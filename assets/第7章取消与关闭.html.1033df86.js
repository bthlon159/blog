import{_ as t}from"./plugin-vue_export-helper.21dcd24c.js";import{r as c,o,c as l,a as n,b as p,e,d as s}from"./app.0d56c066.js";const i={},u=e(`<h1 id="\u7B2C-7-\u7AE0-\u53D6\u6D88\u4E0E\u5173\u95ED" tabindex="-1"><a class="header-anchor" href="#\u7B2C-7-\u7AE0-\u53D6\u6D88\u4E0E\u5173\u95ED" aria-hidden="true">#</a> \u7B2C 7 \u7AE0 \u53D6\u6D88\u4E0E\u5173\u95ED</h1><p>\u4EFB\u52A1\u548C\u7EBF\u7A0B\u7684\u542F\u52A8\u5F88\u5BB9\u6613\u3002\u5728\u5927\u591A\u6570\u65F6\u5019\uFF0C\u6211\u4EEC\u90FD\u4F1A\u8BA9\u5B83\u4EEC\u8FD0\u884C\u76F4\u5230\u7ED3\u675F\uFF0C\u6216\u8005\u8BA9\u5B83\u4EEC\u81EA\u884C\u505C\u6B62\u3002\u7136\u800C\uFF0C\u6709\u65F6\u5019\u6211\u4EEC\u5E0C\u671B\u63D0\u524D\u7ED3\u675F\u4EFB\u52A1\u6216\u7EBF\u7A0B\uFF0C\u6216\u8BB8\u662F\u56E0\u4E3A\u7528\u6237\u53D6\u6D88\u4E86\u64CD\u4F5C\uFF0C\u6216\u8005\u5E94\u7528\u7A0B\u5E8F\u9700\u8981\u88AB\u5FEB\u901F\u5173\u95ED\u3002</p><p>\u8981\u4F7F\u4EFB\u52A1\u548C\u7EBF\u7A0B\u80FD\u5B89\u5168\u3001\u5FEB\u901F\u3001\u53EF\u9760\u5730\u505C\u6B62\u4E0B\u6765\uFF0C\u5E76\u4E0D\u662F\u4E00\u4EF6\u5BB9\u6613\u7684\u4E8B\u3002Java \u6CA1\u6709\u63D0\u4F9B\u4EFB\u4F55\u673A\u5236\u6765\u5B89\u5168\u5730\u7EC8\u6B62\u7EBF\u7A0B<sup class="footnote-ref"><a href="#footnote1">[1]</a><a class="footnote-anchor" id="footnote-ref1"></a></sup>\u3002\u4F46\u5B83\u63D0\u4F9B\u4E86\u4E2D\u65AD\uFF08Interruption\uFF09\uFF0C\u8FD9\u662F\u4E00\u79CD\u534F\u4F5C\u673A\u5236\uFF0C\u80FD\u591F\u4F7F\u4E00\u4E2A\u7EBF\u7A0B\u7EC8\u6B62\u53E6\u4E00\u4E2A\u7EBF\u7A0B\u7684\u5F53\u524D\u5DE5\u4F5C\u3002</p><p>\u8FD9\u79CD\u534F\u4F5C\u5F0F\u7684\u65B9\u6CD5\u662F\u5FC5\u8981\u7684\uFF0C\u6211\u4EEC\u5F88\u5C11\u5E0C\u671B\u67D0\u4E2A\u4EFB\u52A1\u3001\u7EBF\u7A0B\u6216\u670D\u52A1\u7ACB\u5373\u505C\u6B62\uFF0C\u56E0\u4E3A\u8FD9\u79CD\u7ACB\u5373\u505C\u6B62\u4F1A\u4F7F\u5171\u4EAB\u7684\u6570\u636E\u7ED3\u6784\u5904\u4E8E\u4E0D\u4E00\u81F4\u7684\u72B6\u6001\u3002\u76F8\u53CD\uFF0C\u5728\u7F16\u5199\u4EFB\u52A1\u548C\u670D\u52A1\u65F6\u53EF\u4EE5\u4F7F\u7528\u4E00\u79CD\u534F\u4F5C\u7684\u65B9\u5F0F\uFF1A\u5F53\u9700\u8981\u505C\u6B62\u65F6\uFF0C\u5B83\u4EEC\u9996\u5148\u4F1A\u6E05\u9664\u5F53\u524D\u6B63\u5728\u6267\u884C\u7684\u5DE5\u4F5C\uFF0C\u7136\u540E\u518D\u7ED3\u675F\u3002\u8FD9\u63D0\u4F9B\u4E86\u66F4\u597D\u7684\u7075\u6D3B\u6027\uFF0C\u56E0\u4E3A\u4EFB\u52A1\u672C\u8EAB\u7684\u4EE3\u7801\u6BD4\u53D1\u51FA\u53D6\u6D88\u8BF7\u6C42\u7684\u4EE3\u7801\u66F4\u6E05\u695A\u5982\u4F55\u6267\u884C\u6E05\u9664\u5DE5\u4F5C\u3002</p><p>\u751F\u547D\u5468\u671F\u7ED3\u675F\uFF08End-of-Lifecycle\uFF09\u7684\u95EE\u9898\u4F1A\u4F7F\u4EFB\u52A1\u3001\u670D\u52A1\u4EE5\u53CA\u7A0B\u5E8F\u7684\u8BBE\u8BA1\u548C\u5B9E\u73B0\u7B49\u8FC7\u7A0B\u53D8\u5F97\u590D\u6742\uFF0C\u800C\u8FD9\u4E2A\u5728\u7A0B\u5E8F\u8BBE\u8BA1\u4E2D\u975E\u5E38\u91CD\u8981\u7684\u8981\u7D20\u5374\u7ECF\u5E38\u88AB\u5FFD\u7565\u3002\u4E00\u4E2A\u5728\u884C\u4E3A\u826F\u597D\u7684\u8F6F\u4EF6\u4E0E\u52C9\u5F3A\u8FD0\u884C\u7684\u8F6F\u4EF6\u4E4B\u95F4\u7684\u6700\u4E3B\u8981\u533A\u522B\u5C31\u662F\uFF0C\u884C\u4E3A\u826F\u597D\u7684\u8F6F\u4EF6\u80FD\u5F88\u5B8C\u5584\u5730\u5904\u7406\u5931\u8D25\u3001\u5173\u95ED\u548C\u53D6\u6D88\u7B49\u8FC7\u7A0B\u3002\u672C\u7AE0\u5C06\u7ED9\u51FA\u5404\u79CD\u5B9E\u73B0\u53D6\u6D88\u548C\u4E2D\u65AD\u7684\u673A\u5236\uFF0C\u4EE5\u53CA\u5982\u4F55\u7F16\u5199\u4EFB\u52A1\u548C\u670D\u52A1\uFF0C\u4F7F\u5B83\u4EEC\u80FD\u5BF9\u53D6\u6D88\u8BF7\u6C42\u505A\u51FA\u54CD\u5E94\u3002</p><h2 id="_7-1-\u4EFB\u52A1\u53D6\u6D88" tabindex="-1"><a class="header-anchor" href="#_7-1-\u4EFB\u52A1\u53D6\u6D88" aria-hidden="true">#</a> 7.1 \u4EFB\u52A1\u53D6\u6D88</h2><p>\u5982\u679C\u5916\u90E8\u4EE3\u7801\u80FD\u5728\u67D0\u4E2A\u64CD\u4F5C\u6B63\u5E38\u5B8C\u6210\u4E4B\u524D\u5C06\u5176\u7F6E\u5165 \u201C\u5B8C\u6210\u201D \u72B6\u6001\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u64CD\u4F5C\u5C31\u53EF\u4EE5\u79F0\u4E3A\u53EF\u53D6\u6D88\u7684\uFF08Cancellable\uFF09\u3002\u53D6\u6D88\u67D0\u4E2A\u64CD\u4F5C\u7684\u539F\u56E0\u5F88\u591A\uFF1A</p><p><strong>\u7528\u6237\u8BF7\u6C42\u53D6\u6D88</strong>\u3002\u7528\u6237\u70B9\u51FB\u56FE\u5F62\u754C\u9762\u7A0B\u5E8F\u4E2D\u7684 \u201C\u53D6\u6D88\u201D \u6309\u94AE\uFF0C\u6216\u8005\u901A\u8FC7\u7BA1\u7406\u63A5\u53E3\u6765\u53D1\u51FA\u53D6\u6D88\u8BF7\u6C42\uFF0C\u4F8B\u5982 JMX\uFF08Java Management Extensions\uFF09\u3002</p><p><strong>\u6709\u65F6\u95F4\u9650\u5236\u7684\u64CD\u4F5C</strong>\u3002\u4F8B\u5982\uFF0C\u67D0\u4E2A\u5E94\u7528\u7A0B\u5E8F\u9700\u8981\u5728\u6709\u9650\u65F6\u95F4\u5185\u641C\u7D22\u95EE\u9898\u7A7A\u95F4\uFF0C\u5E76\u5728\u8FD9\u4E2A\u65F6\u95F4\u5185\u9009\u62E9\u6700\u4F73\u7684\u89E3\u51B3\u65B9\u6848\u3002\u5F53\u8BA1\u65F6\u5668\u8D85\u65F6\u65F6\uFF0C\u9700\u8981\u53D6\u6D88\u6240\u6709\u6B63\u5728\u641C\u7D22\u7684\u4EFB\u52A1\u3002</p><p><strong>\u5E94\u7528\u7A0B\u5E8F\u4E8B\u4EF6</strong>\u3002\u4F8B\u5982\uFF0C\u5E94\u7528\u7A0B\u5E8F\u5BF9\u67D0\u4E2A\u95EE\u9898\u7A7A\u95F4\u8FDB\u884C\u5206\u89E3\u5E76\u641C\u7D22\uFF0C\u4ECE\u800C\u4F7F\u4E0D\u540C\u7684\u4EFB\u52A1\u53EF\u4EE5\u641C\u7D22\u95EE\u9898\u7A7A\u95F4\u4E2D\u7684\u4E0D\u540C\u533A\u57DF\u3002\u5F53\u5176\u4E2D\u4E00\u4E2A\u4EFB\u52A1\u627E\u5230\u4E86\u89E3\u51B3\u65B9\u6848\u65F6\uFF0C\u6240\u6709\u5176\u4ED6\u4ECD\u5728\u641C\u7D22\u7684\u4EFB\u52A1\u90FD\u5C06\u88AB\u53D6\u6D88\u3002</p><p><strong>\u9519\u8BEF</strong>\u3002\u7F51\u9875\u722C\u866B\u7A0B\u5E8F\u641C\u7D22\u76F8\u5173\u7684\u9875\u9762\uFF0C\u5E76\u5C06\u9875\u9762\u6216\u6458\u8981\u6570\u636E\u4FDD\u5B58\u5230\u786C\u76D8\u3002\u5F53\u4E00\u4E2A\u722C\u866B\u4EFB\u52A1\u53D1\u751F\u9519\u8BEF\u65F6\uFF08\u4F8B\u5982\uFF0C\u78C1\u76D8\u7A7A\u95F4\u5DF2\u6EE1\uFF09\uFF0C\u90A3\u4E48\u6240\u6709\u641C\u7D22\u4EFB\u52A1\u90FD\u4F1A\u53D6\u6D88\uFF0C\u6B64\u65F6\u53EF\u80FD\u4F1A\u8BB0\u5F55\u5B83\u4EEC\u7684\u5F53\u524D\u72B6\u6001\uFF0C\u4EE5\u4FBF\u7A0D\u540E\u91CD\u65B0\u542F\u52A8\u3002</p><p><strong>\u5173\u95ED</strong>\u3002\u5F53\u4E00\u4E2A\u7A0B\u5E8F\u6216\u670D\u52A1\u5173\u95ED\u65F6\uFF0C\u5FC5\u987B\u5BF9\u6B63\u5728\u5904\u7406\u548C\u7B49\u5F85\u5904\u7406\u7684\u5DE5\u4F5C\u6267\u884C\u67D0\u79CD\u64CD\u4F5C\u3002\u5728\u5E73\u7F13\u7684\u5173\u95ED\u8FC7\u7A0B\u4E2D\uFF0C\u5F53\u524D\u6B63\u5728\u6267\u884C\u7684\u4EFB\u52A1\u5C06\u7EE7\u7EED\u6267\u884C\u76F4\u5230\u5B8C\u6210\uFF0C\u800C\u5728\u7ACB\u5373\u5173\u95ED\u8FC7\u7A0B\u4E2D\uFF0C\u5F53\u524D\u7684\u4EFB\u52A1\u5219\u53EF\u80FD\u53D6\u6D88\u3002</p><p>\u5728 Java \u4E2D\u6CA1\u6709\u4E00\u79CD\u5B89\u5168\u7684\u62A2\u5360\u5F0F\u65B9\u6CD5\u6765\u505C\u6B62\u7EBF\u7A0B\uFF0C\u56E0\u6B64\u4E5F\u5C31\u6CA1\u6709\u5B89\u5168\u7684\u62A2\u5360\u5F0F\u65B9\u6CD5\u6765\u505C\u6B62\u4EFB\u52A1\u3002\u53EA\u6709\u4E00\u4E9B\u534F\u4F5C\u5F0F\u7684\u673A\u5236\uFF0C\u4F7F\u8BF7\u6C42\u53D6\u6D88\u7684\u4EFB\u52A1\u548C\u4EE3\u7801\u90FD\u9075\u5FAA\u4E00\u79CD\u534F\u5546\u597D\u7684\u534F\u8BAE\u3002</p><p>\u5176\u4E2D\u4E00\u79CD\u534F\u4F5C\u673A\u5236\u80FD\u8BBE\u7F6E\u67D0\u4E2A \u201C\u5DF2\u8BF7\u6C42\u53D6\u6D88\uFF08Cancellation Requested\uFF09\u201D \u6807\u5FD7\uFF0C\u800C\u4EFB\u52A1\u5C06\u5B9A\u671F\u5730\u67E5\u770B\u8BE5\u6807\u5FD7\u3002\u5982\u679C\u8BBE\u7F6E\u4E86\u8FD9\u4E2A\u6807\u5FD7\uFF0C\u90A3\u4E48\u4EFB\u52A1\u5C06\u63D0\u524D\u7ED3\u675F\u3002\u7A0B\u5E8F\u6E05\u53557-1 \u4E2D\u5C31\u4F7F\u7528\u4E86\u8FD9\u9879\u6280\u672F\uFF0C\u5176\u4E2D\u7684 PrimeGenerator \u6301\u7EED\u5730\u679A\u4E3E\u7D20\u6570\uFF0C\u76F4\u5230\u5B83\u88AB\u53D6\u6D88\u3002cancel \u65B9\u6CD5\u5C06\u8BBE\u7F6E cancelled \u6807\u5FD7\uFF0C\u5E76\u4E14\u4E3B\u5FAA\u73AF\u5728\u641C\u7D22\u4E0B\u4E00\u4E2A\u7D20\u6570\u4E4B\u524D\u4F1A\u9996\u5148\u68C0\u67E5\u8FD9\u4E2A\u6807\u5FD7\u3002\uFF08\u4E3A\u4E86\u4F7F\u8FD9\u4E2A\u8FC7\u7A0B\u80FD\u53EF\u9760\u5730\u5DE5\u4F5C\uFF0C\u6807\u5FD7 cancelled \u5FC5\u987B\u4E3A volatile \u7C7B\u578B\u3002\uFF09</p><p>\u7A0B\u5E8F\u6E05\u53557-1 \u4F7F\u7528 volatile \u7C7B\u578B\u7684\u57DF\u6765\u4FDD\u5B58\u53D6\u6D88\u72B6\u6001</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ThreadSafe</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PrimeGenerator</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">&gt;</span></span> primes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> cancelled<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BigInteger</span> p <span class="token operator">=</span> <span class="token class-name">BigInteger</span><span class="token punctuation">.</span>ONE<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>cancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            p <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">nextProbablePrime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                primes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cancelled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>primes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7A0B\u5E8F\u6E05\u53557-2 \u7ED9\u51FA\u4E86\u8FD9\u4E2A\u7C7B\u7684\u4F7F\u7528\u793A\u4F8B\uFF0C\u5373\u8BA9\u7D20\u6570\u751F\u6210\u5668\u8FD0\u884C 1 \u79D2\u949F\u540E\u53D6\u6D88\u3002\u7D20\u6570\u751F\u6210\u5668\u901A\u5E38\u5E76\u4E0D\u4F1A\u521A\u597D\u5728\u8FD0\u884C 1 \u79D2\u949F\u540E\u505C\u6B62\uFF0C\u56E0\u4E3A\u5728\u8BF7\u6C42\u53D6\u6D88\u7684\u65F6\u523B\u548C run \u65B9\u6CD5\u4E2D\u5FAA\u73AF\u6267\u884C\u4E0B\u4E00\u6B21\u68C0\u67E5\u4E4B\u95F4\u53EF\u80FD\u5B58\u5728\u5EF6\u8FDF\u3002cancel \u65B9\u6CD5\u7531 finally \u5757\u8C03\u7528\uFF0C\u4ECE\u800C\u786E\u4FDD\u5373\u4F7F\u5728\u8C03\u7528 sleep \u65F6\u88AB\u4E2D\u65AD\u4E5F\u80FD\u53D6\u6D88\u7D20\u6570\u751F\u6210\u5668\u7684\u6267\u884C\u3002\u5982\u679C cancel \u6CA1\u6709\u88AB\u8C03\u7528\uFF0C\u90A3\u4E48\u641C\u7D22\u7D20\u6570\u7684\u7EBF\u7A0B\u5C06\u6C38\u8FDC\u8FD0\u884C\u4E0B\u53BB\uFF0C\u4E0D\u65AD\u6D88\u8017 CPU \u7684\u65F6\u949F\u5468\u671F\uFF0C\u5E76\u4F7F\u5F97 JVM \u4E0D\u80FD\u6B63\u5E38\u9000\u51FA\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-2 \u4E00\u4E2A\u4EC5\u8FD0\u884C\u4E00\u79D2\u949F\u7684\u7D20\u6570\u751F\u6210\u5668</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">&gt;</span></span> <span class="token function">aSecondOfPrimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">PrimeGenerator</span> generator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrimeGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>generator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        generator<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> generator<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E00\u4E2A\u53EF\u53D6\u6D88\u7684\u4EFB\u52A1\u5FC5\u987B\u62E5\u6709\u53D6\u6D88\u7B56\u7565\uFF08Cancellation Policy\uFF09\uFF0C\u5728\u8FD9\u4E2A\u7B56\u7565\u4E2D\u5C06\u8BE6\u7EC6\u5730\u5B9A\u4E49\u53D6\u6D88\u64CD\u4F5C\u7684 &quot;How\u201D\u3001&quot;When\u201D \u4EE5\u53CA &quot;What\u201D\uFF0C\u5373\u5176\u4ED6\u4EE3\u7801\u5982\u4F55\uFF08How\uFF09\u8BF7\u6C42\u53D6\u6D88\u8BE5\u4EFB\u52A1\uFF0C\u4EFB\u52A1\u5728\u4F55\u65F6\uFF08When\uFF09\u68C0\u67E5\u662F\u5426\u5DF2\u7ECF\u8BF7\u6C42\u4E86\u53D6\u6D88\uFF0C\u4EE5\u53CA\u5728\u54CD\u5E94\u53D6\u6D88\u8BF7\u6C42\u65F6\u5E94\u8BE5\u6267\u884C\u54EA\u4E9B\uFF08What\uFF09\u64CD\u4F5C\u3002</p><p>\u8003\u8651\u73B0\u5B9E\u4E16\u754C\u4E2D\u505C\u6B62\u652F\u4ED8\uFF08Stop-Payment\uFF09\u652F\u7968\u7684\u793A\u4F8B\u3002\u94F6\u884C\u901A\u5E38\u90FD\u4F1A\u89C4\u5B9A\u5982\u4F55\u63D0\u4EA4\u4E00\u4E2A\u505C\u6B62\u652F\u4ED8\u7684\u8BF7\u6C42\uFF0C\u5728\u5904\u7406\u8FD9\u4E9B\u8BF7\u6C42\u65F6\u9700\u8981\u505A\u51FA\u54EA\u4E9B\u54CD\u5E94\u6027\u4FDD\u8BC1\uFF0C\u4EE5\u53CA\u5F53\u652F\u4ED8\u4E2D\u65AD\u540E\u9700\u8981\u9075\u5B88\u54EA\u4E9B\u6D41\u7A0B\uFF08\u4F8B\u5982\u901A\u77E5\u8BE5\u4E8B\u52A1\u4E2D\u6D89\u53CA\u7684\u5176\u4ED6\u94F6\u884C\uFF0C\u4EE5\u53CA\u5BF9\u4ED8\u6B3E\u4EBA\u7684\u8D26\u6237\u8FDB\u884C\u8D39\u7528\u8BC4\u4F30\uFF09\u3002\u8FD9\u4E9B\u6D41\u7A0B\u548C\u4FDD\u8BC1\u653E\u5728\u4E00\u8D77\u5C31\u6784\u6210\u4E86\u652F\u7968\u652F\u4ED8\u7684\u53D6\u6D88\u7B56\u7565\u3002</p><p>PrimeGenerator \u4F7F\u7528\u4E86\u4E00\u79CD\u7B80\u5355\u7684\u53D6\u6D88\u7B56\u7565\uFF1A\u5BA2\u6237\u4EE3\u7801\u901A\u8FC7\u8C03\u7528 cancel \u6765\u8BF7\u6C42\u53D6\u6D88\uFF0CPrimeGenerator \u5728\u6BCF\u6B21\u641C\u7D22\u7D20\u6570\u524D\u9996\u5148\u68C0\u67E5\u662F\u5426\u5B58\u5728\u53D6\u6D88\u8BF7\u6C42\uFF0C\u5982\u679C\u5B58\u5728\u5219\u9000\u51FA\u3002</p><h3 id="_7-1-1-\u4E2D\u65AD" tabindex="-1"><a class="header-anchor" href="#_7-1-1-\u4E2D\u65AD" aria-hidden="true">#</a> 7.1.1 \u4E2D\u65AD</h3><p>PrimeGenerator \u4E2D\u7684\u53D6\u6D88\u673A\u5236\u6700\u7EC8\u4F1A\u4F7F\u5F97\u641C\u7D22\u7D20\u6570\u7684\u4EFB\u52A1\u9000\u51FA\uFF0C\u4F46\u5728\u9000\u51FA\u8FC7\u7A0B\u4E2D\u9700\u8981\u82B1\u8D39\u4E00\u5B9A\u7684\u65F6\u95F4\u3002\u7136\u800C\uFF0C\u5982\u679C\u4F7F\u7528\u8FD9\u79CD\u65B9\u6CD5\u7684\u4EFB\u52A1\u8C03\u7528\u4E86\u4E00\u4E2A\u963B\u585E\u65B9\u6CD5\uFF0C\u4F8B\u5982 BlockingQueue.put\uFF0C\u90A3\u4E48\u53EF\u80FD\u4F1A\u4EA7\u751F\u4E00\u4E2A\u66F4\u4E25\u91CD\u7684\u95EE\u9898\u2014\u2014\u4EFB\u52A1\u53EF\u80FD\u6C38\u8FDC\u4E0D\u4F1A\u68C0\u67E5\u53D6\u6D88\u6807\u5FD7\uFF0C\u56E0\u6B64\u6C38\u8FDC\u4E0D\u4F1A\u7ED3\u675F\u3002</p><p>\u5728\u7A0B\u5E8F\u6E05\u53557-3 \u4E2D\u7684 BrokenPrimeProducer \u5C31\u8BF4\u660E\u4E86\u8FD9\u4E2A\u95EE\u9898\u3002\u751F\u4EA7\u8005\u7EBF\u7A0B\u751F\u6210\u7D20\u6570\uFF0C\u5E76\u5C06\u5B83\u4EEC\u653E\u5165\u4E00\u4E2A\u963B\u585E\u961F\u5217\u3002\u5982\u679C\u751F\u4EA7\u8005\u7684\u901F\u5EA6\u8D85\u8FC7\u4E86\u6D88\u8D39\u8005\u7684\u5904\u7406\u901F\u5EA6\uFF0C\u961F\u5217\u5C06\u88AB\u586B\u6EE1\uFF0Cput \u65B9\u6CD5\u4E5F\u4F1A\u963B\u585E\u3002\u5F53\u751F\u4EA7\u8005\u5728 put \u65B9\u6CD5\u4E2D\u963B\u585E\u65F6\uFF0C\u5982\u679C\u6D88\u8D39\u8005\u5E0C\u671B\u53D6\u6D88\u751F\u4EA7\u8005\u4EFB\u52A1\uFF0C\u90A3\u4E48\u5C06\u53D1\u751F\u4EC0\u4E48\u60C5\u51B5\uFF1F\u5B83\u53EF\u4EE5\u8C03\u7528 cancel \u65B9\u6CD5\u6765\u8BBE\u7F6E cancelled \u6807\u5FD7\uFF0C\u4F46\u6B64\u65F6\u751F\u4EA7\u8005\u5374\u6C38\u8FDC\u4E0D\u80FD\u68C0\u67E5\u8FD9\u4E2A\u6807\u5FD7\uFF0C\u56E0\u4E3A\u5B83\u65E0\u6CD5\u4ECE\u963B\u585E\u7684 put \u65B9\u6CD5\u4E2D\u6062\u590D\u8FC7\u6765\uFF08\u56E0\u4E3A\u6D88\u8D39\u8005\u6B64\u65F6\u5DF2\u7ECF\u505C\u6B62\u4ECE\u961F\u5217\u4E2D\u53D6\u51FA\u7D20\u6570\uFF0C\u6240\u4EE5 put \u65B9\u6CD5\u5C06\u4E00\u76F4\u4FDD\u6301\u963B\u585E\u72B6\u6001\uFF09\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-3 \u4E0D\u53EF\u9760\u7684\u53D6\u6D88\u64CD\u4F5C\u5C06\u628A\u751F\u4EA7\u8005\u7F6E\u4E8E\u963B\u585E\u7684\u64CD\u4F5C\u4E2D\uFF08\u4E0D\u8981\u8FD9\u4E48\u505A\uFF09</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">BrokenPrimeProducer</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> cancelled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token class-name">BrokenPrimeProducer</span><span class="token punctuation">(</span><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">BigInteger</span> p <span class="token operator">=</span> <span class="token class-name">BigInteger</span><span class="token punctuation">.</span>ONE<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>cancelled<span class="token punctuation">)</span> 
                queue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>p <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">nextProbablePrime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> consumed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cancelled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">consumePrimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">&gt;</span></span> primes <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token class-name">BrokenPrimeProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokenPrimeProducer</span><span class="token punctuation">(</span>primes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">needMorePrimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token function">consume</span><span class="token punctuation">(</span>primes<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        producer<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7B2C 5 \u7AE0\u66FE\u63D0\u5230\uFF0C\u4E00\u4E9B\u7279\u6B8A\u7684\u963B\u585E\u5E93\u7684\u65B9\u6CD5\u652F\u6301\u4E2D\u65AD\u3002\u7EBF\u7A0B\u4E2D\u65AD\u662F\u4E00\u79CD\u534F\u4F5C\u673A\u5236\uFF0C\u7EBF\u7A0B\u53EF\u4EE5\u901A\u8FC7\u8FD9\u79CD\u673A\u5236\u6765\u901A\u77E5\u53E6\u4E00\u4E2A\u7EBF\u7A0B\uFF0C\u544A\u8BC9\u5B83\u5728\u5408\u9002\u7684\u6216\u8005\u53EF\u80FD\u7684\u60C5\u51B5\u4E0B\u505C\u6B62\u5F53\u524D\u5DE5\u4F5C\uFF0C\u5E76\u8F6C\u800C\u6267\u884C\u5176\u4ED6\u7684\u5DE5\u4F5C\u3002</p><p>\u5728 Java \u7684 API \u6216\u8BED\u8A00\u89C4\u8303\u4E2D\uFF0C\u5E76\u6CA1\u6709\u5C06\u4E2D\u65AD\u4E0E\u4EFB\u4F55\u53D6\u6D88\u8BED\u4E49\u5173\u8054\u8D77\u6765\uFF0C\u4F46\u5B9E\u9645\u4E0A\uFF0C\u5982\u679C\u5728\u53D6\u6D88\u4E4B\u5916\u7684\u5176\u4ED6\u64CD\u4F5C\u4E2D\u4F7F\u7528\u4E2D\u65AD\uFF0C\u90A3\u4E48\u90FD\u662F\u4E0D\u5408\u9002\u7684\uFF0C\u5E76\u4E14\u5F88\u96BE\u652F\u6491\u8D77\u66F4\u5927\u7684\u5E94\u7528\u3002</p><p>\u6BCF\u4E2A\u7EBF\u7A0B\u90FD\u6709\u4E00\u4E2A boolean \u7C7B\u578B\u7684\u4E2D\u65AD\u72B6\u6001\u3002\u5F53\u4E2D\u65AD\u7EBF\u7A0B\u65F6\uFF0C\u8FD9\u4E2A\u7EBF\u7A0B\u7684\u4E2D\u65AD\u72B6\u6001\u5C06\u88AB\u8BBE\u7F6E\u4E3A true\u3002\u5728 Thread \u4E2D\u5305\u542B\u4E86\u4E2D\u65AD\u7EBF\u7A0B\u4EE5\u53CA\u67E5\u8BE2\u7EBF\u7A0B\u4E2D\u65AD\u72B6\u6001\u7684\u65B9\u6CD5\uFF0C\u5982\u7A0B\u5E8F\u6E05\u53557-4 \u6240\u793A\u3002interrupt \u65B9\u6CD5\u80FD\u4E2D\u65AD\u76EE\u6807\u7EBF\u7A0B\uFF0C\u800C isInterrupted \u65B9\u6CD5\u80FD\u8FD4\u56DE\u76EE\u6807\u7EBF\u7A0B\u7684\u4E2D\u65AD\u72B6\u6001\u3002\u9759\u6001\u7684 interrupted \u65B9\u6CD5\u5C06\u6E05\u9664\u5F53\u524D\u7EBF\u7A0B\u7684\u4E2D\u65AD\u72B6\u6001\uFF0C\u5E76\u8FD4\u56DE\u5B83\u4E4B\u524D\u7684\u503C\uFF0C\u8FD9\u4E5F\u662F\u6E05\u9664\u4E2D\u65AD\u72B6\u6001\u7684\u552F\u4E00\u65B9\u6CD5\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-4 Thread \u4E2D\u7684\u4E2D\u65AD\u65B9\u6CD5</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ......</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ......</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ......</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u963B\u585E\u5E93\u65B9\u6CD5\uFF0C\u4F8B\u5982 Thread.sleep \u548C Object.wait \u7B49\uFF0C\u90FD\u4F1A\u68C0\u67E5\u7EBF\u7A0B\u4F55\u65F6\u4E2D\u65AD\uFF0C\u5E76\u4E14\u5728\u53D1\u73B0\u4E2D\u65AD\u65F6\u63D0\u524D\u8FD4\u56DE\u3002\u5B83\u4EEC\u5728\u54CD\u5E94\u4E2D\u65AD\u65F6\u6267\u884C\u7684\u64CD\u4F5C\u5305\u62EC\uFF1A\u6E05\u9664\u4E2D\u65AD\u72B6\u6001\uFF0C\u629B\u51FA InterruptedException\uFF0C\u8868\u793A\u963B\u585E\u64CD\u4F5C\u7531\u4E8E\u4E2D\u65AD\u800C\u63D0\u524D\u7ED3\u675F\u3002JVM \u5E76\u4E0D\u80FD\u4FDD\u8BC1\u963B\u585E\u65B9\u6CD5\u68C0\u6D4B\u5230\u4E2D\u65AD\u7684\u901F\u5EA6\uFF0C\u4F46\u5728\u5B9E\u9645\u60C5\u51B5\u4E2D\u54CD\u5E94\u901F\u5EA6\u8FD8\u662F\u975E\u5E38\u5FEB\u7684\u3002</p><p>\u5F53\u7EBF\u7A0B\u5728\u975E\u963B\u585E\u72B6\u6001\u4E0B\u4E2D\u65AD\u65F6\uFF0C\u5B83\u7684\u4E2D\u65AD\u72B6\u6001\u5C06\u88AB\u8BBE\u7F6E\uFF0C\u7136\u540E\u6839\u636E\u5C06\u88AB\u53D6\u6D88\u7684\u64CD\u4F5C\u6765\u68C0\u67E5\u4E2D\u65AD\u72B6\u6001\u4EE5\u5224\u65AD\u53D1\u751F\u4E86\u4E2D\u65AD\u3002\u901A\u8FC7\u8FD9\u6837\u7684\u65B9\u6CD5\uFF0C\u4E2D\u65AD\u64CD\u4F5C\u5C06\u53D8\u5F97 \u201C\u6709\u9ECF\u6027\u201D\u2014\u2014\u5982\u679C\u4E0D\u89E6\u53D1 InterruptedException\uFF0C\u90A3\u4E48\u4E2D\u65AD\u72B6\u6001\u5C06\u4E00\u76F4\u4FDD\u6301\uFF0C\u76F4\u5230\u660E\u786E\u5730\u6E05\u9664\u4E2D\u65AD\u72B6\u6001\u3002</p><p>\u8C03\u7528 interrupt \u5E76\u4E0D\u610F\u5473\u7740\u7ACB\u5373\u505C\u6B62\u76EE\u6807\u7EBF\u7A0B\u6B63\u5728\u8FDB\u884C\u7684\u5DE5\u4F5C\uFF0C\u800C\u53EA\u662F\u4F20\u9012\u4E86\u8BF7\u6C42\u4E2D\u65AD\u7684\u6D88\u606F\u3002</p><p>\u5BF9\u4E2D\u65AD\u64CD\u4F5C\u7684\u6B63\u786E\u7406\u89E3\u662F\uFF1A\u5B83\u5E76\u4E0D\u4F1A\u771F\u6B63\u5730\u4E2D\u65AD\u4E00\u4E2A\u6B63\u5728\u8FD0\u884C\u7684\u7EBF\u7A0B\uFF0C\u800C\u53EA\u662F\u53D1\u51FA\u4E2D\u65AD\u8BF7\u6C42\uFF0C\u7136\u540E\u7531\u7EBF\u7A0B\u5728\u4E0B\u4E00\u4E2A\u5408\u9002\u7684\u65F6\u523B\u4E2D\u65AD\u81EA\u5DF1\u3002\uFF08\u8FD9\u4E9B\u65F6\u523B\u4E5F\u88AB\u79F0\u4E3A\u53D6\u6D88\u70B9\uFF09\u3002\u6709\u4E9B\u65B9\u6CD5\uFF0C\u4F8B\u5982 wait\u3001sleep \u548C join \u7B49\uFF0C\u5C06\u4E25\u683C\u5730\u5904\u7406\u8FD9\u79CD\u8BF7\u6C42\uFF0C\u5F53\u5B83\u4EEC\u6536\u5230\u4E2D\u65AD\u8BF7\u6C42\u6216\u8005\u5728\u5F00\u59CB\u6267\u884C\u65F6\u53D1\u73B0\u67D0\u4E2A\u5DF2\u88AB\u8BBE\u7F6E\u597D\u7684\u4E2D\u65AD\u72B6\u6001\u65F6\uFF0C\u5C06\u629B\u51FA\u4E00\u4E2A\u5F02\u5E38\u3002\u8BBE\u8BA1\u826F\u597D\u7684\u65B9\u6CD5\u53EF\u4EE5\u5B8C\u5168\u5FFD\u7565\u8FD9\u79CD\u8BF7\u6C42\uFF0C\u53EA\u8981\u5B83\u4EEC\u80FD\u4F7F\u8C03\u7528\u4EE3\u7801\u5BF9\u4E2D\u65AD\u8BF7\u6C42\u8FDB\u884C\u67D0\u79CD\u5904\u7406\u3002\u8BBE\u8BA1\u7CDF\u7CD5\u7684\u65B9\u6CD5\u53EF\u80FD\u4F1A\u5C4F\u853D\u4E2D\u65AD\u8BF7\u6C42\uFF0C\u4ECE\u800C\u5BFC\u81F4\u8C03\u7528\u6808\u4E2D\u7684\u5176\u4ED6\u4EE3\u7801\u65E0\u6CD5\u5BF9\u4E2D\u65AD\u8BF7\u6C42\u4F5C\u51FA\u54CD\u5E94\u3002</p><p>\u5728\u4F7F\u7528\u9759\u6001\u7684 interrupted \u65F6\u5E94\u8BE5\u5C0F\u5FC3\uFF0C\u56E0\u4E3A\u5B83\u4F1A\u6E05\u9664\u5F53\u524D\u7EBF\u7A0B\u7684\u4E2D\u65AD\u72B6\u6001\u3002\u5982\u679C\u5728\u8C03\u7528 interrupted \u65F6\u8FD4\u56DE\u4E86 true\uFF0C\u90A3\u4E48\u9664\u975E\u4F60\u60F3\u5C4F\u853D\u8FD9\u4E2A\u4E2D\u65AD\uFF0C\u5426\u5219\u5FC5\u987B\u5BF9\u5B83\u8FDB\u884C\u5904\u7406\u2014\u2014\u53EF\u4EE5\u629B\u51FA InterruptedException\uFF0C\u6216\u8005\u901A\u8FC7\u518D\u6B21\u8C03\u7528 interrupt \u6765\u6062\u590D\u4E2D\u65AD\u72B6\u6001\uFF0C\u5982\u7A0B\u5E8F\u6E05\u53555-10 \u6240\u793A\u3002</p><p>BrokenPrimeProducer \u8BF4\u660E\u4E86\u4E00\u4E9B\u81EA\u5B9A\u4E49\u7684\u53D6\u6D88\u673A\u5236\u65E0\u6CD5\u4E0E\u53EF\u963B\u585E\u7684\u5E93\u51FD\u6570\u5B9E\u73B0\u826F\u597D\u4EA4\u4E92\u7684\u539F\u56E0\u3002\u5982\u679C\u4EFB\u52A1\u4EE3\u7801\u80FD\u591F\u54CD\u5E94\u4E2D\u65AD\uFF0C\u90A3\u4E48\u53EF\u4EE5\u4F7F\u7528\u4E2D\u65AD\u4F5C\u4E3A\u53D6\u6D88\u673A\u5236\uFF0C\u5E76\u4E14\u5229\u7528\u8BB8\u591A\u5E93\u7C7B\u4E2D\u63D0\u4F9B\u7684\u4E2D\u65AD\u652F\u6301\u3002</p><p>\u901A\u5E38\uFF0C\u4E2D\u65AD\u662F\u5B9E\u73B0\u53D6\u6D88\u7684\u6700\u5408\u7406\u65B9\u5F0F\u3002</p><p>BrokenPrimeProducer \u4E2D\u7684\u95EE\u9898\u5F88\u5BB9\u6613\u89E3\u51B3\uFF08\u548C\u7B80\u5316\uFF09\uFF1A\u4F7F\u7528\u4E2D\u65AD\u800C\u4E0D\u662F boolean \u6807\u5FD7\u6765\u8BF7\u6C42\u53D6\u6D88\uFF0C\u5982\u7A0B\u5E8F\u6E05\u53557-5 \u6240\u793A\u3002\u5728\u6BCF\u6B21\u8FED\u4EE3\u5FAA\u73AF\u4E2D\uFF0C\u6709\u4E24\u4E2A\u4F4D\u7F6E\u53EF\u4EE5\u68C0\u6D4B\u51FA\u4E2D\u65AD\uFF1A\u5728\u963B\u585E\u7684 put \u65B9\u6CD5\u8C03\u7528\u4E2D\uFF0C\u4EE5\u53CA\u5728\u5FAA\u73AF\u5F00\u59CB\u5904\u67E5\u8BE2\u4E2D\u65AD\u72B6\u6001\u65F6\u3002\u7531\u4E8E\u8C03\u7528\u4E86\u963B\u585E\u7684 put \u65B9\u6CD5\uFF0C\u56E0\u6B64\u8FD9\u91CC\u5E76\u4E0D\u4E00\u5B9A\u9700\u8981\u8FDB\u884C\u663E\u5F0F\u7684\u68C0\u6D4B\uFF0C\u4F46\u6267\u884C\u68C0\u6D4B\u5374\u4F1A\u4F7F PrimeProducer \u5BF9\u4E2D\u65AD\u5177\u6709\u66F4\u9AD8\u7684\u54CD\u5E94\u6027\uFF0C\u56E0\u4E3A\u5B83\u662F\u5728\u542F\u52A8\u5BFB\u627E\u7D20\u6570\u4EFB\u52A1\u4E4B\u524D\u68C0\u67E5\u4E2D\u65AD\u7684\uFF0C\u800C\u4E0D\u662F\u5728\u4EFB\u52A1\u5B8C\u6210\u4E4B\u540E\u3002\u5982\u679C\u53EF\u4E2D\u65AD\u7684\u963B\u585E\u65B9\u6CD5\u7684\u8C03\u7528\u9891\u7387\u5E76\u4E0D\u9AD8\uFF0C\u4E0D\u8DB3\u4EE5\u83B7\u5F97\u8DB3\u591F\u7684\u54CD\u5E94\u6027\uFF0C\u90A3\u4E48\u663E\u5F0F\u5730\u68C0\u6D4B\u4E2D\u65AD\u72B6\u6001\u80FD\u8D77\u5230\u4E00\u5B9A\u7684\u5E2E\u52A9\u4F5C\u7528\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-5 \u901A\u8FC7\u4E2D\u65AD\u6765\u53D6\u6D88</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">PrimeProducer</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">;</span>

    <span class="token class-name">PrimeProducer</span><span class="token punctuation">(</span><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BigInteger</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">BigInteger</span> p <span class="token operator">=</span> <span class="token class-name">BigInteger</span><span class="token punctuation">.</span>ONE<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
                queue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>p <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">nextProbablePrime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> consumed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*\u5141\u8BB8\u7EBF\u7A0B\u9000\u51FA*/</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-1-2-\u4E2D\u65AD\u7B56\u7565" tabindex="-1"><a class="header-anchor" href="#_7-1-2-\u4E2D\u65AD\u7B56\u7565" aria-hidden="true">#</a> 7.1.2 \u4E2D\u65AD\u7B56\u7565</h3><p>\u6B63\u5982\u4EFB\u52A1\u4E2D\u5E94\u8BE5\u5305\u542B\u53D6\u6D88\u7B56\u7565\u4E00\u6837\uFF0C\u7EBF\u7A0B\u540C\u6837\u5E94\u8BE5\u5305\u542B\u4E2D\u65AD\u7B56\u7565\u3002\u4E2D\u65AD\u7B56\u7565\u89C4\u5B9A\u7EBF\u7A0B\u5982\u4F55\u89E3\u91CA\u67D0\u4E2A\u4E2D\u65AD\u8BF7\u6C42\u2014\u2014\u5F53\u53D1\u73B0\u4E2D\u65AD\u8BF7\u6C42\u65F6\uFF0C\u5E94\u8BE5\u505A\u54EA\u4E9B\u5DE5\u4F5C\uFF08\u5982\u679C\u9700\u8981\u7684\u8BDD\uFF09\uFF0C\u54EA\u4E9B\u5DE5\u4F5C\u5355\u5143\u5BF9\u4E8E\u4E2D\u65AD\u6765\u8BF4\u662F\u539F\u5B50\u64CD\u4F5C\uFF0C\u4EE5\u53CA\u4EE5\u591A\u5FEB\u7684\u901F\u5EA6\u6765\u54CD\u5E94\u4E2D\u65AD\u3002</p><p>\u6700\u5408\u7406\u7684\u4E2D\u65AD\u7B56\u7565\u662F\u67D0\u79CD\u5F62\u5F0F\u7684\u7EBF\u7A0B\u7EA7\uFF08Thread-Level\uFF09\u53D6\u6D88\u64CD\u4F5C\u6216\u670D\u52A1\u7EA7\uFF08Service-Level\uFF09\u53D6\u6D88\u64CD\u4F5C\uFF1A\u5C3D\u5FEB\u9000\u51FA\uFF0C\u5728\u5FC5\u8981\u65F6\u8FDB\u884C\u6E05\u7406\uFF0C\u901A\u77E5\u67D0\u4E2A\u6240\u6709\u8005\u8BE5\u7EBF\u7A0B\u5DF2\u7ECF\u9000\u51FA\u3002\u6B64\u5916\u8FD8\u53EF\u4EE5\u5EFA\u7ACB\u5176\u4ED6\u7684\u4E2D\u65AD\u7B56\u7565\uFF0C\u4F8B\u5982\u6682\u505C\u670D\u52A1\u6216\u91CD\u65B0\u5F00\u59CB\u670D\u52A1\uFF0C\u4F46\u5BF9\u4E8E\u90A3\u4E9B\u5305\u542B\u975E\u6807\u51C6\u4E2D\u65AD\u7B56\u7565\u7684\u7EBF\u7A0B\u6216\u7EBF\u7A0B\u6C60\uFF0C\u53EA\u80FD\u7528\u4E8E\u80FD\u77E5\u9053\u8FD9\u4E9B\u7B56\u7565\u7684\u4EFB\u52A1\u4E2D\u3002</p><p>\u533A\u5206\u4EFB\u52A1\u548C\u7EBF\u7A0B\u5BF9\u4E2D\u65AD\u7684\u53CD\u5E94\u662F\u5F88\u91CD\u8981\u7684\u3002\u4E00\u4E2A\u4E2D\u65AD\u8BF7\u6C42\u53EF\u4EE5\u6709\u4E00\u4E2A\u6216\u591A\u4E2A\u63A5\u6536\u8005\u2014\u2014\u4E2D\u65AD\u7EBF\u7A0B\u6C60\u4E2D\u7684\u67D0\u4E2A\u5DE5\u4F5C\u8005\u7EBF\u7A0B\uFF0C\u540C\u65F6\u610F\u5473\u7740 \u201C\u53D6\u6D88\u5F53\u524D\u4EFB\u52A1\u201D \u548C \u201C\u5173\u95ED\u5DE5\u4F5C\u8005\u7EBF\u7A0B\u201D\u3002</p><p>\u4EFB\u52A1\u4E0D\u4F1A\u5728\u5176\u81EA\u5DF1\u62E5\u6709\u7684\u7EBF\u7A0B\u4E2D\u6267\u884C\uFF0C\u800C\u662F\u5728\u67D0\u4E2A\u670D\u52A1\uFF08\u4F8B\u5982\u7EBF\u7A0B\u6C60\uFF09\u62E5\u6709\u7684\u7EBF\u7A0B\u4E2D\u6267\u884C\u3002\u5BF9\u4E8E\u975E\u7EBF\u7A0B\u6240\u6709\u8005\u7684\u4EE3\u7801\u6765\u8BF4\uFF08\u4F8B\u5982\uFF0C\u5BF9\u4E8E\u7EBF\u7A0B\u6C60\u800C\u8A00\uFF0C\u4EFB\u4F55\u5728\u7EBF\u7A0B\u6C60\u5B9E\u73B0\u4EE5\u5916\u7684\u4EE3\u7801\uFF09\uFF0C\u5E94\u8BE5\u5C0F\u5FC3\u5730\u4FDD\u5B58\u4E2D\u65AD\u72B6\u6001\uFF0C\u8FD9\u6837\u62E5\u6709\u7EBF\u7A0B\u7684\u4EE3\u7801\u624D\u80FD\u5BF9\u4E2D\u65AD\u505A\u51FA\u54CD\u5E94\uFF0C\u5373\u4F7F \u201C\u975E\u6240\u6709\u8005\u201D \u4EE3\u7801\u4E5F\u53EF\u4EE5\u505A\u51FA\u54CD\u5E94\u3002\uFF08\u5F53\u4F60\u4E3A\u4E00\u6237\u4EBA\u5BB6\u6253\u626B\u623F\u5C4B\u65F6\uFF0C\u5373\u4F7F\u4E3B\u4EBA\u4E0D\u5728\uFF0C\u4E5F\u4E0D\u5E94\u8BE5\u628A\u5728\u8FD9\u6BB5\u65F6\u95F4\u5185\u6536\u5230\u7684\u90AE\u4EF6\u6254\u6389\uFF0C\u800C\u5E94\u8BE5\u628A\u90AE\u4EF6\u6536\u8D77\u6765\uFF0C\u7B49\u4E3B\u4EBA\u56DE\u6765\u4EE5\u540E\u518D\u4EA4\u7ED9\u4ED6\u4EEC\u5904\u7406\uFF0C\u5C3D\u7BA1\u4F60\u53EF\u4EE5\u9605\u8BFB\u4ED6\u4EEC\u7684\u6742\u5FD7\u3002\uFF09</p><p>\u8FD9\u5C31\u662F\u4E3A\u4EC0\u4E48\u5927\u591A\u6570\u53EF\u963B\u585E\u7684\u5E93\u51FD\u6570\u90FD\u53EA\u662F\u629B\u51FA InterruptedException \u4F5C\u4E3A\u4E2D\u65AD\u54CD\u5E94\u3002\u5B83\u4EEC\u6C38\u8FDC\u4E0D\u4F1A\u5728\u67D0\u4E2A\u7531\u81EA\u5DF1\u62E5\u6709\u7684\u7EBF\u7A0B\u4E2D\u8FD0\u884C\uFF0C\u56E0\u6B64\u5B83\u4EEC\u4E3A\u4EFB\u52A1\u6216\u5E93\u4EE3\u7801\u5B9E\u73B0\u4E86\u6700\u5408\u7406\u7684\u53D6\u6D88\u7B56\u7565\uFF1A\u5C3D\u5FEB\u9000\u51FA\u6267\u884C\u6D41\u7A0B\uFF0C\u5E76\u628A\u4E2D\u65AD\u4FE1\u606F\u4F20\u9012\u7ED9\u8C03\u7528\u8005\uFF0C\u4ECE\u800C\u4F7F\u8C03\u7528\u6808\u4E2D\u7684\u4E0A\u5C42\u4EE3\u7801\u53EF\u4EE5\u91C7\u53D6\u8FDB\u4E00\u6B65\u7684\u64CD\u4F5C\u3002</p><p>\u5F53\u68C0\u67E5\u5230\u4E2D\u65AD\u8BF7\u6C42\u65F6\uFF0C\u4EFB\u52A1\u5E76\u4E0D\u9700\u8981\u653E\u5F03\u6240\u6709\u7684\u64CD\u4F5C\u2014\u2014\u5B83\u53EF\u4EE5\u63A8\u8FDF\u5904\u7406\u4E2D\u65AD\u8BF7\u6C42\uFF0C\u5E76\u76F4\u5230\u67D0\u4E2A\u66F4\u5408\u9002\u7684\u65F6\u523B\u3002\u56E0\u6B64\u9700\u8981\u8BB0\u4F4F\u4E2D\u65AD\u8BF7\u6C42\uFF0C\u5E76\u5728\u5B8C\u6210\u5F53\u524D\u4EFB\u52A1\u540E\u629B\u51FA InterruptedException \u6216\u8005\u8868\u793A\u5DF2\u6536\u5230\u4E2D\u65AD\u8BF7\u6C42\u3002\u8FD9\u9879\u6280\u672F\u80FD\u591F\u786E\u4FDD\u5728\u66F4\u65B0\u8FC7\u7A0B\u4E2D\u53D1\u751F\u4E2D\u65AD\u65F6\uFF0C\u6570\u636E\u7ED3\u6784\u4E0D\u4F1A\u88AB\u7834\u574F\u3002</p><p>\u4EFB\u52A1\u4E0D\u5E94\u8BE5\u5BF9\u6267\u884C\u8BE5\u4EFB\u52A1\u7684\u7EBF\u7A0B\u7684\u4E2D\u65AD\u7B56\u7565\u505A\u51FA\u4EFB\u4F55\u5047\u8BBE\uFF0C\u9664\u975E\u8BE5\u4EFB\u52A1\u88AB\u4E13\u95E8\u8BBE\u8BA1\u4E3A\u5728\u670D\u52A1\u4E2D\u8FD0\u884C\uFF0C\u5E76\u4E14\u5728\u8FD9\u4E9B\u670D\u52A1\u4E2D\u5305\u542B\u7279\u5B9A\u7684\u4E2D\u65AD\u7B56\u7565\u3002\u65E0\u8BBA\u4EFB\u52A1\u628A\u4E2D\u65AD\u89C6\u4E3A\u53D6\u6D88\uFF0C\u8FD8\u662F\u5176\u4ED6\u67D0\u4E2A\u4E2D\u65AD\u54CD\u5E94\u64CD\u4F5C\uFF0C\u90FD\u5E94\u8BE5\u5C0F\u5FC3\u5730\u4FDD\u5B58\u6267\u884C\u7EBF\u7A0B\u7684\u4E2D\u65AD\u72B6\u6001\u3002\u5982\u679C\u9664\u4E86\u5C06 InterruptedException \u4F20\u9012\u7ED9\u8C03\u7528\u8005\u5916\u8FD8\u9700\u8981\u6267\u884C\u5176\u4ED6\u64CD\u4F5C\uFF0C\u90A3\u4E48\u5E94\u8BE5\u5728\u6355\u83B7 InterruptedException \u4E4B\u540E\u6062\u590D\u4E2D\u65AD\u72B6\u6001\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u6B63\u5982\u4EFB\u52A1\u4EE3\u7801\u4E0D\u5E94\u8BE5\u5BF9\u5176\u6267\u884C\u6240\u5728\u7684\u7EBF\u7A0B\u7684\u4E2D\u65AD\u7B56\u7565\u505A\u51FA\u5047\u8BBE\uFF0C\u6267\u884C\u53D6\u6D88\u64CD\u4F5C\u7684\u4EE3\u7801\u4E5F\u4E0D\u5E94\u8BE5\u5BF9\u7EBF\u7A0B\u7684\u4E2D\u65AD\u7B56\u7565\u505A\u51FA\u5047\u8BBE\u3002\u7EBF\u7A0B\u5E94\u8BE5\u53EA\u80FD\u7531\u5176\u6240\u6709\u8005\u4E2D\u65AD\uFF0C\u6240\u6709\u8005\u53EF\u4EE5\u5C06\u7EBF\u7A0B\u7684\u4E2D\u65AD\u7B56\u7565\u4FE1\u606F\u5C01\u88C5\u5230\u67D0\u4E2A\u5408\u9002\u7684\u53D6\u6D88\u673A\u5236\u4E2D\uFF0C\u4F8B\u5982\u5173\u95ED\uFF08shutdown\uFF09\u65B9\u6CD5\u3002</p><p>\u7531\u4E8E\u6BCF\u4E2A\u7EBF\u7A0B\u62E5\u6709\u5404\u81EA\u7684\u4E2D\u65AD\u7B56\u7565\uFF0C\u56E0\u6B64\u9664\u975E\u4F60\u77E5\u9053\u4E2D\u65AD\u5BF9\u8BE5\u7EBF\u7A0B\u7684\u542B\u4E49\uFF0C\u5426\u5219\u5C31\u4E0D\u5E94\u8BE5\u4E2D\u65AD\u8FD9\u4E2A\u7EBF\u7A0B\u3002</p><p>\u6279\u8BC4\u8005\u66FE\u5632\u7B11 Java \u7684\u4E2D\u65AD\u529F\u80FD\uFF0C\u56E0\u4E3A\u5B83\u6CA1\u6709\u63D0\u4F9B\u62A2\u5360\u5F0F\u4E2D\u65AD\u673A\u5236\uFF0C\u800C\u4E14\u8FD8\u5F3A\u8FEB\u5F00\u53D1\u4EBA\u5458\u5FC5\u987B\u5904\u7406 InterruptedException\u3002\u7136\u800C\uFF0C\u901A\u8FC7\u63A8\u8FDF\u4E2D\u65AD\u8BF7\u6C42\u7684\u5904\u7406\uFF0C\u5F00\u53D1\u4EBA\u5458\u80FD\u5236\u5B9A\u66F4\u7075\u6D3B\u7684\u4E2D\u65AD\u7B56\u7565\uFF0C\u4ECE\u800C\u4F7F\u5E94\u7528\u7A0B\u5E8F\u5728\u54CD\u5E94\u6027\u548C\u5065\u58EE\u6027\u4E4B\u95F4\u5B9E\u73B0\u5408\u7406\u7684\u5E73\u8861\u3002</p><h3 id="_7-1-3-\u54CD\u5E94\u4E2D\u65AD" tabindex="-1"><a class="header-anchor" href="#_7-1-3-\u54CD\u5E94\u4E2D\u65AD" aria-hidden="true">#</a> 7.1.3 \u54CD\u5E94\u4E2D\u65AD</h3><p>\u5728 5.4 \u8282\u4E2D\uFF0C\u5F53\u8C03\u7528\u53EF\u4E2D\u65AD\u7684\u963B\u585E\u51FD\u6570\u65F6\uFF0C\u4F8B\u5982 Thread.sleep \u6216 BlockingQueue.put \u7B49\uFF0C\u6709\u4E24\u79CD\u5B9E\u7528\u7B56\u7565\u53EF\u7528\u4E8E\u5904\u7406 InterruptedException\uFF1A</p><ul><li><p>\u4F20\u9012\u5F02\u5E38\uFF08\u53EF\u80FD\u5728\u6267\u884C\u67D0\u4E2A\u7279\u5B9A\u4E8E\u4EFB\u52A1\u7684\u6E05\u9664\u64CD\u4F5C\u4E4B\u540E\uFF09\uFF0C\u4ECE\u800C\u4F7F\u4F60\u7684\u65B9\u6CD5\u4E5F\u6210\u4E3A\u53EF\u4E2D\u65AD\u7684\u963B\u585E\u65B9\u6CD5\u3002</p></li><li><p>\u6062\u590D\u4E2D\u65AD\u72B6\u6001\uFF0C\u4ECE\u800C\u4F7F\u8C03\u7528\u6808\u4E2D\u7684\u4E0A\u5C42\u4EE3\u7801\u80FD\u591F\u5BF9\u5176\u8FDB\u884C\u5904\u7406\u3002</p></li></ul><p>\u4F20\u9012 InterruptedException \u4E0E\u5C06 InterruptedException \u6DFB\u52A0\u5230 throws \u5B50\u53E5\u4E2D\u4E00\u6837\u5BB9\u6613\uFF0C\u5982\u7A0B\u5E8F\u6E05\u53557-6 \u4E2D\u7684 getNextTask \u6240\u793A\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-6 \u5C06 InterruptedException \u4F20\u9012\u7ED9\u8C03\u7528\u8005</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">;</span>

<span class="token comment">// ......</span>

<span class="token keyword">public</span> <span class="token class-name">Task</span> <span class="token function">getNextTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> queue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5982\u679C\u4E0D\u60F3\u6216\u65E0\u6CD5\u4F20\u9012 InterruptedException\uFF08\u6216\u8BB8\u901A\u8FC7 Runnable \u6765\u5B9A\u4E49\u4EFB\u52A1\uFF09\uFF0C\u90A3\u4E48\u9700\u8981\u5BFB\u627E\u53E6\u4E00\u79CD\u65B9\u5F0F\u6765\u4FDD\u5B58\u4E2D\u65AD\u8BF7\u6C42\u3002\u4E00\u79CD\u6807\u51C6\u7684\u65B9\u6CD5\u5C31\u662F\u901A\u8FC7\u518D\u6B21\u8C03\u7528 interrupt \u6765\u6062\u590D\u4E2D\u65AD\u72B6\u6001\u3002\u4F60\u4E0D\u80FD\u5C4F\u853D InterruptedException\uFF0C\u4F8B\u5982\u5728 catch \u5757\u4E2D\u6355\u83B7\u5230\u5F02\u5E38\u5374\u4E0D\u505A\u4EFB\u4F55\u5904\u7406\uFF0C\u9664\u975E\u5728\u4F60\u7684\u4EE3\u7801\u4E2D\u5B9E\u73B0\u4E86\u7EBF\u7A0B\u7684\u4E2D\u65AD\u7B56\u7565\u3002\u867D\u7136 PrimeProducer \u5C4F\u853D\u4E86\u4E2D\u65AD\uFF0C\u4F46\u8FD9\u662F\u56E0\u4E3A\u5B83\u5DF2\u7ECF\u77E5\u9053\u7EBF\u7A0B\u5C06\u8981\u7ED3\u675F\uFF0C\u56E0\u6B64\u5728\u8C03\u7528\u6808\u4E2D\u5DF2\u7ECF\u6CA1\u6709\u4E0A\u5C42\u4EE3\u7801\u9700\u8981\u77E5\u9053\u4E2D\u65AD\u4FE1\u606F\u3002\u7531\u4E8E\u5927\u591A\u6570\u4EE3\u7801\u5E76\u4E0D\u77E5\u9053\u5B83\u4EEC\u5C06\u5728\u54EA\u4E2A\u7EBF\u7A0B\u4E2D\u8FD0\u884C\uFF0C\u56E0\u6B64\u5E94\u8BE5\u4FDD\u5B58\u4E2D\u65AD\u72B6\u6001\u3002</p><p>\u53EA\u6709\u5B9E\u73B0\u4E86\u7EBF\u7A0B\u4E2D\u65AD\u7B56\u7565\u7684\u4EE3\u7801\u624D\u53EF\u4EE5\u5C4F\u853D\u4E2D\u65AD\u8BF7\u6C42\u3002\u5728\u5E38\u89C4\u7684\u4EFB\u52A1\u548C\u5E93\u4EE3\u7801\u4E2D\u90FD\u4E0D\u5E94\u8BE5\u5C4F\u853D\u4E2D\u65AD\u8BF7\u6C42\u3002</p><p>\u5BF9\u4E8E\u4E00\u4E9B\u4E0D\u652F\u6301\u53D6\u6D88\u4F46\u4ECD\u53EF\u4EE5\u8C03\u7528\u53EF\u4E2D\u65AD\u963B\u585E\u65B9\u6CD5\u7684\u64CD\u4F5C\uFF0C\u5B83\u4EEC\u5FC5\u987B\u5728\u5FAA\u73AF\u4E2D\u8C03\u7528\u8FD9\u4E9B\u65B9\u6CD5\uFF0C\u5E76\u5728\u53D1\u73B0\u4E2D\u65AD\u540E\u91CD\u65B0\u5C1D\u8BD5\u3002\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u5B83\u4EEC\u5E94\u8BE5\u5728\u672C\u5730\u4FDD\u5B58\u4E2D\u65AD\u72B6\u6001\uFF0C\u5E76\u5728\u8FD4\u56DE\u524D\u6062\u590D\u72B6\u6001\u800C\u4E0D\u662F\u5728\u6355\u83B7 InterruptedException \u65F6\u6062\u590D\u72B6\u6001\uFF0C\u5982\u7A0B\u5E8F\u6E05\u53557-7 \u6240\u793A\u3002\u5982\u679C\u8FC7\u65E9\u5730\u8BBE\u7F6E\u4E2D\u65AD\u72B6\u6001\uFF0C\u5C31\u53EF\u80FD\u5F15\u8D77\u65E0\u9650\u5FAA\u73AF\uFF0C\u56E0\u4E3A\u5927\u591A\u6570\u53EF\u4E2D\u65AD\u7684\u963B\u585E\u65B9\u6CD5\u90FD\u4F1A\u5728\u5165\u53E3\u5904\u68C0\u67E5\u4E2D\u65AD\u72B6\u6001\uFF0C\u5E76\u4E14\u5F53\u53D1\u73B0\u8BE5\u72B6\u6001\u5DF2\u88AB\u8BBE\u7F6E\u65F6\u4F1A\u7ACB\u5373\u629B\u51FA InterruptedException\u3002\uFF08\u901A\u5E38\uFF0C\u53EF\u4E2D\u65AD\u7684\u65B9\u6CD5\u4F1A\u5728\u963B\u585E\u6216\u8FDB\u884C\u91CD\u8981\u7684\u5DE5\u4F5C\u524D\u9996\u5148\u68C0\u67E5\u4E2D\u65AD\uFF0C\u4ECE\u800C\u5C3D\u5FEB\u5730\u54CD\u5E94\u4E2D\u65AD\uFF09\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-7 \u4E0D\u53EF\u53D6\u6D88\u7684\u4EFB\u52A1\u5728\u9000\u51FA\u524D\u6062\u590D\u4E2D\u65AD</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Task</span> <span class="token function">getNextTask</span><span class="token punctuation">(</span><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> queue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment">// \u91CD\u65B0\u5C1D\u8BD5</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interrupted<span class="token punctuation">)</span> 
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5982\u679C\u4EE3\u7801\u4E0D\u4F1A\u8C03\u7528\u53EF\u4E2D\u65AD\u7684\u963B\u585E\u65B9\u6CD5\uFF0C\u90A3\u4E48\u4ECD\u7136\u53EF\u4EE5\u901A\u8FC7\u5728\u4EFB\u52A1\u4EE3\u7801\u4E2D\u8F6E\u8BE2\u5F53\u524D\u7EBF\u7A0B\u7684\u4E2D\u65AD\u72B6\u6001\u6765\u54CD\u5E94\u4E2D\u65AD\u3002\u8981\u9009\u62E9\u5408\u9002\u7684\u8F6E\u8BE2\u9891\u7387\uFF0C\u5C31\u9700\u8981\u5728\u6548\u7387\u548C\u54CD\u5E94\u6027\u4E4B\u95F4\u8FDB\u884C\u6743\u8861\u3002\u5982\u679C\u54CD\u5E94\u6027\u8981\u6C42\u8F83\u9AD8\uFF0C\u90A3\u4E48\u4E0D\u5E94\u8BE5\u8C03\u7528\u90A3\u4E9B\u6267\u884C\u65F6\u95F4\u8F83\u957F\u5E76\u4E14\u4E0D\u54CD\u5E94\u4E2D\u65AD\u7684\u65B9\u6CD5\uFF0C\u4ECE\u800C\u5BF9\u53EF\u8C03\u7528\u7684\u5E93\u4EE3\u7801\u8FDB\u884C\u4E00\u4E9B\u9650\u5236\u3002</p><p>\u5728\u53D6\u6D88\u8FC7\u7A0B\u4E2D\u53EF\u80FD\u6D89\u53CA\u9664\u4E86\u4E2D\u65AD\u72B6\u6001\u4E4B\u5916\u7684\u5176\u4ED6\u72B6\u6001\u3002\u4E2D\u65AD\u53EF\u4EE5\u7528\u6765\u83B7\u5F97\u7EBF\u7A0B\u7684\u6CE8\u610F\uFF0C\u5E76\u4E14\u7531\u4E2D\u65AD\u7EBF\u7A0B\u4FDD\u5B58\u7684\u4FE1\u606F\uFF0C\u53EF\u4EE5\u4E3A\u4E2D\u65AD\u7684\u7EBF\u7A0B\u63D0\u4F9B\u8FDB\u4E00\u6B65\u7684\u6307\u793A\u3002\uFF08\u5F53\u8BBF\u95EE\u8FD9\u4E9B\u4FE1\u606F\u65F6\uFF0C\u8981\u786E\u4FDD\u4F7F\u7528\u540C\u6B65\u3002\uFF09</p><p>\u4F8B\u5982\uFF0C\u5F53\u4E00\u4E2A\u7531 ThreadPoolExecutor \u62E5\u6709\u7684\u5DE5\u4F5C\u8005\u7EBF\u7A0B\u68C0\u6D4B\u5230\u4E2D\u65AD\u65F6\uFF0C\u5B83\u4F1A\u68C0\u67E5\u7EBF\u7A0B\u6C60\u662F\u5426\u6B63\u5728\u5173\u95ED\u3002\u5982\u679C\u662F\uFF0C\u5B83\u4F1A\u5728\u7ED3\u675F\u4E4B\u524D\u6267\u884C\u4E00\u4E9B\u7EBF\u7A0B\u6C60\u6E05\u7406\u5DE5\u4F5C\uFF0C\u5426\u5219\u5B83\u53EF\u80FD\u521B\u5EFA\u4E00\u4E2A\u65B0\u7EBF\u7A0B\u5C06\u7EBF\u7A0B\u6C60\u6062\u590D\u5230\u5408\u7406\u7684\u89C4\u6A21\u3002</p><h3 id="_7-1-4-\u793A\u4F8B-\u8BA1\u65F6\u8FD0\u884C" tabindex="-1"><a class="header-anchor" href="#_7-1-4-\u793A\u4F8B-\u8BA1\u65F6\u8FD0\u884C" aria-hidden="true">#</a> 7.1.4 \u793A\u4F8B\uFF1A\u8BA1\u65F6\u8FD0\u884C</h3><p>\u8BB8\u591A\u95EE\u9898\u6C38\u8FDC\u4E5F\u65E0\u6CD5\u89E3\u51B3\uFF08\u4F8B\u5982\uFF0C\u679A\u4E3E\u6240\u6709\u7684\u7D20\u6570\uFF09\uFF0C\u800C\u67D0\u4E9B\u95EE\u9898\uFF0C\u80FD\u5F88\u5FEB\u5F97\u5230\u7B54\u6848\uFF0C\u4E5F\u53EF\u80FD\u6C38\u8FDC\u5F97\u4E0D\u5230\u7B54\u6848\u3002\u5728\u8FD9\u4E9B\u60C5\u51B5\u4E0B\uFF0C\u5982\u679C\u80FD\u591F\u6307\u5B9A \u201C\u6700\u591A\u82B1 10 \u5206\u949F\u641C\u7D22\u7B54\u6848\u201D \u6216\u8005 \u201C\u679A\u4E3E\u51FA\u5728 10 \u5206\u949F\u5185\u80FD\u627E\u5230\u7684\u7B54\u6848\u201D\uFF0C\u90A3\u4E48\u5C06\u662F\u975E\u5E38\u6709\u7528\u7684\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-2 \u4E2D\u7684 aSecondOfPrimes \u65B9\u6CD5\u5C06\u542F\u52A8\u4E00\u4E2A PrimeGenerator\uFF0C\u5E76\u5728 1 \u79D2\u949F\u540E\u4E2D\u65AD\u3002\u5C3D\u7BA1 PrimeGenerator \u53EF\u80FD\u9700\u8981\u8D85\u8FC7 1 \u79D2\u7684\u65F6\u95F4\u624D\u80FD\u505C\u6B62\uFF0C\u4F46\u5B83\u6700\u7EC8\u4F1A\u53D1\u73B0\u4E2D\u65AD\uFF0C\u7136\u540E\u505C\u6B62\uFF0C\u5E76\u4F7F\u7EBF\u7A0B\u7ED3\u675F\u3002\u5728\u6267\u884C\u4EFB\u52A1\u65F6\u7684\u53E6\u4E00\u4E2A\u65B9\u9762\u662F\uFF0C\u4F60\u5E0C\u671B\u77E5\u9053\u5728\u4EFB\u52A1\u6267\u884C\u8FC7\u7A0B\u4E2D\u662F\u5426\u4F1A\u629B\u51FA\u5F02\u5E38\u3002\u5982\u679C PrimeGenerator \u5728\u6307\u5B9A\u65F6\u9650\u5185\u629B\u51FA\u4E86\u4E00\u4E2A\u672A\u68C0\u67E5\u7684\u5F02\u5E38\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u5F02\u5E38\u53EF\u80FD\u4F1A\u88AB\u5FFD\u7565\uFF0C\u56E0\u4E3A\u7D20\u6570\u751F\u6210\u5668\u5728\u53E6\u4E00\u4E2A\u72EC\u7ACB\u7684\u7EBF\u7A0B\u4E2D\u8FD0\u884C\uFF0C\u800C\u8FD9\u4E2A\u7EBF\u7A0B\u5E76\u4E0D\u4F1A\u663E\u5F0F\u5730\u5904\u7406\u5F02\u5E38\u3002</p><p>\u5728\u7A0B\u5E8F\u6E05\u53557-8 \u4E2D\u7ED9\u51FA\u4E86\u5728\u6307\u5B9A\u65F6\u95F4\u5185\u8FD0\u884C\u4E00\u4E2A\u4EFB\u610F\u7684 Runnable \u7684\u793A\u4F8B\u3002\u5B83\u5728\u8C03\u7528\u7EBF\u7A0B\u4E2D\u8FD0\u884C\u4EFB\u52A1\uFF0C\u5E76\u5B89\u6392\u4E86\u4E00\u4E2A\u53D6\u6D88\u4EFB\u52A1\uFF0C\u5728\u8FD0\u884C\u6307\u5B9A\u7684\u65F6\u95F4\u95F4\u9694\u540E\u4E2D\u65AD\u5B83\u3002\u8FD9\u89E3\u51B3\u4E86\u4ECE\u4EFB\u52A1\u4E2D\u629B\u51FA\u672A\u68C0\u67E5\u5F02\u5E38\u7684\u95EE\u9898\uFF0C\u56E0\u4E3A\u8BE5\u5F02\u5E38\u4F1A\u88AB timedRun \u7684\u8C03\u7528\u8005\u6355\u83B7\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-8 \u5728\u5916\u90E8\u7EBF\u7A0B\u4E2D\u5B89\u6392\u4E2D\u65AD\uFF08\u4E0D\u8981\u8FD9\u4E48\u505A\uFF09</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ScheduledExecutorService</span> cancelExec <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">timedRun</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> taskThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cancelExec<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            taskThread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u662F\u4E00\u79CD\u975E\u5E38\u7B80\u5355\u7684\u65B9\u6CD5\uFF0C\u4F46\u5374\u7834\u574F\u4E86\u4EE5\u4E0B\u89C4\u5219\uFF1A\u5728\u4E2D\u65AD\u7EBF\u7A0B\u4E4B\u524D\uFF0C\u5E94\u8BE5\u4E86\u89E3\u5B83\u7684\u4E2D\u65AD\u7B56\u7565\u3002\u7531\u4E8E timedRun \u53EF\u4EE5\u4ECE\u4EFB\u610F\u4E00\u4E2A\u7EBF\u7A0B\u4E2D\u8C03\u7528\uFF0C\u56E0\u6B64\u5B83\u65E0\u6CD5\u77E5\u9053\u8FD9\u4E2A\u8C03\u7528\u7EBF\u7A0B\u7684\u4E2D\u65AD\u7B56\u7565\u3002\u5982\u679C\u4EFB\u52A1\u5728\u8D85\u65F6\u4E4B\u524D\u5B8C\u6210\uFF0C\u90A3\u4E48\u4E2D\u65AD timedRun \u6240\u5728\u7EBF\u7A0B\u7684\u53D6\u6D88\u4EFB\u52A1\u5C06\u5728 timedRun \u8FD4\u56DE\u5230\u8C03\u7528\u8005\u4E4B\u540E\u542F\u52A8\u3002\u6211\u4EEC\u4E0D\u77E5\u9053\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\u5C06\u8FD0\u884C\u4EC0\u4E48\u4EE3\u7801\uFF0C\u4F46\u7ED3\u679C\u4E00\u5B9A\u662F\u4E0D\u597D\u7684\u3002\uFF08\u53EF\u4EE5\u4F7F\u7528 schedule \u8FD4\u56DE\u7684 ScheduledFuture \u6765\u53D6\u6D88\u8FD9\u4E2A\u53D6\u6D88\u4EFB\u52A1\u4EE5\u907F\u514D\u8FD9\u79CD\u98CE\u9669\uFF0C\u8FD9\u79CD\u505A\u6CD5\u867D\u7136\u53EF\u884C\uFF0C\u4F46\u5374\u975E\u5E38\u590D\u6742\u3002\uFF09</p><p>\u800C\u4E14\uFF0C\u5982\u679C\u4EFB\u52A1\u4E0D\u54CD\u5E94\u4E2D\u65AD\uFF0C\u90A3\u4E48 timedRun \u4F1A\u5728\u4EFB\u52A1\u7ED3\u675F\u65F6\u624D\u8FD4\u56DE\uFF0C\u6B64\u65F6\u53EF\u80FD\u5DF2\u7ECF\u8D85\u8FC7\u4E86\u6307\u5B9A\u7684\u65F6\u9650\uFF08\u6216\u8005\u8FD8\u6CA1\u6709\u8D85\u8FC7\u65F6\u9650\uFF09\u3002\u5982\u679C\u67D0\u4E2A\u9650\u65F6\u8FD0\u884C\u7684\u670D\u52A1\u6CA1\u6709\u5728\u6307\u5B9A\u7684\u65F6\u95F4\u5185\u8FD4\u56DE\uFF0C\u90A3\u4E48\u5C06\u5BF9\u8C03\u7528\u8005\u5E26\u6765\u8D1F\u9762\u5F71\u54CD\u3002</p><p>\u5728\u7A0B\u5E8F\u6E05\u53557-9 \u4E2D\u89E3\u51B3\u4E86 aSecondOfPrimes \u7684\u5F02\u5E38\u5904\u7406\u95EE\u9898\u4EE5\u53CA\u4E4B\u524D\u89E3\u51B3\u65B9\u6848\u4E2D\u7684\u95EE\u9898\u3002\u6267\u884C\u4EFB\u52A1\u7684\u7EBF\u7A0B\u62E5\u6709\u81EA\u5DF1\u7684\u6267\u884C\u7B56\u7565\uFF0C\u5373\u4F7F\u4EFB\u52A1\u4E0D\u54CD\u5E94\u4E2D\u65AD\uFF0C\u9650\u65F6\u8FD0\u884C\u7684\u65B9\u6CD5\u4ECD\u80FD\u8FD4\u56DE\u5230\u5B83\u7684\u8C03\u7528\u8005\u3002\u5728\u542F\u52A8\u4EFB\u52A1\u7EBF\u7A0B\u4E4B\u540E\uFF0CtimedRun \u5C06\u6267\u884C\u4E00\u4E2A\u9650\u65F6\u7684 join \u65B9\u6CD5\u3002\u5728 join \u8FD4\u56DE\u540E\uFF0C\u5B83\u5C06\u68C0\u67E5\u4EFB\u52A1\u4E2D\u662F\u5426\u6709\u5F02\u5E38\u629B\u51FA\uFF0C\u5982\u679C\u6709\u7684\u8BDD\uFF0C\u5219\u4F1A\u5728\u8C03\u7528 timedRun \u7684\u7EBF\u7A0B\u4E2D\u518D\u6B21\u629B\u51FA\u8BE5\u5F02\u5E38\u3002\u7531\u4E8E Throwable \u5C06\u5728\u4E24\u4E2A\u7EBF\u7A0B\u4E4B\u95F4\u5171\u4EAB\uFF0C\u56E0\u6B64\u8BE5\u53D8\u91CF\u88AB\u58F0\u660E\u4E3A volatile \u7C7B\u578B\uFF0C\u4ECE\u800C\u786E\u4FDD\u5B89\u5168\u5730\u5C06\u5176\u4ECE\u4EFB\u52A1\u7EBF\u7A0B\u53D1\u5E03\u5230 timedRun \u7EBF\u7A0B\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-9 \u5728\u4E13\u95E8\u7684\u7EBF\u7A0B\u4E2D\u4E2D\u65AD\u4EFB\u52A1</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">timedRun</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">RethrowableTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Throwable</span> t<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>t <span class="token operator">=</span> t<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">rethrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
                <span class="token keyword">throw</span> <span class="token function">launderThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">RethrowableTask</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RethrowableTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> taskThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    taskThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cancelExec<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            taskThread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    taskThread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    task<span class="token punctuation">.</span><span class="token function">rethrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u8FD9\u4E2A\u793A\u4F8B\u7684\u4EE3\u7801\u4E2D\u89E3\u51B3\u4E86\u524D\u9762\u793A\u4F8B\u4E2D\u7684\u95EE\u9898\uFF0C\u4F46\u7531\u4E8E\u5B83\u4F9D\u8D56\u4E8E\u4E00\u4E2A\u9650\u65F6\u7684 join\uFF0C\u56E0\u6B64\u5B58\u5728\u7740 join \u7684\u4E0D\u8DB3\uFF1A\u65E0\u6CD5\u77E5\u9053\u6267\u884C\u63A7\u5236\u662F\u56E0\u4E3A\u7EBF\u7A0B\u6B63\u5E38\u9000\u51FA\u800C\u8FD4\u56DE\u8FD8\u662F\u56E0\u4E3A join \u8D85\u65F6\u800C\u8FD4\u56DE\u3002<sup class="footnote-ref"><a href="#footnote2">[2]</a><a class="footnote-anchor" id="footnote-ref2"></a></sup></p><h3 id="_7-1-5-\u901A\u8FC7-future-\u6765\u5B9E\u73B0\u53D6\u6D88" tabindex="-1"><a class="header-anchor" href="#_7-1-5-\u901A\u8FC7-future-\u6765\u5B9E\u73B0\u53D6\u6D88" aria-hidden="true">#</a> 7.1.5 \u901A\u8FC7 Future \u6765\u5B9E\u73B0\u53D6\u6D88</h3><p>\u6211\u4EEC\u5DF2\u7ECF\u4F7F\u7528\u4E86\u4E00\u79CD\u62BD\u8C61\u673A\u5236\u6765\u7BA1\u7406\u4EFB\u52A1\u7684\u751F\u547D\u5468\u671F\uFF0C\u5904\u7406\u5F02\u5E38\uFF0C\u4EE5\u53CA\u5B9E\u73B0\u53D6\u6D88\uFF0C\u5373 Future\u3002\u901A\u5E38\uFF0C\u4F7F\u7528\u73B0\u6709\u5E93\u4E2D\u7684\u7C7B\u6BD4\u81EA\u884C\u7F16\u5199\u66F4\u597D\uFF0C\u56E0\u6B64\u6211\u4EEC\u5C06\u7EE7\u7EED\u4F7F\u7528 Future \u548C\u4EFB\u52A1\u6267\u884C\u6846\u67B6\u6765\u6784\u5EFA timedRun\u3002</p><p>ExecutorService.submit \u5C06\u8FD4\u56DE\u4E00\u4E2A Future \u6765\u63CF\u8FF0\u4EFB\u52A1\u3002Future \u62E5\u6709\u4E00\u4E2Acancel \u65B9\u6CD5\uFF0C\u8BE5\u65B9\u6CD5\u5E26\u6709\u4E00\u4E2A boolean \u7C7B\u578B\u7684\u53C2\u6570 mayInterruptIfRunning\uFF0C\u8868\u793A\u53D6\u6D88\u64CD\u4F5C\u662F\u5426\u6210\u529F\u3002\uFF08\u8FD9\u53EA\u662F\u8868\u793A\u4EFB\u52A1\u662F\u5426\u80FD\u591F\u63A5\u6536\u4E2D\u65AD\uFF0C\u800C\u4E0D\u662F\u8868\u793A\u4EFB\u52A1\u662F\u5426\u80FD\u68C0\u6D4B\u5E76\u5904\u7406\u4E2D\u65AD\u3002\uFF09\u5982\u679C mayInterruptIfRunning \u4E3A true \u5E76\u4E14\u4EFB\u52A1\u5F53\u524D\u6B63\u5728\u67D0\u4E2A\u7EBF\u7A0B\u4E2D\u8FD0\u884C\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u7EBF\u7A0B\u80FD\u88AB\u4E2D\u65AD\u3002\u5982\u679C\u8FD9\u4E2A\u53C2\u6570\u4E3A false\uFF0C\u90A3\u4E48\u610F\u5473\u7740 \u201C\u82E5\u4EFB\u52A1\u8FD8\u6CA1\u6709\u542F\u52A8\uFF0C\u5C31\u4E0D\u8981\u8FD0\u884C\u5B83\u201D\uFF0C\u8FD9\u79CD\u65B9\u5F0F\u5E94\u8BE5\u7528\u4E8E\u90A3\u4E9B\u4E0D\u5904\u7406\u4E2D\u65AD\u7684\u4EFB\u52A1\u4E2D\u3002</p><p>\u9664\u975E\u4F60\u6E05\u695A\u7EBF\u7A0B\u7684\u4E2D\u65AD\u7B56\u7565\uFF0C\u5426\u5219\u4E0D\u8981\u4E2D\u65AD\u7EBF\u7A0B\uFF0C\u90A3\u4E48\u5728\u4EC0\u4E48\u60C5\u51B5\u4E0B\u8C03\u7528 cancel \u53EF\u4EE5\u5C06\u53C2\u6570\u6307\u5B9A\u4E3A true\uFF1F\u6267\u884C\u4EFB\u52A1\u7684\u7EBF\u7A0B\u662F\u7531\u6807\u51C6\u7684 Executor \u521B\u5EFA\u7684\uFF0C\u5B83\u5B9E\u73B0\u4E86\u4E00\u79CD\u4E2D\u65AD\u7B56\u7565\u4F7F\u5F97\u4EFB\u52A1\u53EF\u4EE5\u901A\u8FC7\u4E2D\u65AD\u88AB\u53D6\u6D88\uFF0C\u6240\u4EE5\u5982\u679C\u4EFB\u52A1\u5728\u6807\u51C6 Executor \u4E2D\u8FD0\u884C\uFF0C\u5E76\u901A\u8FC7\u5B83\u4EEC\u7684 Future \u6765\u53D6\u6D88\u4EFB\u52A1\uFF0C\u90A3\u4E48\u53EF\u4EE5\u8BBE\u7F6E mayInterruptIfRunning\u3002\u5F53\u5C1D\u8BD5\u53D6\u6D88\u67D0\u4E2A\u4EFB\u52A1\u65F6\uFF0C\u4E0D\u5B9C\u76F4\u63A5\u4E2D\u65AD\u7EBF\u7A0B\u6C60\uFF0C\u56E0\u4E3A\u4F60\u5E76\u4E0D\u77E5\u9053\u5F53\u4E2D\u65AD\u8BF7\u6C42\u5230\u8FBE\u65F6\u6B63\u5728\u8FD0\u884C\u4EC0\u4E48\u4EFB\u52A1\u2014\u2014\u53EA\u80FD\u901A\u8FC7\u4EFB\u52A1\u7684 Future \u6765\u5B9E\u73B0\u53D6\u6D88\u3002\u8FD9\u4E5F\u662F\u5728\u7F16\u5199\u4EFB\u52A1\u65F6\u8981\u5C06\u4E2D\u65AD\u89C6\u4E3A\u4E00\u4E2A\u53D6\u6D88\u8BF7\u6C42\u7684\u53E6\u4E00\u4E2A\u7406\u7531\uFF1A\u53EF\u4EE5\u901A\u8FC7\u4EFB\u52A1\u7684 Future \u6765\u53D6\u6D88\u5B83\u4EEC\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-10 \u7ED9\u51FA\u4E86\u53E6\u4E00\u4E2A\u7248\u672C\u7684 timedRun\uFF1A\u5C06\u4EFB\u52A1\u63D0\u4EA4\u7ED9\u4E00\u4E2A ExecutorService\uFF0C\u5E76\u901A\u8FC7\u4E00\u4E2A\u5B9A\u65F6\u7684 Future.get \u6765\u83B7\u5F97\u7ED3\u679C\u3002\u5982\u679C get \u5728\u8FD4\u56DE\u65F6\u629B\u51FA\u4E86\u4E00\u4E2A TimeoutException\uFF0C\u90A3\u4E48\u4EFB\u52A1\u5C06\u901A\u8FC7\u5B83\u7684 Future \u6765\u53D6\u6D88\u3002\uFF08\u4E3A\u4E86\u7B80\u5316\u4EE3\u7801\uFF0C\u8FD9\u4E2A\u7248\u672C\u7684 timedRun \u5728 finally \u5757\u4E2D\u5C06\u76F4\u63A5\u8C03\u7528 Future.cancel\uFF0C\u56E0\u4E3A\u53D6\u6D88\u4E00\u4E2A\u5DF2\u5B8C\u6210\u7684\u4EFB\u52A1\u4E0D\u4F1A\u5E26\u6765\u4EFB\u4F55\u5F71\u54CD\u3002\uFF09\u5982\u679C\u4EFB\u52A1\u5728\u88AB\u53D6\u6D88\u524D\u5C31\u629B\u51FA\u4E00\u4E2A\u5F02\u5E38\uFF0C\u90A3\u4E48\u8BE5\u5F02\u5E38\u5C06\u88AB\u91CD\u65B0\u629B\u51FA\u4EE5\u4FBF\u7531\u8C03\u7528\u8005\u6765\u5904\u7406\u5F02\u5E38\u3002\u5728\u7A0B\u5E8F\u6E05\u53557-10 \u4E2D\u8FD8\u7ED9\u51FA\u4E86\u53E6\u4E00\u79CD\u826F\u597D\u7684\u7F16\u7A0B\u4E60\u60EF\uFF1A\u53D6\u6D88\u90A3\u4E9B\u4E0D\u518D\u9700\u8981\u7ED3\u679C\u7684\u4EFB\u52A1\u3002\uFF08\u5728\u7A0B\u5E8F\u6E05\u53556-13 \u548C\u7A0B\u5E8F\u6E05\u53556-16 \u4E2D\u4F7F\u7528\u4E86\u76F8\u540C\u7684\u6280\u672F\u3002\uFF09</p><p>\u7A0B\u5E8F\u6E05\u53557-10 \u901A\u8FC7 Future \u6765\u53D6\u6D88\u4EFB\u52A1</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">timedRun</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> task <span class="token operator">=</span> taskExec<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        task<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u63A5\u4E0B\u6765\u4EFB\u52A1\u5C06\u88AB\u53D6\u6D88</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5982\u679C\u5728\u4EFB\u52A1\u4E2D\u629B\u51FA\u4E86\u5F02\u5E38\uFF0C\u90A3\u4E48\u91CD\u65B0\u629B\u51FA\u8BE5\u5F02\u5E38</span>
        <span class="token keyword">throw</span> <span class="token function">launderThrowable</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5982\u679C\u4EFB\u52A1\u5DF2\u7ECF\u7ED3\u675F\uFF0C\u90A3\u4E48\u6267\u884C\u53D6\u6D88\u64CD\u4F5C\u4E5F\u4E0D\u4F1A\u5E26\u6765\u4EFB\u4F55\u5F71\u54CD</span>
        <span class="token comment">// \u5982\u679C\u4EFB\u52A1\u6B63\u5728\u8FD0\u884C\uFF0C\u90A3\u4E48\u5C06\u88AB\u4E2D\u65AD</span>
        task<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5F53 Future.get \u629B\u51FA InterruptedException \u6216 TimeoutException \u65F6\uFF0C\u5982\u679C\u4F60\u77E5\u9053\u4E0D\u518D\u9700\u8981\u7ED3\u679C\uFF0C\u90A3\u4E48\u5C31\u53EF\u4EE5\u8C03\u7528 Future.cancel \u6765\u53D6\u6D88\u4EFB\u52A1\u3002</p><h3 id="_7-1-6-\u5904\u7406\u4E0D\u53EF\u4E2D\u65AD\u7684\u963B\u585E" tabindex="-1"><a class="header-anchor" href="#_7-1-6-\u5904\u7406\u4E0D\u53EF\u4E2D\u65AD\u7684\u963B\u585E" aria-hidden="true">#</a> 7.1.6 \u5904\u7406\u4E0D\u53EF\u4E2D\u65AD\u7684\u963B\u585E</h3><p>\u5728 Java \u5E93\u4E2D\uFF0C\u8BB8\u591A\u53EF\u963B\u585E\u7684\u65B9\u6CD5\u90FD\u662F\u901A\u8FC7\u63D0\u524D\u8FD4\u56DE\u6216\u8005\u629B\u51FA InterruptedException \u6765\u54CD\u5E94\u4E2D\u65AD\u8BF7\u6C42\u7684\uFF0C\u4ECE\u800C\u4F7F\u5F00\u53D1\u4EBA\u5458\u66F4\u5BB9\u6613\u6784\u5EFA\u51FA\u80FD\u54CD\u5E94\u53D6\u6D88\u8BF7\u6C42\u7684\u4EFB\u52A1\u3002\u7136\u800C\uFF0C\u5E76\u975E\u6240\u6709\u7684\u53EF\u963B\u585E\u65B9\u6CD5\u6216\u8005\u963B\u585E\u673A\u5236\u90FD\u80FD\u54CD\u5E94\u4E2D\u65AD\uFF1B\u5982\u679C\u4E00\u4E2A\u7EBF\u7A0B\u7531\u4E8E\u6267\u884C\u540C\u6B65\u7684 Socket I/O \u6216\u8005\u7B49\u5F85\u83B7\u5F97\u5185\u7F6E\u9501\u800C\u963B\u585E\uFF0C\u90A3\u4E48\u4E2D\u65AD\u8BF7\u6C42\u53EA\u80FD\u8BBE\u7F6E\u7EBF\u7A0B\u7684\u4E2D\u65AD\u72B6\u6001\uFF0C\u9664\u6B64\u4E4B\u5916\u6CA1\u6709\u5176\u4ED6\u4EFB\u4F55\u4F5C\u7528\u3002\u5BF9\u4E8E\u90A3\u4E9B\u7531\u4E8E\u6267\u884C\u4E0D\u53EF\u4E2D\u65AD\u64CD\u4F5C\u800C\u88AB\u963B\u585E\u7684\u7EBF\u7A0B\uFF0C\u53EF\u4EE5\u4F7F\u7528\u7C7B\u4F3C\u4E8E\u4E2D\u65AD\u7684\u624B\u6BB5\u6765\u505C\u6B62\u8FD9\u4E9B\u7EBF\u7A0B\uFF0C\u4F46\u8FD9\u8981\u6C42\u6211\u4EEC\u5FC5\u987B\u77E5\u9053\u7EBF\u7A0B\u963B\u585E\u7684\u539F\u56E0\u3002</p>`,90),k={href:"http://Java.io",target:"_blank",rel:"noopener noreferrer"},r=s("Java.io"),d=s(" \u5305\u4E2D\u7684\u540C\u6B65 Socket I/O\u3002\u5728\u670D\u52A1\u5668\u5E94\u7528\u7A0B\u5E8F\u4E2D\uFF0C\u6700\u5E38\u89C1\u7684\u963B\u585E I/O \u5F62\u5F0F\u5C31\u662F\u5BF9\u5957\u63A5\u5B57\u8FDB\u884C\u8BFB\u53D6\u548C\u5199\u5165\u3002\u867D\u7136 InputStream \u548C OutputStream \u4E2D\u7684 read \u548C write \u7B49\u65B9\u6CD5\u90FD\u4E0D\u4F1A\u54CD\u5E94\u4E2D\u65AD\uFF0C\u4F46\u901A\u8FC7\u5173\u95ED\u5E95\u5C42\u7684\u5957\u63A5\u5B57\uFF0C\u53EF\u4EE5\u4F7F\u5F97\u7531\u4E8E\u6267\u884C read \u6216 write \u7B49\u65B9\u6CD5\u800C\u88AB\u963B\u585E\u7684\u7EBF\u7A0B\u629B\u51FA\u4E00\u4E2A SocketException\u3002"),v={href:"http://Java.io",target:"_blank",rel:"noopener noreferrer"},m=s("Java.io"),b=s(" \u5305\u4E2D\u7684\u540C\u6B65 I/O\u3002\u5F53\u4E2D\u65AD\u4E00\u4E2A\u6B63\u5728 InterruptibleChannel \u4E0A\u7B49\u5F85\u7684\u7EBF\u7A0B\u65F6\uFF0C\u5C06\u629B\u51FA ClosedByInterruptException \u5E76\u5173\u95ED\u94FE\u8DEF\uFF08\u8FD9\u8FD8\u4F1A\u4F7F\u5F97\u5176\u4ED6\u5728\u8FD9\u6761\u94FE\u8DEF\u4E0A\u963B\u585E\u7684\u7EBF\u7A0B\u540C\u6837\u629B\u51FA ClosedByInterruptException\uFF09\u3002\u5F53\u5173\u95ED\u4E00\u4E2A InterruptibleChannel \u65F6\uFF0C\u5C06\u5BFC\u81F4\u6240\u6709\u5728\u94FE\u8DEF\u64CD\u4F5C\u4E0A\u963B\u585E\u7684\u7EBF\u7A0B\u90FD\u629B\u51FA AsynchronousCloseException\u3002\u5927\u591A\u6570\u6807\u51C6\u7684 Channel \u90FD\u5B9E\u73B0\u4E86 InterruptibleChannel\u3002"),w=e(`<p>Selector \u7684\u5F02\u6B65 I/O\u3002\u5982\u679C\u4E00\u4E2A\u7EBF\u7A0B\u5728\u8C03\u7528 Selector.select \u65B9\u6CD5\uFF08\u5728 java.nio.channels \u4E2D\uFF09\u65F6\u963B\u585E\u4E86\uFF0C\u90A3\u4E48\u8C03\u7528 close \u6216 wakeup \u65B9\u6CD5\u4F1A\u4F7F\u7EBF\u7A0B\u629B\u51FA ClosedSelectorException \u5E76\u63D0\u524D\u8FD4\u56DE\u3002</p><p>\u83B7\u53D6\u67D0\u4E2A\u9501\u3002\u5982\u679C\u4E00\u4E2A\u7EBF\u7A0B\u7531\u4E8E\u7B49\u5F85\u67D0\u4E2A\u5185\u7F6E\u9501\u800C\u963B\u585E\uFF0C\u90A3\u4E48\u5C06\u65E0\u6CD5\u54CD\u5E94\u4E2D\u65AD\uFF0C\u56E0\u4E3A\u7EBF\u7A0B\u8BA4\u4E3A\u5B83\u80AF\u5B9A\u4F1A\u83B7\u5F97\u9501\uFF0C\u6240\u4EE5\u5C06\u4E0D\u4F1A\u7406\u4F1A\u4E2D\u65AD\u8BF7\u6C42\u3002\u4F46\u662F\uFF0C\u5728 Lock \u7C7B\u4E2D\u63D0\u4F9B\u4E86 lockInterruptibly \u65B9\u6CD5\uFF0C\u8BE5\u65B9\u6CD5\u5141\u8BB8\u5728\u7B49\u5F85\u4E00\u4E2A\u9501\u7684\u540C\u65F6\u4ECD\u80FD\u54CD\u5E94\u4E2D\u65AD\uFF0C\u8BF7\u53C2\u89C1\u7B2C 13 \u7AE0\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-11 \u7684 ReaderThread \u7ED9\u51FA\u4E86\u5982\u4F55\u5C01\u88C5\u975E\u6807\u51C6\u7684\u53D6\u6D88\u64CD\u4F5C\u3002ReaderThread \u7BA1\u7406\u4E86\u4E00\u4E2A\u5957\u63A5\u5B57\u8FDE\u63A5\uFF0C\u5B83\u91C7\u7528\u540C\u6B65\u65B9\u5F0F\u4ECE\u8BE5\u5957\u63A5\u5B57\u4E2D\u8BFB\u53D6\u6570\u636E\uFF0C\u5E76\u5C06\u63A5\u6536\u5230\u7684\u6570\u636E\u4F20\u9012\u7ED9 processBuffer\u3002\u4E3A\u4E86\u7ED3\u675F\u67D0\u4E2A\u7528\u6237\u7684\u8FDE\u63A5\u6216\u8005\u5173\u95ED\u670D\u52A1\u5668\uFF0CReaderThread \u6539\u5199\u4E86 interrupt \u65B9\u6CD5\uFF0C\u4F7F\u5176\u65E2\u80FD\u5904\u7406\u6807\u51C6\u7684\u4E2D\u65AD\uFF0C\u4E5F\u80FD\u5173\u95ED\u5E95\u5C42\u7684\u5957\u63A5\u5B57\u3002\u56E0\u6B64\uFF0C\u65E0\u8BBA ReaderThread \u7EBF\u7A0B\u662F\u5728 read \u65B9\u6CD5\u4E2D\u963B\u585E\u8FD8\u662F\u5728\u67D0\u4E2A\u53EF\u4E2D\u65AD\u7684\u963B\u585E\u65B9\u6CD5\u4E2D\u963B\u585E\uFF0C\u90FD\u53EF\u4EE5\u88AB\u4E2D\u65AD\u5E76\u505C\u6B62\u6267\u884C\u5F53\u524D\u7684\u5DE5\u4F5C\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-11 \u901A\u8FC7\u6539\u5199 interrupt \u65B9\u6CD5\u5C06\u975E\u6807\u51C6\u7684\u53D6\u6D88\u64CD\u4F5C\u5C01\u88C5\u5728 Thread \u4E2D</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReaderThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Socket</span> socket<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">InputStream</span> in<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ReaderThread</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> socket<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>socket <span class="token operator">=</span> socket<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>in <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>BUFSZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> count <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
                    <span class="token function">processBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*\u5141\u8BB8\u7EBF\u7A0B\u9000\u51FA*/</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-1-7-\u91C7\u7528-newtaskfor-\u6765\u5C01\u88C5\u975E\u6807\u51C6\u7684\u53D6\u6D88" tabindex="-1"><a class="header-anchor" href="#_7-1-7-\u91C7\u7528-newtaskfor-\u6765\u5C01\u88C5\u975E\u6807\u51C6\u7684\u53D6\u6D88" aria-hidden="true">#</a> 7.1.7 \u91C7\u7528 newTaskFor \u6765\u5C01\u88C5\u975E\u6807\u51C6\u7684\u53D6\u6D88</h3><p>\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7 newTaskFor \u65B9\u6CD5\u6765\u8FDB\u4E00\u6B65\u4F18\u5316 ReaderThread \u4E2D\u5C01\u88C5\u975E\u6807\u51C6\u53D6\u6D88\u7684\u6280\u672F\uFF0C\u8FD9\u662F Java 6 \u5728 ThreadPoolExecutor \u4E2D\u7684\u65B0\u589E\u529F\u80FD\u3002\u5F53\u628A\u4E00\u4E2A Callable \u63D0\u4EA4\u7ED9 ExecutorService \u65F6\uFF0Csubmit \u65B9\u6CD5\u4F1A\u8FD4\u56DE\u4E00\u4E2A Future\uFF0C\u6211\u4EEC\u53EF\u4EE5\u901A\u8FC7\u8FD9\u4E2A Future \u6765\u53D6\u6D88\u4EFB\u52A1\u3002newTaskFor \u662F\u4E00\u4E2A\u5DE5\u5382\u65B9\u6CD5\uFF0C\u5B83\u5C06\u521B\u5EFA Future \u6765\u4EE3\u8868\u4EFB\u52A1\u3002newTaskFor \u8FD8\u80FD\u8FD4\u56DE\u4E00\u4E2A RunnableFuture \u63A5\u53E3\uFF0C\u8BE5\u63A5\u53E3\u6269\u5C55\u4E86 Future \u548C Runnable\uFF08\u5E76\u7531 FutureTask \u5B9E\u73B0\uFF09\u3002</p><p>\u901A\u8FC7\u5B9A\u5236\u8868\u793A\u4EFB\u52A1\u7684 Future \u53EF\u4EE5\u6539\u53D8 Future.cancel \u7684\u884C\u4E3A\u3002\u4F8B\u5982\uFF0C\u5B9A\u5236\u7684\u53D6\u6D88\u4EE3\u7801\u53EF\u4EE5\u5B9E\u73B0\u65E5\u5FD7\u8BB0\u5F55\u6216\u8005\u6536\u96C6\u53D6\u6D88\u64CD\u4F5C\u7684\u7EDF\u8BA1\u4FE1\u606F\uFF0C\u4EE5\u53CA\u53D6\u6D88\u4E00\u4E9B\u4E0D\u54CD\u5E94\u4E2D\u65AD\u7684\u64CD\u4F5C\u3002\u901A\u8FC7\u6539\u5199 interrupt \u65B9\u6CD5\uFF0CReaderThread \u53EF\u4EE5\u53D6\u6D88\u57FA\u4E8E\u5957\u63A5\u5B57\u7684\u7EBF\u7A0B\u3002\u540C\u6837\uFF0C\u901A\u8FC7\u6539\u5199\u4EFB\u52A1\u7684 Future.cancel \u65B9\u6CD5\u4E5F\u53EF\u4EE5\u5B9E\u73B0\u7C7B\u4F3C\u7684\u529F\u80FD\u3002</p><p>\u5728\u7A0B\u5E8F\u6E05\u53557-12 \u7684 CancellableTask \u4E2D\u5B9A\u4E49\u4E86\u4E00\u4E2A CancellableTask \u63A5\u53E3\uFF0C\u8BE5\u63A5\u53E3\u6269\u5C55\u4E86 Callable\uFF0C\u5E76\u589E\u52A0\u4E86\u4E00\u4E2A cancel \u65B9\u6CD5\u548C\u4E00\u4E2A newTask \u5DE5\u5382\u65B9\u6CD5\u6765\u6784\u9020 RunnableFuture\u3002CancellingExecutor \u6269\u5C55\u4E86 ThreadPoolExecutor\uFF0C\u5E76\u901A\u8FC7\u6539\u5199 newTaskFor \u4F7F\u5F97 CancellableTask \u53EF\u4EE5\u521B\u5EFA\u81EA\u5DF1\u7684 Future\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-12 \u901A\u8FC7 newTaskFor \u5C06\u975E\u6807\u51C6\u7684\u53D6\u6D88\u64CD\u4F5C\u5C01\u88C5\u5728\u4E00\u4E2A\u4EFB\u52A1\u4E2D</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CancellableTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">newTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@ThreadSafe</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CancellingExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token punctuation">{</span>
    <span class="token comment">// ......</span>

    <span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">newTaskFor</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> callable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callable <span class="token keyword">instanceof</span> <span class="token class-name">CancellableTask</span><span class="token punctuation">)</span> 
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CancellableTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> callable<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">newTaskFor</span><span class="token punctuation">(</span>callable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SocketUsingTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">CancellableTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Socket</span> socket<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">setSocket</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        socket <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
                socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">RunnableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">newTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> mayInterruptIfRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SocketUsingTask</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>mayInterruptIfRunning<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SocketUsingTask \u5B9E\u73B0\u4E86 CancellableTask\uFF0C\u5E76\u5B9A\u4E49\u4E86 Future.cancel \u6765\u5173\u95ED\u5957\u63A5\u5B57\u548C\u8C03\u7528 super.cancel\u3002\u5982\u679C SocketUsingTask \u901A\u8FC7\u5176\u81EA\u5DF1\u7684 Future \u6765\u53D6\u6D88\uFF0C\u90A3\u4E48\u5E95\u5C42\u7684\u5957\u63A5\u5B57\u5C06\u88AB\u5173\u95ED\u5E76\u4E14\u7EBF\u7A0B\u5C06\u88AB\u4E2D\u65AD\u3002\u56E0\u6B64\u5B83\u63D0\u9AD8\u4E86\u4EFB\u52A1\u5BF9\u53D6\u6D88\u64CD\u4F5C\u7684\u54CD\u5E94\u6027\uFF1A\u4E0D\u4EC5\u80FD\u591F\u5728\u8C03\u7528\u53EF\u4E2D\u65AD\u65B9\u6CD5\u7684\u540C\u65F6\u786E\u4FDD\u54CD\u5E94\u53D6\u6D88\u64CD\u4F5C\uFF0C\u800C\u4E14\u8FD8\u80FD\u8C03\u7528\u53EF\u963B\u8C03\u7684\u5957\u63A5\u5B57 I/O \u65B9\u6CD5\u3002</p><h2 id="_7-2-\u505C\u6B62\u57FA\u4E8E\u7EBF\u7A0B\u7684\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_7-2-\u505C\u6B62\u57FA\u4E8E\u7EBF\u7A0B\u7684\u670D\u52A1" aria-hidden="true">#</a> 7.2 \u505C\u6B62\u57FA\u4E8E\u7EBF\u7A0B\u7684\u670D\u52A1</h2><p>\u5E94\u7528\u7A0B\u5E8F\u901A\u5E38\u4F1A\u521B\u5EFA\u62E5\u6709\u591A\u4E2A\u7EBF\u7A0B\u7684\u670D\u52A1\uFF0C\u4F8B\u5982\u7EBF\u7A0B\u6C60\uFF0C\u5E76\u4E14\u8FD9\u4E9B\u670D\u52A1\u7684\u751F\u547D\u5468\u671F\u901A\u5E38\u6BD4\u521B\u5EFA\u5B83\u4EEC\u7684\u65B9\u6CD5\u7684\u751F\u547D\u5468\u671F\u66F4\u957F\u3002\u5982\u679C\u5E94\u7528\u7A0B\u5E8F\u51C6\u5907\u9000\u51FA\uFF0C\u90A3\u4E48\u8FD9\u4E9B\u670D\u52A1\u6240\u62E5\u6709\u7684\u7EBF\u7A0B\u4E5F\u9700\u8981\u7ED3\u675F\u3002\u7531\u4E8E\u65E0\u6CD5\u901A\u8FC7\u62A2\u5360\u5F0F\u7684\u65B9\u6CD5\u6765\u505C\u6B62\u7EBF\u7A0B\uFF0C\u56E0\u6B64\u5B83\u4EEC\u9700\u8981\u81EA\u884C\u7ED3\u675F\u3002</p><p>\u6B63\u786E\u7684\u5C01\u88C5\u539F\u5219\u662F\uFF1A\u9664\u975E\u62E5\u6709\u67D0\u4E2A\u7EBF\u7A0B\uFF0C\u5426\u5219\u4E0D\u80FD\u5BF9\u8BE5\u7EBF\u7A0B\u8FDB\u884C\u64CD\u63A7\u3002\u4F8B\u5982\uFF0C\u4E2D\u65AD\u7EBF\u7A0B\u6216\u8005\u4FEE\u6539\u7EBF\u7A0B\u7684\u4F18\u5148\u7EA7\u7B49\u3002\u5728\u7EBF\u7A0B API \u4E2D\uFF0C\u5E76\u6CA1\u6709\u5BF9\u7EBF\u7A0B\u6240\u6709\u6743\u7ED9\u51FA\u6B63\u5F0F\u7684\u5B9A\u4E49\uFF1A\u7EBF\u7A0B\u7531 Thread \u5BF9\u8C61\u8868\u793A\uFF0C\u5E76\u4E14\u50CF\u5176\u4ED6\u5BF9\u8C61\u4E00\u6837\u53EF\u4EE5\u88AB\u81EA\u7531\u5171\u4EAB\u3002\u7136\u800C\uFF0C\u7EBF\u7A0B\u6709\u4E00\u4E2A\u76F8\u5E94\u7684\u6240\u6709\u8005\uFF0C\u5373\u521B\u5EFA\u8BE5\u7EBF\u7A0B\u7684\u7C7B\u3002\u56E0\u6B64\u7EBF\u7A0B\u6C60\u662F\u5176\u5DE5\u4F5C\u8005\u7EBF\u7A0B\u7684\u6240\u6709\u8005\uFF0C\u5982\u679C\u8981\u4E2D\u65AD\u8FD9\u4E9B\u7EBF\u7A0B\uFF0C\u90A3\u4E48\u5E94\u8BE5\u4F7F\u7528\u7EBF\u7A0B\u6C60\u3002</p><p>\u4E0E\u5176\u4ED6\u5C01\u88C5\u5BF9\u8C61\u4E00\u6837\uFF0C\u7EBF\u7A0B\u7684\u6240\u6709\u6743\u662F\u4E0D\u53EF\u4F20\u9012\u7684\uFF1A\u5E94\u7528\u7A0B\u5E8F\u53EF\u4EE5\u62E5\u6709\u670D\u52A1\uFF0C\u670D\u52A1\u4E5F\u53EF\u4EE5\u62E5\u6709\u5DE5\u4F5C\u8005\u7EBF\u7A0B\uFF0C\u4F46\u5E94\u7528\u7A0B\u5E8F\u5E76\u4E0D\u80FD\u62E5\u6709\u5DE5\u4F5C\u8005\u7EBF\u7A0B\uFF0C\u56E0\u6B64\u5E94\u7528\u7A0B\u5E8F\u4E0D\u80FD\u76F4\u63A5\u505C\u6B62\u5DE5\u4F5C\u8005\u7EBF\u7A0B\u3002\u76F8\u53CD\uFF0C\u670D\u52A1\u5E94\u8BE5\u63D0\u4F9B\u751F\u547D\u5468\u671F\u65B9\u6CD5\uFF08Lifecycle Method\uFF09\u6765\u5173\u95ED\u5B83\u81EA\u5DF1\u4EE5\u53CA\u5B83\u6240\u62E5\u6709\u7684\u7EBF\u7A0B\u3002\u8FD9\u6837\uFF0C\u5F53\u5E94\u7528\u7A0B\u5E8F\u5173\u95ED\u8BE5\u670D\u52A1\u65F6\uFF0C\u670D\u52A1\u5C31\u53EF\u4EE5\u5173\u95ED\u6240\u6709\u7684\u7EBF\u7A0B\u4E86\u3002\u5728 ExecutorService \u4E2D\u63D0\u4F9B\u4E86 shutdown \u548C shutdownNow \u7B49\u65B9\u6CD5\u3002\u540C\u6837\uFF0C\u5728\u5176\u4ED6\u62E5\u6709\u7EBF\u7A0B\u7684\u670D\u52A1\u4E2D\u4E5F\u5E94\u8BE5\u63D0\u4F9B\u7C7B\u4F3C\u7684\u5173\u95ED\u673A\u5236\u3002</p><p>\u5BF9\u4E8E\u6301\u6709\u7EBF\u7A0B\u7684\u670D\u52A1\uFF0C\u53EA\u8981\u670D\u52A1\u7684\u5B58\u5728\u65F6\u95F4\u5927\u4E8E\u521B\u5EFA\u7EBF\u7A0B\u7684\u65B9\u6CD5\u7684\u5B58\u5728\u65F6\u95F4\uFF0C\u90A3\u4E48\u5C31\u5E94\u8BE5\u63D0\u4F9B\u751F\u547D\u5468\u671F\u65B9\u6CD5\u3002</p><h3 id="_7-2-1-\u793A\u4F8B-\u65E5\u5FD7\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_7-2-1-\u793A\u4F8B-\u65E5\u5FD7\u670D\u52A1" aria-hidden="true">#</a> 7.2.1 \u793A\u4F8B\uFF1A\u65E5\u5FD7\u670D\u52A1</h3><p>\u5728\u5927\u591A\u6570\u670D\u52A1\u5668\u5E94\u7528\u7A0B\u5E8F\u4E2D\u90FD\u4F1A\u7528\u5230\u65E5\u5FD7\uFF0C\u4F8B\u5982\uFF0C\u5728\u4EE3\u7801\u4E2D\u63D2\u5165 println \u8BED\u53E5\u5C31\u662F\u4E00\u79CD\u7B80\u5355\u7684\u65E5\u5FD7\u3002\u50CF PrintWriter \u8FD9\u6837\u7684\u5B57\u7B26\u6D41\u7C7B\u662F\u7EBF\u7A0B\u5B89\u5168\u7684\uFF0C\u56E0\u6B64\u8FD9\u79CD\u7B80\u5355\u7684\u65B9\u6CD5\u4E0D\u9700\u8981\u663E\u5F0F\u7684\u540C\u6B65<sup class="footnote-ref"><a href="#footnote3">[3]</a><a class="footnote-anchor" id="footnote-ref3"></a></sup>\u3002\u7136\u800C\uFF0C\u5728 11.6 \u8282\u4E2D\uFF0C\u6211\u4EEC\u5C06\u770B\u5230\u8FD9\u79CD\u5185\u8054\u65E5\u5FD7\u529F\u80FD\u4F1A\u7ED9\u4E00\u4E9B\u9AD8\u5BB9\u91CF\u7684\uFF08Highvolume\uFF09\u5E94\u7528\u7A0B\u5E8F\u5E26\u6765\u4E00\u5B9A\u7684\u6027\u80FD\u5F00\u9500\u3002\u53E6\u5916\u4E00\u79CD\u66FF\u4EE3\u65B9\u6CD5\u662F\u901A\u8FC7\u8C03\u7528 log \u65B9\u6CD5\u5C06\u65E5\u5FD7\u6D88\u606F\u653E\u5165\u67D0\u4E2A\u961F\u5217\u4E2D\uFF0C\u5E76\u7531\u5176\u4ED6\u7EBF\u7A0B\u6765\u5904\u7406\u3002</p><p>\u5728\u7A0B\u5E8F\u6E05\u53557-13 \u7684 LogWriter \u4E2D\u7ED9\u51FA\u4E86\u4E00\u4E2A\u7B80\u5355\u7684\u65E5\u5FD7\u670D\u52A1\u793A\u4F8B\uFF0C\u5176\u4E2D\u65E5\u5FD7\u64CD\u4F5C\u5728\u5355\u72EC\u7684\u65E5\u5FD7\u7EBF\u7A0B\u4E2D\u6267\u884C\u3002\u4EA7\u751F\u65E5\u5FD7\u6D88\u606F\u7684\u7EBF\u7A0B\u5E76\u4E0D\u4F1A\u5C06\u6D88\u606F\u76F4\u63A5\u5199\u5165\u8F93\u51FA\u6D41\uFF0C\u800C\u662F\u7531 LogWriter \u901A\u8FC7 BlockingQueue \u5C06\u6D88\u606F\u63D0\u4EA4\u7ED9\u65E5\u5FD7\u7EBF\u7A0B\uFF0C\u5E76\u7531\u65E5\u5FD7\u7EBF\u7A0B\u5199\u5165\u3002\u8FD9\u662F\u4E00\u79CD\u591A\u751F\u4EA7\u8005\u5355\u6D88\u8D39\u8005\uFF08Multiple-Producer\uFF0CSingle-Consumer\uFF09\u7684\u8BBE\u8BA1\u65B9\u5F0F\uFF1A\u6BCF\u4E2A\u8C03\u7528 log \u7684\u64CD\u4F5C\u90FD\u76F8\u5F53\u4E8E\u4E00\u4E2A\u751F\u4EA7\u8005\uFF0C\u800C\u540E\u53F0\u7684\u65E5\u5FD7\u7EBF\u7A0B\u5219\u76F8\u5F53\u4E8E\u6D88\u8D39\u8005\u3002\u5982\u679C\u6D88\u8D39\u8005\u7684\u5904\u7406\u901F\u5EA6\u4F4E\u4E8E\u751F\u4EA7\u8005\u7684\u751F\u6210\u901F\u5EA6\uFF0C\u90A3\u4E48 BlockingQueue \u5C06\u963B\u585E\u751F\u4EA7\u8005\uFF0C\u76F4\u5230\u65E5\u5FD7\u7EBF\u7A0B\u6709\u80FD\u529B\u5904\u7406\u65B0\u7684\u65E5\u5FD7\u6D88\u606F\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-13 \u4E0D\u652F\u6301\u5173\u95ED\u7684\u751F\u4EA7\u8005-\u6D88\u8D39\u8005\u65E5\u5FD7\u670D\u52A1</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogWriter</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LoggerThread</span> logger<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">LogWriter</span><span class="token punctuation">(</span><span class="token class-name">Writer</span> writer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggerThread</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        queue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">LoggerThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PrintWriter</span> writer<span class="token punctuation">;</span>
        
        <span class="token comment">//......</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> 
                    writer<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E3A\u4E86\u4F7F\u50CF LogWriter \u8FD9\u6837\u7684\u670D\u52A1\u5728\u8F6F\u4EF6\u4EA7\u54C1\u4E2D\u80FD\u53D1\u6325\u5B9E\u9645\u7684\u4F5C\u7528\uFF0C\u8FD8\u9700\u8981\u5B9E\u73B0\u4E00\u79CD\u7EC8\u6B62\u65E5\u5FD7\u7EBF\u7A0B\u7684\u65B9\u6CD5\uFF0C\u4ECE\u800C\u907F\u514D\u4F7F JVM \u65E0\u6CD5\u6B63\u5E38\u5173\u95ED\u3002\u8981\u505C\u6B62\u65E5\u5FD7\u7EBF\u7A0B\u662F\u5F88\u5BB9\u6613\u7684\uFF0C\u56E0\u4E3A\u5B83\u4F1A\u53CD\u590D\u8C03\u7528 take\uFF0C\u800C take \u80FD\u54CD\u5E94\u4E2D\u65AD\u3002\u5982\u679C\u5C06\u65E5\u5FD7\u7EBF\u7A0B\u4FEE\u6539\u4E3A\u5F53\u6355\u83B7\u5230 InterruptedException \u65F6\u9000\u51FA\uFF0C\u90A3\u4E48\u53EA\u9700\u4E2D\u65AD\u65E5\u5FD7\u7EBF\u7A0B\u5C31\u80FD\u505C\u6B62\u670D\u52A1\u3002</p><p>\u7136\u800C\uFF0C\u5982\u679C\u53EA\u662F\u4F7F\u65E5\u5FD7\u7EBF\u7A0B\u9000\u51FA\uFF0C\u90A3\u4E48\u8FD8\u4E0D\u662F\u4E00\u79CD\u5B8C\u5907\u7684\u5173\u95ED\u673A\u5236\u3002\u8FD9\u79CD\u76F4\u63A5\u5173\u95ED\u7684\u505A\u6CD5\u4F1A\u4E22\u5931\u90A3\u4E9B\u6B63\u5728\u7B49\u5F85\u88AB\u5199\u5165\u5230\u65E5\u5FD7\u7684\u4FE1\u606F\uFF0C\u4E0D\u4EC5\u5982\u6B64\uFF0C\u5176\u4ED6\u7EBF\u7A0B\u5C06\u5728\u8C03\u7528 log \u65F6\u88AB\u963B\u585E\uFF0C\u56E0\u4E3A\u65E5\u5FD7\u6D88\u606F\u961F\u5217\u662F\u6EE1\u7684\uFF0C\u56E0\u6B64\u8FD9\u4E9B\u7EBF\u7A0B\u5C06\u65E0\u6CD5\u89E3\u9664\u963B\u585E\u72B6\u6001\u3002\u5F53\u53D6\u6D88\u4E00\u4E2A\u751F\u4EA7\u8005-\u6D88\u8D39\u8005\u64CD\u4F5C\u65F6\uFF0C\u9700\u8981\u540C\u65F6\u53D6\u6D88\u751F\u4EA7\u8005\u548C\u6D88\u8D39\u8005\u3002\u5728\u4E2D\u65AD\u65E5\u5FD7\u7EBF\u7A0B\u65F6\u4F1A\u5904\u7406\u6D88\u8D39\u8005\uFF0C\u4F46\u5728\u8FD9\u4E2A\u793A\u4F8B\u4E2D\uFF0C\u7531\u4E8E\u751F\u4EA7\u8005\u5E76\u4E0D\u662F\u4E13\u95E8\u7684\u7EBF\u7A0B\uFF0C\u56E0\u6B64\u8981\u53D6\u6D88\u5B83\u4EEC\u5C06\u975E\u5E38\u56F0\u96BE\u3002</p><p>\u53E6\u4E00\u79CD\u5173\u95ED LogWriter \u7684\u65B9\u6CD5\u662F\uFF1A\u8BBE\u7F6E\u67D0\u4E2A \u201C\u5DF2\u8BF7\u6C42\u5173\u95ED\u201D \u6807\u5FD7\uFF0C\u4EE5\u907F\u514D\u8FDB\u4E00\u6B65\u63D0\u4EA4\u65E5\u5FD7\u6D88\u606F\uFF0C\u5982\u7A0B\u5E8F\u6E05\u53557-14 \u6240\u793A\u3002\u5728\u6536\u5230\u5173\u95ED\u8BF7\u6C42\u540E\uFF0C\u6D88\u8D39\u8005\u4F1A\u628A\u961F\u5217\u4E2D\u7684\u6240\u6709\u6D88\u606F\u5199\u5165\u65E5\u5FD7\uFF0C\u5E76\u89E3\u9664\u6240\u6709\u5728\u8C03\u7528 log \u65F6\u963B\u585E\u7684\u751F\u4EA7\u8005\u3002\u7136\u800C\uFF0C\u5728\u8FD9\u4E2A\u65B9\u6CD5\u4E2D\u5B58\u5728\u7740\u7ADE\u6001\u6761\u4EF6\u95EE\u9898\uFF0C\u4F7F\u5F97\u8BE5\u65B9\u6CD5\u5E76\u4E0D\u53EF\u9760\u3002log \u7684\u5B9E\u73B0\u662F\u4E00\u79CD \u201C\u5148\u5224\u65AD\u518D\u8FD0\u884C\u201D \u7684\u4EE3\u7801\u5E8F\u5217\uFF1A\u751F\u4EA7\u8005\u53D1\u73B0\u8BE5\u670D\u52A1\u8FD8\u6CA1\u6709\u5173\u95ED\uFF0C\u56E0\u6B64\u5728\u5173\u95ED\u670D\u52A1\u540E\u4ECD\u7136\u4F1A\u5C06\u65E5\u5FD7\u6D88\u606F\u653E\u5165\u961F\u5217\uFF0C\u8FD9\u540C\u6837\u4F1A\u4F7F\u5F97\u751F\u4EA7\u8005\u53EF\u80FD\u5728\u8C03\u7528 log \u65F6\u963B\u585E\u5E76\u4E14\u65E0\u6CD5\u89E3\u9664\u963B\u585E\u72B6\u6001\u3002\u53EF\u4EE5\u901A\u8FC7\u4E00\u4E9B\u6280\u5DE7\u6765\u964D\u4F4E\u8FD9\u79CD\u60C5\u51B5\u7684\u53D1\u751F\u6982\u7387\uFF08\u4F8B\u5982\uFF0C\u5728\u5BA3\u5E03\u961F\u5217\u88AB\u6E05\u7A7A\u4E4B\u524D\uFF0C\u8BA9\u6D88\u8D39\u8005\u7B49\u5F85\u6570\u79D2\u949F\uFF09\uFF0C\u4F46\u8FD9\u4E9B\u90FD\u6CA1\u6709\u89E3\u51B3\u95EE\u9898\u7684\u672C\u8D28\uFF0C\u5373\u4F7F\u5F88\u5C0F\u7684\u6982\u7387\u4E5F\u53EF\u80FD\u5BFC\u81F4\u7A0B\u5E8F\u53D1\u751F\u6545\u969C\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-14 \u901A\u8FC7\u4E00\u79CD\u4E0D\u53EF\u9760\u7684\u65B9\u5F0F\u4E3A\u65E5\u5FD7\u670D\u52A1\u589E\u52A0\u5173\u95ED\u652F\u6301</p><div class="language-jade ext-jade line-numbers-mode"><pre class="language-jade"><code>public void log(String msg) throws InterruptedException {
    if (!shutdownRequested) 
        queue.put(msg);
    else
        throw new IllegalStateException(&quot;logger is shut down&quot;);
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E3A LogWriter \u63D0\u4F9B\u53EF\u9760\u5173\u95ED\u64CD\u4F5C\u7684\u65B9\u6CD5\u662F\u89E3\u51B3\u7ADE\u6001\u6761\u4EF6\u95EE\u9898\uFF0C\u56E0\u800C\u8981\u4F7F\u65E5\u5FD7\u6D88\u606F\u7684\u63D0\u4EA4\u64CD\u4F5C\u6210\u4E3A\u539F\u5B50\u64CD\u4F5C\u3002\u7136\u800C\uFF0C\u6211\u4EEC\u4E0D\u5E0C\u671B\u5728\u6D88\u606F\u52A0\u5165\u961F\u5217\u65F6\u53BB\u6301\u6709\u4E00\u4E2A\u9501\uFF0C\u56E0\u4E3A put \u65B9\u6CD5\u672C\u8EAB\u5C31\u53EF\u4EE5\u963B\u585E\u3002\u6211\u4EEC\u91C7\u7528\u7684\u65B9\u6CD5\u662F\uFF1A\u901A\u8FC7\u539F\u5B50\u65B9\u5F0F\u6765\u68C0\u67E5\u5173\u95ED\u8BF7\u6C42\uFF0C\u5E76\u4E14\u6709\u6761\u4EF6\u5730\u9012\u589E\u4E00\u4E2A\u8BA1\u6570\u5668\u6765 \u201C\u4FDD\u6301\u201D \u63D0\u4EA4\u6D88\u606F\u7684\u6743\u5229\uFF0C\u5982\u7A0B\u5E8F\u6E05\u53557-15 \u4E2D\u7684 LogService \u6240\u793A\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-15 \u5411 LogWriter \u6DFB\u52A0\u53EF\u9760\u7684\u53D6\u6D88\u64CD\u4F5C</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LoggerThread</span> loggerThread<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PrintWriter</span> writer<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isShutdown<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> reservations<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        loggerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isShutdown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        loggerThread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isShutdown<span class="token punctuation">)</span> 
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">++</span>reservations<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        queue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">LoggerThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">LogService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>isShutdown <span class="token operator">&amp;&amp;</span> reservations <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> 
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token class-name">String</span> msg <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">LogService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token operator">--</span>reservations<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        writer<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">/*retry*/</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-2-\u5173\u95ED-executorservice" tabindex="-1"><a class="header-anchor" href="#_7-2-2-\u5173\u95ED-executorservice" aria-hidden="true">#</a> 7.2.2 \u5173\u95ED ExecutorService</h3><p>\u5728 6.2.4 \u8282\u4E2D\uFF0C\u6211\u4EEC\u770B\u5230 ExecutorService \u63D0\u4F9B\u4E86\u4E24\u79CD\u5173\u95ED\u65B9\u6CD5\uFF1A\u4F7F\u7528 shutdown \u6B63\u5E38\u5173\u95ED\uFF0C\u4EE5\u53CA\u4F7F\u7528 shutdownNow \u5F3A\u884C\u5173\u95ED\u3002\u5728\u8FDB\u884C\u5F3A\u884C\u5173\u95ED\u65F6\uFF0CshutdownNow \u9996\u5148\u5173\u95ED\u5F53\u524D\u6B63\u5728\u6267\u884C\u7684\u4EFB\u52A1\uFF0C\u7136\u540E\u8FD4\u56DE\u6240\u6709\u5C1A\u672A\u542F\u52A8\u7684\u4EFB\u52A1\u6E05\u5355\u3002</p><p>\u8FD9\u4E24\u79CD\u5173\u95ED\u65B9\u5F0F\u7684\u5DEE\u522B\u5728\u4E8E\u5404\u81EA\u7684\u5B89\u5168\u6027\u548C\u54CD\u5E94\u6027\uFF1A\u5F3A\u884C\u5173\u95ED\u7684\u901F\u5EA6\u66F4\u5FEB\uFF0C\u4F46\u98CE\u9669\u4E5F\u66F4\u5927\uFF0C\u56E0\u4E3A\u4EFB\u52A1\u5F88\u53EF\u80FD\u5728\u6267\u884C\u5230\u4E00\u534A\u65F6\u88AB\u7ED3\u675F\uFF1B\u800C\u6B63\u5E38\u5173\u95ED\u867D\u7136\u901F\u5EA6\u6162\uFF0C\u4F46\u5374\u66F4\u5B89\u5168\uFF0C\u56E0\u4E3A ExecutorService \u4F1A\u4E00\u76F4\u7B49\u5230\u961F\u5217\u4E2D\u7684\u6240\u6709\u4EFB\u52A1\u90FD\u6267\u884C\u5B8C\u6210\u540E\u624D\u5173\u95ED\u3002\u5728\u5176\u4ED6\u62E5\u6709\u7EBF\u7A0B\u7684\u670D\u52A1\u4E2D\u4E5F\u5E94\u8BE5\u8003\u8651\u63D0\u4F9B\u7C7B\u4F3C\u7684\u5173\u95ED\u65B9\u5F0F\u4EE5\u4F9B\u9009\u62E9\u3002</p><p>\u7B80\u5355\u7684\u7A0B\u5E8F\u53EF\u4EE5\u76F4\u63A5\u5728 main \u51FD\u6570\u4E2D\u542F\u52A8\u548C\u5173\u95ED\u5168\u5C40\u7684 ExecutorService\u3002\u800C\u5728\u590D\u6742\u7A0B\u5E8F\u4E2D\uFF0C\u901A\u5E38\u4F1A\u5C06 ExecutorService \u5C01\u88C5\u5728\u67D0\u4E2A\u66F4\u9AD8\u7EA7\u522B\u7684\u670D\u52A1\u4E2D\uFF0C\u5E76\u4E14\u8BE5\u670D\u52A1\u80FD\u63D0\u4F9B\u5176\u81EA\u5DF1\u7684\u751F\u547D\u5468\u671F\u65B9\u6CD5\uFF0C\u4F8B\u5982\u7A0B\u5E8F\u6E05\u53557-16 \u4E2D LogService \u7684\u4E00\u79CD\u53D8\u5316\u5F62\u5F0F\uFF0C\u5B83\u5C06\u7BA1\u7406\u7EBF\u7A0B\u7684\u5DE5\u4F5C\u59D4\u6258\u7ED9\u4E00\u4E2A ExecutorService\uFF0C\u800C\u4E0D\u662F\u7531\u5176\u81EA\u884C\u7BA1\u7406\u3002\u901A\u8FC7\u5C01\u88C5 ExecutorService\uFF0C\u53EF\u4EE5\u5C06\u6240\u6709\u6743\u94FE\uFF08Ownership Chain\uFF09\u4ECE\u5E94\u7528\u7A0B\u5E8F\u6269\u5C55\u5230\u670D\u52A1\u4EE5\u53CA\u7EBF\u7A0B\uFF0C\u6240\u6709\u6743\u94FE\u4E0A\u7684\u5404\u4E2A\u6210\u5458\u90FD\u5C06\u7BA1\u7406\u5B83\u6240\u62E5\u6709\u7684\u670D\u52A1\u6216\u7EBF\u7A0B\u7684\u751F\u547D\u5468\u671F\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-16 \u4F7F\u7528 ExecutorService \u7684\u65E5\u5FD7\u670D\u52A1</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> exec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//......</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            exec<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            exec<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span>TIMEOUT<span class="token punctuation">,</span> UNIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WriteTask</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-3-\u6BD2\u4E38-\u5BF9\u8C61" tabindex="-1"><a class="header-anchor" href="#_7-2-3-\u6BD2\u4E38-\u5BF9\u8C61" aria-hidden="true">#</a> 7.2.3 \u201C\u6BD2\u4E38\u201D \u5BF9\u8C61</h3><p>\u53E6\u4E00\u79CD\u5173\u95ED\u751F\u4EA7\u8005-\u6D88\u8D39\u8005\u670D\u52A1\u7684\u65B9\u5F0F\u5C31\u662F\u4F7F\u7528 \u201C\u6BD2\u4E38\uFF08Poison Pill\uFF09\u201D \u5BF9\u8C61\uFF1A\u201C\u6BD2\u4E38\u201D \u662F\u6307\u4E00\u4E2A\u653E\u5728\u961F\u5217\u4E0A\u7684\u5BF9\u8C61\uFF0C\u5176\u542B\u4E49\u662F\uFF1A\u201C\u5F53\u5F97\u5230\u8FD9\u4E2A\u5BF9\u8C61\u65F6\uFF0C\u7ACB\u5373\u505C\u6B62\u3002\u201D \u5728 FIFO\uFF08\u5148\u8FDB\u5148\u51FA\uFF09\u961F\u5217\u4E2D\uFF0C\u201C\u6BD2\u4E38\u201D \u5BF9\u8C61\u5C06\u786E\u4FDD\u6D88\u8D39\u8005\u5728\u5173\u95ED\u4E4B\u524D\u9996\u5148\u5B8C\u6210\u961F\u5217\u4E2D\u7684\u6240\u6709\u5DE5\u4F5C\uFF0C\u5728\u63D0\u4EA4 \u201C\u6BD2\u4E38\u201D \u5BF9\u8C61\u4E4B\u524D\u63D0\u4EA4\u7684\u6240\u6709\u5DE5\u4F5C\u90FD\u4F1A\u88AB\u5904\u7406\uFF0C\u800C\u751F\u4EA7\u8005\u5728\u63D0\u4EA4\u4E86 \u201C\u6BD2\u4E38\u201D \u5BF9\u8C61\u540E\uFF0C\u5C06\u4E0D\u4F1A\u518D\u63D0\u4EA4\u4EFB\u4F55\u5DE5\u4F5C\u3002\u5728\u7A0B\u5E8F\u6E05\u53557-17\u3001\u7A0B\u5E8F\u6E05\u53557-18 \u548C\u7A0B\u5E8F\u6E05\u53557-19 \u4E2D\u7ED9\u51FA\u4E00\u4E2A\u5355\u751F\u4EA7\u8005-\u5355\u6D88\u8D39\u8005\u7684\u684C\u9762\u641C\u7D22\u793A\u4F8B\uFF08\u6765\u81EA\u7A0B\u5E8F\u6E05\u53555-8\uFF09\uFF0C\u5728\u8FD9\u4E2A\u793A\u4F8B\u4E2D\u4F7F\u7528\u4E86 \u201C\u6BD2\u4E38\u201D \u5BF9\u8C61\u6765\u5173\u95ED\u670D\u52A1\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-17 \u901A\u8FC7 \u201C\u6BD2\u4E38\u201D \u5BF9\u8C61\u6765\u5173\u95ED\u670D\u52A1</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IndexingService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">File</span> POISON <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">IndexerThread</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CrawlerThread</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CrawlerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> queue<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">FileFilter</span> fileFilter<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">File</span> root<span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">CrawlerThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
        <span class="token comment">/*\u7A0B\u5E8F\u6E05\u53557-18*/</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token class-name">IndexerThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
        <span class="token comment">/*\u7A0B\u5E8F\u6E05\u53557-19*/</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        producer<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        consumer<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7A0B\u5E8F\u6E05\u53557-18 IndexingService \u7684\u751F\u4EA7\u8005\u7EBF\u7A0B</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CrawlerThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">crawl</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*\u53D1\u751F\u5F02\u5E38*/</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    queue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>POISON<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">/*\u91CD\u65B0\u5C1D\u8BD5*/</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">crawl</span><span class="token punctuation">(</span><span class="token class-name">File</span> root<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">//......</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7A0B\u5E8F\u6E05\u53557-19 IndexingService \u7684\u6D88\u8D39\u8005\u7EBF\u7A0B</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IndexerThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">File</span> file <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fle <span class="token operator">==</span> POISON<span class="token punctuation">)</span> 
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token function">elseindexFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> consumed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EA\u6709\u5728\u751F\u4EA7\u8005\u548C\u6D88\u8D39\u8005\u7684\u6570\u91CF\u90FD\u5DF2\u77E5\u7684\u60C5\u51B5\u4E0B\uFF0C\u624D\u53EF\u4EE5\u4F7F\u7528 \u201C\u6BD2\u4E38\u201D \u5BF9\u8C61\u3002\u5728 IndexingService \u4E2D\u91C7\u7528\u7684\u89E3\u51B3\u65B9\u6848\u53EF\u4EE5\u6269\u5C55\u5230\u591A\u4E2A\u751F\u4EA7\u8005\uFF1A\u53EA\u9700\u6BCF\u4E2A\u751F\u4EA7\u8005\u90FD\u5411\u961F\u5217\u4E2D\u653E\u5165\u4E00\u4E2A \u201C\u6BD2\u4E38\u201D \u5BF9\u8C61\uFF0C\u5E76\u4E14\u6D88\u8D39\u8005\u4EC5\u5F53\u5728\u63A5\u6536\u5230 N<sub>producers</sub> \u4E2A \u201C\u6BD2\u4E38\u201D \u5BF9\u8C61\u65F6\u624D\u505C\u6B62\u3002\u8FD9\u79CD\u65B9\u6CD5\u4E5F\u53EF\u4EE5\u6269\u5C55\u5230\u591A\u4E2A\u6D88\u8D39\u8005\u7684\u60C5\u51B5\uFF0C\u53EA\u9700\u751F\u4EA7\u8005\u5C06 N<sub>consumers</sub> \u4E2A \u201C\u6BD2\u4E38\u201D \u5BF9\u8C61\u653E\u5165\u961F\u5217\u3002\u7136\u800C\uFF0C\u5F53\u751F\u4EA7\u8005\u548C\u6D88\u8D39\u8005\u7684\u6570\u91CF\u8F83\u5927\u65F6\uFF0C\u8FD9\u79CD\u65B9\u6CD5\u5C06\u53D8\u5F97\u96BE\u4EE5\u4F7F\u7528\u3002\u53EA\u6709\u5728\u65E0\u754C\u961F\u5217\u4E2D\uFF0C\u201C\u6BD2\u4E38\u201D \u5BF9\u8C61\u624D\u80FD\u53EF\u9760\u5730\u5DE5\u4F5C\u3002</p><h3 id="_7-2-4-\u793A\u4F8B-\u53EA\u6267\u884C\u4E00\u6B21\u7684\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_7-2-4-\u793A\u4F8B-\u53EA\u6267\u884C\u4E00\u6B21\u7684\u670D\u52A1" aria-hidden="true">#</a> 7.2.4 \u793A\u4F8B\uFF1A\u53EA\u6267\u884C\u4E00\u6B21\u7684\u670D\u52A1</h3><p>\u5982\u679C\u67D0\u4E2A\u65B9\u6CD5\u9700\u8981\u5904\u7406\u4E00\u6279\u4EFB\u52A1\uFF0C\u5E76\u4E14\u5F53\u6240\u6709\u4EFB\u52A1\u90FD\u5904\u7406\u5B8C\u6210\u540E\u624D\u8FD4\u56DE\uFF0C\u90A3\u4E48\u53EF\u4EE5\u901A\u8FC7\u4E00\u4E2A\u79C1\u6709\u7684 Executor \u6765\u7B80\u5316\u670D\u52A1\u7684\u751F\u547D\u5468\u671F\u7BA1\u7406\uFF0C\u5176\u4E2D\u8BE5 Executor \u7684\u751F\u547D\u5468\u671F\u662F\u7531\u8FD9\u4E2A\u65B9\u6CD5\u6765\u63A7\u5236\u7684\u3002\uFF08\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0CinvokeAll \u548C invokeAny \u7B49\u65B9\u6CD5\u901A\u5E38\u4F1A\u8D77\u8F83\u5927\u7684\u4F5C\u7528\u3002\uFF09</p><p>\u7A0B\u5E8F\u6E05\u53557-20 \u4E2D\u7684 checkMail \u65B9\u6CD5\u80FD\u5728\u591A\u53F0\u4E3B\u673A\u4E0A\u5E76\u884C\u5730\u68C0\u67E5\u65B0\u90AE\u4EF6\u3002\u5B83\u521B\u5EFA\u4E00\u4E2A\u79C1\u6709\u7684 Executor\uFF0C\u5E76\u5411\u6BCF\u53F0\u4E3B\u673A\u63D0\u4EA4\u4E00\u4E2A\u4EFB\u52A1\u3002\u7136\u540E\uFF0C\u5F53\u6240\u6709\u90AE\u4EF6\u68C0\u67E5\u4EFB\u52A1\u90FD\u6267\u884C\u5B8C\u6210\u540E\uFF0C\u5173\u95ED Executor \u5E76\u7B49\u5F85\u7ED3\u675F\u3002<sup class="footnote-ref"><a href="#footnote4">[4]</a><a class="footnote-anchor" id="footnote-ref4"></a></sup></p><p>\u7A0B\u5E8F\u6E05\u53557-20 \u4F7F\u7528\u79C1\u6709\u7684 Executor\uFF0C\u5E76\u4E14\u8BE5Executor \u7684\u751F\u547D\u5468\u671F\u53D7\u9650\u4E8E\u65B9\u6CD5\u8C03\u7528</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">boolean</span> <span class="token function">checkMail</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> hosts<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ExecutorService</span> exec <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">AtomicBoolean</span> hasNewMail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> host <span class="token operator">:</span> hosts<span class="token punctuation">)</span>
            exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkMail</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">)</span> hasNewMail<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        exec<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        exec<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> hasNewMail<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-5-shutdownnow-\u7684\u5C40\u9650\u6027" tabindex="-1"><a class="header-anchor" href="#_7-2-5-shutdownnow-\u7684\u5C40\u9650\u6027" aria-hidden="true">#</a> 7.2.5 shutdownNow \u7684\u5C40\u9650\u6027</h3><p>\u5F53\u901A\u8FC7 shutdownNow \u6765\u5F3A\u884C\u5173\u95ED ExecutorService \u65F6\uFF0C\u5B83\u4F1A\u5C1D\u8BD5\u53D6\u6D88\u6B63\u5728\u6267\u884C\u7684\u4EFB\u52A1\uFF0C\u5E76\u8FD4\u56DE\u6240\u6709\u5DF2\u63D0\u4EA4\u4F46\u5C1A\u672A\u5F00\u59CB\u7684\u4EFB\u52A1\uFF0C\u4ECE\u800C\u5C06\u8FD9\u4E9B\u4EFB\u52A1\u5199\u5165\u65E5\u5FD7\u6216\u8005\u4FDD\u5B58\u8D77\u6765\u4EE5\u4FBF\u4E4B\u540E\u8FDB\u884C\u5904\u7406\u3002<sup class="footnote-ref"><a href="#footnote5">[5]</a><a class="footnote-anchor" id="footnote-ref5"></a></sup></p><p>\u7136\u800C\uFF0C\u6211\u4EEC\u65E0\u6CD5\u901A\u8FC7\u5E38\u89C4\u65B9\u6CD5\u6765\u627E\u51FA\u54EA\u4E9B\u4EFB\u52A1\u5DF2\u7ECF\u5F00\u59CB\u4F46\u5C1A\u672A\u7ED3\u675F\u3002\u8FD9\u610F\u5473\u7740\u6211\u4EEC\u65E0\u6CD5\u5728\u5173\u95ED\u8FC7\u7A0B\u4E2D\u77E5\u9053\u6B63\u5728\u6267\u884C\u7684\u4EFB\u52A1\u7684\u72B6\u6001\uFF0C\u9664\u975E\u4EFB\u52A1\u672C\u8EAB\u4F1A\u6267\u884C\u67D0\u79CD\u68C0\u67E5\u3002\u8981\u77E5\u9053\u54EA\u4E9B\u4EFB\u52A1\u8FD8\u6CA1\u6709\u5B8C\u6210\uFF0C\u4F60\u4E0D\u4EC5\u9700\u8981\u77E5\u9053\u54EA\u4E9B\u4EFB\u52A1\u8FD8\u6CA1\u6709\u5F00\u59CB\uFF0C\u800C\u4E14\u8FD8\u9700\u8981\u77E5\u9053\u5F53 Executor \u5173\u95ED\u65F6\u54EA\u4E9B\u4EFB\u52A1\u6B63\u5728\u6267\u884C\u3002<sup class="footnote-ref"><a href="#footnote6">[6]</a><a class="footnote-anchor" id="footnote-ref6"></a></sup></p><p>\u5728\u7A0B\u5E8F\u6E05\u53557-21 \u7684 TrackingExecutor \u4E2D\u7ED9\u51FA\u4E86\u5982\u4F55\u5728\u5173\u95ED\u8FC7\u7A0B\u4E2D\u5224\u65AD\u6B63\u5728\u6267\u884C\u7684\u4EFB\u52A1\u3002\u901A\u8FC7\u5C01\u88C5 ExecutorService \u5E76\u4F7F\u5F97 execute\uFF08\u7C7B\u4F3C\u5730\u8FD8\u6709 submit\uFF0C\u5728\u8FD9\u91CC\u6CA1\u6709\u7ED9\u51FA\uFF09\u8BB0\u5F55\u54EA\u4E9B\u4EFB\u52A1\u662F\u5728\u5173\u95ED\u540E\u53D6\u6D88\u7684\uFF0CTrackingExecutor \u53EF\u4EE5\u627E\u51FA\u54EA\u4E9B\u4EFB\u52A1\u5DF2\u7ECF\u5F00\u59CB\u4F46\u8FD8\u6CA1\u6709\u6B63\u5E38\u5B8C\u6210\u3002\u5728 Executor \u7ED3\u675F\u540E\uFF0CgetCancelledTasks \u8FD4\u56DE\u88AB\u53D6\u6D88\u7684\u4EFB\u52A1\u6E05\u5355\u3002\u8981\u4F7F\u8FD9\u9879\u6280\u672F\u80FD\u53D1\u6325\u4F5C\u7528\uFF0C\u4EFB\u52A1\u5728\u8FD4\u56DE\u65F6\u5FC5\u987B\u7EF4\u6301\u7EBF\u7A0B\u7684\u4E2D\u65AD\u72B6\u6001\uFF0C\u5728\u6240\u6709\u8BBE\u8BA1\u826F\u597D\u7684\u4EFB\u52A1\u4E2D\u90FD\u4F1A\u5B9E\u73B0\u8FD9\u4E2A\u529F\u80FD\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-21 \u5728 ExecutorService \u4E2D\u8DDF\u8E2A\u5728\u5173\u95ED\u4E4B\u540E\u88AB\u53D6\u6D88\u7684\u4EFB\u52A1</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TrackingExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractExecutorService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> exec<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> tasksCancelledAtShutdown <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedSet</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ......</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCancelledTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exec<span class="token punctuation">.</span><span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>tasksCancelledAtShutdown<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Runnable</span> runnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    runnable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
                        tasksCancelledAtShutdown<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// \u5C06 ExecutorService \u7684\u5176\u4ED6\u65B9\u6CD5\u59D4\u6258\u7ED9 exec</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u7A0B\u5E8F\u6E05\u53557-22 \u7684 WebCrawler \u4E2D\u7ED9\u51FA\u4E86 TrackingExecutor \u7684\u7528\u6CD5\u3002\u7F51\u9875\u722C\u866B\u7A0B\u5E8F\u7684\u5DE5\u4F5C\u901A\u5E38\u662F\u65E0\u7A77\u5C3D\u7684\uFF0C\u56E0\u6B64\u5F53\u722C\u866B\u7A0B\u5E8F\u5FC5\u987B\u5173\u95ED\u65F6\uFF0C\u6211\u4EEC\u901A\u5E38\u5E0C\u671B\u4FDD\u5B58\u5B83\u7684\u72B6\u6001\uFF0C\u4EE5\u4FBF\u7A0D\u540E\u91CD\u65B0\u542F\u52A8\u3002CrawlTask \u63D0\u4F9B\u4E86\u4E00\u4E2A getPage \u65B9\u6CD5\uFF0C\u8BE5\u65B9\u6CD5\u80FD\u627E\u51FA\u6B63\u5728\u5904\u7406\u7684\u9875\u9762\u3002\u5F53\u722C\u866B\u7A0B\u5E8F\u5173\u95ED\u65F6\uFF0C\u65E0\u8BBA\u662F\u8FD8\u6CA1\u6709\u5F00\u59CB\u7684\u4EFB\u52A1\uFF0C\u8FD8\u662F\u90A3\u4E9B\u88AB\u53D6\u6D88\u7684\u4EFB\u52A1\uFF0C\u90FD\u5C06\u8BB0\u5F55\u5B83\u4EEC\u7684 URL\uFF0C\u56E0\u6B64\u5F53\u722C\u866B\u7A0B\u5E8F\u91CD\u65B0\u542F\u52A8\u65F6\uFF0C\u5C31\u53EF\u4EE5\u5C06\u8FD9\u4E9B URL \u7684\u9875\u9762\u6293\u53D6\u4EFB\u52A1\u52A0\u5165\u5230\u4EFB\u52A1\u961F\u5217\u4E2D\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-22 \u4F7F\u7528 TrackingExecutorService \u6765\u4FDD\u5B58\u672A\u5B8C\u6210\u7684\u4EFB\u52A1\u4EE5\u5907\u540E\u7EED\u6267\u884C</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">WebCrawler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">TrackingExecutor</span> exec<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> urlsToCrawl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ......</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        exec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrackingExecutor</span><span class="token punctuation">(</span><span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>URL url <span class="token operator">:</span> urlsToCrawl<span class="token punctuation">)</span> 
            <span class="token function">submitCrawlTask</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        urlsToCrawl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">saveUncrawled</span><span class="token punctuation">(</span>exec<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>exec<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span>TIMEOUT<span class="token punctuation">,</span> UNIT<span class="token punctuation">)</span><span class="token punctuation">)</span> 
                <span class="token function">saveUncrawled</span><span class="token punctuation">(</span>exec<span class="token punctuation">.</span><span class="token function">getCancelledTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            exec <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> <span class="token function">processPage</span><span class="token punctuation">(</span><span class="token class-name">URL</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveUncrawled</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> uncrawled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Runnable</span> task <span class="token operator">:</span> uncrawled<span class="token punctuation">)</span> 
            urlsToCrawl<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CrawlTask</span><span class="token punctuation">)</span> task<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">submitCrawlTask</span><span class="token punctuation">(</span><span class="token class-name">URL</span> u<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CrawlTask</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">CrawlTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">URL</span> url<span class="token punctuation">;</span>
        
        <span class="token comment">// ......</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>URL link <span class="token operator">:</span> <span class="token function">processPage</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token function">submitCrawlTask</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">URL</span> <span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> url<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728 TrackingExecutor \u4E2D\u5B58\u5728\u4E00\u4E2A\u4E0D\u53EF\u907F\u514D\u7684\u7ADE\u6001\u6761\u4EF6\uFF0C\u4ECE\u800C\u4EA7\u751F \u201C\u8BEF\u62A5\u201D \u95EE\u9898\uFF1A\u4E00\u4E9B\u88AB\u8BA4\u4E3A\u5DF2\u53D6\u6D88\u7684\u4EFB\u52A1\u5B9E\u9645\u4E0A\u5DF2\u7ECF\u6267\u884C\u5B8C\u6210\u3002\u8FD9\u4E2A\u95EE\u9898\u7684\u539F\u56E0\u5728\u4E8E\uFF0C\u5728\u4EFB\u52A1\u6267\u884C\u6700\u540E\u4E00\u6761\u6307\u4EE4\u4EE5\u53CA\u7EBF\u7A0B\u6C60\u5C06\u4EFB\u52A1\u8BB0\u5F55\u4E3A \u201C\u7ED3\u675F\u201D \u7684\u4E24\u4E2A\u65F6\u523B\u4E4B\u95F4\uFF0C\u7EBF\u7A0B\u6C60\u53EF\u80FD\u88AB\u5173\u95ED\u3002\u5982\u679C\u4EFB\u52A1\u662F\u5E42\u7B49\u7684\uFF08Idempotent\uFF0C\u5373\u5C06\u4EFB\u52A1\u6267\u884C\u4E24\u6B21\u4E0E\u6267\u884C\u4E00\u6B21\u4F1A\u5F97\u5230\u76F8\u540C\u7684\u7ED3\u679C\uFF09\uFF0C\u90A3\u4E48\u8FD9\u4E0D\u4F1A\u5B58\u5728\u95EE\u9898\uFF0C\u5728\u7F51\u9875\u722C\u866B\u7A0B\u5E8F\u4E2D\u5C31\u662F\u8FD9\u79CD\u60C5\u51B5\u3002\u5426\u5219\uFF0C\u5728\u5E94\u7528\u7A0B\u5E8F\u4E2D\u5FC5\u987B\u8003\u8651\u8FD9\u79CD\u98CE\u9669\uFF0C\u5E76\u5BF9 \u201C\u8BEF\u62A5\u201D \u95EE\u9898\u505A\u597D\u51C6\u5907\u3002</p><h2 id="_7-3-\u5904\u7406\u975E\u6B63\u5E38\u7684\u7EBF\u7A0B\u7EC8\u6B62" tabindex="-1"><a class="header-anchor" href="#_7-3-\u5904\u7406\u975E\u6B63\u5E38\u7684\u7EBF\u7A0B\u7EC8\u6B62" aria-hidden="true">#</a> 7.3 \u5904\u7406\u975E\u6B63\u5E38\u7684\u7EBF\u7A0B\u7EC8\u6B62</h2><p>\u5F53\u5355\u7EBF\u7A0B\u7684\u63A7\u5236\u53F0\u7A0B\u5E8F\u7531\u4E8E\u53D1\u751F\u4E86\u4E00\u4E2A\u672A\u6355\u83B7\u7684\u5F02\u5E38\u800C\u7EC8\u6B62\u65F6\uFF0C\u7A0B\u5E8F\u5C06\u505C\u6B62\u8FD0\u884C\uFF0C\u5E76\u4EA7\u751F\u4E0E\u7A0B\u5E8F\u6B63\u5E38\u8F93\u51FA\u975E\u5E38\u4E0D\u540C\u7684\u6808\u8FFD\u8E2A\u4FE1\u606F\uFF0C\u8FD9\u79CD\u60C5\u51B5\u662F\u5F88\u5BB9\u6613\u7406\u89E3\u7684\u3002\u7136\u800C\uFF0C\u5982\u679C\u5E76\u53D1\u7A0B\u5E8F\u4E2D\u7684\u67D0\u4E2A\u7EBF\u7A0B\u53D1\u751F\u6545\u969C\uFF0C\u90A3\u4E48\u901A\u5E38\u5E76\u4E0D\u4F1A\u5982\u6B64\u660E\u663E\u3002\u5728\u63A7\u5236\u53F0\u4E2D\u53EF\u80FD\u4F1A\u8F93\u51FA\u6808\u8FFD\u8E2A\u4FE1\u606F\uFF0C\u4F46\u6CA1\u6709\u4EBA\u4F1A\u89C2\u5BDF\u63A7\u5236\u53F0\u3002\u6B64\u5916\uFF0C\u5F53\u7EBF\u7A0B\u53D1\u751F\u6545\u969C\u65F6\uFF0C\u5E94\u7528\u7A0B\u5E8F\u53EF\u80FD\u770B\u8D77\u6765\u4ECD\u7136\u5728\u5DE5\u4F5C\uFF0C\u6240\u4EE5\u8FD9\u4E2A\u5931\u8D25\u5F88\u53EF\u80FD\u4F1A\u88AB\u5FFD\u7565\u3002\u5E78\u8FD0\u7684\u662F\uFF0C\u6211\u4EEC\u6709\u53EF\u4EE5\u76D1\u6D4B\u5E76\u9632\u6B62\u5728\u7A0B\u5E8F\u4E2D\u201C\u9057\u6F0F\u201D\u7EBF\u7A0B\u7684\u65B9\u6CD5\u3002</p><p>\u5BFC\u81F4\u7EBF\u7A0B\u63D0\u524D\u6B7B\u4EA1\u7684\u6700\u4E3B\u8981\u539F\u56E0\u5C31\u662F RuntimeException\u3002\u7531\u4E8E\u8FD9\u4E9B\u5F02\u5E38\u8868\u793A\u51FA\u73B0\u4E86\u67D0\u79CD\u7F16\u7A0B\u9519\u8BEF\u6216\u8005\u5176\u4ED6\u4E0D\u53EF\u4FEE\u590D\u7684\u9519\u8BEF\uFF0C\u56E0\u6B64\u5B83\u4EEC\u901A\u5E38\u4E0D\u4F1A\u88AB\u6355\u83B7\u3002\u5B83\u4EEC\u4E0D\u4F1A\u5728\u8C03\u7528\u6808\u4E2D\u9010\u5C42\u4F20\u9012\uFF0C\u800C\u662F\u9ED8\u8BA4\u5730\u5728\u63A7\u5236\u53F0\u4E2D\u8F93\u51FA\u6808\u8FFD\u8E2A\u4FE1\u606F\uFF0C\u5E76\u7EC8\u6B62\u7EBF\u7A0B\u3002</p><p>\u7EBF\u7A0B\u975E\u6B63\u5E38\u9000\u51FA\u7684\u540E\u679C\u53EF\u80FD\u662F\u826F\u6027\u7684\uFF0C\u4E5F\u53EF\u80FD\u662F\u6076\u6027\u7684\uFF0C\u8FD9\u8981\u53D6\u51B3\u4E8E\u7EBF\u7A0B\u5728\u5E94\u7528\u7A0B\u5E8F\u4E2D\u7684\u4F5C\u7528\u3002\u867D\u7136\u5728\u7EBF\u7A0B\u6C60\u4E2D\u4E22\u5931\u4E00\u4E2A\u7EBF\u7A0B\u53EF\u80FD\u4F1A\u5BF9\u6027\u80FD\u5E26\u6765\u4E00\u5B9A\u5F71\u54CD\uFF0C\u4F46\u5982\u679C\u7A0B\u5E8F\u80FD\u5728\u5305\u542B 50 \u4E2A\u7EBF\u7A0B\u7684\u7EBF\u7A0B\u6C60\u4E0A\u8FD0\u884C\u826F\u597D\uFF0C\u90A3\u4E48\u5728\u5305\u542B 49 \u4E2A\u7EBF\u7A0B\u7684\u7EBF\u7A0B\u6C60\u4E0A\u901A\u5E38\u4E5F\u80FD\u8FD0\u884C\u826F\u597D\u3002\u7136\u800C\uFF0C\u5982\u679C\u5728 GUI \u7A0B\u5E8F\u4E2D\u4E22\u5931\u4E86\u4E8B\u4EF6\u5206\u6D3E\u7EBF\u7A0B\uFF0C\u90A3\u4E48\u9020\u6210\u7684\u5F71\u54CD\u5C06\u975E\u5E38\u663E\u8457\u2014\u2014\u5E94\u7528\u7A0B\u5E8F\u5C06\u505C\u6B62\u5904\u7406\u4E8B\u4EF6\u5E76\u4E14 GUI \u4F1A\u56E0\u6B64\u5931\u53BB\u54CD\u5E94\u3002\u5728\u7B2C 6 \u7AE0\u7684 OutOfTime \u4E2D\u7ED9\u51FA\u4E86\u7531\u4E8E\u9057\u6F0F\u7EBF\u7A0B\u800C\u9020\u6210\u7684\u4E25\u91CD\u540E\u679C\uFF1ATimer \u8868\u793A\u7684\u670D\u52A1\u5C06\u6C38\u8FDC\u65E0\u6CD5\u4F7F\u7528\u3002</p><p>\u4EFB\u4F55\u4EE3\u7801\u90FD\u53EF\u80FD\u629B\u51FA\u4E00\u4E2A RuntimeException\u3002\u6BCF\u5F53\u8C03\u7528\u53E6\u4E00\u4E2A\u65B9\u6CD5\u65F6\uFF0C\u90FD\u8981\u5BF9\u5B83\u7684\u884C\u4E3A\u4FDD\u6301\u6000\u7591\uFF0C\u4E0D\u8981\u76F2\u76EE\u5730\u8BA4\u4E3A\u5B83\u4E00\u5B9A\u4F1A\u6B63\u5E38\u8FD4\u56DE\uFF0C\u6216\u8005\u4E00\u5B9A\u4F1A\u629B\u51FA\u5728\u65B9\u6CD5\u539F\u578B\u4E2D\u58F0\u660E\u7684\u67D0\u4E2A\u5DF2\u68C0\u67E5\u5F02\u5E38\u3002\u5BF9\u8C03\u7528\u7684\u4EE3\u7801\u8D8A\u4E0D\u719F\u6089\uFF0C\u5C31\u8D8A\u5E94\u8BE5\u5BF9\u5176\u4EE3\u7801\u884C\u4E3A\u4FDD\u6301\u6000\u7591\u3002</p><p>\u5728\u4EFB\u52A1\u5904\u7406\u7EBF\u7A0B\uFF08\u4F8B\u5982\u7EBF\u7A0B\u6C60\u4E2D\u7684\u5DE5\u4F5C\u8005\u7EBF\u7A0B\u6216\u8005 Swing \u7684\u4E8B\u4EF6\u6D3E\u53D1\u7EBF\u7A0B\u7B49\uFF09\u7684\u751F\u547D\u5468\u671F\u4E2D\uFF0C\u5C06\u901A\u8FC7\u67D0\u79CD\u62BD\u8C61\u673A\u5236\uFF08\u4F8B\u5982 Runnable\uFF09\u6765\u8C03\u7528\u8BB8\u591A\u672A\u77E5\u7684\u4EE3\u7801\uFF0C\u6211\u4EEC\u5E94\u8BE5\u5BF9\u5728\u8FD9\u4E9B\u7EBF\u7A0B\u4E2D\u6267\u884C\u7684\u4EE3\u7801\u80FD\u5426\u8868\u73B0\u51FA\u6B63\u786E\u7684\u884C\u4E3A\u4FDD\u6301\u6000\u7591\u3002\u50CF Swing \u4E8B\u4EF6\u7EBF\u7A0B\u8FD9\u6837\u7684\u670D\u52A1\u53EF\u80FD\u53EA\u662F\u56E0\u4E3A\u67D0\u4E2A\u7F16\u5199\u4E0D\u5F53\u7684\u4E8B\u4EF6\u5904\u7406\u5668\u629B\u51FA NullPointerException \u800C\u5931\u8D25\uFF0C\u8FD9\u79CD\u60C5\u51B5\u662F\u975E\u5E38\u7CDF\u7CD5\u7684\u3002\u56E0\u6B64\uFF0C\u8FD9\u4E9B\u7EBF\u7A0B\u5E94\u8BE5\u5728 try-catch \u4EE3\u7801\u5757\u4E2D\u8C03\u7528\u8FD9\u4E9B\u4EFB\u52A1\uFF0C\u8FD9\u6837\u5C31\u80FD\u6355\u83B7\u90A3\u4E9B\u672A\u68C0\u67E5\u7684\u5F02\u5E38\u4E86\uFF0C\u6216\u8005\u4E5F\u53EF\u4EE5\u4F7F\u7528 try-finally \u4EE3\u7801\u5757\u6765\u786E\u4FDD\u6846\u67B6\u80FD\u591F\u77E5\u9053\u7EBF\u7A0B\u975E\u6B63\u5E38\u9000\u51FA\u7684\u60C5\u51B5\uFF0C\u5E76\u505A\u51FA\u6B63\u786E\u7684\u54CD\u5E94\u3002\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u4F60\u6216\u8BB8\u4F1A\u8003\u8651\u6355\u83B7 RuntimeException\uFF0C\u5373\u5F53\u901A\u8FC7 Runnable \u8FD9\u6837\u7684\u62BD\u8C61\u673A\u5236\u6765\u8C03\u7528\u672A\u77E5\u7684\u548C\u4E0D\u53EF\u4FE1\u7684\u4EE3\u7801\u65F6\u3002<sup class="footnote-ref"><a href="#footnote7">[7]</a><a class="footnote-anchor" id="footnote-ref7"></a></sup></p><p>\u5728\u7A0B\u5E8F\u6E05\u53557-23 \u4E2D\u7ED9\u51FA\u4E86\u5982\u4F55\u5728\u7EBF\u7A0B\u6C60\u5185\u90E8\u6784\u5EFA\u4E00\u4E2A\u5DE5\u4F5C\u8005\u7EBF\u7A0B\u3002\u5982\u679C\u4EFB\u52A1\u629B\u51FA\u4E86\u4E00\u4E2A\u672A\u68C0\u67E5\u5F02\u5E38\uFF0C\u90A3\u4E48\u5B83\u5C06\u4F7F\u7EBF\u7A0B\u7EC8\u7ED3\uFF0C\u4F46\u4F1A\u9996\u5148\u901A\u77E5\u6846\u67B6\u8BE5\u7EBF\u7A0B\u5DF2\u7ECF\u7EC8\u7ED3\u3002\u7136\u540E\uFF0C\u6846\u67B6\u53EF\u80FD\u4F1A\u7528\u65B0\u7684\u7EBF\u7A0B\u6765\u4EE3\u66FF\u8FD9\u4E2A\u5DE5\u4F5C\u7EBF\u7A0B\uFF0C\u4E5F\u53EF\u80FD\u4E0D\u4F1A\uFF0C\u56E0\u4E3A\u7EBF\u7A0B\u6C60\u6B63\u5728\u5173\u95ED\uFF0C\u6216\u8005\u5F53\u524D\u5DF2\u6709\u8DB3\u591F\u591A\u7684\u7EBF\u7A0B\u80FD\u6EE1\u8DB3\u9700\u8981\u3002ThreadPoolExecutor \u548C Swing \u90FD\u901A\u8FC7\u8FD9\u9879\u6280\u672F\u6765\u786E\u4FDD\u884C\u4E3A\u7CDF\u7CD5\u7684\u4EFB\u52A1\u4E0D\u4F1A\u5F71\u54CD\u5230\u540E\u7EED\u4EFB\u52A1\u7684\u6267\u884C\u3002\u5F53\u7F16\u5199\u4E00\u4E2A\u5411\u7EBF\u7A0B\u6C60\u63D0\u4EA4\u4EFB\u52A1\u7684\u5DE5\u4F5C\u8005\u7EBF\u7A0B\u7C7B\u65F6\uFF0C\u6216\u8005\u8C03\u7528\u4E0D\u53EF\u4FE1\u7684\u5916\u90E8\u4EE3\u7801\u65F6\uFF08\u4F8B\u5982\u52A8\u6001\u52A0\u8F7D\u7684\u63D2\u4EF6\uFF09\uFF0C\u4F7F\u7528\u8FD9\u4E9B\u65B9\u6CD5\u4E2D\u7684\u67D0\u4E00\u79CD\u53EF\u4EE5\u907F\u514D\u67D0\u4E2A\u7F16\u5199\u5F97\u7CDF\u7CD5\u7684\u4EFB\u52A1\u6216\u63D2\u4EF6\u4E0D\u4F1A\u5F71\u54CD\u8C03\u7528\u5B83\u7684\u6574\u4E2A\u7EBF\u7A0B\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-23 \u5178\u578B\u7684\u7EBF\u7A0B\u6C60\u5DE5\u4F5C\u8005\u7EBF\u7A0B\u7ED3\u6784</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Throwable</span> thrown <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
            <span class="token function">runTask</span><span class="token punctuation">(</span><span class="token function">getTaskFromWorkQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        thrown <span class="token operator">=</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">threadExited</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> thrown<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u672A\u6355\u83B7\u5F02\u5E38\u7684\u5904\u7406</strong></p><p>\u4E0A\u8282\u4ECB\u7ECD\u4E86\u4E00\u79CD\u4E3B\u52A8\u65B9\u6CD5\u6765\u89E3\u51B3\u672A\u68C0\u67E5\u5F02\u5E38\u3002\u5728 Thread API \u4E2D\u540C\u6837\u63D0\u4F9B\u4E86 UncaughtExceptionHandler\uFF0C\u5B83\u80FD\u68C0\u6D4B\u51FA\u67D0\u4E2A\u7EBF\u7A0B\u7531\u4E8E\u672A\u6355\u83B7\u7684\u5F02\u5E38\u800C\u7EC8\u7ED3\u7684\u60C5\u51B5\u3002\u8FD9\u4E24\u79CD\u65B9\u6CD5\u662F\u4E92\u8865\u7684\uFF0C\u901A\u8FC7\u5C06\u4E8C\u8005\u7ED3\u5408\u5728\u4E00\u8D77\uFF0C\u5C31\u80FD\u6709\u6548\u5730\u9632\u6B62\u7EBF\u7A0B\u6CC4\u6F0F\u95EE\u9898\u3002</p><p>\u5F53\u4E00\u4E2A\u7EBF\u7A0B\u7531\u4E8E\u672A\u6355\u83B7\u5F02\u5E38\u800C\u9000\u51FA\u65F6\uFF0CJVM \u4F1A\u628A\u8FD9\u4E2A\u4E8B\u4EF6\u62A5\u544A\u7ED9\u5E94\u7528\u7A0B\u5E8F\u63D0\u4F9B\u7684 UncaughtExceptionHandler \u5F02\u5E38\u5904\u7406\u5668\uFF08\u89C1\u7A0B\u5E8F\u6E05\u53557-24\uFF09\u3002\u5982\u679C\u6CA1\u6709\u63D0\u4F9B\u4EFB\u4F55\u5F02\u5E38\u5904\u7406\u5668\uFF0C\u90A3\u4E48\u9ED8\u8BA4\u7684\u884C\u4E3A\u662F\u5C06\u6808\u8FFD\u8E2A\u4FE1\u606F\u8F93\u51FA\u5230 System.err\u3002<sup class="footnote-ref"><a href="#footnote8">[8]</a><a class="footnote-anchor" id="footnote-ref8"></a></sup></p><p>\u7A0B\u5E8F\u6E05\u53557-24 UncaughtExceptionHandler \u63A5\u53E3</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UncaughtExceptionHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">uncaughtException</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5F02\u5E38\u5904\u7406\u5668\u5982\u4F55\u5904\u7406\u672A\u6355\u83B7\u5F02\u5E38\uFF0C\u53D6\u51B3\u4E8E\u5BF9\u670D\u52A1\u8D28\u91CF\u7684\u9700\u6C42\u3002\u6700\u5E38\u89C1\u7684\u54CD\u5E94\u65B9\u5F0F\u662F\u5C06\u4E00\u4E2A\u9519\u8BEF\u4FE1\u606F\u4EE5\u53CA\u76F8\u5E94\u7684\u6808\u8FFD\u8E2A\u4FE1\u606F\u5199\u5165\u5E94\u7528\u7A0B\u5E8F\u65E5\u5FD7\u4E2D\uFF0C\u5982\u7A0B\u5E8F\u6E05\u53557-25 \u6240\u793A\u3002\u5F02\u5E38\u5904\u7406\u5668\u8FD8\u53EF\u4EE5\u91C7\u53D6\u66F4\u76F4\u63A5\u7684\u54CD\u5E94\uFF0C\u4F8B\u5982\u5C1D\u8BD5\u91CD\u65B0\u542F\u52A8\u7EBF\u7A0B\uFF0C\u5173\u95ED\u5E94\u7528\u7A0B\u5E8F\uFF0C\u6216\u8005\u6267\u884C\u5176\u4ED6\u4FEE\u590D\u6216\u8BCA\u65AD\u7B49\u64CD\u4F5C\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-25 \u5C06\u5F02\u5E38\u5199\u5165\u65E5\u5FD7\u7684 UncaughtExceptionHandler</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UEHLogger</span> <span class="token keyword">implements</span> <span class="token class-name">Thread<span class="token punctuation">.</span>UncaughtExceptionHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uncaughtException</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">getAnonymousLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Level</span><span class="token punctuation">.</span>SEVERE<span class="token punctuation">,</span> <span class="token string">&quot;Thread terminated with exception:&quot;</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u8FD0\u884C\u65F6\u95F4\u8F83\u957F\u7684\u5E94\u7528\u7A0B\u5E8F\u4E2D\uFF0C\u901A\u5E38\u4F1A\u4E3A\u6240\u6709\u7EBF\u7A0B\u7684\u672A\u6355\u83B7\u5F02\u5E38\u6307\u5B9A\u540C\u4E00\u4E2A\u5F02\u5E38\u5904\u7406\u5668\uFF0C\u5E76\u4E14\u8BE5\u5904\u7406\u5668\u81F3\u5C11\u4F1A\u5C06\u5F02\u5E38\u4FE1\u606F\u8BB0\u5F55\u5230\u65E5\u5FD7\u4E2D\u3002</p><p>\u8981\u4E3A\u7EBF\u7A0B\u6C60\u4E2D\u7684\u6240\u6709\u7EBF\u7A0B\u8BBE\u7F6E\u4E00\u4E2A UncaughtExceptionHandler\uFF0C\u9700\u8981\u4E3A ThreadPoolExecutor \u7684\u6784\u9020\u51FD\u6570\u63D0\u4F9B\u4E00\u4E2A ThreadFactory\u3002\uFF08\u4E0E\u6240\u6709\u7684\u7EBF\u7A0B\u64CD\u63A7\u4E00\u6837\uFF0C\u53EA\u6709\u7EBF\u7A0B\u7684\u6240\u6709\u8005\u80FD\u591F\u6539\u53D8\u7EBF\u7A0B\u7684 UncaughtExceptionHandler\u3002\uFF09\u6807\u51C6\u7EBF\u7A0B\u6C60\u5141\u8BB8\u5F53\u53D1\u751F\u672A\u6355\u83B7\u5F02\u5E38\u65F6\u7ED3\u675F\u7EBF\u7A0B\uFF0C\u4F46\u7531\u4E8E\u4F7F\u7528\u4E86\u4E00\u4E2A try-finally \u4EE3\u7801\u5757\u6765\u63A5\u6536\u901A\u77E5\uFF0C\u56E0\u6B64\u5F53\u7EBF\u7A0B\u7ED3\u675F\u65F6\uFF0C\u5C06\u6709\u65B0\u7684\u7EBF\u7A0B\u6765\u4EE3\u66FF\u5B83\u3002\u5982\u679C\u6CA1\u6709\u63D0\u4F9B\u6355\u83B7\u5F02\u5E38\u5904\u7406\u5668\u6216\u8005\u5176\u4ED6\u7684\u6545\u969C\u901A\u77E5\u673A\u5236\uFF0C\u90A3\u4E48\u4EFB\u52A1\u4F1A\u6084\u6084\u5931\u8D25\uFF0C\u4ECE\u800C\u5BFC\u81F4\u6781\u5927\u7684\u6DF7\u4E71\u3002\u5982\u679C\u4F60\u5E0C\u671B\u5728\u4EFB\u52A1\u7531\u4E8E\u53D1\u751F\u5F02\u5E38\u800C\u5931\u8D25\u65F6\u83B7\u5F97\u901A\u77E5\uFF0C\u5E76\u4E14\u6267\u884C\u4E00\u4E9B\u7279\u5B9A\u4E8E\u4EFB\u52A1\u7684\u6062\u590D\u64CD\u4F5C\uFF0C\u90A3\u4E48\u53EF\u4EE5\u5C06\u4EFB\u52A1\u5C01\u88C5\u5728\u80FD\u6355\u83B7\u5F02\u5E38\u7684 Runnable \u6216 Callable \u4E2D\uFF0C\u6216\u8005\u6539\u5199 ThreadPoolExecutor \u7684 afterExecute \u65B9\u6CD5\u3002</p><p>\u4EE4\u4EBA\u56F0\u60D1\u7684\u662F\uFF0C\u53EA\u6709\u901A\u8FC7 execute \u63D0\u4EA4\u7684\u4EFB\u52A1\uFF0C\u624D\u80FD\u5C06\u5B83\u629B\u51FA\u7684\u5F02\u5E38\u4EA4\u7ED9\u672A\u6355\u83B7\u5F02\u5E38\u5904\u7406\u5668\uFF0C\u800C\u901A\u8FC7 submit \u63D0\u4EA4\u7684\u4EFB\u52A1\uFF0C\u65E0\u8BBA\u662F\u629B\u51FA\u7684\u672A\u68C0\u67E5\u5F02\u5E38\u8FD8\u662F\u5DF2\u68C0\u67E5\u5F02\u5E38\uFF0C\u90FD\u5C06\u88AB\u8BA4\u4E3A\u662F\u4EFB\u52A1\u8FD4\u56DE\u72B6\u6001\u7684\u4E00\u90E8\u5206\u3002\u5982\u679C\u4E00\u4E2A\u7531 submit \u63D0\u4EA4\u7684\u4EFB\u52A1\u7531\u4E8E\u629B\u51FA\u4E86\u5F02\u5E38\u800C\u7ED3\u675F\uFF0C\u90A3\u4E48\u8FD9\u4E2A\u5F02\u5E38\u5C06\u88AB Future.get \u5C01\u88C5\u5728 ExecutionException \u4E2D\u91CD\u65B0\u629B\u51FA\u3002</p><h2 id="_7-4-jvm-\u5173\u95ED" tabindex="-1"><a class="header-anchor" href="#_7-4-jvm-\u5173\u95ED" aria-hidden="true">#</a> 7.4 JVM \u5173\u95ED</h2><p>JVM \u65E2\u53EF\u4EE5\u6B63\u5E38\u5173\u95ED\uFF0C\u4E5F\u53EF\u4EE5\u5F3A\u884C\u5173\u95ED\u3002\u6B63\u5E38\u5173\u95ED\u7684\u89E6\u53D1\u65B9\u5F0F\u6709\u591A\u79CD\uFF0C\u5305\u62EC\uFF1A\u5F53\u6700\u540E\u4E00\u4E2A \u201C\u6B63\u5E38\uFF08\u975E\u5B88\u62A4\uFF09\u201D \u7EBF\u7A0B\u7ED3\u675F\u65F6\uFF0C\u6216\u8005\u5F53\u8C03\u7528\u4E86 System.exit \u65F6\uFF0C\u6216\u8005\u901A\u8FC7\u5176\u4ED6\u7279\u5B9A\u4E8E\u5E73\u53F0\u7684\u65B9\u6CD5\u5173\u95ED\u65F6\uFF08\u4F8B\u5982\u53D1\u9001\u4E86 SIGINT \u4FE1\u53F7\u6216\u952E\u5165 Ctrl-C\uFF09\u3002\u867D\u7136\u53EF\u4EE5\u901A\u8FC7\u8FD9\u4E9B\u6807\u51C6\u65B9\u6CD5\u6765\u6B63\u5E38\u5173\u95ED JVM\uFF0C\u4F46\u4E5F\u53EF\u4EE5\u901A\u8FC7\u8C03\u7528 Runtime.halt \u6216\u8005\u5728\u64CD\u4F5C\u7CFB\u7EDF\u4E2D \u201C\u6740\u6B7B\u201D JVM \u8FDB\u7A0B\uFF08\u4F8B\u5982\u53D1\u9001 SIGKILL\uFF09\u6765\u5F3A\u884C\u5173\u95ED JVM\u3002</p><h3 id="_7-4-1-\u5173\u95ED\u94A9\u5B50" tabindex="-1"><a class="header-anchor" href="#_7-4-1-\u5173\u95ED\u94A9\u5B50" aria-hidden="true">#</a> 7.4.1 \u5173\u95ED\u94A9\u5B50</h3><p>\u5728\u6B63\u5E38\u5173\u95ED\u4E2D\uFF0CJVM \u9996\u5148\u8C03\u7528\u6240\u6709\u5DF2\u6CE8\u518C\u7684\u5173\u95ED\u94A9\u5B50\uFF08Shutdown Hook\uFF09\u3002\u5173\u95ED\u94A9\u5B50\u662F\u6307\u901A\u8FC7 Runtime.addShutdownHook \u6CE8\u518C\u7684\u4F46\u5C1A\u672A\u5F00\u59CB\u7684\u7EBF\u7A0B\u3002JVM \u5E76\u4E0D\u80FD\u4FDD\u8BC1\u5173\u95ED\u94A9\u5B50\u7684\u8C03\u7528\u987A\u5E8F\u3002\u5728\u5173\u95ED\u5E94\u7528\u7A0B\u5E8F\u7EBF\u7A0B\u65F6\uFF0C\u5982\u679C\u6709\uFF08\u5B88\u62A4\u6216\u975E\u5B88\u62A4\uFF09\u7EBF\u7A0B\u4ECD\u7136\u5728\u8FD0\u884C\uFF0C\u90A3\u4E48\u8FD9\u4E9B\u7EBF\u7A0B\u63A5\u4E0B\u6765\u5C06\u4E0E\u5173\u95ED\u8FDB\u7A0B\u5E76\u53D1\u6267\u884C\u3002\u5F53\u6240\u6709\u7684\u5173\u95ED\u94A9\u5B50\u90FD\u6267\u884C\u7ED3\u675F\u65F6\uFF0C\u5982\u679C runFinalizersOnExit \u4E3A true\uFF0C\u90A3\u4E48 JVM \u5C06\u8FD0\u884C\u7EC8\u7ED3\u5668\uFF0C\u7136\u540E\u518D\u505C\u6B62\u3002JVM \u5E76\u4E0D\u4F1A\u505C\u6B62\u6216\u4E2D\u65AD\u4EFB\u4F55\u5728\u5173\u95ED\u65F6\u4ECD\u7136\u8FD0\u884C\u7684\u5E94\u7528\u7A0B\u5E8F\u7EBF\u7A0B\u3002\u5F53 JVM \u6700\u7EC8\u7ED3\u675F\u65F6\uFF0C\u8FD9\u4E9B\u7EBF\u7A0B\u5C06\u88AB\u5F3A\u884C\u7ED3\u675F\u3002\u5982\u679C\u5173\u95ED\u94A9\u5B50\u6216\u7EC8\u7ED3\u5668\u6CA1\u6709\u6267\u884C\u5B8C\u6210\uFF0C\u90A3\u4E48\u6B63\u5E38\u5173\u95ED\u8FDB\u7A0B \u201C\u6302\u8D77\u201D \u5E76\u4E14 JVM \u5FC5\u987B\u88AB\u5F3A\u884C\u5173\u95ED\u3002\u5F53\u88AB\u5F3A\u884C\u5173\u95ED\u65F6\uFF0C\u53EA\u662F\u5173\u95ED JVM\uFF0C\u800C\u4E0D\u4F1A\u8FD0\u884C\u5173\u95ED\u94A9\u5B50\u3002</p><p>\u5173\u95ED\u94A9\u5B50\u5E94\u8BE5\u662F\u7EBF\u7A0B\u5B89\u5168\u7684\uFF1A\u5B83\u4EEC\u5728\u8BBF\u95EE\u5171\u4EAB\u6570\u636E\u65F6\u5FC5\u987B\u4F7F\u7528\u540C\u6B65\u673A\u5236\uFF0C\u5E76\u4E14\u5C0F\u5FC3\u5730\u907F\u514D\u53D1\u751F\u6B7B\u9501\uFF0C\u8FD9\u4E0E\u5176\u4ED6\u5E76\u53D1\u4EE3\u7801\u7684\u8981\u6C42\u76F8\u540C\u3002\u800C\u4E14\uFF0C\u5173\u95ED\u94A9\u5B50\u4E0D\u5E94\u8BE5\u5BF9\u5E94\u7528\u7A0B\u5E8F\u7684\u72B6\u6001\uFF08\u4F8B\u5982\uFF0C\u5176\u4ED6\u670D\u52A1\u662F\u5426\u5DF2\u7ECF\u5173\u95ED\uFF0C\u6216\u8005\u6240\u6709\u7684\u6B63\u5E38\u7EBF\u7A0B\u662F\u5426\u5DF2\u7ECF\u6267\u884C\u5B8C\u6210\uFF09\u6216\u8005 JVM \u7684\u5173\u95ED\u539F\u56E0\u505A\u51FA\u4EFB\u4F55\u5047\u8BBE\uFF0C\u56E0\u6B64\u5728\u7F16\u5199\u5173\u95ED\u94A9\u5B50\u7684\u4EE3\u7801\u65F6\u5FC5\u987B\u8003\u8651\u5468\u5168\u3002\u6700\u540E\uFF0C\u5173\u95ED\u94A9\u5B50\u5FC5\u987B\u5C3D\u5FEB\u9000\u51FA\uFF0C\u56E0\u4E3A\u5B83\u4EEC\u4F1A\u5EF6\u8FDF JVM \u7684\u7ED3\u675F\u65F6\u95F4\uFF0C\u800C\u7528\u6237\u53EF\u80FD\u5E0C\u671B JVM \u80FD\u5C3D\u5FEB\u7EC8\u6B62\u3002</p><p>\u5173\u95ED\u94A9\u5B50\u53EF\u4EE5\u7528\u4E8E\u5B9E\u73B0\u670D\u52A1\u6216\u5E94\u7528\u7A0B\u5E8F\u7684\u6E05\u7406\u5DE5\u4F5C\uFF0C\u4F8B\u5982\u5220\u9664\u4E34\u65F6\u6587\u4EF6\uFF0C\u6216\u8005\u6E05\u9664\u65E0\u6CD5\u7531\u64CD\u4F5C\u7CFB\u7EDF\u81EA\u52A8\u6E05\u9664\u7684\u8D44\u6E90\u3002\u5728\u7A0B\u5E8F\u6E05\u53557-26 \u4E2D\u7ED9\u51FA\u4E86\u5982\u4F55\u4F7F\u7A0B\u5E8F\u6E05\u53557-16 \u4E2D\u7684 LogService \u5728\u5176 start \u65B9\u6CD5\u4E2D\u6CE8\u518C\u4E00\u4E2A\u5173\u95ED\u94A9\u5B50\uFF0C\u4ECE\u800C\u786E\u4FDD\u5728\u9000\u51FA\u65F6\u5173\u95ED\u65E5\u5FD7\u6587\u4EF6\u3002</p><p>\u7531\u4E8E\u5173\u95ED\u94A9\u5B50\u5C06\u5E76\u53D1\u6267\u884C\uFF0C\u56E0\u6B64\u5728\u5173\u95ED\u65E5\u5FD7\u6587\u4EF6\u65F6\u53EF\u80FD\u5BFC\u81F4\u5176\u4ED6\u9700\u8981\u65E5\u5FD7\u670D\u52A1\u7684\u5173\u95ED\u94A9\u5B50\u4EA7\u751F\u95EE\u9898\u3002\u4E3A\u4E86\u907F\u514D\u8FD9\u79CD\u60C5\u51B5\uFF0C\u5173\u95ED\u94A9\u5B50\u4E0D\u5E94\u8BE5\u4F9D\u8D56\u90A3\u4E9B\u53EF\u80FD\u88AB\u5E94\u7528\u7A0B\u5E8F\u6216\u5176\u4ED6\u5173\u95ED\u94A9\u5B50\u5173\u95ED\u7684\u670D\u52A1\u3002\u5B9E\u73B0\u8FD9\u79CD\u529F\u80FD\u7684\u4E00\u79CD\u65B9\u5F0F\u662F\u5BF9\u6240\u6709\u670D\u52A1\u4F7F\u7528\u540C\u4E00\u4E2A\u5173\u95ED\u94A9\u5B50\uFF08\u800C\u4E0D\u662F\u6BCF\u4E2A\u670D\u52A1\u4F7F\u7528\u4E00\u4E2A\u4E0D\u540C\u7684\u5173\u95ED\u94A9\u5B50\uFF09\uFF0C\u5E76\u4E14\u5728\u8BE5\u5173\u95ED\u94A9\u5B50\u4E2D\u6267\u884C\u4E00\u7CFB\u5217\u7684\u5173\u95ED\u64CD\u4F5C\u3002\u8FD9\u786E\u4FDD\u4E86\u5173\u95ED\u64CD\u4F5C\u5728\u5355\u4E2A\u7EBF\u7A0B\u4E2D\u4E32\u884C\u6267\u884C\uFF0C\u4ECE\u800C\u907F\u514D\u4E86\u5728\u5173\u95ED\u64CD\u4F5C\u4E4B\u95F4\u51FA\u73B0\u7ADE\u6001\u6761\u4EF6\u6216\u6B7B\u9501\u7B49\u95EE\u9898\u3002\u65E0\u8BBA\u662F\u5426\u4F7F\u7528\u5173\u95ED\u94A9\u5B50\uFF0C\u90FD\u53EF\u4EE5\u4F7F\u7528\u8FD9\u9879\u6280\u672F\uFF0C\u901A\u8FC7\u5C06\u5404\u4E2A\u5173\u95ED\u64CD\u4F5C\u4E32\u884C\u6267\u884C\u800C\u4E0D\u662F\u5E76\u884C\u6267\u884C\uFF0C\u53EF\u4EE5\u6D88\u9664\u8BB8\u591A\u6F5C\u5728\u7684\u6545\u969C\u3002\u5F53\u5E94\u7528\u7A0B\u5E8F\u9700\u8981\u7EF4\u62A4\u591A\u4E2A\u670D\u52A1\u4E4B\u95F4\u7684\u663E\u5F0F\u4F9D\u8D56\u4FE1\u606F\u65F6\uFF0C\u8FD9\u9879\u6280\u672F\u53EF\u4EE5\u786E\u4FDD\u5173\u95ED\u64CD\u4F5C\u6309\u7167\u6B63\u786E\u7684\u987A\u5E8F\u6267\u884C\u3002</p><p>\u7A0B\u5E8F\u6E05\u53557-26 \u901A\u8FC7\u6CE8\u518C\u4E00\u4E2A\u5173\u95ED\u94A9\u5B50\u6765\u505C\u6B62\u65E5\u5FD7\u670D\u52A1</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">LogService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-4-2-\u5B88\u62A4\u7EBF\u7A0B" tabindex="-1"><a class="header-anchor" href="#_7-4-2-\u5B88\u62A4\u7EBF\u7A0B" aria-hidden="true">#</a> 7.4.2 \u5B88\u62A4\u7EBF\u7A0B</h3><p>\u6709\u65F6\u5019\uFF0C\u4F60\u5E0C\u671B\u521B\u5EFA\u4E00\u4E2A\u7EBF\u7A0B\u6765\u6267\u884C\u4E00\u4E9B\u8F85\u52A9\u5DE5\u4F5C\uFF0C\u4F46\u53C8\u4E0D\u5E0C\u671B\u8FD9\u4E2A\u7EBF\u7A0B\u963B\u788D JVM \u7684\u5173\u95ED\u3002\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\u5C31\u9700\u8981\u4F7F\u7528\u5B88\u62A4\u7EBF\u7A0B\uFF08Daemon Thread\uFF09\u3002</p><p>\u7EBF\u7A0B\u53EF\u5206\u4E3A\u4E24\u79CD\uFF1A<strong>\u666E\u901A\u7EBF\u7A0B</strong>\u548C<strong>\u5B88\u62A4\u7EBF\u7A0B</strong>\u3002\u5728 JVM \u542F\u52A8\u65F6\u521B\u5EFA\u7684\u6240\u6709\u7EBF\u7A0B\u4E2D\uFF0C\u9664\u4E86\u4E3B\u7EBF\u7A0B\u4EE5\u5916\uFF0C\u5176\u4ED6\u7684\u7EBF\u7A0B\u90FD\u662F\u5B88\u62A4\u7EBF\u7A0B\uFF08\u4F8B\u5982\u5783\u573E\u56DE\u6536\u5668\u4EE5\u53CA\u5176\u4ED6\u6267\u884C\u8F85\u52A9\u5DE5\u4F5C\u7684\u7EBF\u7A0B\uFF09\u3002\u5F53\u521B\u5EFA\u4E00\u4E2A\u65B0\u7EBF\u7A0B\u65F6\uFF0C\u65B0\u7EBF\u7A0B\u5C06\u7EE7\u627F\u521B\u5EFA\u5B83\u7684\u7EBF\u7A0B\u7684\u5B88\u62A4\u72B6\u6001\uFF0C\u56E0\u6B64\u5728\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0C\u4E3B\u7EBF\u7A0B\u521B\u5EFA\u7684\u6240\u6709\u7EBF\u7A0B\u90FD\u662F\u666E\u901A\u7EBF\u7A0B\u3002</p><p>\u666E\u901A\u7EBF\u7A0B\u4E0E\u5B88\u62A4\u7EBF\u7A0B\u4E4B\u95F4\u7684\u5DEE\u5F02\u4EC5\u5728\u4E8E\u5F53\u7EBF\u7A0B\u9000\u51FA\u65F6\u53D1\u751F\u7684\u64CD\u4F5C\u3002\u5F53\u4E00\u4E2A\u7EBF\u7A0B\u9000\u51FA\u65F6\uFF0CJVM \u4F1A\u68C0\u67E5\u5176\u4ED6\u6B63\u5728\u8FD0\u884C\u7684\u7EBF\u7A0B\uFF0C\u5982\u679C\u8FD9\u4E9B\u7EBF\u7A0B\u90FD\u662F\u5B88\u62A4\u7EBF\u7A0B\uFF0C\u90A3\u4E48 JVM \u4F1A\u6B63\u5E38\u9000\u51FA\u64CD\u4F5C\u3002\u5F53 JVM \u505C\u6B62\u65F6\uFF0C\u6240\u6709\u4ECD\u7136\u5B58\u5728\u7684\u5B88\u62A4\u7EBF\u7A0B\u90FD\u5C06\u88AB\u629B\u5F03\u2014\u2014\u65E2\u4E0D\u4F1A\u6267\u884C finally \u4EE3\u7801\u5757\uFF0C\u4E5F\u4E0D\u4F1A\u6267\u884C\u56DE\u5377\u6808\uFF0C\u800C JVM \u53EA\u662F\u76F4\u63A5\u9000\u51FA\u3002</p><p>\u6211\u4EEC\u5E94\u5C3D\u53EF\u80FD\u5C11\u5730\u4F7F\u7528\u5B88\u62A4\u7EBF\u7A0B\u2014\u2014\u5F88\u5C11\u6709\u64CD\u4F5C\u80FD\u591F\u5728\u4E0D\u8FDB\u884C\u6E05\u7406\u7684\u60C5\u51B5\u4E0B\u88AB\u5B89\u5168\u5730\u629B\u5F03\u3002\u7279\u522B\u662F\uFF0C\u5982\u679C\u5728\u5B88\u62A4\u7EBF\u7A0B\u4E2D\u6267\u884C\u53EF\u80FD\u5305\u542B I/O \u64CD\u4F5C\u7684\u4EFB\u52A1\uFF0C\u90A3\u4E48\u5C06\u662F\u4E00\u79CD\u5371\u9669\u7684\u884C\u4E3A\u3002\u5B88\u62A4\u7EBF\u7A0B\u6700\u597D\u7528\u4E8E\u6267\u884C \u201C\u5185\u90E8\u201D \u4EFB\u52A1\uFF0C\u4F8B\u5982\u5468\u671F\u6027\u5730\u4ECE\u5185\u5B58\u7684\u7F13\u5B58\u4E2D\u79FB\u9664\u903E\u671F\u7684\u6570\u636E\u3002</p><p>\u6B64\u5916\uFF0C\u5B88\u62A4\u7EBF\u7A0B\u901A\u5E38\u4E0D\u80FD\u7528\u6765\u66FF\u4EE3\u5E94\u7528\u7A0B\u5E8F\u7BA1\u7406\u7A0B\u5E8F\u4E2D\u5404\u4E2A\u670D\u52A1\u7684\u751F\u547D\u5468\u671F\u3002</p><h3 id="_7-4-3-\u7EC8\u7ED3\u5668" tabindex="-1"><a class="header-anchor" href="#_7-4-3-\u7EC8\u7ED3\u5668" aria-hidden="true">#</a> 7.4.3 \u7EC8\u7ED3\u5668</h3><p>\u5F53\u4E0D\u518D\u9700\u8981\u5185\u5B58\u8D44\u6E90\u65F6\uFF0C\u53EF\u4EE5\u901A\u8FC7\u5783\u573E\u56DE\u6536\u5668\u6765\u56DE\u6536\u5B83\u4EEC\uFF0C\u4F46\u5BF9\u4E8E\u5176\u4ED6\u4E00\u4E9B\u8D44\u6E90\uFF0C\u4F8B\u5982\u6587\u4EF6\u53E5\u67C4\u6216\u5957\u63A5\u5B57\u53E5\u67C4\uFF0C\u5F53\u4E0D\u518D\u9700\u8981\u5B83\u4EEC\u65F6\uFF0C\u5FC5\u987B\u663E\u5F0F\u5730\u4EA4\u8FD8\u7ED9\u64CD\u4F5C\u7CFB\u7EDF\u3002\u4E3A\u4E86\u5B9E\u73B0\u8FD9\u4E2A\u529F\u80FD\uFF0C\u5783\u573E\u56DE\u6536\u5668\u5BF9\u90A3\u4E9B\u5B9A\u4E49\u4E86 finalize \u65B9\u6CD5\u7684\u5BF9\u8C61\u4F1A\u8FDB\u884C\u7279\u6B8A\u5904\u7406\uFF1A\u5728\u56DE\u6536\u5668\u91CA\u653E\u5B83\u4EEC\u540E\uFF0C\u8C03\u7528\u5B83\u4EEC\u7684 finalize \u65B9\u6CD5\uFF0C\u4ECE\u800C\u4FDD\u8BC1\u4E00\u4E9B\u6301\u4E45\u5316\u7684\u8D44\u6E90\u88AB\u91CA\u653E\u3002</p><p>\u7531\u4E8E\u7EC8\u7ED3\u5668\u53EF\u4EE5\u5728\u67D0\u4E2A\u7531 JVM \u7BA1\u7406\u7684\u7EBF\u7A0B\u4E2D\u8FD0\u884C\uFF0C\u56E0\u6B64\u7EC8\u7ED3\u5668\u8BBF\u95EE\u7684\u4EFB\u4F55\u72B6\u6001\u90FD\u53EF\u80FD\u88AB\u591A\u4E2A\u7EBF\u7A0B\u8BBF\u95EE\uFF0C\u8FD9\u6837\u5C31\u5FC5\u987B\u5BF9\u5176\u8BBF\u95EE\u64CD\u4F5C\u8FDB\u884C\u540C\u6B65\u3002\u7EC8\u7ED3\u5668\u5E76\u4E0D\u80FD\u4FDD\u8BC1\u5B83\u4EEC\u5C06\u5728\u4F55\u65F6\u8FD0\u884C\u751A\u81F3\u662F\u5426\u4F1A\u8FD0\u884C\uFF0C\u5E76\u4E14\u590D\u6742\u7684\u7EC8\u7ED3\u5668\u901A\u5E38\u8FD8\u4F1A\u5728\u5BF9\u8C61\u4E0A\u4EA7\u751F\u5DE8\u5927\u7684\u6027\u80FD\u5F00\u9500\u3002\u8981\u7F16\u5199\u6B63\u786E\u7684\u7EC8\u7ED3\u5668\u662F\u975E\u5E38\u56F0\u96BE\u7684\u3002<sup class="footnote-ref"><a href="#footnote9">[9]</a><a class="footnote-anchor" id="footnote-ref9"></a></sup>\u5728\u5927\u591A\u6570\u60C5\u51B5\u4E0B\uFF0C\u901A\u8FC7\u4F7F\u7528 finally \u4EE3\u7801\u5757\u548C\u663E\u5F0F\u7684 close \u65B9\u6CD5\uFF0C\u80FD\u591F\u6BD4\u4F7F\u7528\u7EC8\u7ED3\u5668\u66F4\u597D\u5730\u7BA1\u7406\u8D44\u6E90\u3002\u552F\u4E00\u7684\u4F8B\u5916\u60C5\u51B5\u5728\u4E8E\uFF1A\u5F53\u9700\u8981\u7BA1\u7406\u5BF9\u8C61\uFF0C\u5E76\u4E14\u8BE5\u5BF9\u8C61\u6301\u6709\u7684\u8D44\u6E90\u662F\u901A\u8FC7\u672C\u5730\u65B9\u6CD5\u83B7\u5F97\u7684\u3002\u57FA\u4E8E\u8FD9\u4E9B\u539F\u56E0\u4EE5\u53CA\u5176\u4ED6\u4E00\u4E9B\u539F\u56E0\uFF0C\u6211\u4EEC\u8981\u5C3D\u91CF\u907F\u514D\u7F16\u5199\u6216\u4F7F\u7528\u5305\u542B\u7EC8\u7ED3\u5668\u7684\u7C7B\uFF08\u9664\u975E\u662F\u5E73\u53F0\u5E93\u4E2D\u7684\u7C7B\uFF09[EJ Item 6]\u3002</p><p>\u907F\u514D\u4F7F\u7528\u7EC8\u7ED3\u5668\u3002</p><p><strong>\u5C0F\u7ED3</strong></p><p>\u5728\u4EFB\u52A1\u3001\u7EBF\u7A0B\u3001\u670D\u52A1\u4EE5\u53CA\u5E94\u7528\u7A0B\u5E8F\u7B49\u6A21\u5757\u4E2D\u7684\u751F\u547D\u5468\u671F\u7ED3\u675F\u95EE\u9898\uFF0C\u53EF\u80FD\u4F1A\u589E\u52A0\u5B83\u4EEC\u5728\u8BBE\u8BA1\u548C\u5B9E\u73B0\u65F6\u7684\u590D\u6742\u6027\u3002Java \u5E76\u6CA1\u6709\u63D0\u4F9B\u67D0\u79CD\u62A2\u5360\u5F0F\u7684\u673A\u5236\u6765\u53D6\u6D88\u64CD\u4F5C\u6216\u8005\u7EC8\u7ED3\u7EBF\u7A0B\u3002\u76F8\u53CD\uFF0C\u5B83\u63D0\u4F9B\u4E86\u4E00\u79CD\u534F\u4F5C\u5F0F\u7684\u4E2D\u65AD\u673A\u5236\u6765\u5B9E\u73B0\u53D6\u6D88\u64CD\u4F5C\uFF0C\u4F46\u8FD9\u8981\u4F9D\u8D56\u4E8E\u5982\u4F55\u6784\u5EFA\u53D6\u6D88\u64CD\u4F5C\u7684\u534F\u8BAE\uFF0C\u4EE5\u53CA\u80FD\u5426\u59CB\u7EC8\u9075\u5FAA\u8FD9\u4E9B\u534F\u8BAE\u3002\u901A\u8FC7\u4F7F\u7528 FutureTask \u548C Executor \u6846\u67B6\uFF0C\u53EF\u4EE5\u5E2E\u52A9\u6211\u4EEC\u6784\u5EFA\u53EF\u53D6\u6D88\u7684\u4EFB\u52A1\u548C\u670D\u52A1\u3002</p><hr class="footnotes-sep">`,102),y={class:"footnotes"},h={class:"footnotes-list"},f={id:"footnote1",class:"footnote-item"},g=s("\u867D\u7136 Thread.stop \u548C suspend \u7B49\u65B9\u6CD5\u63D0\u4F9B\u4E86\u8FD9\u6837\u7684\u673A\u5236\uFF0C\u4F46\u7531\u4E8E\u5B58\u5728\u7740\u4E00\u4E9B\u4E25\u91CD\u7684\u7F3A\u9677\uFF0C\u56E0\u6B64\u5E94\u8BE5\u907F\u514D\u4F7F\u7528\u3002\u8BF7\u53C2\u89C1 "),x={href:"http://java.sun.com/j2se/1.5.0/docs/guide/misc/threadPrimitiveDeprecation.html",target:"_blank",rel:"noopener noreferrer"},T=s("http://java.sun.com/j2se/1.5.0/docs/guide/misc/threadPrimitiveDeprecation.html"),E=s(" \u4E86\u89E3\u5BF9\u8FD9\u4E9B\u95EE\u9898\u7684\u8BE6\u7EC6\u8BF4\u660E\u3002 "),I=n("a",{href:"#footnote-ref1",class:"footnote-backref"},"\u21A9\uFE0E",-1),S=e('<li id="footnote2" class="footnote-item"><p>\u8FD9\u662F Thread API \u7684\u4E00\u4E2A\u7F3A\u9677\uFF0C\u56E0\u4E3A\u65E0\u8BBA join \u662F\u5426\u6210\u529F\u5730\u5B8C\u6210\uFF0C\u5728 Java \u5185\u5B58\u6A21\u578B\u4E2D\u90FD\u4F1A\u6709\u5185\u5B58\u53EF\u89C1\u6027\u7ED3\u679C\uFF0C\u4F46 join \u672C\u8EAB\u4E0D\u4F1A\u8FD4\u56DE\u67D0\u4E2A\u72B6\u6001\u6765\u8868\u660E\u5B83\u662F\u5426\u6210\u529F\u3002 <a href="#footnote-ref2" class="footnote-backref">\u21A9\uFE0E</a></p></li><li id="footnote3" class="footnote-item"><p>\u5982\u679C\u9700\u8981\u5728\u5355\u6761\u65E5\u5FD7\u6D88\u606F\u4E2D\u5199\u5165\u591A\u884C\uFF0C\u90A3\u4E48\u8981\u901A\u8FC7\u5BA2\u6237\u7AEF\u52A0\u9501\u6765\u907F\u514D\u591A\u4E2A\u7EBF\u7A0B\u4E0D\u6B63\u786E\u5730\u4EA4\u9519\u8F93\u51FA\u3002\u5982\u679C\u4E24\u4E2A\u7EBF\u7A0B\u540C\u65F6\u628A\u591A\u884C\u6808\u8FFD\u8E2A\u4FE1\u606F\uFF08Stack Trace\uFF09\u6DFB\u52A0\u5230\u540C\u4E00\u4E2A\u6D41\u4E2D\uFF0C\u5E76\u4E14\u6BCF\u884C\u4FE1\u606F\u5BF9\u5E94\u4E00\u4E2A println \u8C03\u7528\uFF0C\u90A3\u4E48\u8FD9\u4E9B\u4FE1\u606F\u5728\u8F93\u51FA\u4E2D\u5C06\u4EA4\u9519\u5728\u4E00\u8D77\uFF0C\u770B\u4E0A\u53BB\u5C31\u662F\u4E00\u4E9B\u867D\u7136\u5E9E\u5927\u4F46\u5374\u6BEB\u65E0\u610F\u4E49\u7684\u6808\u8FFD\u8E2A\u4FE1\u606F <a href="#footnote-ref3" class="footnote-backref">\u21A9\uFE0E</a></p></li><li id="footnote4" class="footnote-item"><p>\u4E4B\u6240\u4EE5\u91C7\u7528 AtomicBoolean \u6765\u4EE3\u66FF volatile \u7C7B\u578B\u7684 boolean\uFF0C\u662F\u56E0\u4E3A\u80FD\u4ECE\u5185\u90E8\u7684 Runnable \u4E2D\u8BBF\u95EE hasNewMail \u6807\u5FD7\uFF0C\u56E0\u6B64\u5B83\u5FC5\u987B\u662F final \u7C7B\u578B\u4EE5\u514D\u88AB\u4FEE\u6539\u3002 <a href="#footnote-ref4" class="footnote-backref">\u21A9\uFE0E</a></p></li><li id="footnote5" class="footnote-item"><p>shutdownNow \u8FD4\u56DE\u7684 Runnable \u5BF9\u8C61\u53EF\u80FD\u4E0E\u63D0\u4EA4\u7ED9 ExecutorService \u7684 Runnable \u5BF9\u8C61\u5E76\u4E0D\u76F8\u540C\uFF1A\u5B83\u4EEC\u53EF\u80FD\u662F\u88AB\u5C01\u88C5\u8FC7\u7684\u5DF2\u63D0\u4EA4\u4EFB\u52A1\u3002 <a href="#footnote-ref5" class="footnote-backref">\u21A9\uFE0E</a></p></li><li id="footnote6" class="footnote-item"><p>\u7136\u800C\uFF0C\u5728\u5173\u95ED\u8FC7\u7A0B\u4E2D\u53EA\u4F1A\u8FD4\u56DE\u5C1A\u672A\u5F00\u59CB\u7684\u4EFB\u52A1\uFF0C\u800C\u4E0D\u4F1A\u8FD4\u56DE\u6B63\u5728\u6267\u884C\u7684\u4EFB\u52A1\u3002\u5982\u679C\u80FD\u8FD4\u56DE\u6240\u6709\u8FD9\u4E24\u79CD\u7C7B\u578B\u7684\u4EFB\u52A1\uFF0C\u90A3\u4E48\u5C31\u4E0D\u9700\u8981\u8FD9\u79CD\u4E0D\u786E\u5B9A\u7684\u4E2D\u95F4\u72B6\u6001\u3002 <a href="#footnote-ref6" class="footnote-backref">\u21A9\uFE0E</a></p></li><li id="footnote7" class="footnote-item"><p>\u8FD9\u9879\u6280\u672F\u7684\u5B89\u5168\u6027\u5B58\u5728\u7740\u4E00\u4E9B\u4E89\u8BAE\u3002\u5F53\u7EBF\u7A0B\u629B\u51FA\u4E00\u4E2A\u672A\u68C0\u67E5\u5F02\u5E38\u65F6\uFF0C\u6574\u4E2A\u5E94\u7528\u7A0B\u5E8F\u90FD\u53EF\u80FD\u53D7\u5230\u5F71\u54CD\u3002\u4F46\u5176\u66FF\u4EE3\u65B9\u6CD5\u2014\u2014\u5173\u95ED\u6574\u4E2A\u5E94\u7528\u7A0B\u5E8F\uFF0C\u901A\u5E38\u662F\u66F4\u4E0D\u5207\u5B9E\u9645\u7684\u3002 <a href="#footnote-ref7" class="footnote-backref">\u21A9\uFE0E</a></p></li><li id="footnote8" class="footnote-item"><p>\u5728 Java 5.0 \u4E4B\u524D\uFF0C\u63A7\u5236 UncaughtExceptionHandler \u7684\u552F\u4E00\u65B9\u6CD5\u5C31\u662F\u5BF9 ThreadGroup \u8FDB\u884C\u5B50\u7C7B\u5316\u3002\u5728 Java 5.0 \u53CA\u4E4B\u540E\u7684\u7248\u672C\u4E2D\uFF0C\u53EF\u4EE5\u901A\u8FC7 Thread.setUncaughtExceptionHandler \u4E3A\u6BCF\u4E2A\u7EBF\u7A0B\u8BBE\u7F6E\u4E00\u4E2A Uncaught-ExceptionHandler\uFF0C\u8FD8\u53EF\u4EE5\u4F7F\u7528 setDefaultUncaughtExceptionHandler \u6765\u8BBE\u7F6E\u9ED8\u8BA4\u7684 UncaughtExceptionHandler\u3002\u7136\u800C\uFF0C\u5728\u8FD9\u4E9B\u5F02\u5E38\u5904\u7406\u5668\u4E2D\uFF0C\u53EA\u6709\u5176\u4E2D\u4E00\u4E2A\u5C06\u88AB\u8C03\u7528\u2014\u2014JVM \u9996\u5148\u641C\u7D22\u6BCF\u4E2A\u7EBF\u7A0B\u7684\u5F02\u5E38\u5904\u7406\u5668\uFF0C\u7136\u540E\u518D\u641C\u7D22\u4E00\u4E2A ThreadGroup \u7684\u5F02\u5E38\u5904\u7406\u5668\u3002ThreadGroup \u4E2D\u7684\u9ED8\u8BA4\u5F02\u5E38\u5904\u7406\u5668\u5B9E\u73B0\u5C06\u5F02\u5E38\u5904\u7406\u5DE5\u4F5C\u9010\u5C42\u59D4\u6258\u7ED9\u5B83\u7684\u4E0A\u5C42 ThreadGroup\uFF0C\u76F4\u81F3\u5176\u4E2D\u67D0\u4E2A ThreadGroup \u7684\u5F02\u5E38\u5904\u7406\u5668\u80FD\u591F\u5904\u7406\u8BE5\u672A\u6355\u83B7\u5F02\u5E38\uFF0C\u5426\u5219\u5C06\u4E00\u76F4\u4F20\u9012\u5230\u9876\u5C42\u7684 ThreadGroup\u3002\u9876\u5C42 ThreadGroup \u7684\u5F02\u5E38\u5904\u7406\u5668\u59D4\u6258\u7ED9\u9ED8\u8BA4\u7684\u7CFB\u7EDF\u5904\u7406\u5668\uFF08\u5982\u679C\u5B58\u5728\uFF0C\u5728\u9ED8\u8BA4\u60C5\u51B5\u4E0B\u4E3A\u7A7A\uFF09\uFF0C\u5426\u5219\u5C06\u628A\u6808\u8FFD\u8E2A\u4FE1\u606F\u8F93\u51FA\u5230\u63A7\u5236\u53F0\u3002 <a href="#footnote-ref8" class="footnote-backref">\u21A9\uFE0E</a></p></li><li id="footnote9" class="footnote-item"><p>\u8BF7\u53C2\u9605\uFF08Boehm\uFF0C2005\uFF09\u5E76\u4E86\u89E3\u5728\u7F16\u5199\u7EC8\u7ED3\u5668\u65F6\u5B58\u5728\u7684\u5404\u79CD\u56F0\u96BE\u3002 <a href="#footnote-ref9" class="footnote-backref">\u21A9\uFE0E</a></p></li>',8);function j(_,R){const a=c("ExternalLinkIcon");return o(),l("div",null,[u,n("p",null,[n("a",k,[r,p(a)]),d]),n("p",null,[n("a",v,[m,p(a)]),b]),w,n("section",y,[n("ol",h,[n("li",f,[n("p",null,[g,n("a",x,[T,p(a)]),E,I])]),S])])])}var F=t(i,[["render",j],["__file","\u7B2C7\u7AE0\u53D6\u6D88\u4E0E\u5173\u95ED.html.vue"]]);export{F as default};
