import{_ as n}from"./plugin-vue_export-helper.21dcd24c.js";import{o as s,c as a,e}from"./app.0d56c066.js";var t="/assets/\u56FE11-1.7149e9e7.png",p="/assets/\u56FE11-2.99302513.png",c="/assets/\u56FE11-3.e31b49f1.png",o="/assets/\u56FE11-4.74084fc6.png",i="/assets/\u56FE11-5.2bfddd42.png",l="/assets/\u56FE11-6.607a8099.png",u="/assets/\u56FE11-7.e5d7067e.png",d="/assets/\u56FE11-8.4ed96e0f.png",r="/assets/\u56FE11-9.0939d170.png",k="/assets/\u56FE11-10.cf700590.png",v="/assets/\u56FE11-11.a998ad4e.png",m="/assets/\u56FE11-12.e8843dec.png",b="/assets/\u886811-1.4c7e4832.png",g="/assets/\u886811-2.6b80c499.png",y="/assets/\u56FE11-13.f6573651.png",h="/assets/\u56FE11-14.0f831dcc.png",w="/assets/\u56FE11-15.e4957296.png",f="/assets/\u56FE11-16.b7b9d34c.png",S="/assets/\u56FE11-17.e24c3bfb.png",x="/assets/\u886811-3-1.af222b0c.png",j="/assets/\u886811-3-2.92afbbe4.png",_="/assets/\u56FE11-18.9e37da6b.png",C="/assets/\u56FE11-19.a21aba83.png",M="/assets/\u56FE11-20.0e4a271e.png",A="/assets/\u56FE11-21.29a949d3.png",q="/assets/\u56FE11-22.453485aa.png",T="/assets/\u56FE11-23.7d2618b5.png";const I={},J=e(`<h1 id="\u7B2C-11-\u7AE0-\u5B57\u8282\u7801\u6267\u884C" tabindex="-1"><a class="header-anchor" href="#\u7B2C-11-\u7AE0-\u5B57\u8282\u7801\u6267\u884C" aria-hidden="true">#</a> \u7B2C 11 \u7AE0 \u5B57\u8282\u7801\u6267\u884C</h1><p>\u5B57\u8282\u7801\u6267\u884C\u662F Java \u865A\u62DF\u673A\u7684\u91CD\u70B9\uFF0C\u5C31\u5982\u540C\u6C47\u7F16\u8BED\u8A00\u5BF9\u4E8E\u8BA1\u7B97\u673A\u4E00\u6837\u91CD\u8981\uFF0C\u5B57\u8282\u7801\u5BF9\u4E8E Java \u865A\u62DF\u673A\u6765\u8BF4\u662F\u6267\u884C\u7684\u6839\u672C\u3002\u5F53 Java \u6E90\u7801\u88AB\u7F16\u8BD1\u6210 Class \u6587\u4EF6\u540E\uFF0C\u865A\u62DF\u673A\u5C31\u4F1A\u5C06 Class \u6587\u4EF6\u5185\u7684\u65B9\u6CD5\u5B57\u8282\u7801\u8F7D\u5165\u7CFB\u7EDF\u5E76\u52A0\u4EE5\u6267\u884C\u3002\u672C\u7AE0\u5C06\u8BE6\u7EC6\u4ECB\u7ECD\u865A\u62DF\u673A\u7684\u6307\u4EE4\u7CFB\u7EDF\u3001\u6267\u884C\u673A\u5236\u53CA\u76F8\u5173\u914D\u7F6E\u53C2\u6570\u3002</p><p>\u672C\u7AE0\u6D89\u53CA\u7684\u4E3B\u8981\u77E5\u8BC6\u70B9\u6709\uFF1A</p><ul><li><p>\u4F7F\u7528 javap \u67E5\u770B Class \u6587\u4EF6\u4FE1\u606F\u3002</p></li><li><p>\u4E86\u89E3\u5B57\u8282\u7801\u6267\u884C\u8FC7\u7A0B\u3002</p></li><li><p>\u719F\u6089\u5E38\u7528\u5B57\u8282\u7801\u3002</p></li><li><p>\u5B66\u4E60 JIT \u76F8\u5173\u53C2\u6570\u914D\u7F6E\u3002</p></li><li><p>\u901A\u8FC7 ASM \u589E\u5F3A\u65B9\u6CD5\u7684\u529F\u80FD\u3002</p></li><li><p>\u4F7F\u7528 Java Agent \u52A8\u6001\u4FEE\u6539\u5B57\u8282\u7801\u3002</p></li></ul><h2 id="_11-1-\u4EE3\u7801\u5982\u4F55\u6267\u884C-\u5B57\u8282\u7801\u6267\u884C\u6848\u4F8B" tabindex="-1"><a class="header-anchor" href="#_11-1-\u4EE3\u7801\u5982\u4F55\u6267\u884C-\u5B57\u8282\u7801\u6267\u884C\u6848\u4F8B" aria-hidden="true">#</a> 11.1 \u4EE3\u7801\u5982\u4F55\u6267\u884C\uFF1A\u5B57\u8282\u7801\u6267\u884C\u6848\u4F8B</h2><p>Java \u5B57\u8282\u7801\u5BF9\u4E8E\u865A\u62DF\u673A\uFF0C\u5C31\u597D\u50CF\u6C47\u7F16\u8BED\u8A00\u5BF9\u4E8E\u8BA1\u7B97\u673A\uFF0C\u5C5E\u4E8E\u57FA\u672C\u6267\u884C\u6307\u4EE4\u3002\u6BCF\u4E00\u4E2A Java \u5B57\u8282\u7801\u6307\u4EE4\u662F\u4E00\u4E2A byte \u6570\u5B57\uFF0C\u5E76\u4E14\u6709\u4E00\u4E2A\u5BF9\u5E94\u7684\u52A9\u8BB0\u7B26\u3002\u76EE\u524D\u5927\u7EA6\u6709 200 \u4F59\u4E2A\u5B57\u8282\u7801\u6307\u4EE4\u3002\u4E0B\u9762\u5217\u4E3E\u4E86\u90E8\u5206\u5B57\u8282\u7801\u53CA\u5176\u5BF9\u5E94\u7684\u52A9\u8BB0\u7B26\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>_nop          = 0,      // 0x00 
_aconst_null  = 1,      // 0x01 
_iconst_0     = 3,      // 0x03 
_iconst_1     = 4,      // 0x04 
_dconst_1     = 15,     // Ox0f 
_bipush       = 16,     // 0x10 
_iload_0      = 26,     // Ox1a 
_iload_1      = 27,     // Ox1b 
_aload_0      = 42,     // 0x2a 
_istore       = 54,     // 0x36 
_POP          = 87,     // 0x57 
_imul         = 104,    // 0x68 
_idiv         = 108,    // 0x6c
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u65B9\u6CD5\u7684 Java \u5B57\u8282\u7801\u6307\u4EE4\u88AB\u7F16\u8BD1\u5230 Java \u65B9\u6CD5\u7684 Code \u5C5E\u6027\u4E2D\uFF0C\u5982\u679C\u60F3\u8981\u67E5\u770B\u6307\u4EE4\u7684\u5177\u4F53\u5185\u5BB9\uFF0C\u53EF\u4EE5\u4F7F\u7528 JDK \u81EA\u5E26\u7684 javap \u5DE5\u5177\u3002javap \u7684\u5E38\u7528\u53C2\u6570\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>\u7528\u6CD5\uFF1Ajavap &lt;options&gt; &lt;classes&gt; 
\u5176\u4E2D\u7684\u9009\u9879\u5305\u62EC\uFF1A

-version      \u7248\u672C\u4FE1\u606F
-v -verbose   \u8F93\u51FA\u9644\u52A0\u4FE1\u606F
-l            \u8F93\u51FA\u884C\u53F7\u548C\u672C\u5730\u53D8\u91CF\u8868
-public       \u4EC5\u663E\u793A\u516C\u5171\u7C7B\u548C\u6210\u5458
-protected    \u663E\u793A\u53D7\u4FDD\u62A4\u7684 / \u516C\u5171\u7C7B\u548C\u6210\u5458
-package      \u663E\u793A\u7A0B\u5E8F\u5305 / \u53D7\u4FDD\u62A4\u7684 / \u516C\u5171\u7C7B\u548C\u6210\u5458\uFF08\u9ED8\u8BA4\uFF09
-p -private   \u663E\u793A\u6240\u6709\u7C7B\u548C\u6210\u5458
-c            \u5BF9\u4EE3\u7801\u8FDB\u884C\u53CD\u6C47\u7F16
-s            \u8F93\u51FA\u5185\u90E8\u7C7B\u578B\u7B7E\u540D
-sysinfo      \u663E\u793A\u6B63\u5728\u5904\u7406\u7684\u7C7B\u7684\u7CFB\u7EDF\u4FE1\u606F\uFF08\u8DEF\u5F84\u3001\u5927\u5C0F\u3001\u65E5\u671F\u3001MD5 \u6563\u5217\uFF09
-constants    \u663E\u793A\u9759\u6001\u6700\u7EC8\u5E38\u91CF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u3010\u793A\u4F8B 11-1\u3011\u4E0B\u9762\u4EE5\u4E00\u6BB5\u7B80\u5355\u7684 Java \u4EE3\u7801\u4E3A\u4F8B\uFF0C\u6F14\u793A javap \u7684\u4F7F\u7528\u65B9\u6CD5\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Calc</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> 
        <span class="token keyword">return</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">/</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7528 javap \u663E\u793A\u8FD9\u6BB5\u4EE3\u7801\u7684\u4FE1\u606F\uFF0C\u547D\u4EE4\u548C\u8FD4\u56DE\u4FE1\u606F\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>javap -v geym\\zbase\\ch11\\calc\\Calc
Compiled from &quot;Calc.java&quot;
public class geym.zbase.ch11.calc.Calc extends java.lang.Object
SourceFile: &quot;Calc.java&quot;
minor version: 0
major version: 51
Constant pool:
const #1 = class         #2;  // geym/zbase/ch11/calc/Calc
const #2 = Asciz         geym/zbase/ch11/calc/Calc;
const #3 = class         #4;  // java/lang/Object
const #4 = Asciz         java/lang/Object;
const #5 = Asciz         &lt;init&gt;;
const #6 = Asciz         ()V;
const #7 = Asciz         Code;
const #8 = Method        #3.#9;  // java/lang/Object.&quot;&lt;init&gt;&quot;:
const #9 = NameAndType   #5:#6;  // &quot;&lt;init&gt;&quot;:()V
const #10 = Asciz        LineNumberTable;
const #11 = Asciz        LocalVariableTable;
const #12 = Asciz        this;
const #13 = Asciz        Lgeym/zbase/ch11/calc/Calc;;
const #14 = Asciz        calc;
const #15 = Asciz        ()I\uFF1B
const #16 = Asciz        a;
const #17 = Asciz        I;
const #18 = Asciz        b;
const #19 = Asciz        c;
const #20 = Asciz        SourceFile;
const #21 = Asciz        Calc.java;
{
public geym.zbase.ch11.calc.Calc();
Code:
Stack=1, Locals=1, Args_size=1
0:   aload_0
1:   invokespecial    #8; // Method java/lang/Object.&quot;&lt;init&gt;&quot;
4:   return
LineNumberTable:
line 3: 0

LocalVariableTable:
Start  Length  Slot  Name  Signature
0      5       0     this   Lgeym/zbase/ch11/calc/Calc;

public int calc();
Code:
Stack=2, Locals=4, Args_size=1
0:   sipush 500
3:   istore_1
4:   sipush 200
7:   istore_2
8:   bipush 50
10:  istore_3
11:  iload_1
12:  iload_2
13:  iadd
14:  iload_3
15:  idiv
16:  ireturn
LineNumberTable:
line 5: 0
line 6: 4
line 7: 8
line 8: 11

LocalVariableTable:
Start  Length  Slot  Name  Signature
0      17	   0     this  Lgeym/zbase/ch11/calc/Calc;
4      13	   1     a     I
8      9	   2     b     I
11     6	   3     c     I
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4ECE\u4E0A\u8FF0\u4EE3\u7801\u53EF\u4EE5\u770B\u51FA\uFF0C\u8FD9\u6BB5\u7B80\u5355\u7684 Java \u7A0B\u5E8F\u88AB\u53CD\u7F16\u8BD1\u540E\u751F\u6210\u4E86\u5927\u91CF\u7684\u4FE1\u606F\u3002</p><p>\u9996\u5148\uFF0C\u663E\u793A\u4E86\u751F\u6210\u8FD9\u4E2A Class \u6587\u4EF6\u7684 Java \u6E90\u6587\u4EF6\u540D\u79F0\u3001\u5C0F\u7248\u672C\u53F7\u548C\u5927\u7248\u672C\u53F7\u3002\u63A5\u7740\uFF0C\u663E\u793A\u4E86\u8FD9\u4E2A\u7C7B\u4E2D\u6240\u6709\u7684\u5E38\u91CF\uFF0C\u8FD9\u91CC\u6709 21 \u9879\u5E38\u91CF\u3002\u6B64\u5916\uFF0C\u8FD8\u663E\u793A\u4E86\u4E24\u4E2A\u65B9\u6CD5\u4FE1\u606F\uFF1A\u7B2C\u4E00\u4E2A\u65B9\u6CD5\u4E3A\u7C7B\u7684\u6784\u9020\u51FD\u6570\uFF0C\u662F\u7F16\u8BD1\u5668\u81EA\u52A8\u63D2\u5165\u7684\uFF1B\u7B2C\u4E8C\u4E2A\u65B9\u6CD5\u4E3A calc() \u65B9\u6CD5\uFF0C\u5728\u65B9\u6CD5\u4F53\u5185\uFF0C\u663E\u793A\u4E86\u6808\u5927\u5C0F\u3001\u5C40\u90E8\u53D8\u91CF\u8868\u5927\u5C0F\u3001\u5B57\u8282\u7801\u6307\u4EE4\u3001\u884C\u53F7\u3001\u5C40\u90E8\u53D8\u91CF\u8868\u7B49\u4FE1\u606F\u3002</p><p>\u8BFB\u8005\u53EF\u4EE5\u91CD\u70B9\u5173\u6CE8\u4E00\u4E0B calc() \u65B9\u6CD5\u7684\u4E3B\u4F53\u5185\u5BB9\uFF0C\u5373\u5B57\u8282\u7801\u90E8\u5206\uFF08\u52A0\u7C97\u4EE3\u7801\uFF09\uFF0C\u4E0B\u9762\u5C06\u4ED4\u7EC6\u89E3\u8BFB\u8FD9\u6BB5\u5B57\u8282\u7801\u7684\u6267\u884C\u8FC7\u7A0B\u3002</p><p>\u5982\u56FE11.1 \u6240\u793A\uFF0C\u5DE6\u4FA7\u7684\u5B57\u8282\u7801\u5217\u8868\u7528\u52A0\u7C97\u5B57\u4F53\u663E\u793A\u4E86\u6B63\u5728\u6267\u884C\u7684\u5B57\u8282\u7801\uFF0C\u53F3\u4FA7\u5206\u522B\u663E\u793A\u4E86\u5F53\u524D\u7684\u5C40\u90E8\u53D8\u91CF\u8868\u548C\u64CD\u4F5C\u6570\u6808\u3002\u5728\u5B57\u8282\u7801\u90E8\u5206\uFF0C\u5DE6\u4FA7\u7684\u6570\u5B57\u5E8F\u53F7\u8868\u793A\u5B57\u8282\u7801\u504F\u79FB\u91CF\uFF0C\u5373\u5F53\u524D\u5B57\u8282\u7801\u6240\u5728\u7684\u4F4D\u7F6E\uFF0C\u8FD9\u770B\u8D77\u6765\u6709\u70B9\u50CF\u884C\u53F7\uFF0C\u4F46\u5B83\u4E0D\u662F\u3002\u5B57\u8282\u7801\u504F\u79FB\u91CF\u603B\u662F\u548C\u524D\u51E0\u4E2A\u5B57\u8282\u7801\u7684\u957F\u5EA6\u6709\u5173\uFF0C\u7B2C\u4E00\u6761\u5B57\u8282\u7801\u4E3A sipush\uFF0C\u81EA\u7136\u5176\u504F\u79FB\u91CF\u4E3A 0\u3002\u800C sipush \u8FD9\u6761\u6307\u4EE4\u672C\u8EAB\u5360\u7528 1 \u5B57\u8282\uFF0C\u4F46\u5B83\u63A5\u6536\u4E00\u4E2A\u53CC\u5B57\u8282\u7684\u53C2\u6570\uFF0C\u6545\u6574\u4E2A sipush \u6307\u4EE4\u5408\u8BA1\u4E3A 3 \u5B57\u8282\u3002\u5176\u540E\u7EED\u6307\u4EE4 istore_1 \u6240\u5728\u4F4D\u7F6E\u5728\u504F\u79FB\u91CF 3 \u5904\uFF0C\u800C istore_1 \u6307\u4EE4\u4E3A 1 \u5B57\u8282\uFF0C\u4E14\u4E0D\u63A5\u6536\u53C2\u6570\uFF0C\u6545\u5408\u8BA1\u4E3A 1 \u5B57\u8282\uFF0C\u52A0\u4E0A\u4E4B\u524D sipush \u7684 3 \u5B57\u8282\uFF0Csipush 200 \u5C31\u5728\u504F\u79FB\u91CF 4 \u7684\u4F4D\u7F6E\uFF0C\u4F9D\u6B64\u7C7B\u63A8\u3002</p><p><img src="`+t+'" alt="\u56FE11-1" loading="lazy"></p><p>\u56FE11.1 \u5B57\u8282\u7801\u6267\u884C\u793A\u610F\u56FE 1</p><p>\u5982\u56FE11.1 \u6240\u793A\uFF0C\u5728\u6267\u884C\u7B2C\u4E00\u6761\u6307\u4EE4\u7684\u65F6\u5019\uFF0C\u5C40\u90E8\u53D8\u91CF\u8868\u7B2C 0 \u9879\u4E3A this \u5F15\u7528\uFF0C\u8868\u793A\u5F53\u524D\u5BF9\u8C61\u3002\u4E3A\u4E86\u80FD\u987A\u5229\u8BBF\u95EE this \u5BF9\u8C61\uFF0CJava \u5BF9\u4E8E\u6240\u6709\u7684\u975E\u9759\u6001\u51FD\u6570\u8C03\u7528\uFF0C\u90FD\u4F1A\u5C06\u5BF9\u8C61\u7684\u5F15\u7528\u653E\u7F6E\u5728\u5C40\u90E8\u53D8\u91CF\u8868\u7684\u7B2C 0 \u4E2A\u69FD\u4F4D\u3002\u6307\u4EE4 sipush \u7684\u4F5C\u7528\u662F\u5C06\u7ED9\u5B9A\u7684\u53C2\u6570\u538B\u5165\u64CD\u4F5C\u6570\u6808\uFF0C\u6267\u884C\u5B8C sipush 500 \u540E\uFF0C\u64CD\u4F5C\u6570\u6808\u4E2D\u542B\u6709\u6570\u5B57 500\u3002\u5728\u865A\u62DF\u673A\u7684\u6307\u4EE4\u96C6\u4E2D\uFF0C\u8FD8\u6709\u4E00\u6761\u6307\u4EE4\u4E3A bipush\uFF0C\u4E5F\u662F\u5B8C\u6210\u76F8\u540C\u7684\u64CD\u4F5C\uFF0C\u4F46\u662F bipush \u4EC5\u63A5\u6536\u4E00\u4E2A\u5B57\u8282\u7684\u53C2\u6570\uFF0C\u56E0\u6B64\u5B83\u53EA\u80FD\u5904\u7406 -128 ~ 127 \u7684\u6570\u5B57\uFF0C\u8FD9\u91CC\u7684 500 \u5DF1\u7ECF\u8D85\u8FC7\u4E86 bipush \u7684\u5904\u7406\u8303\u56F4\uFF0C\u6545\u4F7F\u7528 sipush\uFF0C\u5B83\u53EF\u4EE5\u652F\u6301 -32768 ~ 32767 \u7684\u6570\u5B57\u3002\u865A\u62DF\u673A\u901A\u8FC7\u8FD9\u79CD\u7EC6\u5206\u7684\u6307\u4EE4\u96C6\uFF0C\u53EF\u4EE5\u5C3D\u53EF\u80FD\u51CF\u5C11\u6307\u4EE4\u6240\u5360\u7684\u7A7A\u95F4\uFF0C\u6BD5\u7ADF sipush \u8981\u6BD4 bipush \u591A\u5360\u4E00\u4E2A\u5B57\u8282\u3002</p><p>\u5982\u56FE11.2 \u6240\u793A\uFF0C\u865A\u62DF\u673A\u6B63\u5728\u6267\u884C istore_1 \u547D\u4EE4\uFF0Cstore \u547D\u4EE4\u662F\u4ECE\u64CD\u4F5C\u6570\u6808\u4E2D\u5F39\u51FA\u4E00\u4E2A\u5143\u7D20\uFF0C\u5E76\u5C06\u5176\u5B58\u653E\u5728\u5C40\u90E8\u53D8\u91CF\u8868\u4E2D\u3002\u4E00\u822C\u8BF4\u6765\uFF0C\u7C7B\u4F3C store \u8FD9\u6837\u7684\u547D\u4EE4\u9700\u8981\u5E26\u4E00\u4E2A\u53C2\u6570\uFF0C\u7528\u6765\u6307\u660E\u5C06\u5F39\u51FA\u7684\u5143\u7D20\u653E\u5728\u5C40\u90E8\u53D8\u91CF\u8868\u7684\u7B2C\u51E0\u4E2A\u4F4D\u7F6E\u3002\u4F46\u662F\uFF0C\u4E3A\u4E86\u5C3D\u53EF\u80FD\u538B\u7F29\u6307\u4EE4\u5927\u5C0F\uFF0C\u4F7F\u7528\u4E13\u95E8\u7684 istore_1 \u6307\u4EE4\u8868\u793A\u5C06\u5F39\u51FA\u7684\u5143\u7D20\u653E\u7F6E\u5728\u5C40\u90E8\u53D8\u91CF\u8868\u7684\u7B2C 1 \u4E2A\u4F4D\u7F6E\u3002\u7C7B\u4F3C\u7684\u8FD8\u6709 istore_0\u3001istore_2\u3001istore_3\uFF0C\u5B83\u4EEC\u5206\u522B\u8868\u793A\u4ECE\u64CD\u4F5C\u6570\u6808\u9876\u5F39\u51FA\u4E00\u4E2A\u5143\u7D20\uFF0C\u5B58\u653E\u5728\u5C40\u90E8\u53D8\u91CF\u8868\u7B2C 0\u30012\u30013 \u4E2A\u4F4D\u7F6E\u3002\u5C40\u90E8\u53D8\u91CF\u8868\u7684\u524D\u51E0\u4E2A\u4F4D\u7F6E\u662F\u5E38\u7528\u7684\uFF0C\u56E0\u6B64\u8FD9\u79CD\u505A\u6CD5\u867D\u7136\u589E\u52A0\u4E86\u6307\u4EE4\u6570\u91CF\uFF0C\u4F46\u662F\u53EF\u4EE5\u5927\u5927\u538B\u7F29\u751F\u6210\u7684\u5B57\u8282\u7801\u7684\u4F53\u79EF\u3002\u5982\u679C\u5C40\u90E8\u53D8\u91CF\u8868\u5F88\u5927\uFF0C\u9700\u8981\u5B58\u50A8\u7684\u69FD\u4F4D\u5927\u4E8E 3\uFF0C\u90A3\u4E48\u53EF\u4EE5\u4F7F\u7528 istore \u6307\u4EE4\uFF0C\u5916\u52A0\u4E00\u4E2A\u53C2\u6570\u8868\u793A\u9700\u8981\u5B58\u653E\u7684\u69FD\u4F4D\u3002\u5728\u8FD9\u6761\u6307\u4EE4\u6267\u884C\u5B8C\u6BD5\u540E\uFF0C\u64CD\u4F5C\u6570\u6808\u88AB\u6E05\u7A7A\uFF0C\u5C40\u90E8\u53D8\u91CF\u8868 1 \u7684\u4F4D\u7F6E\u5B58\u5165 500\u3002</p><p><img src="'+p+'" alt="\u56FE11-2" loading="lazy"></p><p>\u56FE11.2 \u5B57\u8282\u7801\u6267\u884C\u793A\u610F\u56FE 2</p><p>\u63A5\u7740\uFF0C\u6267\u884C sipush 200 \u6307\u4EE4\uFF0C\u5C06 200 \u538B\u5165\u64CD\u4F5C\u6570\u6808\uFF0C\u5982\u56FE11.3 \u6240\u793A\u3002</p><p><img src="'+c+'" alt="\u56FE11-3" loading="lazy"></p><p>\u56FE11.3 \u5B57\u8282\u7801\u6267\u884C\u793A\u610F\u56FE 3</p><p>\u6307\u4EE4 istore2\uFF0C\u5C06 200 \u5B58\u5165\u5C40\u90E8\u53D8\u91CF\u7684\u7B2C 2 \u4E2A\u4F4D\u7F6E\uFF0C\u5E76\u6E05\u7A7A\u64CD\u4F5C\u6570\u6808\uFF0C\u5982\u56FE11.4 \u6240\u793A\u3002</p><p><img src="'+o+'" alt="\u56FE11-4" loading="lazy"></p><p>\u56FE11.4 \u5B57\u8282\u7801\u6267\u884C\u793A\u610F\u56FE 4</p><p>\u6307\u4EE4 bipush 50 \u5C06 50 \u538B\u5165\u64CD\u4F5C\u6570\u6808\uFF0C\u5982\u56FE11.5 \u6240\u793A\u3002</p><p><img src="'+i+'" alt="\u56FE11-5" loading="lazy"></p><p>\u56FE11.5 \u5B57\u8282\u7801\u6267\u884C\u793A\u610F\u56FE 5</p><p>\u6307\u4EE4 istore_3 \u5C06 50 \u5F39\u51FA\uFF0C\u5E76\u5B58\u653E\u5728\u5C40\u90E8\u53D8\u91CF\u8868\u7684\u7B2C 3 \u4E2A\u4F4D\u7F6E\uFF0C\u5982\u56FE11.6 \u6240\u793A\u3002</p><p><img src="'+l+'" alt="\u56FE11-6" loading="lazy"></p><p>\u56FE11.6 \u5B57\u8282\u7801\u6267\u884C\u793A\u610F\u56FE 6</p><p>\u6307\u4EE4 iload_1 \u5C06\u5C40\u90E8\u53D8\u91CF\u8868\u7B2C 1 \u4E2A\u4F4D\u7F6E\u7684\u503C\u538B\u5165\u64CD\u4F5C\u6570\u6808\u3002\u548C store \u6307\u4EE4\u7C7B\u4F3C\uFF0C\u865A\u62DF\u673A\u4E5F\u63D0\u4F9B\u4E86\u4E00\u7CFB\u5217\u6307\u4EE4\uFF0C\u5982 iload_0\u3001iload_2\u3001iload_3 \u7B49\uFF0C\u5206\u522B\u8868\u793A\u5C06\u5C40\u90E8\u53D8\u91CF\u8868\u7684\u7B2C 0\u30012\u30013 \u4E2A\u4F4D\u7F6E\u7684\u503C\u538B\u5165\u64CD\u4F5C\u6570\u6808\u3002\u5982\u679C\u9700\u8981\u64CD\u4F5C\u6BD4\u8F83\u5927\u7684\u5C40\u90E8\u53D8\u91CF\u8868\uFF0C\u5219\u53EF\u4EE5\u4F7F\u7528 iload\uFF0C\u5916\u52A0\u4E00\u4E2A\u53C2\u6570\u6765\u6307\u660E\u5C40\u90E8\u53D8\u91CF\u8868\u7684\u4F4D\u7F6E\u3002\u5728\u6267\u884C\u6307\u4EE4 iload_1 \u4E4B\u540E\uFF0C\u64CD\u4F5C\u6570\u6808\u4E2D\u6808\u9876\u5143\u7D20\u4E3A 500\uFF0C\u5982\u56FE11.7 \u6240\u793A\u3002</p><p><img src="'+u+'" alt="\u56FE11-7" loading="lazy"></p><p>\u56FE11.7 \u5B57\u8282\u7801\u6267\u884C\u793A\u610F\u56FE 7</p><p>\u6307\u4EE4 iload_2 \u5C06\u7B2C 2 \u4E2A\u5C40\u90E8\u53D8\u91CF\u538B\u5165\u64CD\u4F5C\u6570\u6808\uFF0C\u5982\u56FE11.8 \u6240\u793A\u3002</p><p><img src="'+d+'" alt="\u56FE11-8" loading="lazy"></p><p>\u56FE11.8 \u5B57\u8282\u7801\u6267\u884C\u793A\u610F\u56FE 8</p><p>\u6307\u4EE4 iadd \u8868\u793A\u52A0\u6CD5\u64CD\u4F5C\uFF0C\u5B83\u4ECE\u64CD\u4F5C\u6570\u6808\u4E2D\u5F39\u51FA\u4E24\u4E2A\u5143\u7D20\u505A\u52A0\u6CD5\uFF0C\u5E76\u5C06\u7ED3\u679C\u518D\u538B\u56DE\u64CD\u4F5C\u6570\u6808\uFF0C\u5982\u56FE11.9 \u6240\u793A\u3002</p><p><img src="'+r+'" alt="\u56FE11-9" loading="lazy"></p><p>\u56FE11.9 \u5B57\u8282\u7801\u6267\u884C\u793A\u610F\u56FE 9</p><p>\u6307\u4EE4 iload_3 \u5C06\u5C40\u90E8\u53D8\u91CF\u8868\u7B2C 3 \u4E2A\u4F4D\u7F6E\u7684 50 \u538B\u5165\u64CD\u4F5C\u6570\u6808\uFF0C\u5982\u56FE11.10 \u6240\u793A\u3002</p><p><img src="'+k+'" alt="\u56FE11-10" loading="lazy"></p><p>\u56FE11.10 \u5B57\u8282\u7801\u6267\u884C\u793A\u610F\u56FE 10</p><p>\u6307\u4EE4 idiv \u8868\u793A\u6574\u6570\u9664\u6CD5\uFF0C\u5B83\u4ECE\u64CD\u4F5C\u6570\u6808\u4E2D\u5F39\u51FA\u4E24\u4E2A\u5143\u7D20\uFF0C\u76F8\u9664\u540E\u5C06\u7ED3\u679C\u538B\u5165\u64CD\u4F5C\u6570\u6808\uFF0C\u5982\u56FE11.11 \u6240\u793A\u3002\u6BD4 iadd \u7565\u663E\u590D\u6742\u7684\u662F\uFF0C\u9664\u6CD5\u662F\u9700\u8981\u8003\u8651\u987A\u5E8F\u7684\uFF0Cidiv \u7684\u505A\u6CD5\u662F\u7528\u6808\u9876\u7B2C 2 \u987A\u4F4D\u7684\u5143\u7D20\u9664\u4EE5\u6808\u9876\u5143\u7D20\uFF0C\u6B64\u5904\u4E3A 700 / 50 = 14\u3002</p><p><img src="'+v+'" alt="\u56FE11-11" loading="lazy"></p><p>\u56FE11.11 \u5B57\u8282\u7801\u6267\u884C\u793A\u610F\u56FE 11</p><p>\u7136\u540E\uFF0C\u901A\u8FC7 ireturn \u6307\u4EE4\uFF0C\u5C06\u5F53\u524D\u51FD\u6570\u64CD\u4F5C\u6570\u6808\u7684\u9876\u5C42\u5143\u7D20\u5F39\u51FA\uFF0C\u5E76\u5C06\u8FD9\u4E2A\u5143\u7D20\u538B\u5165\u8C03\u7528\u8005\u51FD\u6570\u7684\u64CD\u4F5C\u6570\u6808\u4E2D\uFF08\u56E0\u4E3A\u8C03\u7528\u8005\u975E\u5E38\u5173\u5FC3\u51FD\u6570\u7684\u8FD4\u56DE\u503C\uFF09\uFF0C\u5982\u56FE11.12 \u6240\u793A\uFF0C\u6240\u6709\u5728\u5F53\u524D\u51FD\u6570\u64CD\u4F5C\u6570\u6808\u4E2D\u7684\u5176\u4ED6\u5143\u7D20\u90FD\u4F1A\u88AB\u4E22\u5F03\u3002\u5982\u679C\u5F53\u524D\u8FD4\u56DE\u7684\u662F synchroinzed \u65B9\u6CD5\uFF0C\u90A3\u4E48\u8FD8\u4F1A\u6267\u884C\u4E00\u4E2A\u9690\u542B\u7684 monitorexit \u6307\u4EE4\uFF0C\u9000\u51FA\u4E34\u754C\u533A\u3002\u6700\u540E\uFF0C\u4F1A\u4E22\u5F03\u5F53\u524D\u65B9\u6CD5\u7684\u6574\u4E2A\u5E27\uFF0C\u6062\u590D\u8C03\u7528\u8005\u7684\u5E27\uFF0C\u5E76\u5C06\u63A7\u5236\u6743\u8F6C\u4EA4\u7ED9\u8C03\u7528\u8005\u3002</p><p><img src="'+m+`" alt="\u56FE11-12" loading="lazy"></p><p>\u56FE11.12 \u5B57\u8282\u7801\u6267\u884C\u793A\u610F\u56FE 12</p><h2 id="_11-2-\u6267\u884C\u7684\u57FA\u7840-java-\u865A\u62DF\u673A\u5E38\u7528\u6307\u4EE4\u4ECB\u7ECD" tabindex="-1"><a class="header-anchor" href="#_11-2-\u6267\u884C\u7684\u57FA\u7840-java-\u865A\u62DF\u673A\u5E38\u7528\u6307\u4EE4\u4ECB\u7ECD" aria-hidden="true">#</a> 11.2 \u6267\u884C\u7684\u57FA\u7840\uFF1AJava \u865A\u62DF\u673A\u5E38\u7528\u6307\u4EE4\u4ECB\u7ECD</h2><p>Java \u865A\u62DF\u673A\u7684\u5B57\u8282\u7801\u6307\u4EE4\u591A\u8FBE 200 \u4F59\u4E2A\uFF0C\u5B8C\u5168\u4ECB\u7ECD\u548C\u5B66\u4E60\u8FD9\u4E9B\u6307\u4EE4\u9700\u8981\u82B1\u8D39\u5927\u91CF\u65F6\u95F4\u3002\u4E3A\u4E86\u8BA9\u8BFB\u8005\u80FD\u591F\u66F4\u5FEB\u5730\u719F\u6089\u548C\u4E86\u89E3\u8FD9\u4E9B\u57FA\u672C\u6307\u4EE4\uFF0C\u672C\u8282\u5BF9\u5E38\u7528\u7684\u6307\u4EE4\u505A\u4E86\u5F52\u7C7B\u6574\u7406\uFF0C\u65B9\u4FBF\u8BFB\u8005\u67E5\u9605\u3002\u719F\u6089\u865A\u62DF\u673A\u7684\u6307\u4EE4\u5BF9\u4E8E\u52A8\u6001\u5B57\u8282\u7801\u751F\u6210\u3001\u53CD\u7F16\u8BD1 Class \u6587\u4EF6\u3001Class \u6587\u4EF6\u4FEE\u8865\u90FD\u6709\u975E\u5E38\u91CD\u8981\u7684\u4EF7\u503C\u3002</p><h3 id="_11-2-1-\u5E38\u91CF\u5165\u6808\u6307\u4EE4" tabindex="-1"><a class="header-anchor" href="#_11-2-1-\u5E38\u91CF\u5165\u6808\u6307\u4EE4" aria-hidden="true">#</a> 11.2.1 \u5E38\u91CF\u5165\u6808\u6307\u4EE4</h3><p>\u5E38\u91CF\u5165\u6808\u6307\u4EE4\u7684\u529F\u80FD\u662F\u5C06\u5E38\u6570\u538B\u5165\u64CD\u4F5C\u6570\u6808\uFF0C\u6839\u636E\u6570\u636E\u7C7B\u578B\u548C\u5165\u6808\u5185\u5BB9\u7684\u4E0D\u540C\uFF0C\u53EF\u4EE5\u5206\u4E3A const \u7CFB\u5217\u3001push \u7CFB\u5217\u548C ldc \u6307\u4EE4\u3002</p><p>const \u7CFB\u5217\u6307\u4EE4\u7528\u4E8E\u7279\u5B9A\u7684\u5E38\u91CF\u5165\u6808\uFF0C\u5165\u6808\u7684\u5E38\u91CF\u9690\u542B\u5728\u6307\u4EE4\u672C\u8EAB\u91CC\u3002\u6BD4\u5982\uFF0Caconst_null \u5C06 null \u538B\u5165\u64CD\u4F5C\u6570\u6808\uFF1Biconst_m1\u5C06 -1 \u538B\u5165\u64CD\u4F5C\u6570\u6808\uFF1Biconst_x\uFF08x \u4E3A 0 \u5230 5\uFF09\u5C06 x \u538B\u5165\u6808\uFF1Blconst_0\u3001lconst_1 \u5206\u522B\u5C06\u957F\u6574\u6570 0 \u548C 1 \u538B\u5165\u6808\uFF1Bfconst_0\u3001fconst_1\u3001fconst_2 \u5206\u522B\u5C06\u6D6E\u70B9\u6570 0\u30011\u30012 \u538B\u5165\u6808\uFF1Bdconst_0 \u548C dconst_1 \u5206\u522B\u5C06 double \u578B 0 \u548C 1 \u538B\u5165\u6808\u3002\u4ECE\u6307\u4EE4\u7684\u547D\u540D\u4E0A\u4E0D\u96BE\u627E\u51FA\u89C4\u5F8B\uFF0C\u6307\u4EE4\u52A9\u8BB0\u7B26\u7684\u7B2C\u4E00\u4E2A\u5B57\u7B26\u603B\u662F\u559C\u6B22\u8868\u793A\u6570\u636E\u7C7B\u578B\uFF0Ci \u8868\u793A\u6574\u6570\uFF0Cl \u8868\u793A\u957F\u6574\u6570\uFF0Cf \u8868\u793A\u6D6E\u70B9\u6570\uFF0Cd \u8868\u793A\u53CC\u7CBE\u5EA6\u6D6E\u70B9\u6570\uFF0C\u4E60\u60EF\u4E0A\u7528 a \u8868\u793A\u5BF9\u8C61\u5F15\u7528\u3002\u5982\u679C\u6307\u4EE4\u9690\u542B\u64CD\u4F5C\u7684\u53C2\u6570\uFF0C\u4F1A\u4EE5\u4E0B\u753B\u7EBF\u5F62\u5F0F\u7ED9\u51FA\u3002</p><p>push \u7CFB\u5217\u6307\u4EE4\u4E3B\u8981\u5305\u62EC bipush \u548C sipush\u3002\u5B83\u4EEC\u7684\u533A\u522B\u5728\u4E8E\u63A5\u6536\u6570\u636E\u7C7B\u578B\u4E0D\u540C\uFF0Cbipush \u63A5\u6536 8 \u4F4D\u6574\u6570\uFF0Csipush \u63A5\u6536 16 \u4F4D\u6574\u6570\uFF0C\u5B83\u4EEC\u90FD\u5C06\u53C2\u6570\u538B\u5165\u6808\u3002</p><p>\u5982\u679C\u4EE5\u4E0A\u6307\u4EE4\u90FD\u4E0D\u80FD\u6EE1\u8DB3\u9700\u6C42\uFF0C\u90A3\u4E48\u53EF\u4EE5\u4F7F\u7528\u4E07\u80FD\u7684 ldc \u6307\u4EE4\uFF0C\u5B83\u53EF\u4EE5\u63A5\u6536\u4E00\u4E2A 8 \u4F4D\u7684\u53C2\u6570\uFF0C\u8BE5\u53C2\u6570\u6307\u5411\u5E38\u91CF\u6C60\u4E2D\u7684 int\u3001float \u6216\u8005 String \u7C7B\u578B\u7684\u7D22\u5F15\uFF0C\u5C06\u6307\u5B9A\u7684\u5185\u5BB9\u538B\u5165\u5806\u6808\u3002\u7C7B\u4F3C\u7684\u8FD8\u6709 ldc_w\uFF0C\u5B83\u63A5\u6536\u4E24\u4E2A 8 \u4F4D\u53C2\u6570\uFF0C\u80FD\u652F\u6301\u7684\u7D22\u5F15\u8303\u56F4\u5927\u4E8E ldc\u3002\u5982\u679C\u8981\u538B\u5165\u7684\u5143\u7D20\u662F long \u6216\u8005 double \u7C7B\u578B\u7684\uFF0C\u5219\u4F7F\u7528 ldc2_w \u6307\u4EE4\uFF0C\u4F7F\u7528\u65B9\u5F0F\u90FD\u662F\u7C7B\u4F3C\u7684\u3002</p><p>\u4EE5\u4E0B\u4EE3\u7801\u4F7F\u7528\u4E86\u5E38\u91CF 100000.0d\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">100000.0d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5B83\u4EA7\u751F\u7684\u6307\u4EE4\u4E2D\u5C31\u5305\u542B\u4E86 ldc2_w\uFF0C\u5982\u4E0B\u6240\u793A\uFF0C\u7B2C 2 \u884C\u4E3A\u5E38\u91CF\u6C60\u7B2C 27 \u9879\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ldc2_w	#27
#27 = Double  100000.0d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-2-2-\u5C40\u90E8\u53D8\u91CF\u538B\u6808\u6307\u4EE4" tabindex="-1"><a class="header-anchor" href="#_11-2-2-\u5C40\u90E8\u53D8\u91CF\u538B\u6808\u6307\u4EE4" aria-hidden="true">#</a> 11.2.2 \u5C40\u90E8\u53D8\u91CF\u538B\u6808\u6307\u4EE4</h3><p>\u5C40\u90E8\u53D8\u91CF\u538B\u6808\u6307\u4EE4\u5C06\u7ED9\u5B9A\u7684\u5C40\u90E8\u53D8\u91CF\u8868\u4E2D\u7684\u6570\u636E\u538B\u5165\u64CD\u4F5C\u6570\u6808\u3002\u8FD9\u7C7B\u6307\u4EE4\u5927\u4F53\u53EF\u4EE5\u5206\u4E3A xload\uFF08x \u4E3A i\u3001l\u3001f\u3001d\u3001a\uFF09\u3001xload_n\uFF08x \u4E3A i\u3001l\u3001f\u3001d\u3001a\uFF0Cn \u4E3A 0 \u5230 3\uFF09\u3001xaload\uFF08x \u4E3A i\u3001l\u3001f\u3001d\u3001a\u3001b\u3001c\u3001s\uFF09\u3002\u5728\u8FD9\u91CC x \u8868\u793A\u6570\u636E\u7C7B\u578B\uFF0C\u5982\u886811.1 \u6240\u793A\u3002</p><p>\u886811.1 x \u6240\u8868\u793A\u7684\u6570\u636E\u7C7B\u578B</p><p><img src="`+b+`" alt="\u886811-1" loading="lazy"></p><p>\u6307\u4EE4 xload_n \u987C\u8868\u793A\u5C06\u7B2C n \u4E2A\u5C40\u90E8\u53D8\u91CF\u538B\u5165\u64CD\u4F5C\u6570\u6808\uFF0C\u6BD4\u5982 iload_1\u3001fload_0\u3001aload_0 \u7B49\u6307\u4EE4\u3002\u5176\u4E2D aload_n \u8868\u793A\u5C06\u4E00\u4E2A\u5BF9\u8C61\u5F15\u7528\u538B\u5165\u6808\u3002</p><p>\u6307\u4EE4 xload \u901A\u8FC7\u6307\u5B9A\u53C2\u6570\u7684\u5F62\u5F0F\uFF0C\u628A\u5C40\u90E8\u53D8\u91CF\u538B\u5165\u64CD\u4F5C\u6570\u6808\uFF0C\u5F53\u4F7F\u7528\u8FD9\u4E2A\u6307\u4EE4\u65F6\uFF0C\u8868\u793A\u5C40\u90E8\u53D8\u91CF\u7684\u6570\u91CF\u53EF\u80FD\u8D85\u8FC7\u4E86 4 \u4E2A\uFF0C\u6BD4\u5982\u6307\u4EE4 iload\u3001fload \u7B49\u3002</p><p>\u6307\u4EE4 xaload \u8868\u793A\u5C06\u6570\u7EC4\u7684\u5143\u7D20\u538B\u5165\u6808\uFF0C\u6BD4\u5982 saload\u3001caload \u5206\u522B\u8868\u793A\u538B\u5165 short \u6570\u7EC4\u548C char \u6570\u7EC4\u3002\u6307\u4EE4 xaload \u5728\u6267\u884C\u65F6\uFF0C\u8981\u6C42\u64CD\u4F5C\u6570\u4E2D\u6808\u9876\u5143\u7D20\u4E3A\u6570\u7EC4\u7D22\u5F15 i\uFF0C\u6808\u9876\u987A\u4F4D\u7B2C 2 \u4E2A\u5143\u7D20\u4E3A\u6570\u7EC4\u5F15\u7528 a\uFF0C\u8BE5\u6307\u4EE4\u4F1A\u5F39\u51FA\u6808\u9876\u8FD9\u4E24\u4E2A\u5143\u7D20\uFF0C\u5E76\u5C06 a[i] \u91CD\u65B0\u538B\u5165\u6808\u3002</p><p>\u3010\u793A\u4F8B 11-2\u3011\u4EE5\u4E0B\u9762\u7684\u4EE3\u7801\u4E3A\u4F8B\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print3</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cs<span class="token punctuation">,</span><span class="token keyword">short</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>cs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u751F\u6210\u7684\u90E8\u5206\u5B57\u8282\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: getstatic  #21
3: aload_2
4: iconst_0
5: saload
6: invokevirtual  #43
9: getstatic  #21
12: aload_1
13: iconst_0
14: caload
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6CE8\u610F\u52A0\u7C97\u90E8\u5206\uFF0C\u7B26\u5408\u524D\u6587\u7684\u63CF\u8FF0\uFF0C\u5728 saload \u6267\u884C\u524D\uFF0C\u5148\u5C06\u6570\u7EC4\u5F15\u7528\u538B\u5165\u6808\uFF08aload_2\uFF09\uFF0C\u518D\u5C06\u7D22\u5F15\u538B\u5165\u6808\uFF08iconst_0\uFF09\uFF0C\u7D22\u5F15\u4E3A 0\u3002\u540C\u7406\uFF0C\u5728 caload \u6267\u884C\u524D\uFF0C\u5148\u5C06 char[] \u6570\u7EC4\u538B\u5165\u6808\uFF08aload_1\uFF09\uFF0C\u7136\u540E\u5C06\u6570\u7EC4\u7D22\u5F15 0 \u538B\u5165\u6808\uFF08iconst_0\uFF09\uFF0C\u6700\u540E\u8C03\u7528 caload \u5C06\u7B2C 0 \u4F4D\u7684\u6570\u636E\u538B\u5165\u64CD\u4F5C\u6570\u6808\u9876\u90E8\u3002</p><h3 id="_11-2-3-\u51FA\u6808\u88C5\u5165\u5C40\u90E8\u53D8\u91CF\u8868\u6307\u4EE4" tabindex="-1"><a class="header-anchor" href="#_11-2-3-\u51FA\u6808\u88C5\u5165\u5C40\u90E8\u53D8\u91CF\u8868\u6307\u4EE4" aria-hidden="true">#</a> 11.2.3 \u51FA\u6808\u88C5\u5165\u5C40\u90E8\u53D8\u91CF\u8868\u6307\u4EE4</h3><p>\u51FA\u6808\u88C5\u5165\u5C40\u90E8\u53D8\u91CF\u8868\u6307\u4EE4\u7528\u4E8E\u5C06\u64CD\u4F5C\u6570\u6808\u4E2D\u6808\u9876\u5143\u7D20\u5F39\u51FA\u540E\uFF0C\u88C5\u5165\u5C40\u90E8\u53D8\u91CF\u8868\u7684\u6307\u5B9A\u4F4D\u7F6E\uFF0C\u7528\u4E8E\u7ED9\u5C40\u90E8\u53D8\u91CF\u8D4B\u503C\u3002\u8FD9\u7C7B\u6307\u4EE4\u4E3B\u8981\u4EE5 store \u7684\u5F62\u5F0F\u5B58\u5728\uFF0C\u6BD4\u5982 xstore\uFF08x \u4E3A i\u3001I\u3001f\u3001d\u3001a\uFF09\u3001xstore_n\uFF08x \u4E3A i\u3001l\u3001f\u3001d\u3001a\uFF0Cn \u4E3A 0 \u5230 3\uFF09\u548C xastore\uFF08x \u4E3A i\u3001l\u3001f\u3001d\u3001a\u3001b\u3001c\u3001s\uFF09\u3002\u5176\u4E2D x \u7684\u53D6\u503C\u542B\u4E49\u548C load \u7C7B\u547D\u4EE4\u662F\u4E00\u6837\u7684\uFF0C\u5728\u6B64\u4E0D\u518D\u8D58\u8FF0\u3002</p><p>\u6307\u4EE4 istore_1 \u5C06\u4ECE\u64CD\u4F5C\u6570\u6808\u4E2D\u5F39\u51FA\u4E00\u4E2A\u6574\u6570\uFF0C\u5E76\u628A\u5B83\u8D4B\u503C\u7ED9\u5C40\u90E8\u53D8\u91CF 1\u3002\u7531\u4E8E\u6307\u4EE4 xstore \u6CA1\u6709\u9690\u542B\u53C2\u6570\u4FE1\u606F\uFF0C\u9700\u8981\u63D0\u4F9B\u4E00\u4E2A byte \u7C7B\u578B\u7684\u53C2\u6570\u7C7B\u6307\u5B9A\u76EE\u6807\u5C40\u90E8\u53D8\u91CF\u8868\u7684\u4F4D\u7F6E\u3002xastore \u5219\u4E13\u95E8\u9488\u5BF9\u6570\u7EC4\u64CD\u4F5C\uFF0C\u4EE5 iastore \u4E3A\u4F8B\uFF0C\u5B83\u7528\u4E8E\u7ED9\u4E00\u4E2A int \u6570\u7EC4\u7684\u7ED9\u5B9A\u7D22\u5F15\u8D4B\u503C\u3002\u5728 iastore \u6267\u884C\u524D\uFF0C\u64CD\u4F5C\u6570\u6808\u9876\u9700\u8981\u51C6\u5907 3 \u4E2A\u5143\u7D20\uFF1A\u503C\u3001\u7D22\u5F15\u3001\u6570\u7EC4\u5F15\u7528\uFF0Ciastore \u4F1A\u5F39\u51FA\u8FD9 3 \u4E2A\u503C\uFF0C\u5E76\u5C06\u503C\u8D4B\u7ED9\u6570\u7EC4\u4E2D\u6307\u5B9A\u7D22\u5F15\u7684\u4F4D\u7F6E\u3002</p><p>\u3010\u793A\u4F8B 11-3\u3011\u4EE5\u4E0B\u9762\u8FD9\u6BB5\u7B80\u5355\u7684\u4EE3\u7801\u4E3A\u4F8B\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print4</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cs<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> x<span class="token punctuation">;</span>
    x <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>
    s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">77</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5B83\u751F\u6210\u7684\u5B57\u8282\u7801\u4E2D\u5305\u542B istore \u548C iastore \u6307\u4EE4\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: bipush 99
2: istore 6
4: aload_2
5: iconst_0
6: bipush 77
8: iastore
9: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D\uFF0C\u7B2C 0 \u884C\u5B57\u8282\u7801\uFF08\u5B9E\u9645\u4E0A\u662F\u5B57\u8282\u7801\u504F\u79FB\u91CF\uFF0C\u4E3A\u8868\u8FF0\u7B80\u5355\u8D77\u89C1\uFF0C\u4F7F\u7528\u884C\u4E3A\u5355\u4F4D\uFF0C\u4E0B\u540C\uFF09\uFF0C\u538B\u5165\u5E38\u91CF 99\uFF0C\u7B2C 2 \u884C istore \u5C06 99 \u5F39\u51FA\uFF0C\u5E76\u8D4B\u7ED9\u5C40\u90E8\u53D8\u91CF\u8868\u4E2D\u7B2C 6 \u4E2A\u4F4D\u7F6E\u7684\u53D8\u91CF\uFF0C\u8BE5\u53D8\u91CF\u6B63\u597D\u662F x\u3002\u63A5\u7740\u5728\u7B2C 4\u30015\u30016 \u884C\u5206\u522B\u538B\u5165 iastore \u6240\u9700\u7684 3 \u4E2A\u53C2\u6570\uFF0C\u6700\u540E\u8C03\u7528 iastore \u5C06 77 \u8D4B\u503C\u7ED9\u5C40\u90E8\u53D8\u91CF\u8868\u7B2C 2 \u4E2A\u4F4D\u7F6E\u7684\u6570\u7EC4\uFF08int[] s\uFF09\u7684\u7B2C 0 \u4E2A\u7D22\u5F15\u4F4D\u7F6E\uFF08s[0]\uFF09\u3002</p><h3 id="_11-2-4-\u901A\u7528\u578B\u64CD\u4F5C" tabindex="-1"><a class="header-anchor" href="#_11-2-4-\u901A\u7528\u578B\u64CD\u4F5C" aria-hidden="true">#</a> 11.2.4 \u901A\u7528\u578B\u64CD\u4F5C</h3><p>\u4ECE\u524D\u9762\u7684\u51E0\u7C7B\u6307\u4EE4\u4E2D\u53EF\u4EE5\u770B\u5230\uFF0C\u5927\u90E8\u5206\u6570\u636E\u64CD\u4F5C\u6307\u4EE4\u662F\u548C\u6570\u636E\u7C7B\u578B\u76F8\u5173\u7684\u3002Java \u865A\u62DF\u673A\u4E3A\u4E0D\u540C\u7684\u6570\u636E\u7C7B\u578B\u90FD\u91CF\u8EAB\u5B9A\u505A\u4E86\u4E00\u7CFB\u5217\u6307\u4EE4\u3002\u4F46\u662F\u65E0\u7C7B\u578B\u7684\u6307\u4EE4\u8FD8\u662F\u5FC5\u8981\u7684\uFF0C\u6BD4\u5982\uFF0C\u5C31\u6808\u64CD\u4F5C\u800C\u8A00\uFF0C\u4E0D\u662F\u5728\u6240\u6709\u65F6\u523B\u5BF9\u6808\u7684\u538B\u5165\u6216\u8005\u5F39\u51FA\u90FD\u5FC5\u987B\u660E\u786E\u6570\u636E\u7C7B\u578B\u3002\u901A\u7528\u578B\u64CD\u4F5C\u5C31\u63D0\u4F9B\u4E86\u8FD9\u79CD\u65E0\u987B\u6307\u660E\u6570\u636E\u7C7B\u578B\u7684\u64CD\u4F5C\u3002</p><p>\u6307\u4EE4 nop \u662F\u4E00\u4E2A\u975E\u5E38\u7279\u6B8A\u7684\u6307\u4EE4\uFF0C\u5B83\u7684\u5B57\u8282\u7801\u4E3A 0x00\u3002\u548C\u6C47\u7F16\u8BED\u8A00\u4E2D\u7684 nop \u4E00\u6837\uFF0C\u5B83\u8868\u793A\u4EC0\u4E48\u90FD\u4E0D\u505A\u3002\u8FD9\u6761\u6307\u4EE4\u4E00\u822C\u53EF\u7528\u4E8E\u8C03\u8BD5\u3001\u5360\u4F4D\u7B49\u3002</p><p>\u53E6\u5916\u4E24\u4E2A\u6BD4\u8F83\u91CD\u8981\u7684\u6307\u4EE4\u662F dup \u548C pop\u3002\u6307\u4EE4 dup \u610F\u4E3A duplicate\uFF08\u590D\u5236\uFF09\uFF0C\u5B83\u4F1A\u5C06\u6808\u9876\u5143\u7D20\u590D\u5236\u4E00\u4EFD\u5E76\u518D\u6B21\u538B\u5165\u6808\u9876\uFF0C\u8FD9\u6837\u6808\u9876\u5C31\u6709\u4E24\u4EFD\u4E00\u6A21\u4E00\u6837\u7684\u5143\u7D20\u4E86\u3002\u6307\u4EE4 pop \u5219\u628A\u4E00\u4E2A\u5143\u7D20\u4ECE\u6808\u9876\u5F39\u51FA\uFF0C\u5E76\u4E14\u76F4\u63A5\u5E9F\u5F03\u3002</p><p>\u3010\u793A\u4F8B 11-4\u3011\u4E0B\u9762\u8FD9\u6BB5\u7B80\u5355\u7684\u4EE3\u7801\u662F\u8FD9\u4E24\u4E2A\u6307\u4EE4\u7684\u4F7F\u7528\u6848\u4F8B\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print5</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    obj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7F16\u8BD1\u6210\u5B57\u8282\u7801\u540E\uFF0C\u5176\u5185\u5BB9\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: new    #3  // class java/lang/Object
3: dup
4: invokespecial    #16  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V
7: astore_2
8: aload_2
9: invokevirtual    #58  // Method java/lang/Object.toString:()Ljava/lang/String;
12: pop
13: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E3A\u4E86\u751F\u6210 Object \u5BF9\u8C61\uFF0C\u4F7F\u7528\u4E86\u5BF9\u8C61\u521B\u5EFA\u6307\u4EE4 new\u3002\u521B\u5EFA\u5B8C\u6210\u540E\uFF0C\u6307\u4EE4 new \u4F1A\u628A\u5BF9\u8C61\u5F15\u7528\u653E\u7F6E\u5728\u6808\u9876\uFF0C\u6B64\u65F6\u6808\u9876\u53EA\u6709\u4E00\u4EFD\u5BF9\u8C61\u5F15\u7528\u3002\u4F46\u662F\uFF0C\u5728\u6307\u4EE4 new \u4E4B\u540E\uFF0C\u5BF9\u8BE5 obj \u5BF9\u8C61\u8FDE\u7EED\u8FDB\u884C\u4E24\u6B21\u64CD\u4F5C\uFF1A\u4E00\u6B21\u662F\u901A\u8FC7 invokespecial \u6307\u4EE4\u8C03\u7528\u5BF9\u8C61\u7684\u6784\u9020\u51FD\u6570\uFF0C\u53E6\u4E00\u6B21\u662F\u901A\u8FC7 astore_2 \u6307\u4EE4\u5C06\u5BF9\u8C61\u8D4B\u503C\u7ED9 obj\u3002\u8FD9\u4E24\u4E2A\u64CD\u4F5C\u90FD\u4F1A\u5C06\u6808\u9876\u5143\u7D20\u5F39\u51FA\uFF0C\u4E3A\u4E86\u8FDE\u7EED\u4E24\u6B21\u4F7F\u7528\u540C\u6837\u7684\u6808\u9876\u5143\u7D20\uFF0C\u8FD9\u91CC\u4F7F\u7528\u6307\u4EE4 dup \u590D\u5236\u4E86\u4E00\u4EFD\u5BF9\u8C61\u5F15\u7528\uFF0C\u4F9B\u540E\u9762\u7684\u6307\u4EE4\u4F7F\u7528\u3002\u5728 obj.toString() \u65B9\u6CD5\u6267\u884C\u5B8C\u6BD5\u540E\uFF0C\u51FD\u6570\u7684\u8FD4\u56DE\u503C\u4F1A\u51FA\u73B0\u5728\u6808\u9876\uFF0C\u4F46\u662F\u7531\u4E8E\u6CA1\u6709\u4EBA\u4F7F\u7528\uFF0C\u6240\u4EE5\u7B80\u5355\u5730\u4F7F\u7528 pop \u6307\u4EE4\u5C06\u65E0\u4EBA\u95EE\u6D25\u7684\u8FD4\u56DE\u503C\u76F4\u63A5\u4E22\u5F03\uFF0C\u4E5F\u5B9E\u5C5E\u5408\u7406\u3002</p><p><strong>\u6CE8\u610F</strong>\uFF1Apop \u6307\u4EE4\u53EA\u80FD\u4E22\u5F03 1 \u4E2A\u5B57\u957F\uFF0832 \u4F4D\uFF09\uFF0C\u5982\u679C\u8981\u4E22\u5F03\u6808\u9876\u7684 64 \u4F4D\u6570\u636E\uFF08long \u6216\u8005 double\uFF09\uFF0C\u5219\u9700\u8981\u4F7F\u7528 pop2 \u6307\u4EE4\uFF0C\u7C7B\u4F3C\u5730\uFF0C\u5982\u679C\u8981\u8FDE\u7EED\u590D\u5236\u6808\u9876 2 \u4E2A\u5B57\u957F\uFF0864 \u4F4D\u6570\u636E\uFF09\uFF0C\u5219\u53EF\u4EE5\u4F7F\u7528 dup2 \u6307\u4EE4\u3002</p><h3 id="_11-2-5-\u7C7B\u578B\u8F6C\u6362\u6307\u4EE4" tabindex="-1"><a class="header-anchor" href="#_11-2-5-\u7C7B\u578B\u8F6C\u6362\u6307\u4EE4" aria-hidden="true">#</a> 11.2.5 \u7C7B\u578B\u8F6C\u6362\u6307\u4EE4</h3><p>\u5728\u8F6F\u4EF6\u5F00\u53D1\u8FC7\u7A0B\u4E2D\uFF0C\u7C7B\u578B\u8F6C\u6362\u662F\u6781\u4E3A\u5E38\u7528\u7684\u529F\u80FD\u3002\u4E3A\u4E86\u66F4\u597D\u5730\u652F\u6301\u7C7B\u578B\u8F6C\u6362\uFF0C\u865A\u62DF\u673A\u63D0\u4F9B\u4E86\u4E00\u6574\u5957\u4E13\u95E8\u7528\u4E8E\u7C7B\u578B\u8F6C\u6362\u7684\u6307\u4EE4\u3002\u8FD9\u7C7B\u6307\u4EE4\u7684\u52A9\u8BB0\u7B26\u57FA\u672C\u4E0A\u4F7F\u7528 x2y \u7684\u5F62\u5F0F\u7ED9\u51FA\u3002\u5176\u4E2D x \u53EF\u80FD\u662F i\u3001f\u3001l\u3001d\uFF0Cy \u53EF\u80FD\u662F i\u3001f\u3001l\u3001d\u3001c\u3001s\u3001b\u3002\u5B83\u4EEC\u7684\u542B\u4E49\u5982\u886811.2 \u6240\u793A\u3002</p><p>\u886811.2 \u6307\u4EE4\u4E2D\u5B57\u7B26\u7684\u542B\u4E49</p><p><img src="`+g+'" alt="\u886811-2" loading="lazy"></p><p>\u6BD4\u5982\uFF0Ci2l \u8868\u793A\u5C06 int \u578B\u6570\u636E\u8F6C\u4E3A long \u578B\u6570\u636E\u3002\u5728\u6267\u884C\u6307\u4EE4 i2l \u65F6\uFF0C\u5148\u5C06\u6808\u9876\u7684 int \u578B\u6570\u636E\u5F39\u51FA\uFF0C\u7136\u540E\u8FDB\u884C\u8F6C\u6362\uFF0C\u6700\u540E\u5C06\u8F6C\u5316\u540E\u7684 long \u578B\u6570\u636E\u538B\u5165\uFF0C\u5982\u56FE11.13 \u6240\u793A\uFF0C\u8F6C\u6362\u540E\u7684 long \u578B\u6570\u636E\u5360\u7528\u4E24\u4E2A\u5B57\u7A7A\u95F4\u3002</p><p><img src="'+y+`" alt="\u56FE11-13" loading="lazy"></p><p>\u56FE11.13 \u6267\u884C\u6307\u4EE4 i2l \u548C l2i \u524D\u540E\u64CD\u4F5C\u6570\u6808\u60C5\u51B5</p><p>\u3010\u793A\u4F8B 11-5\u3011\u4E0B\u9762\u8FD9\u6BB5\u4EE3\u7801\u6F14\u793A\u8FD9\u7C7B\u6307\u4EE4\u7684\u4F7F\u7528\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print6</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> l <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token keyword">float</span> f <span class="token operator">=</span> l<span class="token punctuation">;</span>
    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> l<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u5B57\u8282\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: iload_1
1: i2l
2: lstore_2
3: lload_2
4: l2f
5: fstore 4
7: lload_2
8: l2i
9: istore 5
11: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4ECE\u5B57\u8282\u7801\u52A0\u7C97\u90E8\u5206\u4E0D\u96BE\u770B\u51FA\uFF0Cint \u7C7B\u578B\u8F6C\u6362\u4E3A long \u7C7B\u578B\u4F7F\u7528\u4E86 i2l\uFF0Clong \u7C7B\u578B\u8F6C\u6362\u4E3A float \u7C7B\u578B\u4F7F\u7528\u4E86 l2f\uFF0Clong \u7C7B\u578B\u8F6C\u6362\u4E3A int \u7C7B\u578B\u4F7F\u7528\u4E86 l2i\u3002</p><p>\u7EC6\u5FC3\u7684\u8BFB\u8005\u4E5F\u4E0D\u96BE\u53D1\u73B0\uFF0C\u5728\u8FD9\u4E9B\u8F6C\u6362\u6307\u4EE4\u4E2D\uFF0C\u53EA\u6709 i2b\u3001i2c\u3001i2s\uFF0C\u6CA1\u6709 b2i\u3001c2i\u3001s2i\u3002\u4E5F\u5C31\u662F\u8BF4\uFF0C\u6CA1\u6709\u4ECE byte\u3001char \u6216\u662F short \u7C7B\u578B\u8F6C\u6362\u4E3A\u5176\u4ED6\u6570\u636E\u7C7B\u578B\u7684\u6307\u4EE4\uFF0C\u8FD9\u4E0D\u514D\u8BA9\u4EBA\u5FC3\u751F\u7591\u8651\u3002\u6765\u770B\u5982\u4E0B\u4EE3\u7801\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print7</span><span class="token punctuation">(</span><span class="token keyword">byte</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> k <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token keyword">long</span> l <span class="token operator">=</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u6BB5\u4EE3\u7801\u628A\u4E00\u4E2A byte \u7C7B\u578B\u8F6C\u4E3A\u4E86 int \u7C7B\u578B\u548C long \u7C7B\u578B\u3002\u5982\u679C\u6CA1\u6709 b2i \u548C b2l\uFF0C\u8FD9\u662F\u5982\u4F55\u505A\u5230\u7684\u5462\uFF1F\u4EE5\u4E0B\u662F\u8FD9\u6BB5\u4EE3\u7801\u7684\u5B57\u8282\u7801\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: iload_1    // i \u538B\u5165\u6808
1: istore_2   // i \u8D4B\u503C\u7ED9 k
2: iload_1    // i \u5165\u6808
3: i2l        // i \u8F6C\u4E3A long
4: lstore_3   // long \u8CE6\u503C\u7ED9 l
5: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u5BF9\u4E8E byte \u7C7B\u578B\u8F6C\u4E3A int \u7C7B\u578B\uFF0C\u865A\u62DF\u673A\u5E76\u6CA1\u6709\u505A\u5B9E\u8D28\u6027\u7684\u8F6C\u5316\u5904\u7406\uFF0C\u53EA\u662F\u7B80\u5355\u5730\u901A\u8FC7\u64CD\u4F5C\u6570\u6808\u4EA4\u6362\u4E86\u4E24\u4E2A\u6570\u636E\u3002\u800C\u5C06 byte \u7C7B\u578B\u8F6C\u4E3A long \u7C7B\u578B\u65F6\uFF0C\u4F7F\u7528\u7684\u662F i2l\uFF0C\u53EF\u4EE5\u770B\u5230\u5728\u5185\u90E8 byte \u7C7B\u578B\u5728\u8FD9\u91CC\u5DF1\u7ECF\u7B49\u540C\u4E8E int \u7C7B\u578B\u5904\u7406\uFF0C\u7C7B\u4F3C\u7684\u8FD8\u6709 short \u7C7B\u578B\uFF0C\u8FD9\u79CD\u5904\u7406\u65B9\u5F0F\u6709\u4E24\u4E2A\u7279\u70B9\uFF1A</p><ul><li><p>\u4E00\u65B9\u9762\u53EF\u4EE5\u51CF\u5C11\u5B9E\u9645\u7684\u6570\u636E\u7C7B\u578B\uFF0C\u5982\u679C\u4E3A short \u548C byte \u7C7B\u578B\u90FD\u51C6\u5907\u4E00\u5957\u6307\u4EE4\uFF0C\u90A3\u4E48\u6307\u4EE4\u7684\u6570\u91CF\u5C31\u4F1A\u5927\u589E\uFF0C\u800C\u865A\u62DF\u673A\u76EE\u524D\u53EA\u613F\u610F\u4F7F\u7528\u4E00\u4E2A\u5B57\u8282\u8868\u793A\u6307\u4EE4\uFF0C\u56E0\u6B64\u6307\u4EE4\u603B\u6570\u4E0D\u80FD\u8D85\u8FC7 256 \u4E2A\uFF0C\u4E3A\u4E86\u8282\u7701\u6307\u4EE4\u8D44\u6E90\uFF0C\u5C06 short \u7C7B\u578B\u548C byte \u7C7B\u578B\u5F53\u4F5C int \u7C7B\u578B\u5904\u7406\u4E5F\u5728\u60C5\u7406\u4E4B\u4E2D\u3002</p></li><li><p>\u53E6\u4E00\u65B9\u9762\uFF0C\u7531\u4E8E\u5C40\u90E8\u53D8\u91CF\u8868\u4E2D\u7684\u69FD\u4F4D\u56FA\u5B9A\u4E3A 32 \u4F4D\uFF0C\u65E0\u8BBA\u662F byte \u7C7B\u578B\u8FD8\u662F short \u7C7B\u578B\u5B58\u5165\u5C40\u90E8\u53D8\u91CF\u8868\uFF0C\u90FD\u4F1A\u5360\u7528 32 \u4F4D\u7A7A\u95F4\u3002\u4ECE\u8FD9\u4E2A\u89D2\u5EA6\u8BF4\uFF0C\u4E5F\u6CA1\u6709\u5FC5\u8981\u7279\u610F\u533A\u5206\u8FD9\u51E0\u79CD\u6570\u636E\u7C7B\u578B\u3002</p></li></ul><h3 id="_11-2-6-\u8FD0\u7B97\u6307\u4EE4" tabindex="-1"><a class="header-anchor" href="#_11-2-6-\u8FD0\u7B97\u6307\u4EE4" aria-hidden="true">#</a> 11.2.6 \u8FD0\u7B97\u6307\u4EE4</h3><p>\u8FD0\u7B97\u6307\u4EE4\u4E3A Java \u865A\u62DF\u673A\u63D0\u4F9B\u4E86\u57FA\u672C\u7684\u52A0\u51CF\u4E58\u9664\u7B49\u8FD0\u7B97\u529F\u80FD\u3002\u57FA\u672C\u8FD0\u7B97\u53EF\u4EE5\u5206\u4E3A\u52A0\u6CD5\u3001\u51CF\u6CD5\u3001\u4E58\u6CD5\u3001\u9664\u6CD5\u3001\u53D6\u4F59\u3001\u6570\u503C\u53D6\u53CD\u3001\u4F4D\u8FD0\u7B97\u3001\u81EA\u589E\u8FD0\u7B97\u3002\u6BCF\u4E00\u4E2A\u6307\u4EE4\u4E5F\u6709\u81EA\u5DF1\u652F\u6301\u7684\u6570\u636E\u7C7B\u578B\uFF0C\u4E0E\u524D\u6587\u6240\u8FF0\u7684\u6307\u4EE4\u7C7B\u4F3C\uFF0C\u5C06\u6570\u636E\u7C7B\u578B\u4F7F\u7528\u4E00\u4E2A\u5B57\u7B26\u8868\u793A\u3002</p><ul><li><p>\u52A0\u6CD5\u6307\u4EE4\u6709\uFF1Aiadd\u3001ladd\u3001fadd\u3001dadd\u3002</p></li><li><p>\u51CF\u6CD5\u6307\u4EE4\u6709\uFF1Aisub\u3001lsub\u3001fsub\u3001dsub\u3002</p></li><li><p>\u4E58\u6CD5\u6307\u4EE4\u6709\uFF1Aimul\u3001lmul\u3001fmul\u3001dmul\u3002</p></li><li><p>\u9664\u6CD5\u6307\u4EE4\u6709\uFF1Aidiv\u3001ldiv\u3001fdiv\u3001ddiv\u3002</p></li><li><p>\u53D6\u4F59\u6307\u4EE4\u6709\uFF1Airem\u3001lrem\u3001frem\u3001drem\u3002</p></li><li><p>\u6570\u503C\u53D6\u53CD\u6709\uFF1Aineg\u3001lneg\u3001fheg\u3001dneg\u3002</p></li><li><p>\u81EA\u589E\u6307\u4EE4\uFF1Aiinc\u3002</p></li><li><p>\u4F4D\u8FD0\u7B97\u6307\u4EE4\uFF0C\u53C8\u53EF\u5206\u4E3A\u5982\u4E0B\u51E0\u79CD\u3002</p><ul><li>\u4F4D\u79FB\u6307\u4EE4\uFF1Aishl\u3001ishr\u3001iushr\u3001lshl\u3001lshr\u3001lushr\u3002</li><li>\u6309\u4F4D\u6216\u6307\u4EE4\uFF1Aior\u3001lor\u3002</li><li>\u6309\u4F4D\u4E0E\u6307\u4EE4\uFF1Aiand\u3001land\u3002</li><li>\u6309\u4F4D\u5F02\u6216\u6307\u4EE4\uFF1Aixor\u3001lxor\u3002</li></ul></li></ul><p>\u4EE5\u4E58\u6CD5\u6307\u4EE4\u4E3A\u4F8B\uFF0Cimul \u8868\u793A\u4ECE\u64CD\u4F5C\u6570\u6808\u4E2D\u5F39\u51FA\u4E24\u4E2A\u6574\u6570\uFF0C\u5C06\u5B83\u4EEC\u76F8\u4E58\uFF0C\u5C06\u7ED3\u679C\u518D\u538B\u5165\u6808\u3002\u6307\u4EE4 Imul \u8868\u793A\u5BF9 long \u578B\u6570\u636E\u7684\u64CD\u4F5C\uFF0Cfmul \u8868\u793A\u5BF9 float \u578B\u6570\u636E\u7684\u64CD\u4F5C\uFF0Cdmul \u8868\u793A\u5BF9 double \u578B\u6570\u636E\u7684\u4E58\u6CD5\uFF0C\u4F9D\u6B64\u7C7B\u63A8\u3002</p><p>\u53D6\u4F59\u6307\u4EE4\u7528\u4E8E\u8BA1\u7B97\u4E24\u4E2A\u6570\u76F8\u9664\u540E\u7684\u4F59\u6570\uFF0C\u6BD4\u5982 i % j \u5C31\u4F1A\u4EA7\u751F irem \u6307\u4EE4\u3002</p><p>\u3010\u793A\u4F8B 11-6\u3011\u6570\u503C\u53D6\u53CD\u6307\u4EE4\u6539\u53D8\u6570\u5B57\u7684\u7B26\u53F7\u4F4D\uFF0C\u6BD4\u5982\u4EE5\u4E0B Java \u4EE3\u7801\uFF0C\u4F1A\u4EA7\u751F\u4E24\u4E2A fneg\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">float</span> i <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> j <span class="token operator">=</span> <span class="token operator">-</span>i<span class="token punctuation">;</span>
i <span class="token operator">=</span> <span class="token operator">-</span>j\uFF1B
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u751F\u6210\u7684\u5B57\u8282\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: ldc  #73  // float 8.0f
2: fstore_1
3: fload_1
4: fneg
5: fstore_2
6: fload_2
7: fneg
8: fstore_1
9: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6307\u4EE4 fheg \u6267\u884C\u524D\u540E\uFF0C\u64CD\u4F5C\u6570\u6808\u6CA1\u6709\u53D8\u5316\uFF0C\u53EA\u662F\u6808\u9876\u7684\u5143\u7D20\u7B26\u53F7\u4F4D\u88AB\u53D6\u53CD\u3002</p><p>\u6307\u4EE4 iinc \u5BF9\u7ED9\u5B9A\u7684\u5C40\u90E8\u53D8\u91CF\u505A\u81EA\u589E\u64CD\u4F5C\uFF0C\u8FD9\u6761\u6307\u4EE4\u662F\u5C11\u6570\u51E0\u4E2A\u6267\u884C\u8FC7\u7A0B\u4E2D\u5B8C\u5168\u4E0D\u4FEE\u6539\u64CD\u4F5C\u6570\u6808\u7684\u6307\u4EE4\u3002\u5B83\u63A5\u6536\u4E24\u4E2A\u64CD\u4F5C\u6570\uFF1A\u7B2C 1 \u4E2A\u4E3A\u5C40\u90E8\u53D8\u91CF\u8868\u7684\u4F4D\u7F6E\uFF0C\u7B2C 2 \u4E2A\u4E3A\u7D2F\u52A0\u6570\u3002\u6BD4\u5982\u5E38\u89C1\u7684 i++\uFF0C\u5C31\u4F1A\u4EA7\u751F\u8FD9\u6761\u6307\u4EE4\u3002</p><p>\u3010\u793A\u4F8B 11-7\u3011\u4EE5\u4E0B\u4EE3\u7801\u5BF9\u5C40\u90E8\u53D8\u91CF i \u7D2F\u52A0 10 \u6B21\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print11</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
    i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE5\u4E0A\u4EE3\u7801\u4EA7\u751F\u7684\u5B57\u8282\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: bipush  123
2: istore_2
3: iinc  2, 10
6: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7531\u4E8E\u53C2\u6570\u4E2D this\u3001j \u5360\u636E\u4E86\u5C40\u90E8\u53D8\u91CF\u8868\u7684\u7B2C 0 \u548C\u7B2C 1 \u4E2A\u4F4D\u7F6E\uFF0C\u6545i\u5904\u4E8E\u7B2C 2 \u4E2A\u4F4D\u7F6E\u3002</p><p>\u3010\u793A\u4F8B 11-8\u3011\u4F4D\u8FD0\u7B97\u6307\u4EE4\u7531\u4F4D\u8FD0\u7B97\u7B26\u4EA7\u751F\uFF0C\u6BD4\u5982\u5DE6\u79FB &lt;&lt;\u3001\u65E0\u7B26\u53F7\u53F3\u79FB &gt;&gt;&gt;\u3001\u53F3\u79FB &gt;&gt;\u3001\u6309\u4F4D\u6216 |\u3001\u6309\u4F4D\u4E0E &amp;\u3001\u5F02\u6216 ^\u3001\u6309\u4F4D\u53D6\u53CD ~ \u7B49\u3002\u4E0D\u96BE\u53D1\u73B0\uFF0C\u9664\u4E86\u6309\u4F4D\u53D6\u53CD\uFF0C\u5176\u4ED6\u4F4D\u8FD0\u7B97\u90FD\u6709\u5BF9\u5E94\u7684\u6307\u4EE4\u3002\u90A3\u4E48\u6309\u4F4D\u53D6\u53CD\u53C8\u662F\u5982\u4F55\u505A\u5230\u7684\u5462\uFF1F\u4EE5\u4E0B\u9762\u7684\u4EE3\u7801\u4E3A\u4F8B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token operator">~</span>i<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u751F\u6210\u7684\u5B57\u8282\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: bipush  123
2: istore_1
3: iload_1
4: iconst_m1
5: ixor
6: istore_2
7: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D\uFF0Cixor \u4E3A\u6574\u6570\u7684\u6309\u4F4D\u5F02\u6216\u64CD\u4F5C\uFF0C\u5B83\u4ECE\u6808\u4E2D\u5F39\u51FA\u4E24\u4E2A\u6574\u6570\uFF0C\u5E76\u5C06\u5B83\u4EEC\u6309\u4F4D\u5F02\u6216\uFF0C\u5C06\u7ED3\u679C\u518D\u538B\u5165\u6808\u4E2D\u3002\u53EF\u4EE5\u770B\u5230\uFF0C\u5728 ixor \u6267\u884C\u524D\uFF0C\u538B\u5165\u6808\u4E2D\u7684\u6570\u5B57\u4E3A i = 123 \u53CA -1\uFF08iconst_m1\uFF09\uFF0C\u5728\u865A\u62DF\u673A\u4E2D\uFF0C\u6309\u4F4D\u53D6\u53CD\u662F\u901A\u8FC7\u4E0E -1 \u5F02\u6216\u8BA1\u7B97\u5F97\u6765\u7684\u3002</p><p><strong>\u6CE8\u610F</strong>\uFF1A-1 \u7684 2 \u8FDB\u5236\u8868\u793A\u4E3A\u4E00\u4E2A\u5168 1 \u7684\u6570\u5B57 0xFF\uFF0C\u4EFB\u4F55\u6570\u5B57\u4E0E 0xFF \u5F02\u6216\u540E\uFF0C\u81EA\u7136\u53D6\u53CD\u3002</p><h3 id="_11-2-7-\u5BF9\u8C61\u64CD\u4F5C\u6307\u4EE4" tabindex="-1"><a class="header-anchor" href="#_11-2-7-\u5BF9\u8C61\u64CD\u4F5C\u6307\u4EE4" aria-hidden="true">#</a> 11.2.7 \u5BF9\u8C61\u64CD\u4F5C\u6307\u4EE4</h3><p>Java \u662F\u9762\u5411\u5BF9\u8C61\u7684\u7A0B\u5E8F\u8BBE\u8BA1\u8BED\u8A00\uFF0C\u865A\u62DF\u673A\u5E73\u53F0\u4ECE\u5B57\u8282\u7801\u5C42\u9762\u5C31\u5BF9\u9762\u5411\u5BF9\u8C61\u505A\u4E86\u6DF1\u5C42\u6B21\u7684\u652F\u6301\u3002\u6709\u4E00\u7CFB\u5217\u6307\u4EE4\u4E13\u95E8\u7528\u4E8E\u5BF9\u8C61\u64CD\u4F5C\uFF0C\u53EF\u8FDB\u4E00\u6B65\u7EC6\u5206\u4E3A\u521B\u5EFA\u6307\u4EE4\u3001\u5B57\u6BB5\u8BBF\u95EE\u6307\u4EE4\u3001\u7C7B\u578B\u68C0\u67FB\u6307\u4EE4\u3001\u6570\u7EC4\u64CD\u4F5C\u6307\u4EE4\u3002</p><ol><li><p>\u521B\u5EFA\u6307\u4EE4</p><p>\u521B\u5EFA\u6307\u4EE4\u53EF\u4EE5\u7528\u4E8E\u521B\u5EFA\u5BF9\u8C61\uFF0C\u7531\u4E8E\u5BF9\u8C61\u5728 Java \u4E2D\u7684\u5E7F\u6CDB\u4F7F\u7528\uFF0C\u8FD9\u4E9B\u6307\u4EE4\u7684\u4F7F\u7528\u9891\u7387\u4E5F\u975E\u5E38\u9AD8\u3002\u521B\u5EFA\u6307\u4EE4\u4E3B\u8981\u6709 new\u3001newarray\u3001anewarray \u548C multianewarray\u3002</p><p>\u6307\u4EE4 new \u7528\u4E8E\u521B\u5EFA\u666E\u901A\u5BF9\u8C61\u3002\u5B83\u63A5\u6536\u4E00\u4E2A\u64CD\u4F5C\u6570\uFF0C\u4E3A\u6307\u5411\u5E38\u91CF\u6C60\u7684\u7D22\u5F15\uFF0C\u8868\u793A\u8981\u521B\u5EFA\u7684\u7C7B\u578B\uFF0C\u6267\u884C\u5B8C\u6210\u540E\uFF0C\u5C06\u5BF9\u8C61\u7684\u5F15\u7528\u538B\u5165\u6808\u3002</p><p>\u3010\u793A\u4F8B 11-9\u3011\u6307\u4EE4 newarray \u548C anewarray \u7528\u6765\u521B\u5EFA\u6570\u7EC4\u3002\u524D\u8005\u7528\u4E8E\u521B\u5EFA\u57FA\u672C\u7C7B\u578B\u7684\u6570\u7EC4\uFF0C\u540E\u8005\u7528\u4E8E\u521B\u5EFA\u5BF9\u8C61\u6570\u7EC4\u3002\u6307\u4EE4 multianewarray \u7528\u4E8E\u521B\u5EFA\u591A\u7EF4\u6570\u7EC4\u3002\u6BD4\u5982\u4EE5\u4E0B\u4EE3\u7801\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> intarray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objarray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mintarray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u6BB5\u4EE3\u7801\u521B\u5EFA\u4E86\u4E00\u4E2A int \u6570\u7EC4\uFF0C\u4E00\u4E2A Object \u6570\u7EC4\u548C\u4E00\u4E2A int \u4E8C\u7EF4\u6570\u7EC4\uFF0C\u5B83\u4F9D\u6B21\u4F7F\u7528\u4E86 newarray\u3001anewarray \u548C multianewarray\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: bipush    10
2: newarray    int
4: astore_1
5: bipush    10
7: anewarray    #3  // class java/lang/Object
10: astore_2
11: bipush    10
13: bipush    10
15: multianewarray    #81, 2  // class &quot;[[I&quot;
19: astore_3
20: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>\u5B57\u6BB5\u8BBF\u95EE\u6307\u4EE4</p><p>\u5B57\u6BB5\u8BBF\u95EE\u6307\u4EE4\u4E13\u95E8\u7528\u4E8E\u8BBF\u95EE\u7C7B\u6216\u8005\u5BF9\u8C61\u7684\u5B57\u6BB5\u3002\u4E3B\u8981\u6709 getfield\u3001putheld\u3001getstatic\u3001putstatic 4 \u4E2A\u3002\u5176\u4E2D\uFF0Cgetfield\u3001putfield \u7528\u4E8E\u64CD\u4F5C\u5B9E\u4F8B\u5BF9\u8C61\u7684\u5B57\u6BB5\uFF0Cgetstatic\u3001putstatic \u7528\u4E8E\u64CD\u4F5C\u7C7B\u7684\u9759\u6001\u5B57\u6BB5\u3002\u4EE5 getstatic \u6307\u4EE4\u4E3A\u4F8B\uFF0C\u5B83\u542B\u6709\u4E00\u4E2A\u64CD\u4F5C\u6570\uFF0C\u4E3A\u6307\u5411\u5E38\u91CF\u6C60\u7684 Fieldref \u7D22\u5F15\uFF0C\u5B83\u7684\u4F5C\u7528\u5C31\u662F\u83B7\u53D6 Fieldref \u6307\u5B9A\u7684\u5BF9\u8C61\u6216\u8005\u503C\uFF0C\u5E76\u5C06\u5176\u538B\u5165\u64CD\u4F5C\u6570\u6808\uFF08\u6709\u5173 Fieldref \u7684\u8BE6\u7EC6\u4FE1\u606F\uFF0C\u8BF7\u53C2\u9605\u7B2C 9 \u7AE0\uFF09\u3002</p><p>\u4EE5\u4E0B\u662F\u5E38\u7528\u7684\u63A7\u5236\u53F0\u8F93\u51FA\u8BED\u53E5\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Java \u7F16\u8BD1\u5668\u4F1A\u4E3A\u8FD9\u6761\u8BED\u53E5\u4EA7\u751F\u5982\u4E0B getstatic \u6307\u4EE4\uFF0C\u7528\u4E8E\u5C06 System.out \u8FD9\u4E2A\u9759\u6001\u5B57\u6BB5\u538B\u5165\u64CD\u4F5C\u6570\u6808\u3002\u8FD9\u6BB5\u6307\u4EE4\u663E\u793A\uFF0C\u5E38\u91CF\u6C60\u7B2C 21 \u53F7\u4E3A Fieldref\uFF0C\u5B83\u6307\u5411 System.out \u9759\u6001\u5B57\u6BB5\uFF0C\u5B57\u6BB5\u7C7B\u578B\u4E3A java/io/PrintStream\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: getstatic  #21  // Field java/lang/System.out:Ljava/io/PrintStream;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>\u7C7B\u578B\u68C0\u67E5\u6307\u4EE4</p><p>\u7C7B\u578B\u68C0\u67E5\u6307\u4EE4\u4E3B\u8981\u6709\u4E24\u4E2A\uFF1Acheckcast \u548C instanceof\u3002\u6307\u4EE4 checkcast \u7528\u4E8E\u68C0\u67E5\u7C7B\u578B\u5F3A\u5236\u8F6C\u6362\u662F\u5426\u53EF\u4EE5\u8FDB\u884C\u3002\u5982\u679C\u53EF\u4EE5\u8FDB\u884C\uFF0C\u90A3\u4E48 checkcast \u6307\u4EE4\u4E0D\u4F1A\u6539\u53D8\u64CD\u4F5C\u6570\u6808\uFF0C\u5426\u5219\u5B83\u4F1A\u629B\u51FA ClassCastException \u5F02\u5E38\u3002\u6307\u4EE4 instanceof \u7528\u6765\u5224\u65AD\u7ED9\u5B9A\u5BF9\u8C61\u662F\u5426\u662F\u67D0\u4E00\u4E2A\u7C7B\u7684\u5B9E\u4F8B\uFF0C\u5B83\u4F1A\u5C06\u5224\u65AD\u7ED3\u679C\u538B\u5165\u64CD\u4F5C\u6570\u6808\u3002</p><p>\u3010\u793A\u4F8B 11-10\u3011\u4EE5\u4E0B\u4EE3\u7801\u662F checkcast \u548C instanceof \u6307\u4EE4\u7684\u5B9E\u4F8B\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">chackcast</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u9762\u4EE3\u7801\u4F7F\u7528\u4E86 instanceof \u5173\u952E\u5B57\uFF0C\u5E76\u4F7F\u7528\u4E86\u5F3A\u5236\u8F6C\u6362\uFF0C\u5B83\u4EEC\u5206\u522B\u4F1A\u4EA7\u751F instanceof \u548C checkcast \u4E24\u4E2A\u5B57\u8282\u7801\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: aload_1
1: instanceof    #95  // class java/lang/String
4: ifeq    12
7: aload_1
8: checkcast    #95  // class java/lang/String
11: areturn
12: aconst_null
13: areturn
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u5B83\u4EEC\u90FD\u63A5\u6536\u4E00\u4E2A\u64CD\u4F5C\u6570\uFF0C\u5E76\u5224\u65AD\u6808\u9876\u5C42\u5143\u7D20\u662F\u5426\u53EF\u4EE5\u8F6C\u4E3A\u8BE5\u64CD\u4F5C\u6570\u7ED9\u5B9A\u7684\u7C7B\u578B\u3002</p></li><li><p>\u6570\u7EC4\u64CD\u4F5C\u6307\u4EE4</p><p>\u6570\u7EC4\u64CD\u4F5C\u6307\u4EE4\u4E3B\u8981\u6709\u524D\u6587\u4ECB\u7ECD\u8FC7\u7684 xastore \u548C xaload\uFF0C\u8FD9\u91CC\u4E0D\u518D\u8D58\u8FF0\u3002\u6B64\u5916\uFF0C\u8FD8\u6709\u4E00\u4E2A\u53D6\u6570\u7EC4\u957F\u5EA6\u7684\u6307\u4EE4 arraylength\uFF0C\u8BE5\u6307\u4EE4\u5F39\u51FA\u6808\u9876\u7684\u6570\u7EC4\u5143\u7D20\uFF0C\u83B7\u53D6\u6570\u7EC4\u7684\u957F\u5EA6\uFF0C\u5C06\u957F\u5EA6\u538B\u5165\u6808\u3002</p></li></ol><h3 id="_11-2-8-\u6BD4\u8F83\u63A7\u5236\u6307\u4EE4" tabindex="-1"><a class="header-anchor" href="#_11-2-8-\u6BD4\u8F83\u63A7\u5236\u6307\u4EE4" aria-hidden="true">#</a> 11.2.8 \u6BD4\u8F83\u63A7\u5236\u6307\u4EE4</h3><p>\u7A0B\u5E8F\u6D41\u7A0B\u79BB\u4E0D\u5F00\u6761\u4EF6\u63A7\u5236\uFF0C\u4E3A\u4E86\u652F\u6301\u6761\u4EF6\u8DF3\u8F6C\uFF0C\u865A\u62DF\u673A\u63D0\u4F9B\u4E86\u5927\u91CF\u5B57\u8282\u7801\u6307\u4EE4\uFF0C\u5927\u4F53\u4E0A\u53EF\u4EE5\u5206\u4E3A\u6BD4\u8F83\u6307\u4EE4\u3001\u6761\u4EF6\u8DF3\u8F6C\u6307\u4EE4\u3001\u6BD4\u8F83\u6761\u4EF6\u8DF3\u8F6C\u6307\u4EE4\u3001\u591A\u6761\u4EF6\u5206\u652F\u8DF3\u8F6C\u6307\u4EE4\u3001\u65E0\u6761\u4EF6\u8DF3\u8F6C\u6307\u4EE4\u7B49\u3002</p><ol><li><p>\u6BD4\u8F83\u6307\u4EE4</p><p>\u6BD4\u8F83\u6307\u4EE4\u7684\u4F5C\u7528\u662F\u6BD4\u8F83\u6808\u9876\u4E24\u4E2A\u5143\u7D20\u7684\u5927\u5C0F\uFF0C\u5E76\u5C06\u6BD4\u8F83\u7ED3\u679C\u5165\u6808\u3002\u6BD4\u8F83\u6307\u4EE4\u6709 dcmpg\u3001dcmpl\u3001fcmpg\u3001fcmpl\u3001lcmp\u3002\u4E0E\u524D\u6587\u8BB2\u89E3\u7684\u6307\u4EE4\u7C7B\u4F3C\uFF0C\u9996\u5B57\u7B26 d \u8868\u793A double \u7C7B\u578B\uFF0Cf \u8868\u793A float \u7C7B\u578B\uFF0Cl \u8868\u793A long \u7C7B\u578B\u3002\u5BF9\u4E8E double \u7C7B\u578B\u548C float \u7C7B\u578B\u7684\u6570\u5B57\uFF0C\u7531\u4E8E NaN \u7684\u5B58\u5728\uFF0C\u5404\u6709\u4E24\u4E2A\u7248\u672C\u7684\u6BD4\u8F83\u6307\u4EE4\uFF0C\u4EE5 float \u7C7B\u578B\u4E3A\u4F8B\uFF0C\u6709 fcmpg \u548C fcmpl \u4E24\u4E2A\u6307\u4EE4\uFF0C\u5B83\u4EEC\u7684\u533A\u522B\u5728\u4E8E\uFF0C\u5728\u8FDB\u884C\u6570\u5B57\u6BD4\u8F83\u65F6\uFF0C\u82E5\u9047\u5230 NaN \u503C\uFF0C\u5904\u7406\u7ED3\u679C\u4E0D\u540C\u3002</p><p>\u6307\u4EE4 fcmpg \u548C fcmpl \u90FD\u4ECE\u6808\u4E2D\u5F39\u51FA\u4E24\u4E2A\u64CD\u4F5C\u6570\uFF0C\u5E76\u5C06\u5B83\u4EEC\u505A\u6BD4\u8F83\uFF0C\u8BBE\u6808\u9876\u7684\u5143\u7D20\u4E3A v2\uFF0C\u6808\u9876\u987A\u4F4D\u7B2C 2 \u4F4D\u7684\u5143\u7D20\u4E3A v1\uFF0C\u82E5 v1 = v2 \u5219\u538B\u5165 0\uFF0C\u82E5 v1 &gt; v2 \u5219\u538B\u5165 1\uFF0C\u82E5 v1 &lt; v2 \u5219\u538B\u5165 -1\u3002\u4E24\u4E2A\u6307\u4EE4\u7684\u4E0D\u540C\u4E4B\u5904\u5728\u4E8E\uFF0C\u5982\u679C\u9047\u5230 NaN \u503C\uFF0Cfcmpg \u4F1A\u538B\u5165 1\uFF0C\u800C fbmpl \u4F1A\u538B\u5165 -1\u3002</p><p>\u6307\u4EE4 dcmpl \u548C dcmpg \u4E5F\u662F\u7C7B\u4F3C\u7684\uFF0C\u6839\u636E\u5176\u547D\u540D\u53EF\u4EE5\u63A8\u6D4B\u5176\u542B\u4E49\uFF0C\u5728\u6B64\u4E0D\u518D\u8D58\u8FF0\u3002\u6307\u4EE4 Icmp \u9488\u5BF9 long \u578B\u6574\u6570\uFF0C\u7531\u4E8E long \u578B\u6574\u6570\u6CA1\u6709 NaN \u503C\uFF0C\u6545\u65E0\u987B\u51C6\u5907\u4E24\u5957\u6307\u4EE4\u3002</p></li><li><p>\u6761\u4EF6\u8DF3\u8F6C\u6307\u4EE4</p><p>\u6761\u4EF6\u8DF3\u8F6C\u6307\u4EE4\u901A\u5E38\u548C\u6BD4\u8F83\u6307\u4EE4\u7ED3\u5408\u4F7F\u7528\u3002\u6761\u4EF6\u8DF3\u8F6C\u6307\u4EE4\u6709 ifeq\u3001iflt\u3001ifle\u3001ifne\u3001ifgt\u3001ifge\u3001ifnull\u3001ifnonnull \u8FD9\u4E9B\u6307\u4EE4\u90FD\u63A5\u6536\u4E24\u4E2A\u5B57\u8282\u7684\u64CD\u4F5C\u6570\uFF0C\u7528\u4E8E\u8BA1\u7B97\u8DF3\u8F6C\u7684\u4F4D\u7F6E\uFF0816 \u4F4D\u7B26\u53F7\u6574\u6570\u4F5C\u4E3A\u5F53\u524D\u4F4D\u7F6E\u7684 offset\uFF09\u3002\u5B83\u4EEC\u7684\u7EDF\u4E00\u542B\u4E49\u4E3A\uFF1A\u5F39\u51FA\u6808\u9876\u5143\u7D20\uFF0C\u6D4B\u8BD5\u5B83\u662F\u5426\u6EE1\u8DB3\u67D0\u4E00\u6761\u4EF6\uFF0C\u5982\u679C\u6EE1\u8DB3\u6761\u4EF6\uFF0C\u5219\u8DF3\u8F6C\u5230\u7ED9\u5B9A\u4F4D\u7F6E\u3002\u5728\u6761\u4EF6\u8DF3\u8F6C\u6307\u4EE4\u6267\u884C\u524D\uFF0C\u4E00\u822C\u53EF\u4EE5\u5148\u7528\u6BD4\u8F83\u6307\u4EE4\u8FDB\u884C\u6808\u9876\u5143\u7D20\u7684\u51C6\u5907\uFF0C\u7136\u540E\u8FDB\u884C\u6761\u4EF6\u8DF3\u8F6C\u3002</p><p>\u3010\u793A\u4F8B 11-11\u3011\u8BF7\u770B\u4EE5\u4E0B\u4EE3\u7801\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">float</span> f1 <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> f2 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>f1 <span class="token operator">&gt;</span> f2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE5\u4E0A\u4EE3\u7801\u4EA7\u751F\u7684\u6307\u4EE4\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: ldc    #38;  // float 9.0f
2: fstore_1
3: ldc    #39;  // float 10.0f
5: fstore_2
6: getstatic    #15;  // Field java/lang/System.out:Ljava/io/PrintStream;
9: fload_1
10: fload_2
11: fcmpl
12: ifle    19
15: iconst_1
16: goto    20
19: iconst_0
20: invokevirtual    #30; // Method java/io/PrintStream.println:(Z)V
23: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u7B2C 9 \u884C\u548C\u7B2C 10 \u884C\u5728\u6808\u9876\u51C6\u5907\u4E86\u4E24\u4E2A\u6BD4\u8F83\u5143\u7D20\u3002\u7B2C 11 \u884C\u5BF9\u6808\u9876\u4E24\u4E2A\u5143\u7D20\u8FDB\u884C\u6BD4\u8F83\uFF0C\u7B2C 12 \u884C\u7684 ifle \u83B7\u53D6\u6808\u9876\u7684\u7ED3\u679C\uFF0C\u5E76\u786E\u8BA4\u662F\u5426\u9700\u8981\u8DF3\u8F6C\u3002</p></li><li><p>\u6BD4\u8F83\u6761\u4EF6\u8DF3\u8F6C\u6307\u4EE4</p><p>\u6BD4\u8F83\u6761\u4EF6\u8DF3\u8F6C\u6307\u4EE4\u7C7B\u4F3C\u4E8E\u6BD4\u8F83\u6307\u4EE4\u548C\u6761\u4EF6\u8DF3\u8F6C\u6307\u4EE4\u7684\u7ED3\u5408\u4F53\uFF0C\u5B83\u5C06\u6BD4\u8F83\u548C\u8DF3\u8F6C\u4E24\u4E2A\u6B65\u9AA4\u5408\u4E8C\u4E3A\u4E00\uFF0C\u8FD9\u7C7B\u6307\u4EE4\u6709 if_cmpeq\u3001if_cmpne\u3001if_cmplt\u3001if_cmpgt\u3001if_cmple\u3001if_icmpge\u3001if_acmpeq \u548C if_acmpne\u3002\u5176\u4E2D\u6307\u4EE4\u52A9\u8BB0\u7B26\u52A0\u4E0A &quot;if_&quot; \u540E\uFF0C\u4EE5\u5B57\u7B26 &quot;i&quot; \u5F00\u5934\u7684\u6307\u4EE4\u9488\u5BF9 int \u578B\u6574\u6570\u64CD\u4F5C\uFF08\u4E5F\u5305\u62EC short \u548C byte \u7C7B\u578B\uFF09\uFF0C\u4EE5\u5B57\u7B26 &quot;a&quot; \u5F00\u5934\u7684\u6307\u4EE4\u8868\u793A\u5BF9\u8C61\u5F15\u7528\u7684\u6BD4\u8F83\u3002</p><p>\u8FD9\u4E9B\u6307\u4EE4\u90FD\u63A5\u6536\u4E24\u4E2A\u5B57\u8282\u7684\u64CD\u4F5C\u6570\u4F5C\u4E3A\u53C2\u6570\uFF0C\u7528\u4E8E\u8BA1\u7B97\u8DF3\u8F6C\u7684\u4F4D\u7F6E\u3002\u540C\u65F6\u5728\u6267\u884C\u6307\u4EE4\u65F6\uFF0C\u6808\u9876\u9700\u8981\u51C6\u5907\u4E24\u4E2A\u5143\u7D20\u8FDB\u884C\u6BD4\u8F83\u3002\u6307\u4EE4\u6267\u884C\u5B8C\u6210\u540E\uFF0C\u6808\u9876\u7684\u8FD9\u4E24\u4E2A\u5143\u7D20\u88AB\u6E05\u7A7A\uFF0C\u4E14\u6CA1\u6709\u4EFB\u4F55\u6570\u636E\u5165\u6808\u3002\u5982\u679C\u9884\u8BBE\u6761\u4EF6\u6210\u7ACB\uFF0C\u5219\u6267\u884C\u8DF3\u8F6C\uFF0C\u5426\u5219\u7EE7\u7EED\u6267\u884C\u4E0B\u4E00\u6761\u8BED\u53E5\u3002</p><p>\u3010\u793A\u4F8B 11-12\u3011\u4EE5\u4E0B\u9762\u7684\u4EE3\u7801\u4E3A\u4F8B\uFF0C\u6BD4\u8F83 short \u548C byte \u7C7B\u578B\u7684\u4E24\u4E2A\u6570\u5B57\u7684\u5927\u5C0F\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">short</span> f1 <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token keyword">byte</span> f2 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>f1 <span class="token operator">&gt;</span> f2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u751F\u6210\u7684\u5B57\u8282\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: bipush    9
2: istore_1
3: bipush 10
5: istore_2
6: getstatic    #15;  // Field java/lang/Systern.out:Ljava/io/PrintStream;
9: iload_1
10: iload_2
11: if_icmple    18
14: iconst_1
15: goto    19
18: iconst_0
19: invokevirtual    #30;  // Method java/io/PrintStream.println:(Z)V
22: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D\uFF0C\u7B2C 9 \u884C\u548C\u7B2C 10 \u884C\u5C06\u9700\u8981\u6BD4\u8F83\u7684\u6570\u5B57\u538B\u5165\u6808\uFF0C\u7B2C 11 \u884C\u6267\u884C\u6BD4\u8F83\uFF0C\u5982\u679C\u6761\u4EF6\u6210\u7ACB\u5219\u8DF3\u8F6C\u5230\u7B2C 18 \u884C\uFF0C\u8F93\u51FA 0\uFF0C\u5426\u5219\u7EE7\u7EED\u6267\u884C\u540E\u4E00\u6761\u6307\u4EE4\uFF0C\u5373\u8F93\u5165 1\u3002</p><p>\u3010\u793A\u4F8B 11-13\u3011\u5982\u679C\u6BD4\u8F83\u7684\u5143\u7D20\u662F\u5BF9\u8C61\uFF0C\u90A3\u4E48\u5C31\u4F1A\u4F7F\u7528 if_acmpeq \u548C if_acmpne \u6307\u4EE4\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Object</span> f1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span> f2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>fl <span class="token operator">==</span> f2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>fl <span class="token operator">!=</span> f2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE5\u4E0A\u4EE3\u7801\u751F\u6210\u7684\u90E8\u5206\u6307\u4EE4\u4E3A\uFF08\u7BC7\u5E45\u6240\u9650\uFF0C\u6CA1\u6709\u7ED9\u51FA\u5B8C\u6574\u6307\u4EE4\uFF09\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>19: aload_1
20: aload_2
21: if_acmpne    28
24: iconst_1
25: goto    29
...
35: aload_1
36: aload_2
37: if_acmpeq    44
40: iconst_1
41: goto    45
44: iconst_0
45: invokevirtual    #30;  // Method java/io/PrintStream.println:(Z)V
48: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D\u7B2C 9\u300110 \u884C\u548C\u7B2C 35\u300136 \u884C\u5206\u522B\u538B\u5165\u6808\u9876\u5143\u7D20\u8FDB\u884C\u6BD4\u8F83\uFF0C\u7B2C 21 \u884C\u548C\u7B2C 37 \u884C\u6267\u884C\u5BF9\u8C61\u5F15\u7528\u7684\u6BD4\u8F83\uFF0C\u5E76\u786E\u8BA4\u662F\u5426\u9700\u8981\u8DF3\u8F6C\u3002</p></li><li><p>\u591A\u6761\u4EF6\u5206\u652F\u8DF3\u8F6C\u6307\u4EE4</p><p>\u591A\u6761\u4EF6\u5206\u652F\u8DF3\u8F6C\u6307\u4EE4\u662F\u4E13\u4E3A switch-case \u8BED\u53E5\u8BBE\u8BA1\u7684\uFF0C\u4E3B\u8981\u6709 tableswitch \u548C lookupswitch\u3002\u4ECE\u52A9\u8BB0\u7B26\u4E0A\u770B\uFF0C\u4E24\u8005\u90FD\u662F switch \u8BED\u53E5\u7684\u5B9E\u73B0\uFF0C\u5B83\u4EEC\u7684\u533A\u522B\u5728\u4E8E\uFF0Ctableswitch \u8981\u6C42\u591A\u4E2A\u6761\u4EF6\u5206\u652F\u503C\u662F\u8FDE\u7EED\u7684\uFF0C\u5B83\u5185\u90E8\u53EA\u5B58\u653E\u8D77\u59CB\u503C\u548C\u7EC8\u6B62\u503C\uFF0C\u4EE5\u53CA\u82E5\u5E72\u4E2A\u8DF3\u8F6C\u504F\u79FB\u91CF\uFF0C\u901A\u8FC7\u7ED9\u5B9A\u7684\u64CD\u4F5C\u6570 index\uFF0C\u53EF\u4EE5\u7ACB\u5373\u5B9A\u4F4D\u5230\u8DF3\u8F6C\u504F\u79FB\u91CF\u4F4D\u7F6E\uFF0C\u56E0\u6B64\u6548\u7387\u6BD4\u8F83\u9AD8\u3002\u6307\u4EE4 lookupswitch \u5185\u90E8\u5B58\u653E\u7740\u5404\u4E2A\u79BB\u6563\u7684 case-offset \u5BF9\uFF0C\u6BCF\u6B21\u6267\u884C\u90FD\u8981\u641C\u7D22\u5168\u90E8\u7684 case-offset \u5BF9\uFF0C\u627E\u5230\u5339\u914D\u7684 case \u503C\uFF0C\u5E76\u6839\u636E\u5BF9\u5E94\u7684 offset \u8BA1\u7B97\u8DF3\u8F6C\u5730\u5740\uFF0C\u56E0\u6B64\u6548\u7387\u8F83\u4F4E\u3002</p><p>\u6307\u4EE4 tableswitch \u7684\u793A\u610F\u56FE\u5982\u56FE11.14 \u6240\u793A\u3002\u7531\u4E8E tableswitch \u7684 case \u503C\u662F\u8FDE\u7EED\u7684\uFF0C\u6240\u4EE5\u53EA\u9700\u8981\u8BB0\u5F55\u6700\u4F4E\u503C\u548C\u6700\u9AD8\u503C\uFF0C\u4EE5\u53CA\u6BCF\u4E00\u9879\u5BF9\u5E94\u7684 offset \u504F\u79FB\u91CF\uFF0C\u6839\u636E\u7ED9\u5B9A\u7684 index \u503C\u901A\u8FC7\u7B80\u5355\u7684\u8BA1\u7B97\u5373\u53EF\u76F4\u63A5\u5B9A\u4F4D\u5230 offset\u3002</p><p><img src="`+h+'" alt="\u56FE11-14" loading="lazy"></p><p>\u56FE11.14 \u6307\u4EE4 tableswitch \u7684\u793A\u610F\u56FE</p><p>\u6307\u4EE4 lookupswitch \u5904\u7406\u7684\u662F\u79BB\u6563\u7684 case \u503C\uFF0C\u4F46\u662F\u51FA\u4E8E\u6548\u7387\u8003\u8651\uFF0C\u5C06 case-offset \u5BF9\u6309\u7167 case \u503C\u5927\u5C0F\u6392\u5E8F\uFF0C\u7ED9\u5B9A index \u65F6\uFF0C\u9700\u8981\u67E5\u627E\u4E0E index \u76F8\u7B49\u7684 case\uFF0C\u83B7\u5F97\u5176 offset\uFF0C\u5982\u679C\u627E\u4E0D\u5230\u5219\u8DF3\u8F6C\u5230 default\u3002\u6307\u4EE4 lookupswitch \u7684\u793A\u610F\u56FE\u5982\u56FE11.15 \u6240\u793A\u3002</p><p><img src="'+w+`" alt="\u56FE11-15" loading="lazy"></p><p>\u56FE11.15 \u6307\u4EE4 lookupswitch \u7684\u793A\u610F\u56FE</p><p>\u3010\u793A\u4F8B 11-14\u3011\u4E0B\u9762\u4EE5\u51E0\u4E2A\u4EE3\u7801\u7247\u6BB5\u4E3A\u4F8B\uFF0C\u4ECB\u7ECD\u8FD9\u4E24\u4E2A\u6307\u4EE4\u7684\u5177\u4F53\u4F7F\u7528\u65B9\u5F0F\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">swtich1</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u4EE3\u7801\u5BF9 i \u8FDB\u884C\u5206\u652F\u5224\u65AD\uFF0C\u4EA7\u751F\u7684\u5B57\u8282\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: iload_1
1: tableswitch{ // 1 to 3
        1: 28;
        2: 31;
        3: 34;
        default: 34 }
28: goto    34
31: goto    34
34: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u7531\u4E8E case \u503C\u662F\u8FDE\u7EED\u7684\uFF0C\u7F16\u8BD1\u5668\u751F\u6210\u4E86 tableswitch \u6307\u4EE4\u6765\u5904\u7406 switch \u8BED\u53E5\u3002</p><p>\u518D\u6765\u770B\u7B2C 2 \u6BB5\u4EE3\u7801\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">swtich2</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">100</span><span class="token operator">:</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">200</span><span class="token operator">:</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">300</span><span class="token operator">:</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D\uFF0Ccase \u503C\u4E3A\u4E0D\u8FDE\u7EED\u7684\uFF0C\u65E0\u6CD5\u4F7F\u7528 tableswitch \u5904\u7406\uFF0C\u56E0\u6B64\u751F\u6210\u4E86 lookupswitch \u6307\u4EE4\u3002\u5F62\u5F0F\u4E0A lookupswitch \u548C tableswitch \u975E\u5E38\u7C7B\u4F3C\uFF0C\u4F46\u662F\u4ECE\u5B57\u8282\u7801\u4F53\u79EF\u4E0A\u770B\uFF0Clookupswitch \u9700\u8981\u5360\u7528\u66F4\u591A\u7684\u7A7A\u95F4\u3002\u8FD9\u975E\u5E38\u5BB9\u6613\u7406\u89E3\uFF0C\u56E0\u4E3A lookupswitch \u9700\u8981\u4E3A\u6BCF\u4E00\u79CD\u60C5\u51B5\u5206\u522B\u4FDD\u5B58 case-offset \u7684\u503C\uFF0C\u4F46\u662F tableswitch \u4E3A\u6BCF\u4E00\u4E2A\u5206\u652F\u53EA\u4FDD\u5B58\u4E86 offset\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: iload_1
1: lookupswitch{ // 3
        100: 36;
        200: 39;
        300: 42;
        default: 42 }
36: goto    42
39: goto    42
42: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u3010\u793A\u4F8B 11-15\u3011\u5728 JDK 1.7 \u540E\uFF0Cswtich \u8BED\u53E5\u5F97\u5230\u4E86\u589E\u5F3A\uFF0C\u76EE\u524D\u5DF2\u7ECF\u652F\u6301\u4F7F\u7528\u5B57\u7B26\u4E32\u8FDB\u884C switch \u64CD\u4F5C\u3002\u800C\u5B57\u7B26\u4E32\u7684 switch-case \u8BED\u53E5\u662F\u901A\u8FC7 lookupswitch \u6307\u4EE4\u6765\u5B9E\u73B0\u7684\u3002\u4EE5\u4E0B\u9762\u4EE3\u7801\u4E3A\u4F8B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">swtich4</span><span class="token punctuation">(</span><span class="token class-name">String</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">&quot;geym&quot;</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">&quot;zbase&quot;</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">&quot;java&quot;</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u4EE3\u7801\u7528\u5B57\u7B26\u4E32\u4F5C\u4E3A switch \u5BF9\u8C61\uFF0C\u5B83\u6240\u751F\u6210\u7684\u5B57\u8282\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: aload_1
1: dup
2: astore_2
3: invokevirtual    #51;  // Method java/lang/String.hashCode:()I
6: lookupswitch{ // 3
         3169394: 40;
         3254818: 52;
         115685963: 64;
         default: 73 }
40:  aload_2                                                      
41:  ldc    #57;  //String geym
43:  invokevirtual    #59;  // Method java/lang/String.equals:(Ljava/lang/Object;)Z
46:  ifne    73
49:  goto    73
52:  aload_2                                                      
53:  ldc    #63;  // String java
55:  invokevirtual    #59;  // Method java/lang/String.equals: (Ljava/lang/Object;)Z
58:  ifne    73
61:  goto    73
64:  aload_2                                                      
65:  ldc    #65;  // String zbase
67:  invokevirtual    #59; //Method java/lang/String.equals: (Ljava/lang/Object;)Z
70:  ifne    73
73:  return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u4E3A\u4E86\u652F\u6301\u5BF9 String \u7C7B\u578B\u7684 switch \u64CD\u4F5C\uFF0C\u5728\u5B57\u8282\u7801\u7B2C 3 \u884C\uFF08\u5B9E\u4E3A\u504F\u79FB\u91CF\uFF0C\u7528\u884C\u7B80\u5316\u63CF\u8FF0\uFF09\u8C03\u7528\u4E86\u5B57\u7B26\u4E32\u7684 hashCode() \u65B9\u6CD5\uFF0C\u5F97\u5230 int \u7C7B\u578B\u6574\u6570\u3002\u5728 lookupswitch \u6307\u4EE4\u4E2D\uFF0C\u5B9E\u9645\u4F7F\u7528\u8BE5 hash \u503C\u4F5C\u4E3A\u5206\u652F\u7684 case\u3002\u5982\u679C hash \u503C\u4E0D\u5339\u914D\uFF0C\u5219\u5B57\u7B26\u4E32\u4E5F\u4E0D\u5339\u914D\uFF0C\u56E0\u6B64\u53EF\u4EE5\u76F4\u63A5\u6267\u884C default \u5904\u7684\u6307\u4EE4\uFF0C\u4F46\u5982\u679C hash \u503C\u5339\u914D\uFF0C\u8003\u8651\u5230 hash \u51B2\u7A81\u7684\u5B58\u5728\uFF0C\u8FD9\u91CC\u5E76\u6CA1\u6709\u7ACB\u5373\u6267\u884C\u5339\u914D\u540E\u7684\u6307\u4EE4\uFF0C\u800C\u662F\u5BF9\u5339\u914D\u7684\u9879\u8FDB\u884C\u4E8C\u6B21\u786E\u8BA4\uFF0C\u5728\u7B2C 43 \u884C\u4F7F\u7528 String.equals() \u51FD\u6570\u5224\u65AD\u5B57\u7B26\u4E32\u662F\u5426\u771F\u7684\u76F8\u7B49\u3002\u5982\u679C\u786E\u5B9E\u76F8\u7B49\uFF0C\u5219\u6267\u884C\u5BF9\u5E94\u7684\u8BED\u53E5\uFF0C\u5426\u5219\u9000\u51FA\u3002\u7531\u6B64\u53EF\u89C1\uFF0C\u5F53\u4F7F\u7528 String \u4F5C\u4E3A case \u7C7B\u578B\u65F6\uFF0C\u865A\u62DF\u673A\u8981\u6267\u884C hash \u8BA1\u7B97\u53CA\u5224\u65AD\u5B57\u7B26\u4E32\u662F\u5426\u76F8\u7B49\uFF0C\u6027\u80FD\u5FC5\u7136\u8981\u4F4E\u4E8E\u76F4\u63A5\u5BF9 int \u7C7B\u578B\u7684\u5904\u7406\u3002</p></li><li><p>\u65E0\u6761\u4EF6\u8DF3\u8F6C\u6307\u4EE4</p><p>\u76EE\u524D\u4E3B\u8981\u7684\u65E0\u6761\u4EF6\u8DF3\u8F6C\u6307\u4EE4\u4E3A goto\u3002\u6307\u4EE4 jsr\u3001ret \u867D\u7136\u4E5F\u662F\u65E0\u6761\u4EF6\u8DF3\u8F6C\u7684\uFF0C\u4E3B\u8981\u7528\u4E8E try-finally \u8BED\u53E5\uFF0C\u4E14\u5DF2\u7ECF\u88AB\u865A\u62DF\u673A\u9010\u6E10\u5E9F\u5F03\uFF0C\u6545\u4E0D\u5728\u672C\u4E66\u4E2D\u4ECB\u7ECD\u3002\u6307\u4EE4 goto \u63A5\u6536\u4E24\u4E2A\u5B57\u8282\u7684\u64CD\u4F5C\u6570\uFF0C\u5171\u540C\u7EC4\u6210\u4E00\u4E2A\u5E26\u7B26\u53F7\u7684\u6574\u6570\uFF0C\u7528\u4E8E\u6307\u5B9A\u6307\u4EE4\u7684\u504F\u79FB\u91CF\uFF0C\u6307\u4EE4\u6267\u884C\u7684\u76EE\u7684\u5C31\u662F\u8DF3\u8F6C\u5230\u504F\u79FB\u91CF\u7ED9\u5B9A\u7684\u4F4D\u7F6E\u3002\u5982\u679C\u6307\u4EE4\u504F\u79FB\u91CF\u592A\u5927\uFF0C\u8D85\u8FC7\u53CC\u5B57\u8282\u7684\u5E26\u7B26\u53F7\u6574\u6570\u7684\u8303\u56F4\uFF0C\u5219\u53EF\u4EE5\u4F7F\u7528\u6307\u4EE4 goto_w\uFF0C\u5B83\u548C goto \u6709\u76F8\u540C\u7684\u4F5C\u7528\uFF0C\u4F46\u662F\u5B83\u63A5\u6536 4 \u4E2A\u5B57\u8282\u7684\u64CD\u4F5C\u6570\uFF0C\u53EF\u4EE5\u8868\u793A\u66F4\u5927\u7684\u5730\u5740\u8303\u56F4\u3002</p></li></ol><h3 id="_11-2-9-\u51FD\u6570\u8C03\u7528\u4E0E\u8FD4\u56DE\u6307\u4EE4" tabindex="-1"><a class="header-anchor" href="#_11-2-9-\u51FD\u6570\u8C03\u7528\u4E0E\u8FD4\u56DE\u6307\u4EE4" aria-hidden="true">#</a> 11.2.9 \u51FD\u6570\u8C03\u7528\u4E0E\u8FD4\u56DE\u6307\u4EE4</h3><p>\u4E3A\u4E86\u652F\u6301\u51FD\u6570\u8C03\u7528\u548C\u8FD4\u56DE\u503C\u7684\u5904\u7406\uFF0C\u865A\u62DF\u673A\u63D0\u4F9B\u4E86\u4E00\u7CFB\u5217\u57FA\u672C\u6307\u4EE4\u3002\u5C31\u51FD\u6570\u8C03\u7528\u800C\u8A00\uFF0C\u6709\u6307\u4EE4 invokevirtual\u3001invokeinterface\u3001invokespecial\u3001invokestatic \u548C invokedynamic\u3002\u5728\u51FD\u6570\u8FD4\u56DE\u65F6\uFF0C\u9700\u8981\u5C06\u8FD4\u56DE\u503C\u538B\u5165\u8C03\u7528\u8005\u64CD\u4F5C\u6570\u6808\uFF0C\u6B64\u65F6\u9700\u8981\u4F7F\u7528 xreturn \u6307\u4EE4\uFF08x \u53EF\u4EE5\u662F i\u3001l\u3001f\u3001d\u3001a \u6216\u7A7A\uFF09\u3002</p><p>\u8FD9\u4E9BinvokeAXY\u6307\u4EE4\u90FD\u662F\u8FDB\u884C\u51FD\u6570\u8C03\u7528\u7684\uFF0C\u4F46\u662F\u5404\u81EA\u90FD\u6709\u81EA\u5DF1\u7684\u4F7F\u7528\u8303\u56F4\u3002</p><ul><li><p>invokevirtual\uFF1A\u865A\u51FD\u6570\u8C03\u7528\uFF0C\u8C03\u7528\u5BF9\u8C61\u7684\u5B9E\u4F8B\u65B9\u6CD5\uFF0C\u6839\u636E\u5BF9\u8C61\u7684\u5B9E\u9645\u7C7B\u578B\u8FDB\u884C\u6D3E\u53D1\uFF0C\u652F\u6301\u591A\u6001\uFF0C\u4E5F\u662F\u6700\u5E38\u89C1\u7684 Java \u51FD\u6570\u8C03\u7528\u65B9\u5F0F\u3002</p></li><li><p>invokeinterface\uFF1A\u6307\u63A5\u53E3\u65B9\u6CD5\u7684\u8C03\u7528\uFF0C\u5F53\u88AB\u8C03\u7528\u5BF9\u8C61\u58F0\u660E\u4E3A\u63A5\u53E3\u65F6\uFF0C\u4F7F\u7528\u8BE5\u6307\u4EE4\u8C03\u7528\u63A5\u53E3\u7684\u65B9\u6CD5\u3002</p></li><li><p>invokespecial\uFF1A\u8C03\u7528\u4E00\u4E9B\u7279\u6B8A\u7684\u51FD\u6570\uFF0C\u6BD4\u5982\u6784\u9020\u51FD\u6570\u3001\u7C7B\u7684\u79C1\u6709\u65B9\u6CD5\u3001\u7236\u7C7B\u65B9\u6CD5\u3002\u8FD9\u4E9B\u65B9\u6CD5\u90FD\u662F\u9759\u6001\u7C7B\u578B\u7ED1\u5B9A\u7684\uFF0C\u4E0D\u4F1A\u5728\u8C03\u7528\u65F6\u8FDB\u884C\u52A8\u6001\u6D3E\u53D1\u3002</p></li><li><p>invokestatic\uFF1A\u8C03\u7528\u7C7B\u7684\u9759\u6001\u65B9\u6CD5\uFF0C\u8FD9\u4E2A\u4E5F\u662F\u9759\u6001\u7ED1\u5B9A\u7684\u3002</p></li><li><p>invokedynamic\uFF1A\u8C03\u7528\u52A8\u6001\u7ED1\u5B9A\u7684\u65B9\u6CD5\uFF0C\u8FD9\u4E2A\u662F JDK 1.7 \u540E\u65B0\u52A0\u5165\u7684\u6307\u4EE4\uFF0C\u8BE5\u6307\u4EE4\u7684\u5177\u4F53\u4ECB\u7ECD\u8BF7\u53C2\u8003 11.5 \u8282\u3002</p></li></ul><p>\u51FD\u6570\u8C03\u7528\u7ED3\u675F\u524D\uFF0C\u9700\u8981\u8FDB\u884C\u8FD4\u56DE\u3002\u8FD4\u56DE\u65F6\uFF0C\u9700\u8981\u4F7F\u7528 xretum \u6307\u4EE4\u5C06\u8FD4\u56DE\u503C\u5B58\u5165\u8C03\u7528\u8005\u7684\u64CD\u4F5C\u6570\u6808\u4E2D\u3002\u6839\u636E\u8FD4\u56DE\u503C\u7C7B\u578B\u7684\u4E0D\u540C\uFF0C\u8BE5\u6307\u4EE4\u7684\u524D\u7F00\u6709\u6240\u4E0D\u540C\uFF0C\u5F53\u8FD4\u56DE\u503C\u4E3A int \u7C7B\u578B\u65F6\uFF0C\u4F7F\u7528\u6307\u4EE4 ireturn\uFF0C\u5F53\u8FD4\u56DE\u503C\u4E3A void \u65F6\uFF0C\u4F7F\u7528\u6307\u4EE4 return\u3002\u8BE5\u6307\u4EE4\u88AB\u8C03\u7528\u65F6\uFF0C\u5982\u679C\u65B9\u6CD5\u662F\u540C\u6B65\u7684\uFF0C\u90A3\u4E48\u8C03\u7528\u540E\uFF0C\u76D1\u89C6\u5668\u9501\u5C06\u88AB\u91CA\u653E\u3002</p><p>\u3010\u793A\u4F8B 11-16\u3011\u4E0B\u9762\u901A\u8FC7\u51E0\u4E2A\u4EE3\u7801\u7247\u6BB5\u6765\u7406\u89E3\u4E00\u4E0B\u8FD9\u51E0\u4E2A\u6307\u4EE4\u7684\u4F7F\u7528\u65B9\u5F0F\u3002</p><p>\u9996\u5148\uFF0C\u6765\u4ECB\u7ECD\u4E00\u4E0B\u6307\u4EE4 invokevirtual \u7684\u4F7F\u7528\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;aa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4EE5\u4E0A\u8BED\u53E5\u4F1A\u4EA7\u751F\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: getstatic    #16;  // Field java/lang/System.out:Ljava/io/PrintStream;
3: ldc    #22;  // String aa
5: invokevirtual    #24;  // Method java/io/PrintStream.println:(Ljava/lang/String;)V 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6CE8\u610F\u6307\u4EE4 invokevirtual\uFF0C\u5B83\u8C03\u7528\u4E86 PrintStream \u5B9E\u4F8B\u7684 println() \u65B9\u6CD5\u3002\u5728\u8C03\u7528\u524D\uFF0C\u64CD\u4F5C\u6570\u6808\u4E2D\u5C06\u538B\u5165\u8C03\u7528\u5BF9\u8C61\u7684\u5B9E\u4F8B\uFF0C\u4EE5\u53CA\u8BE5\u65B9\u6CD5\u7684\u6240\u6709\u53C2\u6570\u3002\u5728\u672C\u4F8B\u4E2D\u4E3A System.out \u5B9E\u4F8B\u548C\u5B57\u7B26 &quot;aa&quot;\u3002\u6307\u4EE4 invokevirtual \u9700\u8981\u4E24\u4E2A\u5B57\u8282\u7684\u64CD\u4F5C\u6570\uFF0C\u7528\u4E8E\u8BA1\u7B97\u6307\u5411\u5E38\u91CF\u6C60\u7684\u7D22\u5F15\uFF0C\u8FD9\u91CC\u7D22\u5F15\u5FC5\u987B\u6307\u5411 CONSTANT_Methodref \u5165\u53E3\uFF0C\u8868\u793A\u9700\u8981\u8C03\u7528\u7684\u65B9\u6CD5\u3002</p><p>\u6307\u4EE4 invokeinterface \u8C03\u7528\u63A5\u53E3\u7684\u65B9\u6CD5\u3002\u6BD4\u5982\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
t<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span><span class="token punctuation">)</span> t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u4EE3\u7801\u751F\u6210\u4E86 Thread \u5BF9\u8C61\uFF0C\u5E76\u8C03\u7528\u4E86\u5B83\u7684 run() \u65B9\u6CD5\u3002Thread \u7C7B\u5B9E\u73B0\u4E86 Runnable \u63A5\u53E3\u3002\u8FD9\u91CC\u4F7F\u7528\u4E24\u79CD\u65B9\u5F0F\u8C03\u7528 run() \u65B9\u6CD5\uFF1A\u7B2C 1 \u79CD\u76F4\u63A5\u5728 Thread \u58F0\u660E\u7684\u5B9E\u4F8B\u4E0A\u8C03\u7528\uFF1B\u7B2C 2 \u79CD\u5C06\u5176\u8F6C\u4E3A\u63A5\u53E3\u7C7B\u578B Runnable\uFF0C\u518D\u8FDB\u884C\u8C03\u7528\u3002\u8FD9\u4E24\u79CD\u8C03\u7528\u65B9\u5F0F\u4F7F\u7528\u7684 invoke \u6307\u4EE4\u662F\u4E0D\u540C\u7684\uFF0C\u5982\u4E0B\u6240\u793A\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: new    #45;  // class java/lang/Thread
3: dup                                                                    
4: invokespecial    #47;  // Method java/lang/Thread.&quot;&lt;init&gt;&quot;:()V
7: astore_1                                                               
8: aload_1                                                                
9: invokevirtual    #48;  // Method java/lang/Thread.run:()V
12: aload_1                                                                
13: invokeinterface    #51, 1;  // InterfaceMethod java/lang/Runnable.run:()V
18: return      
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7B2C 9 \u884C\u4F7F\u7528 invokevirtual \u6307\u4EE4\uFF0C\u662F\u76F4\u63A5\u9488\u5BF9 Thread \u5BF9\u8C61\u7684\u8C03\u7528\uFF0C\u7B2C 13 \u884C\u5219\u662F\u9488\u5BF9 Runnable \u63A5\u53E3\u7684\u8C03\u7528\u3002\u548C invokevirtual \u4E0D\u540C\uFF0Cinvokeinterface \u5728\u8C03\u7528\u65F6\u9700\u8981\u989D\u5916\u4F20\u5165 1 \u4E2A\u5B57\u8282\u7684\u65E0\u7B26\u53F7\u6574\u6570\uFF0C\u8868\u793A\u8FD9\u6B21\u51FD\u6570\u8C03\u7528\u6240\u9700\u53C2\u6570\u7684\u5B57\u6570\uFF081 \u5B57\u4E3A 32 \u4F4D\uFF09\uFF0C\u5305\u542B\u9690\u542B\u7684 this\u3002\u5728\u672C\u4F8B\u4E2D\uFF0C\u51FD\u6570\u6CA1\u6709\u53C2\u6570\uFF0C\u53EA\u9700\u8981\u5F53\u524D\u5F15\u7528 this\uFF0C\u6545\u5B57\u6570\u4E3A 1\u3002</p><p>\u6307\u4EE4 invokespecial \u7528\u4E8E\u8C03\u7528\u7279\u6B8A\u7684\u51FD\u6570\u3002\u6BD4\u5982\uFF0C\u8C03\u7528\u7C7B\u7684\u6784\u9020\u51FD\u6570\u3001\u79C1\u6709\u65B9\u6CD5\u6216\u8005\u7236\u7C7B\u65B9\u6CD5\u65F6\u90FD\u4F1A\u4F7F\u7528\u8BE5\u6307\u4EE4\u3002\u8BE5\u6307\u4EE4\u63A5\u6536\u4E24\u4E2A\u5B57\u8282\u7684\u64CD\u4F5C\u6570\uFF0C\u7528\u4E8E\u8BA1\u7B97\u5E38\u91CF\u6C60\u7D22\u5F15\u5165\u53E3\uFF0C\u4E14\u8BE5\u5165\u53E3\u5FC5\u987B\u4E3A CONSTANT_Methodref\u3002\u6B64\u5916\uFF0C\u5728\u8C03\u7528\u65F6\uFF0C\u5FC5\u987B\u5728\u64CD\u4F5C\u6570\u6808\u4E2D\u51C6\u5907\u597D\u5BF9\u8C61\u5B9E\u4F8B\u3001\u51FD\u6570\u53C2\u6570\u7B49\u4FE1\u606F\u3002</p><p>\u4E00\u6B21\u7B80\u5355\u7684\u5BF9\u8C61\u5B9E\u4F8B\u521B\u5EFA\uFF0C\u5C31\u9700\u8981\u8C03\u7528\u6784\u9020\u51FD\u6570\uFF0C\u6BD4\u5982\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Date</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4EE5\u4E0A\u8BED\u53E5\u4F1A\u4EA7\u751F\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: new    #31;  // class java/util/Date
3: dup
4: invokespecial    #33;  // Method java/util/Date.&quot;&lt;init&gt;&quot;:()V
7: astore_1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u4F7F\u7528\u6307\u4EE4 invokespecial \u8C03\u7528\u4E86 Date \u7C7B\u7684\u6784\u9020\u51FD\u6570\u3002</p><p>\u3010\u793A\u4F8B 11-17\u3011\u4E0B\u9762\u518D\u6765\u770B\u4E00\u4E2A\u8C03\u7528\u7C7B\u7684\u79C1\u6709\u65B9\u6CD5\u7684\u4F8B\u5B50\u3002\u7531\u4E8E\u7C7B\u7684\u79C1\u6709\u65B9\u6CD5\u4E0D\u5177\u6709\u591A\u6001\u6027\uFF0C\u5373\u4F7F\u5728\u5B50\u7C7B\u4E2D\u6709\u76F8\u540C\u7B7E\u540D\u7684\u79C1\u6709\u65B9\u6CD5\uFF0C\u4E5F\u4E0D\u80FD\u8986\u76D6\u7236\u7C7B\u4E2D\u5BF9\u5E94\u7684\u79C1\u6709\u65B9\u6CD5\u7684\u884C\u4E3A\uFF0C\u56E0\u6B64\u5BF9\u4E8E\u79C1\u6709\u65B9\u6CD5\u7684\u8C03\u7528\u53EF\u4EE5\u4F7F\u7528\u9759\u6001\u7ED1\u5B9A\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invokeSpecial2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE5\u4E0A\u4EE3\u7801\u8C03\u7528 pMethod() \u79C1\u6709\u65B9\u6CD5\uFF0C\u5B83\u4EA7\u751F\u7684\u5B57\u8282\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: aload_0
1: invokespecial    #37; // Method pMethod:()V
4: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6B64\u5916\uFF0C\u8C03\u7528\u7236\u7C7B\u65B9\u6CD5\u65F6\u4E5F\u4F7F\u7528 invokespecial\uFF0C\u6BD4\u5982\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4F1A\u751F\u6210\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: aload_0
1: invokespecial    #40;  // Method java/lang/Object.toString:()Ljava/lang/String;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0Cinvokespecial \u5728\u8C03\u7528\u7236\u7C7B\u65B9\u6CD5\uFF0C\u901A\u8FC7\u64CD\u4F5C\u6570\u76F4\u63A5\u6307\u5411\u7236\u7C7B\u7684 toString() \u65B9\u6CD5\uFF0C\u4ECE\u800C\u907F\u514D\u4E86\u5B50\u7C7B toString() \u65B9\u6CD5\u7684\u4F7F\u7528\u3002</p><h3 id="_11-2-10-\u540C\u6B65\u63A7\u5236" tabindex="-1"><a class="header-anchor" href="#_11-2-10-\u540C\u6B65\u63A7\u5236" aria-hidden="true">#</a> 11.2.10 \u540C\u6B65\u63A7\u5236</h3><p>\u4E3A\u4E86\u5B9E\u73B0\u591A\u7EBF\u7A0B\u7684\u540C\u6B65\uFF0CJava\u865A\u62DF\u673A\u8FD8\u63D0\u4F9B\u4E86 monitorenter\u3001monitorexit \u6765\u5B8C\u6210\u4E34\u754C\u533A\u7684\u8FDB\u5165\u548C\u79BB\u5F00\u64CD\u4F5C\u3002\u5F53\u4E00\u4E2A\u7EBF\u7A0B\u8FDB\u5165\u540C\u6B65\u5757\u65F6\uFF0C\u5B83\u4F7F\u7528 monitorenter \u6307\u4EE4\u8BF7\u6C42\u8FDB\u5165\uFF0C\u5982\u679C\u5F53\u524D\u5BF9\u8C61\u7684\u76D1\u89C6\u5668\u8BA1\u6570\u5668\u4E3A 0\uFF0C\u5219\u5B83\u4F1A\u88AB\u51C6\u8BB8\u8FDB\u5165\uFF0C\u82E5\u4E3A 1\uFF0C\u5219\u5224\u65AD\u6301\u6709\u5F53\u524D\u76D1\u89C6\u5668\u7684\u7EBF\u7A0B\u662F\u5426\u4E3A\u81EA\u5DF1\uFF0C\u5982\u679C\u662F\uFF0C\u5219\u8FDB\u5165\uFF0C\u5426\u5219\u8FDB\u884C\u7B49\u5F85\uFF0C\u76F4\u5230\u5BF9\u8C61\u7684\u76D1\u89C6\u5668\u8BA1\u6570\u5668\u4E3A 0\uFF0C\u624D\u4F1A\u88AB\u5141\u8BB8\u8FDB\u5165\u540C\u6B65\u5757\u3002\u5F53\u7EBF\u7A0B\u9000\u51FA\u540C\u6B65\u5757\u65F6\uFF0C\u9700\u8981\u4F7F\u7528 monitorexit \u58F0\u660E\u9000\u51FA\u3002\u5728 Java \u865A\u62DF\u673A\u4E2D\uFF0C\u4EFB\u4F55\u5BF9\u8C61\u90FD\u6709\u4E00\u4E2A\u76D1\u89C6\u5668\u4E0E\u4E4B\u5173\u8054\uFF0C\u7528\u6765\u5224\u65AD\u5BF9\u8C61\u662F\u5426\u88AB\u9501\u5B9A\uFF0C\u5F53\u76D1\u89C6\u5668\u88AB\u6301\u6709\u540E\uFF0C\u5BF9\u8C61\u5904\u4E8E\u9501\u5B9A\u72B6\u6001\u3002</p><p>\u6307\u4EE4 monitorenter \u548C monitorexit \u5728\u6267\u884C\u65F6\uFF0C\u90FD\u9700\u8981\u5728\u64CD\u4F5C\u6570\u6808\u9876\u538B\u5165\u5BF9\u8C61\uFF0C\u4E4B\u540E monitorenter \u548C monitorexit \u7684\u9501\u5B9A\u548C\u91CA\u653E\u90FD\u662F\u9488\u5BF9\u8FD9\u4E2A\u5BF9\u8C61\u7684\u76D1\u89C6\u5668\u8FDB\u884C\u7684\u3002</p><p>\u56FE11.16 \u5C55\u793A\u4E86\u76D1\u89C6\u5668\u5982\u4F55\u4FDD\u62A4\u4E34\u754C\u533A\u4EE3\u7801\u4E0D\u540C\u65F6\u88AB\u591A\u4E2A\u7EBF\u7A0B\u8BBF\u95EE\uFF0C\u53EA\u6709\u5F53\u7EBF\u7A0B 4 \u79BB\u5F00\u4E34\u754C\u533A\u540E\uFF0C\u7EBF\u7A0B 1\u30012\u30013 \u624D\u6709\u53EF\u80FD\u8FDB\u5165\u3002</p><p><img src="`+f+`" alt="\u56FE11-16" loading="lazy"></p><p>\u56FE11.16 \u76D1\u89C6\u5668\u4FDD\u62A4\u4E34\u754C\u533A</p><p>\u3010\u793A\u4F8B 11-18\u3011\u8FD9\u91CC\u7ED9\u51FA\u4E00\u4E2A monitorenter\u3001monitorexit \u6307\u4EE4\u7684\u4F7F\u7528\u793A\u4F8B\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncAdd</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">add1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u7C7B SyncAdd \u4E2D\u6709\u4E24\u4E2A\u65B9\u6CD5\uFF1Aadd1() \u548C add2()\uFF0C\u5B83\u4EEC\u90FD\u5BF9\u5F53\u524D this \u5BF9\u8C61\u8FDB\u884C\u52A0\u9501\uFF0C\u5E76\u5BF9\u5B9E\u4F8B\u5B57\u6BB5 i \u8FDB\u884C\u66F4\u65B0\u3002\u5BF9\u4E8E add1() \u65B9\u6CD5\uFF0C\u6709\u5982\u4E0B\u5B57\u8282\u7801\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: aload_0
1: dup
2: getfield    #12;  // Field i:I
5: iconst_1
6: iadd
7: putfield    #12;  // Field i:I
10: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u8FD9\u6BB5\u4EE3\u7801\u548C\u666E\u901A\u7684\u65E0\u540C\u6B65\u64CD\u4F5C\u7684\u4EE3\u7801\u6CA1\u6709\u4EC0\u4E48\u4E0D\u540C\uFF0C\u6CA1\u6709\u4F7F\u7528 monitorenter \u548C monitorexit \u8FDB\u884C\u540C\u6B65\u533A\u63A7\u5236\u3002\u8FD9\u662F\u56E0\u4E3A\uFF0C\u5BF9\u4E8E\u540C\u6B65\u65B9\u6CD5\u800C\u8A00\uFF0C\u5F53\u865A\u62DF\u673A\u901A\u8FC7\u65B9\u6CD5\u7684\u8BBF\u95EE\u6807\u8BC6\u7B26\u5224\u65AD\u5B83\u662F\u4E00\u4E2A\u540C\u6B65\u65B9\u6CD5\u65F6\uFF0C\u4F1A\u81EA\u52A8\u5728\u65B9\u6CD5\u8C03\u7528\u524D\u8FDB\u884C\u52A0\u9501\uFF0C\u5F53\u540C\u6B65\u65B9\u6CD5\u6267\u884C\u5B8C\u6BD5\u540E\uFF0C\u4E0D\u7BA1\u65B9\u6CD5\u662F\u6B63\u5E38\u7ED3\u675F\u8FD8\u662F\u629B\u51FA\u5F02\u5E38\uFF0C\u5747\u4F1A\u7531\u865A\u62DF\u673A\u91CA\u653E\u8FD9\u4E2A\u9501\u3002\u6240\u4EE5\uFF0C\u5BF9\u4E8E\u540C\u6B65\u65B9\u5F0F\u800C\u8A00\uFF0Cmonitorenter \u548C monitorexit \u6307\u4EE4\u662F\u9690\u5F0F\u5B58\u5728\u7684\uFF0C\u5E76\u672A\u76F4\u63A5\u51FA\u73B0\u5728\u5B57\u8282\u7801\u4E2D\u3002</p><p>add2() \u65B9\u6CD5\u7684\u5B57\u8282\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: aload_0
1: dup
2: astore_1
3: monitorenter
4: aload_0
5: dup
6: getfield    #12;  // Field i:I
9: iconst_1
10: iadd
11: putfield    #12;  // Field i:I
14: aload_1
15: monitorexit
16: goto    22
19: aload_1
20: monitorexit
21: athrow
22: return
  Exception table:                     
     from  to  target  type                  
     4	   16  19      any              
     19	   21  19      any     
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u5BF9\u4E8E\u540C\u6B65\u5757\u800C\u8A00\uFF0C\u5B57\u8282\u7801\u4E2D\u5DF2\u7ECF\u751F\u6210\u4E86 monitorenter \u548C monitorexit \u6307\u4EE4\u3002\u8BFB\u8005\u4E5F\u8BB8\u4F1A\u89C9\u5F97\u5947\u602A\uFF0C\u4E3A\u4EC0\u4E48\u4E00\u4E2A monitorenter \u5C45\u7136\u4F1A\u5BF9\u5E94\u4E24\u4E2A monitorexit \u6307\u4EE4\uFF1F\u8BFB\u8005\u53EF\u4EE5\u6CE8\u610F\u5B57\u8282\u7801\u6700\u540E\u7ED9\u51FA\u7684\u5F02\u5E38\u8868\uFF0C\u867D\u7136\u5728\u6E90\u7801\u4E2D\u6CA1\u6709\u8FDB\u884C\u5F02\u5E38\u5904\u7406\uFF0C\u4F46\u662F\u5728\u751F\u6210\u7684\u5B57\u8282\u7801\u4E2D\u81EA\u52A8\u63D2\u5165\u4E86\u4E00\u6BB5\u5F02\u5E38\u5904\u7406\u4EE3\u7801\uFF0C\u5F02\u5E38\u5904\u7406\u70B9\u4E3A\u7B2C 19 \u884C\u3002\u6574\u6BB5\u5B57\u8282\u7801\u7684\u89E3\u6790\u5982\u4E0B\uFF1A</p><p>\u7B2C 0 \u884C\u5C06 this \u5F15\u7528\u5165\u6808\u3002</p><p>\u7B2C 1 \u884C\u590D\u5236 this \u5F15\u7528\uFF0C\u5E76\u5165\u6808\u3002</p><p>\u7B2C 2 \u884C\u5C06 this \u5F15\u7528\u5F39\u51FA\uFF0C\u5B58\u5165\u7B2C 1 \u4E2A\u5C40\u90E8\u53D8\u91CF\u3002</p><p>\u7B2C 3 \u884C\u6839\u636E\u6808\u9876\u7684 this \u5F15\u7528\u8FDB\u884C\u52A0\u9501\u3002</p><p>\u7B2C 4 ~ 14 \u884C\u6267\u884C\u4E86 i++ \u64CD\u4F5C\u3002</p><p>\u7B2C 15 \u884C\u8868\u793A\u91CA\u653E\u9501\uFF0C\u6B64\u65F6\uFF0Ci++ \u5DF2\u7ECF\u5B8C\u6210\u3002</p><p>\u7B2C 16 \u884C\u8DF3\u8F6C\u5230\u7B2C 22 \u884C\uFF0C\u5E76\u9000\u51FA\u3002</p><p>\u5982\u679C\u5728\u7B2C 4 ~ 16 \u884C\u6267\u884C\u671F\u95F4\u9047\u5230\u4EFB\u4F55\u5F02\u5E38\uFF0C\u5219\u8FDB\u5165\u7B2C 19 \u884C\u5904\u7406\u3002</p><p>\u7B2C 19 \u884C\u5C06\u7B2C 1 \u4E2A\u5C40\u90E8\u53D8\u91CF\u5165\u6808\uFF0C\u8BE5\u53D8\u91CF\u5C31\u662F this\uFF0C\u7531\u7B2C 2 \u884C\u5B58\u5165\u3002</p><p>\u7B2C 20 \u884C\u6839\u636E\u6808\u9876\u7684 this \u9000\u51FA\u4E34\u754C\u533A\uFF0C\u91CA\u653E\u9501\u3002</p><p>\u7B2C 21 \u884C\u629B\u51FA\u5F53\u524D\u53D1\u751F\u7684\u5F02\u5E38\uFF0C\u5F02\u5E38\u5BF9\u8C61\u4F4D\u4E8E\u6808\u9876\u3002</p><h3 id="_11-2-11-\u518D\u770B-class-\u7684\u65B9\u6CD5\u7ED3\u6784" tabindex="-1"><a class="header-anchor" href="#_11-2-11-\u518D\u770B-class-\u7684\u65B9\u6CD5\u7ED3\u6784" aria-hidden="true">#</a> 11.2.11 \u518D\u770B Class \u7684\u65B9\u6CD5\u7ED3\u6784</h3><p>\u5728 9.2.14 \u8282\u4E2D\uFF0C\u4EE5 SimpleUser.setId() \u65B9\u6CD5\u4E3A\u4F8B\uFF0C\u5206\u6790\u4E86 Class \u6587\u4EF6\u7684\u9759\u6001\u7ED3\u6784\u3002\u8BFB\u8005\u53EF\u4EE5\u56DE\u987E\u76F8\u5173\u5185\u5BB9\u3002\u56FE11.17 \u4E3A setId() \u65B9\u6CD5\u7684\u7ED3\u6784\u548C\u6307\u4EE4\u90E8\u5206\u3002</p><p><img src="`+S+`" alt="\u56FE11-17" loading="lazy"></p><p>\u56FE11.17 setId() \u65B9\u6CD5\u7684\u7ED3\u6784\u548C\u6307\u4EE4\u90E8\u5206</p><p>\u5176\u4E2D\u7EC6\u7EBF\u6846\u90E8\u5206\u4E3A\u65B9\u6CD5\u7684\u5B57\u8282\u7801\u6307\u4EE4\u3002\u4E3A\u9605\u8BFB\u65B9\u4FBF\uFF0C\u8FD9\u91CC\u518D\u6B21\u7ED9\u51FA SimpleUser.setId() \u65B9\u6CD5\u6E90\u7801\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u89E3\u6790 setId() \u65B9\u6CD5\u5B57\u8282\u7801\uFF0C\u5982\u886811.3 \u6240\u793A\u3002</p><p>\u886811.3 setId() \u65B9\u6CD5\u5B57\u8282\u7801\u89E3\u6790</p><p><img src="`+x+'" alt="\u886811-3-1" loading="lazy"></p><p><img src="'+j+`" alt="\u886811-3-2" loading="lazy"></p><p><strong>\u6CE8\u610F</strong>\uFF1A\u8868\u4E2D\u7B2C 1 \u5217\u7684\u6570\u5B57\u5747\u4E3A 16 \u8FDB\u5236\uFF0C\u6545\u5728\u5E38\u91CF\u6C60\u7D22\u5F15\u8BA1\u7B97\u65F6\uFF0C\u52A1\u5FC5\u5148\u8F6C\u4E3A 10 \u8FDB\u5236\u3002</p><p>\u6700\u540E\uFF0C\u7ED9\u51FA\u8FD9\u6BB5\u4EE3\u7801\u7684\u5B8C\u6574\u5B57\u8282\u7801\u4FE1\u606F\uFF0C\u65B9\u4FBF\u8BFB\u8005\u6BD4\u5BF9\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: aload_0
1: iload_1
2: putfield    #23;  // Field id:I
5: goto    19
8: astore_2
9: getstatic    #30;  // Field java/lang/System.out:Ljava/io/Printstream;
12: aload_2
13: invokevirtual    #36;  // Method java/lang/IllegalStateException.toString:()Ljava/lang/String;
16: invokevirtual    #40;  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
19: return
  Exception table:
    from  to  target  type
    0     5   8       Class java/lang/IllegalStateException
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_11-3-\u66F4\u4E0A\u4E00\u5C42\u697C-\u518D\u770B-asm" tabindex="-1"><a class="header-anchor" href="#_11-3-\u66F4\u4E0A\u4E00\u5C42\u697C-\u518D\u770B-asm" aria-hidden="true">#</a> 11.3 \u66F4\u4E0A\u4E00\u5C42\u697C\uFF1A\u518D\u770B ASM</h2><p>\u8BFB\u5230\u8FD9\u91CC\uFF0C\u8BFB\u8005\u6216\u8BB8\u4F1A\u89C9\u5F97\u5B66\u4E60\u865A\u62DF\u673A\u7684\u6307\u4EE4\u67AF\u71E5\u800C\u4E4F\u5473\uFF0C\u4E86\u89E3 Class \u6587\u4EF6\u9519\u7EFC\u590D\u6742\u7684\u7ED3\u6784\u4F3C\u4E4E\u4E5F\u6CA1\u6709\u592A\u5927\u7684\u4EF7\u503C\u3002\u4E8B\u5B9E\u6070\u6070\u76F8\u53CD\uFF0C\u8FD9\u4E9B\u770B\u4F3C\u67AF\u71E5\u7684\u77E5\u8BC6\uFF0C\u53EF\u4EE5\u8BA9\u6211\u4EEC\u505A\u5F88\u591A\u6709\u8DA3\u7684\u4E8B\u60C5\u3002\u6BD4\u5982\u5927\u540D\u9F0E\u9F0E\u7684 CGLIB\uFF0C\u5176\u5E95\u5C42\u5C31\u662F\u57FA\u4E8E ASM \u7684\uFF0C\u800C\u8981\u7528\u597D ASM\uFF0C\u4E86\u89E3 Class \u6587\u4EF6\u7ED3\u6784\u548C\u5E38\u7528\u6307\u4EE4\u662F\u5FC5\u4E0D\u53EF\u5C11\u7684\u3002\u901A\u8FC7 ASM \u7684\u5B57\u8282\u7801\u64CD\u4F5C\uFF0C\u53EF\u4EE5\u52A8\u6001\u521B\u5EFA\u65B0\u7684\u7C7B\u578B\uFF0C\u53EF\u4EE5\u4E3A\u7C7B\u589E\u52A0\u65B0\u7684\u529F\u80FD\u3002\u867D\u7136\u4F7F\u7528 CGLIB \u8FD9\u4E9B\u9AD8\u7EA7\u5E93\u4E5F\u53EF\u4EE5\u5B8C\u6210\u5927\u91CF\u7684\u5DE5\u4F5C\uFF0C\u4F46\u662F\u76F4\u63A5\u4F7F\u7528 ASM \u8FD8\u662F\u5927\u6709\u597D\u5904\u7684\uFF1AASM \u7684\u6027\u80FD\u6700\u597D\uFF0C\u7075\u6D3B\u5EA6\u6700\u9AD8\uFF0C\u529F\u80FD\u4E5F\u6700\u5F3A\u5927\uFF0C\u53EF\u4EE5\u5C06\u64CD\u4F5C\u7C92\u5EA6\u5B9A\u4F4D\u5230\u6BCF\u4E00\u6761\u6307\u4EE4\u3002</p><h3 id="_11-3-1-\u4E3A\u7C7B\u589E\u52A0\u5B89\u5168\u63A7\u5236" tabindex="-1"><a class="header-anchor" href="#_11-3-1-\u4E3A\u7C7B\u589E\u52A0\u5B89\u5168\u63A7\u5236" aria-hidden="true">#</a> 11.3.1 \u4E3A\u7C7B\u589E\u52A0\u5B89\u5168\u63A7\u5236</h3><p>\u3010\u793A\u4F8B 11-19\u3011\u672C\u8282\u5C06\u4ECB\u7ECD\u4E00\u4E2A\u4F7F\u7528 ASM \u7684\u57FA\u672C\u6848\u4F8B\u3002\u73B0\u6709\u4E00\u4E2A\u8D26\u6237\u7C7B\uFF0C\u53EF\u4EE5\u8FDB\u884C\u67D0\u4E9B\u64CD\u4F5C\uFF0C\u5982\u4E0B\u6240\u793A\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Account</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;operation ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u76EE\u524D\uFF0Coperation() \u65B9\u6CD5\u6CA1\u6709\u4EFB\u4F55\u63A7\u5236\u624B\u6BB5\uFF0C\u73B0\u5728\u5E0C\u671B\u4E3A operation() \u65B9\u6CD5\u589E\u52A0\u4E00\u4E9B\u5B89\u5168\u6821\u9A8C\uFF0C\u4EE5\u5224\u65AD\u8FD9\u4E2A\u5BF9\u8C61\u662F\u5426\u6709\u6743\u9650\u6267\u884C\u8FD9\u4E2A\u65B9\u6CD5\uFF0C\u5982\u679C\u6709\uFF0C\u5219\u6267\u884C\u8BE5\u65B9\u6CD5\uFF0C\u5982\u679C\u6CA1\u6709\uFF0C\u5219\u76F4\u63A5\u9000\u51FA\u3002\u5F53\u7136\uFF0C\u8FD9\u4E00\u5207\u662F\u8981\u5728\u4E0D\u4FEE\u6539 Account \u7C7B\u6E90\u7801\u7684\u524D\u63D0\u4E0B\u8FDB\u884C\u7684\u3002</p><p><strong>\u6CE8\u610F</strong>\uFF1A\u6839\u636E\u5F00\u95ED\u539F\u5219\uFF0C\u4E00\u4E2A\u7CFB\u7EDF\u5BF9\u529F\u80FD\u7684\u589E\u52A0\u5E94\u8BE5\u662F\u5F00\u653E\u7684\uFF0C\u5BF9\u4FEE\u6539\u5E94\u8BE5\u662F\u95ED\u5408\u7684\u3002\u4E5F\u5C31\u662F\u8BF4\uFF0C\u7CFB\u7EDF\u5E94\u8BE5\u62E5\u6709\u4E00\u5B9A\u7684\u6269\u5C55\u6027\uFF0C\u4F46\u662F\u4E5F\u5E94\u8BE5\u5C3D\u53EF\u80FD\u4E0D\u8981\u4FEE\u6539\u539F\u6709\u7CFB\u7EDF\u7684\u4EE3\u7801\u3002\u5BF9\u4E8E\u7EBF\u4E0A\u7CFB\u7EDF\uFF0C\u4FEE\u6539\u4EE3\u7801\u5E26\u6765\u7684\u6700\u5927\u95EE\u9898\u662F\u5F88\u5BB9\u6613\u5C06\u539F\u6709\u7CFB\u7EDF\u7834\u574F\uFF0C\u9700\u8981\u5B89\u6392\u66F4\u591A\u7684\u56DE\u5F52\u6D4B\u8BD5\u3002\u4ECE\u53E6\u4E00\u65B9\u9762\u8BB2\uFF0C\u5982\u679C\u7CFB\u7EDF\u4E2D\u8981\u8FDB\u884C\u6743\u9650\u6821\u9A8C\u7684\u529F\u80FD\u70B9\u5F88\u591A\uFF0C\u8FDB\u884C\u7EDF\u4E00\u7684\u6279\u91CF\u5904\u7406\u8981\u6BD4\u9010\u4E2A\u5904\u7406\u65B9\u4FBF\u3001\u9AD8\u6548\u3001\u7CBE\u786E\u5F97\u591A\u3002</p><p>\u5047\u8BBE\u73B0\u5728\u8981\u589E\u52A0\u7684\u6743\u9650\u6821\u9A8C\u51FD\u6570\u4E3A\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityChecker</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">checkSecurity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;SecurityChecker.checkSecurity ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE5\u4E0A\u4EE3\u7801\u6A21\u62DF\u4E86\u6743\u9650\u6821\u9A8C\uFF0C\u901A\u8FC7\u968F\u673A\u65B9\u5F0F\u7ED9\u51FA\u662F\u5426\u901A\u8FC7\u6821\u9A8C\u3002\u73B0\u5728\u7CFB\u7EDF\u8981\u505A\u7684\u5C31\u662F\u5C06 SecurityChecker.checkSecurity() \u7F6E\u4E8E Account.operation() \u4E4B\u524D\u8FD0\u884C\uFF0C\u5982\u679C\u6743\u9650\u6821\u9A8C\u5931\u8D25\uFF0C\u5219\u963B\u6B62 Account.operation() \u7EE7\u7EED\u5904\u7406\u3002</p><p>\u4E0B\u9762\u7684 SecurityWeaveGenerator \u7C7B\u5C06 checkSecurity() \u653E\u7F6E\u5230 operation() \u7684\u7B2C 1 \u884C\u6267\u884C\u3002\u5B83\u7684\u6838\u5FC3\u662F\u4EE3\u7801\u7B2C 6 \u884C\u7684 AddSecurityCheckClassAdapter \u7C7B\u3002\u8FD9\u662F\u4E00\u4E2A ClassVisitor\uFF0C\u5B83\u8D1F\u8D23\u5B9E\u9645\u7684\u5B57\u8282\u7801\u7EC7\u5165\u64CD\u4F5C\u3002\u5728\u4EE3\u7801\u7684\u7B2C 8 ~ 12 \u884C\uFF0C\u5C06\u65B0\u751F\u6210\u7684 Account \u7C7B\u5199\u5165\u6587\u4EF6\uFF0C\u8986\u76D6\u7531 Java \u7F16\u8BD1\u5668\u4EA7\u751F\u7684 Account \u7C7B\u7684 Class \u6587\u4EF6\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityWeaveGenerator</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassReader</span> cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassReader</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_MAXS <span class="token operator">|</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_FRAMES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AddSecurityCheckClassAdapter</span> classAdapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AddSecurityCheckClassAdapter</span><span class="token punctuation">(</span>cw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cr<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>classAdapter<span class="token punctuation">,</span> <span class="token class-name">ClassReader</span><span class="token punctuation">.</span>SKIP_DEBUG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;bin/&quot;</span> <span class="token operator">+</span> className<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;\\\\.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; .class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileOutputStream</span> fout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fout<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AddSecurityCheckClassAdapter \u7C7B\u7684\u5185\u5BB9\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">AddSecurityCheckClassAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">ClassVisitor</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">AddSecurityCheckClassAdapter</span><span class="token punctuation">(</span><span class="token class-name">ClassVisitor</span> cv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>ASM5<span class="token punctuation">,</span> cv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">MethodVisitor</span> <span class="token function">visitMethod</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> access<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span>
                                     <span class="token keyword">final</span> <span class="token class-name">String</span> desc<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> exceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MethodVisitor</span> mv <span class="token operator">=</span> cv<span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodVisitor</span> wrappedMv <span class="token operator">=</span> mv<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mv <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;operation&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                wrappedMv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AddSecurityCheckMethodAdapter</span><span class="token punctuation">(</span>mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> wrappedMv<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728 AddSecurityCheckClassAdapter \u4E2D\u8986\u76D6\u4E86 visitMethod() \u65B9\u6CD5\uFF0C\u5728\u4EE3\u7801\u7684\u7B2C 11 \u884C\uFF0C\u5F53\u8BBF\u95EE\u5230 operation \u65B9\u6CD5\u65F6\uFF0C\u4EA4\u7531 AddSecurityCheckMethodAdapter \u7C7B\u5904\u7406\u3002AddSecurityCheckMethodAdapter \u662F\u4E00\u4E2A Methodvisitor\uFF0C\u8D1F\u8D23\u6700\u7EC8\u7684\u5B57\u8282\u7801\u4FEE\u6539\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">AddSecurityCheckMethodAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">MethodVisitor</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">AddSecurityCheckMethodAdapter</span><span class="token punctuation">(</span><span class="token class-name">MethodVisitor</span> mv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>ASM5<span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Label</span> continueLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">visitMethodInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>INVOKESTATIC<span class="token punctuation">,</span> <span class="token string">&quot;geym/zbase/ch11/aop/securitycheck/Securitychecker&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;checksecurity&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()Z&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">visitJumpInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>IFNE<span class="token punctuation">,</span> continueLabel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">visitInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>RETURN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">visitLabel</span><span class="token punctuation">(</span>continueLabel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AddSecurityCheckMethodAdapter \u7C7B\u8986\u76D6\u4E86 MethodVisitor \u7684 visitCode() \u65B9\u6CD5\u3002\u5F53\u8BBF\u95EE\u5230\u65B9\u6CD5\u7684\u5B57\u8282\u7801\u65F6\uFF0C\u5728\u7B2C 7 ~ 12 \u884C\u7EC7\u5165\u4E86\u5BF9 SecurityCheckcr.checkSecurity() \u7684\u8C03\u7528\u3002\u5982\u679C checkSecurity() \u8FD4\u56DE\u4E86 false\uFF08\u6808\u9876\u4E3A 0\uFF09\uFF0C\u6839\u636E\u6307\u4EE4 ifne\uFF0C\u8DF3\u8F6C\u4E0D\u4F1A\u53D1\u751F\uFF0C\u7A0B\u5E8F\u8FD4\u56DE\u3002\u5982\u679C checkSecurity() \u8FD4\u56DE\u4E86 true\uFF08\u6808\u9876\u4E3A 1\uFF09\uFF0C\u5219\u6307\u4EE4 ifne \u53D1\u751F\u8DF3\u8F6C\uFF0C\u7EE7\u7EED\u6267\u884C\u539F\u5148\u7684 operation() \u65B9\u6CD5\u3002</p><p>\u9996\u5148\u4F7F\u7528 javac \u7F16\u8BD1\u5E76\u751F\u6210 Account.class\uFF0C\u63A5\u7740\u4F7F\u7528 SecurityWeaveGenerator \u7C7B\u5BF9 Account.class \u8FDB\u884C\u5904\u7406\uFF0C\u7EC7\u5165\u6743\u9650\u6821\u9A8C\u7684\u5B57\u8282\u7801\uFF0C\u6700\u540E\u4F7F\u7528\u4EE5\u4E0B\u7B80\u5355\u7684\u4EE3\u7801\u6D4B\u8BD5\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunAccountMain</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Account</span> account <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        account<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7A0B\u5E8F\u53EF\u80FD\u7684\u8F93\u51FA\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>SecurityChecker.checkSecurity ...
operation ...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-3-2-\u7EDF\u8BA1\u51FD\u6570\u6267\u884C\u65F6\u95F4" tabindex="-1"><a class="header-anchor" href="#_11-3-2-\u7EDF\u8BA1\u51FD\u6570\u6267\u884C\u65F6\u95F4" aria-hidden="true">#</a> 11.3.2 \u7EDF\u8BA1\u51FD\u6570\u6267\u884C\u65F6\u95F4</h3><p>\u5F53\u7CFB\u7EDF\u9047\u5230\u6027\u80FD\u95EE\u9898\u65F6\uFF0C\u83B7\u53D6\u51FD\u6570\u7684\u6267\u884C\u65F6\u95F4\u6709\u52A9\u4E8E\u5E2E\u52A9\u6211\u4EEC\u6392\u67E5\u6027\u80FD\u95EE\u9898\u3002\u7EDF\u8BA1\u51FD\u6570\u6267\u884C\u65F6\u95F4\u6700\u7B80\u5355\u7684\u65B9\u5F0F\u662F\u5728\u51FD\u6570\u5165\u53E3\u548C\u51FA\u53E3\u5904\u90FD\u4F7F\u7528 System.currentTimeMillis() \u51FD\u6570\u83B7\u5F97\u7CFB\u7EDF\u65F6\u95F4\uFF0C\u7136\u540E\u8BA1\u7B97\u4E24\u8005\u7684\u5DEE\u503C\u3002\u4E00\u822C\u60C5\u51B5\u4E0B\uFF0C\u4E0D\u53EF\u80FD\u4E3A\u6BCF\u4E00\u4E2A\u51FD\u6570\u90FD\u5199\u8FD9\u6837\u7684\u8BED\u53E5\uFF0C\u5728\u5B9E\u9645\u5DE5\u4F5C\u4E2D\uFF0C\u5F80\u5F80\u4E0D\u4F1A\u6709\u8FD9\u6837\u7684\u4FE1\u606F\u7EDF\u8BA1\u3002\u4F46\u5F97\u76CA\u4E8E ASM \u6846\u67B6\uFF0C\u73B0\u5728\u53EF\u4EE5\u5728\u4E0D\u4FEE\u6539\u6E90\u7801\u3001\u4E0D\u6539\u53D8\u539F\u6709\u7CFB\u7EDF\u7684\u60C5\u51B5\u4E0B\uFF0C\u76F4\u63A5\u5C06\u7EDF\u8BA1\u51FD\u6570\u7EC7\u5165\u7CFB\u7EDF\u3002</p><p>\u3010\u793A\u4F8B 11-20\u3011\u4E0B\u9762\u7684\u4EE3\u7801\u4F7F\u7528 Thread.sleep() \u6A21\u62DF\u4E00\u6BB5\u8017\u65F6\u7684\u51FD\u6570\u8C03\u7528\uFF0C\u73B0\u5728 Acccout.operation() \u672C\u8EAB\u5E76\u4E0D\u5177\u6709\u8BA1\u65F6\u529F\u80FD\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Account</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;operation ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u9700\u8981\u52A0\u5165\u7684\u8BA1\u65F6\u7EDF\u8BA1\u529F\u80FD\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeStat</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> time <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot; spend:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>TimeStat \u7C7B\u5B9E\u73B0\u4E86\u51FD\u6570\u7684\u8C03\u7528\u8BA1\u65F6\uFF0C\u5728\u8FDB\u5165\u51FD\u6570\u65F6\uFF0C\u53EF\u4EE5\u4F7F\u7528 start() \u65B9\u6CD5\u8868\u793A\u51FD\u6570\u8C03\u7528\u5F00\u59CB\uFF0C\u5728\u79BB\u5F00\u51FD\u6570\u65F6\uFF0C\u4F7F\u7528 end() \u65B9\u6CD5\u8868\u793A\u51FD\u6570\u8C03\u7528\u7ED3\u675F\u3002\u51FD\u6570\u8C03\u7528\u7ED3\u675F\u540E\uFF0C\u6253\u5370\u51FA\u5F53\u524D\u6B63\u5728\u8C03\u7528\u7684\u51FD\u6570\u540D\u79F0\u53CA\u5B9E\u9645\u7684\u7CFB\u7EDF\u8017\u65F6\u3002</p><p>\u4EE5\u4E0B\u4EE3\u7801\u5C06 TimeStat.start() \u548C TimeStat.end() \u7EC7\u5165 Account.operation() \u4E2D\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeStatWeaveGenerator</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassReader</span> cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassReader</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_MAXS <span class="token operator">|</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_FRAMES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TimeStatClassAdapter</span> classAdapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimeStatClassAdapter</span><span class="token punctuation">(</span>cw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cr<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>classAdapter<span class="token punctuation">,</span> <span class="token class-name">ClassReader</span><span class="token punctuation">.</span>SKIP_DEBUG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;bin/&quot;</span> <span class="token operator">+</span> className<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;\\\\. &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; / &quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;. class &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileOutputStream</span> fout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fout<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u4EE5\u4E0A\u4EE3\u7801\u4E2D\uFF0C\u7B2C 6 \u884C\u4F7F\u7528 TimeStatClassAdapter \u7C7B\u5B8C\u6210\u5177\u4F53\u7684\u5B57\u8282\u7801\u4FEE\u6539\u5DE5\u4F5C\u3002\u4FEE\u6539\u5B8C\u6210\u540E\uFF0C\u5728\u7B2C 9 ~ 12 \u884C\u5199\u5165 Class \u6587\u4EF6\uFF0C\u8986\u76D6\u539F\u6709\u7684 Class \u6587\u4EF6\u3002</p><p>TimeStatClassAdapter \u662F\u4E00\u4E2A ClassVisitor\uFF0C\u8FD9\u91CC\u9700\u8981\u8986\u76D6\u5B83\u7684 visitMethod() \u65B9\u6CD5\uFF0C\u5BF9 operation() \u65B9\u6CD5\u8FDB\u884C\u4FEE\u6539\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">TimeStatClassAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">ClassVisitor</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">TimeStatClassAdapter</span><span class="token punctuation">(</span><span class="token class-name">ClassVisitor</span> cv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>ASM5<span class="token punctuation">,</span> cv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">MethodVisitor</span> <span class="token function">visitMethod</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> access<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> 
                                     <span class="token keyword">final</span> <span class="token class-name">String</span> desc<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> exceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MethodVisitor</span> mv <span class="token operator">=</span> cv<span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodVisitor</span> wrappedMv <span class="token operator">=</span> mv<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mv <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;operation&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                wrappedMv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimeStatMethodAdapter</span><span class="token punctuation">(</span>mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> wrappedMv<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE5\u4E0A\u4EE3\u7801\u5728\u8BBF\u95EE\u65B9\u6CD5\u65F6\uFF0C\u5224\u65AD\u662F\u5426\u662F operation() \u65B9\u6CD5\uFF0C\u5982\u679C\u662F\uFF0C\u5219\u8FDB\u884C\u65B9\u6CD5\u5B57\u8282\u7801\u7684\u8C03\u6574\uFF0C\u5E76\u5C06\u8FD9\u4E2A\u5DE5\u4F5C\u59D4\u6258\u7ED9 TimeStatMethodAdapter \u5B8C\u6210\u3002\u4E0B\u9762\u662F TimeStatMethodAdapter \u7684\u5B9E\u73B0\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">TimeStatMethodAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">MethodVisitor</span> <span class="token keyword">implements</span> <span class="token class-name">Opcodes</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">TimeStatMethodAdapter</span><span class="token punctuation">(</span><span class="token class-name">MethodVisitor</span> mv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>ASM5<span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">visitMethodInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>INVOKESTATIC<span class="token punctuation">,</span> <span class="token string">&quot;geym/zbase/ch11/aop/timestat/TimeStat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;start&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visitInsn</span><span class="token punctuation">(</span><span class="token keyword">int</span> opcode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>opcode <span class="token operator">&gt;=</span> IRETURN <span class="token operator">&amp;&amp;</span> opcode <span class="token operator">&lt;=</span> RETURN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">visitMethodInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>INVOKESTATIC<span class="token punctuation">,</span> <span class="token string">&quot;geym/zbase/ch11/aop/timestat/TimeStat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mv<span class="token punctuation">.</span><span class="token function">visitInsn</span><span class="token punctuation">(</span>opcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D\uFF0C\u7B2C 6 \u884C\u7684 visitCode() \u5728\u65B9\u6CD5\u7684 Code \u5C5E\u6027\u88AB\u8BBF\u95EE\u65F6\u8C03\u7528\uFF0C\u56E0\u6B64\u5728\u8FD9\u91CC\u63D2\u5165\u5BF9 TimeStat.start() \u65B9\u6CD5\u7684\u8C03\u7528\uFF0C\u8868\u793A\u65B9\u6CD5\u7684\u5F00\u59CB\u3002\u5728\u7B2C 12 \u884C\uFF0C\u8986\u76D6\u4E86 visitInsn() \u65B9\u6CD5\uFF0C\u5F53\u8BBF\u95EE\u5230 xreturn \u6307\u4EE4\u65F6\uFF0C\u8FDB\u884C TimeStat.end() \u65B9\u6CD5\u8C03\u7528\uFF0C\u8868\u793A\u65B9\u6CD5\u5373\u5C06\u9000\u51FA\u3002\u4ECE\u5B57\u8282\u7801\u7684\u6307\u4EE4\u4E0A\uFF0C\u770B\u591A\u4E2A xretum \u6307\u4EE4\u662F\u8FDE\u7EED\u7684\uFF0C\u5982\u4E0B\u6240\u793A\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ireturn = 172,  // Oxac
lreturn = 173,  // Oxad
freturn = 174,  // Oxae
dreturn = 175,  // Oxaf
areturn = 176,  // OxbO
return = 177,   // Oxb1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u56E0\u6B64\u5728 visitInsn() \u65B9\u6CD5\u4E2D\uFF0C\u7B80\u5355\u5730\u901A\u8FC7\u6307\u4EE4\u503C\u83B7\u5F97\u8303\u56F4\uFF0C\u5224\u65AD\u662F\u5426\u4E3A xreturn \u8FD4\u56DE\u6307\u4EE4\u3002\u4F7F\u7528 TimeStatWeaveGenerator \u4FEE\u6539 Account.class\uFF0C\u5C06\u65F6\u95F4\u7EDF\u8BA1\u7684\u5B57\u8282\u7801\u7EC7\u5165\uFF0C\u5E76\u8FD0\u884C\u4EE5\u4E0B\u4EE3\u7801\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunTimeStatMainAfterGen</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Account</span> account <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        account<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u5F97\u5230\u8F93\u51FA\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>operation ...
geym.zbase.ch11.aop.timestat.Account.operation(Unknown Source) spend:10 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u5728 operation() \u65B9\u6CD5\u8C03\u7528\u7ED3\u675F\u540E\uFF0C\u7A0B\u5E8F\u8FD8\u8F93\u51FA\u4E86\u51FD\u6570\u8FD0\u884C\u7684\u8017\u65F6\u3002</p><h2 id="_11-4-\u8C01\u8BF4-java-\u592A\u523B\u677F-java-agent-\u8FD0\u884C\u65F6\u4FEE\u6539\u7C7B" tabindex="-1"><a class="header-anchor" href="#_11-4-\u8C01\u8BF4-java-\u592A\u523B\u677F-java-agent-\u8FD0\u884C\u65F6\u4FEE\u6539\u7C7B" aria-hidden="true">#</a> 11.4 \u8C01\u8BF4 Java \u592A\u523B\u677F\uFF1AJava Agent \u8FD0\u884C\u65F6\u4FEE\u6539\u7C7B</h2><p>JDK 1.5 \u5F15\u5165\u4E86 java.lang.instrument \u5305\uFF0C\u8BE5\u5305\u63D0\u4F9B\u4E86\u4E00\u4E9B\u5DE5\u5177\u5E2E\u52A9\u5F00\u53D1\u4EBA\u5458\u5728 Java \u7A0B\u5E8F\u8FD0\u884C\u65F6\u52A8\u6001\u4FEE\u6539\u7CFB\u7EDF\u4E2D\u7684 Class \u7C7B\u578B\u3002\u8BE5\u8F6F\u4EF6\u5305\u7684\u4E00\u4E2A\u5173\u952E\u7EC4\u4EF6\u4E3A Java Agent\u3002\u4ECE\u540D\u5B57\u770B\uFF0C\u4F3C\u4E4E\u53EF\u4EE5\u7406\u89E3\u6210 Java \u4EE3\u7406\uFF0C\u5B9E\u9645\u4E0A\uFF0C\u5B83\u7684\u529F\u80FD\u66F4\u50CF Class \u7C7B\u578B\u7684\u8F6C\u6362\u5668\uFF0C\u5B83\u53EF\u4EE5\u5728\u8FD0\u884C\u65F6\u63A5\u6536\u7A0B\u5E8F\u5916\u90E8\u8BF7\u6C42\uFF0C\u5BF9 Class \u7C7B\u578B\u8FDB\u884C\u4FEE\u6539\u3002</p><p>\u5728\u547D\u4EE4\u884C\u6267\u884C java \u547D\u4EE4\uFF0C\u53EF\u4EE5\u770B\u5230 java \u547D\u4EE4\u7684\u5E2E\u52A9\uFF0C\u4E0D\u96BE\u53D1\u73B0\u5176\u4E2D\u6709\u4E00\u4E2A javaagent \u9009\u9879\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-javaagent:&lt;jarpath&gt;[=&lt;options&gt;]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u52A0\u8F7D Java \u7F16\u7A0B\u8BED\u8A00\u4EE3\u7406\uFF0C\u8BF7\u53C2\u9605 java.lang.instrument</p><p>\u4E5F\u5C31\u662F\u8BF4\uFF0C\u5728 Java \u7A0B\u5E8F\u8FD0\u884C\u65F6\u53EF\u4EE5\u6307\u5B9A\u4E00\u4E2A Java Agent \u4F5C\u4E3A\u5176\u7F16\u7A0B\u8BED\u8A00\u4EE3\u7406\u3002</p><h3 id="_11-4-1-\u4F7F\u7528-javaagent-\u53C2\u6570\u542F\u52A8-java-\u865A\u62DF\u673A" tabindex="-1"><a class="header-anchor" href="#_11-4-1-\u4F7F\u7528-javaagent-\u53C2\u6570\u542F\u52A8-java-\u865A\u62DF\u673A" aria-hidden="true">#</a> 11.4.1 \u4F7F\u7528 -javaagent \u53C2\u6570\u542F\u52A8 Java \u865A\u62DF\u673A</h3><p>\u53C2\u6570 -javaagent \u53EF\u4EE5\u7528\u4E8E\u6307\u5B9A\u4E00\u4E2A jar \u5305\uFF0C\u4E14\u5BF9\u8BE5 jar \u5305\u6709\u5982\u4E0B\u8981\u6C42\uFF1A</p><ol><li><p>\u8FD9\u4E2A jar \u5305\u7684 MANIFEST.MF \u6587\u4EF6\u5FC5\u987B\u6307\u5B9A Premain-Class \u9879\u3002</p></li><li><p>Premain-Class \u6307\u5B9A\u7684\u90A3\u4E2A\u7C7B\u5FC5\u987B\u5B9E\u73B0 premain() \u65B9\u6CD5\u3002</p></li></ol><p>Premain-Class \u4EC5\u4ECE\u82F1\u6587\u5B57\u9762\u4E0A\u7406\u89E3\uFF0C\u5C31\u662F\u8FD0\u884C\u5728 main() \u51FD\u6570\u4E4B\u524D\u7684\u7C7B\u3002\u5F53 Java \u865A\u62DF\u673A\u542F\u52A8\u65F6\uFF0C\u5728\u6267\u884C main() \u51FD\u6570\u4E4B\u524D\uFF0C\u865A\u62DF\u673A\u4F1A\u5148\u8FD0\u884C -javaagent \u6240\u6307\u5B9A jar \u5305\u5185 Premain-Class \u7C7B\u7684 premain() \u65B9\u6CD5\u3002premain() \u65B9\u6CD5\u7684\u7B7E\u540D\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5176\u4E2D\uFF0CagentArgs \u662F\u901A\u8FC7\u547D\u4EE4\u884C\u4F20\u7ED9 Java Agent \u7684\u53C2\u6570\uFF0Cinst \u63D0\u4F9B Java Class \u5B57\u8282\u7801\u8F6C\u6362\u7684\u5DE5\u5177\u3002Instrumentation \u7C7B\u7684\u5E38\u7528 API \u5982\u4E0B\uFF1A</p><ul><li><p>void addTransformer(ClassFileTransformer transformer, boolean canRetransform)</p><p>\u589E\u52A0\u4E00\u4E2A Class \u6587\u4EF6\u7684\u8F6C\u6362\u5668\uFF0C\u7528\u4E8E\u6539\u53D8 Class \u4E8C\u8FDB\u5236\u6D41\u7684\u6570\u636E\uFF0C\u53C2\u6570 canRetransform \u7528\u4E8E\u8BBE\u7F6E\u662F\u5426\u5141\u8BB8\u91CD\u65B0\u8F6C\u6362\u3002</p></li><li><p>void redefineClasses(ClassDefinition... definitions)</p><p>\u5728\u7C7B\u52A0\u8F7D\u4E4B\u524D\uFF0C\u91CD\u65B0\u5B9A\u4E49 Class \u6587\u4EF6\u3002ClassDefinition \u8868\u793A\u5BF9\u4E00\u4E2A\u7C7B\u65B0\u7684\u5B9A\u4E49\u3002\u5982\u679C\u5728\u7C7B\u52A0\u8F7D\u4E4B\u540E\uFF0C\u9700\u8981\u4F7F\u7528 retransformClasses() \u65B9\u6CD5\u91CD\u65B0\u5B9A\u4E49\u7C7B\u3002</p></li><li><p>boolean removeTransformer(ClassFileTransformer transformer)</p><p>\u79FB\u51FA\u4E00\u4E2A\u7C7B\u8F6C\u6362\u5668\u3002</p></li><li><p>void retransformClasses(Class&lt;?&gt;... classes)</p><p>\u5728\u7C7B\u52A0\u8F7D\u4E4B\u540E\uFF0C\u91CD\u65B0\u5B9A\u4E49 Class\u3002</p></li></ul><p>\u3010\u793A\u4F8B 11-21\u3011\u4E0B\u9762\u7684\u4F8B\u5B50\u5B9A\u4E49\u4E86\u4E00\u4E2A Java Agent\uFF0C\u8FD9\u4E2A Agent \u6253\u5370\u51FA\u5728 main() \u51FD\u6570\u8FD0\u884C\u540E\uFF0C\u7CFB\u7EDF\u8F7D\u5165\u7684\u7C7B\u578B\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PreMainTraceAgent</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">UnmodifiableClassException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;agentArgs:&quot;</span> <span class="token operator">+</span> agentArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inst<span class="token punctuation">.</span><span class="token function">addTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassFileTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> classBeingRedefined<span class="token punctuation">,</span>
                                    <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span>
                    <span class="token keyword">throws</span> <span class="token class-name">IllegalClassFormatException</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;load Class:&quot;</span> <span class="token operator">+</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> classfileBuffer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u4EE3\u7801\u7B2C 2 \u884C\uFF0C\u5B9A\u4E49\u4E86 Agent \u7684 premain() \u65B9\u6CD5\uFF0C\u8BE5\u65B9\u6CD5\u4F1A\u5728 main() \u51FD\u6570\u6267\u884C\u524D\u8C03\u7528\u3002</p><p>\u4EE3\u7801\u7B2C 4 \u884C\uFF0C\u6253\u5370\u4E86\u4F20\u9012\u7ED9 Agent \u7684\u53C2\u6570\u3002</p><p>\u4EE3\u7801\u7B2C 5 \u884C\uFF0C\u52A0\u5165\u4E86\u4E00\u4E2A\u7C7B\u8F6C\u6362\u5668\u3002\u8FD9\u91CC\u4F7F\u7528\u533F\u540D\u5185\u90E8\u7C7B\uFF0C\u5B9A\u4E49\u4E86\u4E00\u4E2A\u7C7B\u8F6C\u6362\u5668\u3002\u8FD9\u4E2A\u7C7B\u8F6C\u6362\u5668\u5F88\u7B80\u5355\uFF0C\u53EA\u662F\u7B80\u5355\u5730\u6253\u5370\u51FA\u83B7\u53D6\u7684\u7C7B\u540D\uFF0C\u4E0D\u505A\u5B9E\u8D28\u6027\u8F6C\u6362\u3002</p><p>\u4EE3\u7801\u7B2C 7 \u884C\u4E3A\u7C7B\u8F6C\u6362\u5668\u63A5\u53E3\u7684 transform() \u65B9\u6CD5\uFF0C\u7528\u4E8E\u5B8C\u6210\u7C7B\u7684\u8F6C\u6362\u3002\u8BE5\u65B9\u6CD5\u5B9A\u4E49\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> 
                 <span class="token class-name">String</span> className<span class="token punctuation">,</span> 
                 <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> classBeingRedefined<span class="token punctuation">,</span>
                 <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">,</span> 
                 <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">IllegalClassFormatException</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D\uFF0Cloader \u4E3A\u7C7B\u7684\u52A0\u8F7D\u5668\uFF0CclassName \u8868\u793A\u7C7B\u7684\u5168\u9650\u5B9A\u540D\uFF0C\u6BD4\u5982 &quot;java/lang/String&quot;\u3002\u53C2\u6570 classBeingRedefined \u8868\u793A\uFF1A\u5982\u679C\u88AB\u91CD\u5B9A\u4E49\u6216\u91CD\u8F6C\u6362\u89E6\u53D1\uFF0C\u5219\u4E3A\u91CD\u5B9A\u4E49\u6216\u91CD\u8F6C\u6362\u7684\u7C7B\uFF1B\u5982\u679C\u662F\u7C7B\u52A0\u8F7D\uFF0C\u5219\u4E3A null\u3002\u53C2\u6570 protectionDomain \u8868\u793A\u8981\u5B9A\u4E49\u6216\u91CD\u5B9A\u4E49\u7684\u7C7B\u7684\u4FDD\u62A4\u57DF\u3002\u53C2\u6570 classfileBuffer \u8868\u793A\u7C7B\u6587\u4EF6\u683C\u5F0F\u7684\u4E8C\u8FDB\u5236\u6570\u636E\uFF08\u53EA\u8BFB\uFF0C\u4E0D\u80FD\u4FEE\u6539\uFF09\u3002\u8BE5\u65B9\u6CD5\u7684\u8FD4\u56DE\u503C\u4E3A\u91CD\u65B0\u5B9A\u4E49\u7684\u65B0\u7684\u7C7B\u7684\u4E8C\u8FDB\u5236\u6570\u636E\u3002</p><p>\u5C06\u4EE5\u4E0A\u7684 Java Agent \u6253\u5305\u6210 jat.jar\uFF0C\u5E76\u8BBE\u7F6E META-INF/MANIFEST.MF \u6587\u4EF6\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Manifest-Version: 1.0
Premain-Class: geym.zbase.ch11.agent.PreMainTraceAgent 
Can-Redine-Classes: true
Can-Retransform-Classes: true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u5C31\u5B8C\u6210\u4E86\u4E00\u4E2A\u4FDD\u5B58\u6709\u5408\u6CD5 Java Agent \u7684 jar \u5305\u3002\u4F7F\u7528\u4EE5\u4E0B\u4EE3\u7801\u6D4B\u8BD5\u8FD9\u4E2A jat.jar\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunAccountMain</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Account</span> account <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        account<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u4EE3\u7801\u4E2D\u7684 Account \u4E3A 11.3.2 \u8282\u4E2D\u7684 Account \u7C7B\u3002\u4F7F\u7528 Java \u865A\u62DF\u673A\u53C2\u6570 -javaagent:d:/jat.jar \u8FD0\u884C\u4EE3\u7801\uFF0C\u8F93\u51FA\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>agentArgs:null
load Class:sun/launcher/LauncherHelper
load Class:geym/zbase/ch11/agent/RunAccountMain
load Class:java/lang/Void
load Class:geym/zbase/ch11/aop/timestat/Account
load Class:java/lang/InterruptedException
operation ...
load Class:java/lang/Shutdown
load Class:java/lang/Shutdown$Lock
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0CPreMainTraceAgent \u5DF2\u7ECF\u53EF\u4EE5\u6B63\u5E38\u5DE5\u4F5C\u4E86\uFF0C\u8FD9\u91CC\u6240\u52A0\u8F7D\u7684\u7C7B\u578B\uFF0C\u5E76\u975E\u7CFB\u7EDF\u4E2D\u6240\u6709\u7684 Class \u7C7B\u3002\u5B9E\u9645\u4E0A\uFF0C\u5728 jat.jar \u6267\u884C\u4E4B\u524D\u7684\u6240\u6709\u5DF3\u52A0\u8F7D\u7684\u7C7B\u578B\u90FD\u662F\u65E0\u6CD5\u6355\u83B7\u7684\u3002\u56E0\u6B64\uFF0C\u5927\u91CF\u7684\u7CFB\u7EDF\u6838\u5FC3\u7C7B\u4F1A\u4E22\u5931\uFF0C\u4F46\u662F\u5E94\u7528\u7A0B\u5E8F\u7684\u7C7B\u90FD\u5728 main() \u51FD\u6570\u6267\u884C\u4E4B\u540E\u52A0\u8F7D\uFF0C\u56E0\u6B64\u90FD\u53EF\u4EE5\u901A\u8FC7\u8FD9\u79CD\u65B9\u5F0F\u6355\u83B7\uFF0C\u4F8B\u5982\u4E0A\u8FF0\u4EE3\u7801\u7684\u5B57\u4F53\u52A0\u7C97\u90E8\u5206\u3002</p><h3 id="_11-4-2-\u4F7F\u7528-java-agent-\u4E3A\u51FD\u6570\u589E\u52A0\u8BA1\u65F6\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#_11-4-2-\u4F7F\u7528-java-agent-\u4E3A\u51FD\u6570\u589E\u52A0\u8BA1\u65F6\u529F\u80FD" aria-hidden="true">#</a> 11.4.2 \u4F7F\u7528 Java Agent \u4E3A\u51FD\u6570\u589E\u52A0\u8BA1\u65F6\u529F\u80FD</h3><p>\u5728 11.3.2 \u8282\u4E2D\uFF0C\u5DF2\u7ECF\u901A\u8FC7 ASM \u8FDB\u884C\u4E86\u5B57\u8282\u7801\u7EC7\u5165\uFF0C\u4F7F Account.operation() \u65B9\u6CD5\u5177\u6709\u8BA1\u65F6\u529F\u80FD\uFF0C\u4F46\u63D0\u4F9B\u7684\u7EC7\u5165\u65B9\u5F0F\u4E0D\u591F\u7075\u6D3B\uFF0C\u8981\u6C42\u5728 Account \u7C7B\u8FDB\u884C javac \u7F16\u8BD1\u540E\uFF0C\u518D\u8FDB\u884C\u57FA\u4E8E\u6587\u4EF6\u7684\u7EC7\u5165\u3002\u8FD9\u79CD\u505A\u6CD5\u867D\u7136\u53EF\u884C\uFF0C\u4F46\u662F\u8FC7\u4E8E\u70E6\u7410\u3002\u6709\u4E86 Java Agent \u7684\u652F\u6301\uFF0C\u5C31\u53EF\u4EE5\u5927\u5927\u6539\u8FDB\u8FD9\u79CD\u65B9\u5F0F\u3002</p><p>\u3010\u793A\u4F8B 11-22\u3011\u4E0B\u9762\u7684\u4EE3\u7801\u5C55\u793A\u4E86\u901A\u8FC7 Java Agent \u76F4\u63A5\u8FDB\u884C\u5B57\u8282\u7801\u7EC7\u5165\u7684\u65B9\u5F0F\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PreMainAddTimeStatAgent</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">UnmodifiableClassException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;agentArgs:&quot;</span> <span class="token operator">+</span> agentArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inst<span class="token punctuation">.</span><span class="token function">addTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassFileTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> classBeingRedefined<span class="token punctuation">,</span>
                                    <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span>
                    <span class="token keyword">throws</span> <span class="token class-name">IllegalClassFormatException</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;geym/zbase/ch11/aop/timestat/Account&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;meet geym.zbase.ch11.aop.timestat.Account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">ClassReader</span> cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassReader</span><span class="token punctuation">(</span>classfileBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_MAXS <span class="token operator">|</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_FRAMES<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">TimeStatClassAdapter</span> classAdapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimeStatClassAdapter</span><span class="token punctuation">(</span>cw<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cr<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>classAdapter<span class="token punctuation">,</span> <span class="token class-name">ClassReader</span><span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> classfileBuffer<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u4EE3\u7801\u7B2C 5 \u884C\uFF0C\u52A0\u5165\u4E86\u7C7B\u8F6C\u6362\u5668\uFF0C\u8FD9\u91CC\u4F9D\u7136\u4F7F\u7528\u4E86\u533F\u540D\u5185\u90E8\u7C7B\u7684\u5F62\u5F0F\u5B9A\u4E49\u8FD9\u4E2A\u8F6C\u6362\u5668\u3002\u7B2C 9 \u884C\u5224\u65AD\u5F53\u524D\u52A0\u8F7D\u7684\u7C7B\u662F\u5426\u4E3A Account\uFF0C\u5982\u679C\u662F\uFF0C\u5219\u8FDB\u884C\u5B57\u8282\u7801\u7EC7\u5165\u3002\u7B2C 11 ~ 15 \u884C\u4F7F\u7528 TimeStatClassAdapter \u5BF9 Account \u8FDB\u884C\u4FEE\u6539\u3002</p><p>\u5C06 PreMainAddTimeStatAgent \u6253\u5305\u6210 ja.jar\uFF0C\u8BBE\u7F6E META-INF/MANIFEST.MF \u4E3A\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Manifest-Version: 1.0
Premain-Class: geym.zbase.ch11.agent.PreMainAddTimeStatAgent
Can-Redine-Classes: true
Can-Retransform-Classes: true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7528 Java \u865A\u62DF\u673A\u53C2\u6570 -javaagent:d:/ja.jar \u8FD0\u884C\u4E0A\u4E00\u8282\u4E2D\u7684 RunAccountMain\uFF0C\u5F97\u5230\u5982\u4E0B\u8F93\u51FA\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>agentArgs:null
sun/launcher/LauncherHelper
geym/zbase/ch11/agent/RunAccountMain
java/lang/Void
meet geym.zbase.ch11.aop.timestat.Account
java/lang/InterruptedException
geym/zbase/ch11/aop/timestat/TimeStat
operation ...
geym.zbase.ch11.aop.timestat.Account.operation(Unknown Source) spend:10
java/lang/Shutdown
java/lang/Shutdown$Lock
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u4F7F\u7528\u4E86 Java Agent \u540E\uFF0C\u5DF2\u7ECF\u53EF\u4EE5\u5728 main() \u51FD\u6570\u8FD0\u884C\u65F6\u52A8\u6001\u4FEE\u6539 Account \u7684\u5B57\u8282\u7801\u5E76\u4F7F\u4E4B\u751F\u6548\uFF0C\u56E0\u6B64\u51FD\u6570\u7684\u6267\u884C\u65F6\u95F4\u4E5F\u51FA\u73B0\u5728\u8F93\u51FA\u4E2D\uFF08\u5B57\u4F53\u52A0\u7C97\u90E8\u5206\uFF09\u3002</p><p><strong>\u6CE8\u610F</strong>\uFF1A\u4F7F\u7528 Java Agent \u53EF\u4EE5\u5728 Class \u7C7B\u578B\u88AB\u52A0\u8F7D\u524D\u5BF9\u7C7B\u8FDB\u884C\u91CD\u5B9A\u4E49\uFF0C\u52A8\u6001\u4FEE\u6539\u6307\u5B9A\u7684 Class \u4E8C\u8FDB\u5236\u6570\u636E\u5E76\u4F7F\u4E4B\u751F\u6548\u3002\u8FD9\u79CD\u65B9\u5F0F\u6BD4\u57FA\u4E8E\u6587\u4EF6\u8FDB\u884C\u5B57\u8282\u7801\u7EC7\u5165\u66F4\u5FEB\u6377\u6709\u6548\u3002</p><h3 id="_11-4-3-\u52A8\u6001\u91CD\u8F6C\u6362\u7C7B" tabindex="-1"><a class="header-anchor" href="#_11-4-3-\u52A8\u6001\u91CD\u8F6C\u6362\u7C7B" aria-hidden="true">#</a> 11.4.3 \u52A8\u6001\u91CD\u8F6C\u6362\u7C7B</h3><p>\u5728\u524D\u4E24\u8282\u4E2D\uFF0C\u4F7F\u7528 Java Agent \u65B9\u5F0F\u9700\u8981\u5728 Java \u7A0B\u5E8F\u542F\u52A8\u65F6\u52A0\u5165 -javaagent \u53C2\u6570\uFF0C\u5E76\u4E14\u53EA\u80FD\u5728\u7C7B\u52A0\u8F7D\u524D\u8FDB\u884C\u91CD\u5B9A\u4E49\u3002\u4E8B\u5B9E\u4E0A\uFF0CJava Agent \u4E5F\u652F\u6301\u5728\u7C7B\u52A0\u8F7D\u540E\u8FDB\u884C\u52A8\u6001\u4FEE\u6539\u3002\u8FD9\u9700\u8981\u4F7F\u7528 Java Agent \u7684\u53E6\u5916\u4E00\u4E2A\u65B9\u6CD5\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>agentmain() \u65B9\u6CD5\u4E0E premain() \u65B9\u6CD5\u7684\u53C2\u6570\u6709\u7740\u540C\u6837\u7684\u542B\u4E49\u3002\u4F46\u662F agentmain() \u65B9\u6CD5\u662F\u5728\u4E00\u4E2A Java Agent \u88AB\u9644\u52A0\uFF08attach\uFF09\u5230 Java \u865A\u62DF\u673A\u4E0A\u65F6\u6267\u884C\u7684\u3002\u5F53 Java Agent \u88AB\u9644\u52A0\u5230 Java \u865A\u62DF\u673A\u4E0A\u65F6\uFF0CJava \u7A0B\u5E8F\u7684 main() \u51FD\u6570\u4E00\u822C\u5DF1\u7ECF\u542F\u52A8\uFF0C\u5E76\u4E14\u7A0B\u5E8F\u5F88\u53EF\u80FD\u5DF2\u7ECF\u8FD0\u884C\u4E86\u76F8\u5F53\u957F\u7684\u65F6\u95F4\u3002\u6B64\u65F6\uFF0C\u901A\u8FC7 Instrumentation.retransformClasses() \u65B9\u6CD5\u53EF\u4EE5\u4F7F\u7528\u7C7B\u8F6C\u6362\u5668\u91CD\u65B0\u8F6C\u6362\u7ED9\u5B9A\u7684 Class \u7C7B\u578B\u5E76\u4F7F\u4E4B\u751F\u6548\u3002\u4E3A\u6F14\u793A\u8FD9\u4E2A\u529F\u80FD\uFF0C\u8BF7\u770B\u4E0B\u9762\u7684\u793A\u4F8B\u3002</p><p>\u3010\u793A\u4F8B 11-23\u3011\u4E0B\u9762\u8FD9\u6BB5\u4EE3\u7801\u4E0D\u65AD\u5730\u8C03\u7528 Account.operation() \u65B9\u6CD5\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunLoopAccountMain</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Account</span> account <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                account<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE5\u4E0A\u4EE3\u7801\u6301\u7EED\u8C03\u7528 operation() \u65B9\u6CD5\uFF0C\u5E76\u6BCF\u6B21\u4F11\u7720 1 \u79D2\u3002\u4E0D\u9700\u8981\u52A0\u4EFB\u4F55 Java \u865A\u62DF\u673A\u53C2\u6570\u8FD0\u884C\u8FD9\u6BB5\u4EE3\u7801\uFF0C\u7A0B\u5E8F\u4F1A\u6301\u7EED\u51FA\u73B0\u4EE5\u4E0B\u8F93\u51FA\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>operation ...
operation ...
operation ...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u7740\uFF0C\u4FEE\u6539\u4E0A\u8282\u4E2D\u7684 PreMainAddTimeStatAgent \u7C7B\uFF0C\u5E76\u589E\u52A0\u4EE5\u4E0B\u65B9\u6CD5\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> 
    <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">UnmodifiableClassException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Agent Main called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;agentArgs:&quot;</span> <span class="token operator">+</span> agentArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">premain</span><span class="token punctuation">(</span>agentArgs<span class="token punctuation">,</span> inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    inst<span class="token punctuation">.</span><span class="token function">retransformClasses</span><span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u4EE3\u7801\u5B9E\u73B0\u4E86 agentmain() \u65B9\u6CD5\uFF0C\u8BE5\u65B9\u6CD5\u4F1A\u5728\u51FD\u6570 Java Agent \u88AB\u9644\u52A0\u5230\u865A\u62DF\u673A\u4E0A\u65F6\u6267\u884C\u3002agentmain() \u65B9\u6CD5\u59D4\u6258 premain() \u65B9\u6CD5\u8FDB\u884C\u7C7B\u8F6C\u6362\u5668\u7684\u6CE8\u518C\uFF0C\u5E76\u5728\u6700\u540E\u4F7F\u7528\u4E86 retransformClasses() \u65B9\u6CD5\u8981\u6C42\u4F7F\u7528\u6CE8\u518C\u7684\u7C7B\u8F6C\u6362\u5668\u91CD\u8F6C\u6362\u7C7B Accout\u3002</p><p>\u5C06\u4FEE\u6539\u540E\u7684 PreMainAddTimeStatAgent \u7C7B\u6253\u5305\u4E3A ja.jar\uFF0C\u5E76\u4FEE\u6539 META-INF/MANIFEST.MF \u4E3A\uFF08\u589E\u52A0\u4E86 Agent-Class\uFF09\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Manifest-Version: 1.0
Agent-Class: geym.zbase.ch11.agent.PreMainAddTimeStatAgent
Premain-Class: geym.zbase.ch11.agent.PreMainAddTimeStatAgent 
Can-Redine-Classes: true
Can-Retransform-Classes: true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u589E\u52A0\u7684 Agent-Class \u5C5E\u6027\u8868\u793A\uFF1A\u5F53\u6301\u6709 Java Agent \u7684 jar\uFF08\u8FD9\u91CC\u662F ja.jar\uFF09\u88AB\u9644\u52A0\u5230 Java \u865A\u62DF\u673A\u4E0A\u65F6\uFF0C\u6267\u884C\u8BE5\u5C5E\u6027\u6307\u5B9A\u7C7B\u7684 agentmain() \u65B9\u6CD5\uFF08\u8FD9\u91CC\u5C31\u662F PreMainAddTimeStatAgent. agentmain() \u65B9\u6CD5\uFF09\u3002</p><p>\u5230\u6B64\uFF0CJava Agent \u5DF1\u7ECF\u51C6\u5907\u5B8C\u6BD5\uFF0C\u5269\u4E0B\u7684\u95EE\u9898\u5C31\u662F\u5982\u4F55\u5C06 Java Agent\uFF08ja.jar\uFF09\u9644\u52A0\u5230\u6B63\u5728\u6267\u884C\u7684 RunLoopAccountMain \u4E0A\u3002\u8981\u5B9E\u73B0\u8FD9\u4E2A\u529F\u80FD\uFF0C\u9700\u8981\u501F\u52A9 %JAVA_HOME%/lib/tools.jar\uFF0C\u8BE5 jar \u5305\u63D0\u4F9B\u4E86\u4E00\u4E9B\u865A\u62DF\u673A\u64CD\u4F5C\u7684\u5DE5\u5177\u7C7B\uFF0C\u5C06\u8BE5 jar \u5305\u52A0\u5165\u5DE5\u7A0B\u7684 ClassPath \u4E2D\uFF0C\u5982\u56FE11.18 \u6240\u793A\u3002</p><p><img src="`+_+`" alt="\u56FE11-18" loading="lazy"></p><p>\u56FE11.18 tools.jar \u5F15\u5165</p><p>\u63A5\u7740\uFF0C\u4F7F\u7528 tools.jar \u4E2D\u7684\u5DE5\u5177\u7C7B\uFF0C\u5C06 ja.jar \u9644\u52A0\u5230\u76EE\u6807 Java \u8FDB\u7A0B\u4E2D\uFF0C\u5982\u4E0B\u6240\u793A\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AttachToolMain</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">AttachNotSupportedException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span>
            <span class="token class-name">AgentLoadExceptiont</span><span class="token punctuation">,</span> <span class="token class-name">AgentlnitializationException</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VirtualMachineDescriptor</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">VirtualMachine</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">VirtualMachineDescriptor</span> vmd <span class="token operator">:</span> list<span class="token punctuation">)</span> 
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>vmd<span class="token punctuation">.</span><span class="token function">displayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;RunLoopAccountMain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">VirtualMachine</span> virtualmachine <span class="token operator">=</span> <span class="token class-name">VirtualMachine</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>vmd<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                virtualmachine<span class="token punctuation">.</span><span class="token function">loadAgent</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\\\ja.jar&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;argument for agent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                virtualmachine<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u4EE3\u7801\u7684\u4E3B\u8981\u529F\u80FD\u662F\u5C06 D:\\ja.jar \u4E2D\u7684 Java Agent \u9644\u52A0\u5230\u6307\u5B9A\u7684 Java \u7A0B\u5E8F\u4E2D\u3002\u4EE3\u7801\u7B2C 5 \u884C\u83B7\u5F97\u5F53\u524D\u7CFB\u7EDF\u4E2D\u6240\u6709\u7684 Java \u865A\u62DF\u673A\uFF08\u6709\u70B9\u50CF jps \u547D\u4EE4\uFF09\u3002\u4EE3\u7801\u7B2C 8 \u884C\u9650\u5B9A\u53EA\u5BF9\u4EE5 RunLoopAccountMain \u4E3A\u4E3B\u51FD\u6570\u7684\u865A\u62DF\u673A\u7A0B\u5E8F\u8FDB\u884C\u64CD\u4F5C\u3002\u4EE3\u7801\u7B2C 9 \u884C\u4F7F\u7528 attach() \u65B9\u6CD5\u8FDE\u63A5\u4E0A\u7ED9\u5B9A\u7684\u865A\u62DF\u673A\uFF08\u8FD9\u91CC\u5C31\u662F RunLoopAccountMain\uFF09\u3002\u4EE3\u7801\u7B2C 10 \u884C\u5C06\u51C6\u5907\u597D\u7684 ja.jar \u8F7D\u5165\u76EE\u6807\u865A\u62DF\u673A\uFF0C\u5E76\u4F20\u5165\u4E86\u4E00\u4E2A\u53C2\u6570 &quot;argument for agent&quot;<strong>\u3002</strong></p><p>\u4FDD\u6301 RunLoopAccountMain \u6301\u7EED\u8FD0\u884C\uFF0C\u5E76\u540C\u65F6\u8FD0\u884C AttachToolMain\uFF0C\u7ED3\u675F\u540E\u6253\u5370\u51FA &quot;ok&quot; \u5B57\u6837\uFF0C\u518D\u89C2\u5BDF RunLoopAccountMain \u7684\u8F93\u51FA\uFF0C\u53EF\u4EE5\u770B\u5230\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>operation ...
operation ...
Agent Main called
agentArgs:argument for agent
agentArgs:argument for agent
meet geym.zbase.ch11.aop.timestat.Account
geym/zbase/ch11/aop/timestat/TimeStat
operation ...
geym.zbase.ch11.aop.timestat.Account.operation(Unknown Source) spend:10 
operation ...
geym.zbase.ch11.aop.timestat.Account.operation(Unknown Source) spend:10
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7531\u8FD9\u6BB5\u8F93\u51FA\u53EF\u77E5\uFF0C\u5728 RunLoopAccountMain \u52A0\u8F7D\u4E86 PreMainAddTimeStatAgent \u4E4B\u540E\uFF0Cagentmain() \u88AB\u8C03\u7528\uFF0C\u63A5\u7740\u91CD\u65B0\u8FD0\u884C\u4E86\u7C7B\u8F6C\u6362\u5668\uFF0C\u5E76\u4E3A Account \u7C7B\u52A0\u5165\u4E86\u51FD\u6570\u8C03\u7528\u7684\u8BA1\u65F6\u529F\u80FD\u3002\u5728\u7C7B\u8F6C\u6362\u7ED3\u675F\u540E\uFF0C\u6BCF\u6B21 operation() \u64CD\u4F5C\u540E\u90FD\u4F1A\u8F93\u51FA\u51FD\u6570\u8C03\u7528\u7684\u8017\u65F6\u3002\u800C\u8FD9\u4E00\u5207\u90FD\u4E0D\u9700\u8981\u91CD\u542F\u5E94\u7528\uFF0C\u751A\u81F3\u4E0D\u9700\u8981\u4EFB\u4F55\u989D\u5916\u53C2\u6570\u7684\u652F\u6301\u3002</p><h3 id="_11-4-4-\u6709\u5173-java-agent-\u7684\u603B\u7ED3" tabindex="-1"><a class="header-anchor" href="#_11-4-4-\u6709\u5173-java-agent-\u7684\u603B\u7ED3" aria-hidden="true">#</a> 11.4.4 \u6709\u5173 Java Agent \u7684\u603B\u7ED3</h3><p>Java Agent \u63D0\u4F9B\u4E86\u4E00\u4E2A\u5F88\u597D\u7684\u65B9\u5F0F\u52A8\u6001\u4FEE\u6539\u7C7B\u7684\u5B9E\u73B0\uFF0C\u800C ASM \u63D0\u4F9B\u4E86\u4E00\u5957\u9AD8\u6548\u7684 Class \u4E8C\u8FDB\u5236\u6D41\u521B\u5EFA\u548C\u4FEE\u6539\u5DE5\u5177\u3002ASM \u53EF\u4EE5\u8BA9 Java Agent \u77E5\u9053\u5982\u4F55\u4FEE\u6539\u6216\u8005\u521B\u5EFA\u4E00\u4E2A\u7C7B\uFF0C\u800C Java Agent \u53EF\u4EE5\u8BA9 ASM \u66F4\u597D\u3001\u66F4\u65B9\u4FBF\u5730\u8FDB\u884C\u7C7B\u7684\u4FEE\u6539\u3002\u4E24\u8005\u7684\u7ED3\u5408\u53EF\u4EE5\u5927\u5927\u589E\u52A0 Java \u5E73\u53F0\u7684\u7075\u6D3B\u6027\u3002</p><h2 id="_11-5-\u4E0E\u65F6\u4FF1\u8FDB-\u52A8\u6001\u65B9\u6CD5\u8C03\u7528" tabindex="-1"><a class="header-anchor" href="#_11-5-\u4E0E\u65F6\u4FF1\u8FDB-\u52A8\u6001\u65B9\u6CD5\u8C03\u7528" aria-hidden="true">#</a> 11.5 \u4E0E\u65F6\u4FF1\u8FDB\uFF1A\u52A8\u6001\u65B9\u6CD5\u8C03\u7528</h2><p>\u5728 JDK 1.7 \u4E2D\u5F15\u5165\u4E86\u4E00\u4E2A invoke \u6307\u4EE4\u2014\u2014invokedynamic\uFF0C\u8BE5\u6307\u4EE4\u7684\u76EE\u7684\u662F\u66F4\u597D\u5730\u652F\u6301 Java \u865A\u62DF\u673A\u5E73\u53F0\u4E0A\u7684\u52A8\u6001\u8BED\u8A00\uFF0C\u4EE5\u53CA Java 8 \u4E2D\u7684 lambda \u8868\u8FBE\u5F0F\u3002\u5728 Java 8 \u4E4B\u524D\uFF0C\u751A\u81F3\u65E0\u6CD5\u4F7F\u7528 Java \u7F16\u8BD1\u5668\u4EA7\u751F\u7684 invokednamic \u6307\u4EE4\uFF0C\u5B9E\u9645\u4E0A\u5728 JDK 1.7 \u4E2D\u5DF2\u7ECF\u652F\u6301\u4E86\u8BE5\u6307\u4EE4\u3002\u968F\u7740 invokednamic \u7684\u5F15\u5165\uFF0CJava 1.7 \u4E2D\u8FD8\u5F15\u5165\u4E86\u4E00\u4E9B\u6982\u5FF5\uFF0C\u4E3A\u4E86\u66F4\u597D\u5730\u7406\u89E3 invokedynamic\uFF0C\u8FD9\u91CC\u5148\u6765\u4ECB\u7ECD\u4E00\u4E0B\u76F8\u5173\u6982\u5FF5\u3002</p><ul><li><p>\u65B9\u6CD5\u53E5\u67C4\uFF08Method Handler\uFF09\uFF1A\u65B9\u6CD5\u53E5\u67C4\u5F88\u50CF\u4E00\u4E2A\u65B9\u6CD5\u6307\u9488\u6216\u8005\u4EE3\u7406\u3002\u901A\u8FC7\u65B9\u6CD5\u53E5\u67C4\uFF0C\u53EF\u4EE5\u8C03\u7528\u4E00\u4E2A\u65B9\u6CD5\u3002\u8BFB\u8005\u5E94\u8BE5\u8FD8\u8BB0\u5F97\u5728 Class \u6587\u4EF6\u7684\u5E38\u91CF\u6C60\u4E2D\uFF0C\u6709\u4E00\u9879\u5E38\u91CF\u7C7B\u578B\u4E3A CONSTANT_MethodHandle\uFF0C\u8FD9\u5C31\u662F\u65B9\u6CD5\u53E5\u67C4\u3002</p></li><li><p>\u8C03\u7528\u70B9\uFF08CallSite\uFF09\uFF1A\u8C03\u7528\u70B9\u662F\u5BF9\u65B9\u6CD5\u53E5\u67C4\u7684\u5C01\u88C5\uFF0C\u901A\u8FC7\u8C03\u7528\u70B9\u53EF\u4EE5\u83B7\u5F97\u4E00\u4E2A\u65B9\u6CD5\u53E5\u67C4\u8FDB\u884C\u65B9\u6CD5\u8C03\u7528\u3002\u4F7F\u7528\u8C03\u7528\u70B9\u53EF\u4EE5\u589E\u5F3A\u65B9\u6CD5\u53E5\u67C4\u7684\u8868\u8FBE\u80FD\u529B\uFF0C\u6BD4\u5982\u5BF9\u4E8E\u53EF\u53D8\u8C03\u7528\u70B9\u6765\u8BF4\uFF0C\u5B83\u7ED1\u5B9A\u7684\u65B9\u6CD5\u53E5\u67C4\u662F\u53EF\u53D8\u7684\uFF0C\u56E0\u6B64\uFF0C\u5BF9\u540C\u4E00\u4E2A\u8C03\u7528\u70B9\u800C\u8A00\uFF0C\u5176\u8C03\u7528\u65B9\u6CD5\u662F\u53EF\u53D8\u7684\u3002</p></li><li><p>\u542F\u52A8\u65B9\u6CD5\uFF08BootstrapMethods\uFF09\uFF1A\u901A\u8FC7\u542F\u52A8\u65B9\u6CD5\u53EF\u4EE5\u83B7\u5F97\u4E00\u4E2A\u8C03\u7528\u70B9\uFF0C\u83B7\u53D6\u8C03\u7528\u70B9\u7684\u76EE\u7684\u662F\u8FDB\u884C\u65B9\u6CD5\u7ED1\u5B9A\u548C\u8C03\u7528\u3002\u542F\u52A8\u65B9\u6CD5\u662F\u5728 Class \u6587\u4EF6\u7684\u5C5E\u6027\u4E2D\u8FDB\u884C\u63CF\u8FF0\u7684\uFF0C\u8BFB\u8005\u53EF\u4EE5\u53C2\u89C1 9.2.16 \u8282\u3002</p></li><li><p>\u65B9\u6CD5\u7C7B\u578B\uFF08Method Type\uFF09\uFF1A\u7528\u4E8E\u63CF\u8FF0\u65B9\u6CD5\u7684\u7B7E\u540D\uFF0C\u6BD4\u5982\u65B9\u6CD5\u7684\u53C2\u6570\u7C7B\u578B\u3001\u8FD4\u56DE\u503C\u7B49\u3002\u6839\u636E\u65B9\u6CD5\u7684\u7C7B\u578B\uFF0C\u53EF\u4EE5\u67E5\u627E\u5230\u53EF\u7528\u7684\u65B9\u6CD5\u53E5\u67C4\u3002</p></li></ul><h3 id="_11-5-1-\u65B9\u6CD5\u53E5\u67C4\u4F7F\u7528\u5B9E\u4F8B" tabindex="-1"><a class="header-anchor" href="#_11-5-1-\u65B9\u6CD5\u53E5\u67C4\u4F7F\u7528\u5B9E\u4F8B" aria-hidden="true">#</a> 11.5.1 \u65B9\u6CD5\u53E5\u67C4\u4F7F\u7528\u5B9E\u4F8B</h3><p>\u5728 JDK 1.7 \u4E2D\uFF0C\u5F15\u5165\u4E86\u4E00\u4E9B API \u7528\u6765\u652F\u6301\u65B9\u6CD5\u53E5\u67C4\u7684\u4F7F\u7528\uFF0C\u8FD9\u4E9B\u7C7B\u4E3B\u8981\u4F4D\u4E8E java.lang.invoke \u5305\u4E2D\u3002\u672C\u8282\u4E3B\u8981\u4ECB\u7ECD\u6700\u57FA\u7840\u7684 4 \u4E2A\u7C7B\uFF1A</p><ul><li><p>java.lang.invoke.MethodType\uFF1A\u63D0\u4F9B\u4E86\u4E00\u7EC4\u751F\u6210\u65B9\u6CD5\u7C7B\u578B\u63CF\u8FF0\u7684 API\u3002\u4F7F\u7528\u5176\u9759\u6001\u65B9\u6CD5 methodType()\uFF0C\u53EF\u4EE5\u6839\u636E\u8FD4\u56DE\u503C\u548C\u53C2\u6570\u7C7B\u578B\u751F\u6210\u4E00\u4E2A MethodType \u5BF9\u8C61\u3002</p></li><li><p>java.lang.invoke.MethodHandle\uFF1A\u8868\u793A\u65B9\u6CD5\u53E5\u67C4\u3002\u901A\u8FC7\u65B9\u6CD5\u53E5\u67C4\u7684\u5B9E\u4F8B\uFF0C\u53EF\u4EE5\u4F7F\u7528\u5176 invoke() \u65B9\u6CD5\u76F4\u63A5\u8C03\u7528\u6307\u5B9A\u65B9\u6CD5\u3002</p></li><li><p>java.lang.invoke.MethodHandles\uFF1A\u8FD9\u662F\u4E00\u4E2A\u5DE5\u5177\u7C7B\uFF0C\u5927\u90E8\u5206\u65B9\u6CD5\u662F\u9759\u6001\u65B9\u6CD5\uFF0C\u7528\u4E8E\u6784\u9020 MethodHandle \u5B9E\u4F8B\u3002</p></li><li><p>java.lang.invoke.MethodHandles.Lookup\uFF1A\u8FD9\u662F MethodHandles \u7684\u5185\u90E8\u7C7B\uFF0C\u662F\u4E00\u4E2A\u5DE5\u5177\u7C7B\uFF0C\u7528\u4E8E\u67E5\u627E\u548C\u6784\u9020 MethodHandle \u5B9E\u4F8B\u3002</p></li></ul><p>\u3010\u793A\u4F8B 11-24\u3011\u4E0B\u9762\u662F\u4E00\u4E2A\u7B80\u5355\u7684\u4F7F\u7528 MethodHandle \u8FDB\u884C\u51FD\u6570\u8C03\u7528\u7684\u4F8B\u5B50\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">geym<span class="token punctuation">.</span>zbase<span class="token punctuation">.</span>ch11<span class="token punctuation">.</span>inv</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>invoke<span class="token punctuation">.</span></span><span class="token class-name">MethodHandle</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>invoke<span class="token punctuation">.</span></span><span class="token class-name">MethodType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>invoke<span class="token punctuation">.</span></span><span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token static">lookup</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleMethodHandle</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyPrintln</span> <span class="token punctuation">{</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1L</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0L</span> <span class="token operator">?</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">MyPrintln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getPrintlnMethodHandler</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invokeExact</span><span class="token punctuation">(</span><span class="token string">&quot;geym&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">MethodHandle</span> <span class="token function">getPrintlnMethodHandler</span><span class="token punctuation">(</span><span class="token class-name">Object</span> receiver<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">MethodType</span> mt <span class="token operator">=</span> <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findVirtual</span><span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;println&quot;</span><span class="token punctuation">,</span> mt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindTo</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u672C\u4F8B\u4E2D\u58F0\u660E\u4E86\u4E00\u4E2A\u5185\u90E8\u7C7B MyPrintln\uFF0C\u5B83\u62E5\u6709\u4E00\u4E2A println() \u65B9\u6CD5\uFF0C\u8FD9\u4E2A\u65B9\u6CD5\u548C System.out \u4E2D\u7684 println() \u65B9\u6CD5\u6709\u76F8\u540C\u7684\u7B7E\u540D\u3002\u56E0\u6B64\uFF0C\u8FD9\u4E24\u4E2A\u5C5E\u4E8E\u4E0D\u540C\u7C7B\u7684\u65B9\u6CD5\u62E5\u6709\u76F8\u540C\u7684\u63CF\u8FF0\u548C MethodType\u3002\u5728 main() \u51FD\u6570\u4E2D\uFF0C\u7B2C 14 \u884C\u968F\u673A\u4EA7\u751F\u4E00\u4E2A\u5BF9\u8C61\uFF0C\u5B83\u53EF\u80FD\u662F PrintStream \u7C7B\uFF0C\u4E5F\u53EF\u80FD\u662F MyPrintln \u7C7B\u3002\u5728\u7B2C 18 \u884C\u7684 getPrintlnMethodHandler() \u4F7F\u7528 MethodType.methodType() \u65B9\u6CD5\u6784\u9020\u4E86\u4E00\u4E2A\u8868\u793A\u65B9\u6CD5\u7B7E\u540D\u7684 MethodType \u5B9E\u4F8B\u3002\u8FD9\u91CC\u4EA7\u751F\u7684 MethodType \u8868\u793A\u4E00\u4E2A\u8FD4\u56DE\u503C\u4E3A void\u3001\u53C2\u6570\u4E3A String \u7684\u51FD\u6570\u3002\u5728\u7B2C 20 \u884C\uFF0C\u4F7F\u7528 MethodHandles.lookup.lookup() \u5F97\u5230\u4E00\u4E2A Lookup \u5B9E\u4F8B\uFF0C\u5E76\u8C03\u7528\u5176 findVirtual() \u65B9\u6CD5\uFF0C\u6839\u636E MethodType\u3001\u51FD\u6570\u540D\u79F0\u548C\u5B9E\u9645\u7684\u5BF9\u8C61\u7C7B\u578B\u8FDB\u884C\u65B9\u6CD5\u67E5\u627E\uFF0C\u5F97\u5230 MethodHandle \u5B9E\u4F8B\uFF0C\u5E76\u5C06\u8C03\u7528\u5BF9\u8C61 receiver \u4F5C\u4E3A\u65B9\u6CD5\u8C03\u7528\u7684\u6267\u884C\u8005\uFF0C\u7136\u540E\u8FD4\u56DE\u8FD9\u4E2A MethodHandle \u5B9E\u4F8B\u3002\u5728\u7B2C 16 \u884C\uFF0C\u6839\u636E\u8FD4\u56DE\u7684 MethodHandle \u5B9E\u4F8B\uFF0C\u8C03\u7528 println() \u65B9\u6CD5\uFF0C\u5E76\u4F20\u5165\u53C2\u6570 &quot;geym&quot;\u3002\u65E0\u8BBA\u5F53\u524D obj \u662F\u4EC0\u4E48\u7C7B\u578B\u7684\u5BF9\u8C61\uFF0C\u53EA\u8981\u5176\u62E5\u6709\u7ED9\u5B9A\u7B7E\u540D\u548C\u540D\u79F0\u7684\u65B9\u6CD5\uFF0C\u5C31\u53EF\u4EE5\u987A\u5229\u8C03\u7528\u5230\u8FD9\u4E2A\u65B9\u6CD5\u3002</p><p>\u4EE5\u4E0A\u5C31\u662F MethodHandle \u7684\u4F7F\u7528\u6848\u4F8B\u3002\u8FD9\u91CC\u8FD8\u9700\u8981\u8BF4\u660E\u4E00\u4E0B\uFF0C\u4F7F\u7528 Lookup \u5BF9\u8C61\u8FDB\u884C\u51FD\u6570\u67E5\u627E\u6709 3 \u79CD\u65B9\u5F0F\u3002</p><ul><li><p>findStatic() \u65B9\u6CD5\uFF1A\u67E5\u627E\u4E00\u4E2A static \u65B9\u6CD5\uFF0C\u4F7F\u7528 invokestatic \u8FDB\u884C\u65B9\u6CD5\u8C03\u7528\u3002</p></li><li><p>findVirtual() \u65B9\u6CD5\uFF1A\u67E5\u627E\u4E00\u4E2A\u865A\u65B9\u6CD5\uFF0C\u4F7F\u7528 invokevirtual \u6307\u4EE4\u8FDB\u884C\u65B9\u6CD5\u8C03\u7528\u3002</p></li><li><p>findSpecial() \u65B9\u6CD5\uFF1A\u67E5\u627E\u4E00\u4E2A\u7279\u6B8A\u7684\u65B9\u6CD5\uFF0C\u7B49\u4EF7\u4E8E\u4F7F\u7528 invokespecial \u8C03\u7528\uFF0C\u7528\u4E8E\u8BBF\u95EE\u79C1\u6709\u65B9\u6CD5\u3001\u7236\u7C7B\u7684\u65B9\u6CD5\u3002\u4F46\u662F\u5BF9\u4E8E\u6784\u9020\u51FD\u6570\u7684\u8BBF\u95EE\u9700\u8981\u4F7F\u7528 findConstructor() \u65B9\u6CD5\u3002</p></li></ul><p>\u7531\u4E8E\u5927\u90E8\u5206 Java \u51FD\u6570\u90FD\u662F\u865A\u51FD\u6570\uFF0C\u6240\u4EE5\u5BF9\u4E8E\u7EDD\u5927\u90E8\u5206\u51FD\u6570\u8C03\u7528\uFF0C\u4F7F\u7528 findVirtual() \u65B9\u6CD5\u67E5\u627E\u5C31\u53EF\u4EE5\u4E86\u3002\u5BF9\u4E8E\u9759\u6001\u51FD\u6570\u5219\u4F7F\u7528 findStatic() \u65B9\u6CD5\uFF0C\u5BF9\u4E8E\u7279\u6B8A\u7684\u4E00\u4E9B\u65B9\u6CD5\uFF0C\u6BD4\u5982\u79C1\u6709\u65B9\u6CD5\u6216\u8005\u7236\u7C7B\u65B9\u6CD5\uFF0C\u5219\u4F7F\u7528 findSpecial() \u65B9\u6CD5\u8FDB\u884C\u67E5\u627E\u3002</p><p>\u3010\u793A\u4F8B 11-25\u3011\u4E0B\u9762\u7684\u4EE3\u7801\u6F14\u793A\u4E86 findStatic() \u65B9\u6CD5\u7684\u4F7F\u7528\u3002\u548C findVirtual() \u65B9\u6CD5\u4E0D\u540C\uFF0C\u9759\u6001\u65B9\u6CD5\u4E0D\u9700\u8981\u7ED1\u5B9A\u8C03\u7528\u5BF9\u8C61\uFF0C\u56E0\u4E3A\u9759\u6001\u65B9\u6CD5\u6CA1\u6709 this \u5F15\u7528\u3002\u4E0B\u9762\u7684\u4EE3\u7801\u901A\u8FC7 MethodHandle \u8C03\u7528\u4E86 Math.sin() \u51FD\u6570\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleStaticMethodHandle</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">SimpleStaticMethodHandle</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStaticMethodHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">callSin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">callSin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">MethodHandle</span> mh <span class="token operator">=</span> <span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findStatic</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;sin&quot;</span><span class="token punctuation">,</span>
                <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> mh<span class="token punctuation">.</span><span class="token function">invokeExact</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span>PI <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u3010\u793A\u4F8B 11-26\u3011\u4E0B\u9762\u7684\u4F8B\u5B50\u4F7F\u7528 findSpecial() \u65B9\u6CD5\u8C03\u7528\u4E86\u7C7B\u7684\u79C1\u6709\u65B9\u6CD5\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimplePrivateMethodHandle</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">SimplePrivateMethodHandle</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimplePrivateMethodHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj<span class="token punctuation">.</span><span class="token function">callToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">printLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;call private method&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">MethodHandle</span> mh <span class="token operator">=</span> <span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findSpecial</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;printLine&quot;</span><span class="token punctuation">,</span>
                <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindTo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mh<span class="token punctuation">.</span><span class="token function">invokeExact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u3010\u793A\u4F8B 11-27\u3011\u4E0B\u9762\u7684\u4F8B\u5B50\u4F7F\u7528 findSpecial() \u65B9\u6CD5\u8C03\u7528\u4E86\u7236\u7C7B\u7684\u65B9\u6CD5\uFF0C\u6A21\u62DF\u4E86 super.toString() \u65B9\u6CD5\u7684\u8C03\u7528\u3002\u867D\u7136\u5728 SimpleSuperMethodHandle \u7C7B\u4E2D\u91CD\u8F7D\u4E86 toString() \u65B9\u6CD5\uFF0C\u4F46\u662F\u6309\u7167\u4E0B\u9762\u6240\u793A\u7684\u8C03\u7528\u65B9\u5F0F\uFF0C\u7A0B\u5E8F\u4F9D\u7136\u4F1A\u6253\u5370 &quot;geym.zbase.ch11.inv.SimpleSuperMethodHandle@15e538e&quot;\u3002\u8FD9\u4E2A\u65B9\u6CD5\u8C03\u7528\u7684\u4F9D\u7136\u662F\u5B9E\u4F8B\u65B9\u6CD5\uFF0C\u6545\u5728\u6700\u540E\u901A\u8FC7 bindTo() \u65B9\u6CD5\u7ED1\u5B9A\u5230\u76EE\u6807\u5B9E\u4F8B\u4E0A\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleSuperMethodHandle</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">SimpleSuperMethodHandle</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleSuperMethodHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">callToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;I am SimpleSuperMethodHandle&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">callToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">MethodHandle</span> mh <span class="token operator">=</span> <span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findSpecial</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;toString&quot;</span><span class="token punctuation">,</span>
                <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindTo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> mh<span class="token punctuation">.</span><span class="token function">invokeExact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>\u6CE8\u610F</strong>\uFF1AfindSpecial() \u65B9\u6CD5\u7684\u53C2\u6570\u4E2D\uFF0C\u7B2C 1 \u4E2A\u4E3A\u8981\u8C03\u7528\u65B9\u6CD5\u7684\u6240\u5728\u7C7B\uFF0C\u7B2C 2 \u4E2A\u53C2\u6570\u4E3A\u65B9\u6CD5\u540D\uFF0C\u7B2C 3 \u4E2A\u53C2\u6570\u4E3A\u65B9\u6CD5\u7C7B\u578B\uFF0C\u7B2C 4 \u4E2A\u53C2\u6570\u4E3A\u5B9E\u9645\u7684\u5BF9\u8C61\u7C7B\u578B.</p><h3 id="_11-5-2-\u8C03\u7528\u70B9\u4F7F\u7528\u5B9E\u4F8B" tabindex="-1"><a class="header-anchor" href="#_11-5-2-\u8C03\u7528\u70B9\u4F7F\u7528\u5B9E\u4F8B" aria-hidden="true">#</a> 11.5.2 \u8C03\u7528\u70B9\u4F7F\u7528\u5B9E\u4F8B</h3><p>\u8C03\u7528\u70B9\uFF08CallSite\uFF09\u4E5F\u662F JDK 1.7 \u589E\u52A0\u7684 API\uFF0C\u5B83\u4E5F\u5728 java.lang.invoke \u5305\u4E2D\uFF0C\u5982\u56FE11.19 \u6240\u793A\u3002\u8C03\u7528\u70B9\u7528\u4E8E\u5305\u88C5\u65B9\u6CD5\u53E5\u67C4\uFF0C\u901A\u8FC7\u4E00\u4E2A\u8C03\u7528\u70B9\u5B9E\u4F8B\u5C31\u53EF\u4EE5\u5F97\u5230\u76F8\u5173\u7684\u65B9\u6CD5\u53E5\u67C4\uFF0C\u4ECE\u800C\u5B9E\u73B0\u65B9\u6CD5\u8C03\u7528\u3002</p><p><img src="`+C+`" alt="\u56FE11-19" loading="lazy"></p><p>\u56FE11.19 \u8C03\u7528\u70B9\u7C7B\u5C42\u6B21\u7ED3\u6784</p><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u76EE\u524D\uFF0CJDK \u4E2D\u652F\u6301 3 \u7C7B\u8C03\u7528\u70B9\uFF0C\u5206\u522B\u662F\u5E38\u91CF\u8C03\u7528\u70B9\uFF08ConstantCallSite\uFF09\u3001\u53EF\u53D8\u8C03\u7528\u70B9\uFF08MutableCallSite\uFF09\u548C\u6613\u53D8\u8C03\u7528\u70B9\uFF08VolatileCallSite\uFF09\u3002\u5B83\u4EEC\u7684\u7279\u70B9\u5982\u4E0B\u3002</p><ul><li><p>\u5E38\u91CF\u8C03\u7528\u70B9\uFF1A\u8C03\u7528\u76EE\u6807\u4E0D\u53EF\u53D8\u3002\u4E00\u65E6\u5B83\u7ED1\u5B9A\u5230\u4E86\u76EE\u6807\u65B9\u6CD5\u53E5\u67C4\u4E0A\uFF0C\u5C31\u65E0\u6CD5\u518D\u66F4\u6539\u3002</p></li><li><p>\u53EF\u53D8\u8C03\u7528\u70B9\uFF1A\u8C03\u7528\u76EE\u6807\u53EF\u53D8\uFF0C\u53EF\u4EE5\u591A\u6B21\u7ED1\u5B9A\u5230\u4E0D\u540C\u7684\u76EE\u6807\u65B9\u6CD5\u53E5\u67C4\u4E0A\uFF0C\u6BCF\u6B21\u53EA\u901A\u8FC7\u540C\u4E00\u4E2A\u8C03\u7528\u70B9\uFF0C\u5C31\u53EF\u4EE5\u8C03\u7528\u4E0D\u540C\u7684\u65B9\u6CD5\u3002</p></li><li><p>\u6613\u53D8\u8C03\u7528\u70B9\uFF1A\u7531\u4E8E\u7F13\u5B58\u7B49\u539F\u56E0\uFF0C\u5728\u591A\u7EBF\u7A0B\u73AF\u5883\u4E2D\uFF0C\u5F53\u4E00\u4E2A\u7EBF\u7A0B\u66F4\u6539\u4E86\u53EF\u53D8\u8C03\u7528\u70B9\u7684\u76EE\u6807\u65B9\u6CD5\u540E\uFF0C\u5176\u4ED6\u7EBF\u7A0B\u4E0D\u80FD\u4FDD\u8BC1\u7ACB\u5373\u53D1\u73B0\u8FD9\u4E2A\u66F4\u6539\u3002\u5982\u679C\u9700\u8981\u4FDD\u8BC1\u8C03\u7528\u70B9\u4FEE\u6539\u5728\u591A\u7EBF\u7A0B\u95F4\u7684\u53EF\u89C1\u6027\uFF0C\u53EF\u4EE5\u4F7F\u7528\u6613\u53D8\u8C03\u7528\u70B9\uFF0C\u5B83\u6EE1\u8DB3 volatile \u8BED\u4E49\u3002</p></li></ul><p>\u4EE5\u4E0B\u4EE3\u7801\u6F14\u793A\u4E86\u5E38\u91CF\u8C03\u7528\u70B9\u7684\u4F7F\u7528\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">constantCallSiteSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">MethodHandles<span class="token punctuation">.</span>Lookup</span> lookup <span class="token operator">=</span> <span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodType</span> type <span class="token operator">=</span> <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodHandle</span> mh <span class="token operator">=</span> lookup<span class="token punctuation">.</span><span class="token function">findVirtual</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;substring&quot;</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ConstantCallSite</span> callSite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConstantCallSite</span><span class="token punctuation">(</span>mh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodHandle</span> invoker <span class="token operator">=</span> callSite<span class="token punctuation">.</span><span class="token function">dynamicInvoker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">&quot;1234567890&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;constantCallSiteSample return:&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE3\u7801\u7B2C 5 \u884C\uFF0C\u6839\u636E MethodHandle \u65B9\u6CD5\u53E5\u67C4\u6784\u9020\u4E00\u4E2A\u5E38\u91CF\u8C03\u7528\u70B9\uFF0C\u5E38\u91CF\u8C03\u7528\u70B9\u4E0D\u53EF\u53D8\uFF0C\u4E00\u76F4\u6307\u5411\u8BE5 MethodHandle\u3002\u7531\u7B2C 2 ~ 4 \u884C\u53EF\u77E5\uFF0C\u8BE5 MethodHandle \u6307\u5411 String.substring(int, int) \u65B9\u6CD5\u3002\u7B2C 6 \u884C\u7531\u8C03\u7528\u70B9\u7684 dynamiclnvoker() \u65B9\u6CD5\u53D6\u5F97 MethodHandle\uFF0C\u5E76\u8FDB\u884C\u8C03\u7528\u3002</p><p>\u3010\u793A\u4F8B 11-28\u3011\u4E0B\u9762\u7684\u4F8B\u5B50\u5C55\u793A\u4E86\u53EF\u53D8\u8C03\u7528\u70B9\uFF08MutableCallSite\uFF09\u7684\u4F7F\u7528\u65B9\u5F0F\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mutableCallSiteSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">MethodType</span> type <span class="token operator">=</span> <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MutableCallSite</span> callSite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutableCallSite</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodHandle</span> invoker <span class="token operator">=</span> callSite<span class="token punctuation">.</span><span class="token function">dynamicInvoker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodHandles<span class="token punctuation">.</span>Lookup</span> lookup <span class="token operator">=</span> <span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodHandle</span> mhSin <span class="token operator">=</span> lookup<span class="token punctuation">.</span><span class="token function">findStatic</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;sin&quot;</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodHandle</span> mhCos <span class="token operator">=</span> lookup<span class="token punctuation">.</span><span class="token function">findStatic</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;cos&quot;</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    callSite<span class="token punctuation">.</span><span class="token function">setTarget</span><span class="token punctuation">(</span>mhSin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span>PI <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;sin(90)=&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    callSite<span class="token punctuation">.</span><span class="token function">setTarget</span><span class="token punctuation">(</span>mhCos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span>PI <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;cos(90)=&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE3\u7801\u7B2C 3 \u884C\u6839\u636E\u51FD\u6570\u7C7B\u578B\uFF08\u51FD\u6570\u7B7E\u540D\uFF09\u6784\u9020\u4E86\u53EF\u53D8\u8C03\u7528\u70B9\uFF0C\u6839\u636E\u53EF\u53D8\u8C03\u7528\u70B9\u751F\u6210 MethodHandle\uFF0C\u540D\u4E3A invoker\uFF0C\u4F46\u6B64\u65F6\uFF0C\u53EF\u53D8\u8C03\u7528\u70B9\u5C1A\u672A\u5B8C\u6210\u521D\u59CB\u5316\uFF0C\u6CA1\u6709\u7ED1\u5B9A\u4EFB\u4F55\u53EF\u7528\u51FD\u6570\u3002\u63A5\u7740\u5728\u7B2C 6\u30017 \u884C\u83B7\u5F97\u53EF\u7528\u7684\u65B9\u6CD5\u53E5\u67C4 Math.sin() \u548CMath.cos()\u3002\u7B2C 8 \u884C\u8BBE\u7F6E\u53EF\u53D8\u8C03\u7528\u70B9\u7684\u76EE\u6807\u65B9\u6CD5\u4E3A Math.sin()\uFF0C\u5E76\u8FDB\u884C\u51FD\u6570\u8C03\u7528\u3002\u7B2C 11 \u884C\u6539\u53D8\u53EF\u7528\u8C03\u7528\u70B9\u7684\u76EE\u6807\u65B9\u6CD5\uFF0C\u5E76\u8FDB\u884C\u8C03\u7528\u3002\u7ED3\u679C\u901A\u8FC7\u540C\u4E00\u4E2A MethodHandle \u5B9E\u4F8B invoker \u5B8C\u6210\u4E86\u4E24\u6B21\u4E0D\u540C\u7684\u65B9\u6CD5\u8C03\u7528\u3002</p><h3 id="_11-5-3-\u53CD\u5C04\u548C\u65B9\u6CD5\u53E5\u67C4" tabindex="-1"><a class="header-anchor" href="#_11-5-3-\u53CD\u5C04\u548C\u65B9\u6CD5\u53E5\u67C4" aria-hidden="true">#</a> 11.5.3 \u53CD\u5C04\u548C\u65B9\u6CD5\u53E5\u67C4</h3><p>\u8BFB\u8005\u4E5F\u8BB8\u4F1A\u53D1\u73B0\uFF0C\u65B9\u6CD5\u53E5\u67C4\u63D0\u4F9B\u7684\u51FD\u6570\u67E5\u627E\u548C\u8BBF\u95EE\u529F\u80FD\uFF0C\u5728\u53CD\u5C04\u4E2D\u4E0D\u662F\u65E9\u5DF1\u63D0\u4F9B\u4E86\u5417\uFF1F\u4E0D\u9519\uFF0C\u4F7F\u7528\u53CD\u5C04\u4E5F\u53EF\u4EE5\u5B9E\u73B0\u7C7B\u4F3C\u7684\u529F\u80FD\uFF0C\u4E0D\u540C\u7684\u662F\uFF0C\u53CD\u5C04\u5728 Java \u8BED\u8A00\u5C42\u9762\u8FDB\u884C\u65B9\u6CD5\u8C03\u7528\u6A21\u62DF\uFF0C\u800C\u65B9\u6CD5\u53E5\u67C4\u5219\u5728 Java \u5B57\u8282\u7801\u5C42\u9762\u8FDB\u884C\u65B9\u6CD5\u8C03\u7528\u3002\u56E0\u6B64\uFF0C\u65B9\u6CD5\u53E5\u67C4\u7684\u6267\u884C\u6548\u7387\u8981\u9AD8\u4E8E\u53CD\u5C04\u3002</p><p>\u3010\u793A\u4F8B 11-29\u3011\u4F7F\u7528\u4E0B\u9762\u7684\u4EE3\u7801\u5BF9\u53CD\u5C04\u8C03\u7528\u548C\u65B9\u6CD5\u53E5\u67C4\u8C03\u7528\u8FDB\u884C\u6D4B\u8BD5\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectionMain</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> COUNT <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">callByHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReflectionMain</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodType</span> mt <span class="token operator">=</span> <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodHandle</span> mh <span class="token operator">=</span> <span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findVirtual</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;method&quot;</span><span class="token punctuation">,</span> mt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindTo</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> COUNT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mh<span class="token punctuation">.</span><span class="token function">invokeExact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">callByReflection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReflectionMain</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> m <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;method&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> COUNT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token function">callByHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callByHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callByReflection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callByReflection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8C03\u7528\u7684\u76EE\u6807\u65B9\u6CD5\u90FD\u662F\u7B2C 5 \u884C\u7684 method() \u65B9\u6CD5\u3002callByHandler() \u65B9\u6CD5\u4F7F\u7528\u65B9\u6CD5\u53E5\u67C4\u8FDB\u884C\u51FD\u6570\u8C03\u7528\uFF0CcallByReflection() \u65B9\u6CD5\u4F7F\u7528\u53CD\u5C04\u8FDB\u884C\u8C03\u7528\u3002\u4E24\u8005\u90FD\u7528 method() \u65B9\u6CD5\u6267\u884C\u76F8\u540C\u7684\u8C03\u7528\u6B21\u6570\uFF0C\u5E76\u7EDF\u8BA1\u65F6\u95F4\u3002\u4E3B\u51FD\u6570 main() \u4E2D\uFF0C\u5206\u522B\u8FDB\u884C\u4E24\u6B21\u8C03\u7528\uFF1A\u7B2C 1 \u6B21\u8C03\u7528\u5C5E\u4E8E\u70ED\u8EAB\uFF0C\u5E0C\u671B\u76F8\u5173\u7684 JIT \u7F16\u8BD1\u7B49\u8FDB\u884C\u5B8C\u6210\uFF0C\u7B2C 2 \u6B21\u8C03\u7528\u624D\u662F\u8981\u5173\u5FC3\u7684\u6027\u80FD\u7EDF\u8BA1\u6570\u636E\u3002</p><p>\u5728\u7B14\u8005\u7684\u8BA1\u7B97\u673A\u4E0A\uFF0C\u4F7F\u7528\u4E0D\u540C\u53C2\u6570\u8FD0\u884C\u7A0B\u5E8F\uFF0C\u5F97\u5230\u5982\u4E0B\u8F93\u51FA\uFF1A</p><p>\u8FD0\u884C\u53C2\u6570\uFF1A-Xint</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>callByHandler spend:282
callByHandler spend:263
callByReflection spend:444
callByReflection spend:433
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD0\u884C\u53C2\u6570\uFF1A-Xcomp -XX:-BackgroundCompilation</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>callByHandler spend:52
callByHandler spend:50
callByReflection spend:121
callByReflection spend:67
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u91CC\u53EA\u5173\u5FC3\u6BCF\u4E00\u79CD\u7C7B\u578B\u7684\u7B2C 2 \u6B21\u8F93\u51FA\uFF08\u52A0\u7C97\u90E8\u5206\uFF09\u3002\u53EF\u4EE5\u770B\u5230\uFF0C\u5BF9\u4E8E\u7EAF\u89E3\u91CA\u578B\u51FD\u6570\u8C03\u7528\uFF0C\u53CD\u5C04\u7684\u6027\u80FD\u53EA\u80FD\u8FBE\u5230\u65B9\u6CD5\u53E5\u67C4\u7684\u4E00\u534A\uFF0C\u800C\u5BF9\u4E8E JIT \u7F16\u8BD1\u540E\u7684\u51FD\u6570\u8C03\u7528\uFF0C\u53CD\u5C04\u7684\u6027\u80FD\u6709\u8F83\u5927\u63D0\u5347\uFF0C\u4F46\u4ECD\u7136\u6BD4\u65B9\u6CD5\u53E5\u67C4\u7565\u5DEE\u3002</p><h3 id="_11-5-4-\u6307\u4EE4-invokedynamic-\u4F7F\u7528\u5B9E\u4F8B" tabindex="-1"><a class="header-anchor" href="#_11-5-4-\u6307\u4EE4-invokedynamic-\u4F7F\u7528\u5B9E\u4F8B" aria-hidden="true">#</a> 11.5.4 \u6307\u4EE4 invokedynamic \u4F7F\u7528\u5B9E\u4F8B</h3><p>\u5728\u4E86\u89E3\u4E86\u65B9\u6CD5\u53E5\u67C4\u548C\u8C03\u7528\u70B9\u7684\u57FA\u7840\u4E0A\uFF0C\u7EC8\u4E8E\u53EF\u4EE5\u8BA9\u4E3B\u89D2 invokedynamic \u6307\u4EE4\u767B\u573A\u4EAE\u76F8\u4E86\u3002\u6307\u4EE4 invokedynamic \u63A5\u6536\u4E24\u4E2A\u5B57\u8282\u64CD\u4F5C\u6570\uFF0C\u6839\u636E\u64CD\u4F5C\u6570\uFF0Cinvokedynamic \u4F1A\u8BA1\u7B97\u51FA\u5E38\u91CF\u6C60\u7D22\u5F15\uFF0C\u8BE5\u5E38\u91CF\u6C60\u5165\u53E3\u4E3A CONSTANT_InvokeDynamic \u7ED3\u6784\uFF0C\u8BE5\u7ED3\u6784\u7528\u4E8E\u6307\u5411\u4E00\u4E2A\u5F15\u5BFC\u65B9\u6CD5\uFF08BootstrapMethods\uFF09\u548C\u65B9\u6CD5\u7684\u7B7E\u540D\u3002\u5F15\u5BFC\u65B9\u6CD5\u4F1A\u6307\u5411\u5E38\u91CF\u6C60\u4E2D\u7684 CONSTANT_MethodHandle \u9879\uFF0C\u8868\u793A\u65B9\u6CD5\u7684\u8C03\u7528\u4F4D\u7F6E\u3002CONSTANT_MethodHandle \u5165\u53E3\u4F1A\u5177\u4F53\u6307\u5411 CONSTANT_Methodref \u6216\u8005 CONSTANT_Fieldref \u7ED3\u6784\u3002\u5F15\u5BFC\u65B9\u6CD5\u3001CONSTANT_MethodHandle\u3001CONSTANT_InvokeDynamic \u5728\u5185\u7684\u5C5E\u6027\u6216\u8005\u5E38\u91CF\u6C60\u7C7B\u578B\uFF0C\u5728\u7B2C 9 \u7AE0\u4E2D\u6709\u8BE6\u7EC6\u63CF\u8FF0\uFF0C\u8BFB\u8005\u53EF\u4EE5\u53C2\u8003\u76F8\u5173\u5185\u5BB9\u3002</p><p>\u901A\u8FC7\u5BF9 InvokeDynamic \u7ED3\u6784\u7684\u89E3\u6790\uFF0C\u6700\u7EC8\u4F1A\u627E\u5230\u5F15\u5BFC\u65B9\u6CD5\uFF0C\u5F15\u5BFC\u65B9\u6CD5\u4F1A\u8FD4\u56DE\u4E00\u4E2A CallSite \u8C03\u7528\u70B9\uFF0C\u865A\u62DF\u673A\u5728\u6267\u884C\u5F15\u5BFC\u65B9\u6CD5\u540E\uFF0C\u5C31\u80FD\u5F97\u5230\u76EE\u6807\u8C03\u7528\u70B9\uFF0C\u5E76\u53D6\u5F97\u76EE\u6807\u51FD\u6570\u7684 MethodHandle\uFF0C\u4ECE\u800C\u5B8C\u6210\u51FD\u6570\u8C03\u7528\u3002</p><p>\u5982\u56FE11.20 \u6240\u793A\uFF0Cinvokedynamic \u6307\u4EE4\u4F1A\u627E\u5230 Class \u6587\u4EF6\u4E2D\u7684 CONSTANT_InvokeDynamic \u5E38\u91CF\uFF0C\u5E76\u89E3\u6790\u51FA\u5BF9\u5E94\u7684\u5F15\u5BFC\u65B9\u6CD5 BootstrapMethods\u3002\u5728\u5F15\u5BFC\u65B9\u6CD5\u7ED3\u6784\u4E2D\uFF0C\u53C8\u4F1A\u5F15\u7528\u5E38\u91CF\u6C60\u4E2D\u7684 MethodHandle \u65B9\u6CD5\u53E5\u67C4\uFF0C\u8BE5\u65B9\u6CD5\u53E5\u67C4\u8868\u793A\u5F15\u5BFC\u65B9\u6CD5\uFF0C\u901A\u8FC7\u8FD9\u4E2A MethodHandle \u53C8\u80FD\u5728 Class \u6587\u4EF6\u4E2D\u627E\u5230 CONSTANT_Methodref\uFF0C\u4ECE\u800C\u8FDB\u884C\u5F15\u5BFC\u65B9\u6CD5\u7684\u8C03\u7528\u3002\u5F15\u5BFC\u65B9\u6CD5\u4F1A\u8FD4\u56DE CallSite \u8C03\u7528\u70B9\uFF0C\u7CFB\u7EDF\u901A\u8FC7\u8C03\u7528\u70B9\u627E\u5230\u6700\u7EC8\u9700\u8981\u8C03\u7528\u7684\u65B9\u6CD5\u53E5\u67C4\uFF0C\u5C31\u53EF\u4EE5\u6267\u884C\u76EE\u6807\u65B9\u6CD5\u4E86\u3002\u7531\u6B64\u53EF\u89C1\uFF0C\u52A8\u6001\u8C03\u7528\u7684\u51FD\u6570\u6D3E\u53D1\u7ED1\u5B9A\u662F\u7531\u5F15\u5BFC\u65B9\u6CD5\u51B3\u5B9A\u7684\u3002\u8FD9\u4E5F\u5C31\u662F\u628A\u5B83\u79F0\u4E3A\u5F15\u5BFC\u65B9\u6CD5\u7684\u539F\u56E0\u3002</p><p><img src="`+M+`" alt="\u56FE11-20" loading="lazy"></p><p>\u56FE11.20 invokedynamic \u6307\u4EE4\u6D41\u7A0B\u56FE</p><p>\u76EE\u524D\uFF0C\u6307\u4EE4 invokedynamic \u5B8C\u5168\u662F\u4E3A\u52A8\u6001\u8BED\u8A00\u51C6\u5907\u7684\u3002\u5728 JDK 1.7 \u53CA\u4E4B\u524D\u7248\u672C\u4E2D\uFF0CJava \u5C1A\u4E0D\u5177\u5907\u5F88\u5F3A\u7684\u52A8\u6001\u6027\uFF0C\u56E0\u6B64\u65E0\u6CD5\u901A\u8FC7 Java \u7F16\u8BD1\u5668\u4EA7\u751F invokedynamic \u6307\u4EE4\u3002\u4F46\u5728 JDK 1.8 \u4E4B\u540E\uFF0C\u7531\u4E8E\u51FD\u6570\u5F0F\u7F16\u7A0B\u7684\u5F15\u5165\uFF0CJava \u7684\u52A8\u6001\u6027\u5927\u5927\u589E\u5F3A\uFF0C\u5728 Java \u51FD\u6570\u5F0F API \u8C03\u7528\u4E2D\uFF0C\u7F16\u8BD1\u5668\u5C31\u80FD\u4EA7\u751F invokedynamic \u6307\u4EE4\u3002\u6B64\u5916\uFF0C\u7531\u5404\u79CD\u52A8\u6001\u8BED\u8A00\u81EA\u5DF1\u7684\u7F16\u8BD1\u5668\uFF08\u6BD4\u5982 Groovy \u7B49\uFF09\u4E5F\u53EF\u80FD\u4EA7\u751F invokedynamic \u8C03\u7528\u3002</p><p>\u867D\u7136\u5728 JDK 1.8 \u4E4B\u524D\uFF0C\u65E0\u6CD5\u76F4\u63A5\u7531 Java \u7F16\u8BD1\u5668\u4EA7\u751F invokedynamic \u6307\u4EE4\uFF0C\u4F46\u5728\u524D\u6587\u4E2D\u5DF2\u6709\u4E0D\u5C11\u7BC7\u5E45\u4ECB\u7ECD ASM \u6846\u67B6\u7684\u4F7F\u7528\uFF0C\u5728\u8FD9\u91CC\u5C06\u4F7F\u7528 ASM \u4EA7\u751F\u5305\u542B invokedynamic \u6307\u4EE4\u7684\u51FD\u6570\uFF0C\u5E76\u6F14\u793A\u5176\u7ED3\u6784\u3002\u672C\u4F8B\u4F7F\u7528 invokedynamic \u6765\u8C03\u7528 String.hashCode() \u65B9\u6CD5\u3002</p><p>\u4E3A\u4E86\u4F7F\u7528 invokedynamic\uFF0C\u5FC5\u987B\u5148\u5EFA\u7ACB\u4E00\u4E2A\u5F15\u5BFC\u65B9\u6CD5\uFF0C\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynBootStrap</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CallSite</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token class-name">Lookup</span> lookup<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">MethodType</span> type<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;bootstrap called, name=&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodHandle</span> mh <span class="token operator">=</span> lookup<span class="token punctuation">.</span><span class="token function">findVirtual</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindTo</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConstantCallSite</span><span class="token punctuation">(</span>mh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5F15\u5BFC\u65B9\u6CD5\u7684\u7B2C 2 \u4E2A\u53C2\u6570 name \u4E3A\u8C03\u7528\u51FD\u6570\u7684\u540D\u79F0\uFF0C\u8FD9\u91CC\u4F7F\u7528 name \u6765\u67E5\u627E String \u7684\u65B9\u6CD5\uFF0C\u6B64\u5904\u4F20\u5165\u7684\u503C\u4E3A &quot;hashCode&quot;\u3002\u53C2\u6570 value \u662F\u65B9\u6CD5\u7684\u7B2C 1 \u4E2A\u53C2\u6570\uFF0C\u5BF9\u4E8E\u5B9E\u4F8B\u65B9\u6CD5\uFF0C\u7B2C 1 \u4E2A\u53C2\u6570\u5C31\u662F this\u3002\u65B9\u6CD5\u7B2C 4 \u884C\u5B8C\u6210\u4E86\u65B9\u6CD5\u53E5\u67C4\u7684\u67E5\u627E\u5DE5\u4F5C\uFF0C\u7B2C 5 \u884C\u8FD4\u56DE\u4E86\u5E38\u91CF\u8C03\u7528\u70B9\uFF0C\u7CFB\u7EDF\u4F1A\u6839\u636E\u8FD9\u4E2A\u8C03\u7528\u70B9\u8FDB\u884C\u65B9\u6CD5\u8C03\u7528\u3002</p><p>\u4EE5\u4E0B\u4EE3\u7801\u4F7F\u7528 ASM \u6784\u9020\u4E86\u4E00\u4E2A\u4F7F\u7528 invokedynamic \u6307\u4EE4\u7684\u7C7B\uFF0C\u5E76\u5C06\u4E0A\u8FF0\u4EE3\u7801\u7684\u5F15\u5BFC\u65B9\u6CD5\u4F5C\u4E3A\u5176\u5F15\u5BFC\u65B9\u6CD5\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynInvokerSample</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Handle</span> BSM <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handle</span><span class="token punctuation">(</span>H_INVOKESTATIC<span class="token punctuation">,</span> <span class="token class-name">DynBootStrap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">&#39;.&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;bootstrap&quot;</span><span class="token punctuation">,</span> <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token class-name">CallSite</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Lookup</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMethodDescriptorString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Class</span> <span class="token function">createClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_FRAMES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cw<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span>V1_7<span class="token punctuation">,</span> ACC_PUBLIC <span class="token operator">|</span> ACC_SUPER<span class="token punctuation">,</span> <span class="token string">&quot;DynInvokerSampleMain&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;java/lang/Object&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> m <span class="token operator">=</span> <span class="token class-name">Method</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;void &lt;init&gt;()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">GeneratorAdapter</span> mg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GeneratorAdapter</span><span class="token punctuation">(</span>ACC_PUBLIC<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> cw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mg<span class="token punctuation">.</span><span class="token function">loadThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mg<span class="token punctuation">.</span><span class="token function">invokeConstructor</span><span class="token punctuation">(</span><span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mg<span class="token punctuation">.</span><span class="token function">returnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mg<span class="token punctuation">.</span><span class="token function">endMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">MethodVisitor</span> mv <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>ACC_PUBLIC <span class="token operator">|</span> ACC_STATIC<span class="token punctuation">,</span> <span class="token string">&quot;run&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()V&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mv<span class="token punctuation">.</span><span class="token function">visitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mv<span class="token punctuation">.</span><span class="token function">visitFieldInsn</span><span class="token punctuation">(</span>GETSTATIC<span class="token punctuation">,</span> <span class="token string">&quot;java/lang/System&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;out&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Ljava/io/PrintStream;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mv<span class="token punctuation">.</span><span class="token function">visitInvokeDynamicInsn</span><span class="token punctuation">(</span><span class="token string">&quot;hashCode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()I&quot;</span><span class="token punctuation">,</span> BSM<span class="token punctuation">,</span> <span class="token string">&quot;geym&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mv<span class="token punctuation">.</span><span class="token function">visitMethodInsn</span><span class="token punctuation">(</span>INVOKEVIRTUAL<span class="token punctuation">,</span> <span class="token string">&quot;java/io/PrintStream&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;println&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;(I)V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mv<span class="token punctuation">.</span><span class="token function">visitInsn</span><span class="token punctuation">(</span>RETURN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mv<span class="token punctuation">.</span><span class="token function">visitMaxs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mv<span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cw<span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">FileOutputStream</span> fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;D:/DynInvokerSampleMain.class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token string">&quot;DynInvokerSampleMain&quot;</span><span class="token punctuation">,</span> bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span>
            <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">SecurityException</span> <span class="token punctuation">{</span>
        <span class="token class-name">DynInvokerSample</span> me <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynInvokerSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> me<span class="token punctuation">.</span><span class="token function">createClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;run&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;geym&quot;</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7B2C 2 ~ 4 \u884C\u58F0\u660E\u4E86\u5F15\u5BFC\u65B9\u6CD5\uFF0C\u5F15\u5BFC\u65B9\u6CD5\u5C06\u4F7F\u7528 invokstatic \u8FDB\u884C\u8C03\u7528\u3002\u7B2C 8 ~ 14 \u884C\u521B\u5EFA\u4E86\u7C7B DynlnvokerSampleMain\uFF0C\u5E76\u4E3A\u5176\u4EA7\u751F\u4E86\u9ED8\u8BA4\u7684\u6784\u9020\u51FD\u6570\u3002\u7B2C 16 \u884C\u521B\u5EFA\u4E86 run() \u65B9\u6CD5\u3002\u7B2C 20 \u884C\u4F7F\u7528 invokedynamic \u6307\u4EE4\uFF0C\u5728\u5B57\u7B26\u4E32 &quot;gcym&quot; \u4E0A\u67E5\u627E\u5E76\u8C03\u7528\u540D\u4E3A hashCode \u7684\u51FD\u6570\uFF0C\u51FD\u6570\u7B7E\u540D\u4E3A &quot;()I&quot;\uFF0C\u5373\u4E0D\u63A5\u6536\u53C2\u6570\uFF0C\u8FD4\u56DE\u503C\u4E3A int \u7C7B\u578B\u3002\u4F20\u5165\u7684 BSM \u4E3A\u5728\u7B2C 2 ~ 4 \u884C\u58F0\u660E\u7684\u5F15\u5BFC\u65B9\u6CD5\u3002\u7B2C 21 \u884C\u8F93\u51FA invokedynamic \u8FD0\u884C\u540E\u7684\u7ED3\u679C\u3002\u7B2C 29 \u884C\u5C06\u65B0\u751F\u6210\u7684 Class \u5199\u5165\u6587\u4EF6 DynlnvokerSampleMain.class\u3002\u7B2C 31 \u884C\u5B8C\u6210\u7C7B DynlnvokerSampleMain \u7684\u5B9A\u4E49\u548C\u52A0\u8F7D\u3002\u7B2C 38 \u884C\u8C03\u7528\u4E86 DynInvokerSampleMain.run() \u65B9\u6CD5\uFF0C\u6253\u5370 &quot;geym&quot; \u7684 hashCode() \u8FD4\u56DE\u503C\u3002\u7B2C 39 \u884C\u76F4\u63A5\u8C03\u7528 &quot;geym&quot;.hashCode()\u3002</p><p>\u8FD0\u884C\u4EE5\u4E0A\u4EE3\u7801\uFF0C\u8F93\u51FA\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>bootstrap called,name=hashCode
3169394
3169394
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F7F\u7528 javap\u5DE5\u5177\u5206\u6790\u4E0A\u8FF0\u4EE3\u7801\u4EA7\u751F\u7684 DynlnvokerSampleMain.class \u6587\u4EF6\uFF0C\u5982\u56FE11.21 \u6240\u793A\u3002</p><p><img src="`+A+`" alt="\u56FE11-21" loading="lazy"></p><p>\u56FE11.21 invokedynamic \u5B9E\u4F8B\u7ED3\u6784\u56FE</p><p>\u6587\u4EF6\u4E2D\u6709\u4E24\u5904\u7ED3\u6784\u548C\u52A8\u6001\u8C03\u7528\u6709\u5173\uFF1A</p><ul><li><p>\u4E00\u5904\u662F run() \u65B9\u6CD5\u5B57\u8282\u7801\u90E8\u5206\u4F7F\u7528\u4E86 invokedynamic \u6307\u4EE4\uFF0C\u8BE5\u6307\u4EE4\u4E00\u65B9\u9762\u6307\u5411\u4E86 CONSTANT_InvokeDynamic \u7ED3\u6784\uFF0C\u53E6\u4E00\u65B9\u9762\u6307\u5411\u4E86\u7B2C\u4E00\u4E2A\u5F15\u5BFC\u65B9\u6CD5\u3002</p></li><li><p>\u53E6\u4E00\u5904\u5C31\u662F\u5F15\u5BFC\u65B9\u6CD5\u5C5E\u6027\uFF0C\u5B83\u4E3B\u8981\u5B9A\u4F4D\u4E86\u65B9\u6CD5\u53E5\u67C4\u7684\u4F4D\u7F6E\uFF0C\u5E76\u6839\u636E\u5E38\u91CF\u6C60\u4E4B\u95F4\u7684\u5F15\u7528\u5173\u7CFB\uFF0C\u53EF\u4EE5\u4E00\u76F4\u8FFD\u6EAF\u5230 DynBootStrap.bootstrap() \u65B9\u6CD5\u3002</p></li></ul><h2 id="_11-6-\u8DD1\u5F97\u518D\u5FEB\u70B9-\u9759\u6001\u7F16\u8BD1\u4F18\u5316" tabindex="-1"><a class="header-anchor" href="#_11-6-\u8DD1\u5F97\u518D\u5FEB\u70B9-\u9759\u6001\u7F16\u8BD1\u4F18\u5316" aria-hidden="true">#</a> 11.6 \u8DD1\u5F97\u518D\u5FEB\u70B9\uFF1A\u9759\u6001\u7F16\u8BD1\u4F18\u5316</h2><p>\u5F53\u4F7F\u7528 javac \u628A Java \u6E90\u7801\u8F6C\u4E3A\u5B57\u8282\u7801\u65F6\uFF0C\u7F16\u8BD1\u5668\u4F1A\u6709\u4E00\u4E9B\u4F18\u5316\u4EE5\u83B7\u5F97\u66F4\u597D\u7684\u6027\u80FD\u3002\u76EE\u524D\uFF0C\u5BF9\u4E8E\u6267\u884C\u7684\u5B57\u8282\u7801\u4F1A\u4ECE\u4E24\u5904\u8FDB\u884C\u4F18\u5316\uFF1A</p><p>\u7B2C\u4E00\uFF0C\u4F7F\u7528 javac \u7F16\u8BD1\u65F6\uFF1B</p><p>\u7B2C\u4E8C\uFF0C\u901A\u8FC7 JIT\uFF08Just-In-Time\uFF09\u5373\u65F6\u7F16\u8BD1\uFF0C\u5728\u8FD0\u884C\u65F6\u3002</p><p>\u76EE\u524D\uFF0C\u5927\u91CF\u7684\u4F18\u5316\u5DE5\u4F5C\u90FD\u56F4\u7ED5\u7740 JIT \u5C55\u5F00\uFF0C\u6BD4\u5982\u65B9\u6CD5\u5185\u8054\u3001\u6808\u4E0A\u66FF\u6362\u7B49\u3002\u5C06\u4F18\u5316\u5DE5\u4F5C\u4ECE javac \u524D\u7AEF\u79FB\u5230\u540E\u7AEF\u7684\u597D\u5904\u662F\u975E\u5E38\u660E\u663E\u7684\uFF0C\u8FD9\u6837\u6240\u6709\u57FA\u4E8E Java \u5E73\u53F0\u7684\u8BED\u8A00\u90FD\u80FD\u5171\u4EAB\u8FD9\u79CD\u4F18\u5316\u5E26\u6765\u7684\u597D\u5904\u3002\u5C06\u5927\u91CF\u7684\u4F18\u5316\u53EA\u653E\u7F6E\u4E8E javac \u524D\u7AEF\uFF0C\u53EA\u6709 Java \u8BED\u8A00\u53EF\u4EE5\u5229\u7528\u8FD9\u79CD\u4F18\u5316\u65B9\u5F0F\u3002\u4F46\u5373\u4FBF\u5982\u6B64\uFF0C\u5F00\u53D1\u4EBA\u5458\u4E5F\u5FC5\u987B\u8981\u4E86\u89E3\u4E00\u4E9B javac \u7684\u5E38\u7528\u4F18\u5316\u65B9\u6CD5\u3002</p><h3 id="_11-6-1-\u7F16\u8BD1\u65F6\u8BA1\u7B97" tabindex="-1"><a class="header-anchor" href="#_11-6-1-\u7F16\u8BD1\u65F6\u8BA1\u7B97" aria-hidden="true">#</a> 11.6.1 \u7F16\u8BD1\u65F6\u8BA1\u7B97</h3><p>\u5982\u679C\u5728\u7A0B\u5E8F\u4E2D\u51FA\u73B0\u4E86\u8BA1\u7B97\u8868\u8FBE\u5F0F\uFF0C\u8868\u8FBE\u5F0F\u7684\u503C\u80FD\u591F\u5728\u7F16\u8BD1\u65F6\u786E\u5B9A\uFF0C\u90A3\u4E48\u8868\u8FBE\u5F0F\u7684\u8BA1\u7B97\u4F1A\u63D0\u524D\u5230\u7F16\u8BD1\u9636\u6BB5\uFF0C\u800C\u4E0D\u662F\u5728\u8FD0\u884C\u65F6\u8BA1\u7B97\u3002</p><p>\u3010\u793A\u4F8B 11-30\u3011\u5F88\u591A\u65F6\u5019\uFF0C\u4E3A\u4E86\u589E\u5F3A\u4EE3\u7801\u7684\u53EF\u8BFB\u6027\uFF0C\u5F80\u5F80\u4E0D\u4F1A\u628A\u6700\u7EC8\u7684\u6570\u503C\u5199\u5728\u4EE3\u7801\u4E2D\uFF0C\u901A\u5E38\u503E\u5411\u4E8E\u628A\u8BA1\u7B97\u8FC7\u7A0B\u5199\u5728\u4EE3\u7801\u91CC\uFF0C\u6BD4\u5982\u4E0B\u9762\u4EE3\u7801\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do sth.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5FAA\u73AF\u6B21\u6570\u4E3A 60 * 60 * 24 * 1000 \u6B21\uFF0C\u901A\u5E38\u8FD9\u4E2A\u8868\u8FBE\u5F0F\u7528\u6765\u8BA1\u7B97\u5929\u3001\u65F6\u3001\u5206\u3001\u79D2\u7684\u4E58\u79EF\u3002\u770B\u5230\u8FD9\u6BB5\u4EE3\u7801\uFF0C\u53EF\u80FD\u4F1A\u8BA9\u4EBA\u4EA7\u751F\u4E00\u79CD\u6000\u7591\uFF0C\u662F\u4E0D\u662F\u8FD9\u4E2A\u8BA1\u7B97\u6BCF\u6B21\u5FAA\u73AF\u90FD\u8981\u8FDB\u884C\u4E00\u6B21\u5462\uFF1F\u5982\u679C\u662F\u7684\u8BDD\uFF0C\u662F\u4E0D\u662F\u66F4\u5E94\u8BE5\u5199\u6210\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">86400000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do sth.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6216\u8005\u4E00\u5B9A\u8981\u4FDD\u7559\u8BA1\u7B97\u8868\u8FBE\u5F0F\u7684\u8BDD\uFF0C\u5199\u6210\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do sth.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8BFB\u8005\u4E5F\u8BB8\u4F1A\u8BA4\u4E3A\uFF0C\u4E0A\u8FF0\u4EE3\u7801\u5148\u8BA1\u7B97\u4E86\u8868\u8FBE\u5F0F\u4E58\u79EF\uFF0C\u5E76\u4FDD\u7559\u8FD9\u4E2A\u503C\uFF0C\u4EE5\u907F\u514D\u6BCF\u6B21\u5FAA\u73AF\u90FD\u91CD\u590D\u8BA1\u7B97\u3002</p><p>\u5B9E\u9645\u4E0A\uFF0C\u540E\u4E24\u6BB5\u4EE3\u7801\u7684\u62C5\u5FC3\u662F\u591A\u4F59\u7684\uFF0C\u56E0\u4E3A\u5728\u7F16\u8BD1\u7684\u65F6\u5019\uFF0C\u5BF9\u4E8E\u7ED9\u5B9A\u7684\u8868\u8FBE\u5F0F\u4F1A\u81EA\u52A8\u8BA1\u7B97\u5E76\u7ED9\u51FA\u7ED3\u679C\u3002\u672C\u4F8B\u4E2D\u7B2C\u4E00\u6BB5\u4EE3\u7801\u751F\u6210\u7684\u5B57\u8282\u7801\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>#20 = Integer    86400000
0: iconst_0
1: istore_1
2: goto    8
5: iinc    1, 1
8: iload_1
9: ldc    #20  // int 86400000
11: if_icmplt    5
14: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u7528\u4E8E\u63A7\u5236\u5FAA\u73AF\u6B21\u6570\u4E0A\u9650\u7684\u6574\u6570\u5728\u5B57\u8282\u7801\u4E2D\u5E76\u975E\u7ECF\u8FC7\u8BA1\u7B97\u5F97\u6765\u7684\uFF0C\u800C\u662F\u4FDD\u5B58\u5728\u5E38\u91CF\u6C60\u4E2D\uFF0C\u5E76\u76F4\u63A5\u4F7F\u7528\uFF0C\u5176\u4F5C\u7528\u662F\u5224\u5B9A\u662F\u5426\u53EF\u4EE5\u7EE7\u7EED\u5FAA\u73AF\u3002\u53EF\u89C1\uFF0C\u5BF9\u4E8E\u5E38\u91CF\u8868\u8FBE\u5F0F\uFF0C\u53EF\u4EE5\u5927\u80C6\u5730\u4F7F\u7528\u800C\u65E0\u987B\u62C5\u5FC3\u5F71\u54CD\u7CFB\u7EDF\u6027\u80FD\u3002</p><p>\u3010\u793A\u4F8B 11-31\u3011\u53E6\u4E00\u4E2A\u5E38\u7528\u7684\u4F8B\u5B50\u662F\u5B57\u7B26\u4E32\u8FDE\u63A5\u3002\u6709\u65F6\u5019\uFF0C\u5982\u679C\u4E00\u4E2A\u5B57\u7B26\u4E32\u5F88\u957F\uFF0C\u901A\u5E38\u4F1A\u503E\u5411\u4E8E\u4F7F\u7528 &quot;+&quot; \u53F7\u8FDE\u63A5\u3002\u7531\u4E8E\u5B57\u7B26\u4E32\u662F\u4E0D\u53EF\u53D8\u7684\u5BF9\u8C61\uFF0C\u8BFB\u8005\u4E5F\u8BB8\u4F1A\u8BA4\u4E3A\u4F7F\u7528\u7C7B\u4F3C A + B \u7684\u65B9\u5F0F\u8FDE\u63A5\u5B57\u7B26\u4E32\u65F6\uFF0C\u9700\u8981 3 \u4E2A\u5BF9\u8C61\uFF0C\u5373 A\u3001B \u548C AB\u3002\u4E0B\u9762\u518D\u6765\u770B\u4E00\u4E2A\u4F8B\u5B50\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> info1 <span class="token operator">=</span> <span class="token string">&quot;select * from test&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> info2 <span class="token operator">=</span> <span class="token string">&quot;select * &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;from test&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> info3 <span class="token operator">=</span> <span class="token string">&quot;select * &quot;</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;from test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info1 <span class="token operator">==</span> info2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info1 <span class="token operator">==</span> info3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info2 <span class="token operator">==</span> info3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info2 <span class="token operator">==</span> info3<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u4EE3\u7801\u4E2D\uFF0Cinfo1 \u662F\u76F4\u63A5\u5B9A\u4E49\u7684\u5B57\u7B26\uFF0Cinfo2 \u4F7F\u7528 &quot;+&quot; \u8FDE\u63A5\uFF0C\u751F\u6210\u5B57\u9762\u91CF\u7B49\u4E8E info1 \u7684\u5B57\u7B26\u4E32\uFF0Cinfo3 \u4F7F\u7528 String.concat() \u65B9\u6CD5\u505A\u8FDE\u63A5\u751F\u6210\u3002\u6267\u884C\u4EE5\u4E0A\u4EE3\u7801\uFF0C\u8F93\u51FA\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>true 
false 
false 
true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0Cinfo1 \u548C info2 \u6307\u5411\u4E86\u540C\u4E00\u4E2A\u5BF9\u8C61\u5F15\u7528\uFF0C\u800C info3 \u5219\u6307\u5411\u4E86\u4E0D\u540C\u7684\u5BF9\u8C61\u5F15\u7528\uFF0C\u4F46\u662F info3 \u7684\u5E38\u91CF\u6C60\u5F15\u7528\u5730\u5740\u5C31\u662F info2\u3002\u8FD9\u8BF4\u660E info3 \u662F\u88AB\u5B9E\u5B9E\u5728\u5728\u6784\u9020\u51FA\u6765\u7684\u65B0\u7684 String \u5BF9\u8C61\uFF0C\u800C info2 \u7684 &quot;+&quot; \u8FD0\u7B97\u5E76\u672A\u5728\u8FD0\u884C\u65F6\u8FDB\u884C\uFF0C\u5426\u5219\u4E5F\u5E94\u8BE5\u6709\u65B0\u5BF9\u8C61\u4EA7\u751F\u3002\u67E5\u770B\u5B83\u7684\u90E8\u5206\u5B57\u8282\u7801\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: ldc    #24;  // String select * from test
2: astore_0
3: ldc    #24;  // String select * from test
5: astore_1
6: ldc    #26;  // String select *
8: ldc    #28;  // String from test
10: invokevirtual    #30; // Method java/lang/String.concat:(Ljava/lang/String;)Ljava/lang/String;
13: astore_2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u5B57\u8282\u7801\u4E2D\uFF0C\u7B2C 2 \u884C\u8868\u793A\u5C06\u5E38\u91CF\u6C60\u7B2C 24 \u9879\u5B58\u5165\u7B2C 0 \u4E2A\u5C40\u90E8\u53D8\u91CF\uFF08info1\uFF09\uFF0C\u7B2C 5 \u884C\u8868\u793A\u5C06\u5E38\u91CF\u6C60\u7B2C 24 \u9879\u5B58\u5165\u7B2C 1 \u4E2A\u5C40\u90E8\u53D8\u91CF\uFF08info2\uFF09\u3002\u8FD9\u91CC\u5C31\u89E3\u91CA\u4E86\u4E3A\u4EC0\u4E48\u7A0B\u5E8F\u4F1A\u6709\u8FD9\u6837\u7684\u8F93\u51FA\uFF0C\u56E0\u4E3A\u5728\u7F16\u8BD1\u65F6\uFF0C\u5B57\u7B26\u4E32\u8FDE\u63A5\u5DF2\u7ECF\u5B8C\u6210\u3002\u800C\u5BF9\u4E8E\u540E\u7EED\u7684 concat() \u51FD\u6570\uFF0C\u5219\u6CA1\u6709\u8FD9\u79CD\u4F18\u5316\uFF0C\u7B2C 10 \u884C\u7684 invokevirtual \u8C03\u7528\uFF0C\u5C31\u8BF4\u660E\u4E86 info3 \u662F\u5728\u8FD0\u884C\u65F6\u88AB\u521B\u5EFA\u7684\u3002</p><p>\u7EFC\u4E0A\uFF0C\u5BF9\u4E8E\u5E38\u91CF\u5B57\u7B26\u4E32\u8FDE\u63A5\uFF0C\u4E0D\u7528\u62C5\u5FC3\u591A\u5199\u51E0\u4E2A &quot;+&quot; \u4F1A\u5F71\u54CD\u7CFB\u7EDF\u6027\u80FD\u3001\u591A\u5360\u7528\u5185\u5B58\u7B49\uFF0C\u56E0\u4E3A\u8FD9\u4E9B\u90FD\u4F1A\u5728\u7F16\u8BD1\u5668\u4E2D\u8FDB\u884C\u8BA1\u7B97\u3002</p><h3 id="_11-6-2-\u53D8\u91CF\u5B57\u7B26\u4E32\u7684\u8FDE\u63A5" tabindex="-1"><a class="header-anchor" href="#_11-6-2-\u53D8\u91CF\u5B57\u7B26\u4E32\u7684\u8FDE\u63A5" aria-hidden="true">#</a> 11.6.2 \u53D8\u91CF\u5B57\u7B26\u4E32\u7684\u8FDE\u63A5</h3><p>\u4E0A\u4E00\u8282\u4ECB\u7ECD\u4E86\u7F16\u8BD1\u5668\u5BF9\u5E38\u91CF\u5B57\u7B26\u4E32\u7684\u4F18\u5316\uFF0C\u90A3\u4E48\u5BF9\u4E8E\u53D8\u91CF\u5B57\u7B26\u4E32\u8FDE\u63A5\uFF0C\u662F\u5426\u4E5F\u6709\u7C7B\u4F3C\u7684\u4F18\u5316\u65B9\u6848\u5462\uFF1F\u7B54\u6848\u662F\u80AF\u5B9A\u7684\u3002</p><p>\u3010\u793A\u4F8B 11-32\u3011\u4E0B\u9762\u8FD9\u6BB5\u4EE3\u7801\u662F\u5E38\u7528\u7684\u5B57\u7B26\u4E32\u64CD\u4F5C\u65B9\u5F0F\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addString</span><span class="token punctuation">(</span><span class="token class-name">String</span> str1<span class="token punctuation">,</span> <span class="token class-name">String</span> str2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> str3 <span class="token operator">=</span> str1 <span class="token operator">+</span> str2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53D8\u91CF str1 \u548C str2 \u901A\u8FC7 &quot;+&quot; \u8FDB\u884C\u5B57\u7B26\u4E32\u8FDE\u63A5\u3002\u5BF9\u4E8E\u5E38\u91CF\uFF0C\u4F1A\u5728\u8FD0\u884C\u65F6\u8FDB\u884C\u8BA1\u7B97\uFF0C\u800C\u5BF9\u4E8E\u53D8\u91CF\uFF0C\u8FD0\u884C\u65F6\u663E\u7136\u65E0\u6CD5\u8FDB\u884C\u8BA1\u7B97\uFF0C\u6B64\u65F6\u7F16\u8BD1\u5668\u4F1A\u4E3A\u5B57\u7B26\u4E32\u7684\u64CD\u4F5C\u63D2\u5165 StringBuilder\u3002\u7B14\u8005\u4F7F\u7528 jad\uFF08Java \u7684\u53CD\u7F16\u8BD1\u5668\uFF09\u5BF9\u4E0A\u8FF0\u4EE3\u7801\u751F\u6210\u7684 Class \u6587\u4EF6\u8FDB\u884C\u53CD\u7F16\u8BD1\uFF0C\u5F97\u5230\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> str3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u6E05\u695A\u5730\u770B\u5230\uFF0C\u5B57\u7B26\u4E32\u8FDE\u63A5\u90FD\u88AB\u8F6C\u4E3A\u4E86\u66F4\u53EF\u53D6\u7684 StringBuilder \u64CD\u4F5C\uFF0C\u907F\u514D\u4E86\u6BCF\u6B21\u5B57\u7B26\u4E32\u64CD\u4F5C\u90FD\u751F\u6210\u65B0\u7684\u5BF9\u8C61\uFF0C\u56E0\u6B64\u8BFB\u8005\u5927\u53EF\u4E0D\u5FC5\u62C5\u5FC3\u8FD9\u7C7B\u64CD\u4F5C\u5E26\u6765\u592A\u5927\u7684\u6027\u80FD\u95EE\u9898\u3002\u4F46\u662F\u5982\u679C\u80FD\u5728\u7F16\u7801\u65F6\u7559\u610F\u8FD9\u4E9B\u95EE\u9898\uFF0C\u4F9D\u7136\u662F\u5927\u6709\u597D\u5904\u7684\u3002</p><p>\u3010\u793A\u4F8B 11-33\u3011\u4E0B\u9762\u7684\u4EE3\u7801\u5728\u5FAA\u73AF\u4E2D\u8FDB\u884C\u5B57\u7B26\u4E32\u8FDE\u63A5\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addString2</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> str1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> str3 <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> str <span class="token operator">:</span> str1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        str3 <span class="token operator">+=</span> str1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6839\u636E\u4E0A\u8FF0\u7ECF\u9A8C\uFF0C\u8BFB\u8005\u5E94\u8BE5\u80FD\u60F3\u5230\uFF0C\u8FD9\u4E9B\u5B57\u7B26\u4E32\u64CD\u4F5C\u90FD\u4F1A\u88AB\u7F16\u8BD1\u6210\u66F4\u9AD8\u6548\u7684 StringBuilder\u3002\u4F7F\u7528 jad \u53CD\u7F16\u8BD1\u4E0A\u8FF0\u751F\u6210\u7684 Class \u6587\u4EF6\uFF0C\u5F97\u5230\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addString2</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> str1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> str3 <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> as<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token punctuation">(</span>as <span class="token operator">=</span> str1<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        str3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>str3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4ECE\u53CD\u7F16\u8BD1\u4EE3\u7801\u53EF\u77E5\uFF0C\u867D\u7136\u4F7F\u7528\u4E86 StringBuilder \u8FDB\u884C\u5B57\u7B26\u4E32\u8FDE\u63A5\uFF0C\u4F46\u662F\u4F18\u5316\u7684\u7ED3\u679C\u662F\u4E3A\u6BCF\u6B21\u5B57\u7B26\u4E32\u8FDE\u63A5\u90FD\u751F\u6210\u4E00\u4E2A StringBuilder \u5B9E\u4F8B\uFF0C\u8FD9\u663E\u7136\u4E5F\u662F\u4E00\u79CD\u4E0D\u591F\u806A\u660E\u7684\u505A\u6CD5\u3002\u66F4\u597D\u7684\u505A\u6CD5\u662F\u5728\u5FAA\u73AF\u5916\u5EFA\u7ACB StringBuilder \u5B9E\u4F8B\uFF0C\u5728\u5FAA\u73AF\u5185\u8FDB\u884C\u5B57\u7B26\u4E32\u7D2F\u52A0\u64CD\u4F5C\u3002</p><p>\u7531\u6B64\u53EF\u89C1\uFF0C\u5BF9\u4E8E\u53D8\u91CF\u5B57\u7B26\u4E32\u7D2F\u52A0\uFF0C\u7F16\u8BD1\u5668\u4F1A\u505A\u9002\u91CF\u4F18\u5316\uFF0C\u4F46\u662F\u65E0\u6CD5\u5F97\u5230\u6700\u4F18\u7684\u89E3\u51B3\u65B9\u6848\uFF0C\u4F9D\u7136\u9700\u8981\u5728\u5F00\u53D1\u65F6\u6CE8\u610F\u8FD9\u4E9B\u95EE\u9898\u3002</p><h3 id="_11-6-3-\u57FA\u4E8E\u5E38\u91CF\u7684\u6761\u4EF6\u8BED\u53E5\u88C1\u526A" tabindex="-1"><a class="header-anchor" href="#_11-6-3-\u57FA\u4E8E\u5E38\u91CF\u7684\u6761\u4EF6\u8BED\u53E5\u88C1\u526A" aria-hidden="true">#</a> 11.6.3 \u57FA\u4E8E\u5E38\u91CF\u7684\u6761\u4EF6\u8BED\u53E5\u88C1\u526A</h3><p>\u5728\u4ECB\u7ECD\u672C\u8282\u5185\u5BB9\u524D\uFF0C\u7B14\u8005\u5148\u8BB2\u8FF0\u4E00\u4E2A\u771F\u5B9E\u7684\u5F00\u53D1\u6848\u4F8B\u3002\u4F17\u6240\u5468\u77E5\uFF0C\u5927\u578B\u9879\u76EE\u7684\u6784\u5EFA\u8FC7\u7A0B\u662F\u975E\u5E38\u8017\u65F6\u7684\uFF0C\u4EE5\u7B14\u8005\u7EF4\u62A4\u7684 Java \u9879\u76EE\u4E3A\u4F8B\uFF0C\u5B8C\u5168\u7F16\u8BD1\u548C\u6784\u5EFA\u9700\u8981\u82B1 30 \u5206\u949F\u5230 1 \u5C0F\u65F6\u3002\u56E0\u6B64\uFF0C\u5728\u6B63\u5F0F\u53D1\u5E03\u7248\u672C\u4E4B\u524D\uFF0C\u5927\u5BB6\u90FD\u662F\u975E\u5E38\u8C28\u614E\u7684\uFF0C\u751F\u6015\u51FA\u9519\u540E\u91CD\u65B0\u7F16\u8BD1\u9879\u76EE\u8D39\u65F6\u8D39\u529B\u3002\u4F46\u662F\uFF0C\u96BE\u514D\u758F\u5FFD\uFF0C\u6709\u65F6\u5019\u5C31\u662F\u4F1A\u7531\u4E8E\u8FD9\u6837\u90A3\u6837\u7684\u539F\u56E0\uFF0C\u9700\u8981\u91CD\u65B0\u7F16\u8BD1\u3002\u4E3A\u4E86\u8282\u7701\u65F6\u95F4\uFF0C\u6709\u65F6\u5019\u5C31\u4F1A\u4F7F\u7528 \u201C\u585E\u5305\u201D \u7684\u65B9\u6CD5\uFF0C\u5C06\u9700\u8981\u66F4\u65B0\u7684\u7C7B\u5355\u72EC\u7F16\u8BD1\uFF0C\u7136\u540E\u66F4\u65B0\u5230\u5DF1\u7ECF\u7F16\u8BD1\u5B8C\u6210\u7684 jar \u5305\u4E2D\uFF0C\u800C\u4E0D\u53BB\u91CD\u65B0\u7F16\u8BD1\u6574\u4E2A\u7CFB\u7EDF\uFF08\u5F53\u7136\uFF0C\u4E00\u822C\u60C5\u51B5\u4E0B\u5E76\u4E0D\u63A8\u8350\u8FD9\u4E48\u505A\uFF09\u3002</p><p>\u3010\u793A\u4F8B 11-34\u3011\u6709\u4E00\u6B21\uFF0C\u7B14\u8005\u53D1\u73B0\u7C7B\u4F3C\u4E0B\u9762\u4EE3\u7801\u5B9A\u4E49\u7684\u7C7B\u9700\u8981\u4FEE\u6539\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinalFlag</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4FEE\u6539\u7684\u5185\u5BB9\u662F flag \u5E38\u91CF\u5E94\u8BE5\u88AB\u7F6E\u4E3A false\uFF0C\u800C\u4E0D\u662F true\uFF0C\u56E0\u4E3A\u5728\u7CFB\u7EDF\u4E2D\u6709\u4E0D\u5C11\u5730\u65B9\u4EE5\u4E0B\u9762\u7C7B\u4F3C\u7684\u65B9\u5F0F\u5F15\u7528\u8FD9\u4E2A\u5E38\u91CF\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FinalFlag</span><span class="token punctuation">.</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;flag is true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;flag is false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E3A\u4E86\u907F\u514D\u91CD\u65B0\u7F16\u8BD1\u6574\u4E2A\u7CFB\u7EDF\u5E26\u6765\u7684\u9EBB\u70E6\uFF0C\u7B14\u8005\u60F3\u5F53\u7136\u5730\u5C06 FinalFlag \u4E2D\u7684 flag \u8BBE\u7F6E\u4E3A false\uFF0C\u5355\u72EC\u7F16\u8BD1 FinalFlag\uFF0C\u5E76\u5C06\u65B0\u7684 Class \u6587\u4EF6\u66F4\u65B0\u5230 jar \u4E2D\u3002\u63A5\u7740\u66F4\u65B0\u6574\u4E2A\u7CFB\u7EDF\u5E76\u8FDB\u884C\u6D4B\u8BD5\uFF0C\u7ED3\u679C\u53D1\u73B0\u5F15\u7528\u5230 FinalFlag.flag \u7684\u4EE3\u7801\u70B9\uFF0C\u5E76\u6CA1\u6709\u8FDB\u5165\u671F\u671B\u7684\u903B\u8F91\uFF0C\u8BA9\u4EBA\u7EA0\u7ED3\u534A\u5929\u3002</p><p>\u5176\u5B9E\uFF0C\u5BFC\u81F4\u8FD9\u4E2A\u95EE\u9898\u7684\u539F\u56E0\u5F88\u7B80\u5355\uFF0C\u5982\u679C\u4F7F\u7528 javap \u83B7\u5F97\u4E0A\u8FF0 checkflag() \u65B9\u6CD5\u7684\u5B57\u8282\u7801\uFF0C\u53EF\u4EE5\u770B\u5230\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: getstatic    #36;  // Field java/lang/System.out:Ljava/io/Printstream;
3: ldc    #59;  // String flag is true
5: invokevirtual    #61;  // Method java/io/Printstream.println:(Ljava/lang/String;)V
8: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u662F\u4E0D\u662F\u4EE4\u4EBA\u5403\u60CA\u7684\u7F16\u8BD1\u7ED3\u679C\uFF1F\u5728\u5B9E\u9645\u6267\u884C\u7684\u5B57\u8282\u7801\u4E2D\uFF0C\u6CA1\u6709\u83B7\u53D6 FinalFlag.flag\uFF0C\u6CA1\u6709\u8FDB\u884C\u6761\u4EF6\u5224\u65AD\u8DF3\u8F6C\uFF0C\u53EA\u662F\u7B80\u5355\u5730\u6253\u5370\u4E86 &quot;String flag is true&quot;\u3002\u56E0\u6B64\uFF0C\u65E0\u8BBA\u5982\u4F55\u66F4\u65B0 FinalFlag.flag\uFF0C\u53EA\u8981\u5F15\u7528\u8FD9\u4E2A\u53D8\u91CF\u7684\u7C7B\u4E0D\u505A\u66F4\u65B0\uFF0C\u7A0B\u5E8F\u90FD\u4E0D\u4F1A\u6709\u4EFB\u4F55\u53D8\u5316\u3002\u8FD9\u5C31\u662F\u56E0\u4E3A\u7F16\u8BD1\u5668\u4F1A\u5BF9\u5E38\u91CF\u505A\u7279\u6B8A\u7684\u4F18\u5316\uFF0C\u7531\u4E8E final \u5E38\u91CF\u662F\u4E0D\u53EF\u53D8\u7684\uFF0C\u4EFB\u4F55\u903B\u8F91\u90FD\u53EF\u4EE5\u5728\u7F16\u8BD1\u65F6\u5C31\u786E\u5B9A\uFF0C\u4E0D\u9700\u8981\u7684\u903B\u8F91\u81EA\u7136\u53EF\u4EE5\u88C1\u526A\uFF0C\u4E8E\u662F\u5C31\u6709\u4E86\u8FD9\u4E48\u4E00\u4E2A\u95EE\u9898\u3002</p><p>\u89E3\u51B3\u8FD9\u4E2A\u95EE\u9898\u7684\u529E\u6CD5\u5C31\u662F\u505A\u4E00\u6B21\u5168\u9762\u7684\u7F16\u8BD1\uFF0C\u8BA9 final \u7684\u66F4\u65B0\u5F71\u54CD\u5230\u6BCF\u4E00\u4E2A\u4F7F\u7528\u5230\u7684\u7C7B\u4E2D\u3002</p><h3 id="_11-6-4-switch-\u8BED\u53E5\u7684\u4F18\u5316" tabindex="-1"><a class="header-anchor" href="#_11-6-4-switch-\u8BED\u53E5\u7684\u4F18\u5316" aria-hidden="true">#</a> 11.6.4 switch \u8BED\u53E5\u7684\u4F18\u5316</h3><p>\u5728\u524D\u9762\u7684\u7AE0\u8282\u4E2D\u63D0\u5230\uFF0C\u5BF9\u4E8E switch \u8BED\u53E5\uFF0C\u7F16\u8BD1\u5668\u4F1A\u4EA7\u751F\u4E24\u79CD\u5B57\u8282\u7801\u6307\u4EE4\uFF1Atableswitch \u548C lookupswitch\u3002\u5176\u4E2D tableswitch \u7684\u6548\u7387\u9AD8\u4E8E lookupswitch\uFF0C\u4F46 tableswitch \u7684\u7ED3\u6784\u51B3\u5B9A\u4E86\u5B83\u53EA\u80FD\u5904\u7406 case \u60C5\u51B5\u662F\u8FDE\u7EED\u7684\u6570\u503C\uFF0C\u800C lookupswitch \u53EF\u4EE5\u5904\u7406\u4E0D\u8FDE\u7EED\u7684\u60C5\u51B5\u3002\u4E00\u822C\u6765\u8BF4\uFF0C\u603B\u662F\u5E0C\u671B\u53EF\u4EE5\u5C3D\u53EF\u80FD\u5730\u4F7F\u7528 tableswitch\uFF0C\u800C\u4E0D\u662F lookupswitch\u3002</p><p>\u3010\u793A\u4F8B 11-35\u3011\u4EE5\u4E0B\u9762\u7684\u4EE3\u7801\u4E3A\u4F8B\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E5F\u8BB8\u4E0D\u5C11\u8BFB\u8005\u4F1A\u8BA4\u4E3A\uFF0C\u56E0\u4E3A case \u503C\u662F\u4E0D\u8FDE\u7EED\u7684\uFF0C\u6240\u4EE5\u7F16\u8BD1\u5668\u4F1A\u4F7F\u7528\u4F4E\u6548\u7684 lookupswitch \u6307\u4EE4\u5904\u7406\u8FD9\u4E2A switch\uFF0C\u6BCF\u6B21\u90FD\u904D\u5386\u67E5\u627E\u6240\u6709\u7684\u53EF\u80FD\u60C5\u51B5\u3002</p><p>\u5982\u679C\u7528 javap \u67E5\u770B\u751F\u6210\u7684\u5B57\u8282\u7801\uFF0C\u4F1A\u53D1\u73B0\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: iload_1
1: tableswitch{ // 1 to 5
        1: 36;
        2: 39;
        3: 45;
        4: 45; 
        5: 42;
        default: 45 }
36:	goto    53
39:	goto    53
42:	goto    53
45: getstatic    #36;  // Field java/lang/System.out:Ljava/io/Printstream;
48:	ldc    #58;  // String
50: invokevirtual    #60;  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
53: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u4E3A\u4E86\u4F7F\u7528 tableswitch\uFF0C\u7F16\u8BD1\u5668\u5C06\u79BB\u6563\u7684\u6570\u636E\u8FDB\u884C\u4E86\u586B\u5145\uFF0C\u5176\u4E2D case3\u30014 \u90FD\u8DF3\u8F6C\u5230\u4E86 default\uFF0C\u7B26\u5408\u4EE3\u7801\u7684\u8BED\u4E49\u3002\u4F46\u5982\u679C\u79BB\u6563\u7A7A\u95F4\u5F88\u5927\uFF0C\u5C31\u4F1A\u8981\u6C42\u63D2\u5165\u8FC7\u591A\u7684\u4E2D\u95F4\u6570\u636E\uFF0C\u6B64\u65F6\u7F16\u8BD1\u5668\u4F9D\u7136\u4F1A\u4F7F\u7528 lookupswitch \u6307\u4EE4\u3002</p><h2 id="_11-7-\u63D0\u9AD8\u865A\u62DF\u673A\u7684\u6267\u884C\u6548\u7387-jit-\u53CA\u5176\u76F8\u5173\u53C2\u6570" tabindex="-1"><a class="header-anchor" href="#_11-7-\u63D0\u9AD8\u865A\u62DF\u673A\u7684\u6267\u884C\u6548\u7387-jit-\u53CA\u5176\u76F8\u5173\u53C2\u6570" aria-hidden="true">#</a> 11.7 \u63D0\u9AD8\u865A\u62DF\u673A\u7684\u6267\u884C\u6548\u7387\uFF1AJIT \u53CA\u5176\u76F8\u5173\u53C2\u6570</h2><p>JIT\uFF08Just-In-Time\uFF09\u7F16\u8BD1\u5668\u662F Java \u865A\u62DF\u673A\u7684\u6267\u884C\u673A\u5236\u7684\u6027\u80FD\u4FDD\u8BC1\u3002\u7531\u4E8E Java \u7684\u5B57\u8282\u7801\u662F\u89E3\u91CA\u6267\u884C\u7684\uFF0C\u6548\u7387\u5F88\u4F4E\u3002\u5728 Java \u53D1\u5C55\u5386\u53F2\u4E2D\uFF0C\u6709\u4E24\u5957\u89E3\u91CA\u6267\u884C\u5668\uFF1A\u53E4\u8001\u7684\u5B57\u8282\u7801\u89E3\u91CA\u5668\u3001\u73B0\u5728\u88AB\u5E7F\u6CDB\u4F7F\u7528\u7684\u6A21\u677F\u89E3\u91CA\u5668\u3002\u5B57\u8282\u7801\u89E3\u91CA\u5668\u5728\u6267\u884C\u65F6\u901A\u8FC7\u7EAF\u8F6F\u4EF6\u4EE3\u7801\u6A21\u62DF\u5B57\u8282\u7801\u7684\u6267\u884C\uFF0C\u6548\u7387\u975E\u5E38\u4F4E\u3002\u76F8\u6BD4\u4E4B\u4E0B\uFF0C\u6A21\u677F\u89E3\u91CA\u5668\u5C06\u6BCF\u4E00\u6761\u5B57\u8282\u7801\u548C\u4E00\u4E2A\u6A21\u677F\u51FD\u6570\u76F8\u5173\u8054\uFF0C\u800C\u6A21\u677F\u51FD\u6570\u4E2D\u76F4\u63A5\u4EA7\u751F\u8FD9\u6761\u5B57\u8282\u7801\u6267\u884C\u65F6\u7684\u673A\u5668\u7801\uFF0C\u4ECE\u800C\u63D0\u9AD8\u4E86\u89E3\u91CA\u5668\u7684\u6027\u80FD\u3002\u4F46\u5373\u4FBF\u5982\u6B64\uFF0C\u4EC5\u51ED\u501F\u89E3\u91CA\u5668\uFF0C\u865A\u62DF\u673A\u7684\u6267\u884C\u6548\u7387\u4F9D\u7136\u5F88\u4F4E\uFF0C\u4E3A\u4E86\u89E3\u51B3\u8FD9\u4E2A\u95EE\u9898\uFF0C\u865A\u62DF\u673A\u5E73\u53F0\u652F\u6301\u4E00\u79CD\u53EB\u4F5C\u5373\u65F6\u7F16\u8BD1\u7684\u6280\u672F\u3002</p><p>\u5373\u65F6\u7F16\u8BD1\u7684\u76EE\u7684\u662F\u907F\u514D\u51FD\u6570\u88AB\u89E3\u91CA\u6267\u884C\uFF0C\u800C\u662F\u5C06\u6574\u4E2A\u51FD\u6570\u4F53\u7F16\u8BD1\u6210\u673A\u5668\u7801\uFF0C\u6BCF\u6B21\u51FD\u6570\u6267\u884C\u65F6\uFF0C\u53EA\u6267\u884C\u7F16\u8BD1\u540E\u7684\u673A\u5668\u7801\u5373\u53EF\uFF0C\u8FD9\u79CD\u65B9\u5F0F\u53EF\u4EE5\u4F7F\u6267\u884C\u6548\u7387\u5927\u5E45\u5EA6\u63D0\u5347\u3002</p><h3 id="_11-7-1-\u5F00\u542F-jit-\u7F16\u8BD1" tabindex="-1"><a class="header-anchor" href="#_11-7-1-\u5F00\u542F-jit-\u7F16\u8BD1" aria-hidden="true">#</a> 11.7.1 \u5F00\u542F JIT \u7F16\u8BD1</h3><p>Java \u865A\u62DF\u673A\u6709 3 \u79CD\u6267\u884C\u6A21\u5F0F\uFF0C\u5206\u522B\u662F\u89E3\u91CA\u6267\u884C\u3001\u6DF7\u5408\u6A21\u5F0F\u548C\u7F16\u8BD1\u6267\u884C\uFF0C\u9ED8\u8BA4\u60C5\u51B5\u4E0B\u5904\u4E8E\u6DF7\u5408\u6A21\u5F0F\u4E2D\u3002\u4F7F\u7528\u547D\u4EE4\u884C java -version \u53EF\u4EE5\u67E5\u770B\u865A\u62DF\u673A\u7684\u6267\u884C\u6A21\u5F0F\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>C:\\Users\\Administrator&gt;java -version
java version &quot;10.0.2&quot; 2018-07-17
Java(TM) SE Runtime Environment 18.3 (build 10.0.2+13)
Java HotSpot(TM) 64-Bit Server VM 18.3 (build 10.0.2+13, mixed mode)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u9762\u8F93\u51FA\u7684 &quot;mixed mode&quot; \u5C31\u8868\u793A\u6DF7\u5408\u6A21\u5F0F\u3002\u5728\u6DF7\u5408\u6A21\u5F0F\u4E2D\uFF0C\u90E8\u5206\u51FD\u6570\u4F1A\u88AB\u89E3\u91CA\u6267\u884C\uFF0C\u90E8\u5206\u51FD\u6570\u53EF\u80FD\u88AB\u7F16\u8BD1\u6267\u884C\u3002\u865A\u62DF\u673A\u51B3\u5B9A\u51FD\u6570\u662F\u5426\u9700\u8981\u7F16\u8BD1\u6267\u884C\u7684\u4F9D\u636E\u662F\u5224\u65AD\u8BE5\u51FD\u6570\u662F\u5426\u4E3A\u70ED\u70B9\u4EE3\u7801\u3002\u5982\u679C\u51FD\u6570\u7684\u8C03\u7528\u9891\u7387\u5F88\u9AD8\uFF0C\u88AB\u53CD\u590D\u4F7F\u7528\uFF0C\u90A3\u4E48\u5C31\u4F1A\u88AB\u8BA4\u4E3A\u662F\u70ED\u70B9\uFF0C\u5C31\u4F1A\u88AB\u7F16\u8BD1\u6267\u884C\u3002</p><p>\u89E3\u91CA\u6267\u884C\u6A21\u5F0F\u8868\u793A\u5168\u90E8\u4EE3\u7801\u5747\u89E3\u91CA\u6267\u884C\uFF0C\u4E0D\u505A\u4EFB\u4F55 JIT \u7F16\u8BD1\uFF0C\u53EF\u4EE5\u4F7F\u7528\u53C2\u6570 -Xint \u6765\u5F00\u542F\u89E3\u91CA\u6267\u884C\u6A21\u5F0F\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>C:\\Users\\Administrator&gt;java -Xint -version
java version \u201D10.0.2&quot; 2018-07-17
Java(TM) SE Runtime Environment 18.3 (build 10.0.2+13)
Java HotSpot(TM) 64-Bit Server VM 18.3 (build 10.0.2+13, interpreted mode)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7F16\u8BD1\u6267\u884C\u6A21\u5F0F\u548C\u89E3\u91CA\u6267\u884C\u6A21\u5F0F\u76F8\u53CD\uFF0C\u5BF9\u4E8E\u6240\u6709\u7684\u51FD\u6570\uFF0C\u65E0\u8BBA\u662F\u5426\u662F\u70ED\u70B9\u4EE3\u7801\uFF0C\u90FD\u4F1A\u88AB\u7F16\u8BD1\u6267\u884C\uFF0C\u4F7F\u7528\u53C2\u6570 -Xcomp \u53EF\u4EE5\u8BBE\u7F6E\u4E3A\u7F16\u8BD1\u6A21\u5F0F\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>C:\\Users\\Administrator&gt;java -Xcomp -version
java version \u201D10.0.2&quot; 2018-07-17
Java(TM) SE Runtime Environment 18.3 (build 10.0.2+13)
Java HotSpot(TM) 64-Bit Server VM 18.3 (build 10.0.2+13, compiled mode)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E00\u822C\u6765\u8BF4\uFF0C\u7F16\u8BD1\u6A21\u5F0F\u7684\u6267\u884C\u6548\u7387\u4F1A\u8FDC\u8FDC\u9AD8\u4E8E\u89E3\u91CA\u6A21\u5F0F\u3002</p><p>\u3010\u793A\u4F8B 11-36\u3011\u4E0B\u9762\u7684\u4EE3\u7801\u4E0D\u505C\u5730\u8BA1\u7B97\u5706\u5468\u7387\u7684\u6570\u503C\uFF0C\u5E76\u7ED9\u51FA\u4E86\u8FD0\u884C\u7684\u8017\u65F6\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">calcPi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> re <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        re <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> re <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">calcPi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;spend:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>e <span class="token operator">-</span> b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F7F\u7528\u865A\u62DF\u673A\u53C2\u6570 -Xint \u8FD0\u884C\u4EE5\u4E0A\u4EE3\u7801\uFF0C\u8F93\u51FA\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>spend:2441ms
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4F7F\u7528\u865A\u62DF\u673A\u53C2\u6570 -Xcomp \u8FD0\u884C\u4EE5\u4E0A\u4EE3\u7801\uFF0C\u8F93\u51FA\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>spend:400ms
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5F88\u660E\u663E\uFF0C\u5728\u672C\u4F8B\u4E2D\u4F7F\u7528\u7F16\u8BD1\u8FD0\u884C\u8981\u6BD4\u89E3\u91CA\u8FD0\u884C\u5FEB\u5927\u7EA6 6 \u500D\u3002</p><h3 id="_11-7-2-jit-\u7F16\u8BD1\u9608\u503C" tabindex="-1"><a class="header-anchor" href="#_11-7-2-jit-\u7F16\u8BD1\u9608\u503C" aria-hidden="true">#</a> 11.7.2 JIT \u7F16\u8BD1\u9608\u503C</h3><p>\u5728\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0CJIT \u4F7F\u7528\u6DF7\u5408\u6A21\u5F0F\u8FD0\u884C\uFF08\u6307\u5B9A\u53C2\u6570\u4E3A -Xmixed\uFF09\uFF0C\u5728\u6DF7\u5408\u6A21\u5F0F\u4E2D\uFF0C\u53EA\u4F1A\u5BF9\u70ED\u70B9\u4EE3\u7801\u8FDB\u884C\u5373\u65F6\u7F16\u8BD1\u3002\u5BF9\u4E8E\u662F\u5426\u4E3A\u70ED\u70B9\u4EE3\u7801\uFF0C\u865A\u62DF\u673A\u5185\u6709\u4E00\u4E2A\u9608\u503C\u8FDB\u884C\u5224\u65AD\uFF0C\u5F53\u51FD\u6570\u8C03\u7528\u6B21\u6570\u8D85\u8FC7\u8FD9\u4E2A\u9608\u503C\u65F6\uFF0C\u5C31\u88AB\u8BA4\u4E3A\u662F\u70ED\u70B9\u4EE3\u7801\uFF0C\u8FDB\u884C\u5373\u65F6\u7F16\u8BD1\u3002\u5728 Client \u6A21\u5F0F\u4E0B\uFF0C\u8FD9\u4E2A\u9608\u503C\u4E3A 1500 \u6B21\uFF0C\u5728 Server \u6A21\u5F0F\u4E0B\u8FD9\u4E2A\u9608\u503C\u4E3A 10000 \u6B21\u3002\u4F7F\u7528\u53C2\u6570 -XX:CompileThreshold \u53EF\u4EE5\u8BBE\u7F6E\u8FD9\u4E2A\u9608\u503C\uFF0C\u4F7F\u7528\u53C2\u6570 -XX:+PrintCompilation \u53EF\u4EE5\u6253\u5370\u5373\u65F6\u7F16\u8BD1\u7684\u65E5\u5FD7\u3002</p><p>\u3010\u793A\u4F8B 11-37\u3011\u4E0B\u9762\u7684\u4EE3\u7801\u8C03\u7528\u4E86 500 \u6B21 met() \u51FD\u6570\uFF0C\u5728\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0Cmet() \u51FD\u6570\u4E0D\u4F1A\u88AB\u7F16\u8BD1\uFF0C\u4F46\u662F\u901A\u8FC7\u8BBE\u7F6E -XX:CompileThreshold \u4E3A 500\uFF0Cmet() \u51FD\u6570\u5C31\u4F1A\u6210\u4E3A\u70ED\u70B9\u4EE3\u7801\uFF0C\u88AB\u7F16\u8BD1\u4E3A\u673A\u5668\u7801\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">met</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    b <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">met</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4EE5\u53C2\u6570 -XX:CompileThreshold=500 -XX:+PrintCompilation \u8FD0\u884C\u4EE5\u4E0A\u4EE3\u7801\uFF0C\u90E8\u5206\u8F93\u51FA\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>68  19  s  java.lang.StringBuffer::append (8 bytes)
69  20     java.io.Win32FileSystem::normalize (231 bytes)
70  21     geym.zbase.ch11.jit.JITSimpleTest::met (9 bytes)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u51FD\u6570 met() \u5DF2\u7ECF\u88AB\u7F16\u8BD1\u4E3A\u673A\u5668\u7801\u3002</p><h3 id="_11-7-3-\u591A\u7EA7\u7F16\u8BD1\u5668" tabindex="-1"><a class="header-anchor" href="#_11-7-3-\u591A\u7EA7\u7F16\u8BD1\u5668" aria-hidden="true">#</a> 11.7.3 \u591A\u7EA7\u7F16\u8BD1\u5668</h3><p>Java \u865A\u62DF\u673A\u4E2D\u62E5\u6709\u5BA2\u6237\u7AEF\u7F16\u8BD1\u5668\u548C\u670D\u52A1\u7AEF\u7F16\u8BD1\u5668\u4E24\u79CD\u7F16\u8BD1\u7CFB\u7EDF\uFF0C\u4E00\u822C\u79F0\u4E3A C1 \u548C C2 \u7F16\u8BD1\u5668\u3002\u5F53\u4F7F\u7528 -client \u53C2\u6570\u65F6\uFF0C\u865A\u62DF\u673A\u4F1A\u4F7F\u7528 C1 \u7F16\u8BD1\u5668\uFF0C\u4F7F\u7528 -server \u53C2\u6570\u65F6\uFF0C\u865A\u62DF\u673A\u4F1A\u4F7F\u7528 C2 \u7F16\u8BD1\u5668\u3002C1 \u7F16\u8BD1\u5668\u7684\u7279\u70B9\u662F\u7F16\u8BD1\u901F\u5EA6\u5FEB\uFF0CC2 \u7F16\u8BD1\u5668\u7684\u7279\u70B9\u662F\u4F1A\u505A\u66F4\u591A\u7684\u7F16\u8BD1\u65F6\u4F18\u5316\uFF0C\u56E0\u6B64\u7F16\u8BD1\u65F6\u95F4\u4F1A\u957F\u4E8E C1\uFF0C\u4F46\u662F\u7F16\u8BD1\u540E\u7684\u4EE3\u7801\u8D28\u91CF\u4F1A\u9AD8\u4E8E C1\u3002\u4E3A\u4E86\u4F7F C1 \u548C C2 \u5728\u7F16\u8BD1\u901F\u5EA6\u548C\u6267\u884C\u6548\u7387\u4E4B\u95F4\u53D6\u5F97\u5E73\u8861\uFF0C\u865A\u62DF\u673A\u652F\u6301\u4E00\u79CD\u53EB\u4F5C\u591A\u7EA7\u7F16\u8BD1\u7684\u7B56\u7565\u3002\u591A\u7EA7\u7F16\u8BD1\u5C06\u7F16\u8BD1\u7684\u5C42\u6B21\u5206\u4E3A\u4EE5\u4E0B 5 \u7EA7\u3002</p><ul><li><p>0 \u7EA7\uFF08\u89E3\u91CA\u6267\u884C\uFF09\uFF1A\u91C6\u7528\u89E3\u91CA\u6267\u884C\uFF0C\u4E0D\u91C6\u96C6\u6027\u80FD\u76D1\u63A7\u6570\u636E\u3002</p></li><li><p>1 \u7EA7\uFF08\u7B80\u5355\u7684 C1 \u7F16\u8BD1\uFF09\uFF1A\u91C6\u7528 C1 \u7F16\u8BD1\u5668\uFF0C\u8FDB\u884C\u6700\u7B80\u5355\u7684\u5FEB\u901F\u7F16\u8BD1\uFF0C\u6839\u636E\u9700\u8981\u91C6\u96C6\u6027\u80FD\u6570\u636E\u3002</p></li><li><p>2 \u7EA7\uFF08\u6709\u9650\u7684 C1 \u7F16\u8BD1\uFF09\uFF1A\u91C6\u7528 C1 \u7F16\u8BD1\u5668\uFF0C\u8FDB\u884C\u66F4\u591A\u7684\u4F18\u5316\u7F16\u8BD1\uFF0C\u53EF\u80FD\u4F1A\u6839\u636E\u7B2C 1 \u7EA7\u91C6\u96C6\u7684\u6027\u80FD\u7EDF\u8BA1\u6570\u636E\u8FDB\u4E00\u6B65\u4F18\u5316\u7F16\u8BD1\u4EE3\u7801\u3002</p></li><li><p>3 \u7EA7\uFF08\u5B8C\u5168 C1 \u7F16\u8BD1\uFF09\uFF1A\u5B8C\u5168\u4F7F\u7528 C1 \u7F16\u8BD1\u5668\u7684\u6240\u6709\u529F\u80FD\uFF0C\u4F1A\u91C6\u96C6\u6027\u80FD\u6570\u636E\u8FDB\u884C\u4F18\u5316\u3002</p></li><li><p>4 \u7EA7\uFF08C2 \u7F16\u8BD1\uFF09\uFF1A\u5B8C\u5168\u4F7F\u7528 C2 \u7F16\u8BD1\u5668\u8FDB\u884C\u7F16\u8BD1\uFF0C\u8FDB\u884C\u5B8C\u5168\u7684\u4F18\u5316\u3002</p></li></ul><p>\u8981\u4F7F\u7528\u591A\u7EA7\u7F16\u8BD1\u5668\u53EF\u4EE5\u4F7F\u7528\u53C2\u6570 -XX:+TieredCompilation \u6253\u5F00\u591A\u7EA7\u7F16\u8BD1\u5668\u7684\u7B56\u7565\u3002\u5982\u679C\u4F7F\u7528\u8BE5\u53C2\u6570\uFF0C\u90A3\u4E48\u865A\u62DF\u673A\u5FC5\u987B\u4F7F\u7528 -server \u6A21\u5F0F\u542F\u52A8\uFF0C\u5982\u679C\u4F7F\u7528 -client \u6A21\u5F0F\u542F\u52A8\uFF0C\u90A3\u4E48\u5206\u7EA7\u6A21\u5F0F\u4F9D\u7136\u4E0D\u4F1A\u5F00\u542F\u3002</p><p>\u3010\u793A\u4F8B 11-38\u3011\u4E0B\u9762\u7684\u4EE3\u7801\u9891\u7E41\u8C03\u7528\u4E86 WriterService. service() \u51FD\u6570\uFF0C\u901A\u8FC7\u4E0D\u540C\u7684\u53C2\u6570\u914D\u7F6E\uFF0C\u6765\u5B66\u4E60\u4E00\u4E0B\u591A\u7EA7\u7F16\u8BD1\u5668\u7684\u4F7F\u7528\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WriterMain</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WriterService</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriterService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ws<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;spend:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>e <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ws <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WriterService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DBWriter</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DBWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DBWriter</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;DBWriter&quot;</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F7F\u7528\u53C2\u6570 -XX:+PrintCompilation -server-Xcomp \u8FD0\u884C\u4E0A\u8FF0\u4EE3\u7801\uFF0C\u90E8\u5206\u8F93\u51FA\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>862  382    b    geym.zbase.ch11.jit.deopt.WriterMain::main (74 bytes)
863  382         geym.zbase.ch11.jit.deopt.WriterMain::main (74 bytes) made not entrant
912  397    b    geym.zbase.ch11.jit.deopt.WriterService::&lt;init&gt; (5 bytes)
913  398    b    geym.zbase.ch11.jit.deopt.WriterService::service (13 bytes)
913  398    b    geym.zbase.ch11.jit.deopt.WriterService::service (13 bytes) made not entrant
915  400    b    geym.zbase.ch11.jit.deopt.DBWriter::&lt;init&gt; (5 bytes)             
915  401    b    geym.zbase.ch11.jit.deopt.DBWriter::write (7 bytes)              
918  403    b    geym.zbase.ch11.jit.deopt.WriterService::service (13 bytes) 
919  404  % b     geym.zbase.ch11.jit.deopt.WriterMain::main @ 18 (74 bytes) 
1143  404  %       geym.zbase.ch11.jit.deopt.WriterMain::main @ -2 (74 bytes) made not entrant
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0CWriterService.service() \u548C DBWriter.writer() \u7B49\u51FD\u6570\u90FD\u88AB\u7F16\u8BD1\u6210\u4E86\u672C\u5730\u4EE3\u7801\u3002\u5176\u4E2D\u6709\u4E9B\u51FD\u6570\u540E\u6807\u6CE8\u6709 made not entrant \u6807\u8BB0\uFF0C\u8868\u793A\u8BE5\u51FD\u6570\u7F16\u8BD1\u7ED3\u679C\u88AB\u6807\u8BB0\u4E3A\u4E0D\u53EF\u518D\u7528\uFF0C\u540E\u7EED\u53EF\u80FD\u4F1A\u4ECE\u5185\u5B58\u4E2D\u79FB\u9664\uFF0C\u8868\u793A\u5E9F\u5F03\u3002\u8FD9\u79CD\u60C5\u51B5\u662F\u56E0\u4E3A\u8BE5\u51FD\u6570\u5DF2\u7ECF\u4E0D\u9700\u8981\u518D\u4F7F\u7528\uFF08\u6BD4\u5982\u7C7B\u88AB\u5783\u573E\u56DE\u6536\u5668\u56DE\u6536\uFF0C\u5176\u65B9\u6CD5\u4EE3\u7801\u81EA\u7136\u4E0D\u4F1A\u518D\u88AB\u4F7F\u7528\uFF09\uFF0C\u6216\u8005\u7F16\u8BD1\u5668\u4EA7\u751F\u4E86\u4E00\u4E2A\u66F4\u4F18\u7684\u7F16\u8BD1\u7ED3\u679C\uFF0C\u9700\u8981\u5C06\u65E7\u6570\u636E\u6E05\u9664\u3002</p><p><strong>\u6CE8\u610F</strong>\uFF1Amade not entrant \u72B6\u6001\u53EA\u662F\u8868\u793A\u65B0\u7684\u4EE3\u7801\u8C03\u7528\u4E0D\u80FD\u4F7F\u7528\u8FD9\u5757\u7F16\u8BD1\u7ED3\u679C\uFF0C\u4F46\u53EF\u80FD\u5B58\u5728\u6B63\u5728\u4F7F\u7528\u8BE5\u6BB5\u4EE3\u7801\u5757\u7684\u7A0B\u5E8F\uFF0C\u6240\u4EE5\u8FD8\u4E0D\u80FD\u5B8C\u5168\u4ECE\u7CFB\u7EDF\u4E2D\u6E05\u7406\u3002\u5982\u679C\u4EE3\u7801\u5757\u5DF2\u7ECF\u4E0D\u518D\u88AB\u4F7F\u7528\uFF0C\u5E76\u5904\u4E8E made not entrant \u72B6\u6001\uFF0C\u4E00\u65E6\u88AB\u6E05\u7406\u7EBF\u7A0B\u53D1\u73B0\uFF0C\u4EE3\u7801\u5757\u4F1A\u88AB\u8FDB\u4E00\u6B65\u6807\u8BB0\u4E3A made zombie \u72B6\u6001\uFF08\u50F5\u5C38\u72B6\u6001\uFF09\uFF0C\u6B64\u65F6\u4EE3\u7801\u5E93\u5C06\u88AB\u5F7B\u5E95\u6E05\u9664\u3002</p><p>\u4F7F\u7528\u53C2\u6570 -XX:+PrintCompilation -server -Xcomp -XX:+TieredCompilation \u8FD0\u884C\u4E0A\u8FF0\u4EE3\u7801\uFF0C\u90E8\u5206\u8F93\u51FA\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>50  287    b 3   geym.zbase.ch11.jit.deopt.WriterMain::main (74 bytes)
57  298    b 3   geym.zbase.ch11.jit.deopt.WriterService::&lt;init&gt; (5 bytes)
57  299    b 3   geym.zbase.ch11.jit.deopt.WriterService::service (13 bytes)
57  300    b 3   geym.zbase.ch11.jit.deopt.DBWriter::&lt;init&gt; (5 bytes)
57  301    b 3   geym.zbase.ch11.jit.deopt.DBWriter::write (7 bytes)
59  302    b 4   geym.zbase.ch11.jit.deopt.WriterService::service (13 bytes)
62  299      3   geym.zbase.ch11.jit.deopt.WriterService::service (13 bytes) made not entrant
62  303    b 4  geym.zbase.ch11.jit.deopt.DBWriter::&lt;init&gt; (5 bytes)
63  300      3  geym.zbase.ch11.jit.deopt.DBWriter::&lt;init&gt; (5 bytes) made not entrant
63  304    b 4  geym.zbase.ch11.jit.deopt.DBWriter::write (7 bytes)
63  301      3  geym.zbase.ch11.jit.deopt.DBWriter::write (7 bytes) made not entrant
66  309  % b 4  geym.zbase.ch11.jit.deopt.WriterMain::main @ 18 (74 bytes)
70  310    b 4  geym.zbase.ch11.jit.deopt.WriterMain::main (74 bytes)
73  287      3  geym.zbase.ch11.jit.deopt.WriterMain::main (74 bytes) made not entrant
77  309  % b 4  geym.zbase.ch11.jit.deopt.WriterMain::main @ -2 (74 bytes) made not entrant
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u5728\u4F7F\u7528 -XX:+TieredCompilation \u4E4B\u540E\uFF0CJIT \u7684\u65E5\u5FD7\u53D1\u751F\u4E86\u53D8\u5316\uFF0C\u5728\u8F93\u51FA\u7684\u7ED3\u679C\u4E2D\u591A\u4E86\u4E00\u5217\uFF0C\u589E\u52A0\u7684\u5217\u8868\u793A\u7F16\u8BD1\u7684\u7EA7\u522B\u3002\u8BE5\u65E5\u5FD7\u7684\u6BCF\u4E00\u5217\u7684\u542B\u4E49\u5206\u522B\u5982\u4E0B\u3002</p><ul><li><p>\u65F6\u95F4\u6233\uFF1A\u7CFB\u7EDF\u542F\u52A8\u5230\u7F16\u8BD1\u5B8C\u6210\u65F6\u7684\u6BEB\u79D2\u6570\u3002</p></li><li><p>\u5373\u65F6\u7F16\u8BD1 ID\uFF1A\u7F16\u8BD1\u4EFB\u52A1\u7684\u5185\u90E8 ID\uFF0C\u4E00\u822C\u662F\u4E00\u4E2A\u81EA\u589E\u7684\u503C\u3002</p></li><li><p>\u5C5E\u6027\uFF1A\u63CF\u8FF0\u4EE3\u7801\u72B6\u6001\u7684 5 \u4E2A\u5C5E\u6027\u3002</p><ul><li>%\uFF1A\u662F\u4E00\u4E2A OSR\uFF08\u6808\u4E0A\u66FF\u6362\uFF09\u3002</li><li>s\uFF1A\u662F\u4E00\u4E2A\u540C\u6B65\u65B9\u6CD5\u3002</li><li>!\uFF1A\u65B9\u6CD5\u6709\u5F02\u5E38\u5904\u7406\u5FEB\u3002</li><li>b\uFF1A\u963B\u585E\u6A21\u5F0F\u7F16\u8BD1\u3002</li><li>n\uFF1A\u662F\u672C\u5730\u65B9\u6CD5\u7684\u4E00\u4E2A\u5305\u88C5\u3002</li></ul></li><li><p>\u7F16\u8BD1\u7EA7\u522B\uFF1A0 ~ 4 \u7EA7\u7F16\u8BD1\u3002\u7EA7\u522B\u8D8A\u9AD8\u7F16\u8BD1\u751F\u6210\u7684\u673A\u5668\u7801\u8D28\u91CF\u8D8A\u597D\uFF0C\u7F16\u8BD1\u8017\u65F6\u4E5F\u8D8A\u957F\u3002</p></li><li><p>\u65B9\u6CD5\u540D\uFF1A\u88AB\u7F16\u8BD1\u65B9\u6CD5\u7684\u540D\u79F0\u3002</p></li><li><p>\u65B9\u6CD5\u5927\u5C0F\uFF1A\u88AB\u7F16\u8BD1\u65B9\u6CD5\u7684\u5927\u5C0F\uFF0C\u8FD9\u4E2A\u5927\u5C0F\u662F\u6307 Java \u5B57\u8282\u7801\u5927\u5C0F\uFF0C\u4E0D\u662F\u751F\u6210\u7684\u672C\u5730\u673A\u5668\u7801\u5927\u5C0F\u3002</p></li></ul><p>\u4ECE\u8FD9\u6BB5\u7F16\u8BD1\u65E5\u5FD7\u4E2D\u4E0D\u96BE\u53D1\u73B0\uFF0C\u5728\u65F6\u95F4\u6233\u7B2C 57 \u6BEB\u79D2\u5904\uFF0C301 \u53F7\u7F16\u8BD1\u4E2D\uFF0CDBWriter.writer() \u88AB\u7B2C\u4E00\u6B21\u7F16\u8BD1\u4E3A\u673A\u5668\u7801\uFF0C\u7F16\u8BD1\u7EA7\u522B\u662F 3\u3002\u5728\u7B2C 63 \u6BEB\u79D2\u5904\uFF0C\u8BE5 301 \u53F7\u7F16\u8BD1\u88AB\u6807\u8BB0\u4E3A made not entrant\uFF0C\u5373\u4E0D\u518D\u5141\u8BB8\u4EA7\u751F\u65B0\u7684\u8C03\u7528\uFF0C\u4E0E\u6B64\u540C\u65F6\uFF0C\u7B2C 63 \u6BEB\u79D2\u5904\u7684 304 \u53F7\u7F16\u8BD1\u5C06 DBWriter.writer() \u91CD\u65B0\u7F16\u8BD1\uFF0C\u5E76\u4F7F\u7528\u7F16\u8BD1\u7EA7\u522B 4\u3002\u8FD9\u5C31\u662F\u4E00\u4E2A\u5178\u578B\u7684\u5C42\u6B21\u7F16\u8BD1\u7B56\u7565\u8FDB\u884C\u7F16\u8BD1\u7EA7\u522B\u7684\u63D0\u5347\uFF0C\u540E\u4E00\u6B21\u7F16\u8BD1\u4EA7\u751F\u4E86\u66F4\u4F18\u8D28\u7684\u4EE3\u7801\u3002</p><h3 id="_11-7-4-osr-\u6808\u4E0A\u66FF\u6362" tabindex="-1"><a class="header-anchor" href="#_11-7-4-osr-\u6808\u4E0A\u66FF\u6362" aria-hidden="true">#</a> 11.7.4 OSR \u6808\u4E0A\u66FF\u6362</h3><p>\u4E00\u822C\u6765\u8BF4\uFF0C\u4E00\u6B21\u51FD\u6570\u8C03\u7528\u8981\u4E48\u4F7F\u7528\u89E3\u91CA\u6267\u884C\uFF0C\u8981\u4E48\u4F7F\u7528\u5373\u65F6\u7F16\u8BD1\u540E\u7684\u673A\u5668\u7801\u6267\u884C\u3002\u4ECE\u89E3\u91CA\u6267\u884C\u5207\u6362\u5230\u673A\u5668\u7801\u6267\u884C\uFF0C\u662F\u5728\u8FD9\u4E2A\u51FD\u6570\u7684\u4E24\u6B21\u8C03\u7528\u4E4B\u95F4\u4EA7\u751F\u7684\uFF0C\u5373\u4E00\u4E2A\u51FD\u6570\u7684\u524D\u4E00\u6B21\u51FD\u6570\u8C03\u7528\u53D1\u751F\u65F6\uFF0C\u5C1A\u672A\u51C6\u5907\u597D\u7F16\u8BD1\u540E\u7248\u672C\uFF0C\u5219\u4F1A\u8FDB\u884C\u89E3\u91CA\u6267\u884C\uFF0C\u800C\u4E0B\u4E00\u6B21\u8C03\u7528\u53D1\u751F\u65F6\uFF0C\u53D1\u73B0\u5176\u7F16\u8BD1\u7248\u672C\u5DF1\u7ECF\u51C6\u5907\u597D\uFF0C\u90A3\u4E48\u5C31\u4F1A\u4F7F\u7528\u7F16\u8BD1\u540E\u7684\u7248\u672C\u6267\u884C\u3002\u8FD9\u79CD\u60C5\u51B5\u8986\u76D6\u4E86\u7EDD\u5927\u90E8\u5206\u573A\u5408\uFF0C\u4F46\u662F\u4E0D\u9002\u5408\u90A3\u4E9B\u8C03\u7528\u6B21\u6570\u4E0D\u591A\u4F46\u662F\u51FD\u6570\u4F53\u5185\u5305\u542B\u5927\u91CF\u5FAA\u73AF\u7684\u51FD\u6570\uFF0C\u6BD4\u5982\u5982\u4E0B\u51FD\u6570\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">WriterService</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriterService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ws<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>main() \u51FD\u6570\u88AB\u6267\u884C\u7684\u6B21\u6570\u53EA\u6709\u4E00\u6B21\uFF08\u6216\u8005\u5176\u4ED6\u88AB\u8C03\u7528\u6B21\u6570\u660E\u663E\u4E0D\u591A\u7684\u51FD\u6570\uFF09\uFF0C\u4F46\u662F\u51FD\u6570\u4F53\u5185\u6709\u4E00\u4E2A\u5FAA\u73AF\u6B21\u6570\u5F88\u591A\u7684\u5FAA\u73AF\u4F53\uFF0C\u5728\u8FD9\u79CD\u60C5\u51B5\u4E0B\uFF0C\u7531\u4E8E main() \u51FD\u6570\u4E0D\u53EF\u80FD\u6EE1\u8DB3\u7F16\u8BD1\u6761\u4EF6\uFF0C\u6C38\u8FDC\u5F97\u4E0D\u5230\u7F16\u8BD1\uFF0C\u4F46\u662F\u4ECE\u5B9E\u9645\u8FD0\u884C\u7684\u89D2\u5EA6\u6765\u8BF4\uFF0C\u5FAA\u73AF\u4EE3\u7801\u88AB\u5927\u91CF\u53CD\u590D\u6267\u884C\uFF0C\u662F\u6709\u7F16\u8BD1\u4EF7\u503C\u7684\u3002\u4E3A\u4E86\u5E94\u5BF9\u8FD9\u79CD\u60C5\u51B5\uFF0C\u7F16\u8BD1\u5668\u4F1A\u8BB0\u5F55\u5FAA\u73AF\u7684\u6B21\u6570\uFF0C\u4E00\u65E6\u5FAA\u73AF\u6B21\u6570\u8FBE\u5230\u4E00\u5B9A\u7684\u9608\u503C\uFF08\u4E00\u822C\u5728 1 \u4E07\u6B21\u5DE6\u53F3\uFF09\uFF0C\u5C31\u4F1A\u8BA4\u4E3A\u8FD9\u6BB5\u5FAA\u73AF\u4EE3\u7801\u4E5F\u662F\u70ED\u70B9\u4EE3\u7801\uFF0C\u5E76\u89E6\u53D1\u5373\u65F6\u7F16\u8BD1\u3002</p><p>\u7F16\u8BD1\u5B8C\u6210\u540E\uFF0C\u7531\u4E8E main() \u51FD\u6570\u5F88\u5C11\u88AB\u6267\u884C\uFF0C\u751A\u81F3\u53EF\u80FD\u6C38\u8FDC\u4E0D\u4F1A\u518D\u88AB\u6267\u884C\u4E86\uFF0C\u865A\u62DF\u673A\u9700\u8981\u4E00\u4E2A\u5207\u5165\u70B9\u6765\u52A8\u6001\u5C06\u6B63\u5728\u6267\u884C\u7684\u5FAA\u73AF\u4F53\u4EE3\u7801\u66FF\u6362\u4E3A\u7F16\u8BD1\u540E\u7248\u672C\u3002\u8FD9\u79CD\u4E0D\u7B49\u5F85\u51FD\u6570\u8FD0\u884C\u7ED3\u675F\uFF0C\u5728\u5FAA\u73AF\u4F53\u5185\u5C31\u5C06\u4EE3\u7801\u66FF\u6362\u4E3A\u7F16\u8BD1\u7248\u672C\u7684\u6280\u672F\uFF0C\u53EB\u4F5C OSR\uFF08On Stack Relapcement\uFF0C\u6808\u4E0A\u66FF\u6362\uFF09\u3002\u5982\u56FE11.22 \u6240\u793A\uFF0C\u5DE6\u4FA7\u8868\u793A\u666E\u901A\u7684\u65B9\u6CD5\u7F16\u8BD1\uFF0C\u6BCF\u6B21\u5728\u65B9\u6CD5\u5165\u53E3\u8FDB\u884C\u5224\u65AD\uFF0C\u53F3\u4FA7\u8868\u793A\u6808\u4E0A\u66FF\u6362\uFF0C\u5728\u65B9\u6CD5\u5165\u53E3\u65F6\u5E76\u4E0D\u68C0\u67FB\uFF08\u65B9\u6CD5\u8C03\u7528\u6B21\u6570\u5F88\u5C11\uFF09\uFF0C\u800C\u5728\u6BCF\u6B21\u5FAA\u73AF\u5F00\u59CB\u65F6\uFF0C\u5224\u65AD\u662F\u5426\u6709\u7F16\u8BD1\u7248\u672C\u53EF\u4F9B\u4F7F\u7528\u3002</p><p><img src="`+q+`" alt="\u56FE11-22" loading="lazy"></p><p>\u56FE11.22 OSR \u548C\u666E\u901A\u65B9\u6CD5\u7F16\u8BD1\u533A\u522B</p><p>\u5728\u4E0A\u4E00\u8282\u7684\u5B9E\u4F8B\u4E2D\uFF0Cmain() \u51FD\u6570\u5DF2\u7ECF\u4F7F\u7528\u4E86 OSR \u8FDB\u884C\u7F16\u8BD1\u548C\u8FD0\u884C\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>66  309 % b 4    geym.zbase.ch11.jit.deopt.WriterMain::main @ 18 (74 bytes)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u65E5\u5FD7\u4E2D\uFF0C\uFF05 \u8868\u793A OSR\u3002</p><p><strong>\u6CE8\u610F</strong>\uFF1A\u4E25\u683C\u6765\u8BF4\uFF0C\u5E76\u4E0D\u662F\u901A\u8FC7\u5FAA\u73AF\u6B21\u6570\u548C\u5FAA\u73AF\u5165\u53E3\u6765\u8FDB\u884C OSR \u5224\u65AD\u7684\uFF0C\u800C\u662F\u4F7F\u7528\u4E00\u79CD\u53EB\u4F5C\u56DE\u8FB9\uFF08back-edge\uFF09\u8BA1\u6570\u5668\u548C\u56DE\u8FB9\u6307\u4EE4\u6765\u8FDB\u884C\u5224\u65AD\u7684\u3002\u6240\u8C13\u56DE\u8FB9\uFF0C\u5C31\u662F\u5B57\u8282\u7801\u6307\u4EE4\u4E2D\u5411\u540E\u8DF3\u8F6C\u7684\u6307\u4EE4\u3002\u5F53\u7136\uFF0C\u5728\u5927\u90E8\u5206\u60C5\u51B5\u4E0B\uFF0C\u8FD9\u79CD\u5411\u540E\u8DF3\u8F6C\u7684\u6307\u4EE4\u662F\u7531\u5FAA\u73AF\u4EA7\u751F\u7684\u3002</p><h3 id="_11-7-5-\u65B9\u6CD5\u5185\u8054" tabindex="-1"><a class="header-anchor" href="#_11-7-5-\u65B9\u6CD5\u5185\u8054" aria-hidden="true">#</a> 11.7.5 \u65B9\u6CD5\u5185\u8054</h3><p>\u65B9\u6CD5\u5185\u8054\u662F\u4E00\u79CD\u6709\u6548\u7684\u4F18\u5316\u624B\u6BB5\uFF0C\u5B83\u53EF\u4EE5\u51CF\u5C11\u65B9\u6CD5\u8C03\u7528\u7684\u6B21\u6570\uFF0C\u4ECE\u800C\u63D0\u9AD8\u7CFB\u7EDF\u6027\u80FD\u3002JIT \u7F16\u8BD1\u5668\u9ED8\u8BA4\u4F1A\u8FDB\u884C\u65B9\u6CD5\u5185\u8054\u4F18\u5316\u3002</p><p>\u3010\u793A\u4F8B 11-39\u3011\u4E0B\u9762\u7684\u4F8B\u5B50\u8BF4\u660E\u4E86\u4EC0\u4E48\u662F\u65B9\u6CD5\u5185\u8054\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InLineMain</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">100000000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728 main() \u51FD\u6570\u4E2D\uFF0C\u8C03\u7528 inc() \u51FD\u6570\u3002\u800C inc() \u51FD\u6570\u7684\u5185\u5BB9\u5F88\u5C11\uFF0C\u5C5E\u4E8E\u5178\u578B\u7684\u5C0F\u65B9\u6CD5\u3002\u56E0\u6B64\u4EA7\u751F\u4E00\u6B21\u51FD\u6570\u8C03\u7528\u7684\u6210\u672C\u5C31\u4F1A\u76F8\u5BF9\u6BD4\u8F83\u9AD8\uFF0C\u5BF9 inc() \u51FD\u6570\u8FDB\u884C\u5185\u8054\u540E\uFF0C\u5FAA\u73AF\u4F53\u5C31\u4F1A\u53D8\u6210\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">100000000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\u5FAA\u73AF\u51FD\u6570\u8C03\u7528\u88AB\u5265\u79BB\uFF0C\u539F\u6709\u7684\u51FD\u6570\u4F53\u76F4\u63A5\u88AB\u5D4C\u5165\u5FAA\u73AF\u4F53\u5185\uFF0C\u4ECE\u800C\u6709\u6548\u51CF\u5C11\u51FD\u6570\u8C03\u7528\u6B21\u6570\u3002\u5BF9\u4E8E\u8FD9\u79CD\u5C0F\u65B9\u6CD5\u6548\u679C\u662F\u6781\u5176\u660E\u663E\u7684\uFF0C\u4F7F\u7528 -XX:+Inline \u53C2\u6570\u53EF\u4EE5\u6253\u5F00\u5185\u8054\u4F18\u5316\u3002\u4F7F\u7528\u53C2\u6570 -Xcomp -server -XX:+Inline \u8FD0\u884C\u793A\u4F8B\u4E2D\u7684 InLineMain.main()\uFF0C\u8F93\u51FA\uFF08\u8017\u65F6\uFF09\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>7
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4F7F\u7528 -Xcomp -server -XX:-Inline \u53C2\u6570\u5173\u95ED\u5185\u8054\uFF0C\u518D\u6B21\u8FD0\u884C\uFF0C\u8F93\u51FA\uFF08\u8017\u65F6\uFF09\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>236
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u7531\u6B64\u53EF\u89C1\uFF0C\u5185\u8054\u7684\u4F18\u5316\u6548\u679C\u662F\u975E\u5E38\u663E\u8457\u7684\u3002\u4F46\u662F\u5185\u8054\u4F1A\u589E\u5927\u7CFB\u7EDF\u6267\u884C\u4EE3\u7801\u7684\u4F53\u79EF\uFF0C\u5BF9\u4E8E\u5927\u7684\u65B9\u6CD5\u4F53\uFF0C\u4F7F\u7528\u5185\u8054\u4E5F\u9700\u8981\u8C28\u614E\uFF0C\u865A\u62DF\u673A\u63D0\u4F9B\u4E86\u4E00\u4E9B\u53C2\u6570\u6765\u63A7\u5236\u5BF9\u4E8E\u591A\u5927\u7684\u4EE3\u7801\u4F53\u79EF\u5141\u8BB8\u8FDB\u884C\u5185\u8054\uFF0C\u6BD4\u5982 -XX:FreqInlineSize \u53C2\u6570\uFF0C\u53EF\u4EE5\u63A7\u5236\u70ED\u70B9\u65B9\u6CD5\u8FDB\u884C\u5185\u8054\u7684\u4F53\u79EF\u4E0A\u9650\uFF0C\u4F46\u51E1\u65B9\u6CD5\u4F53\u79EF\u5927\u4E8E\u7ED9\u5B9A\u503C\uFF0C\u90FD\u4E0D\u4F1A\u8FDB\u884C\u5185\u8054\u4F18\u5316\u3002</p><h3 id="_11-7-6-\u8BBE\u7F6E\u4EE3\u7801\u7F13\u5B58\u5927\u5C0F" tabindex="-1"><a class="header-anchor" href="#_11-7-6-\u8BBE\u7F6E\u4EE3\u7801\u7F13\u5B58\u5927\u5C0F" aria-hidden="true">#</a> 11.7.6 \u8BBE\u7F6E\u4EE3\u7801\u7F13\u5B58\u5927\u5C0F</h3><p>\u5B57\u8282\u7801\u88AB\u7F16\u8BD1\u4E3A\u673A\u5668\u7801\u540E\uFF0C\u5F97\u5230\u7684\u7ED3\u679C\u9700\u8981\u5728\u5185\u5B58\u4E2D\u4FDD\u5B58\uFF0C\u4F7F\u7528\u3002\u5B58\u653E\u8FD9\u4E9B\u4EE3\u7801\u7684\u5185\u5B58\u533A\u57DF\u79F0\u4E3A\u4EE3\u7801\u7F13\u5B58\uFF08Code Cache\uFF09\u3002\u4E00\u65E6\u4EE3\u7801\u7F13\u5B58\u7A7A\u95F4\u88AB\u7528\u5B8C\uFF0C\u865A\u62DF\u673A\u5E76\u4E0D\u4F1A\u50CF\u5806\u6216\u8005\u6C38\u4E45\u533A\u90A3\u6837\u66B4\u529B\u5730\u76F4\u63A5\u629B\u51FA\u5185\u5B58\u6EA2\u51FA\u9519\u8BEF\uFF0C\u4FDD\u6301\u7CFB\u7EDF\u7EE7\u7EED\u8FD0\u884C\u3002\u7CFB\u7EDF\u505C\u6B62 JIT \u7F16\u8BD1\u540E\uFF0C\u540E\u7EED\u672A\u7F16\u8BD1\u7684\u4EE3\u7801\u5168\u90E8\u4EE5\u89E3\u91CA\u65B9\u5F0F\u8FD0\u884C\uFF0C\u6545\u7CFB\u7EDF\u6027\u80FD\u4F1A\u53D7\u5230\u5F71\u54CD\u3002\u4EE3\u7801\u7F13\u5B58\u7A7A\u95F4\u7684\u6E05\u7406\u5DE5\u4F5C\u4E5F\u662F\u5728\u7CFB\u7EDF GC \u65F6\u5B8C\u6210\u7684\u3002</p><p>\u4EE3\u7801\u7F13\u5B58\u7A7A\u95F4\u7684\u5927\u5C0F\u53EF\u4EE5\u4F7F\u7528\u53C2\u6570 -XX:ReservedCodeCacheSize \u6307\u5B9A\u3002\u4E00\u822C\u5728 32 \u4F4D\u7684 Client \u6A21\u5F0F\u4E0B\uFF0C\u8FD9\u4E2A\u503C\u4E3A 32MB\u3002\u8BFB\u8005\u53EF\u4EE5\u6839\u636E\u5E94\u7528\u7684\u9700\u8981\u8BBE\u5B9A\u8FD9\u4E2A\u503C\u3002</p><p>\u3010\u793A\u4F8B 11-40\u3011\u4E0B\u9762\u4F8B\u5B50\u663E\u793A\u4E86\u4EE3\u7801\u7F13\u5B58\u7A7A\u95F4\u7684\u5927\u5C0F\u8BBE\u7F6E\uFF0C\u4EE5\u53CA\u4EE3\u7801\u7F13\u5B58\u7A7A\u95F4\u7684\u56DE\u6536\u60C5\u51B5\u3002\u8BFB\u8005\u9700\u8981\u77E5\u9053\uFF0C\u4EE3\u7801\u7F13\u5B58\u7A7A\u95F4\u8BBE\u7F6E\u5F97\u8D8A\u5927\uFF0C\u90A3\u4E48\u53EF\u4EE5\u4FDD\u5B58\u7684\u88AB\u7F16\u8BD1\u7684\u65B9\u6CD5\u5C31\u8D8A\u591A\u3002\u800C\u4E00\u65E6\u4EE3\u7801\u7F13\u5B58\u7A7A\u95F4\u8017\u5C3D\uFF0CJIT \u7F16\u8BD1\u5668\u505C\u6B62\u5DE5\u4F5C\uFF0C\u5C31\u518D\u4E5F\u65E0\u6CD5\u542F\u52A8 JIT \u7F16\u8BD1\u4E86\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CodeCacheJit</span> <span class="token keyword">implements</span> <span class="token class-name">Opcodes</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createAndCall</span><span class="token punctuation">(</span><span class="token class-name">String</span> hellostr<span class="token punctuation">,</span> <span class="token class-name">String</span> classname<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span>
            <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">SecurityException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_MAXS <span class="token operator">|</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_FRAMES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cw<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span>V1_7<span class="token punctuation">,</span> ACC_PUBLIC<span class="token punctuation">,</span> classname<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;java/lang/Object&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodVisitor</span> mw <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>ACC_PUBLIC<span class="token punctuation">,</span> <span class="token string">&quot;&lt;init&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; ()V&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitVarInsn</span><span class="token punctuation">(</span>ALOAD<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitMethodInsn</span><span class="token punctuation">(</span>INVOKESPECIAL<span class="token punctuation">,</span> <span class="token string">&quot;java/lang/Object&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;init&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; ()V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitInsn</span><span class="token punctuation">(</span>RETURN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitMaxs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>ACC_PUBLIC <span class="token operator">+</span> ACC_STATIC<span class="token punctuation">,</span> <span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;([Ljava/lang/String;)V&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitFieldInsn</span><span class="token punctuation">(</span>GETSTATIC<span class="token punctuation">,</span> <span class="token string">&quot;java/lang/System&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;out&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Ljava/io/PrintStream;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitLdcInsn</span><span class="token punctuation">(</span>hellostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitMethodInsn</span><span class="token punctuation">(</span>INVOKEVIRTUAL<span class="token punctuation">,</span> <span class="token string">&quot;java/io/PrintStream&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;println&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;(Ljava/lang/String;)V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitInsn</span><span class="token punctuation">(</span>RETURN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitMaxs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JitClassLoader</span> loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JitClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> m<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            m <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">&quot;defineClass&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            m<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Class</span> exampleClass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> m<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> classname<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> code<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            exampleClass<span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">createAndCall</span><span class="token punctuation">(</span><span class="token string">&quot;hello, world&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">&quot;Ex&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u505C\u6B62 JIT \u540E\u518D GC, JIT \u4E0D\u4F1A\u542F\u7528\u4E86</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">2500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E0A\u8FF0\u4EE3\u7801\u5728 main() \u51FD\u6570\u4E2D\u53CD\u590D\u8C03\u7528 createAndCall() \u51FD\u6570\uFF0C\u8FD9\u4E2A\u51FD\u6570\u6BCF\u6B21\u65B0\u5EFA\u4E00\u4E2A\u7C7B\uFF0C\u5E76\u8C03\u7528\u8FD9\u4E2A\u7C7B\u7684 main() \u51FD\u6570\u3002\u7A0B\u5E8F\u7B2C 40 \u884C\uFF0C\u5728\u8C03\u7528 2500 \u6B21\u4EE5\u540E\uFF0C\u8FDB\u884C\u663E\u5F0F\u7684 GC \u64CD\u4F5C\u3002</p><p>\u4F7F\u7528\u4EE5\u4E0B\u53C2\u6570\u8FD0\u884C\u8FD9\u6BB5\u4EE3\u7801\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-XX:+PrintCompilation -XX:ReservedCodeCacheSize=5M -Xcomp 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u5F97\u5230\u7A0B\u5E8F\u90E8\u5206\u8F93\u51FA\u5982\u4E0B\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>hello,world2041
1143  2777  b    Ex2042::main (9 bytes)
hello,world2042
1143  2778  b    Ex2043::main (9 bytes)
hello,world2043
hello,world2044
hello,world2045
hello,world2046
hello,world2571
hello,world2572
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u5728 2041 \u6B21\u8C03\u7528\u540E\uFF0CJIT \u7F16\u8BD1\u88AB\u505C\u6B62\uFF0C\u4E0D\u518D\u6709\u4EFB\u4F55 JIT \u7F16\u8BD1\u65E5\u5FD7\u4FE1\u606F\u8F93\u51FA\u3002\u800C\u5728 2500 \u6B21\u8C03\u7528\u540E\uFF0C\u7CFB\u7EDF\u8C03\u7528\u663E\u5F0F GC \u540E\uFF0C\u5E76\u6CA1\u6709\u4EFB\u4F55\u6548\u679C\u3002</p><p>\u5C06\u7A0B\u5E8F\u7B2C 40 \u884C\u6539\u4E3A\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u4EE5\u76F8\u540C\u7684\u53C2\u6570\u8FD0\u884C\u4EE5\u4E0A\u4EE3\u7801\uFF0C\u53EF\u4EE5\u770B\u5230\u90E8\u5206\u8F93\u51FA\uFF08\u8F93\u51FA\u91CF\u592A\u5927\uFF0C\u6545\u622A\u53D6\u4E00\u5C0F\u90E8\u5206\uFF09\uFF1A</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>hello,world1270
869 2006  b    Ex1271::main (9 bytes)
...
hello,world1999                                 
1125 2735  b    Ex2000::main (9 bytes)         
hello,world2000                                 
1125 2736  b    java.lang.System::gc (7 bytes) 
1125 2737  n    java.lang.Runtime::gc (native) 
1138 2739  b    Ex2001::main (9 bytes)         
hello,world2001                                 
1148 2740  b    Ex2002::main (9 bytes)         
1148 1063       (method) made zombie           
1148 1061       (method)  made zombie 
hello,world2002              
1148 1058       (method) made zombie           
1157 2454       (method) made zombie           
1157 2453       (method) made zombie      
...
19278 4729      (method) made zombie           
hello,world4002                                 
19289 4741  b    Ex4003::main (9 bytes)         
hello,world4003                                 
19298 4742  b    Ex4004::main (9 bytes)         
hello,world4004
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u53EF\u4EE5\u770B\u5230\uFF0C\u5728 2000 \u6B21\u8C03\u7528\u524D\uFF0C\u6CA1\u6709\u4EFB\u4F55\u4EE3\u7801\u7F13\u5B58\u7A7A\u95F4\u88AB\u56DE\u6536\uFF0C\u5728 2000 \u6B21\u8C03\u7528\u540E\uFF0CSystem.gc() \u8FD0\u884C\uFF0C\u5E76\u5F00\u59CB\u56DE\u6536\u4EE3\u7801\u7F13\u5B58\u7A7A\u95F4\uFF0C\u5927\u91CF\u51FD\u6570\u88AB\u6807\u8BB0\u4E3A made zombie\uFF0C\u5E76\u88AB\u91CA\u653E\u3002\u7531\u4E8E\u5783\u573E\u56DE\u6536\u7684\u5B58\u5728\uFF0C\u65E0\u6548\u7684\u4EE3\u7801\u603B\u662F\u53EF\u4EE5\u88AB\u91CA\u653E\uFF0C\u4EE3\u7801\u7F13\u5B58\u7A7A\u95F4\u672A\u88AB\u8017\u5C3D\uFF0C\u5E76\u6700\u7EC8\u6301\u7EED\u6267\u884C\u5230 4000 \u591A\u6B21\u8C03\u7528\uFF0C\u4F9D\u7136\u6B63\u5E38\u5DE5\u4F5C\u3002</p><p><strong>\u6CE8\u610F</strong>\uFF1A\u4E00\u65E6\u4EE3\u7801\u7F13\u5B58\u7A7A\u95F4\u8017\u5C3D\uFF0CJIT \u5C31\u4F1A\u505C\u6B62\uFF0C\u5E76\u4E14\u5728\u6574\u4E2A\u865A\u62DF\u673A\u7684\u751F\u547D\u5468\u671F\u4E2D\uFF0C\u4E0D\u4F1A\u518D\u542F\u52A8\u4E86\u3002\u8981\u6269\u5927\u4EE3\u7801\u7F13\u5B58\u533A\u95F4\uFF0C\u53EF\u4EE5\u4F7F\u7528 -XX:ReservedCodeCacheSize \u53C2\u6570\u8BBE\u7F6E\u3002</p><p>\u5982\u56FE11.23 \u6240\u793A\uFF0C\u5728 JConsole \u91CC\u89C2\u5BDF\u4EE3\u7801\u7F13\u5B58\u7A7A\u95F4\u7684\u4F7F\u7528\u60C5\u51B5\u3002</p><p><img src="`+T+'" alt="\u56FE11-23" loading="lazy"></p><p>\u56FE11.23 \u4EE3\u7801\u7F13\u5B58\u7A7A\u95F4\u4F7F\u7528\u7387</p><h2 id="_11-8-\u5C0F\u7ED3" tabindex="-1"><a class="header-anchor" href="#_11-8-\u5C0F\u7ED3" aria-hidden="true">#</a> 11.8 \u5C0F\u7ED3</h2><p>\u672C\u7AE0\u4E3B\u8981\u4ECB\u7ECD\u4E86 Java \u865A\u62DF\u673A\u7684\u5B57\u8282\u7801\u6267\u884C\u673A\u5236\u3002\u9996\u5148\u4ECB\u7ECD\u4E86 Java \u865A\u62DF\u673A\u7684\u4E3B\u8981\u6307\u4EE4\u96C6\uFF0C\u63A5\u7740\u4EE5\u8FD9\u4E9B\u6307\u4EE4\u96C6\u4E3A\u57FA\u7840\uFF0C\u5B66\u4E60\u5982\u4F55\u4F7F\u7528 ASM \u5E93\u8FDB\u884C\u52A8\u6001\u5B57\u8282\u7801\u751F\u6210\u3001\u4FEE\u6539\u7B49\u76F8\u5173\u7684\u5F00\u53D1\u5DE5\u4F5C\u3002\u4E3A\u4E86\u66F4\u597D\u5730\u4F7F\u7528\u8FD9\u79CD\u6280\u672F\uFF0C\u672C\u7AE0\u8FD8\u4ECB\u7ECD\u4E86 Java Agent \u673A\u5236\u3002</p><p>\u6B64\u5916\uFF0C\u672C\u7AE0\u8FD8\u7B80\u5355\u4ECB\u7ECD\u4E86 Javac \u7684\u9759\u6001\u7F16\u8BD1\u53CA JIT \u52A8\u6001\u7F16\u8BD1\u8FD9\u4E24\u9879\u57FA\u7840\u6027\u7684\u6A21\u5757\uFF0C\u4EE5\u5E2E\u52A9\u8BFB\u8005\u8FDB\u4E00\u6B65\u7406\u89E3 Java \u865A\u62DF\u673A\u7684\u8FD0\u884C\u673A\u5236\u3002</p>',521),z=[J];function O(E,L){return s(),a("div",null,z)}var R=n(I,[["render",O],["__file","\u7B2C11\u7AE0\u5B57\u8282\u7801\u6267\u884C.html.vue"]]);export{R as default};
