<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.48" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://www.cxlsn.cn/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html"><meta property="og:site_name" content="MyBlog"><meta property="og:title" content="ç¬¬ 5 ç«  å¹¶å‘å®¹å™¨"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-08-16T11:56:17.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:modified_time" content="2022-08-16T11:56:17.000Z"><title>ç¬¬ 5 ç«  å¹¶å‘å®¹å™¨ | MyBlog</title><meta name="description" content="MyBlog">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.09a441ee.css">
    <link rel="modulepreload" href="/assets/app.0d56c066.js"><link rel="modulepreload" href="/assets/ç¬¬5ç« å¹¶å‘å®¹å™¨.html.11ef3b3d.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/assets/ç¬¬5ç« å¹¶å‘å®¹å™¨.html.ef80cb1d.js"><link rel="prefetch" href="/assets/index.html.18f6ed2e.js"><link rel="prefetch" href="/assets/home.html.32fca429.js"><link rel="prefetch" href="/assets/slide.html.a293c482.js"><link rel="prefetch" href="/assets/index.html.bcf51f43.js"><link rel="prefetch" href="/assets/index.html.3768ee5f.js"><link rel="prefetch" href="/assets/index.html.b7a9ea16.js"><link rel="prefetch" href="/assets/ç¬¬10ç«  å¼‚å¸¸.html.33f3792f.js"><link rel="prefetch" href="/assets/ç¬¬11ç«  å¹¶å‘.html.41f89aa7.js"><link rel="prefetch" href="/assets/ç¬¬12ç«  åºåˆ—åŒ–.html.08c4c0cc.js"><link rel="prefetch" href="/assets/ç¬¬2ç«  åˆ›å»ºå’Œé”€æ¯å¯¹è±¡.html.1b6f55e3.js"><link rel="prefetch" href="/assets/ç¬¬3ç«  å¯¹äºæ‰€æœ‰å¯¹è±¡éƒ½é€šç”¨çš„æ–¹æ³•.html.e81922f0.js"><link rel="prefetch" href="/assets/ç¬¬4ç«  ç±»å’Œæ¥å£.html.bbf64366.js"><link rel="prefetch" href="/assets/ç¬¬5ç«  æ³›å‹.html.053306ed.js"><link rel="prefetch" href="/assets/ç¬¬6ç«  æšä¸¾å’Œæ³¨è§£.html.cb21ea0d.js"><link rel="prefetch" href="/assets/ç¬¬7ç«  Lambdaå’ŒStream.html.664c81b8.js"><link rel="prefetch" href="/assets/ç¬¬8ç«  æ–¹æ³•.html.bfc52ab1.js"><link rel="prefetch" href="/assets/ç¬¬9ç«  é€šç”¨ç¼–ç¨‹.html.6a1d88a2.js"><link rel="prefetch" href="/assets/index.html.153be5a1.js"><link rel="prefetch" href="/assets/index.html.4b079bc8.js"><link rel="prefetch" href="/assets/ç¬¬1ç« Javaå¤šçº¿ç¨‹æŠ€èƒ½.html.f4c43a60.js"><link rel="prefetch" href="/assets/ç¬¬2ç« å¯¹è±¡åŠå˜é‡çš„å¹¶å‘è®¿é—®.html.24971a2d.js"><link rel="prefetch" href="/assets/ç¬¬3ç« çº¿ç¨‹é—´é€šä¿¡.html.e9963ba8.js"><link rel="prefetch" href="/assets/ç¬¬4ç« é”çš„ä½¿ç”¨.html.bc309d92.js"><link rel="prefetch" href="/assets/ç¬¬5ç« å®šæ—¶å™¨.html.aaf2b6ee.js"><link rel="prefetch" href="/assets/ç¬¬6ç« å•ä¾‹æ¨¡å¼ä¸å¤šçº¿ç¨‹.html.a87eb20f.js"><link rel="prefetch" href="/assets/ç¬¬7ç« æ‹¾é—å¢è¡¥.html.2cbb6898.js"><link rel="prefetch" href="/assets/ç¬¬8ç« å¹¶å‘é›†åˆæ¡†æ¶.html.1739cc6b.js"><link rel="prefetch" href="/assets/ç¬¬9ç« çº¿ç¨‹æ± ThreadPoolExecutorçš„ä½¿ç”¨.html.186199c8.js"><link rel="prefetch" href="/assets/index.html.62274579.js"><link rel="prefetch" href="/assets/ç¬¬1ç« å¤šçº¿ç¨‹åŸºç¡€.html.afd475cd.js"><link rel="prefetch" href="/assets/ç¬¬2ç« Atomicç±».html.06be1f5d.js"><link rel="prefetch" href="/assets/ç¬¬3ç« Lockä¸Condition.html.ab9d71ca.js"><link rel="prefetch" href="/assets/ç¬¬4ç« åŒæ­¥å·¥å…·ç±».html.c3382339.js"><link rel="prefetch" href="/assets/ç¬¬6ç« çº¿ç¨‹æ± ä¸Future.html.e4a6ecca.js"><link rel="prefetch" href="/assets/ç¬¬7ç« ForkJoinPool.html.98e49c17.js"><link rel="prefetch" href="/assets/ç¬¬8ç« CompletableFuture.html.f7a413b4.js"><link rel="prefetch" href="/assets/index.html.12f0ee52.js"><link rel="prefetch" href="/assets/ç¬¬10ç« Javaå¹¶å‘åŒ…ä¸­çº¿ç¨‹åŒæ­¥å™¨åŸç†å‰–æ.html.b977fee1.js"><link rel="prefetch" href="/assets/ç¬¬11ç« å¹¶å‘ç¼–ç¨‹å®è·µ.html.623c5cbb.js"><link rel="prefetch" href="/assets/ç¬¬1ç« å¹¶å‘ç¼–ç¨‹çº¿ç¨‹åŸºç¡€.html.3967f815.js"><link rel="prefetch" href="/assets/ç¬¬2ç« å¹¶å‘ç¼–ç¨‹çš„å…¶ä»–åŸºç¡€çŸ¥è¯†.html.1c7f7072.js"><link rel="prefetch" href="/assets/ç¬¬3ç« Javaå¹¶å‘åŒ…ä¸­ThreadLocalRandomç±»åŸç†å‰–æ.html.8f28f52d.js"><link rel="prefetch" href="/assets/ç¬¬4ç« Javaå¹¶å‘åŒ…ä¸­åŸå­æ“ä½œç±»åŸç†å‰–æ.html.2e32d2f3.js"><link rel="prefetch" href="/assets/ç¬¬5ç« Javaå¹¶å‘åŒ…ä¸­å¹¶å‘Listæºç å‰–æ.html.4b8c96f3.js"><link rel="prefetch" href="/assets/ç¬¬6ç« Javaå¹¶å‘åŒ…ä¸­é”åŸç†å‰–æ.html.57b14c73.js"><link rel="prefetch" href="/assets/ç¬¬7ç« Javaå¹¶å‘åŒ…ä¸­å¹¶å‘é˜Ÿåˆ—åŸç†å‰–æ.html.21d8c694.js"><link rel="prefetch" href="/assets/ç¬¬8ç« Javaå¹¶å‘åŒ…ä¸­çº¿ç¨‹æ± ThreadPoolExecutoråŸç†æ¢ç©¶.html.44cbbd21.js"><link rel="prefetch" href="/assets/ç¬¬9ç« Javaå¹¶å‘åŒ…ä¸­ScheduledThreadPoolExecutoråŸç†æ¢ç©¶.html.b4fa44fb.js"><link rel="prefetch" href="/assets/index.html.e5d1d6c3.js"><link rel="prefetch" href="/assets/ç¬¬10ç«  Mapå’ŒSet.html.a55e5985.js"><link rel="prefetch" href="/assets/ç¬¬11ç«  å †ä¸ä¼˜å…ˆçº§åˆ—è¡¨.html.e280a8e4.js"><link rel="prefetch" href="/assets/ç¬¬12ç«  é€šç”¨å®¹å™¨å’Œæ€»ç»“.html.7f8f71e8.js"><link rel="prefetch" href="/assets/ç¬¬13ç«  æ–‡ä»¶åŸºæœ¬æŠ€æœ¯.html.5f4b89df.js"><link rel="prefetch" href="/assets/ç¬¬14ç«  æ–‡ä»¶é«˜çº§æŠ€æœ¯.html.8c6479e2.js"><link rel="prefetch" href="/assets/ç¬¬15ç«  å¹¶å‘åŸºç¡€çŸ¥è¯†.html.5cb53a4c.js"><link rel="prefetch" href="/assets/ç¬¬16ç«  å¹¶å‘åŒ…çš„åŸºçŸ³.html.142bea88.js"><link rel="prefetch" href="/assets/ç¬¬17ç«  å¹¶å‘å®¹å™¨.html.3acbf1e5.js"><link rel="prefetch" href="/assets/ç¬¬18ç«  å¼‚æ­¥ä»»åŠ¡æ‰§è¡ŒæœåŠ¡.html.1b161f70.js"><link rel="prefetch" href="/assets/ç¬¬19ç«  åŒæ­¥å’Œåä½œå·¥å…·ç±».html.addf5980.js"><link rel="prefetch" href="/assets/ç¬¬1ç«  ç¼–ç¨‹åŸºç¡€.html.baf9d7d3.js"><link rel="prefetch" href="/assets/ç¬¬20ç«  å¹¶å‘æ€»ç»“.html.0b3bb480.js"><link rel="prefetch" href="/assets/ç¬¬21ç«  åå°„.html.af2446cd.js"><link rel="prefetch" href="/assets/ç¬¬22ç«  æ³¨è§£.html.d1e27bc4.js"><link rel="prefetch" href="/assets/ç¬¬23ç«  åŠ¨æ€ä»£ç†.html.7995d8c2.js"><link rel="prefetch" href="/assets/ç¬¬24ç«  ç±»åŠ è½½æœºåˆ¶.html.b0642f1c.js"><link rel="prefetch" href="/assets/ç¬¬25ç«  æ­£åˆ™è¡¨è¾¾å¼.html.8b5d5322.js"><link rel="prefetch" href="/assets/ç¬¬26ç«  å‡½æ•°å¼ç¼–ç¨‹.html.7b517aff.js"><link rel="prefetch" href="/assets/ç¬¬2ç«  ç†è§£æ•°æ®èƒŒåçš„äºŒè¿›åˆ¶.html.94e4cb31.js"><link rel="prefetch" href="/assets/ç¬¬3ç«  ç±»çš„åŸºç¡€.html.5639d229.js"><link rel="prefetch" href="/assets/ç¬¬4ç«  ç±»çš„ç»§æ‰¿.html.2f958e91.js"><link rel="prefetch" href="/assets/ç¬¬5ç«  ç±»çš„ç»§æ‰¿.html.7d7e56a6.js"><link rel="prefetch" href="/assets/ç¬¬6ç«  å¼‚å¸¸.html.adb3eef3.js"><link rel="prefetch" href="/assets/ç¬¬7ç«  å¸¸ç”¨åŸºç¡€ç±».html.17e1b88d.js"><link rel="prefetch" href="/assets/ç¬¬8ç«  æ³›å‹.html.9d1aa562.js"><link rel="prefetch" href="/assets/ç¬¬9ç«  åˆ—è¡¨å’Œé˜Ÿåˆ—.html.1b223279.js"><link rel="prefetch" href="/assets/index.html.213dbe07.js"><link rel="prefetch" href="/assets/ç¬¬10ç« Executoræ¡†æ¶.html.2d819cce.js"><link rel="prefetch" href="/assets/ç¬¬11ç« Javaå¹¶å‘ç¼–ç¨‹å®è·µ.html.e045243d.js"><link rel="prefetch" href="/assets/ç¬¬1ç« å¹¶å‘ç¼–ç¨‹çš„æŒ‘æˆ˜.html.f2cf1cf0.js"><link rel="prefetch" href="/assets/ç¬¬2ç« Javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†.html.84620d72.js"><link rel="prefetch" href="/assets/ç¬¬3ç« Javaå†…å­˜æ¨¡å‹.html.57e9f10a.js"><link rel="prefetch" href="/assets/ç¬¬4ç« Javaå¹¶å‘ç¼–ç¨‹åŸºç¡€.html.e1837d6e.js"><link rel="prefetch" href="/assets/ç¬¬5ç« Javaä¸­çš„é”.html.509db6c5.js"><link rel="prefetch" href="/assets/ç¬¬6ç« Javaå¹¶å‘å®¹å™¨å’Œæ¡†æ¶.html.fab16b37.js"><link rel="prefetch" href="/assets/ç¬¬7ç« Javaä¸­çš„13ä¸ªåŸå­æ“ä½œç±».html.8a2e8902.js"><link rel="prefetch" href="/assets/ç¬¬8ç« Javaä¸­çš„å¹¶å‘å·¥å…·ç±».html.ede4146b.js"><link rel="prefetch" href="/assets/ç¬¬9ç« Javaä¸­çš„çº¿ç¨‹æ± .html.e7e64f52.js"><link rel="prefetch" href="/assets/index.html.ccabe8d8.js"><link rel="prefetch" href="/assets/ç¬¬10ç« é¿å…æ´»è·ƒæ€§å±é™©.html.288ef3a6.js"><link rel="prefetch" href="/assets/ç¬¬11ç« æ€§èƒ½ä¸å¯ä¼¸ç¼©æ€§.html.66974eb6.js"><link rel="prefetch" href="/assets/ç¬¬12ç« å¹¶å‘ç¨‹åºçš„æµ‹è¯•.html.064eea71.js"><link rel="prefetch" href="/assets/ç¬¬13ç« æ˜¾å¼é”.html.bf44c451.js"><link rel="prefetch" href="/assets/ç¬¬14ç« æ„å»ºè‡ªå®šä¹‰çš„åŒæ­¥å·¥å…·.html.23a2e0be.js"><link rel="prefetch" href="/assets/ç¬¬15ç« åŸå­å˜é‡ä¸éé˜»å¡åŒæ­¥æœºåˆ¶.html.06dd6e43.js"><link rel="prefetch" href="/assets/ç¬¬16ç« Javaå†…å­˜æ¨¡å‹ç®€ä»‹.html.977d59cd.js"><link rel="prefetch" href="/assets/ç¬¬1ç« ç®€ä»‹.html.90b5e48c.js"><link rel="prefetch" href="/assets/ç¬¬2ç« çº¿ç¨‹å®‰å…¨.html.2501a94b.js"><link rel="prefetch" href="/assets/ç¬¬3ç« å¯¹è±¡çš„å…±äº«.html.faeb65aa.js"><link rel="prefetch" href="/assets/ç¬¬4ç« å¯¹è±¡çš„ç»„åˆ.html.1fe1b50c.js"><link rel="prefetch" href="/assets/ç¬¬5ç« åŸºç¡€æ„å»ºæ¨¡å—.html.1fe6799b.js"><link rel="prefetch" href="/assets/ç¬¬6ç« ä»»åŠ¡æ‰§è¡Œ.html.70613e72.js"><link rel="prefetch" href="/assets/ç¬¬7ç« å–æ¶ˆä¸å…³é—­.html.1e1c2d49.js"><link rel="prefetch" href="/assets/ç¬¬8ç« çº¿ç¨‹æ± çš„ä½¿ç”¨.html.72ef0a90.js"><link rel="prefetch" href="/assets/ç¬¬9ç« å›¾å½¢ç”¨æˆ·ç•Œé¢åº”ç”¨ç¨‹åº.html.11c377b5.js"><link rel="prefetch" href="/assets/001-two-sum.html.a3f3595a.js"><link rel="prefetch" href="/assets/002-add-two-numbers.html.e7703c4f.js"><link rel="prefetch" href="/assets/003-longest-substring-without-repeating-characters.html.0c6329c6.js"><link rel="prefetch" href="/assets/index.html.d8ad8d07.js"><link rel="prefetch" href="/assets/index.html.5a513471.js"><link rel="prefetch" href="/assets/ç¬¬10ç« å‰ç«¯ç¼–è¯‘ä¸ä¼˜åŒ–.html.2a6b1789.js"><link rel="prefetch" href="/assets/ç¬¬11ç« åç«¯ç¼–è¯‘ä¸ä¼˜åŒ–.html.59704c7c.js"><link rel="prefetch" href="/assets/ç¬¬12ç« Javaå†…å­˜æ¨¡å‹ä¸çº¿ç¨‹.html.deaa5ea6.js"><link rel="prefetch" href="/assets/ç¬¬13ç« çº¿ç¨‹å®‰å…¨ä¸é”ä¼˜åŒ–.html.fd873e3a.js"><link rel="prefetch" href="/assets/ç¬¬1ç« èµ°è¿‘Java.html.0897d78c.js"><link rel="prefetch" href="/assets/ç¬¬2ç« Javaå†…å­˜åŒºåŸŸä¸å†…å­˜æº¢å‡ºå¼‚å¸¸.html.0978cdd4.js"><link rel="prefetch" href="/assets/ç¬¬3ç« åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥.html.a47791fa.js"><link rel="prefetch" href="/assets/ç¬¬4ç« è™šæ‹Ÿæœºæ€§èƒ½ç›‘æ§ã€æ•…éšœå¤„ç†å·¥å…·.html.61f80277.js"><link rel="prefetch" href="/assets/ç¬¬5ç« è°ƒä¼˜æ¡ˆä¾‹åˆ†æä¸å®æˆ˜.html.7a5b7c4c.js"><link rel="prefetch" href="/assets/ç¬¬6ç« ç±»æ–‡ä»¶ç»“æ„.html.3e8cd2c6.js"><link rel="prefetch" href="/assets/ç¬¬7ç« è™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶.html.3af5a31c.js"><link rel="prefetch" href="/assets/ç¬¬8ç« è™šæ‹Ÿæœºå­—èŠ‚ç æ‰§è¡Œå¼•æ“.html.dc5c593e.js"><link rel="prefetch" href="/assets/ç¬¬9ç« ç±»åŠ è½½åŠæ‰§è¡Œå­ç³»ç»Ÿçš„æ¡ˆä¾‹ä¸å®æˆ˜.html.c3e2fd28.js"><link rel="prefetch" href="/assets/index.html.c2e9c36e.js"><link rel="prefetch" href="/assets/ç¬¬1ç« èµ°å…¥å¹¶è¡Œä¸–ç•Œ.html.bf2758d5.js"><link rel="prefetch" href="/assets/ç¬¬2ç« Javaå¹¶è¡Œç¨‹åºåŸºç¡€.html.8a27b9a6.js"><link rel="prefetch" href="/assets/ç¬¬3ç« JDKå¹¶å‘åŒ….html.55a5bb57.js"><link rel="prefetch" href="/assets/ç¬¬4ç« é”çš„ä¼˜åŒ–åŠæ³¨æ„äº‹é¡¹.html.0ac6ac12.js"><link rel="prefetch" href="/assets/ç¬¬5ç« å¹¶è¡Œæ¨¡å¼ä¸ç®—æ³•.html.6e857f15.js"><link rel="prefetch" href="/assets/ç¬¬6ç« Java8910ä¸å¹¶å‘.html.61173fb4.js"><link rel="prefetch" href="/assets/ç¬¬7ç« ä½¿ç”¨Akkaæ„å»ºé«˜å¹¶å‘ç¨‹åº.html.610f0e53.js"><link rel="prefetch" href="/assets/ç¬¬8ç« å¹¶è¡Œç¨‹åºè°ƒè¯•.html.dcf9af72.js"><link rel="prefetch" href="/assets/ç¬¬9ç« å¤šçº¿ç¨‹ä¼˜åŒ–ç¤ºä¾‹â€”Jettyæ ¸å¿ƒä»£ç åˆ†æ.html.1b25b9bb.js"><link rel="prefetch" href="/assets/index.html.8c841845.js"><link rel="prefetch" href="/assets/ç¬¬10ç« Classè£…è½½ç³»ç»Ÿ.html.800b1d8e.js"><link rel="prefetch" href="/assets/ç¬¬11ç« å­—èŠ‚ç æ‰§è¡Œ.html.fd59242f.js"><link rel="prefetch" href="/assets/ç¬¬1ç« åˆæ¢Javaè™šæ‹Ÿæœº.html.80ec8c68.js"><link rel="prefetch" href="/assets/ç¬¬2ç« è®¤è¯†Javaè™šæ‹Ÿæœºçš„åŸºæœ¬ç»“æ„.html.bbf499e1.js"><link rel="prefetch" href="/assets/ç¬¬3ç« å¸¸ç”¨Javaè™šæ‹Ÿæœºå‚æ•°.html.10cb1042.js"><link rel="prefetch" href="/assets/ç¬¬4ç« åƒåœ¾å›æ”¶çš„æ¦‚å¿µä¸ç®—æ³•.html.90d52151.js"><link rel="prefetch" href="/assets/ç¬¬5ç« åƒåœ¾æ”¶é›†å™¨å’Œå†…å­˜åˆ†é….html.98dc8566.js"><link rel="prefetch" href="/assets/ç¬¬6ç« æ€§èƒ½ç›‘æ§å·¥å…·.html.d9178ab7.js"><link rel="prefetch" href="/assets/ç¬¬7ç« åˆ†æJavaå †.html.76f053df.js"><link rel="prefetch" href="/assets/ç¬¬8ç« é”ä¸å¹¶å‘.html.c6edc3b8.js"><link rel="prefetch" href="/assets/ç¬¬9ç« Classæ–‡ä»¶ç»“æ„.html.ce3b9ffe.js"><link rel="prefetch" href="/assets/404.html.a61819a1.js"><link rel="prefetch" href="/assets/index.html.196bf7d0.js"><link rel="prefetch" href="/assets/index.html.6474b04a.js"><link rel="prefetch" href="/assets/index.html.12d9ea9f.js"><link rel="prefetch" href="/assets/index.html.8cf1d97b.js"><link rel="prefetch" href="/assets/index.html.b1d72dff.js"><link rel="prefetch" href="/assets/index.html.6a433ed8.js"><link rel="prefetch" href="/assets/index.html.292db8d2.js"><link rel="prefetch" href="/assets/index.html.db46c28d.js"><link rel="prefetch" href="/assets/home.html.b3222fa8.js"><link rel="prefetch" href="/assets/slide.html.3b4fa46d.js"><link rel="prefetch" href="/assets/index.html.eab01647.js"><link rel="prefetch" href="/assets/index.html.f6997ce1.js"><link rel="prefetch" href="/assets/index.html.4f492e58.js"><link rel="prefetch" href="/assets/ç¬¬10ç«  å¼‚å¸¸.html.b369a82a.js"><link rel="prefetch" href="/assets/ç¬¬11ç«  å¹¶å‘.html.1e83a7e7.js"><link rel="prefetch" href="/assets/ç¬¬12ç«  åºåˆ—åŒ–.html.934b2280.js"><link rel="prefetch" href="/assets/ç¬¬2ç«  åˆ›å»ºå’Œé”€æ¯å¯¹è±¡.html.bf39597f.js"><link rel="prefetch" href="/assets/ç¬¬3ç«  å¯¹äºæ‰€æœ‰å¯¹è±¡éƒ½é€šç”¨çš„æ–¹æ³•.html.c2f582c1.js"><link rel="prefetch" href="/assets/ç¬¬4ç«  ç±»å’Œæ¥å£.html.d616fa92.js"><link rel="prefetch" href="/assets/ç¬¬5ç«  æ³›å‹.html.fe9bf71e.js"><link rel="prefetch" href="/assets/ç¬¬6ç«  æšä¸¾å’Œæ³¨è§£.html.b0c192a2.js"><link rel="prefetch" href="/assets/ç¬¬7ç«  Lambdaå’ŒStream.html.11e132a3.js"><link rel="prefetch" href="/assets/ç¬¬8ç«  æ–¹æ³•.html.0f5952cd.js"><link rel="prefetch" href="/assets/ç¬¬9ç«  é€šç”¨ç¼–ç¨‹.html.a9158c44.js"><link rel="prefetch" href="/assets/index.html.66d9275e.js"><link rel="prefetch" href="/assets/index.html.e1e195ac.js"><link rel="prefetch" href="/assets/ç¬¬1ç« Javaå¤šçº¿ç¨‹æŠ€èƒ½.html.d201a503.js"><link rel="prefetch" href="/assets/ç¬¬2ç« å¯¹è±¡åŠå˜é‡çš„å¹¶å‘è®¿é—®.html.8eff37f9.js"><link rel="prefetch" href="/assets/ç¬¬3ç« çº¿ç¨‹é—´é€šä¿¡.html.96ad7aa4.js"><link rel="prefetch" href="/assets/ç¬¬4ç« é”çš„ä½¿ç”¨.html.0b108a46.js"><link rel="prefetch" href="/assets/ç¬¬5ç« å®šæ—¶å™¨.html.079d1655.js"><link rel="prefetch" href="/assets/ç¬¬6ç« å•ä¾‹æ¨¡å¼ä¸å¤šçº¿ç¨‹.html.dd40cab9.js"><link rel="prefetch" href="/assets/ç¬¬7ç« æ‹¾é—å¢è¡¥.html.c98b6afc.js"><link rel="prefetch" href="/assets/ç¬¬8ç« å¹¶å‘é›†åˆæ¡†æ¶.html.c47636a0.js"><link rel="prefetch" href="/assets/ç¬¬9ç« çº¿ç¨‹æ± ThreadPoolExecutorçš„ä½¿ç”¨.html.fdd06e63.js"><link rel="prefetch" href="/assets/index.html.970ebb57.js"><link rel="prefetch" href="/assets/ç¬¬1ç« å¤šçº¿ç¨‹åŸºç¡€.html.f6e06884.js"><link rel="prefetch" href="/assets/ç¬¬2ç« Atomicç±».html.5c9a96af.js"><link rel="prefetch" href="/assets/ç¬¬3ç« Lockä¸Condition.html.dd94c834.js"><link rel="prefetch" href="/assets/ç¬¬4ç« åŒæ­¥å·¥å…·ç±».html.f32cb37a.js"><link rel="prefetch" href="/assets/ç¬¬6ç« çº¿ç¨‹æ± ä¸Future.html.f2664d19.js"><link rel="prefetch" href="/assets/ç¬¬7ç« ForkJoinPool.html.5b09c440.js"><link rel="prefetch" href="/assets/ç¬¬8ç« CompletableFuture.html.00ddc982.js"><link rel="prefetch" href="/assets/index.html.05f6dacd.js"><link rel="prefetch" href="/assets/ç¬¬10ç« Javaå¹¶å‘åŒ…ä¸­çº¿ç¨‹åŒæ­¥å™¨åŸç†å‰–æ.html.22c349a1.js"><link rel="prefetch" href="/assets/ç¬¬11ç« å¹¶å‘ç¼–ç¨‹å®è·µ.html.5db30ba4.js"><link rel="prefetch" href="/assets/ç¬¬1ç« å¹¶å‘ç¼–ç¨‹çº¿ç¨‹åŸºç¡€.html.59828def.js"><link rel="prefetch" href="/assets/ç¬¬2ç« å¹¶å‘ç¼–ç¨‹çš„å…¶ä»–åŸºç¡€çŸ¥è¯†.html.95634460.js"><link rel="prefetch" href="/assets/ç¬¬3ç« Javaå¹¶å‘åŒ…ä¸­ThreadLocalRandomç±»åŸç†å‰–æ.html.5e3f88be.js"><link rel="prefetch" href="/assets/ç¬¬4ç« Javaå¹¶å‘åŒ…ä¸­åŸå­æ“ä½œç±»åŸç†å‰–æ.html.aa40f522.js"><link rel="prefetch" href="/assets/ç¬¬5ç« Javaå¹¶å‘åŒ…ä¸­å¹¶å‘Listæºç å‰–æ.html.19da87be.js"><link rel="prefetch" href="/assets/ç¬¬6ç« Javaå¹¶å‘åŒ…ä¸­é”åŸç†å‰–æ.html.e64d1f1d.js"><link rel="prefetch" href="/assets/ç¬¬7ç« Javaå¹¶å‘åŒ…ä¸­å¹¶å‘é˜Ÿåˆ—åŸç†å‰–æ.html.05c55f53.js"><link rel="prefetch" href="/assets/ç¬¬8ç« Javaå¹¶å‘åŒ…ä¸­çº¿ç¨‹æ± ThreadPoolExecutoråŸç†æ¢ç©¶.html.355c02bf.js"><link rel="prefetch" href="/assets/ç¬¬9ç« Javaå¹¶å‘åŒ…ä¸­ScheduledThreadPoolExecutoråŸç†æ¢ç©¶.html.bc89022d.js"><link rel="prefetch" href="/assets/index.html.0812d30d.js"><link rel="prefetch" href="/assets/ç¬¬10ç«  Mapå’ŒSet.html.d15ebc0a.js"><link rel="prefetch" href="/assets/ç¬¬11ç«  å †ä¸ä¼˜å…ˆçº§åˆ—è¡¨.html.22879ed0.js"><link rel="prefetch" href="/assets/ç¬¬12ç«  é€šç”¨å®¹å™¨å’Œæ€»ç»“.html.af4e25e8.js"><link rel="prefetch" href="/assets/ç¬¬13ç«  æ–‡ä»¶åŸºæœ¬æŠ€æœ¯.html.e9de4ab6.js"><link rel="prefetch" href="/assets/ç¬¬14ç«  æ–‡ä»¶é«˜çº§æŠ€æœ¯.html.6944682e.js"><link rel="prefetch" href="/assets/ç¬¬15ç«  å¹¶å‘åŸºç¡€çŸ¥è¯†.html.fbf03dc9.js"><link rel="prefetch" href="/assets/ç¬¬16ç«  å¹¶å‘åŒ…çš„åŸºçŸ³.html.f5fbd049.js"><link rel="prefetch" href="/assets/ç¬¬17ç«  å¹¶å‘å®¹å™¨.html.d522da1e.js"><link rel="prefetch" href="/assets/ç¬¬18ç«  å¼‚æ­¥ä»»åŠ¡æ‰§è¡ŒæœåŠ¡.html.76e9a36e.js"><link rel="prefetch" href="/assets/ç¬¬19ç«  åŒæ­¥å’Œåä½œå·¥å…·ç±».html.669856bd.js"><link rel="prefetch" href="/assets/ç¬¬1ç«  ç¼–ç¨‹åŸºç¡€.html.3f747685.js"><link rel="prefetch" href="/assets/ç¬¬20ç«  å¹¶å‘æ€»ç»“.html.1e326470.js"><link rel="prefetch" href="/assets/ç¬¬21ç«  åå°„.html.25579869.js"><link rel="prefetch" href="/assets/ç¬¬22ç«  æ³¨è§£.html.10b1af26.js"><link rel="prefetch" href="/assets/ç¬¬23ç«  åŠ¨æ€ä»£ç†.html.76b2167b.js"><link rel="prefetch" href="/assets/ç¬¬24ç«  ç±»åŠ è½½æœºåˆ¶.html.2dc4cd09.js"><link rel="prefetch" href="/assets/ç¬¬25ç«  æ­£åˆ™è¡¨è¾¾å¼.html.d3486e09.js"><link rel="prefetch" href="/assets/ç¬¬26ç«  å‡½æ•°å¼ç¼–ç¨‹.html.dd3f8bd7.js"><link rel="prefetch" href="/assets/ç¬¬2ç«  ç†è§£æ•°æ®èƒŒåçš„äºŒè¿›åˆ¶.html.3d5eaefa.js"><link rel="prefetch" href="/assets/ç¬¬3ç«  ç±»çš„åŸºç¡€.html.c86161b4.js"><link rel="prefetch" href="/assets/ç¬¬4ç«  ç±»çš„ç»§æ‰¿.html.2bce738f.js"><link rel="prefetch" href="/assets/ç¬¬5ç«  ç±»çš„ç»§æ‰¿.html.ad950d91.js"><link rel="prefetch" href="/assets/ç¬¬6ç«  å¼‚å¸¸.html.09ddca79.js"><link rel="prefetch" href="/assets/ç¬¬7ç«  å¸¸ç”¨åŸºç¡€ç±».html.12c88740.js"><link rel="prefetch" href="/assets/ç¬¬8ç«  æ³›å‹.html.81d0949a.js"><link rel="prefetch" href="/assets/ç¬¬9ç«  åˆ—è¡¨å’Œé˜Ÿåˆ—.html.38c68a48.js"><link rel="prefetch" href="/assets/index.html.bf5d33db.js"><link rel="prefetch" href="/assets/ç¬¬10ç« Executoræ¡†æ¶.html.a7e672e0.js"><link rel="prefetch" href="/assets/ç¬¬11ç« Javaå¹¶å‘ç¼–ç¨‹å®è·µ.html.debb41c7.js"><link rel="prefetch" href="/assets/ç¬¬1ç« å¹¶å‘ç¼–ç¨‹çš„æŒ‘æˆ˜.html.1b00855d.js"><link rel="prefetch" href="/assets/ç¬¬2ç« Javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†.html.f005f932.js"><link rel="prefetch" href="/assets/ç¬¬3ç« Javaå†…å­˜æ¨¡å‹.html.6ec525fb.js"><link rel="prefetch" href="/assets/ç¬¬4ç« Javaå¹¶å‘ç¼–ç¨‹åŸºç¡€.html.bd275d3c.js"><link rel="prefetch" href="/assets/ç¬¬5ç« Javaä¸­çš„é”.html.83cc4dba.js"><link rel="prefetch" href="/assets/ç¬¬6ç« Javaå¹¶å‘å®¹å™¨å’Œæ¡†æ¶.html.8a83a2ef.js"><link rel="prefetch" href="/assets/ç¬¬7ç« Javaä¸­çš„13ä¸ªåŸå­æ“ä½œç±».html.2c3c8029.js"><link rel="prefetch" href="/assets/ç¬¬8ç« Javaä¸­çš„å¹¶å‘å·¥å…·ç±».html.61794c87.js"><link rel="prefetch" href="/assets/ç¬¬9ç« Javaä¸­çš„çº¿ç¨‹æ± .html.9434f936.js"><link rel="prefetch" href="/assets/index.html.93c2aee6.js"><link rel="prefetch" href="/assets/ç¬¬10ç« é¿å…æ´»è·ƒæ€§å±é™©.html.e7ea1e3a.js"><link rel="prefetch" href="/assets/ç¬¬11ç« æ€§èƒ½ä¸å¯ä¼¸ç¼©æ€§.html.42d4a3a1.js"><link rel="prefetch" href="/assets/ç¬¬12ç« å¹¶å‘ç¨‹åºçš„æµ‹è¯•.html.690d2aba.js"><link rel="prefetch" href="/assets/ç¬¬13ç« æ˜¾å¼é”.html.1171f97b.js"><link rel="prefetch" href="/assets/ç¬¬14ç« æ„å»ºè‡ªå®šä¹‰çš„åŒæ­¥å·¥å…·.html.6c72f888.js"><link rel="prefetch" href="/assets/ç¬¬15ç« åŸå­å˜é‡ä¸éé˜»å¡åŒæ­¥æœºåˆ¶.html.9de6dd1b.js"><link rel="prefetch" href="/assets/ç¬¬16ç« Javaå†…å­˜æ¨¡å‹ç®€ä»‹.html.847d1584.js"><link rel="prefetch" href="/assets/ç¬¬1ç« ç®€ä»‹.html.5ff3b256.js"><link rel="prefetch" href="/assets/ç¬¬2ç« çº¿ç¨‹å®‰å…¨.html.34a72eca.js"><link rel="prefetch" href="/assets/ç¬¬3ç« å¯¹è±¡çš„å…±äº«.html.088b59e3.js"><link rel="prefetch" href="/assets/ç¬¬4ç« å¯¹è±¡çš„ç»„åˆ.html.420592f2.js"><link rel="prefetch" href="/assets/ç¬¬5ç« åŸºç¡€æ„å»ºæ¨¡å—.html.b697dc08.js"><link rel="prefetch" href="/assets/ç¬¬6ç« ä»»åŠ¡æ‰§è¡Œ.html.d2692cee.js"><link rel="prefetch" href="/assets/ç¬¬7ç« å–æ¶ˆä¸å…³é—­.html.1033df86.js"><link rel="prefetch" href="/assets/ç¬¬8ç« çº¿ç¨‹æ± çš„ä½¿ç”¨.html.5655d9dd.js"><link rel="prefetch" href="/assets/ç¬¬9ç« å›¾å½¢ç”¨æˆ·ç•Œé¢åº”ç”¨ç¨‹åº.html.2c9a92f0.js"><link rel="prefetch" href="/assets/001-two-sum.html.bd5b42b8.js"><link rel="prefetch" href="/assets/002-add-two-numbers.html.1cd12f58.js"><link rel="prefetch" href="/assets/003-longest-substring-without-repeating-characters.html.3f87474a.js"><link rel="prefetch" href="/assets/index.html.346ee126.js"><link rel="prefetch" href="/assets/index.html.bddb9164.js"><link rel="prefetch" href="/assets/ç¬¬10ç« å‰ç«¯ç¼–è¯‘ä¸ä¼˜åŒ–.html.27f33bd6.js"><link rel="prefetch" href="/assets/ç¬¬11ç« åç«¯ç¼–è¯‘ä¸ä¼˜åŒ–.html.2d98e937.js"><link rel="prefetch" href="/assets/ç¬¬12ç« Javaå†…å­˜æ¨¡å‹ä¸çº¿ç¨‹.html.e5d51c84.js"><link rel="prefetch" href="/assets/ç¬¬13ç« çº¿ç¨‹å®‰å…¨ä¸é”ä¼˜åŒ–.html.2e377ef2.js"><link rel="prefetch" href="/assets/ç¬¬1ç« èµ°è¿‘Java.html.7c41e7a9.js"><link rel="prefetch" href="/assets/ç¬¬2ç« Javaå†…å­˜åŒºåŸŸä¸å†…å­˜æº¢å‡ºå¼‚å¸¸.html.82365a5f.js"><link rel="prefetch" href="/assets/ç¬¬3ç« åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥.html.1360e884.js"><link rel="prefetch" href="/assets/ç¬¬4ç« è™šæ‹Ÿæœºæ€§èƒ½ç›‘æ§ã€æ•…éšœå¤„ç†å·¥å…·.html.0a90211f.js"><link rel="prefetch" href="/assets/ç¬¬5ç« è°ƒä¼˜æ¡ˆä¾‹åˆ†æä¸å®æˆ˜.html.e7e286da.js"><link rel="prefetch" href="/assets/ç¬¬6ç« ç±»æ–‡ä»¶ç»“æ„.html.9f84d086.js"><link rel="prefetch" href="/assets/ç¬¬7ç« è™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶.html.31c0a6a3.js"><link rel="prefetch" href="/assets/ç¬¬8ç« è™šæ‹Ÿæœºå­—èŠ‚ç æ‰§è¡Œå¼•æ“.html.6f40ca25.js"><link rel="prefetch" href="/assets/ç¬¬9ç« ç±»åŠ è½½åŠæ‰§è¡Œå­ç³»ç»Ÿçš„æ¡ˆä¾‹ä¸å®æˆ˜.html.5bf71bd8.js"><link rel="prefetch" href="/assets/index.html.18e34f59.js"><link rel="prefetch" href="/assets/ç¬¬1ç« èµ°å…¥å¹¶è¡Œä¸–ç•Œ.html.d4a7a8b1.js"><link rel="prefetch" href="/assets/ç¬¬2ç« Javaå¹¶è¡Œç¨‹åºåŸºç¡€.html.79f6e18f.js"><link rel="prefetch" href="/assets/ç¬¬3ç« JDKå¹¶å‘åŒ….html.df0acd9f.js"><link rel="prefetch" href="/assets/ç¬¬4ç« é”çš„ä¼˜åŒ–åŠæ³¨æ„äº‹é¡¹.html.5a2b559c.js"><link rel="prefetch" href="/assets/ç¬¬5ç« å¹¶è¡Œæ¨¡å¼ä¸ç®—æ³•.html.c0ec6141.js"><link rel="prefetch" href="/assets/ç¬¬6ç« Java8910ä¸å¹¶å‘.html.9a2cc047.js"><link rel="prefetch" href="/assets/ç¬¬7ç« ä½¿ç”¨Akkaæ„å»ºé«˜å¹¶å‘ç¨‹åº.html.e1442a98.js"><link rel="prefetch" href="/assets/ç¬¬8ç« å¹¶è¡Œç¨‹åºè°ƒè¯•.html.ddf890de.js"><link rel="prefetch" href="/assets/ç¬¬9ç« å¤šçº¿ç¨‹ä¼˜åŒ–ç¤ºä¾‹â€”Jettyæ ¸å¿ƒä»£ç åˆ†æ.html.0ab5a261.js"><link rel="prefetch" href="/assets/index.html.9735d51d.js"><link rel="prefetch" href="/assets/ç¬¬10ç« Classè£…è½½ç³»ç»Ÿ.html.50bb638d.js"><link rel="prefetch" href="/assets/ç¬¬11ç« å­—èŠ‚ç æ‰§è¡Œ.html.f0a2e1fd.js"><link rel="prefetch" href="/assets/ç¬¬1ç« åˆæ¢Javaè™šæ‹Ÿæœº.html.0a668344.js"><link rel="prefetch" href="/assets/ç¬¬2ç« è®¤è¯†Javaè™šæ‹Ÿæœºçš„åŸºæœ¬ç»“æ„.html.1777df39.js"><link rel="prefetch" href="/assets/ç¬¬3ç« å¸¸ç”¨Javaè™šæ‹Ÿæœºå‚æ•°.html.65784af7.js"><link rel="prefetch" href="/assets/ç¬¬4ç« åƒåœ¾å›æ”¶çš„æ¦‚å¿µä¸ç®—æ³•.html.d6231456.js"><link rel="prefetch" href="/assets/ç¬¬5ç« åƒåœ¾æ”¶é›†å™¨å’Œå†…å­˜åˆ†é….html.6446a277.js"><link rel="prefetch" href="/assets/ç¬¬6ç« æ€§èƒ½ç›‘æ§å·¥å…·.html.e9ce7787.js"><link rel="prefetch" href="/assets/ç¬¬7ç« åˆ†æJavaå †.html.ee273e82.js"><link rel="prefetch" href="/assets/ç¬¬8ç« é”ä¸å¹¶å‘.html.7624390a.js"><link rel="prefetch" href="/assets/ç¬¬9ç« Classæ–‡ä»¶ç»“æ„.html.f4c2ac9f.js"><link rel="prefetch" href="/assets/404.html.36540b0d.js"><link rel="prefetch" href="/assets/index.html.583c479d.js"><link rel="prefetch" href="/assets/index.html.c407fe6a.js"><link rel="prefetch" href="/assets/index.html.99a8f87f.js"><link rel="prefetch" href="/assets/index.html.7587b161.js"><link rel="prefetch" href="/assets/index.html.f6866d7d.js"><link rel="prefetch" href="/assets/index.html.a985c72b.js"><link rel="prefetch" href="/assets/index.html.4c96ae2e.js"><link rel="prefetch" href="/assets/404.629f43ab.js"><link rel="prefetch" href="/assets/Layout.26a2a4c9.js"><link rel="prefetch" href="/assets/Slide.b01858c1.js"><link rel="prefetch" href="/assets/Blog.ac038c81.js"><link rel="prefetch" href="/assets/auto.esm.52abc6cc.js"><link rel="prefetch" href="/assets/index.147398ee.js"><link rel="prefetch" href="/assets/index.e1c5a3de.js"><link rel="prefetch" href="/assets/mermaid.esm.min.e741c6cd.js"><link rel="prefetch" href="/assets/highlight.esm.9b852bc5.js"><link rel="prefetch" href="/assets/markdown.esm.77e8db25.js"><link rel="prefetch" href="/assets/math.esm.cb9d4be3.js"><link rel="prefetch" href="/assets/notes.esm.62c5f19d.js"><link rel="prefetch" href="/assets/reveal.esm.41ec5d7f.js"><link rel="prefetch" href="/assets/search.esm.04894411.js"><link rel="prefetch" href="/assets/zoom.esm.78977eba.js"><link rel="prefetch" href="/assets/photoswipe.esm.2debdee5.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/" class="brand"><img class="logo" src="/logo.svg" alt="MyBlog"><!----><span class="site-name hide-in-pad">MyBlog</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="è¯»ä¹¦ç¬”è®°"><span class="title"><span class="icon iconfont icon-note" style=""></span>è¯»ä¹¦ç¬”è®°</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/reading-notes/Effective%20Java" class="nav-link" aria-label="Effective Java"><!---->Effective Java<!----></a></li><li class="dropdown-item"><a href="/reading-notes/Java%E7%BC%96%E7%A8%8B%E7%9A%84%E9%80%BB%E8%BE%91" class="nav-link" aria-label="Java ç¼–ç¨‹çš„é€»è¾‘"><!---->Java ç¼–ç¨‹çš„é€»è¾‘<!----></a></li><li class="dropdown-item"><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98" class="nav-link" aria-label="Java å¹¶å‘ç¼–ç¨‹å®æˆ˜"><!---->Java å¹¶å‘ç¼–ç¨‹å®æˆ˜<!----></a></li><li class="dropdown-item"><a href="/reading-notes/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF" class="nav-link" aria-label="Java å¤šçº¿ç¨‹ç¼–ç¨‹æ ¸å¿ƒæŠ€æœ¯"><!---->Java å¤šçº¿ç¨‹ç¼–ç¨‹æ ¸å¿ƒæŠ€æœ¯<!----></a></li><li class="dropdown-item"><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E7%BE%8E" class="nav-link" aria-label="Java å¹¶å‘ç¼–ç¨‹ä¹‹ç¾"><!---->Java å¹¶å‘ç¼–ç¨‹ä¹‹ç¾<!----></a></li><li class="dropdown-item"><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90" class="nav-link active" aria-label="Java å¹¶å‘å®ç°åŸç†ï¼šJDK æºç å‰–æ"><!---->Java å¹¶å‘å®ç°åŸç†ï¼šJDK æºç å‰–æ<!----></a></li><li class="dropdown-item"><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1" class="nav-link" aria-label="å®æˆ˜ Java é«˜å¹¶å‘ç¨‹åºè®¾è®¡"><!---->å®æˆ˜ Java é«˜å¹¶å‘ç¨‹åºè®¾è®¡<!----></a></li><li class="dropdown-item"><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF" class="nav-link" aria-label="Java å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯"><!---->Java å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯<!----></a></li><li class="dropdown-item"><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96" class="nav-link" aria-label="å®æˆ˜ Java è™šæ‹Ÿæœºï¼šJVM æ•…éšœè¯Šæ–­ä¸æ€§èƒ½ä¼˜åŒ–"><!---->å®æˆ˜ Java è™šæ‹Ÿæœºï¼šJVM æ•…éšœè¯Šæ–­ä¸æ€§èƒ½ä¼˜åŒ–<!----></a></li><li class="dropdown-item"><a href="/reading-notes/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" class="nav-link" aria-label="æ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºï¼šJVM é«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µ"><!---->æ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºï¼šJVM é«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µ<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="leetcode"><span class="title"><span class="icon iconfont icon-note" style=""></span>leetcode</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/leetcode/Top100" class="nav-link" aria-label="Top 100"><!---->Top 100<!----></a></li></ul></button></div></div></nav><!----></div><div class="navbar-right"><!----><!----><div class="nav-item"><a class="repo-link" href="https://gitee.com/anansneaker/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="Gitee"><svg xmlns="http://www.w3.org/2000/svg" class="icon gitee-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="gitee icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm242.97-533.34H482.39a23.7 23.7 0 0 0-23.7 23.7l-.03 59.28c0 13.08 10.59 23.7 23.7 23.7h165.96a23.7 23.7 0 0 1 23.7 23.7v11.85a71.1 71.1 0 0 1-71.1 71.1H375.71a23.7 23.7 0 0 1-23.7-23.7V423.11a71.1 71.1 0 0 1 71.1-71.1h331.8a23.7 23.7 0 0 0 23.7-23.7l.06-59.25a23.73 23.73 0 0 0-23.7-23.73H423.11a177.78 177.78 0 0 0-177.78 177.75v331.83c0 13.08 10.62 23.7 23.7 23.7h349.62a159.99 159.99 0 0 0 159.99-159.99V482.33a23.7 23.7 0 0 0-23.7-23.7z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><p class="sidebar-heading active"><span class="icon iconfont icon-note" style=""></span><span class="title">è¯»ä¹¦ç¬”è®°</span><!----></p><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Effective Java</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java ç¼–ç¨‹çš„é€»è¾‘</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java å¹¶å‘ç¼–ç¨‹å®æˆ˜</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Javaå¤šçº¿ç¨‹ç¼–ç¨‹æ ¸å¿ƒæŠ€æœ¯</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java å¹¶å‘ç¼–ç¨‹ä¹‹ç¾</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">Java å¹¶å‘å®ç°åŸç†ï¼šJDK æºç å‰–æ</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC1%E7%AB%A0%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9F%BA%E7%A1%80.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬ 1 ç«  å¤šçº¿ç¨‹åŸºç¡€"><!---->ç¬¬ 1 ç«  å¤šçº¿ç¨‹åŸºç¡€<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC2%E7%AB%A0Atomic%E7%B1%BB.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬ 2 ç«  Atomic ç±»"><!---->ç¬¬ 2 ç«  Atomic ç±»<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC3%E7%AB%A0Lock%E4%B8%8ECondition.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬ 3 ç«  Lock ä¸ Condition"><!---->ç¬¬ 3 ç«  Lock ä¸ Condition<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC4%E7%AB%A0%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7%E7%B1%BB.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬ 4 ç«  åŒæ­¥å·¥å…·ç±»"><!---->ç¬¬ 4 ç«  åŒæ­¥å·¥å…·ç±»<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="ç¬¬ 5 ç«  å¹¶å‘å®¹å™¨"><!---->ç¬¬ 5 ç«  å¹¶å‘å®¹å™¨<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-1-blockingqueue" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.1 BlockingQueue"><!---->5.1 BlockingQueue<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-1-1-arrayblockingqueue" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.1.1 ArrayBlockingQueue"><!---->5.1.1 ArrayBlockingQueue<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-1-2-linkedblockingqueue" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.1.2 LinkedBlockingQueue"><!---->5.1.2 LinkedBlockingQueue<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-1-3-priorityblockingqueue" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.1.3 PriorityBlockingQueue"><!---->5.1.3 PriorityBlockingQueue<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-1-4-delayqueue" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.1.4 DelayQueue"><!---->5.1.4 DelayQueue<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-1-5-synchronousqueue" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.1.5 SynchronousQueue"><!---->5.1.5 SynchronousQueue<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-2-blockingdeque" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.2 BlockingDeque"><!---->5.2 BlockingDeque<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-3-copyonwrite" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.3 CopyOnWrite"><!---->5.3 CopyOnWrite<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-3-1-copyonwritearraylist" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.3.1 CopyOnWriteArrayList"><!---->5.3.1 CopyOnWriteArrayList<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-3-2-copyonwritearrayset" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.3.2 CopyOnWriteArraySet"><!---->5.3.2 CopyOnWriteArraySet<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-4-concurrentlinkedqueue-deque" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.4 ConcurrentLinkedQueue / Deque"><!---->5.4 ConcurrentLinkedQueue / Deque<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-5-concurrenthashmap" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.5 ConcurrentHashMap"><!---->5.5 ConcurrentHashMap<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-5-1-jdk-7-ä¸­çš„å®ç°æ–¹å¼" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.5.1 JDK 7 ä¸­çš„å®ç°æ–¹å¼"><!---->5.5.1 JDK 7 ä¸­çš„å®ç°æ–¹å¼<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-5-2-jdk-8-ä¸­çš„å®ç°æ–¹å¼" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.5.2 JDK 8 ä¸­çš„å®ç°æ–¹å¼"><!---->5.5.2 JDK 8 ä¸­çš„å®ç°æ–¹å¼<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-6-concurrentskiplistmap-set" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.6 ConcurrentSkipListMap / Set"><!---->5.6 ConcurrentSkipListMap / Set<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-6-1-concurrentskiplistmap" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.6.1 ConcurrentSkipListMap"><!---->5.6.1 ConcurrentSkipListMap<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-6-2-concurrentskiplistset" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.6.2 ConcurrentSkipListSet"><!---->5.6.2 ConcurrentSkipListSet<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC6%E7%AB%A0%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%8EFuture.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬ 6 ç«  çº¿ç¨‹æ± ä¸ Future"><!---->ç¬¬ 6 ç«  çº¿ç¨‹æ± ä¸ Future<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC7%E7%AB%A0ForkJoinPool.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬ 7 ç«  ForkJoinPool"><!---->ç¬¬ 7 ç«  ForkJoinPool<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC8%E7%AB%A0CompletableFuture.html" class="nav-link sidebar-link sidebar-page" aria-label="ç¬¬ 8 ç«  CompletableFuture"><!---->ç¬¬ 8 ç«  CompletableFuture<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">å®æˆ˜ Java é«˜å¹¶å‘ç¨‹åºè®¾è®¡</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">å®æˆ˜ Java è™šæ‹Ÿæœºï¼šJVM æ•…éšœè¯Šæ–­ä¸æ€§èƒ½ä¼˜åŒ–</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">æ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºï¼šJVM é«˜çº§ç‰¹æ€§ä¸æœ€ä½³å®è·µ</span><span class="arrow right"></span></button><!----></section><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><p class="sidebar-heading"><span class="icon iconfont icon-note" style=""></span><span class="title">leetcode</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/leetcode/Top100/" class="nav-link sidebar-link sidebar-page" aria-label="Top 100"><!---->Top 100<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->ç¬¬ 5 ç«  å¹¶å‘å®¹å™¨</h1><div class="page-info"><span class="author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down" localizeddate="2022å¹´7æœˆ16æ—¥" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://www.cxlsn.cn/" target="_blank" rel="noopener noreferrer">é˜¿æ¥ sneaker</a></span><span property="author" content="é˜¿æ¥ sneaker"></span></span><!----><span class="date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022å¹´7æœˆ16æ—¥</span><meta property="datePublished" content="2022-07-16T09:38:20.000Z"></span><!----><!----><span class="reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down" localizeddate="2022å¹´7æœˆ16æ—¥" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 56 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT56M"></span><span class="words-info" aria-label="å­—æ•°ğŸ” " data-balloon-pos="down" localizeddate="2022å¹´7æœˆ16æ—¥" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>çº¦ 16778 å­—</span><meta property="wordCount" content="16778"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-1-blockingqueue" class="router-link-active router-link-exact-active toc-link level2">5.1 BlockingQueue</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-1-1-arrayblockingqueue" class="router-link-active router-link-exact-active toc-link level3">5.1.1 ArrayBlockingQueue</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-1-2-linkedblockingqueue" class="router-link-active router-link-exact-active toc-link level3">5.1.2 LinkedBlockingQueue</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-1-3-priorityblockingqueue" class="router-link-active router-link-exact-active toc-link level3">5.1.3 PriorityBlockingQueue</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-1-4-delayqueue" class="router-link-active router-link-exact-active toc-link level3">5.1.4 DelayQueue</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-1-5-synchronousqueue" class="router-link-active router-link-exact-active toc-link level3">5.1.5 SynchronousQueue</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-2-blockingdeque" class="router-link-active router-link-exact-active toc-link level2">5.2 BlockingDeque</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-3-copyonwrite" class="router-link-active router-link-exact-active toc-link level2">5.3 CopyOnWrite</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-3-1-copyonwritearraylist" class="router-link-active router-link-exact-active toc-link level3">5.3.1 CopyOnWriteArrayList</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-3-2-copyonwritearrayset" class="router-link-active router-link-exact-active toc-link level3">5.3.2 CopyOnWriteArraySet</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-4-concurrentlinkedqueue-deque" class="router-link-active router-link-exact-active toc-link level2">5.4 ConcurrentLinkedQueue / Deque</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-5-concurrenthashmap" class="router-link-active router-link-exact-active toc-link level2">5.5 ConcurrentHashMap</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-5-1-jdk-7-ä¸­çš„å®ç°æ–¹å¼" class="router-link-active router-link-exact-active toc-link level3">5.5.1 JDK 7 ä¸­çš„å®ç°æ–¹å¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-5-2-jdk-8-ä¸­çš„å®ç°æ–¹å¼" class="router-link-active router-link-exact-active toc-link level3">5.5.2 JDK 8 ä¸­çš„å®ç°æ–¹å¼</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-6-concurrentskiplistmap-set" class="router-link-active router-link-exact-active toc-link level2">5.6 ConcurrentSkipListMap / Set</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-6-1-concurrentskiplistmap" class="router-link-active router-link-exact-active toc-link level3">5.6.1 ConcurrentSkipListMap</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC5%E7%AB%A0%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8.html#_5-6-2-concurrentskiplistset" class="router-link-active router-link-exact-active toc-link level3">5.6.2 ConcurrentSkipListSet</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="ç¬¬-5-ç« -å¹¶å‘å®¹å™¨" tabindex="-1"><a class="header-anchor" href="#ç¬¬-5-ç« -å¹¶å‘å®¹å™¨" aria-hidden="true">#</a> ç¬¬ 5 ç«  å¹¶å‘å®¹å™¨</h1><p>åœ¨ Lock å’Œ Phaser çš„å®ç°ä¸­ï¼Œå·²ç»ä»‹ç»äº†åŸºäº CAS å®ç°çš„æ— é”é˜Ÿåˆ—å’Œæ— é”æ ˆã€‚æœ¬ç« å°†å…¨é¢ä»‹ç» Concurrent åŒ…æä¾›çš„å„ç§å¹¶å‘å®¹å™¨ã€‚</p><h2 id="_5-1-blockingqueue" tabindex="-1"><a class="header-anchor" href="#_5-1-blockingqueue" aria-hidden="true">#</a> 5.1 BlockingQueue</h2><p>åœ¨æ‰€æœ‰çš„å¹¶å‘å®¹å™¨ä¸­ï¼ŒBlockingQueue æ˜¯æœ€å¸¸è§çš„ä¸€ç§ã€‚BlockingQueue æ˜¯ä¸€ä¸ªå¸¦é˜»å¡åŠŸèƒ½çš„é˜Ÿåˆ—ï¼Œå½“å…¥é˜Ÿåˆ—æ—¶ï¼Œè‹¥é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™é˜»å¡è°ƒç”¨è€…ï¼›å½“å‡ºé˜Ÿåˆ—æ—¶ï¼Œè‹¥é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™é˜»å¡è°ƒç”¨è€…ã€‚</p><p>åœ¨ Concurrent åŒ…ä¸­ï¼ŒBlockingQueue æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæœ‰è®¸å¤šä¸ªä¸åŒçš„å®ç°ç±»ï¼Œå¦‚å›¾5-1 æ‰€ç¤ºã€‚</p><img src="/assets/å›¾5-1.89098d2e.jpeg" alt="å›¾5-1" style="zoom:50%;"><p>å›¾5-1 BlockingQueue çš„å„ç§å®ç°ç±»</p><p>è¯¥æ¥å£çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æ¥å£å’Œ JDK é›†åˆåŒ…ä¸­çš„ Queue æ¥å£æ˜¯å…¼å®¹çš„ï¼ŒåŒæ—¶åœ¨å…¶åŸºç¡€ä¸Šå¢åŠ äº†é˜»å¡åŠŸèƒ½ã€‚åœ¨è¿™é‡Œï¼Œå…¥é˜Ÿæä¾›äº† add(..)ã€offer(..)ã€put (..) 3 ä¸ªå‡½æ•°ï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿä»ä¸Šé¢çš„å®šä¹‰å¯ä»¥çœ‹åˆ°ï¼Œadd(..) å’Œ offer(..) çš„è¿”å›å€¼æ˜¯å¸ƒå°”ç±»å‹ï¼Œè€Œ put æ— è¿”å›å€¼ï¼Œè¿˜ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼Œæ‰€ä»¥ add(..) å’Œ offer(..) æ˜¯æ— é˜»å¡çš„ï¼Œä¹Ÿæ˜¯ Queue æœ¬èº«å®šä¹‰çš„æ¥å£ï¼Œè€Œ put(..) æ˜¯é˜»å¡å¼çš„ã€‚add(..) å’Œ offer(..) çš„åŒºåˆ«ä¸å¤§ï¼Œå½“é˜Ÿåˆ—ä¸ºæ»¡çš„æ—¶å€™ï¼Œå‰è€…ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œåè€…åˆ™ç›´æ¥è¿”å› falseã€‚</p><p>å‡ºé˜Ÿåˆ—ä¸ä¹‹ç±»ä¼¼ï¼Œæä¾›äº† remove()ã€peek()ã€take() ç­‰å‡½æ•°ï¼Œremove() å’Œ peek() æ˜¯éé˜»å¡å¼çš„ï¼Œtake() æ˜¯é˜»å¡å¼çš„ã€‚</p><p>ä¸‹é¢åˆ†åˆ«ä»‹ç» BlockingQueue çš„å„ç§ä¸åŒå®ç°ã€‚</p><h3 id="_5-1-1-arrayblockingqueue" tabindex="-1"><a class="header-anchor" href="#_5-1-1-arrayblockingqueue" aria-hidden="true">#</a> 5.1.1 ArrayBlockingQueue</h3><p>ArrayBlockingQueue æ˜¯ä¸€ä¸ªç”¨æ•°ç»„å®ç°çš„ç¯å½¢é˜Ÿåˆ—ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­ï¼Œä¼šè¦æ±‚ä¼ å…¥æ•°ç»„çš„å®¹é‡ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶æ ¸å¿ƒæ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// æ•°ç»„åŠé˜Ÿå¤´ã€é˜Ÿå°¾æŒ‡é’ˆ</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> items<span class="token punctuation">;</span>
    <span class="token keyword">int</span> takeIndex<span class="token punctuation">;</span>
    <span class="token keyword">int</span> putIndex<span class="token punctuation">;</span>
    <span class="token keyword">int</span> count<span class="token punctuation">;</span>
    <span class="token comment">// å…¶æ ¸å¿ƒå°±æ˜¯ 1 æŠŠé” + 2 ä¸ªæ¡ä»¶</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notFull<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ put / take å‡½æ•°ä¹Ÿå¾ˆç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token function">checkNotNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    <span class="token comment">// ä½¿ç”¨çš„å¯ä¸­æ–­çš„ Lock</span>
    lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> items<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
            <span class="token comment">// put çš„æ—¶å€™ï¼Œè‹¥é˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™é˜»å¡</span>
            notFull<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">insert</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">E</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    items<span class="token punctuation">[</span>putIndex<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
    putIndex <span class="token operator">=</span> <span class="token function">inc</span><span class="token punctuation">(</span>putIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">++</span>count<span class="token punctuation">;</span>
    <span class="token comment">// å½“ put è¿›å»ä¹‹åï¼Œé€šçŸ¥éç©ºæ¡ä»¶</span>
    notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">// åœ¨ take çš„æ—¶å€™ï¼Œè‹¥é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™é˜»å¡</span>
            notEmpty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">extract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">E</span> <span class="token function">extract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> items <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">;</span>
    <span class="token class-name">E</span> x <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token function">cast</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>takeIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    items<span class="token punctuation">[</span>takeIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    takeIndex <span class="token operator">=</span> <span class="token function">inc</span><span class="token punctuation">(</span>takeIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">--</span>count<span class="token punctuation">;</span>
    <span class="token comment">// take ç»“æŸï¼Œé€šçŸ¥éæ»¡æ¡ä»¶</span>
    notFull<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-1-2-linkedblockingqueue" tabindex="-1"><a class="header-anchor" href="#_5-1-2-linkedblockingqueue" aria-hidden="true">#</a> 5.1.2 LinkedBlockingQueue</h3><p>LinkedBlockingQueue æ˜¯ä¸€ç§åŸºäºå•å‘é“¾è¡¨çš„é˜»å¡é˜Ÿåˆ—ã€‚å› ä¸ºé˜Ÿå¤´å’Œé˜Ÿå°¾æ˜¯ 2 ä¸ªæŒ‡é’ˆåˆ†å¼€æ“ä½œçš„ï¼Œæ‰€ä»¥ç”¨äº† 2 æŠŠé” + 2 ä¸ªæ¡ä»¶ï¼ŒåŒæ—¶æœ‰ 1 ä¸ª AtomicInteger çš„åŸå­å˜é‡è®°å½• count æ•°ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>
    <span class="token comment">// åŸå­å˜é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å•å‘é“¾è¡¨çš„å¤´éƒ¨å’Œå°¾éƒ¨</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> head<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> last<span class="token punctuation">;</span>
    <span class="token comment">// 2 æŠŠé” + 2 ä¸ªæ¡ä»¶</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty <span class="token operator">=</span> takeLock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notFull <span class="token operator">=</span> putLock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨å…¶æ„é€ å‡½æ•°ä¸­ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šé˜Ÿåˆ—çš„æ€»å®¹é‡ã€‚å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ä¸º Integer.MAX_VALUEã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>capacity <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span>
    last <span class="token operator">=</span> head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢çœ‹ä¸€ä¸‹å…¶ put / take å®ç°ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>putLock<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">;</span>
    putLock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            notFull<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">enqueue</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        c <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> capacity<span class="token punctuation">)</span>
            <span class="token comment">// é€šçŸ¥å…¶ä»– put çº¿ç¨‹</span>
            notFull<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        putLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment">// è¿™ä¸ªé‡Œé¢è¦åŠ  takeLock</span>
        <span class="token function">signalNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">E</span> x<span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>takeLock<span class="token punctuation">;</span>
    takeLock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            notEmpty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        x <span class="token operator">=</span> <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        c <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">getAndDecrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token comment">// é€šçŸ¥å…¶ä»– take çº¿ç¨‹</span>
            notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        takeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> capacity<span class="token punctuation">)</span>
        <span class="token comment">// è¿™ä¸ªé‡Œé¢è¦åŠ  putLock</span>
        <span class="token function">signalNotFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>LinkedBlockingQueue å’Œ ArrayBlockingQueue çš„å®ç°æœ‰ä¸€äº›å·®å¼‚ï¼Œæœ‰å‡ ç‚¹è¦ç‰¹åˆ«è¯´æ˜ï¼š</p><ol><li><p>ä¸ºäº†æé«˜å¹¶å‘åº¦ï¼Œç”¨ 2 æŠŠé”ï¼Œåˆ†åˆ«æ§åˆ¶é˜Ÿå¤´ã€é˜Ÿå°¾çš„æ“ä½œã€‚æ„å‘³ç€åœ¨ put(..) å’Œ put(..) ä¹‹é—´ã€take() ä¸ take() ä¹‹é—´æ˜¯äº’æ–¥çš„ï¼Œput(..) å’Œ take() ä¹‹é—´å¹¶ä¸äº’æ–¥ã€‚ä½†å¯¹äº count å˜é‡ï¼ŒåŒæ–¹éƒ½éœ€è¦æ“ä½œï¼Œæ‰€ä»¥å¿…é¡»æ˜¯åŸå­ç±»å‹ã€‚</p></li><li><p>å› ä¸ºå„è‡ªæ‹¿äº†ä¸€æŠŠé”ï¼Œæ‰€ä»¥å½“éœ€è¦è°ƒç”¨å¯¹æ–¹çš„ condition çš„ signal æ—¶ï¼Œè¿˜å¿…é¡»å†åŠ ä¸Šå¯¹æ–¹çš„é”ï¼Œå°±æ˜¯ signalNotEmpty() å’Œ signalNotFull() å‡½æ•°ã€‚ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">signalNotEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>takeLock<span class="token punctuation">;</span>
    <span class="token comment">// å¿…é¡»å…ˆæ‹¿åˆ° takeLockï¼Œæ‰èƒ½è°ƒç”¨ notEmpty.signal</span>
    takeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        takeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">signalNotFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>putLock<span class="token punctuation">;</span>
    <span class="token comment">// å¿…é¡»å…ˆæ‹¿åˆ° putLockï¼Œæ‰èƒ½è°ƒç”¨ notFull.signal</span>
    putLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        notFull<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        putLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ä¸ä»… put ä¼šé€šçŸ¥ takeï¼Œtake ä¹Ÿä¼šé€šçŸ¥ putã€‚å½“ put å‘ç°éæ»¡çš„æ—¶å€™ï¼Œä¹Ÿä¼šé€šçŸ¥å…¶ä»– put çº¿ç¨‹ï¼›å½“ take å‘ç°éç©ºçš„æ—¶å€™ï¼Œä¹Ÿä¼šé€šçŸ¥å…¶ä»– take çº¿ç¨‹ã€‚</p></li></ol><h3 id="_5-1-3-priorityblockingqueue" tabindex="-1"><a class="header-anchor" href="#_5-1-3-priorityblockingqueue" aria-hidden="true">#</a> 5.1.3 PriorityBlockingQueue</h3><p>é˜Ÿåˆ—é€šå¸¸æ˜¯å…ˆè¿›å…ˆå‡ºçš„ï¼Œè€Œ PriorityQueue æ˜¯æŒ‰ç…§å…ƒç´ çš„ä¼˜å…ˆçº§ä»å°åˆ°å¤§å‡ºé˜Ÿåˆ—çš„ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼ŒPriorityQueue ä¸­çš„ 2 ä¸ªå…ƒç´ ä¹‹é—´éœ€è¦å¯ä»¥æ¯”è¾ƒå¤§å°ï¼Œå¹¶å®ç° Comparable æ¥å£ã€‚</p><p>å…¶æ ¸å¿ƒæ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>    
    <span class="token comment">// ...</span>
    <span class="token comment">// ç”¨æ•°ç»„å®ç°çš„äºŒå‰å°æ ¹å †</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> queue<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> comparator<span class="token punctuation">;</span>
    <span class="token comment">// 1 æŠŠé” + 1 ä¸ªæ¡ä»¶ï¼Œæ²¡æœ‰éæ»¡çš„æ¡ä»¶</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶æ„é€ å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼Œå¦‚æœä¸æŒ‡å®šåˆå§‹å¤§å°ï¼Œå†…éƒ¨ä¼šè®¾å®šä¸€ä¸ªé»˜è®¤å€¼ 11ï¼Œå½“å…ƒç´ ä¸ªæ•°è¶…è¿‡è¿™ä¸ªå¤§å°ä¹‹åï¼Œä¼šè‡ªåŠ¨æ‰©å®¹ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>DEFAULT_INITIAL_CAPACITY<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_INITIAL_CAPACITY <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> comparator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>notEmpty <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>comparator <span class="token operator">=</span> comparator<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>initialCapacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ˜¯å¯¹åº”çš„ put / take å‡½æ•°çš„å®ç°ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">offer</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> n<span class="token punctuation">,</span> cap<span class="token punctuation">;</span>
    <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> size<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>cap <span class="token operator">=</span> <span class="token punctuation">(</span>array <span class="token operator">=</span> queue<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// size è¶…å‡ºäº†æ•°ç»„çš„é•¿åº¦ï¼Œæ‰©å®¹</span>
        <span class="token function">tryGrow</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> cmp <span class="token operator">=</span> comparator<span class="token punctuation">;</span>
        <span class="token comment">// æ²¡æœ‰å®šä¹‰æ¯”è¾ƒæ“ä½œç¬¦ï¼Œä½¿ç”¨å…ƒç´ è‡ªå¸¦çš„æ¯”è¾ƒåŠŸèƒ½</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">// å…ƒç´ å…¥å †ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œ siftUp æ“ä½œ</span>
            <span class="token function">siftUpComparable</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> e<span class="token punctuation">,</span> array<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">siftUpUsingComparator</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> e<span class="token punctuation">,</span> array<span class="token punctuation">,</span> cmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">E</span> result<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// å‡ºé˜Ÿåˆ—</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>result <span class="token operator">=</span> <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            notEmpty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">E</span> <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> n <span class="token operator">=</span> size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> queue<span class="token punctuation">;</span>
        <span class="token comment">// å› ä¸ºæ˜¯æœ€å°äºŒå‰å †ï¼Œå †é¡¶å³æ˜¯è¦å‡ºé˜Ÿçš„å…ƒç´ </span>
        <span class="token class-name">E</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">E</span> x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> array<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
        array<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> cmp <span class="token operator">=</span> comparator<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">// è°ƒæ•´å †ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œ siftDown æ“ä½œ</span>
            <span class="token function">siftDownComparable</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> array<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">siftDownUsingComparator</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> array<span class="token punctuation">,</span> n<span class="token punctuation">,</span> cmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> n<span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œåœ¨é˜»å¡çš„å®ç°æ–¹é¢ï¼Œå’Œ ArrayBlockingQueue çš„æœºåˆ¶ç›¸ä¼¼ï¼Œä¸»è¦åŒºåˆ«æ˜¯ç”¨æ•°ç»„å®ç°äº†ä¸€ä¸ªäºŒå‰å †ï¼Œä»è€Œå®ç°æŒ‰ä¼˜å…ˆçº§ä»å°åˆ°å¤§å‡ºé˜Ÿåˆ—ã€‚å¦ä¸€ä¸ªåŒºåˆ«æ˜¯æ²¡æœ‰ notFull æ¡ä»¶ï¼Œå½“å…ƒç´ ä¸ªæ•°è¶…å‡ºæ•°ç»„é•¿åº¦æ—¶ï¼Œæ‰§è¡Œæ‰©å®¹æ“ä½œã€‚</p><h3 id="_5-1-4-delayqueue" tabindex="-1"><a class="header-anchor" href="#_5-1-4-delayqueue" aria-hidden="true">#</a> 5.1.4 DelayQueue</h3><p>DelayQueue å³å»¶è¿Ÿé˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæŒ‰å»¶è¿Ÿæ—¶é—´ä»å°åˆ°å¤§å‡ºé˜Ÿçš„ PriorityQueueã€‚æ‰€è°“å»¶è¿Ÿæ—¶é—´ï¼Œå°±æ˜¯ â€œæœªæ¥å°†è¦æ‰§è¡Œçš„æ—¶é—´â€ - â€œå½“å‰æ—¶é—´â€ã€‚ä¸ºæ­¤ï¼Œæ”¾å…¥ DelayQueue ä¸­çš„å…ƒç´ ï¼Œå¿…é¡»å®ç° Delayed æ¥å£ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Delayed</span> <span class="token keyword">extends</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Delayed</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> <span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…³äºè¯¥æ¥å£ï¼Œæœ‰ä¸¤ç‚¹è¯´æ˜ï¼š</p><ol><li><p>å¦‚æœ getDelay çš„è¿”å›å€¼å°äºæˆ–ç­‰äº 0ï¼Œåˆ™è¯´æ˜è¯¥å…ƒç´ åˆ°æœŸï¼Œéœ€è¦ä»é˜Ÿåˆ—ä¸­æ‹¿å‡ºæ¥æ‰§è¡Œã€‚</p></li><li><p>è¯¥æ¥å£é¦–å…ˆç»§æ‰¿äº† Comparable æ¥å£ï¼Œæ‰€ä»¥è¦å®ç°è¯¥æ¥å£ï¼Œå¿…é¡»å®ç° Comparable æ¥å£ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯åŸºäº getDelay() çš„è¿”å›å€¼æ¯”è¾ƒä¸¤ä¸ªå…ƒç´ çš„å¤§å°ã€‚</p></li></ol><p>ä¸‹é¢çœ‹ä¸€ä¸‹ DelayQueue çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DelayQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span> <span class="token keyword">extends</span> <span class="token class-name">Delayed</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// ä¼˜å…ˆçº§é˜Ÿåˆ—</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1 æŠŠé” + 1 ä¸ªæ¡ä»¶</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> available <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢ä»‹ç» put / take çš„å®ç°ï¼Œå…ˆä» take è¯´èµ·ï¼Œå› ä¸ºè¿™æ ·æ›´èƒ½çœ‹å‡º DelayQueue çš„ç‰¹æ€§ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å–å‡ºäºŒå‰å †çš„å †é¡¶å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯å»¶è¿Ÿæ—¶é—´æœ€å°çš„</span>
            <span class="token class-name">E</span> first <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token comment">// é˜Ÿåˆ—ä¸ºç©ºï¼Œtake çº¿ç¨‹é˜»å¡</span>
                available<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> delay <span class="token operator">=</span> first<span class="token punctuation">.</span><span class="token function">getDelay</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å †é¡¶å…ƒç´ çš„å»¶è¿Ÿæ—¶é—´å°äºæˆ–ç­‰äº 0ï¼Œå‡ºé˜Ÿåˆ—ï¼Œè¿”å›</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> q<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å¦‚æœå·²ç»æœ‰å…¶ä»–çº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…è¿™ä¸ªå…ƒç´ ï¼Œåˆ™æ— é™æœŸé˜»å¡</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    available<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span> thisThread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    leader <span class="token operator">=</span> thisThread<span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">// å¦åˆ™é˜»å¡æœ‰é™çš„æ—¶é—´</span>
                        available<span class="token punctuation">.</span><span class="token function">awaitNanos</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">==</span> thisThread<span class="token punctuation">)</span>
                            leader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> q<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">// è‡ªå·±æ˜¯ leaderï¼Œå·²ç»è·å–äº†å †é¡¶å…ƒç´ ï¼Œå”¤é†’å…¶ä»–çº¿ç¨‹</span>
            available<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…³äº take() å‡½æ•°ï¼Œæœ‰ä¸¤ç‚¹éœ€è¦è¯´æ˜ï¼š</p><ol><li><p>ä¸åŒäºä¸€èˆ¬çš„é˜»å¡é˜Ÿåˆ—ï¼Œåªåœ¨é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œæ‰é˜»å¡ã€‚å¦‚æœå †é¡¶å…ƒç´ çš„å»¶è¿Ÿæ—¶é—´æ²¡åˆ°ï¼Œä¹Ÿä¼šé˜»å¡ã€‚</p></li><li><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ä½¿ç”¨äº†ä¸€ä¸ªä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨ä¸€ä¸ª Thread leader å˜é‡è®°å½•äº†ç­‰å¾…å †é¡¶å…ƒç´ çš„ç¬¬ 1 ä¸ªçº¿ç¨‹ã€‚ä¸ºä»€ä¹ˆè¿™æ ·åšå‘¢ï¼Ÿé€šè¿‡ getDelay(..) å¯ä»¥çŸ¥é“å †é¡¶å…ƒç´ ä½•æ—¶åˆ°æœŸï¼Œä¸å¿…æ— é™æœŸç­‰å¾…ï¼Œå¯ä»¥ä½¿ç”¨ condition.awaitNanos() ç­‰å¾…ä¸€ä¸ªæœ‰é™çš„æ—¶é—´ï¼›åªæœ‰å½“å‘ç°è¿˜æœ‰å…¶ä»–çº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…å †é¡¶å…ƒç´ ï¼ˆleader != NULLï¼‰æ—¶ï¼Œæ‰éœ€è¦æ— é™æœŸç­‰å¾…ã€‚</p></li></ol><p>ä¸‹é¢çœ‹ä¸€ä¸‹ put çš„å®ç°ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">offer</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// å…ƒç´ æ”¾å…¥äºŒå‰å †</span>
        q<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœæ”¾è¿›å»çš„å…ƒç´ åˆšå¥½åœ¨å †é¡¶ï¼Œè¯´æ˜æ”¾å…¥å †å…ƒç´ å»¶è¿Ÿæ—¶é—´æ˜¯æœ€å°çš„ï¼Œ</span>
        <span class="token comment">// é‚£ä¹ˆéœ€è¦é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹ï¼Œå¦åˆ™æ”¾å…¥çš„å…ƒç´ ä¸åœ¨å †é¡¶ï¼Œæ²¡æœ‰å¿…è¦é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            leader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            available<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…³äºä¸Šé¢çš„å®ç°ï¼Œæœ‰ä¸€ç‚¹è¦è¯´æ˜ï¼šä¸æ˜¯æ¯æ”¾å…¥ä¸€ä¸ªå…ƒç´ ï¼Œéƒ½éœ€è¦é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹ã€‚æ”¾å…¥çš„å…ƒç´ ï¼Œå¦‚æœå…¶å»¶è¿Ÿæ—¶é—´å¤§äºå½“å‰å †é¡¶çš„å…ƒç´ å»¶è¿Ÿæ—¶é—´ï¼Œå°±æ²¡å¿…è¦é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹ï¼›åªæœ‰å½“å»¶è¿Ÿæ—¶é—´æ˜¯æœ€å°çš„ï¼Œåœ¨å †é¡¶æ—¶ï¼Œæ‰æœ‰å¿…è¦é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ä»£ç ä¸­çš„ if (q.peek() == e) æ®µè½ã€‚</p><h3 id="_5-1-5-synchronousqueue" tabindex="-1"><a class="header-anchor" href="#_5-1-5-synchronousqueue" aria-hidden="true">#</a> 5.1.5 SynchronousQueue</h3><p>SynchronousQueue æ˜¯ä¸€ç§ç‰¹æ®Šçš„ BlockingQueueï¼Œå®ƒæœ¬èº«æ²¡æœ‰å®¹é‡ã€‚å…ˆè°ƒ put(..)ï¼Œçº¿ç¨‹ä¼šé˜»å¡ï¼›ç›´åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº† take()ï¼Œä¸¤ä¸ªçº¿ç¨‹æ‰åŒæ—¶è§£é”ï¼Œåä¹‹äº¦ç„¶ã€‚å¯¹äºå¤šä¸ªçº¿ç¨‹è€Œè¨€ï¼Œä¾‹å¦‚ 3 ä¸ªçº¿ç¨‹ï¼Œè°ƒç”¨ 3 æ¬¡ put(..)ï¼Œ3 ä¸ªçº¿ç¨‹éƒ½ä¼šé˜»å¡ï¼›ç›´åˆ°å¦å¤–çš„çº¿ç¨‹è°ƒç”¨ 3 æ¬¡ take()ï¼Œ6 ä¸ªçº¿ç¨‹æ‰åŒæ—¶è§£é”ï¼Œåä¹‹äº¦ç„¶ã€‚</p><p>åœ¨è®²è§£çº¿ç¨‹æ± ä¸­çš„ CachedThreadPool å®ç°çš„æ—¶å€™ä¼šä½¿ç”¨åˆ° SynchronousQueue çš„è¿™ç§ç‰¹æ€§ã€‚</p><p>æ¥ä¸‹æ¥å°±çœ‹ä¸€ä¸‹ï¼ŒSynchronousQueue æ˜¯å¦‚ä½•å®ç°çš„ã€‚å…ˆä»æ„é€ å‡½æ•°çœ‹èµ·ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">SynchronousQueue</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    transferer <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">TransferQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">TransferStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å’Œé”ä¸€æ ·ï¼Œä¹Ÿæœ‰å…¬å¹³å’Œéå…¬å¹³æ¨¡å¼ã€‚å¦‚æœæ˜¯å…¬å¹³æ¨¡å¼ï¼Œåˆ™ç”¨ TransferQueue å®ç°ï¼›å¦‚æœæ˜¯éå…¬å¹³æ¨¡å¼ï¼Œåˆ™ç”¨ TransferStack å®ç°ã€‚è¿™ä¸¤ä¸ªç±»åˆ†åˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…ˆçœ‹ä¸€ä¸‹ put / take çš„å®ç°ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> o<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>transferer<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> e <span class="token operator">=</span> transferer<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span>e<span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œput / take éƒ½è°ƒç”¨äº† transfer(..) æ¥å£ã€‚è€Œ TransferQueue å’Œ TransferStack åˆ†åˆ«å®ç°äº†è¿™ä¸ªæ¥å£ã€‚è¯¥æ¥å£åœ¨ SynchronousQueue å†…éƒ¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚å¦‚æœæ˜¯ put(..)ï¼Œåˆ™ç¬¬ 1 ä¸ªå‚æ•°å°±æ˜¯å¯¹åº”çš„å…ƒç´ ï¼›å¦‚æœæ˜¯ take()ï¼Œåˆ™ç¬¬ 1 ä¸ªå‚æ•°ä¸º nullã€‚å 2 ä¸ªå‚æ•°åˆ†åˆ«ä¸ºæ˜¯å¦è®¾ç½®è¶…æ—¶å’Œå¯¹åº”çš„è¶…æ—¶æ—¶é—´ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Transferer</span> <span class="token punctuation">{</span>
    <span class="token keyword">abstract</span> <span class="token class-name">Object</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Object</span> e<span class="token punctuation">,</span> <span class="token keyword">boolean</span> timed<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ä»€ä¹ˆæ˜¯å…¬å¹³æ¨¡å¼å’Œéå…¬å¹³æ¨¡å¼ï¼Œå¦‚å›¾5-2 æ‰€ç¤ºã€‚å‡è®¾ 3 ä¸ªçº¿ç¨‹åˆ†åˆ«è°ƒç”¨äº† put(..)ï¼Œ3 ä¸ªçº¿ç¨‹ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨ 3 æ¬¡ take()ï¼Œå’Œ 3 ä¸ª put(..) ä¸€ä¸€é…å¯¹ã€‚</p><img src="/assets/å›¾5-2.7f243469.jpeg" alt="å›¾5-2" style="zoom:50%;"><p>å›¾5-2 å…¬å¹³æ¨¡å¼ä¸éå…¬å¹³æ¨¡å¼å¯¹æ¯”</p><p>å¦‚æœæ˜¯å…¬å¹³æ¨¡å¼ï¼ˆé˜Ÿåˆ—æ¨¡å¼ï¼‰ï¼Œåˆ™ç¬¬ 1 ä¸ªè°ƒç”¨ put(..) çš„çº¿ç¨‹ 1 ä¼šåœ¨é˜Ÿåˆ—å¤´éƒ¨ï¼Œç¬¬ 1 ä¸ªåˆ°æ¥çš„ take() çº¿ç¨‹å’Œå®ƒè¿›è¡Œé…å¯¹ï¼Œéµå¾ªå…ˆåˆ°å…ˆé…å¯¹çš„åŸåˆ™ï¼Œæ‰€ä»¥æ˜¯å…¬å¹³çš„ï¼›å¦‚æœæ˜¯éå…¬å¹³æ¨¡å¼ï¼ˆæ ˆæ¨¡å¼ï¼‰ï¼Œåˆ™ç¬¬ 3 ä¸ªè°ƒç”¨ put(..) çš„çº¿ç¨‹ 3 ä¼šåœ¨æ ˆé¡¶ï¼Œç¬¬ 1 ä¸ªåˆ°æ¥çš„ take() çº¿ç¨‹å’Œå®ƒè¿›è¡Œé…å¯¹ï¼Œéµå¾ªçš„æ˜¯ååˆ°å…ˆé…å¯¹çš„åŸåˆ™ï¼Œæ‰€ä»¥æ˜¯éå…¬å¹³çš„ã€‚</p><p>ä¸‹é¢åˆ†åˆ«çœ‹ä¸€ä¸‹ TransferQueue å’Œ TransferStack çš„å®ç°ã€‚</p><ol><li><p>TransferQueue</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TransferQueue</span> <span class="token keyword">extends</span> <span class="token class-name">Transferer</span> <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">QNode</span> <span class="token punctuation">{</span>
            <span class="token comment">// å•å‘é“¾è¡¨</span>
            <span class="token keyword">volatile</span> <span class="token class-name">QNode</span> next<span class="token punctuation">;</span>          
            <span class="token comment">// å¦‚æœæ˜¯ putï¼Œåˆ™ item != nullï¼›å¦‚æœæ˜¯ takeï¼Œåˆ™ item == null</span>
            <span class="token keyword">volatile</span> <span class="token class-name">Object</span> item<span class="token punctuation">;</span>         
            <span class="token comment">// put / take å¯¹åº”çš„é˜»å¡çº¿ç¨‹å’Œä¸Šé¢çš„ item å¯¹åº”</span>
            <span class="token keyword">volatile</span> <span class="token class-name">Thread</span> waiter<span class="token punctuation">;</span> 
            <span class="token comment">// putï¼ŒisData = trueï¼Œå¦åˆ™ä¸º false</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> isData<span class="token punctuation">;</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">QNode</span> head<span class="token punctuation">;</span>
    <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">QNode</span> tail<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒTransferQueue æ˜¯ä¸€ä¸ªåŸºäºå•å‘é“¾è¡¨è€Œå®ç°çš„é˜Ÿåˆ—ï¼Œé€šè¿‡ head å’Œ tailï¼Œ2 ä¸ªæŒ‡é’ˆè®°å½•å¤´éƒ¨å’Œå°¾éƒ¨ã€‚åˆå§‹çš„æ—¶å€™ï¼Œhead å’Œ tail ä¼šæŒ‡å‘ä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼Œæ„é€ å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">TransferQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç©ºèŠ‚ç‚¹</span>
    <span class="token class-name">QNode</span> h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QNode</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    head <span class="token operator">=</span> h<span class="token punctuation">;</span>
    tail <span class="token operator">=</span> h<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å›¾5-3 æ‰€ç¤ºä¸º TransferQueue çš„å·¥ä½œåŸç†ã€‚</p><img src="/assets/å›¾5-3.91ddce0c.jpeg" alt="å›¾5-3" style="zoom:50%;"><p>å›¾5-3 TransferQueue çš„å·¥ä½œåŸç†</p><p>é˜¶æ®µï¼ˆaï¼‰ï¼šé˜Ÿåˆ—ä¸­æ˜¯ä¸€ä¸ªç©ºçš„èŠ‚ç‚¹ï¼Œhead / tail éƒ½æŒ‡å‘è¿™ä¸ªç©ºèŠ‚ç‚¹ã€‚</p><p>é˜¶æ®µï¼ˆbï¼‰ï¼š3 ä¸ªçº¿ç¨‹åˆ†åˆ«è°ƒç”¨ putï¼Œç”Ÿæˆ 3 ä¸ª QNodeï¼Œè¿›å…¥é˜Ÿåˆ—ã€‚</p><p>é˜¶æ®µï¼ˆcï¼‰ï¼šæ¥äº†ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ takeï¼Œä¼šå’Œé˜Ÿåˆ—å¤´éƒ¨çš„ç¬¬ 1 ä¸ª QNode è¿›è¡Œé…å¯¹ã€‚</p><p>é˜¶æ®µï¼ˆdï¼‰ï¼šç¬¬ 1 ä¸ª QNode å‡ºé˜Ÿåˆ—ã€‚</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªå…³é”®ç‚¹ï¼šput èŠ‚ç‚¹å’Œ take èŠ‚ç‚¹ä¸€æ—¦ç›¸é‡ï¼Œå°±ä¼šé…å¯¹å‡ºé˜Ÿåˆ—ï¼Œæ‰€ä»¥åœ¨é˜Ÿåˆ—ä¸­ä¸å¯èƒ½åŒæ—¶å­˜åœ¨ put èŠ‚ç‚¹å’Œ take èŠ‚ç‚¹ï¼Œè¦ä¹ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ put èŠ‚ç‚¹ï¼Œè¦ä¹ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ take èŠ‚ç‚¹ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ TransferQueue çš„ä»£ç å®ç°ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Object</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Object</span> e<span class="token punctuation">,</span> <span class="token keyword">boolean</span> timed<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">QNode</span> s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
    <span class="token keyword">boolean</span> isData <span class="token operator">=</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">QNode</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span>
        <span class="token class-name">QNode</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
        <span class="token comment">// é˜Ÿåˆ—è¿˜æœªåˆå§‹åŒ–ï¼Œè‡ªæ—‹ç­‰å¾…</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> h <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span> 
        <span class="token comment">// é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…å½“å‰çº¿ç¨‹å’Œé˜Ÿåˆ—ä¸­å…ƒç´ ä¸ºåŒä¸€ç§æ¨¡å¼</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> t <span class="token operator">||</span> t<span class="token punctuation">.</span>isData <span class="token operator">==</span> isData<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token class-name">QNode</span> tn <span class="token operator">=</span> t<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token comment">// ä¸ä¸€è‡´è¯»ï¼Œé‡æ–°æ‰§è¡Œ for å¾ªç¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> tail<span class="token punctuation">)</span>                  
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>               
                <span class="token function">advanceTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timed <span class="token operator">&amp;&amp;</span> nanos <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>        
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token comment">// æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹</span>
                s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QNode</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> isData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åŠ å…¥å°¾éƒ¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">casNext</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span>        
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token comment">// åç§» tail æŒ‡é’ˆ</span>
            <span class="token function">advanceTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>              
            <span class="token comment">// è¿›å…¥é˜»å¡çŠ¶æ€</span>
            <span class="token class-name">Object</span> x <span class="token operator">=</span> <span class="token function">awaitFulfill</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">,</span> timed<span class="token punctuation">,</span> nanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>                   
                <span class="token function">clean</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// ä»é˜»å¡ä¸­å”¤é†’ï¼Œç¡®å®šå·²ç»å¤„äºé˜Ÿåˆ—ä¸­çš„ç¬¬ 1 ä¸ªå…ƒç´ </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">isOffList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           
                <span class="token function">advanceHead</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>          
                <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>              
                    s<span class="token punctuation">.</span>item <span class="token operator">=</span> s<span class="token punctuation">;</span>
                s<span class="token punctuation">.</span>waiter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> x <span class="token operator">:</span> e<span class="token punctuation">;</span>
            <span class="token comment">// å½“å‰çº¿ç¨‹å¯ä»¥å’Œé˜Ÿåˆ—ä¸­çš„ç¬¬ 1 ä¸ªå…ƒç´ è¿›è¡Œé…å¯¹</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    
            <span class="token comment">// å–é˜Ÿåˆ—ä¸­ç¬¬ 1 ä¸ªå…ƒç´ </span>
            <span class="token class-name">QNode</span> m <span class="token operator">=</span> h<span class="token punctuation">.</span>next<span class="token punctuation">;</span>               
            <span class="token comment">// ä¸ä¸€è‡´è¯»ï¼Œé‡æ–°æ‰§è¡Œ for å¾ªç¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> tail <span class="token operator">||</span> m <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> h <span class="token operator">!=</span> head<span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>                   

            <span class="token class-name">Object</span> x <span class="token operator">=</span> m<span class="token punctuation">.</span>item<span class="token punctuation">;</span>
            <span class="token comment">// å·²ç»é…å¯¹è¿‡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isData <span class="token operator">==</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span>    
                x <span class="token operator">==</span> m <span class="token operator">||</span>                   
                <span class="token comment">// å°è¯•é…å¯¹</span>
                <span class="token operator">!</span>m<span class="token punctuation">.</span><span class="token function">casItem</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       
                <span class="token comment">// å·²ç»é…å¯¹è¿‡ï¼Œç›´æ¥å‡ºé˜Ÿåˆ—</span>
                <span class="token function">advanceHead</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>          
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// é…å¯¹æˆåŠŸï¼Œå‡ºé˜Ÿåˆ—</span>
            <span class="token function">advanceHead</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>              
            <span class="token comment">// å”¤é†’é˜Ÿåˆ—ä¸­ä¸ç¬¬ 1 ä¸ªå…ƒç´ å¯¹åº”çš„çº¿ç¨‹</span>
            <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>waiter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>x <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> x <span class="token operator">:</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ•´ä¸ª for å¾ªç¯æœ‰ä¸¤ä¸ªå¤§çš„ if-else åˆ†æ”¯ï¼Œå¦‚æœå½“å‰çº¿ç¨‹å’Œé˜Ÿåˆ—ä¸­çš„å…ƒç´ æ˜¯åŒä¸€ç§æ¨¡å¼ï¼ˆéƒ½æ˜¯ put èŠ‚ç‚¹æˆ–è€… take èŠ‚ç‚¹ï¼‰ï¼Œåˆ™ä¸å½“å‰çº¿ç¨‹å¯¹åº”çš„èŠ‚ç‚¹è¢«åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨å¹¶ä¸”é˜»å¡ï¼›å¦‚æœä¸æ˜¯åŒä¸€ç§æ¨¡å¼ï¼Œåˆ™é€‰å–é˜Ÿåˆ—å¤´éƒ¨çš„ç¬¬ 1 ä¸ªå…ƒç´ è¿›è¡Œé…å¯¹ã€‚</p><p>è¿™é‡Œçš„é…å¯¹å°±æ˜¯ m.casItem(x, e)ï¼ŒæŠŠè‡ªå·±çš„ item x æ¢æˆå¯¹æ–¹çš„ item eï¼Œå¦‚æœ CAS æ“ä½œæˆåŠŸï¼Œåˆ™é…å¯¹æˆåŠŸã€‚å¦‚æœæ˜¯ put èŠ‚ç‚¹ï¼Œåˆ™ isData = trueï¼Œitem != nullï¼›å¦‚æœæ˜¯ take èŠ‚ç‚¹ï¼Œåˆ™ isData = falseï¼Œitem = nullã€‚å¦‚æœ CAS æ“ä½œä¸æˆåŠŸï¼Œåˆ™ isData å’Œ item ä¹‹é—´å°†ä¸ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯ isData != (x != null)ï¼Œé€šè¿‡è¿™ä¸ªæ¡ä»¶å¯ä»¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å·²ç»è¢«åŒ¹é…è¿‡äº†ã€‚</p></li><li><p>TransferStack</p><p>TransferStack çš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼Œé¦–å…ˆï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ã€‚ä¸åŒäºé˜Ÿåˆ—ï¼Œåªéœ€è¦ head æŒ‡é’ˆå°±èƒ½å®ç°å…¥æ ˆå’Œå‡ºæ ˆæ“ä½œã€‚</p><p>é“¾è¡¨ä¸­çš„èŠ‚ç‚¹æœ‰ä¸‰ç§çŠ¶æ€ï¼ŒREQUEST å¯¹åº” take èŠ‚ç‚¹ï¼ŒDATA å¯¹åº” put èŠ‚ç‚¹ï¼ŒäºŒè€…é…å¯¹ä¹‹åï¼Œä¼šç”Ÿæˆä¸€ä¸ª FULFILLING èŠ‚ç‚¹ï¼Œå…¥æ ˆï¼Œç„¶å FULLING èŠ‚ç‚¹å’Œè¢«é…å¯¹çš„èŠ‚ç‚¹ä¸€èµ·å‡ºæ ˆã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TransferStack</span> <span class="token keyword">extends</span> <span class="token class-name">Transferer</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> REQUEST <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DATA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> FULFILLING <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SNode</span> <span class="token punctuation">{</span>
        <span class="token comment">// å•å‘é“¾è¡¨</span>
        <span class="token keyword">volatile</span> <span class="token class-name">SNode</span> next<span class="token punctuation">;</span>        
        <span class="token comment">// é…å¯¹çš„èŠ‚ç‚¹</span>
        <span class="token keyword">volatile</span> <span class="token class-name">SNode</span> match<span class="token punctuation">;</span>       
        <span class="token comment">// å¯¹åº”çš„é˜»å¡çº¿ç¨‹</span>
        <span class="token keyword">volatile</span> <span class="token class-name">Thread</span> waiter<span class="token punctuation">;</span>    
        <span class="token class-name">Object</span> item<span class="token punctuation">;</span>                
        <span class="token comment">// ä¸‰ç§æ¨¡å¼</span>
        <span class="token keyword">int</span> mode<span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">volatile</span> <span class="token class-name">SNode</span> head<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚å›¾5-4 æ‰€ç¤ºä¸º TransferStack çš„å·¥ä½œåŸç†ã€‚</p><img src="/assets/å›¾5-4.9089083c.jpeg" alt="å›¾5-4" style="zoom:50%;"><p>å›¾5-4 TransferStack çš„å·¥ä½œåŸç†</p><p>é˜¶æ®µï¼ˆaï¼‰ï¼šhead æŒ‡å‘ NULLã€‚ä¸åŒäº TransferQueueï¼Œè¿™é‡Œæ²¡æœ‰ç©ºçš„å¤´èŠ‚ç‚¹ã€‚</p><p>é˜¶æ®µï¼ˆbï¼‰ï¼š3 ä¸ªçº¿ç¨‹è°ƒç”¨ 3 æ¬¡ putï¼Œä¾æ¬¡å…¥æ ˆã€‚</p><p>é˜¶æ®µï¼ˆcï¼‰ï¼šçº¿ç¨‹ 4 è°ƒç”¨ takeï¼Œå’Œæ ˆé¡¶çš„ç¬¬ 1 ä¸ªå…ƒç´ é…å¯¹ï¼Œç”Ÿæˆ FULLFILLING èŠ‚ç‚¹ï¼Œå…¥æ ˆã€‚</p><p>é˜¶æ®µï¼ˆdï¼‰ï¼šæ ˆé¡¶çš„ 2 ä¸ªå…ƒç´ åŒæ—¶å‡ºæ ˆã€‚</p><p>ä¸‹é¢çœ‹ä¸€ä¸‹å…·ä½“çš„ä»£ç å®ç°ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Object</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Object</span> e<span class="token punctuation">,</span> <span class="token keyword">boolean</span> timed<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SNode</span> s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
    <span class="token keyword">int</span> mode <span class="token operator">=</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> REQUEST <span class="token operator">:</span> DATA<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SNode</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
        <span class="token comment">// åŒä¸€ç§æ¨¡å¼</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> h<span class="token punctuation">.</span>mode <span class="token operator">==</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timed <span class="token operator">&amp;&amp;</span> nanos <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       
                <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token function">casHead</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> h<span class="token punctuation">.</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>      
                <span class="token keyword">else</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token comment">// å…¥æ ˆ</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">casHead</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> s <span class="token operator">=</span> <span class="token function">snode</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">,</span> h<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// é˜»å¡ç­‰å¾…</span>
                <span class="token class-name">SNode</span> m <span class="token operator">=</span> <span class="token function">awaitFulfill</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> timed<span class="token punctuation">,</span> nanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>               
                    <span class="token function">clean</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> head<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>next <span class="token operator">==</span> s<span class="token punctuation">)</span>
                    <span class="token function">casHead</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> s<span class="token punctuation">.</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>      
                <span class="token keyword">return</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> REQUEST<span class="token punctuation">)</span> <span class="token operator">?</span> m<span class="token punctuation">.</span>item <span class="token operator">:</span> s<span class="token punctuation">.</span>item<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// éåŒä¸€ç§æ¨¡å¼ï¼Œå¾…åŒ¹é…</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFulfilling</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            
                <span class="token function">casHead</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> h<span class="token punctuation">.</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>         
            <span class="token comment">// ç”Ÿæˆä¸€ä¸ª FULFILLING èŠ‚ç‚¹ï¼Œå…¥æ ˆ</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">casHead</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> s <span class="token operator">=</span> <span class="token function">snode</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">,</span> h<span class="token punctuation">,</span> FULFILLING <span class="token operator">|</span> mode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                    <span class="token class-name">SNode</span> m <span class="token operator">=</span> s<span class="token punctuation">.</span>next<span class="token punctuation">;</span>       
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        
                        <span class="token function">casHead</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
                        s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>           
                        <span class="token keyword">break</span><span class="token punctuation">;</span>              
                    <span class="token punctuation">}</span>
                    <span class="token class-name">SNode</span> mn <span class="token operator">=</span> m<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">tryMatch</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// ä¸¤ä¸ªèŠ‚ç‚¹ä¸€èµ·å‡ºæ ˆ</span>
                        <span class="token function">casHead</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> mn<span class="token punctuation">)</span><span class="token punctuation">;</span>      
                        <span class="token keyword">return</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> REQUEST<span class="token punctuation">)</span> <span class="token operator">?</span> m<span class="token punctuation">.</span>item <span class="token operator">:</span> s<span class="token punctuation">.</span>item<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span>                  
                        s<span class="token punctuation">.</span><span class="token function">casNext</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> mn<span class="token punctuation">)</span><span class="token punctuation">;</span>   
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// å·²ç»åŒ¹é…è¿‡äº†ï¼Œå‡ºæ ˆ</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                           
            <span class="token class-name">SNode</span> m <span class="token operator">=</span> h<span class="token punctuation">.</span>next<span class="token punctuation">;</span>              
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                 
                <span class="token function">casHead</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">SNode</span> mn <span class="token operator">=</span> m<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">tryMatch</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span>           
                    <span class="token comment">// é…å¯¹ï¼Œä¸€èµ·å‡ºæ ˆ</span>
                    <span class="token function">casHead</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> mn<span class="token punctuation">)</span><span class="token punctuation">;</span>          
                <span class="token keyword">else</span>                         
                    h<span class="token punctuation">.</span><span class="token function">casNext</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> mn<span class="token punctuation">)</span><span class="token punctuation">;</span>        
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h2 id="_5-2-blockingdeque" tabindex="-1"><a class="header-anchor" href="#_5-2-blockingdeque" aria-hidden="true">#</a> 5.2 BlockingDeque</h2><p>BlockingDeque å®šä¹‰äº†ä¸€ä¸ªé˜»å¡çš„åŒç«¯é˜Ÿåˆ—æ¥å£ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">putFirst</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">putLast</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token class-name">E</span> <span class="token function">takeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token class-name">E</span> <span class="token function">takeLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æ¥å£åœ¨ç»§æ‰¿äº† BlockingQueue æ¥å£çš„åŒæ—¶ï¼Œå¢åŠ äº†å¯¹åº”çš„åŒç«¯é˜Ÿåˆ—æ“ä½œæ¥å£ã€‚è¯¥æ¥å£åªæœ‰ä¸€ä¸ªå®ç°ï¼Œå°±æ˜¯ LinkedBlockingDequeã€‚</p><p>å…¶æ ¸å¿ƒæ•°æ®ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼Œæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">BlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">E</span> item<span class="token punctuation">;</span>
        <span class="token comment">// åŒå‘é“¾è¡¨çš„ Node</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> prev<span class="token punctuation">;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">;</span>

        <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token class-name">E</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            item <span class="token operator">=</span> x<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// é˜Ÿåˆ—çš„å¤´å’Œå°¾</span>
    <span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> first<span class="token punctuation">;</span>
    <span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> last<span class="token punctuation">;</span>
    <span class="token comment">// å…ƒç´ ä¸ªæ•°</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>
    <span class="token comment">// å®¹é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>
    <span class="token comment">// 1 æŠŠé” + 2 ä¸ªæ¡ä»¶</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notFull <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ... </span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹åº”çš„å®ç°åŸç†ï¼Œå’Œ LinkedBlockingQueue åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯ LinkedBlockingQueue æ˜¯å•å‘é“¾è¡¨ï¼Œè€Œ LinkedBlockingDeque æ˜¯åŒå‘é“¾è¡¨ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">takeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">E</span> x<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token function">unlinkFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            notEmpty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">takeLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">E</span> x<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">=</span> <span class="token function">unlinkLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            notEmpty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putFirst</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">linkFirst</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span>
            notFull<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putLast</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">linkLast</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span>
            notFull<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-3-copyonwrite" tabindex="-1"><a class="header-anchor" href="#_5-3-copyonwrite" aria-hidden="true">#</a> 5.3 CopyOnWrite</h2><p>CopyOnWrite æŒ‡åœ¨ â€œå†™â€ çš„æ—¶å€™ï¼Œä¸æ˜¯ç›´æ¥ â€œå†™â€ æºæ•°æ®ï¼Œè€Œæ˜¯æŠŠæ•°æ®æ‹·è´ä¸€ä»½è¿›è¡Œä¿®æ”¹ï¼Œå†é€šè¿‡æ‚²è§‚é”æˆ–è€…ä¹è§‚é”çš„æ–¹å¼å†™å›ã€‚é‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥ä¿®æ”¹ï¼Œè€Œæ˜¯è¦æ‹·è´ä¸€ä»½ä¿®æ”¹å‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†åœ¨ â€œè¯»â€ çš„æ—¶å€™ä¸åŠ é”ã€‚ä¸‹é¢é€šè¿‡å‡ ä¸ªæ¡ˆä¾‹æ¥å±•ç° CopyOnWrite çš„åº”ç”¨ã€‚</p><h3 id="_5-3-1-copyonwritearraylist" tabindex="-1"><a class="header-anchor" href="#_5-3-1-copyonwritearraylist" aria-hidden="true">#</a> 5.3.1 CopyOnWriteArrayList</h3><p>å’Œ ArrayList ä¸€æ ·ï¼ŒCopyOnWriteArrayList çš„æ ¸å¿ƒæ•°æ®ç»“æ„ä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">RandomAccess</span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">transient</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ˜¯ CopyOnArrayList çš„å‡ ä¸ª â€œè¯»â€ å‡½æ•°ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> array<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">indexOf</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> elements<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">indexOf</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> elements<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token keyword">int</span> fence<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> index<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fence<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>elements<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> index<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fence<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>elements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ—¢ç„¶è¿™äº› â€œè¯»â€ å‡½æ•°éƒ½æ²¡æœ‰åŠ é”ï¼Œé‚£ä¹ˆæ˜¯å¦‚ä½•ä¿è¯ â€œçº¿ç¨‹å®‰å…¨â€ å‘¢ï¼Ÿç­”æ¡ˆåœ¨ â€œå†™â€ å‡½æ•°é‡Œé¢ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    <span class="token comment">// åŠ æ‚²è§‚é”</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token comment">// CopyOnWriteï¼Œå†™çš„æ—¶å€™ï¼Œå…ˆæ‹·è´ä¸€ä»½ä¹‹å‰çš„æ•°ç»„</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newElements <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        newElements<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token comment">// æŠŠæ–°æ•°ç»„èµ‹å€¼ç»™è€æ•°ç»„</span>
        <span class="token function">setArray</span><span class="token punctuation">(</span>newElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶ä»– â€œå†™â€ å‡½æ•°ï¼Œä¾‹å¦‚ remove å’Œ add ç±»ä¼¼ï¼Œæ­¤å¤„ä¸å†è¯¦è¿°ã€‚</p><h3 id="_5-3-2-copyonwritearrayset" tabindex="-1"><a class="header-anchor" href="#_5-3-2-copyonwritearrayset" aria-hidden="true">#</a> 5.3.2 CopyOnWriteArraySet</h3><p>CopyOnWriteArraySet å°±æ˜¯ç”¨ Array å®ç°çš„ä¸€ä¸ª Setï¼Œä¿è¯æ‰€æœ‰å…ƒç´ éƒ½ä¸é‡å¤ã€‚å…¶å†…éƒ¨æ˜¯å°è£…çš„ä¸€ä¸ª CopyOnWriteArrayListã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CopyOnWriteArraySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°è£…çš„ CopyOnWriteArrayList</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> al<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">CopyOnWriteArraySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        al <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸é‡å¤çš„ï¼ŒåŠ è¿›å»</span>
        <span class="token keyword">return</span> al<span class="token punctuation">.</span><span class="token function">addIfAbsent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-4-concurrentlinkedqueue-deque" tabindex="-1"><a class="header-anchor" href="#_5-4-concurrentlinkedqueue-deque" aria-hidden="true">#</a> 5.4 ConcurrentLinkedQueue / Deque</h2><p>å‰é¢è¯¦ç»†åˆ†æäº† AQS å†…éƒ¨çš„é˜»å¡é˜Ÿåˆ—å®ç°åŸç†ï¼šåŸºäºåŒå‘é“¾è¡¨ï¼Œé€šè¿‡å¯¹ head / tail è¿›è¡Œ CAS æ“ä½œï¼Œå®ç°å…¥é˜Ÿå’Œå‡ºé˜Ÿã€‚</p><p>ConcurrentLinkedQueue çš„å®ç°åŸç†å’Œ AQS å†…éƒ¨çš„é˜»å¡é˜Ÿåˆ—ç±»ä¼¼ï¼šåŒæ ·æ˜¯åŸºäº CASï¼ŒåŒæ ·æ˜¯é€šè¿‡ head / tail æŒ‡é’ˆè®°å½•é˜Ÿåˆ—å¤´éƒ¨å’Œå°¾éƒ¨ï¼Œä½†è¿˜æ˜¯æœ‰ç¨è®¸å·®åˆ«ã€‚</p><p>é¦–å…ˆï¼Œå®ƒæ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œå®šä¹‰å¦‚ä¸‹ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">volatile</span> <span class="token class-name">E</span> item<span class="token punctuation">;</span>
        <span class="token keyword">volatile</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> head<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> tail<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶æ¬¡ï¼Œåœ¨ AQS çš„é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œæ¯æ¬¡å…¥é˜Ÿåï¼Œtail ä¸€å®šåç§»ä¸€ä¸ªä½ç½®ï¼›æ¯æ¬¡å‡ºé˜Ÿï¼Œhead ä¸€å®šå‰ç§»ä¸€ä¸ªä½ç½®ï¼Œä»¥ä¿è¯ head æŒ‡å‘é˜Ÿåˆ—å¤´éƒ¨ï¼Œtail æŒ‡å‘é“¾è¡¨å°¾éƒ¨ã€‚</p><p>ä½†åœ¨ ConcurrentLinkedQueue ä¸­ï¼Œhead / tail çš„æ›´æ–°å¯èƒ½è½åäºèŠ‚ç‚¹çš„å…¥é˜Ÿå’Œå‡ºé˜Ÿï¼Œå› ä¸ºå®ƒä¸æ˜¯ç›´æ¥å¯¹ head / tail æŒ‡é’ˆè¿›è¡Œ CAS æ“ä½œçš„ï¼Œè€Œæ˜¯å¯¹ Node ä¸­çš„ item è¿›è¡Œæ“ä½œã€‚ä¸‹é¢è¿›è¡Œè¯¦ç»†åˆ†æï¼š</p><ol><li><p>åˆå§‹åŒ–åˆå§‹çš„æ—¶å€™ï¼Œå¦‚å›¾5-5 æ‰€ç¤ºï¼Œhead å’Œ tail éƒ½æ‰§è¡Œä¸€ä¸ª NULL èŠ‚ç‚¹ã€‚</p><img src="/assets/å›¾5-5.a56cdc1f.jpeg" alt="å›¾5-5" style="zoom:50%;"><p>å›¾5-5 åˆå§‹çŠ¶æ€</p><p>å¯¹åº”çš„ä»£ç å¦‚ä¸‹ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ConcurrentLinkedQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    head <span class="token operator">=</span> tail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>å…¥é˜Ÿåˆ—</p><p>ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">checkNotNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> newNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> t <span class="token operator">=</span> tail<span class="token punctuation">,</span> p <span class="token operator">=</span> t<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> q <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å…³é”®ç‚¹ï¼šæ˜¯å¯¹ tail çš„ next æŒ‡é’ˆè€Œä¸æ˜¯å¯¹ tail æŒ‡é’ˆæ‰§è¡Œ CAS æ“ä½œ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">casNext</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> newNode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ¯å…¥ 2 ä¸ªèŠ‚ç‚¹ï¼Œåç§»ä¸€æ¬¡ tail æŒ‡é’ˆï¼Œå¤±è´¥ä¹Ÿæ²¡æœ‰å…³ç³»</span>
                <span class="token function">casTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> newNode<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> q<span class="token punctuation">)</span>
            <span class="token comment">// å·²ç»åˆ°è¾¾é˜Ÿåˆ—å°¾éƒ¨</span>
            p <span class="token operator">=</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> t <span class="token operator">:</span> head<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token comment">// åç§» p æŒ‡é’ˆ</span>
            p <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> t <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> tail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> t <span class="token operator">:</span> q<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„å…¥é˜Ÿå…¶å®æ˜¯æ¯æ¬¡åœ¨é˜Ÿå°¾è¿½åŠ  2 ä¸ªèŠ‚ç‚¹æ—¶ï¼Œæ‰ç§»åŠ¨ä¸€æ¬¡ tail èŠ‚ç‚¹ï¼Œå…·ä½“è¿‡ç¨‹å¦‚å›¾5-6 æ‰€ç¤ºã€‚</p><img src="/assets/å›¾5-6.b5413daf.jpeg" alt="å›¾5-6" style="zoom:50%;"><p>å›¾5-6 çº¿ç¨‹ 1 å…¥é˜Ÿ item2 èŠ‚ç‚¹</p><p>åˆå§‹çš„æ—¶å€™ï¼Œé˜Ÿåˆ—ä¸­æœ‰ 1 ä¸ªèŠ‚ç‚¹ item1ï¼Œtail æŒ‡å‘è¯¥èŠ‚ç‚¹ï¼Œå‡è®¾çº¿ç¨‹ 1 è¦å…¥é˜Ÿ item2 èŠ‚ç‚¹ï¼š</p><p>step1ï¼šp = tailï¼Œq = p.next = NULLã€‚</p><p>step2ï¼šå¯¹ p çš„ next æ‰§è¡Œ CAS æ“ä½œï¼Œè¿½åŠ  item2ï¼ŒæˆåŠŸä¹‹åï¼Œp = tailã€‚æ‰€ä»¥ä¸Šé¢çš„ casTail å‡½æ•°ä¸ä¼šæ‰§è¡Œï¼Œç›´æ¥è¿”å›ã€‚æ­¤æ—¶ tail æŒ‡é’ˆæ²¡æœ‰å˜åŒ–ã€‚</p><p>ä¹‹åï¼Œå‡è®¾çº¿ç¨‹ 2 è¦å…¥é˜Ÿ item3 èŠ‚ç‚¹ï¼Œå¦‚å›¾5-7 æ‰€ç¤ºã€‚</p><img src="/assets/å›¾5-7.ff921975.jpeg" alt="å›¾5-7" style="zoom:50%;"><p>å›¾5-7 çº¿ç¨‹ 2 å…¥é˜Ÿ item3 èŠ‚ç‚¹</p><p>step3ï¼šp = tailï¼Œq = p.nextã€‚</p><p>step4ï¼šq != NULLï¼Œå› æ­¤ä¸ä¼šå…¥é˜Ÿæ–°èŠ‚ç‚¹ã€‚pï¼Œq éƒ½åç§» 1 ä½ã€‚</p><p>step5ï¼šq = NULLï¼Œå¯¹ p çš„ next æ‰§è¡Œ CAS æ“ä½œï¼Œå…¥é˜Ÿ item3 èŠ‚ç‚¹ã€‚</p><p>step6ï¼šp != tï¼Œæ»¡è¶³æ¡ä»¶ï¼Œæ‰§è¡Œä¸Šé¢çš„ casTail æ“ä½œï¼Œtail åç§» 2 ä¸ªä½ç½®ï¼Œåˆ°è¾¾é˜Ÿåˆ—å°¾éƒ¨ã€‚</p><p>æœ€åæ€»ç»“ä¸€ä¸‹å…¥é˜Ÿåˆ—çš„ä¸¤ä¸ªå…³é”®ç‚¹ï¼š</p><p>ï¼ˆ1ï¼‰å³ä½¿ tail æŒ‡é’ˆæ²¡æœ‰ç§»åŠ¨ï¼Œåªè¦å¯¹ p çš„ next æŒ‡é’ˆæˆåŠŸè¿›è¡Œ CAS æ“ä½œï¼Œå°±ç®—æˆåŠŸå…¥é˜Ÿåˆ—ã€‚</p><p>ï¼ˆ2ï¼‰åªæœ‰å½“ p != tail çš„æ—¶å€™ï¼Œæ‰ä¼šåç§» tail æŒ‡é’ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯è¿ç»­è¿½åŠ  2 ä¸ªèŠ‚ç‚¹ï¼Œæ‰åç§» 1 æ¬¡ tail æŒ‡é’ˆã€‚å³ä½¿ CAS å¤±è´¥ä¹Ÿæ²¡å…³ç³»ï¼Œå¯ä»¥ç”±ä¸‹ 1 ä¸ªçº¿ç¨‹æ¥ç§»åŠ¨ tail æŒ‡é’ˆã€‚</p></li><li><p>å‡ºé˜Ÿåˆ—</p><p>ä¸Šé¢è¯´äº†å…¥é˜Ÿåˆ—ä¹‹åï¼Œtail æŒ‡é’ˆä¸å˜åŒ–ï¼Œé‚£æ˜¯å¦ä¼šå‡ºç°å…¥é˜Ÿåˆ—ä¹‹åï¼Œè¦å‡ºé˜Ÿåˆ—å´æ²¡æœ‰å…ƒç´ å¯å‡ºçš„æƒ…å†µå‘¢ï¼Ÿ</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    restartFromHead<span class="token operator">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> h <span class="token operator">=</span> head<span class="token punctuation">,</span> p <span class="token operator">=</span> h<span class="token punctuation">,</span> q<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">E</span> item <span class="token operator">=</span> p<span class="token punctuation">.</span>item<span class="token punctuation">;</span>
            <span class="token comment">// å…³é”®ç‚¹ï¼šåœ¨å‡ºé˜Ÿåˆ—çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰ç§»åŠ¨ head æŒ‡é’ˆï¼Œè€Œæ˜¯æŠŠ item ç½®ä¸ºäº† NULL</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span><span class="token function">casItem</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ¯äº§ç”Ÿ 2 ä¸ª NULL èŠ‚ç‚¹ï¼Œæ‰æŠŠ head æŒ‡é’ˆåç§» 2 ä½</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> h<span class="token punctuation">)</span>
                    <span class="token function">updateHead</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>q <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> q <span class="token operator">:</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> item<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>q <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">updateHead</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> q<span class="token punctuation">)</span>
                <span class="token keyword">continue</span> restartFromHead<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                p <span class="token operator">=</span> q<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡ºé˜Ÿåˆ—çš„ä»£ç å’Œå…¥é˜Ÿåˆ—ç±»ä¼¼ï¼Œä¹Ÿæœ‰ pã€qï¼Œ2 ä¸ªæŒ‡é’ˆï¼Œæ•´ä¸ªå˜åŒ–è¿‡ç¨‹å¦‚å›¾5-8 æ‰€ç¤ºã€‚å‡è®¾åˆå§‹çš„æ—¶å€™ head æŒ‡å‘ç©ºèŠ‚ç‚¹ï¼Œé˜Ÿåˆ—ä¸­æœ‰ item1ã€item2ã€item3 ä¸‰ä¸ªèŠ‚ç‚¹ã€‚</p><img src="/assets/å›¾5-8.53b589aa.jpeg" alt="å›¾5-8" style="zoom:50%;"><p>å›¾5-8 çº¿ç¨‹ 3 å‡ºé˜Ÿåˆ—çš„è¿‡ç¨‹</p><p>step1ï¼šp = headï¼Œq = p.nextï¼Œp != qã€‚</p><p>step2ï¼šåç§» p æŒ‡é’ˆï¼Œä½¿å¾— p = qã€‚</p><p>step3ï¼šå‡ºé˜Ÿåˆ—ã€‚å…³é”®ç‚¹ï¼šæ­¤å¤„å¹¶æ²¡æœ‰ç›´æ¥åˆ é™¤ item1 èŠ‚ç‚¹ï¼Œåªæ˜¯æŠŠè¯¥èŠ‚ç‚¹çš„ item é€šè¿‡ CAS æ“ä½œç½®ä¸ºäº† NULLã€‚</p><p>step4ï¼šp != headï¼Œæ­¤æ—¶é˜Ÿåˆ—ä¸­æœ‰äº† 2 ä¸ª NULL èŠ‚ç‚¹ï¼Œå†å‰ç§» 1 æ¬¡ head æŒ‡é’ˆï¼Œå¯¹å…¶æ‰§è¡Œ updateHead æ“ä½œã€‚</p><p>æœ€åæ€»ç»“ä¸€ä¸‹å‡ºé˜Ÿåˆ—çš„å…³é”®ç‚¹ï¼š</p><p>ï¼ˆ1ï¼‰å‡ºé˜Ÿåˆ—çš„åˆ¤æ–­å¹¶éè§‚å¯Ÿ tail æŒ‡é’ˆçš„ä½ç½®ï¼Œè€Œæ˜¯ä¾èµ–äº head æŒ‡é’ˆåç»­çš„èŠ‚ç‚¹æ˜¯å¦ä¸º NULL è¿™ä¸€æ¡ä»¶ã€‚</p><p>ï¼ˆ2ï¼‰åªè¦å¯¹èŠ‚ç‚¹çš„ item æ‰§è¡Œ CAS æ“ä½œï¼Œç½®ä¸º NULL æˆåŠŸï¼Œåˆ™å‡ºé˜Ÿåˆ—æˆåŠŸã€‚å³ä½¿ head æŒ‡é’ˆæ²¡æœ‰æˆåŠŸç§»åŠ¨ï¼Œä¹Ÿå¯ä»¥ç”±ä¸‹ 1 ä¸ªçº¿ç¨‹ç»§ç»­å®Œæˆã€‚</p></li><li><p>é˜Ÿåˆ—åˆ¤ç©º</p><p>å› ä¸º head / tail å¹¶ä¸æ˜¯ç²¾ç¡®åœ°æŒ‡å‘é˜Ÿåˆ—å¤´éƒ¨å’Œå°¾éƒ¨ï¼Œæ‰€ä»¥ä¸èƒ½ç®€å•åœ°é€šè¿‡æ¯”è¾ƒ head / tail æŒ‡é’ˆæ¥åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œè€Œæ˜¯éœ€è¦ä» head æŒ‡é’ˆå¼€å§‹éå†ï¼Œæ‰¾ç¬¬ 1 ä¸ªä¸ä¸º NULL çš„èŠ‚ç‚¹ã€‚å¦‚æœæ‰¾åˆ°ï¼Œåˆ™é˜Ÿåˆ—ä¸ä¸ºç©ºï¼›å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™é˜Ÿåˆ—ä¸ºç©ºã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¯»æ‰¾ç¬¬ 1 ä¸ªä¸ä¸º NULL çš„èŠ‚ç‚¹</span>
    <span class="token keyword">return</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ä» head æŒ‡é’ˆå¼€å§‹éå†ï¼Œè·å–ç¬¬ 1 ä¸ªä¸ä¸º NULL çš„èŠ‚ç‚¹</span>
<span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    restartFromHead<span class="token operator">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> h <span class="token operator">=</span> head<span class="token punctuation">,</span> p <span class="token operator">=</span> h<span class="token punctuation">,</span> q<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> hasItem <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>item <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>hasItem <span class="token operator">||</span> <span class="token punctuation">(</span>q <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">updateHead</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> hasItem <span class="token operator">?</span> p <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> q<span class="token punctuation">)</span>
                <span class="token keyword">continue</span> restartFromHead<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                p <span class="token operator">=</span> q<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h2 id="_5-5-concurrenthashmap" tabindex="-1"><a class="header-anchor" href="#_5-5-concurrenthashmap" aria-hidden="true">#</a> 5.5 ConcurrentHashMap</h2><p>HashMap é€šå¸¸çš„å®ç°æ–¹å¼æ˜¯ â€œæ•°ç»„ + é“¾è¡¨â€ï¼Œè¿™ç§æ–¹å¼è¢«ç§°ä¸º â€œæ‹‰é“¾æ³•â€ã€‚ConcurrentHashMap åœ¨è¿™ä¸ªåŸºæœ¬åŸç†ä¹‹ä¸Šè¿›è¡Œäº†å„ç§ä¼˜åŒ–ï¼Œåœ¨ JDK 7 å’Œ JDK 8 ä¸­çš„å®ç°æ–¹å¼æœ‰å¾ˆå¤§å·®å¼‚ï¼Œä¸‹é¢åˆ†å¼€è®¨è®ºã€‚</p><h3 id="_5-5-1-jdk-7-ä¸­çš„å®ç°æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_5-5-1-jdk-7-ä¸­çš„å®ç°æ–¹å¼" aria-hidden="true">#</a> 5.5.1 JDK 7 ä¸­çš„å®ç°æ–¹å¼</h3><p>ä¸ºäº†æé«˜å¹¶å‘åº¦ï¼Œåœ¨ JDK 7 ä¸­ï¼Œä¸€ä¸ª HashMap è¢«æ‹†åˆ†ä¸ºå¤šä¸ªå­ HashMapã€‚æ¯ä¸€ä¸ªå­ HashMap ç§°ä½œä¸€ä¸ª Segmentï¼Œå¤šä¸ªçº¿ç¨‹æ“ä½œå¤šä¸ª Segment ç›¸äº’ç‹¬ç«‹ï¼Œå¦‚å›¾5-9 æ‰€ç¤ºã€‚</p><img src="/assets/å›¾5-9.a5acc8f1.jpeg" alt="å›¾5-9" style="zoom:50%;"><p>å›¾5-9 JDK 7 ä¸­ ConcurrentHashMap æ•°æ®ç»“æ„ç¤ºæ„å›¾</p><p>å…·ä½“æ¥è¯´ï¼Œæ¯ä¸ª Segment éƒ½ç»§æ‰¿è‡ª ReentrantLockï¼ŒSegment çš„æ•°é‡ç­‰äºé”çš„æ•°é‡ï¼Œè¿™äº›é”å½¼æ­¤ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œå³æ‰€è°“çš„ â€œåˆ†æ®µé”â€ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ReentrantLock</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//  ConcurrentHashMap ç”±å¤šä¸ªå­ HashMapï¼ˆSegmentï¼‰ç»„æˆ</span>
    <span class="token keyword">final</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> segments<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥ç”±æ„é€ å‡½æ•°çš„åˆ†æå…¥æ‰‹ï¼Œå‰–æ ConcurrentHashMap çš„å®ç°åŸç†ã€‚</p><ol><li><p>æ„é€ å‡½æ•°åˆ†æ</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">,</span> <span class="token keyword">int</span> concurrencyLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>loadFactor <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> initialCapacity <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> concurrencyLevel <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>concurrencyLevel <span class="token operator">&gt;</span> MAX_SEGMENTS<span class="token punctuation">)</span>
        concurrencyLevel <span class="token operator">=</span> MAX_SEGMENTS<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sshift <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ssize <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¿è¯å¹¶å‘åº¦æ˜¯ 2 çš„æ•´æ•°æ¬¡æ–¹ </span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>ssize <span class="token operator">&lt;</span> concurrencyLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">++</span>sshift<span class="token punctuation">;</span>
        ssize <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>segmentShift <span class="token operator">=</span> <span class="token number">32</span> <span class="token operator">-</span> sshift<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>segmentMask <span class="token operator">=</span> ssize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">&gt;</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span>
        initialCapacity <span class="token operator">=</span> MAXIMUM_CAPACITY<span class="token punctuation">;</span>
    <span class="token comment">// åˆå§‹æ€»å®¹é‡æˆ–æ•°ç»„ä¸ªæ•°ï¼Œæ˜¯æ¯ä¸ª Segment çš„åˆå§‹å¤§å°</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> initialCapacity <span class="token operator">/</span> ssize<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">*</span> ssize <span class="token operator">&lt;</span> initialCapacity<span class="token punctuation">)</span>
        <span class="token operator">++</span>c<span class="token punctuation">;</span>
    <span class="token keyword">int</span> cap <span class="token operator">=</span> MIN_SEGMENT_TABLE_CAPACITY<span class="token punctuation">;</span>
    <span class="token comment">// ä¿è¯æ¯ä¸ª Segment çš„å®¹é‡ï¼Œä¹Ÿæ˜¯ 2 çš„æ•´æ•°æ¬¡æ–¹</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cap <span class="token operator">&lt;</span> c<span class="token punctuation">)</span>
        cap <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// æ„é€ ç¬¬ 0 ä¸ª Segment</span>
    <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> s0 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>loadFactor<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>cap <span class="token operator">*</span> loadFactor<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">HashEntry</span><span class="token punctuation">[</span>cap<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å…³é”®çš„ä¸€å¥ï¼šSegment æ•°ç»„çš„å¤§å°ä¸º ssizeï¼Œä¹Ÿå°±æ˜¯ 2 çš„æ•´æ•°æ¬¡æ–¹</span>
    <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ss <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">Segment</span><span class="token punctuation">[</span>ssize<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// æ•°ç»„çš„ç¬¬ 0 ä¸ªå…ƒç´ èµ‹å€¼ä¸º s0</span>
    UNSAFE<span class="token punctuation">.</span><span class="token function">putOrderedObject</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> SBASE<span class="token punctuation">,</span> s0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>segments <span class="token operator">=</span> ss<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ„é€ å‡½æ•°çš„ç¬¬ 3 ä¸ªå‚æ•° concurrenyLevelï¼Œæ˜¯ â€œå¹¶å‘åº¦â€ï¼Œä¹Ÿå°±æ˜¯ Segment æ•°ç»„çš„å¤§å°ã€‚è¿™ä¸ªå€¼ä¸€æ—¦åœ¨æ„é€ å‡½æ•°ä¸­è®¾å®šï¼Œä¹‹åä¸èƒ½å†æ‰©å®¹ã€‚ä¸ºäº†æå‡ hash çš„è®¡ç®—æ€§èƒ½ï¼Œä¼šä¿è¯æ•°ç»„çš„å¤§å°å§‹ç»ˆæ˜¯ 2 çš„æ•´æ•°æ¬¡æ–¹ã€‚ä¾‹å¦‚è®¾ç½® concurrentyLevel = 9ï¼Œåœ¨æ„é€ å‡½æ•°é‡Œé¢ä¼šæ‰¾åˆ°æ¯” 9 å¤§ä¸”è· 9 æœ€è¿‘çš„ 2 çš„æ•´æ•°æ¬¡æ–¹ï¼Œä¹Ÿå°±æ˜¯ ssize = 16ã€‚å¯¹åº” segmentShiftã€segmentMask ä¸¤ä¸ªå˜é‡ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿è®¡ç®— hash ä½¿ç”¨çš„ã€‚</p><p>åˆå§‹çš„æ—¶å€™ï¼Œå¦‚æœä¸æŒ‡å®šä»»ä½•å‚æ•°ï¼Œå°±ä¼šä½¿ç”¨é»˜è®¤å€¼ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤çš„ Segment æ•°ç»„å¤§å°æ˜¯ 16ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code></code></pre><div class="line-numbers" aria-hidden="true"></div></div></li></ol><p>public ConcurrentHashMap() { this(DEFAULT_INITIAL_CAPACITY, DEFAULT_LOAD_FACTOR, DEFAULT_CONCURRENCY_LEVEL); }</p><p>static final int DEFAULT_INITIAL_CAPACITY = 16; static final float DEFAULT_LOAD_FACTOR = 0.75f; static final int DEFAULT_CONCURRENCY_LEVEL = 16;</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>
ç¬¬ 1 ä¸ªå‚æ•°ï¼ŒinitialCapacity æ˜¯æ•´ä¸ª ConcurrentHashMap çš„åˆå§‹å¤§å°ã€‚ç”¨ initialCapacity é™¤ä»¥ ssizeï¼Œæ˜¯æ¯ä¸ª Segment çš„åˆå§‹å¤§å°ã€‚è¿™é‡Œä¹Ÿä¼šä¿è¯ Segment é‡Œé¢ HashEntry[] æ•°ç»„çš„å¤§å°æ˜¯ 2 çš„æ•´æ•°æ¬¡æ–¹ã€‚

ç¬¬ 2 ä¸ªå‚æ•°ï¼ŒloadFactor å³è´Ÿè½½å› å­ï¼Œä¼ ç»™äº† Segment å†…éƒ¨ã€‚å½“æ¯ä¸ª Segment çš„å…ƒç´ ä¸ªæ•°è¾¾åˆ°ä¸€å®šé˜ˆå€¼ï¼Œè¿›è¡Œ rehashã€‚å¦‚å›¾5-9 æ‰€ç¤ºï¼ŒSegment çš„ä¸ªæ•°ä¸èƒ½æ‰©å®¹ï¼Œä½†æ¯ä¸ª Segment çš„å†…éƒ¨å¯ä»¥æ‰©å®¹ã€‚

2. put(..) å‡½æ•°åˆ†æ

```java
public V put(K key, V value) {
    Segment&lt;K,V&gt; s;
    if (value == null)
        throw new NullPointerException();
    // æŠŠ key æ˜ å°„åˆ°ä¸€ä¸ª 32 ä½æ•´æ•°
    int hash = hash(key);
    // å†æŠŠè¯¥æ•´æ•°æ˜ å°„åˆ°ç¬¬ j ä¸ª Segment
    int j = (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;
    if ((s = (Segment&lt;K,V&gt;)UNSAFE.getObject          
         // Segment[j] == null
         (segments, (j &lt;&lt; SSHIFT) + SBASE)) == null) 
        s = ensureSegment(j);
    //  æ‰¾åˆ°å¯¹åº”çš„ Segment[j]ï¼Œè°ƒç”¨å…¶ put
    return s.put(key, hash, value, false);
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”±äº Segment çš„ä¸ªæ•°æ˜¯ 2 çš„æ•´æ•°æ¬¡æ–¹ï¼Œå‡è®¾å…¶ä¸º 16ï¼Œåˆ™ segmentShift = 32 - sshift = 32 - 4 = 28ï¼ŒsegmentMask = ssize - 1 = 16 - 1 = 15ï¼ˆå‚è§ä¸Šé¢çš„æ„é€ å‡½æ•°ï¼‰ã€‚</p><p>hash å€¼æ˜¯ä¸€ä¸ª 32 ä½çš„æ•´æ•°ï¼Œint j = ( hash &gt;&gt;&gt; segmentShift) &amp; segmentMask è¿™è¡Œä»£ç å°±æ˜¯æŠŠ hash å€¼å³ç§» 28 ä½ï¼Œå†å’Œ 15 è¿›è¡Œä¸æ“ä½œï¼Œè¡¨è¾¾çš„æ„æ€æ˜¯ï¼šä»¥ hash å€¼çš„æœ€é«˜ 4 ä½ä½œä¸ºå¯¹åº”çš„ Segment æ•°ç»„ä¸‹æ ‡ jã€‚</p><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­æ²¡æœ‰åŠ é”æ“ä½œï¼Œå› ä¸ºé”æ˜¯åŠ åœ¨ s.put å†…éƒ¨çš„ï¼Œä¹Ÿå°±æ˜¯åˆ†æ®µåŠ é”ã€‚å¦å¤–ï¼Œå¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶è°ƒç”¨ ensureSegment å¯¹ Segment[j] è¿›è¡Œåˆå§‹åŒ–ï¼Œåœ¨è¿™ä¸ªå‡½æ•°çš„å†…éƒ¨è¦é¿å…é‡å¤åˆå§‹åŒ–ï¼Œä¸‹é¢è¯¦ç»†åˆ†æã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">ensureSegment</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ss <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>segments<span class="token punctuation">;</span>
    <span class="token comment">// ä¸‹æ ‡ k å¯¹åº”çš„å†…å­˜åœ°å€åç§»é‡ä¸º u</span>
    <span class="token keyword">long</span> u <span class="token operator">=</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;&lt;</span> SSHIFT<span class="token punctuation">)</span> <span class="token operator">+</span> SBASE<span class="token punctuation">;</span> 
    <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> seg<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>seg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> UNSAFE<span class="token punctuation">.</span><span class="token function">getObjectVolatile</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä»¥ ss[0] çš„å‚æ•°ä¸ºåŸå‹</span>
        <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> proto <span class="token operator">=</span> ss<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
        <span class="token keyword">int</span> cap <span class="token operator">=</span> proto<span class="token punctuation">.</span>table<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">float</span> lf <span class="token operator">=</span> proto<span class="token punctuation">.</span>loadFactor<span class="token punctuation">;</span>
        <span class="token keyword">int</span> threshold <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>cap <span class="token operator">*</span> lf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">HashEntry</span><span class="token punctuation">[</span>cap<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>seg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> UNSAFE<span class="token punctuation">.</span><span class="token function">getObjectVolatile</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>lf<span class="token punctuation">,</span> threshold<span class="token punctuation">,</span> tab<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>seg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> UNSAFE<span class="token punctuation">.</span><span class="token function">getObjectVolatile</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>UNSAFE<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> u<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> seg <span class="token operator">=</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> seg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯å½“ segments[k] = null æ—¶å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ã€‚ç”±äºå¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶è°ƒç”¨è¯¥å‡½æ•°ï¼ŒUNSAFE.getObjectVolatile(ss, u) == null å‡ºç°äº† 3 æ¬¡ï¼Œåœ¨ 3 ä¸ªä¸åŒçš„æ—¶é—´ç‚¹é‡å¤æ£€æŸ¥ segments[k] == nullã€‚ä½†å³ä½¿å¦‚æ­¤ï¼Œä¹Ÿä¸èƒ½å®Œå…¨ä¿è¯é¿å…é‡å¤åˆå§‹åŒ–ï¼Œæ‰€ä»¥æœ€åéœ€è¦æ‰§è¡Œä¸€ä¸ª CAS æ“ä½œ UNSAFE.compareAndSwapObject(ss, u, null, seg = s) ä¿è¯åªè¢«åˆå§‹åŒ–ä¸€æ¬¡ã€‚ä¿é™©èµ·è§ï¼ŒæŠŠè¿™æ¬¡ CAS æ“ä½œæ”¾åœ¨ä¸€ä¸ª while å¾ªç¯é‡Œï¼Œä¿è¯å‡ºæ¥çš„æ—¶å€™ segments[k] ä¸€å®šä¸ä¸ºç©ºã€‚</p><p>segments[j] è¢«æˆåŠŸåœ°åˆå§‹åŒ–äº†ï¼Œä¸‹é¢è¿›å…¥å†…éƒ¨ï¼Œäº†è§£å¦‚ä½•æŠŠå…ƒç´ æ”¾è¿›å»ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ReentrantLock</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> node <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token function">scanAndLockForPut</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å½“æ‰§è¡Œåˆ°è¿™ä¸ªåœ°æ–¹æ—¶ä¸€å®šæ‹¿åˆ°é”äº†</span>
        <span class="token class-name">V</span> oldValue<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
            <span class="token comment">// å› ä¸º tab.length ä¸º 2 åˆ°æ•´æ•°æ¬¡æ–¹ï¼Œè¿™ä¸ªåœ°æ–¹ç­‰ä»·äº hash å¯¹ tab.length å–æ¨¡</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token punctuation">(</span>tab<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">;</span>
            <span class="token comment">// å®šä½åˆ°ç¬¬ index ä¸ª HashEntry</span>
            <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> first <span class="token operator">=</span> <span class="token function">entryAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> first<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">K</span> k<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
                            <span class="token comment">// ä¿®æ”¹æ¬¡æ•°ç´¯åŠ </span>
                            <span class="token operator">++</span>modCount<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">// key ç›¸ç­‰æˆ–åœ¨ hash å€¼ç›¸ç­‰ï¼Œä¸ä¼šé‡å¤æ’å…¥ï¼Œç›´æ¥è¿”å›</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// éå†é“¾è¡¨</span>
                    e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// å·²ç»éå†åˆ°é“¾è¡¨å°¾éƒ¨ï¼Œæ²¡æœ‰å‘ç°é‡å¤å…ƒç´ </span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// åœ¨ä¸Šé¢çš„ scanAndLockForPut é‡Œé¢ï¼Œå·²ç»å»ºå¥½äº†èŠ‚ç‚¹</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                        <span class="token comment">// æŠŠ node æ’å…¥é“¾è¡¨å¤´éƒ¨</span>
                        node<span class="token punctuation">.</span><span class="token function">setNext</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span>
                        <span class="token comment">// æ–°å»º node æ’å…¥é“¾è¡¨å¤´éƒ¨</span>
                        node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> first<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> c <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;</span> threshold <span class="token operator">&amp;&amp;</span> tab<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span>
                        <span class="token comment">// è¶…å‡ºé˜ˆå€¼ï¼Œæ‰©å®¹</span>
                        <span class="token function">rehash</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span>
                        <span class="token comment">// æŠŠ node èµ‹å€¼ç»™ tab[index]</span>
                        <span class="token function">setEntryAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> index<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">++</span>modCount<span class="token punctuation">;</span>
                    count <span class="token operator">=</span> c<span class="token punctuation">;</span>
                    oldValue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…³äºä¸Šé¢çš„ä»£ç ï¼Œæœ‰å‡ ç‚¹è¯´æ˜ï¼š</p><p>ï¼ˆ1ï¼‰åœ¨ Segment é‡Œé¢æœ‰ 2 ä¸ª count å˜é‡ï¼Œcount ä¸ modCountï¼Œå‰è€…è¡¨ç¤ºå…ƒç´ çš„ä¸ªæ•°ï¼Œåè€…è¡¨ç¤ºä¿®æ”¹çš„æ¬¡æ•°ã€‚å½“å¾… put çš„å…ƒç´ ã€key å€¼æˆ–è€… hash å€¼å’Œé“¾è¡¨ä¸­æŸä¸ªèŠ‚ç‚¹ç›¸ç­‰æ—¶ï¼Œä¸ä¼šé‡å¤æ’å…¥æ–°èŠ‚ç‚¹ã€‚æ­¤æ—¶å†è¿›ä¸€æ­¥åˆ¤æ–­ï¼Œå¦‚æœ onlyIfAbsent = trueï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åšï¼›å¦‚æœ onlyIfAbsent = falseï¼Œåˆ™ä¿®æ”¹è¯¥èŠ‚ç‚¹çš„ valueï¼ŒåŒæ—¶ modCount ç´¯åŠ ä¸€æ¬¡ã€‚</p><p>ï¼ˆ2ï¼‰è¿›å…¥ä¸Šé¢çš„ else åˆ†æ”¯ï¼Œè¯´æ˜å·²ç»éå†åˆ°äº†é“¾è¡¨å°¾éƒ¨ï¼Œå¹¶ä¸”æ²¡æœ‰å‘ç°ä¸ key å€¼æˆ–è€… hash å€¼ç›¸ç­‰çš„èŠ‚ç‚¹ï¼Œæ­¤æ—¶åœ¨é“¾è¡¨å¤´éƒ¨æ’å…¥ 1 ä¸ªæ–°èŠ‚ç‚¹ï¼Œå¹¶æŠŠ table[index] èµ‹å€¼ä¸ºè¯¥èŠ‚ç‚¹ã€‚å› ä¸º first å°±æ˜¯é“¾è¡¨å¤´éƒ¨ï¼Œæ‰€ä»¥ç›´æ¥æŠŠ node çš„ next æŒ‡é’ˆæŒ‡å‘ first å°±å¯ä»¥äº†ã€‚</p><p>ï¼ˆ3ï¼‰åœ¨å‡½æ•°çš„å¼€å§‹ï¼ŒåŠ é”çš„æ—¶å€™ï¼Œè¿›è¡Œäº†ä¸€æ¬¡ä¼˜åŒ–ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> node <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token function">scanAndLockForPut</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¦‚æœ tryLock() æˆåŠŸï¼Œå³æ‹¿åˆ°é”ï¼Œåˆ™è¿›å…¥ä¸‹é¢çš„ä»£ç ï¼›å¦‚æœ tryLock() ä¸æˆåŠŸï¼Œä¹Ÿä¸èƒ½é—²ç€ï¼Œé‚£è¿›å…¥ scanAndLockForPut(key, hash, value) åšä»€ä¹ˆå‘¢ï¼Ÿ</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">scanAndLockForPut</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> hash<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> first <span class="token operator">=</span> <span class="token function">entryForHash</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> first<span class="token punctuation">;</span>
    <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> node <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> retries <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> f<span class="token punctuation">;</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retries <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
                    node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                retries <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
                retries <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è‡ªæ—‹</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>retries <span class="token operator">&gt;</span> MAX_SCAN_RETRIES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// é˜»å¡</span>
            <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>retries <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                 <span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">entryForHash</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e <span class="token operator">=</span> first <span class="token operator">=</span> f<span class="token punctuation">;</span>  
            retries <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„å‡½æ•°çœ‹ä¼¼å¤æ‚ï¼Œå®åˆ™åªæ˜¯åšäº†ä¸¤ä»¶äº‹ï¼šä¸€æ˜¯æ‹¿ä¸åˆ°é”ï¼Œä¸ç«‹å³é˜»å¡ï¼Œè€Œæ˜¯å…ˆè‡ªæ—‹ï¼Œè‹¥è‡ªæ—‹åˆ°ä¸€å®šæ¬¡æ•°ä»æœªæ‹¿åˆ°é”ï¼Œå†è°ƒç”¨ lock() é˜»å¡ï¼›äºŒæ˜¯åœ¨è‡ªæ—‹çš„è¿‡ç¨‹ä¸­éå†äº†é“¾è¡¨ï¼Œè‹¥å‘ç°æ²¡æœ‰é‡å¤çš„èŠ‚ç‚¹ï¼Œåˆ™æå‰æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸ºåé¢å†æ’å…¥èŠ‚çœæ—¶é—´ã€‚</p><ol start="3"><li><p>æ‰©å®¹</p><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­æåˆ°äº†ï¼Œè¶…è¿‡ä¸€å®šçš„é˜ˆå€¼åï¼ŒSegment å†…éƒ¨ä¼šè¿›è¡Œæ‰©å®¹ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">rehash</span><span class="token punctuation">(</span><span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldTable <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> oldCapacity <span class="token operator">=</span> oldTable<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// åœ¨æ—§å®¹é‡çš„åŸºç¡€ä¸Šæ‰©å®¹äºŒå€</span>
    <span class="token keyword">int</span> newCapacity <span class="token operator">=</span> oldCapacity <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
    threshold <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>newCapacity <span class="token operator">*</span> loadFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> newTable <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">HashEntry</span><span class="token punctuation">[</span>newCapacity<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> sizeMask <span class="token operator">=</span> newCapacity <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> oldCapacity <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> oldTable<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> next <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token comment">// å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ä¹‹å‰åœ¨ç¬¬ i ä¸ªä½ç½®ï¼Œé‚£ä¹ˆåœ¨æ–°çš„ hash è¡¨ä¸­ï¼Œä¸€å®šå¤„äº i æˆ–è€… i + oldCapacity ä½ç½®</span>
            <span class="token keyword">int</span> idx <span class="token operator">=</span> e<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> sizeMask<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>    
                newTable<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span> 
                <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> lastRun <span class="token operator">=</span> e<span class="token punctuation">;</span>
                <span class="token keyword">int</span> lastIdx <span class="token operator">=</span> idx<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> last <span class="token operator">=</span> next<span class="token punctuation">;</span>
                     last <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                     last <span class="token operator">=</span> last<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> k <span class="token operator">=</span> last<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> sizeMask<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">!=</span> lastIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// å¯»æ‰¾é“¾è¡¨ä¸­æœ€åä¸€ä¸ª hash å€¼ä¸ç­‰äº lastIdx çš„å…ƒç´ </span>
                        lastIdx <span class="token operator">=</span> k<span class="token punctuation">;</span>
                        lastRun <span class="token operator">=</span> last<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// å…³é”®çš„ä¸€è¡Œï¼šæŠŠåœ¨ lastRun ä¹‹åçš„é“¾è¡¨å…ƒç´ ä¹‹é—´é“¾æ¥åˆ°æ–° hash è¡¨ä¸­çš„ lastIdx ä½ç½®ï¼Œ</span>
                <span class="token comment">// åœ¨ lastRun ä¹‹å‰çš„æ‰€æœ‰é“¾è¡¨å…ƒç´ ï¼Œéœ€è¦åœ¨æ–°çš„ä½ç½®é€ä¸ªæ‹·è´</span>
                newTable<span class="token punctuation">[</span>lastIdx<span class="token punctuation">]</span> <span class="token operator">=</span> lastRun<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> e<span class="token punctuation">;</span> p <span class="token operator">!=</span> lastRun<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">V</span> v <span class="token operator">=</span> p<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
                    <span class="token keyword">int</span> h <span class="token operator">=</span> p<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
                    <span class="token keyword">int</span> k <span class="token operator">=</span> h <span class="token operator">&amp;</span> sizeMask<span class="token punctuation">;</span>
                    <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> n <span class="token operator">=</span> newTable<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    newTable<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> p<span class="token punctuation">.</span>key<span class="token punctuation">,</span> v<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æŠŠæ–°èŠ‚ç‚¹åŠ å…¥æ–°çš„ Hash è¡¨</span>
    <span class="token keyword">int</span> nodeIndex <span class="token operator">=</span> node<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> sizeMask<span class="token punctuation">;</span> 
    node<span class="token punctuation">.</span><span class="token function">setNext</span><span class="token punctuation">(</span>newTable<span class="token punctuation">[</span>nodeIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newTable<span class="token punctuation">[</span>nodeIndex<span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
    table <span class="token operator">=</span> newTable<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…³äºè¯¥æ‰©å®¹å‡½æ•°ï¼Œæœ‰å‡ ç‚¹éœ€è¦è¯´æ˜ï¼š</p><p>ï¼ˆ1ï¼‰å‡½æ•°çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å°†è¦åŠ å…¥çš„æœ€æ–°èŠ‚ç‚¹ã€‚åœ¨æ‰©å®¹å®Œæˆä¹‹åï¼ŒæŠŠè¯¥èŠ‚ç‚¹åŠ å…¥æ–°çš„ Hash è¡¨ã€‚</p><p>ï¼ˆ2ï¼‰æ•´ä¸ªæ•°ç»„çš„é•¿åº¦æ˜¯ 2 çš„æ•´æ•°æ¬¡æ–¹ï¼Œæ¯æ¬¡æŒ‰äºŒå€æ‰©å®¹ï¼Œè€Œ hash å‡½æ•°å°±æ˜¯å¯¹æ•°ç»„é•¿åº¦å–æ¨¡ï¼Œå³ node.hash &amp; sizeMaskã€‚å› æ­¤ï¼Œå¦‚æœå…ƒç´ ä¹‹å‰å¤„äºç¬¬ i ä¸ªä½ç½®ï¼Œå½“å†æ¬¡ hash æ—¶ï¼Œå¿…ç„¶å¤„äºç¬¬ i ä¸ªæˆ–è€…ç¬¬ i + oldCapacity ä¸ªä½ç½®ã€‚</p><p>ï¼ˆ3ï¼‰ä¸Šé¢çš„æ‰©å®¹è¿›è¡Œäº†ä¸€æ¬¡ä¼˜åŒ–ï¼Œå¹¶æ²¡æœ‰å¯¹å…ƒç´ ä¾æ¬¡æ‹·è´ï¼Œè€Œæ˜¯å…ˆæ‰¾åˆ° lastRun ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ for å¾ªç¯ã€‚lastRun åˆ°é“¾è¡¨æœ«å°¾çš„æ‰€æœ‰å…ƒç´ ï¼Œå…¶ hash å€¼æ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥ä¸éœ€è¦ä¾æ¬¡é‡æ–°æ‹·è´ï¼Œåªéœ€æŠŠè¿™éƒ¨åˆ†é“¾è¡¨é“¾æ¥åˆ°æ–°é“¾è¡¨æ‰€å¯¹åº”çš„ä½ç½®å°±å¯ä»¥ï¼Œä¹Ÿå°±æ˜¯ newTable[lastIdx] = lastRunã€‚lastRun ä¹‹å‰çš„å…ƒç´ åˆ™éœ€è¦ä¾æ¬¡æ‹·è´ã€‚</p><p>å› æ­¤ï¼Œå³ä½¿æŠŠä¸€æ®µ for å¾ªç¯å»æ‰ï¼Œæ•´ä¸ªç¨‹åºçš„é€»è¾‘ä»ç„¶æ˜¯æ­£ç¡®çš„ã€‚</p></li><li><p>get å®ç°åˆ†æ</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> s<span class="token punctuation">;</span>
    <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span>
    <span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> u <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">&gt;&gt;&gt;</span> segmentShift<span class="token punctuation">)</span> <span class="token operator">&amp;</span> segmentMask<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> SSHIFT<span class="token punctuation">)</span> <span class="token operator">+</span> SBASE<span class="token punctuation">;</span>
    <span class="token comment">// ç¬¬ä¸€æ¬¡ hash</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> UNSAFE<span class="token punctuation">.</span><span class="token function">getObjectVolatile</span><span class="token punctuation">(</span>segments<span class="token punctuation">,</span> u<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>tab <span class="token operator">=</span> s<span class="token punctuation">.</span>table<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> 
             <span class="token punctuation">(</span><span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> UNSAFE<span class="token punctuation">.</span><span class="token function">getObjectVolatile</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> TSHIFT<span class="token punctuation">)</span> <span class="token operator">+</span> TBASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment">// ç¬¬äºŒæ¬¡ hash</span>
             e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">K</span> k<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>æ•´ä¸ª get è¿‡ç¨‹ä¹Ÿå°±æ˜¯ä¸¤æ¬¡ hashï¼š</p><p>ç¬¬ä¸€æ¬¡ hashï¼Œå‡½æ•°ä¸º (h &gt;&gt;&gt; segmentShift) &amp; segmentMaskï¼Œè®¡ç®—å‡ºæ‰€åœ¨çš„ Segmentï¼›</p><p>ç¬¬äºŒæ¬¡ hashï¼Œå‡½æ•°ä¸º h &amp; (tab.length - 1)ï¼Œå³ h å¯¹æ•°ç»„é•¿åº¦å–æ¨¡ï¼Œæ‰¾åˆ° Segment é‡Œé¢å¯¹åº”çš„ HashEntry æ•°ç»„ä¸‹æ ‡ï¼Œç„¶åéå†è¯¥ä½ç½®çš„é“¾è¡¨ã€‚</p><p>æ•´ä¸ªè¯»çš„è¿‡ç¨‹å®Œå…¨æ²¡æœ‰åŠ é”ï¼Œè€Œæ˜¯ä½¿ç”¨äº† UNSAFE.getObjectVolatile å‡½æ•°ã€‚</p><h3 id="_5-5-2-jdk-8-ä¸­çš„å®ç°æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#_5-5-2-jdk-8-ä¸­çš„å®ç°æ–¹å¼" aria-hidden="true">#</a> 5.5.2 JDK 8 ä¸­çš„å®ç°æ–¹å¼</h3><p>JDK 8 çš„å®ç°æœ‰å¾ˆå¤§å˜åŒ–ï¼Œé¦–å…ˆæ˜¯æ²¡æœ‰äº†åˆ†æ®µé”ï¼Œæ‰€æœ‰æ•°æ®éƒ½æ”¾åœ¨ä¸€ä¸ªå¤§çš„ HashMap ä¸­ï¼›å…¶æ¬¡æ˜¯å¼•å…¥äº†çº¢é»‘æ ‘ï¼Œå…¶åŸç†å¦‚å›¾5-10 æ‰€ç¤ºã€‚</p><img src="/assets/å›¾5-10.be6faaca.jpeg" alt="å›¾5-10" style="zoom:50%;"><p>å›¾5-10 JDK 8 ä¸­ ConcurrentHashMap å®ç°åŸç†ç¤ºæ„å›¾</p><p>å¦‚æœå¤´èŠ‚ç‚¹æ˜¯ Node ç±»å‹ï¼Œåˆ™å°¾éšå®ƒçš„å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„é“¾è¡¨ï¼›å¦‚æœå¤´èŠ‚ç‚¹æ˜¯ TreeNode ç±»å‹ï¼Œå®ƒçš„åé¢å°±æ˜¯ä¸€é¢—çº¢é»‘æ ‘ï¼ŒTreeNode æ˜¯ Node çš„å­ç±»ã€‚</p><p>é“¾è¡¨å’Œçº¢é»‘æ ‘ä¹‹é—´å¯ä»¥ç›¸äº’è½¬æ¢ï¼šåˆå§‹çš„æ—¶å€™æ˜¯é“¾è¡¨ï¼Œå½“é“¾è¡¨ä¸­çš„å…ƒç´ è¶…è¿‡æŸä¸ªé˜ˆå€¼æ—¶ï¼ŒæŠŠé“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘ï¼›åä¹‹ï¼Œå½“çº¢é»‘æ ‘ä¸­çš„å…ƒç´ ä¸ªæ•°å°äºæŸä¸ªé˜ˆå€¼æ—¶ï¼Œå†è½¬æ¢ä¸ºé“¾è¡¨ã€‚</p><p>é‚£ä¸ºä»€ä¹ˆ JDK 8 è¦åšè¿™ç§æ”¹å˜å‘¢ï¼Ÿåœ¨ JDK 7 ä¸­çš„åˆ†æ®µé”ï¼Œæœ‰ä¸‰ä¸ªå¥½å¤„ï¼š</p><ol><li><p>å‡å°‘ Hash å†²çªï¼Œé¿å…ä¸€ä¸ªæ§½é‡Œæœ‰å¤ªå¤šå…ƒç´ ã€‚</p></li><li><p>æé«˜è¯»å’Œå†™çš„å¹¶å‘åº¦ã€‚æ®µä¸æ®µä¹‹é—´ç›¸äº’ç‹¬ç«‹ã€‚</p></li><li><p>æä¾›æ‰©å®¹çš„å¹¶å‘åº¦ã€‚æ‰©å®¹çš„æ—¶å€™ï¼Œä¸æ˜¯æ•´ä¸ª ConcurrentHashMap ä¸€èµ·æ‰©å®¹ï¼Œè€Œæ˜¯æ¯ä¸ª Segment ç‹¬ç«‹æ‰©å®¹ã€‚</p></li></ol><p>é’ˆå¯¹è¿™ä¸‰ä¸ªå¥½å¤„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åœ¨ JDK 8 ä¸­ç›¸åº”çš„å¤„ç†æ–¹å¼ï¼š</p><ol><li><p>ä½¿ç”¨çº¢é»‘æ ‘ï¼Œå½“ä¸€ä¸ªæ§½é‡Œæœ‰å¾ˆå¤šå…ƒç´ æ—¶ï¼Œå…¶æŸ¥è¯¢å’Œæ›´æ–°é€Ÿåº¦ä¼šæ¯”é“¾è¡¨å¿«å¾ˆå¤šï¼ŒHash å†²çªçš„é—®é¢˜ç”±æ­¤å¾—åˆ°è¾ƒå¥½çš„è§£å†³ã€‚</p></li><li><p>åŠ é”çš„ç²’åº¦ï¼Œå¹¶éæ•´ä¸ª ConcurrentHashMapï¼Œè€Œæ˜¯å¯¹æ¯ä¸ªå¤´èŠ‚ç‚¹åˆ†åˆ«åŠ é”ï¼Œå³å¹¶å‘åº¦ï¼Œå°±æ˜¯ Node æ•°ç»„çš„é•¿åº¦ï¼Œåˆå§‹é•¿åº¦ä¸º 16ï¼Œå’Œåœ¨ JDK 7 ä¸­åˆå§‹ Segment çš„ä¸ªæ•°ç›¸åŒã€‚</p></li><li><p>å¹¶å‘æ‰©å®¹ï¼Œè¿™æ˜¯éš¾åº¦æœ€å¤§çš„ã€‚åœ¨ JDK 7 ä¸­ï¼Œä¸€æ—¦ Segment çš„ä¸ªæ•°åœ¨åˆå§‹åŒ–çš„æ—¶å€™ç¡®ç«‹ï¼Œä¸èƒ½å†æ›´æ”¹ï¼Œå¹¶å‘åº¦è¢«å›ºå®šã€‚ä¹‹ååªæ˜¯åœ¨æ¯ä¸ª Segment å†…éƒ¨æ‰©å®¹ï¼Œè¿™æ„å‘³ç€æ¯ä¸ª Segment ç‹¬ç«‹æ‰©å®¹ï¼Œäº’ä¸å½±å“ï¼Œä¸å­˜åœ¨å¹¶å‘æ‰©å®¹çš„é—®é¢˜ã€‚ä½†åœ¨ JDK 8 ä¸­ï¼Œç›¸å½“äºåªæœ‰ 1 ä¸ª Segmentï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¦æ‰©å®¹ Node æ•°ç»„çš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹è¿˜è¦è¯»å†™ï¼Œå› æ­¤å¤„ç†è¿‡ç¨‹å¾ˆå¤æ‚ï¼Œåé¢ä¼šè¯¦ç»†åˆ†æã€‚</p></li></ol><p>ç”±ä¸Šè¿°å¯¹æ¯”å¯ä»¥æ€»ç»“å‡ºæ¥ï¼šJDK 8 çš„å®ç°ä¸€æ–¹é¢é™ä½äº† Hash å†²çªï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæå‡äº†å¹¶å‘åº¦ã€‚</p><p>ä¸‹é¢ä»æ„é€ å‡½æ•°å¼€å§‹ï¼Œä¸€æ­¥æ­¥æ·±å…¥åˆ†æå…¶å®ç°è¿‡ç¨‹ã€‚</p><ol><li><p>æ„é€ å‡½æ•°åˆ†æ</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">(</span><span class="token keyword">int</span> initialCapacity<span class="token punctuation">,</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">,</span> <span class="token keyword">int</span> concurrencyLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>loadFactor <span class="token operator">&gt;</span> <span class="token number">0.0f</span><span class="token punctuation">)</span> <span class="token operator">||</span> initialCapacity <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> concurrencyLevel <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>initialCapacity <span class="token operator">&lt;</span> concurrencyLevel<span class="token punctuation">)</span>    
            initialCapacity <span class="token operator">=</span> concurrencyLevel<span class="token punctuation">;</span>    
        <span class="token keyword">long</span> size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> initialCapacity <span class="token operator">/</span> loadFactor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> cap <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span> <span class="token operator">?</span> MAXIMUM_CAPACITY <span class="token operator">:</span> <span class="token function">tableSizeFor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sizeCtl <span class="token operator">=</span> cap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå˜é‡ cap å°±æ˜¯ Node æ•°ç»„çš„é•¿åº¦ï¼Œä¿æŒä¸º 2 çš„æ•´æ•°æ¬¡æ–¹ã€‚tableSizeFor(..) å‡½æ•°æ˜¯æ ¹æ®ä¼ å…¥çš„åˆå§‹å®¹é‡ï¼Œè®¡ç®—å‡ºä¸€ä¸ªåˆé€‚çš„æ•°ç»„é•¿åº¦ã€‚å…·ä½“è€Œè¨€ï¼š1.5 å€çš„åˆå§‹å®¹é‡ + 1ï¼Œå†å¾€ä¸Šå–æœ€æ¥è¿‘çš„ 2 çš„æ•´æ•°æ¬¡æ–¹ï¼Œä½œä¸ºæ•°ç»„é•¿åº¦ cap çš„åˆå§‹å€¼ã€‚</p><p>è¿™é‡Œçš„ sizeCtlï¼Œå…¶å«ä¹‰æ˜¯ç”¨äºæ§åˆ¶åœ¨åˆå§‹åŒ–æˆ–è€…å¹¶å‘æ‰©å®¹æ—¶å€™çš„çº¿ç¨‹æ•°ï¼Œåªä¸è¿‡å…¶åˆå§‹å€¼è®¾ç½®æˆ capã€‚</p></li><li><p>åˆå§‹åŒ–</p><p>åœ¨ä¸Šé¢çš„æ„é€ å‡½æ•°é‡Œåªè®¡ç®—äº†æ•°ç»„çš„åˆå§‹å¤§å°ï¼Œå¹¶æ²¡æœ‰å¯¹æ•°ç»„è¿›è¡Œåˆå§‹åŒ–ã€‚å½“å¤šä¸ªçº¿ç¨‹éƒ½å¾€é‡Œé¢æ”¾å…¥å…ƒç´ çš„æ—¶å€™ï¼Œå†è¿›è¡Œåˆå§‹åŒ–ã€‚è¿™å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šå¤šä¸ªçº¿ç¨‹é‡å¤åˆå§‹åŒ–ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> <span class="token keyword">int</span> sc<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> tab<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">=</span> sizeCtl<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">// sizeCtl = -1ï¼Œè‡ªæ—‹ç­‰å¾…</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">// å…³é”®ï¼šæŠŠ sizeCtl è®¾ä¸º -1</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> tab<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token punctuation">(</span>sc <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> sc <span class="token operator">:</span> DEFAULT_CAPACITY<span class="token punctuation">;</span>
                    <span class="token comment">// åˆå§‹åŒ–</span>
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    table <span class="token operator">=</span> tab <span class="token operator">=</span> nt<span class="token punctuation">;</span>
                    <span class="token comment">// sizeCtl å¹¶éè¡¨ç¤ºæ•°ç»„é•¿åº¦ï¼Œæ‰€ä»¥åˆå§‹åŒ–æˆåŠŸä¹‹åï¼Œå°±ä¸å†ç­‰äºæ•°ç»„é•¿åº¦ï¼Œ</span>
                    <span class="token comment">// è€Œæ˜¯ n - (n &gt;&gt;&gt; 2) == 0.75nï¼Œè¡¨ç¤ºä¸‹ä¸€æ¬¡æ‰©å®¹çš„é˜ˆå€¼</span>
                    sc <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// æŠŠ sizeCtl å†è®¾å›å»</span>
                sizeCtl <span class="token operator">=</span> sc<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> tab<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå¤šä¸ªçº¿ç¨‹çš„ç«äº‰æ˜¯é€šè¿‡å¯¹ sizeCtl è¿›è¡Œ CAS æ“ä½œå®ç°çš„ã€‚å¦‚æœæŸä¸ªçº¿ç¨‹æˆåŠŸåœ°æŠŠ sizeCtl è®¾ç½®ä¸º -1ï¼Œå®ƒå°±æ‹¥æœ‰äº†åˆå§‹åŒ–çš„æƒåˆ©ï¼Œè¿›å…¥åˆå§‹åŒ–çš„ä»£ç æ¨¡å—ï¼Œç­‰åˆ°åˆå§‹åŒ–å®Œæˆï¼Œå†æŠŠ sizeCtl è®¾ç½®å›å»ï¼›å…¶ä»–çº¿ç¨‹åˆ™ä¸€ç›´æ‰§è¡Œ while å¾ªç¯ï¼Œè‡ªæ—‹ç­‰å¾…ï¼Œç›´åˆ°æ•°ç»„ä¸ä¸º nullï¼Œå³å½“åˆå§‹åŒ–ç»“æŸæ—¶ï¼Œé€€å‡ºæ•´ä¸ªå‡½æ•°ã€‚</p><p>å› ä¸ºåˆå§‹åŒ–çš„å·¥ä½œé‡å¾ˆå°ï¼Œæ‰€ä»¥æ­¤å¤„é€‰æ‹©çš„ç­–ç•¥æ˜¯è®©å…¶ä»–çº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œè€Œæ²¡æœ‰å¸®åŠ©å…¶åˆå§‹åŒ–ã€‚</p></li><li><p>put(..) å®ç°åˆ†æ</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">putVal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">spread</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> f<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fh<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">// åˆ†æ”¯ 1ï¼šæ•´ä¸ªæ•°ç»„åˆå§‹åŒ–</span>
            tab <span class="token operator">=</span> <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// åˆ†æ”¯ 2ï¼šç¬¬ [i] ä¸ªå…ƒç´ åˆå§‹åŒ–</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">casTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>                    
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fh <span class="token operator">=</span> f<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> MOVED<span class="token punctuation">)</span>
            <span class="token comment">// åˆ†æ”¯ 3ï¼šæ‰©å®¹</span>
            tab <span class="token operator">=</span> <span class="token function">helpTransfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// åˆ†æ”¯ 4ï¼šæ”¾å…¥å…ƒç´ </span>
            <span class="token class-name">V</span> oldVal <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// å…³é”®çš„ä¸€å¥ï¼šåŠ é”</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// é“¾è¡¨</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>fh <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        binCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> f<span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">K</span> ek<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>ek <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                oldVal <span class="token operator">=</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>
                                    e<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> pred <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                pred<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// çº¢é»‘æ ‘</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">TreeBin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> p<span class="token punctuation">;</span>
                        binCount <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            oldVal <span class="token operator">=</span> p<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>
                                p<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// å¦‚æœæ˜¯é“¾è¡¨ï¼Œåˆ™ä¸Šé¢çš„ binCount ä¼šä» 1 ä¸€ç›´ç´¯åŠ </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">&gt;=</span> TREEIFY_THRESHOLD<span class="token punctuation">)</span>
                    <span class="token comment">// è¶…å‡ºé˜ˆå€¼ï¼Œè½¬æ¢ä¸ºçº¢é»‘æ ‘</span>
                    <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVal <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> oldVal<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ€»å…ƒç´ ä¸ªæ•°ç´¯åŠ  1</span>
    <span class="token function">addCount</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> binCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ for å¾ªç¯æœ‰ 4 ä¸ªå¤§çš„åˆ†æ”¯ï¼š</p><p>ç¬¬ 1 ä¸ªåˆ†æ”¯ï¼Œæ˜¯æ•´ä¸ªæ•°ç»„çš„åˆå§‹åŒ–ï¼Œå‰é¢å·²è®²ï¼›</p><p>ç¬¬ 2 ä¸ªåˆ†æ”¯ï¼Œæ˜¯æ‰€åœ¨çš„æ§½ä¸ºç©ºï¼Œè¯´æ˜è¯¥å…ƒç´ æ˜¯è¯¥æ§½çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç›´æ¥æ–°å»ºä¸€ä¸ªå¤´èŠ‚ç‚¹ï¼Œç„¶åè¿”å›ï¼›</p><p>ç¬¬ 3 ä¸ªåˆ†æ”¯ï¼Œè¯´æ˜è¯¥æ§½æ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œå¸®åŠ©å…¶æ‰©å®¹ï¼›</p><p>ç¬¬ 4 ä¸ªåˆ†æ”¯ï¼Œå°±æ˜¯æŠŠå…ƒç´ æ”¾å…¥æ§½å†…ã€‚æ§½å†…å¯èƒ½æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€æ£µçº¢é»‘æ ‘ï¼Œé€šè¿‡å¤´èŠ‚ç‚¹çš„ç±»å‹å¯ä»¥åˆ¤æ–­æ˜¯å“ªä¸€ç§ã€‚ç¬¬ 4 ä¸ªåˆ†æ”¯æ˜¯åŒ…è£¹åœ¨ synchronized (f) é‡Œé¢çš„ï¼Œf å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ä½ç½®çš„å¤´èŠ‚ç‚¹ï¼Œæ„å‘³ç€æ¯ä¸ªæ•°ç»„å…ƒç´ æœ‰ä¸€æŠŠé”ï¼Œå¹¶å‘åº¦ç­‰äºæ•°ç»„çš„é•¿åº¦ã€‚</p><p>ä¸Šé¢çš„ binCount è¡¨ç¤ºé“¾è¡¨çš„å…ƒç´ ä¸ªæ•°ï¼Œå½“è¿™ä¸ªæ•°ç›®è¶…è¿‡ TREEIFY_THRESHOLD = 8 æ—¶ï¼ŒæŠŠé“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘ï¼Œä¹Ÿå°±æ˜¯ treeifyBin(tab, i) å‡½æ•°ã€‚ä½†åœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨ï¼Œä¸ä¸€å®šéœ€è¦è¿›è¡Œçº¢é»‘æ ‘è½¬æ¢ï¼Œå¯èƒ½åªåšæ‰©å®¹æ“ä½œï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ä»æ‰©å®¹è®²èµ·ã€‚</p></li><li><p>æ‰©å®¹</p><p>æ‰©å®¹çš„å®ç°æ˜¯æœ€å¤æ‚çš„ï¼Œä¸‹é¢ä» treeifyBin(tab, i) è®²èµ·ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">treeifyBin</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> b<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> sc<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&lt;</span> MIN_TREEIFY_CAPACITY<span class="token punctuation">)</span>
            <span class="token comment">// æ•°ç»„é•¿åº¦å°äºé˜ˆå€¼ 64ï¼Œä¸åšçº¢é»‘æ ‘è½¬æ¢ï¼Œç›´æ¥æ‰©å®¹</span>
            <span class="token function">tryPresize</span><span class="token punctuation">(</span>n <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>hash <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">==</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> hd <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> tl <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> b<span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// éå†é“¾è¡¨ï¼Œæ„å»ºçº¢é»‘æ ‘</span>
                        <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash<span class="token punctuation">,</span> e<span class="token punctuation">.</span>key<span class="token punctuation">,</span> e<span class="token punctuation">.</span>val<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>prev <span class="token operator">=</span> tl<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                            hd <span class="token operator">=</span> p<span class="token punctuation">;</span>
                        <span class="token keyword">else</span>
                            tl<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
                        tl <span class="token operator">=</span> p<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">setTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> index<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>hd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼ŒMIN_TREEIFY_CAPACITY = 64ï¼Œæ„å‘³ç€å½“æ•°ç»„çš„é•¿åº¦æ²¡æœ‰è¶…è¿‡ 64 çš„æ—¶å€™ï¼Œæ•°ç»„çš„æ¯ä¸ªèŠ‚ç‚¹é‡Œéƒ½æ˜¯é“¾è¡¨ï¼Œåªä¼šæ‰©å®¹ï¼Œä¸ä¼šè½¬æ¢æˆçº¢é»‘æ ‘ã€‚åªæœ‰å½“æ•°ç»„é•¿åº¦å¤§äºæˆ–ç­‰äº 64 æ—¶ï¼Œæ‰è€ƒè™‘æŠŠé“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘ã€‚</p><p>åœ¨ tryPresize(int size) å†…éƒ¨è°ƒç”¨äº†ä¸€ä¸ªæ ¸å¿ƒå‡½æ•° transfer(Node&lt;Kï¼ŒV&gt;[] tabï¼ŒNode&lt;Kï¼ŒV&gt;[] nextTab)ï¼Œå…ˆä»è¿™ä¸ªå‡½æ•°çš„åˆ†æè¯´èµ·ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nextTab<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">,</span> stride<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>stride <span class="token operator">=</span> <span class="token punctuation">(</span>NCPU <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">/</span> NCPU <span class="token operator">:</span> n<span class="token punctuation">)</span> <span class="token operator">&lt;</span> MIN_TRANSFER_STRIDE<span class="token punctuation">)</span>
        <span class="token comment">// è®¡ç®—æ­¥é•¿</span>
        stride <span class="token operator">=</span> MIN_TRANSFER_STRIDE<span class="token punctuation">;</span> 
    <span class="token comment">// åˆå§‹åŒ–æ–° HashMap</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextTab <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ‰©å®¹ä¸¤å€</span>
            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>n <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            nextTab <span class="token operator">=</span> nt<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>       
            sizeCtl <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        nextTable <span class="token operator">=</span> nextTab<span class="token punctuation">;</span>
        <span class="token comment">// åˆå§‹çš„ transferIndex ä¸ºæ—§ HashMap çš„æ•°ç»„é•¿åº¦</span>
        transferIndex <span class="token operator">=</span> n<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> nextn <span class="token operator">=</span> nextTab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token class-name">ForwardingNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> fwd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForwardingNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>nextTab<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> finishing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
    <span class="token comment">// è¿™é‡Œçš„ i ä¸ºéå†çš„ä¸‹æ ‡ï¼Œbound ä¸ºéå†çš„è¾¹ç•Œã€‚å¦‚æœæˆåŠŸæ‹¿åˆ°ä¸€ä¸ªä»»åŠ¡ï¼Œåˆ™ i = nextIndex - 1ï¼Œ</span>
    <span class="token comment">// bound = nextIndex - strideï¼›å¦‚æœæ‹¿ä¸åˆ°ä»»åŠ¡ï¼Œåˆ™ i = 0ï¼Œbound = 0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> bound <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> f<span class="token punctuation">;</span> <span class="token keyword">int</span> fh<span class="token punctuation">;</span>
        <span class="token comment">// advance è¡¨ç¤ºåœ¨ä» i = transferIndex - 1 éå†åˆ° bound ä½ç½®çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦ä¸€ç›´ç»§ç»­</span>
        <span class="token comment">// è¿™ä¸ªåœ°æ–¹è¾ƒéš¾ç†è§£ï¼š3 ä¸ªåˆ†æ”¯é‡Œé¢éƒ½æ˜¯ advance = falseï¼Œæ„å‘³ç€è‹¥ 3 ä¸ªåˆ†æ”¯éƒ½ä¸æ‰§è¡Œï¼Œ</span>
        <span class="token comment">// æ‰å¯èƒ½ä¸€ç›´æ‰§è¡Œ while å¾ªç¯ã€‚ç›®çš„åœ¨äºï¼Œå½“å¯¹ transferIndex æ‰§è¡Œ CAS æ“ä½œä¸æˆåŠŸçš„æ—¶å€™ï¼Œ</span>
        <span class="token comment">// éœ€è¦è‡ªæ—‹ï¼Œä»¥æœŸæ‹¿åˆ°ä¸€ä¸ª stride çš„è¿ç§»ä»»åŠ¡</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>advance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> nextIndex<span class="token punctuation">,</span> nextBound<span class="token punctuation">;</span>
            <span class="token comment">// å¯¹æ•°ç»„çš„éå†ï¼Œé€šè¿‡è¿™é‡Œçš„ --i è¿›è¡Œã€‚å¦‚æœæˆåŠŸæ‰§è¡Œäº† --iï¼Œ</span>
            <span class="token comment">// å°±ä¸ç”¨ç»§ç»­ while å¾ªç¯äº†ã€‚å› ä¸ºæ¯æ¬¡ advance åªèƒ½è¿›ä¸€æ­¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>i <span class="token operator">&gt;=</span> bound <span class="token operator">||</span> finishing<span class="token punctuation">)</span>
                advance <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// transferIndex &lt;= 0ï¼Œæ•´ä¸ª HashMap å®Œæˆ</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nextIndex <span class="token operator">=</span> transferIndex<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                advance <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// å¯¹ transferIndex è¿›è¡Œ CAS æ“ä½œï¼Œä¹Ÿå°±æ˜¯ä¸ºå½“å‰çº¿ç¨‹åˆ†é… 1 ä¸ª strideã€‚</span>
            <span class="token comment">// CAS æ“ä½œæˆåŠŸï¼Œçº¿ç¨‹æˆåŠŸæ‹¿åˆ°ä¸€ä¸ª stride è¿ç§»ä»»åŠ¡ï¼›</span>
            <span class="token comment">// CAS æ“ä½œä¸æˆåŠŸï¼Œçº¿ç¨‹æ²¡æŠ¢åˆ°ä»»åŠ¡ï¼Œä¼šç»§ç»­æ‰§è¡Œ while å¾ªç¯ï¼Œè‡ªæ—‹</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> TRANSFERINDEX<span class="token punctuation">,</span> nextIndex<span class="token punctuation">,</span>
                      nextBound <span class="token operator">=</span> <span class="token punctuation">(</span>nextIndex <span class="token operator">&gt;</span> stride <span class="token operator">?</span> nextIndex <span class="token operator">-</span> stride <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                bound <span class="token operator">=</span> nextBound<span class="token punctuation">;</span>
                i <span class="token operator">=</span> nextIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                advance <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// i å·²ç»è¶Šç•Œï¼Œæ•´ä¸ª HashMap å·²ç»éå†å®Œæˆ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">&gt;=</span> n <span class="token operator">||</span> i <span class="token operator">+</span> n <span class="token operator">&gt;=</span> nextn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> sc<span class="token punctuation">;</span>
            <span class="token comment">// finishing è¡¨ç¤ºæ•´ä¸ª HashMap æ‰©å®¹å®Œæˆ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                nextTable <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token comment">// æŠŠ nextTable èµ‹å€¼ç»™å½“å‰ table</span>
                table <span class="token operator">=</span> nextTab<span class="token punctuation">;</span>
                sizeCtl <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc <span class="token operator">=</span> sizeCtl<span class="token punctuation">,</span> sc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">resizeStamp</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> RESIZE_STAMP_SHIFT<span class="token punctuation">)</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                finishing <span class="token operator">=</span> advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                i <span class="token operator">=</span> n<span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// tab[i] è¿ç§»å®Œæ¯•ï¼Œèµ‹å€¼ä¸€ä¸ª ForwardingNode</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            advance <span class="token operator">=</span> <span class="token function">casTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// tab[i]çš„ä½ç½®å·²ç»åœ¨è¿ç§»è¿‡ç¨‹ä¸­</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fh <span class="token operator">=</span> f<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> MOVED<span class="token punctuation">)</span>
            advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
        <span class="token comment">// å¯¹ tab[i] è¿›è¡Œè¿ç§»æ“ä½œï¼Œtab[i] å¯èƒ½æ˜¯ä¸€ä¸ªé“¾è¡¨æˆ–è€…çº¢é»‘æ ‘</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> ln<span class="token punctuation">,</span> hn<span class="token punctuation">;</span>
                    <span class="token comment">// é“¾è¡¨</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>fh <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">int</span> runBit <span class="token operator">=</span> fh <span class="token operator">&amp;</span> n<span class="token punctuation">;</span>
                        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> lastRun <span class="token operator">=</span> f<span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> f<span class="token punctuation">.</span>next<span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">int</span> b <span class="token operator">=</span> p<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> n<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!=</span> runBit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                runBit <span class="token operator">=</span> b<span class="token punctuation">;</span>
                                <span class="token comment">// æ„å‘³ç€åœ¨ lastRun ä¹‹åçš„æ‰€æœ‰å…ƒç´ ï¼Œhash å€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè®°å½•ä¸‹è¿™ä¸ªæœ€åçš„ä½ç½®</span>
                                lastRun <span class="token operator">=</span> p<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>runBit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// ç±»ä¼¼äº JDK 7 çš„é“¾è¡¨è¿ç§»çš„ä¼˜åŒ–åšæ³•</span>
                            ln <span class="token operator">=</span> lastRun<span class="token punctuation">;</span>
                            hn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            hn <span class="token operator">=</span> lastRun<span class="token punctuation">;</span>
                            ln <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> f<span class="token punctuation">;</span> p <span class="token operator">!=</span> lastRun<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">int</span> ph <span class="token operator">=</span> p<span class="token punctuation">.</span>hash<span class="token punctuation">;</span> <span class="token class-name">K</span> pk <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">;</span> <span class="token class-name">V</span> pv <span class="token operator">=</span> p<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ph <span class="token operator">&amp;</span> n<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                                ln <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>ph<span class="token punctuation">,</span> pk<span class="token punctuation">,</span> pv<span class="token punctuation">,</span> ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">else</span>
                                hn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>ph<span class="token punctuation">,</span> pk<span class="token punctuation">,</span> pv<span class="token punctuation">,</span> hn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token function">setTabAt</span><span class="token punctuation">(</span>nextTab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">setTabAt</span><span class="token punctuation">(</span>nextTab<span class="token punctuation">,</span> i <span class="token operator">+</span> n<span class="token punctuation">,</span> hn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">setTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// çº¢é»‘æ ‘ï¼Œè¿ç§»åŠæ³•å’Œé“¾è¡¨ç±»ä¼¼</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">TreeBin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>f<span class="token punctuation">;</span>
                        <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> lo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loTail <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> hi <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> hiTail <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> lc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> hc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> t<span class="token punctuation">.</span>first<span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">int</span> h <span class="token operator">=</span> e<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
                            <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
                                <span class="token punctuation">(</span>h<span class="token punctuation">,</span> e<span class="token punctuation">.</span>key<span class="token punctuation">,</span> e<span class="token punctuation">.</span>val<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">&amp;</span> n<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>prev <span class="token operator">=</span> loTail<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                                    lo <span class="token operator">=</span> p<span class="token punctuation">;</span>
                                <span class="token keyword">else</span>
                                    loTail<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
                                loTail <span class="token operator">=</span> p<span class="token punctuation">;</span>
                                <span class="token operator">++</span>lc<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>prev <span class="token operator">=</span> hiTail<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                                    hi <span class="token operator">=</span> p<span class="token punctuation">;</span>
                                <span class="token keyword">else</span>
                                    hiTail<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
                                hiTail <span class="token operator">=</span> p<span class="token punctuation">;</span>
                                <span class="token operator">++</span>hc<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        ln <span class="token operator">=</span> <span class="token punctuation">(</span>lc <span class="token operator">&lt;=</span> UNTREEIFY_THRESHOLD<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">untreeify</span><span class="token punctuation">(</span>lo<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>hc <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>lo<span class="token punctuation">)</span> <span class="token operator">:</span> t<span class="token punctuation">;</span>
                        hn <span class="token operator">=</span> <span class="token punctuation">(</span>hc <span class="token operator">&lt;=</span> UNTREEIFY_THRESHOLD<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">untreeify</span><span class="token punctuation">(</span>hi<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>lc <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>hi<span class="token punctuation">)</span> <span class="token operator">:</span> t<span class="token punctuation">;</span>
                        <span class="token function">setTabAt</span><span class="token punctuation">(</span>nextTab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">setTabAt</span><span class="token punctuation">(</span>nextTab<span class="token punctuation">,</span> i <span class="token operator">+</span> n<span class="token punctuation">,</span> hn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">setTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥å‡½æ•°éå¸¸å¤æ‚ï¼Œä¸‹é¢ä¸€æ­¥æ­¥åˆ†æï¼š</p><p>ï¼ˆ1ï¼‰æ‰©å®¹çš„åŸºæœ¬åŸç†å¦‚å›¾5-11 æ‰€ç¤ºï¼Œé¦–å…ˆå»ºä¸€ä¸ªæ–°çš„ HashMapï¼Œå…¶æ•°ç»„é•¿åº¦æ˜¯æ—§æ•°ç»„é•¿åº¦çš„ 2 å€ï¼Œç„¶åæŠŠæ—§çš„å…ƒç´ é€ä¸ªè¿ç§»è¿‡æ¥ã€‚æ‰€ä»¥ï¼Œä¸Šé¢çš„å‡½æ•°å‚æ•°æœ‰ 2 ä¸ªï¼Œç¬¬ 1 ä¸ªå‚æ•° tab æ˜¯æ‰©å®¹ä¹‹å‰çš„ HashMapï¼Œç¬¬ 2 ä¸ªå‚æ•° nextTab æ˜¯æ‰©å®¹ä¹‹åçš„ HashMapã€‚å½“ nextTab = null çš„æ—¶å€™ï¼Œå‡½æ•°æœ€åˆä¼šå¯¹ nextTab è¿›è¡Œåˆå§‹åŒ–ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå…³é”®ç‚¹è¦è¯´æ˜ï¼šè¯¥å‡½æ•°ä¼šè¢«å¤šä¸ªçº¿ç¨‹è°ƒç”¨ï¼Œæ‰€ä»¥æ¯ä¸ªçº¿ç¨‹åªæ˜¯æ‰©å®¹æ—§çš„ HashMap éƒ¨åˆ†ï¼Œè¿™å°±æ¶‰åŠå¦‚ä½•åˆ’åˆ†ä»»åŠ¡çš„é—®é¢˜ã€‚</p><img src="/assets/å›¾5-11.dc2f91c7.jpeg" alt="å›¾5-11" style="zoom:50%;"><p>å›¾5-11 æ‰©å®¹çš„åŸºæœ¬åŸç†</p><p>ï¼ˆ2ï¼‰å›¾5-12 æ‰€ç¤ºä¸ºå¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰©å®¹-ä»»åŠ¡åˆ’åˆ†ç¤ºæ„å›¾ã€‚æ—§æ•°ç»„çš„é•¿åº¦æ˜¯ Nï¼Œæ¯ä¸ªçº¿ç¨‹æ‰©å®¹ä¸€æ®µï¼Œä¸€æ®µçš„é•¿åº¦ç”¨å˜é‡ strideï¼ˆæ­¥é•¿ï¼‰æ¥è¡¨ç¤ºï¼ŒtransferIndex è¡¨ç¤ºäº†æ•´ä¸ªæ•°ç»„æ‰©å®¹çš„è¿›åº¦ã€‚</p><img src="/assets/å›¾5-12.5d108f3e.jpeg" alt="å›¾5-12" style="zoom:50%;"><p>å›¾5-12 å¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰©å®¹-ä»»åŠ¡åˆ’åˆ†ç¤ºæ„å›¾</p><p>stride çš„è®¡ç®—å…¬å¼å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œå³ï¼šåœ¨å•æ ¸æ¨¡å¼ä¸‹ç›´æ¥ç­‰äº nï¼Œå› ä¸ºåœ¨å•æ ¸æ¨¡å¼ä¸‹æ²¡æœ‰åŠæ³•å¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰©å®¹ï¼Œåªéœ€è¦ 1 ä¸ªçº¿ç¨‹æ¥æ‰©å®¹æ•´ä¸ªæ•°ç»„ï¼›ä½†åœ¨å¤šæ ¸æ¨¡å¼ä¸‹ä¸º (n &gt;&gt;&gt; 3) / NCPUï¼Œå¹¶ä¸”ä¿è¯æ­¥é•¿çš„æœ€å°å€¼æ˜¯ 16ã€‚æ˜¾ç„¶ï¼Œéœ€è¦çš„çº¿ç¨‹ä¸ªæ•°çº¦ä¸º n / strideã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>stride <span class="token operator">=</span> <span class="token punctuation">(</span>NCPU <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">/</span> NCPU <span class="token operator">:</span> n<span class="token punctuation">)</span> <span class="token operator">&lt;</span> MIN_TRANSFER_STRIDE<span class="token punctuation">)</span>
        stride <span class="token operator">=</span> MIN_TRANSFER_STRIDE<span class="token punctuation">;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>transferIndex æ˜¯ ConcurrentHashMap çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œè®°å½•äº†æ‰©å®¹çš„è¿›åº¦ã€‚åˆå§‹å€¼ä¸º nï¼Œä»å¤§åˆ°å°æ‰©å®¹ï¼Œæ¯æ¬¡å‡ stride ä¸ªä½ç½®ï¼Œæœ€ç»ˆå‡è‡³ n&lt;= 0ï¼Œè¡¨ç¤ºæ•´ä¸ªæ‰©å®¹å®Œæˆã€‚å› æ­¤ï¼Œä» [0, transferIndex - 1] çš„ä½ç½®è¡¨ç¤ºè¿˜æ²¡æœ‰åˆ†é…åˆ°çº¿ç¨‹æ‰©å®¹çš„éƒ¨åˆ†ï¼Œä» [transfexIndex, n - 1] çš„ä½ç½®è¡¨ç¤ºå·²ç»åˆ†é…ç»™æŸä¸ªçº¿ç¨‹è¿›è¡Œæ‰©å®¹ï¼Œå½“å‰æ­£åœ¨æ‰©å®¹ä¸­ï¼Œæˆ–è€…å·²ç»æ‰©å®¹æˆåŠŸã€‚</p><p>å› ä¸º transferIndex ä¼šè¢«å¤šä¸ªçº¿ç¨‹å¹¶å‘ä¿®æ”¹ï¼Œæ¯æ¬¡å‡ strideï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ CAS è¿›è¡Œæ“ä½œï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span>compareAndSwapInt <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> TRANSFERINDEX<span class="token punctuation">,</span> nextIndex<span class="token punctuation">,</span> nextBound <span class="token operator">=</span> <span class="token punctuation">(</span>nextIndex <span class="token operator">&gt;</span> stride <span class="token operator">?</span> nextIndex <span class="token operator">-</span> stride <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ï¼ˆ3ï¼‰åœ¨æ‰©å®¹æœªå®Œæˆä¹‹å‰ï¼Œæœ‰çš„æ•°ç»„ä¸‹æ ‡å¯¹åº”çš„æ§½å·²ç»è¿ç§»åˆ°äº†æ–°çš„ HashMap é‡Œé¢ï¼Œæœ‰çš„è¿˜åœ¨æ—§çš„ HashMap é‡Œé¢ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæ‰€æœ‰è°ƒç”¨ get(k, v) çš„çº¿ç¨‹è¿˜æ˜¯ä¼šè®¿é—®æ—§ HashMapï¼Œæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿå›¾5-13 æ‰€ç¤ºä¸ºæ‰©å®¹è¿‡ç¨‹ä¸­çš„è½¬å‘ç¤ºæ„å›¾ï¼šå½“ Node[0] å·²ç»è¿ç§»æˆåŠŸï¼Œè€Œå…¶ä»– Node è¿˜åœ¨è¿ç§»è¿‡ç¨‹ä¸­æ—¶ï¼Œå¦‚æœæœ‰çº¿ç¨‹è¦è¯»å– Node[0] çš„æ•°æ®ï¼Œå°±ä¼šè®¿é—®å¤±è´¥ã€‚ä¸ºæ­¤ï¼Œæ–°å»ºä¸€ä¸ª ForwardingNodeï¼Œå³è½¬å‘èŠ‚ç‚¹ï¼Œåœ¨è¿™ä¸ªèŠ‚ç‚¹é‡Œé¢è®°å½•çš„æ˜¯æ–°çš„ ConcurrentHashMap çš„å¼•ç”¨ã€‚è¿™æ ·ï¼Œå½“çº¿ç¨‹è®¿é—®åˆ° ForwardingNode ä¹‹åï¼Œä¼šå»æŸ¥è¯¢æ–°çš„ ConcurrentHashMapã€‚</p><img src="/assets/å›¾5-13.527d4f44.jpeg" alt="å›¾5-13" style="zoom:50%;"><p>å›¾5-13 æ‰©å®¹è¿‡ç¨‹ä¸­çš„è½¬å‘ç¤ºæ„å›¾</p><p>ï¼ˆ4ï¼‰å› ä¸ºæ•°ç»„çš„é•¿åº¦ tab.length æ˜¯ 2 çš„æ•´æ•°æ¬¡æ–¹ï¼Œæ¯æ¬¡æ‰©å®¹åˆæ˜¯ 2 å€ã€‚è€Œ Hash å‡½æ•°æ˜¯ hashCode % tab.lengthï¼Œç­‰ä»·äº hashCode &amp; (tab.length - 1)ã€‚è¿™æ„å‘³ç€ï¼šå¤„äºç¬¬ i ä¸ªä½ç½®çš„å…ƒç´ ï¼Œåœ¨æ–°çš„ Hash è¡¨çš„æ•°ç»„ä¸­ä¸€å®šå¤„äºç¬¬ i ä¸ªæˆ–è€…ç¬¬ i + n ä¸ªä½ç½®ï¼Œå¦‚å›¾5-11 æ‰€ç¤ºã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼šå‡è®¾æ•°ç»„é•¿åº¦æ˜¯ 8ï¼Œæ‰©å®¹ä¹‹åæ˜¯ 16ï¼š</p><p>è‹¥ hashCode = 5ï¼Œ5 % 8 = 0ï¼Œæ‰©å®¹åï¼Œ5 % 16 = 0ï¼Œä½ç½®ä¿æŒä¸å˜ï¼›</p><p>è‹¥ hashCode = 24ï¼Œ24 % 8= 0ï¼Œæ‰©å®¹åï¼Œ24 % 16 = 8ï¼Œåç§» 8 ä¸ªä½ç½®ï¼›</p><p>è‹¥ hashCode = 25ï¼Œ25 % 8= 1ï¼Œæ‰©å®¹åï¼Œ25 % 16 = 9ï¼Œåç§» 8 ä¸ªä½ç½®ï¼›</p><p>è‹¥ hashCode = 39ï¼Œ39 % 8= 7ï¼Œæ‰©å®¹åï¼Œ39 % 8 = 7ï¼Œä½ç½®ä¿æŒä¸å˜ï¼›</p><p>â€¦â€¦</p><p>æ­£å› ä¸ºæœ‰è¿™æ ·çš„è§„å¾‹ï¼Œæ‰€ä»¥å¦‚ä¸‹æœ‰ä»£ç ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token function">setTabAt</span><span class="token punctuation">(</span>nextTab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTabAt</span><span class="token punctuation">(</span>nextTab<span class="token punctuation">,</span> i <span class="token operator">+</span> n<span class="token punctuation">,</span> hn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¹Ÿå°±æ˜¯æŠŠ tab[i] ä½ç½®çš„é“¾è¡¨æˆ–çº¢é»‘æ ‘é‡æ–°ç»„è£…æˆä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†é“¾æ¥åˆ° nextTab[i] çš„ä½ç½®ï¼Œä¸€éƒ¨åˆ†é“¾æ¥åˆ° nextTab[i + n] çš„ä½ç½®ï¼Œå¦‚å›¾5-11 æ‰€ç¤ºã€‚ç„¶åæŠŠ tab[i] çš„ä½ç½®æŒ‡å‘ä¸€ä¸ª ForwardingNode èŠ‚ç‚¹ã€‚</p><p>åŒæ—¶ï¼Œå½“ tab[i] åé¢æ˜¯é“¾è¡¨æ—¶ï¼Œä½¿ç”¨ç±»ä¼¼äº JDK 7 ä¸­åœ¨æ‰©å®¹æ—¶çš„ä¼˜åŒ–æ–¹æ³•ï¼Œä» lastRun å¾€åçš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œä¸éœ€ä¾æ¬¡æ‹·è´ï¼Œè€Œæ˜¯ç›´æ¥é“¾æ¥åˆ°æ–°çš„é“¾è¡¨å¤´éƒ¨ã€‚ä» lastRun å¾€å‰çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œéœ€è¦ä¾æ¬¡æ‹·è´ã€‚</p><p>äº†è§£äº†æ ¸å¿ƒçš„è¿ç§»å‡½æ•° transfer(tab, nextTab)ï¼Œå†å›å¤´çœ‹ tryPresize(int size) å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„è¾“å…¥æ˜¯æ•´ä¸ª Hash è¡¨çš„å…ƒç´ ä¸ªæ•°ï¼Œåœ¨å‡½æ•°é‡Œé¢ï¼Œæ ¹æ®éœ€è¦å¯¹æ•´ä¸ª Hash è¡¨è¿›è¡Œæ‰©å®¹ã€‚æƒ³è¦çœ‹æ˜ç™½è¿™ä¸ªå‡½æ•°ï¼Œéœ€è¦é€å½»åœ°ç†è§£ sizeCtl å˜é‡ï¼Œä¸‹é¢è¿™æ®µæ³¨é‡Šæ‘˜è‡ªæºç ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * Table initialization and resizing control. When negative, the
 * table is being initialized or resized: -1 for initialization,
 * else -(1 + the number of active resizing threads). Otherwise,
 * when table is null, holds the initial table size to use upon
 * creation, or 0 for default. After initialization, holds the
 * next element count value upon which to resize the table.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> sizeCtl<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ sizeCtl = -1 æ—¶ï¼Œè¡¨ç¤ºæ•´ä¸ª HashMap æ­£åœ¨åˆå§‹åŒ–ï¼›</p><p>å½“ sizeCtl = æŸä¸ªå…¶ä»–è´Ÿæ•°æ—¶ï¼Œè¡¨ç¤ºå¤šä¸ªçº¿ç¨‹åœ¨å¯¹ HashMap åšå¹¶å‘æ‰©å®¹ï¼›</p><p>å½“ sizeCtl = cap æ—¶ï¼Œtab = nullï¼Œè¡¨ç¤ºæœªåˆå§‹ä¹‹å‰çš„åˆå§‹å®¹é‡ï¼ˆå¦‚ä¸Šé¢çš„æ„é€ å‡½æ•°æ‰€ç¤ºï¼‰ï¼›</p><p>æ‰©å®¹æˆåŠŸä¹‹åï¼ŒsizeCtl å­˜å‚¨çš„æ˜¯ä¸‹ä¸€æ¬¡è¦æ‰©å®¹çš„é˜ˆå€¼ï¼Œå³ä¸Šé¢åˆå§‹åŒ–ä»£ç ä¸­çš„ n - (n &gt;&gt;&gt; 2) = 0.75nã€‚</p><p>æ‰€ä»¥ï¼ŒsizeCtl å˜é‡åœ¨ Hash è¡¨å¤„äºä¸åŒçŠ¶æ€æ—¶ï¼Œè¡¨è¾¾ä¸åŒçš„å«ä¹‰ã€‚æ˜ç™½äº†è¿™ä¸ªé“ç†ï¼Œå†æ¥çœ‹ä¸Šé¢çš„ tryPresize(int size) å‡½æ•°ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">tryPresize</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>MAXIMUM_CAPACITY <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> MAXIMUM_CAPACITY <span class="token operator">:</span>
    <span class="token comment">// æ ¹æ®å…ƒç´ ä¸ªæ•°è®¡ç®—æ•°ç»„å¤§å°</span>
    <span class="token function">tableSizeFor</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> sc<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">=</span> sizeCtl<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">;</span>
        <span class="token comment">// Hash è¡¨åˆå§‹åŒ–ï¼Œå’Œä¸Šé¢åˆå§‹åŒ–çš„æ—¶å€™ä¸€æ ·</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            n <span class="token operator">=</span> <span class="token punctuation">(</span>sc <span class="token operator">&gt;</span> c<span class="token punctuation">)</span> <span class="token operator">?</span> sc <span class="token operator">:</span> c<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>table <span class="token operator">==</span> tab<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
                        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        table <span class="token operator">=</span> nt<span class="token punctuation">;</span>
                        <span class="token comment">// å³ n - n / 4 = 0.75nï¼Œä¸‹ä¸€æ¬¡æ‰©å®¹çš„é˜ˆå€¼</span>
                        sc <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    sizeCtl <span class="token operator">=</span> sc<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;=</span> sc <span class="token operator">||</span> n <span class="token operator">&gt;=</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> table<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">resizeStamp</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// sc &lt; 0ï¼Œè¯´æ˜å¤šä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œå¹¶å‘æ‰©å®¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nt<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">&gt;&gt;&gt;</span> RESIZE_STAMP_SHIFT<span class="token punctuation">)</span> <span class="token operator">!=</span> rs <span class="token operator">||</span> sc <span class="token operator">==</span> rs <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">||</span>
                    sc <span class="token operator">==</span> rs <span class="token operator">+</span> MAX_RESIZERS <span class="token operator">||</span> <span class="token punctuation">(</span>nt <span class="token operator">=</span> nextTable<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
                    <span class="token comment">// æ‰©å®¹ç»“æŸ</span>
                    transferIndex <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> sc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment">// å¸®ç€æ‰©å®¹</span>
                    <span class="token function">transfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> nt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> <span class="token punctuation">(</span>rs <span class="token operator">&lt;&lt;</span> RESIZE_STAMP_SHIFT<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// ç¬¬ä¸€æ¬¡æ‰©å®¹</span>
                <span class="token function">transfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>tryPresize(int size) æ˜¯æ ¹æ®æœŸæœ›çš„å…ƒç´ ä¸ªæ•°å¯¹æ•´ä¸ª Hash è¡¨è¿›è¡Œæ‰©å®¹ï¼Œæ ¸å¿ƒæ˜¯è°ƒç”¨ transfer å‡½æ•°ã€‚åœ¨ç¬¬ä¸€æ¬¡æ‰©å®¹çš„æ—¶å€™ï¼ŒsizeCtl ä¼šè¢«è®¾ç½®æˆä¸€ä¸ªå¾ˆå¤§çš„è´Ÿæ•° U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2)ï¼›ä¹‹åæ¯ä¸€ä¸ªçº¿ç¨‹æ‰©å®¹çš„æ—¶å€™ï¼ŒsizeCtl å°±åŠ  1ï¼ŒU.compareAndSwapInt(this, SIZECTL, sc, sc + 1)ï¼Œå¾…æ‰©å®¹å®Œæˆä¹‹åï¼ŒsizeCtl å‡ 1ã€‚</p></li></ol><h2 id="_5-6-concurrentskiplistmap-set" tabindex="-1"><a class="header-anchor" href="#_5-6-concurrentskiplistmap-set" aria-hidden="true">#</a> 5.6 ConcurrentSkipListMap / Set</h2><p>ConcurrentHashMap æ˜¯ä¸€ç§ key æ— åºçš„ HashMapï¼ŒConcurrentSkipListMap åˆ™æ˜¯ key æœ‰åºçš„ï¼Œå®ç°äº† NavigableMap æ¥å£ï¼Œæ­¤æ¥å£åˆç»§æ‰¿äº† SortedMap æ¥å£ã€‚</p><h3 id="_5-6-1-concurrentskiplistmap" tabindex="-1"><a class="header-anchor" href="#_5-6-1-concurrentskiplistmap" aria-hidden="true">#</a> 5.6.1 ConcurrentSkipListMap</h3><ol><li><p>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ SkipList å®ç° Mapï¼Ÿ</p><p>åœ¨ Java çš„ util åŒ…ä¸­ï¼Œæœ‰ä¸€ä¸ªéçº¿ç¨‹å®‰å…¨çš„ HashMapï¼Œä¹Ÿå°±æ˜¯ TreeMapï¼Œæ˜¯ key æœ‰åºçš„ï¼ŒåŸºäºçº¢é»‘æ ‘å®ç°ã€‚</p><p>è€Œåœ¨ Concurrent åŒ…ä¸­ï¼Œæä¾›çš„ key æœ‰åºçš„ HashMapï¼Œä¹Ÿå°±æ˜¯ ConcurrentSkipListMapï¼Œæ˜¯åŸºäº SkipListï¼ˆè·³æŸ¥è¡¨ï¼‰æ¥å®ç°çš„ã€‚è¿™é‡Œä¸ºä»€ä¹ˆä¸ç”¨çº¢é»‘æ ‘ï¼Œè€Œç”¨è·³æŸ¥è¡¨æ¥å®ç°å‘¢ï¼Ÿå€Ÿç”¨ Doug Lea çš„åŸè¯ï¼š</p><blockquote><p>The reason is that there are no known efficient lock-free insertion and deletion algorithms for search trees.</p></blockquote><p>ä¹Ÿå°±æ˜¯ç›®å‰è®¡ç®—æœºé¢†åŸŸè¿˜æœªæ‰¾åˆ°ä¸€ç§é«˜æ•ˆçš„ã€ä½œç”¨åœ¨æ ‘ä¸Šçš„ã€æ— é”çš„ã€å¢åŠ å’Œåˆ é™¤èŠ‚ç‚¹çš„åŠæ³•ã€‚</p><p>é‚£ä¸ºä»€ä¹ˆ SkipList å¯ä»¥æ— é”åœ°å®ç°èŠ‚ç‚¹çš„å¢åŠ ã€åˆ é™¤å‘¢ï¼Ÿè¿™è¦ä»æ— é”é“¾è¡¨çš„å®ç°è¯´èµ·ã€‚</p></li><li><p>æ— é”é“¾è¡¨ Doug Lea åœ¨æ³¨é‡Šä¸­å¼•ç”¨äº†ä¸€ç¯‡æ— é”é“¾è¡¨çš„è®ºæ–‡ï¼šA pragmatic implementation of non-blocking linked listsã€‚</p><p>è¡¨é¢ä¸Šçœ‹ï¼Œæ— é”é“¾è¡¨æ˜¯å¾ˆç®€å•çš„ï¼Œæ ¹æœ¬ä¸éœ€è¦å†™ä¸€ç¯‡è®ºæ–‡æ¥ä¸“é—¨è®ºè¿°ã€‚åœ¨ä¸Šæ–‡ä¸­è®²è§£ AQS æ—¶ï¼Œæ›¾åå¤ç”¨åˆ°æ— é”é˜Ÿåˆ—ï¼Œå…¶å®ç°ä¹Ÿæ˜¯é“¾è¡¨ã€‚ç©¶ç«ŸäºŒè€…çš„åŒºåˆ«åœ¨å“ªå‘¢ï¼Ÿ</p><p>ä¸Šæ–‡æ‰€è®²çš„æ— é”é˜Ÿåˆ—ã€æ ˆï¼Œéƒ½æ˜¯åªåœ¨é˜Ÿå¤´ã€é˜Ÿå°¾è¿›è¡Œ CAS æ“ä½œï¼Œé€šå¸¸ä¸ä¼šæœ‰é—®é¢˜ã€‚å¦‚æœåœ¨é“¾è¡¨çš„ä¸­é—´è¿›è¡Œæ’å…¥æˆ–åˆ é™¤æ“ä½œï¼ŒæŒ‰ç…§é€šå¸¸çš„ CAS åšæ³•ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ï¼</p><p>å…³äºè¿™ä¸ªé—®é¢˜ï¼ŒDoug Lea çš„è®ºæ–‡ä¸­æœ‰æ¸…æ™°çš„è®ºè¿°ï¼Œæ­¤å¤„å¼•ç”¨å¦‚ä¸‹ï¼š</p><p>æ“ä½œ 1ï¼šåœ¨èŠ‚ç‚¹ 10 åé¢æ’å…¥èŠ‚ç‚¹ 20ã€‚å¦‚å›¾5-14 æ‰€ç¤ºï¼Œé¦–å…ˆæŠŠèŠ‚ç‚¹ 20 çš„ next æŒ‡é’ˆæŒ‡å‘èŠ‚ç‚¹ 30ï¼Œç„¶åå¯¹èŠ‚ç‚¹ 10 çš„ next æŒ‡é’ˆæ‰§è¡Œ CAS æ“ä½œï¼Œä½¿å…¶æŒ‡å‘èŠ‚ç‚¹ 20 å³å¯ã€‚</p><img src="/assets/å›¾5-14.b52f891d.jpeg" alt="å›¾5-14" style="zoom:50%;"><p>å›¾5-14 åœ¨èŠ‚ç‚¹ 10 å’ŒèŠ‚ç‚¹ 30 ä¹‹é—´æ’å…¥èŠ‚ç‚¹ 20</p><p>æ“ä½œ 2ï¼šåˆ é™¤èŠ‚ç‚¹ 10ã€‚å¦‚å›¾5-15 æ‰€ç¤ºï¼Œåªéœ€æŠŠå¤´èŠ‚ç‚¹çš„ next æŒ‡é’ˆï¼Œè¿›è¡Œ CAS æ“ä½œåˆ°èŠ‚ç‚¹ 30 å³å¯ã€‚</p><img src="/assets/å›¾5-15.37d2debb.jpeg" alt="å›¾5-15" style="zoom:50%;"><p>å›¾5-15 åˆ é™¤èŠ‚ç‚¹ 10</p><p>ä½†æ˜¯ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œï¼Œä¸€ä¸ªåˆ é™¤èŠ‚ç‚¹ 10ï¼Œä¸€ä¸ªè¦åœ¨èŠ‚ç‚¹ 10 åé¢æ’å…¥èŠ‚ç‚¹ 20ã€‚å¹¶ä¸”è¿™ä¸¤ä¸ªæ“ä½œéƒ½å„è‡ªæ˜¯ CAS çš„ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°é—®é¢˜ã€‚å¦‚å›¾5-16 æ‰€ç¤ºï¼Œåˆ é™¤èŠ‚ç‚¹ 10ï¼Œä¼šåŒæ—¶æŠŠæ–°æ’å…¥çš„èŠ‚ç‚¹ 20 ä¹Ÿåˆ é™¤æ‰ï¼è¿™ä¸ªé—®é¢˜è¶…å‡ºäº† CAS çš„è§£å†³èŒƒå›´ã€‚</p><img src="/assets/å›¾5-16.88c4ac73.jpeg" alt="å›¾5-16" style="zoom:50%;"><p>å›¾5-16 ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œ</p><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p><p>ç©¶å…¶åŸå› ï¼šåœ¨åˆ é™¤èŠ‚ç‚¹ 10 çš„æ—¶å€™ï¼Œå®é™…å—åˆ°æ“ä½œçš„æ˜¯èŠ‚ç‚¹ 10 çš„å‰é©±ï¼Œä¹Ÿå°±æ˜¯å¤´èŠ‚ç‚¹ã€‚èŠ‚ç‚¹ 10 æœ¬èº«æ²¡æœ‰ä»»ä½•å˜åŒ–ã€‚æ•…è€Œï¼Œå†å¾€èŠ‚ç‚¹ 10 åæ’å…¥èŠ‚ç‚¹ 20 çš„çº¿ç¨‹ï¼Œå¹¶ä¸çŸ¥é“èŠ‚ç‚¹ 10 å·²ç»è¢«åˆ é™¤äº†ï¼</p><p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œåœ¨è®ºæ–‡ä¸­æå‡ºäº†å¦‚ä¸‹çš„è§£å†³åŠæ³•ï¼Œå¦‚å›¾5-17 æ‰€ç¤ºï¼ŒæŠŠèŠ‚ç‚¹ 10 çš„åˆ é™¤åˆ†ä¸ºä¸¤ 2 æ­¥ï¼š</p><img src="/assets/å›¾5-17.71249b75.jpeg" alt="å›¾5-17" style="zoom:50%;"><p>å›¾5-17 åˆ é™¤ 1 ä¸ªèŠ‚ç‚¹çš„ä¸¤ä¸ªæ­¥éª¤</p><p>ç¬¬ä¸€æ­¥ï¼ŒæŠŠèŠ‚ç‚¹ 10 çš„ next æŒ‡é’ˆï¼Œmark æˆåˆ é™¤ï¼Œå³è½¯åˆ é™¤ï¼›</p><p>ç¬¬äºŒæ­¥ï¼Œæ‰¾æœºä¼šï¼Œç‰©ç†åˆ é™¤ã€‚</p><p>åšæ ‡è®°ä¹‹åï¼Œå½“çº¿ç¨‹å†å¾€èŠ‚ç‚¹ 10 åé¢æ’å…¥èŠ‚ç‚¹ 20 çš„æ—¶å€™ï¼Œä¾¿å¯ä»¥å…ˆè¿›è¡Œåˆ¤æ–­ï¼ŒèŠ‚ç‚¹ 10 æ˜¯å¦å·²ç»è¢«åˆ é™¤ï¼Œä»è€Œé¿å…åœ¨ä¸€ä¸ªåˆ é™¤çš„èŠ‚ç‚¹ 10 åé¢æ’å…¥èŠ‚ç‚¹ 20ã€‚è¿™ä¸ªè§£å†³æ–¹æ³•æœ‰ä¸€ä¸ªå…³é”®ç‚¹ï¼šâ€œæŠŠèŠ‚ç‚¹ 10 çš„ next æŒ‡é’ˆæŒ‡å‘èŠ‚ç‚¹ 20ï¼ˆæ’å…¥æ“ä½œï¼‰â€ å’Œ â€œåˆ¤æ–­èŠ‚ç‚¹ 10 æœ¬èº«æ˜¯å¦å·²ç»åˆ é™¤ï¼ˆåˆ¤æ–­æ“ä½œï¼‰â€ï¼Œå¿…é¡»æ˜¯åŸå­çš„ï¼Œå¿…é¡»åœ¨ 1 ä¸ª CAS æ“ä½œé‡Œé¢å®Œæˆï¼</p><p>åŠæ³•ä¸€ï¼šAtomicMarkableReference</p><p>ä¿è¯æ¯ä¸ª next æ˜¯ AtomicMarkableReference ç±»å‹ã€‚ä½†è¿™ä¸ªåŠæ³•ä¸å¤Ÿé«˜æ•ˆï¼ŒDoug Lea åœ¨ ConcurrentSkipListMap çš„å®ç°ä¸­ç”¨äº†å¦ä¸€ç§åŠæ³•ã€‚</p><p>åŠæ³• 2ï¼šMark èŠ‚ç‚¹</p><p>æˆ‘ä»¬çš„ç›®çš„æ˜¯æ ‡è®°èŠ‚ç‚¹ 10 å·²ç»åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯æ ‡è®°å®ƒçš„ next å­—æ®µã€‚é‚£ä¹ˆå¯ä»¥æ–°é€ ä¸€ä¸ª marker èŠ‚ç‚¹ï¼Œä½¿èŠ‚ç‚¹ 10 çš„ next æŒ‡é’ˆæŒ‡å‘è¯¥ Marker èŠ‚ç‚¹ã€‚è¿™æ ·ï¼Œå½“å‘èŠ‚ç‚¹ 10 çš„åé¢æ’å…¥èŠ‚ç‚¹ 20 çš„æ—¶å€™ï¼Œå°±å¯ä»¥åœ¨æ’å…¥çš„åŒæ—¶åˆ¤æ–­èŠ‚ç‚¹ 10 çš„ next æŒ‡é’ˆæ˜¯å¦æ‰§è¡Œäº†ä¸€ä¸ª Marker èŠ‚ç‚¹ï¼Œè¿™ä¸¤ä¸ªæ“ä½œå¯ä»¥åœ¨ä¸€ä¸ª CAS æ“ä½œé‡Œé¢å®Œæˆã€‚</p></li><li><p>è·³æŸ¥è¡¨</p><p>è§£å†³äº†æ— é”é“¾è¡¨çš„æ’å…¥æˆ–åˆ é™¤é—®é¢˜ï¼Œä¹Ÿå°±è§£å†³äº†è·³æŸ¥è¡¨çš„ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚å› ä¸ºè·³æŸ¥è¡¨å°±æ˜¯å¤šå±‚é“¾è¡¨å èµ·æ¥çš„ã€‚</p><p>ä¸‹é¢å…ˆçœ‹ä¸€ä¸‹è·³æŸ¥è¡¨çš„æ•°æ®ç»“æ„ï¼ˆä¸‹é¢æ‰€ç”¨ä»£ç éƒ½å¼•ç”¨è‡ª JDK 7ï¼ŒJDK 8 ä¸­çš„ä»£ç ç•¥æœ‰å·®å¼‚ï¼Œä½†ä¸å½±å“ä¸‹é¢çš„åŸç†åˆ†æï¼‰ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// åº•å±‚ Node èŠ‚ç‚¹ã€‚æ‰€æœ‰çš„ &lt;K,V&gt; å¯¹ï¼Œéƒ½æ˜¯ç”±è¿™ä¸ªå•å‘é“¾è¡¨ä¸²èµ·æ¥çš„</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">K</span> key<span class="token punctuation">;</span>
    <span class="token keyword">volatile</span> <span class="token class-name">Object</span> value<span class="token punctuation">;</span>
    <span class="token keyword">volatile</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">;</span>
    <span class="token comment">// ... </span>
<span class="token punctuation">}</span>

<span class="token comment">// ä¸Šé¢ Index å±‚çš„èŠ‚ç‚¹</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Index</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¸å­˜å‚¨å®é™…æ•°æ®ï¼ŒæŒ‡å‘ Node</span>
    <span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> node<span class="token punctuation">;</span>
    <span class="token comment">// å…³é”®ç‚¹ï¼šæ¯ä¸ª Index èŠ‚ç‚¹ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å…¶ä¸‹ä¸€ä¸ª Level å¯¹åº”çš„èŠ‚ç‚¹</span>
    <span class="token keyword">final</span> <span class="token class-name">Index</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> down<span class="token punctuation">;</span>
    <span class="token comment">// è‡ªå·±ä¹Ÿç»„æˆå•å‘é“¾è¡¨</span>
    <span class="token keyword">volatile</span> <span class="token class-name">Index</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> right<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// æ•´ä¸ª ConcurrentSkipListMap å°±åªéœ€è®°å½•é¡¶å±‚çš„ head èŠ‚ç‚¹</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentSkipListMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">implements</span> <span class="token class-name">ConcurrentNavigableMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">HeadIndex</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> head<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è·³æŸ¥è¡¨çš„æ•°æ®ç»“æ„å¦‚å›¾5-18 æ‰€ç¤ºã€‚</p><img src="/assets/å›¾5-18.57c15766.jpeg" alt="å›¾5-18" style="zoom:50%;"><p>å›¾5-18 è·³æŸ¥è¡¨çš„æ•°æ®ç»“æ„</p><p>ä¸‹é¢è¯¦ç»†åˆ†æå¦‚ä½•ä»è·³æŸ¥è¡¨ä¸ŠæŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤å…ƒç´ ã€‚</p><p>ï¼ˆ1ï¼‰put å®ç°åˆ†æã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">doPut</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">V</span> <span class="token function">doPut</span><span class="token punctuation">(</span><span class="token class-name">K</span> kkey<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> key <span class="token operator">=</span> <span class="token function">comparable</span><span class="token punctuation">(</span>kkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¦æ’å…¥èŠ‚ç‚¹ï¼Œéœ€è¦å…ˆæ‰¾åˆ°èŠ‚ç‚¹çš„å‰é©±</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> b <span class="token operator">=</span> <span class="token function">findPredecessor</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å…ƒç´ è¦æ’åœ¨ [b, n] ä¹‹é—´</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> n <span class="token operator">=</span> b<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> f <span class="token operator">=</span> n<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token comment">// n != b.nextï¼Œé‡æ–°å¼€å§‹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> b<span class="token punctuation">.</span>next<span class="token punctuation">)</span>               
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token class-name">Object</span> v <span class="token operator">=</span> n<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>               
                    <span class="token comment">// å‘ç° n å·²ç»è¢«åˆ é™¤äº†ï¼Œæ‰§è¡Œåˆ é™¤æ¸…ç†é€»è¾‘</span>
                    n<span class="token punctuation">.</span><span class="token function">helpDelete</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// å‘ç° b å·²ç»è¢«åˆ é™¤äº†ï¼Œé‡æ–°å¼€å§‹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> n <span class="token operator">||</span> b<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> c <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å¾…æ’å…¥çš„å…ƒç´ ï¼Œå·²ç»å¤§äº nï¼Œåˆ™æŠŠ [b, n] å¾€åæŒªä¸€ä¸ªä½ç½®</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    b <span class="token operator">=</span> n<span class="token punctuation">;</span>
                    n <span class="token operator">=</span> f<span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// èŠ‚ç‚¹å­˜åœ¨ï¼Œç›´æ¥æ”¹å€¼</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>onlyIfAbsent <span class="token operator">||</span> n<span class="token punctuation">.</span><span class="token function">casValue</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">V</span><span class="token punctuation">)</span>v<span class="token punctuation">;</span>
                    <span class="token keyword">else</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>  
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// è‹¥å¾…æ’å…¥çš„å…ƒç´ åœ¨ [b, n] ä¹‹é—´ï¼Œåˆ™ä¼šèµ°åˆ°è¿™ä¸ªä½ç½®ï¼Œæ’å…¥æ–°èŠ‚ç‚¹</span>
            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> z <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>kkey<span class="token punctuation">,</span> value<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è‹¥èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ™æ–°å»ºä¸€ä¸ªï¼Œæ’å…¥è¿›å»</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>b<span class="token punctuation">.</span><span class="token function">casNext</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>         
            <span class="token comment">// åˆ¤æ–­æ˜¯å¦è¦ç»™æ­¤èŠ‚ç‚¹åŠ ä¸Š Index å±‚ã€‚randomLevel æœ‰ 50% ä¼šè¿”å› 0ï¼Œ</span>
            <span class="token comment">// ä¹Ÿå°±æ˜¯è¯´ï¼Œ50% çš„èŠ‚ç‚¹ä¸ä¼šæœ‰ Index å±‚ï¼Œè€Œåªä¼šåœ¨åº•å±‚çš„é“¾è¡¨ä¸Šé¢</span>
            <span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token function">randomLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment">// level &gt; 0ï¼Œä¸ºå…¶å»ºç´¢å¼•</span>
                <span class="token function">insertIndex</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// å…³é”®å‡½æ•°ï¼šæŸ¥æ‰¾ä¸€ä¸ªèŠ‚ç‚¹çš„å‰é©±ï¼Œä» header å¼€å§‹ï¼Œä»å·¦å¾€å³ã€ä»ä¸Šå¾€ä¸‹éå†</span>
<span class="token keyword">private</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPredecessor</span><span class="token punctuation">(</span><span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é¡¶å±‚ index çš„å¤´éƒ¨</span>
        <span class="token class-name">Index</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> q <span class="token operator">=</span> head<span class="token punctuation">;</span>
        <span class="token class-name">Index</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> r <span class="token operator">=</span> q<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> n <span class="token operator">=</span> r<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
                <span class="token class-name">K</span> k <span class="token operator">=</span> n<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
                <span class="token comment">// r å¯¹åº”çš„ Node å·²ç»æ˜¯åˆ é™¤çŠ¶æ€</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>            
                    r <span class="token operator">=</span> q<span class="token punctuation">.</span>right<span class="token punctuation">;</span>          
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// è¦æŸ¥æ‰¾çš„å…ƒç´  &gt; èŠ‚ç‚¹ï¼Œä¸€ç›´å¾€å³éå†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    q <span class="token operator">=</span> r<span class="token punctuation">;</span>
                    r <span class="token operator">=</span> r<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// ä»ä¸Šé¢çš„ if åˆ¤æ–­ä¸­è·³å‡ºæ¥ï¼Œåˆ™å½“å‰èŠ‚ç‚¹å¤„äº [q, r] ä¹‹é—´ï¼Œå¤§äº qï¼Œå°äº rï¼Œè·³åˆ°ä¸‹ä¸€å±‚ï¼Œä» q å¼€å§‹</span>
            <span class="token class-name">Index</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> d <span class="token operator">=</span> q<span class="token punctuation">.</span>down<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                q <span class="token operator">=</span> d<span class="token punctuation">;</span>
                r <span class="token operator">=</span> d<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span>
                <span class="token comment">// åˆ°äº†åº•å±‚ï¼Œè¿”å›å‰é©±</span>
                <span class="token keyword">return</span> q<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚å›¾5-19 æ‰€ç¤ºä¸ºè·³æŸ¥è¡¨æŸ¥æ‰¾ç¤ºæ„å›¾ã€‚</p><img src="/assets/å›¾5-19.1c4e9dee.jpeg" alt="å›¾5-19" style="zoom:50%;"><p>å›¾5-19 è·³æŸ¥è¡¨æŸ¥æ‰¾ç¤ºæ„å›¾</p><p>åœ¨åº•å±‚ï¼ŒèŠ‚ç‚¹æŒ‰ç…§ä»å°åˆ°å¤§çš„é¡ºåºæ’åˆ—ï¼Œä¸Šé¢çš„ index å±‚é—´éš”åœ°ä¸²åœ¨ä¸€èµ·ï¼Œå› ä¸ºä»å°åˆ°å¤§æ’åˆ—ã€‚æŸ¥æ‰¾çš„æ—¶å€™ï¼Œä»é¡¶å±‚ index å¼€å§‹ï¼Œè‡ªå·¦å¾€å³ã€è‡ªä¸Šå¾€ä¸‹ï¼Œå½¢æˆå›¾ç¤ºçš„éå†æ›²çº¿ã€‚å‡è®¾è¦æŸ¥æ‰¾çš„å…ƒç´ æ˜¯ 32ï¼Œéå†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>å…ˆéå†ç¬¬ 2 å±‚ Indexï¼Œå‘ç°åœ¨ 21 çš„åé¢ï¼›</p><p>ä» 21 ä¸‹é™åˆ°ç¬¬ 1 å±‚ Indexï¼Œä» 21 å¾€åéå†ï¼Œå‘ç°åœ¨ 21 å’Œ 35 ä¹‹é—´ï¼›</p><p>ä» 21 ä¸‹é™åˆ°åº•å±‚ï¼Œä» 21 å¾€åéå†ï¼Œæœ€ç»ˆå‘ç°åœ¨ 29 å’Œ 35 ä¹‹é—´ã€‚</p><p>åœ¨æ•´ä¸ªçš„æŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼ŒèŒƒå›´ä¸æ–­ç¼©å°ï¼Œæœ€ç»ˆå®šä½åˆ°åº•å±‚çš„ä¸¤ä¸ªå…ƒç´ ä¹‹é—´ã€‚</p><p>å…³äºä¸Šé¢çš„ put(..) å‡½æ•°ï¼Œæœ‰ä¸€ä¸ªå…³é”®ç‚¹éœ€è¦è¯´æ˜ï¼šåœ¨é€šè¿‡ findPredecessor æ‰¾åˆ°äº†å¾…æ’å…¥çš„å…ƒç´ åœ¨ [b, n] ä¹‹é—´ä¹‹åï¼Œå¹¶ä¸èƒ½é©¬ä¸Šæ’å…¥ã€‚å› ä¸ºå…¶ä»–çº¿ç¨‹ä¹Ÿåœ¨æ“ä½œè¿™ä¸ªé“¾è¡¨ï¼Œbã€n éƒ½æœ‰å¯èƒ½è¢«åˆ é™¤ï¼Œæ‰€ä»¥åœ¨æ’å…¥ä¹‹å‰æ‰§è¡Œäº†ä¸€ç³»åˆ—çš„æ£€æŸ¥é€»è¾‘ï¼Œè€Œè¿™ä¹Ÿæ­£æ˜¯æ— é”é“¾è¡¨çš„å¤æ‚ä¹‹å¤„ã€‚</p><p>ï¼ˆ2ï¼‰remove(..) åˆ†æ</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doRemove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// è‹¥æ‰¾åˆ°äº† (k, v)ï¼Œåˆ™åˆ é™¤ï¼Œå¹¶è¿”å› vï¼›è‹¥æ‰¾ä¸åˆ°ï¼Œåˆ™è¿”å› null</span>
<span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">doRemove</span><span class="token punctuation">(</span><span class="token class-name">Object</span> okey<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> key <span class="token operator">=</span> <span class="token function">comparable</span><span class="token punctuation">(</span>okey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> b <span class="token operator">=</span> <span class="token function">findPredecessor</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> n <span class="token operator">=</span> b<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> f <span class="token operator">=</span> n<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token comment">// ä¸ä¸€è‡´è¯»ï¼Œé‡æ–°å¼€å§‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> b<span class="token punctuation">.</span>next<span class="token punctuation">)</span>                     
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> v <span class="token operator">=</span> n<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token comment">// å‘ç° n å·²ç»åˆ é™¤ï¼Œæ‰§è¡Œåˆ é™¤çš„æ¸…ç†é€»è¾‘</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                     
                n<span class="token punctuation">.</span><span class="token function">helpDelete</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// å‘ç° b å·²ç»åˆ é™¤ï¼Œé‡æ–°å¼€å§‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> n <span class="token operator">||</span> b<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>       
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> c <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è¦åˆ é™¤çš„å…ƒç´ å°äº nï¼Œè¯´æ˜æ²¡æ‰¾åˆ°è¦åˆ é™¤çš„å…ƒç´ ï¼Œè¿”å› null</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// è¦åˆ é™¤çš„å…ƒç´ å¤§äº nï¼Œ[b, n] åç§»ä¸€ä¸ªä½ç½®ï¼Œé‡æ–°æ‰¾</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                b <span class="token operator">=</span> n<span class="token punctuation">;</span>
                n <span class="token operator">=</span> f<span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æ²¡æ‰¾åˆ°è¦åˆ é™¤çš„å…ƒç´  (k, v)ã€‚key ç›¸ç­‰ï¼Œä½† value ä¸åŒ¹é…ï¼Œè¿”å› null</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>value<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// è¦åˆ é™¤çš„å…ƒç´ ç­‰äº nã€‚æ‰§è¡Œä¸‹é¢ä¸€ç³»åˆ—åˆ é™¤é€»è¾‘</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>n<span class="token punctuation">.</span><span class="token function">casValue</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>n<span class="token punctuation">.</span><span class="token function">appendMarker</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>b<span class="token punctuation">.</span><span class="token function">casNext</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">findNode</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>                   
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">findPredecessor</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>            
                <span class="token keyword">if</span> <span class="token punctuation">(</span>head<span class="token punctuation">.</span>right <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token function">tryReduceLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">V</span><span class="token punctuation">)</span>v<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„åˆ é™¤å‡½æ•°å’Œæ’å…¥å‡½æ•°çš„é€»è¾‘éå¸¸ç±»ä¼¼ï¼Œå› ä¸ºæ— è®ºæ˜¯æ’å…¥ï¼Œè¿˜æ˜¯åˆ é™¤ï¼Œéƒ½è¦å…ˆæ‰¾åˆ°å…ƒç´ çš„å‰é©±ï¼Œä¹Ÿå°±æ˜¯å®šä½åˆ°å…ƒç´ æ‰€åœ¨çš„åŒºé—´ [b, n]ã€‚åœ¨å®šä½ä¹‹åï¼Œæ‰§è¡Œä¸‹é¢å‡ ä¸ªæ­¥éª¤ï¼š</p><p>å¦‚æœå‘ç° bã€n å·²ç»è¢«åˆ é™¤äº†ï¼Œåˆ™æ‰§è¡Œå¯¹åº”çš„åˆ é™¤æ¸…ç†é€»è¾‘ï¼›</p><p>å¦åˆ™ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å¾…åˆ é™¤çš„ (k, v)ï¼Œè¿”å› nullï¼›</p><p>å¦‚æœæ‰¾åˆ°äº†å¾…åˆ é™¤çš„å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯èŠ‚ç‚¹ nï¼Œåˆ™æŠŠ n çš„ value ç½®ä¸º nullï¼ŒåŒæ—¶åœ¨ n çš„åé¢åŠ ä¸Š Marker èŠ‚ç‚¹ï¼ŒåŒæ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦é™ä½ Index çš„å±‚æ¬¡ã€‚</p><p>ï¼ˆ3ï¼‰get åˆ†æ</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doGet</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">V</span> <span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">Object</span> okey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> key <span class="token operator">=</span> <span class="token function">comparable</span><span class="token punctuation">(</span>okey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> n <span class="token operator">=</span> <span class="token function">findNode</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> v <span class="token operator">=</span> n<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">V</span><span class="token punctuation">)</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">findNode</span><span class="token punctuation">(</span><span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> b <span class="token operator">=</span> <span class="token function">findPredecessor</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¾…æŸ¥æ‰¾å…ƒç´ å¤„äº [b, n] ä¹‹é—´</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> n <span class="token operator">=</span> b<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> f <span class="token operator">=</span> n<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token comment">// ä¸‹é¢è¿™æ®µåˆ é™¤çš„æ¸…ç†é€»è¾‘å’Œå‰é¢çš„ä¸€æ ·</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> b<span class="token punctuation">.</span>next<span class="token punctuation">)</span>                 
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> v <span class="token operator">=</span> n<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                 
                n<span class="token punctuation">.</span><span class="token function">helpDelete</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> n <span class="token operator">||</span> b<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>   
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> c <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ‰¾åˆ°äº†ï¼Œè¿”å›</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> n<span class="token punctuation">;</span>
            <span class="token comment">// æ²¡æœ‰æ‰¾åˆ°ï¼Œè¿”å› null</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// c &lt; 0ï¼Œåç§» 1 ä¸ªä½ç½®ï¼Œé‡æ–°æ‰¾</span>
            b <span class="token operator">=</span> n<span class="token punctuation">;</span>
            n <span class="token operator">=</span> f<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>é€šè¿‡ä¸Šé¢çš„ä»£ç ä¼šå‘ç°ï¼Œæ— è®ºæ˜¯æ’å…¥ã€åˆ é™¤ï¼Œè¿˜æ˜¯æŸ¥æ‰¾ï¼Œéƒ½æœ‰ç›¸ä¼¼çš„é€»è¾‘ï¼Œéƒ½éœ€è¦å…ˆå®šä½åˆ°å…ƒç´ ä½ç½® [b, n]ï¼Œç„¶ååˆ¤æ–­ bã€n æ˜¯å¦å·²ç»è¢«åˆ é™¤ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™éœ€è¦æ‰§è¡Œç›¸åº”çš„åˆ é™¤æ¸…ç†é€»è¾‘ã€‚è¿™ä¹Ÿæ­£æ˜¯æ— é”é“¾è¡¨å¤æ‚çš„åœ°æ–¹ã€‚</p><h3 id="_5-6-2-concurrentskiplistset" tabindex="-1"><a class="header-anchor" href="#_5-6-2-concurrentskiplistset" aria-hidden="true">#</a> 5.6.2 ConcurrentSkipListSet</h3><p>å¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼ŒConcurrentSkipListSet åªæ˜¯å¯¹ ConcurrentSkipListMap çš„ç®€å•å°è£…ï¼Œæ­¤å¤„ä¸å†è¿›ä¸€æ­¥å±•å¼€å™è¿°ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentSkipListSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">implements</span> <span class="token class-name">NavigableSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°è£…äº†ä¸€ä¸ª ConcurrentSkipListMap</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentNavigableMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> m<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">ConcurrentSkipListSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentSkipListMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://gitee.com/anansneaker/vuepress-theme-hope/edit/master/docs/reading-notes/Javaå¹¶å‘å®ç°åŸç†ï¼šJDKæºç å‰–æ/ç¬¬5ç« å¹¶å‘å®¹å™¨.md" rel="noopener noreferrer" target="_blank" aria-label="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><span class="info">2022/8/16 ä¸‹åˆ7:56:17</span></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: cl55563@163.com">é˜¿æ¥ sneaker</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC4%E7%AB%A0%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7%E7%B1%BB.html" class="nav-link prev" aria-label="ç¬¬ 4 ç«  åŒæ­¥å·¥å…·ç±»"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->ç¬¬ 4 ç«  åŒæ­¥å·¥å…·ç±»</div></a><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/%E7%AC%AC6%E7%AB%A0%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%8EFuture.html" class="nav-link next" aria-label="ç¬¬ 6 ç«  çº¿ç¨‹æ± ä¸ Future"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">ç¬¬ 6 ç«  çº¿ç¨‹æ± ä¸ Future<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"></div><div class="copyright">Copyright Â© 2022 é˜¿æ¥ sneaker</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.0d56c066.js" defer></script>
  </body>
</html>
