<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.48" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://www.cxlsn.cn/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html"><meta property="og:site_name" content="MyBlog"><meta property="og:title" content="第 11 章 字节码执行"><meta property="og:type" content="article"><meta property="og:image" content="https://www.cxlsn.cn/"><meta property="og:updated_time" content="2022-08-16T11:56:17.000Z"><meta property="og:locale" content="zh-CN"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="第 11 章 字节码执行"><meta property="article:modified_time" content="2022-08-16T11:56:17.000Z"><title>第 11 章 字节码执行 | MyBlog</title><meta name="description" content="MyBlog">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.09a441ee.css">
    <link rel="modulepreload" href="/assets/app.0d56c066.js"><link rel="modulepreload" href="/assets/第11章字节码执行.html.f0a2e1fd.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/assets/第11章字节码执行.html.fd59242f.js"><link rel="prefetch" href="/assets/index.html.18f6ed2e.js"><link rel="prefetch" href="/assets/home.html.32fca429.js"><link rel="prefetch" href="/assets/slide.html.a293c482.js"><link rel="prefetch" href="/assets/index.html.bcf51f43.js"><link rel="prefetch" href="/assets/index.html.3768ee5f.js"><link rel="prefetch" href="/assets/index.html.b7a9ea16.js"><link rel="prefetch" href="/assets/第10章 异常.html.33f3792f.js"><link rel="prefetch" href="/assets/第11章 并发.html.41f89aa7.js"><link rel="prefetch" href="/assets/第12章 序列化.html.08c4c0cc.js"><link rel="prefetch" href="/assets/第2章 创建和销毁对象.html.1b6f55e3.js"><link rel="prefetch" href="/assets/第3章 对于所有对象都通用的方法.html.e81922f0.js"><link rel="prefetch" href="/assets/第4章 类和接口.html.bbf64366.js"><link rel="prefetch" href="/assets/第5章 泛型.html.053306ed.js"><link rel="prefetch" href="/assets/第6章 枚举和注解.html.cb21ea0d.js"><link rel="prefetch" href="/assets/第7章 Lambda和Stream.html.664c81b8.js"><link rel="prefetch" href="/assets/第8章 方法.html.bfc52ab1.js"><link rel="prefetch" href="/assets/第9章 通用编程.html.6a1d88a2.js"><link rel="prefetch" href="/assets/index.html.153be5a1.js"><link rel="prefetch" href="/assets/index.html.4b079bc8.js"><link rel="prefetch" href="/assets/第1章Java多线程技能.html.f4c43a60.js"><link rel="prefetch" href="/assets/第2章对象及变量的并发访问.html.24971a2d.js"><link rel="prefetch" href="/assets/第3章线程间通信.html.e9963ba8.js"><link rel="prefetch" href="/assets/第4章锁的使用.html.bc309d92.js"><link rel="prefetch" href="/assets/第5章定时器.html.aaf2b6ee.js"><link rel="prefetch" href="/assets/第6章单例模式与多线程.html.a87eb20f.js"><link rel="prefetch" href="/assets/第7章拾遗增补.html.2cbb6898.js"><link rel="prefetch" href="/assets/第8章并发集合框架.html.1739cc6b.js"><link rel="prefetch" href="/assets/第9章线程池ThreadPoolExecutor的使用.html.186199c8.js"><link rel="prefetch" href="/assets/index.html.62274579.js"><link rel="prefetch" href="/assets/第1章多线程基础.html.afd475cd.js"><link rel="prefetch" href="/assets/第2章Atomic类.html.06be1f5d.js"><link rel="prefetch" href="/assets/第3章Lock与Condition.html.ab9d71ca.js"><link rel="prefetch" href="/assets/第4章同步工具类.html.c3382339.js"><link rel="prefetch" href="/assets/第5章并发容器.html.ef80cb1d.js"><link rel="prefetch" href="/assets/第6章线程池与Future.html.e4a6ecca.js"><link rel="prefetch" href="/assets/第7章ForkJoinPool.html.98e49c17.js"><link rel="prefetch" href="/assets/第8章CompletableFuture.html.f7a413b4.js"><link rel="prefetch" href="/assets/index.html.12f0ee52.js"><link rel="prefetch" href="/assets/第10章Java并发包中线程同步器原理剖析.html.b977fee1.js"><link rel="prefetch" href="/assets/第11章并发编程实践.html.623c5cbb.js"><link rel="prefetch" href="/assets/第1章并发编程线程基础.html.3967f815.js"><link rel="prefetch" href="/assets/第2章并发编程的其他基础知识.html.1c7f7072.js"><link rel="prefetch" href="/assets/第3章Java并发包中ThreadLocalRandom类原理剖析.html.8f28f52d.js"><link rel="prefetch" href="/assets/第4章Java并发包中原子操作类原理剖析.html.2e32d2f3.js"><link rel="prefetch" href="/assets/第5章Java并发包中并发List源码剖析.html.4b8c96f3.js"><link rel="prefetch" href="/assets/第6章Java并发包中锁原理剖析.html.57b14c73.js"><link rel="prefetch" href="/assets/第7章Java并发包中并发队列原理剖析.html.21d8c694.js"><link rel="prefetch" href="/assets/第8章Java并发包中线程池ThreadPoolExecutor原理探究.html.44cbbd21.js"><link rel="prefetch" href="/assets/第9章Java并发包中ScheduledThreadPoolExecutor原理探究.html.b4fa44fb.js"><link rel="prefetch" href="/assets/index.html.e5d1d6c3.js"><link rel="prefetch" href="/assets/第10章 Map和Set.html.a55e5985.js"><link rel="prefetch" href="/assets/第11章 堆与优先级列表.html.e280a8e4.js"><link rel="prefetch" href="/assets/第12章 通用容器和总结.html.7f8f71e8.js"><link rel="prefetch" href="/assets/第13章 文件基本技术.html.5f4b89df.js"><link rel="prefetch" href="/assets/第14章 文件高级技术.html.8c6479e2.js"><link rel="prefetch" href="/assets/第15章 并发基础知识.html.5cb53a4c.js"><link rel="prefetch" href="/assets/第16章 并发包的基石.html.142bea88.js"><link rel="prefetch" href="/assets/第17章 并发容器.html.3acbf1e5.js"><link rel="prefetch" href="/assets/第18章 异步任务执行服务.html.1b161f70.js"><link rel="prefetch" href="/assets/第19章 同步和协作工具类.html.addf5980.js"><link rel="prefetch" href="/assets/第1章 编程基础.html.baf9d7d3.js"><link rel="prefetch" href="/assets/第20章 并发总结.html.0b3bb480.js"><link rel="prefetch" href="/assets/第21章 反射.html.af2446cd.js"><link rel="prefetch" href="/assets/第22章 注解.html.d1e27bc4.js"><link rel="prefetch" href="/assets/第23章 动态代理.html.7995d8c2.js"><link rel="prefetch" href="/assets/第24章 类加载机制.html.b0642f1c.js"><link rel="prefetch" href="/assets/第25章 正则表达式.html.8b5d5322.js"><link rel="prefetch" href="/assets/第26章 函数式编程.html.7b517aff.js"><link rel="prefetch" href="/assets/第2章 理解数据背后的二进制.html.94e4cb31.js"><link rel="prefetch" href="/assets/第3章 类的基础.html.5639d229.js"><link rel="prefetch" href="/assets/第4章 类的继承.html.2f958e91.js"><link rel="prefetch" href="/assets/第5章 类的继承.html.7d7e56a6.js"><link rel="prefetch" href="/assets/第6章 异常.html.adb3eef3.js"><link rel="prefetch" href="/assets/第7章 常用基础类.html.17e1b88d.js"><link rel="prefetch" href="/assets/第8章 泛型.html.9d1aa562.js"><link rel="prefetch" href="/assets/第9章 列表和队列.html.1b223279.js"><link rel="prefetch" href="/assets/index.html.213dbe07.js"><link rel="prefetch" href="/assets/第10章Executor框架.html.2d819cce.js"><link rel="prefetch" href="/assets/第11章Java并发编程实践.html.e045243d.js"><link rel="prefetch" href="/assets/第1章并发编程的挑战.html.f2cf1cf0.js"><link rel="prefetch" href="/assets/第2章Java并发机制的底层实现原理.html.84620d72.js"><link rel="prefetch" href="/assets/第3章Java内存模型.html.57e9f10a.js"><link rel="prefetch" href="/assets/第4章Java并发编程基础.html.e1837d6e.js"><link rel="prefetch" href="/assets/第5章Java中的锁.html.509db6c5.js"><link rel="prefetch" href="/assets/第6章Java并发容器和框架.html.fab16b37.js"><link rel="prefetch" href="/assets/第7章Java中的13个原子操作类.html.8a2e8902.js"><link rel="prefetch" href="/assets/第8章Java中的并发工具类.html.ede4146b.js"><link rel="prefetch" href="/assets/第9章Java中的线程池.html.e7e64f52.js"><link rel="prefetch" href="/assets/index.html.ccabe8d8.js"><link rel="prefetch" href="/assets/第10章避免活跃性危险.html.288ef3a6.js"><link rel="prefetch" href="/assets/第11章性能与可伸缩性.html.66974eb6.js"><link rel="prefetch" href="/assets/第12章并发程序的测试.html.064eea71.js"><link rel="prefetch" href="/assets/第13章显式锁.html.bf44c451.js"><link rel="prefetch" href="/assets/第14章构建自定义的同步工具.html.23a2e0be.js"><link rel="prefetch" href="/assets/第15章原子变量与非阻塞同步机制.html.06dd6e43.js"><link rel="prefetch" href="/assets/第16章Java内存模型简介.html.977d59cd.js"><link rel="prefetch" href="/assets/第1章简介.html.90b5e48c.js"><link rel="prefetch" href="/assets/第2章线程安全.html.2501a94b.js"><link rel="prefetch" href="/assets/第3章对象的共享.html.faeb65aa.js"><link rel="prefetch" href="/assets/第4章对象的组合.html.1fe1b50c.js"><link rel="prefetch" href="/assets/第5章基础构建模块.html.1fe6799b.js"><link rel="prefetch" href="/assets/第6章任务执行.html.70613e72.js"><link rel="prefetch" href="/assets/第7章取消与关闭.html.1e1c2d49.js"><link rel="prefetch" href="/assets/第8章线程池的使用.html.72ef0a90.js"><link rel="prefetch" href="/assets/第9章图形用户界面应用程序.html.11c377b5.js"><link rel="prefetch" href="/assets/001-two-sum.html.a3f3595a.js"><link rel="prefetch" href="/assets/002-add-two-numbers.html.e7703c4f.js"><link rel="prefetch" href="/assets/003-longest-substring-without-repeating-characters.html.0c6329c6.js"><link rel="prefetch" href="/assets/index.html.d8ad8d07.js"><link rel="prefetch" href="/assets/index.html.5a513471.js"><link rel="prefetch" href="/assets/第10章前端编译与优化.html.2a6b1789.js"><link rel="prefetch" href="/assets/第11章后端编译与优化.html.59704c7c.js"><link rel="prefetch" href="/assets/第12章Java内存模型与线程.html.deaa5ea6.js"><link rel="prefetch" href="/assets/第13章线程安全与锁优化.html.fd873e3a.js"><link rel="prefetch" href="/assets/第1章走近Java.html.0897d78c.js"><link rel="prefetch" href="/assets/第2章Java内存区域与内存溢出异常.html.0978cdd4.js"><link rel="prefetch" href="/assets/第3章垃圾收集器与内存分配策略.html.a47791fa.js"><link rel="prefetch" href="/assets/第4章虚拟机性能监控、故障处理工具.html.61f80277.js"><link rel="prefetch" href="/assets/第5章调优案例分析与实战.html.7a5b7c4c.js"><link rel="prefetch" href="/assets/第6章类文件结构.html.3e8cd2c6.js"><link rel="prefetch" href="/assets/第7章虚拟机类加载机制.html.3af5a31c.js"><link rel="prefetch" href="/assets/第8章虚拟机字节码执行引擎.html.dc5c593e.js"><link rel="prefetch" href="/assets/第9章类加载及执行子系统的案例与实战.html.c3e2fd28.js"><link rel="prefetch" href="/assets/index.html.c2e9c36e.js"><link rel="prefetch" href="/assets/第1章走入并行世界.html.bf2758d5.js"><link rel="prefetch" href="/assets/第2章Java并行程序基础.html.8a27b9a6.js"><link rel="prefetch" href="/assets/第3章JDK并发包.html.55a5bb57.js"><link rel="prefetch" href="/assets/第4章锁的优化及注意事项.html.0ac6ac12.js"><link rel="prefetch" href="/assets/第5章并行模式与算法.html.6e857f15.js"><link rel="prefetch" href="/assets/第6章Java8910与并发.html.61173fb4.js"><link rel="prefetch" href="/assets/第7章使用Akka构建高并发程序.html.610f0e53.js"><link rel="prefetch" href="/assets/第8章并行程序调试.html.dcf9af72.js"><link rel="prefetch" href="/assets/第9章多线程优化示例—Jetty核心代码分析.html.1b25b9bb.js"><link rel="prefetch" href="/assets/index.html.8c841845.js"><link rel="prefetch" href="/assets/第10章Class装载系统.html.800b1d8e.js"><link rel="prefetch" href="/assets/第1章初探Java虚拟机.html.80ec8c68.js"><link rel="prefetch" href="/assets/第2章认识Java虚拟机的基本结构.html.bbf499e1.js"><link rel="prefetch" href="/assets/第3章常用Java虚拟机参数.html.10cb1042.js"><link rel="prefetch" href="/assets/第4章垃圾回收的概念与算法.html.90d52151.js"><link rel="prefetch" href="/assets/第5章垃圾收集器和内存分配.html.98dc8566.js"><link rel="prefetch" href="/assets/第6章性能监控工具.html.d9178ab7.js"><link rel="prefetch" href="/assets/第7章分析Java堆.html.76f053df.js"><link rel="prefetch" href="/assets/第8章锁与并发.html.c6edc3b8.js"><link rel="prefetch" href="/assets/第9章Class文件结构.html.ce3b9ffe.js"><link rel="prefetch" href="/assets/404.html.a61819a1.js"><link rel="prefetch" href="/assets/index.html.196bf7d0.js"><link rel="prefetch" href="/assets/index.html.6474b04a.js"><link rel="prefetch" href="/assets/index.html.12d9ea9f.js"><link rel="prefetch" href="/assets/index.html.8cf1d97b.js"><link rel="prefetch" href="/assets/index.html.b1d72dff.js"><link rel="prefetch" href="/assets/index.html.6a433ed8.js"><link rel="prefetch" href="/assets/index.html.292db8d2.js"><link rel="prefetch" href="/assets/index.html.db46c28d.js"><link rel="prefetch" href="/assets/home.html.b3222fa8.js"><link rel="prefetch" href="/assets/slide.html.3b4fa46d.js"><link rel="prefetch" href="/assets/index.html.eab01647.js"><link rel="prefetch" href="/assets/index.html.f6997ce1.js"><link rel="prefetch" href="/assets/index.html.4f492e58.js"><link rel="prefetch" href="/assets/第10章 异常.html.b369a82a.js"><link rel="prefetch" href="/assets/第11章 并发.html.1e83a7e7.js"><link rel="prefetch" href="/assets/第12章 序列化.html.934b2280.js"><link rel="prefetch" href="/assets/第2章 创建和销毁对象.html.bf39597f.js"><link rel="prefetch" href="/assets/第3章 对于所有对象都通用的方法.html.c2f582c1.js"><link rel="prefetch" href="/assets/第4章 类和接口.html.d616fa92.js"><link rel="prefetch" href="/assets/第5章 泛型.html.fe9bf71e.js"><link rel="prefetch" href="/assets/第6章 枚举和注解.html.b0c192a2.js"><link rel="prefetch" href="/assets/第7章 Lambda和Stream.html.11e132a3.js"><link rel="prefetch" href="/assets/第8章 方法.html.0f5952cd.js"><link rel="prefetch" href="/assets/第9章 通用编程.html.a9158c44.js"><link rel="prefetch" href="/assets/index.html.66d9275e.js"><link rel="prefetch" href="/assets/index.html.e1e195ac.js"><link rel="prefetch" href="/assets/第1章Java多线程技能.html.d201a503.js"><link rel="prefetch" href="/assets/第2章对象及变量的并发访问.html.8eff37f9.js"><link rel="prefetch" href="/assets/第3章线程间通信.html.96ad7aa4.js"><link rel="prefetch" href="/assets/第4章锁的使用.html.0b108a46.js"><link rel="prefetch" href="/assets/第5章定时器.html.079d1655.js"><link rel="prefetch" href="/assets/第6章单例模式与多线程.html.dd40cab9.js"><link rel="prefetch" href="/assets/第7章拾遗增补.html.c98b6afc.js"><link rel="prefetch" href="/assets/第8章并发集合框架.html.c47636a0.js"><link rel="prefetch" href="/assets/第9章线程池ThreadPoolExecutor的使用.html.fdd06e63.js"><link rel="prefetch" href="/assets/index.html.970ebb57.js"><link rel="prefetch" href="/assets/第1章多线程基础.html.f6e06884.js"><link rel="prefetch" href="/assets/第2章Atomic类.html.5c9a96af.js"><link rel="prefetch" href="/assets/第3章Lock与Condition.html.dd94c834.js"><link rel="prefetch" href="/assets/第4章同步工具类.html.f32cb37a.js"><link rel="prefetch" href="/assets/第5章并发容器.html.11ef3b3d.js"><link rel="prefetch" href="/assets/第6章线程池与Future.html.f2664d19.js"><link rel="prefetch" href="/assets/第7章ForkJoinPool.html.5b09c440.js"><link rel="prefetch" href="/assets/第8章CompletableFuture.html.00ddc982.js"><link rel="prefetch" href="/assets/index.html.05f6dacd.js"><link rel="prefetch" href="/assets/第10章Java并发包中线程同步器原理剖析.html.22c349a1.js"><link rel="prefetch" href="/assets/第11章并发编程实践.html.5db30ba4.js"><link rel="prefetch" href="/assets/第1章并发编程线程基础.html.59828def.js"><link rel="prefetch" href="/assets/第2章并发编程的其他基础知识.html.95634460.js"><link rel="prefetch" href="/assets/第3章Java并发包中ThreadLocalRandom类原理剖析.html.5e3f88be.js"><link rel="prefetch" href="/assets/第4章Java并发包中原子操作类原理剖析.html.aa40f522.js"><link rel="prefetch" href="/assets/第5章Java并发包中并发List源码剖析.html.19da87be.js"><link rel="prefetch" href="/assets/第6章Java并发包中锁原理剖析.html.e64d1f1d.js"><link rel="prefetch" href="/assets/第7章Java并发包中并发队列原理剖析.html.05c55f53.js"><link rel="prefetch" href="/assets/第8章Java并发包中线程池ThreadPoolExecutor原理探究.html.355c02bf.js"><link rel="prefetch" href="/assets/第9章Java并发包中ScheduledThreadPoolExecutor原理探究.html.bc89022d.js"><link rel="prefetch" href="/assets/index.html.0812d30d.js"><link rel="prefetch" href="/assets/第10章 Map和Set.html.d15ebc0a.js"><link rel="prefetch" href="/assets/第11章 堆与优先级列表.html.22879ed0.js"><link rel="prefetch" href="/assets/第12章 通用容器和总结.html.af4e25e8.js"><link rel="prefetch" href="/assets/第13章 文件基本技术.html.e9de4ab6.js"><link rel="prefetch" href="/assets/第14章 文件高级技术.html.6944682e.js"><link rel="prefetch" href="/assets/第15章 并发基础知识.html.fbf03dc9.js"><link rel="prefetch" href="/assets/第16章 并发包的基石.html.f5fbd049.js"><link rel="prefetch" href="/assets/第17章 并发容器.html.d522da1e.js"><link rel="prefetch" href="/assets/第18章 异步任务执行服务.html.76e9a36e.js"><link rel="prefetch" href="/assets/第19章 同步和协作工具类.html.669856bd.js"><link rel="prefetch" href="/assets/第1章 编程基础.html.3f747685.js"><link rel="prefetch" href="/assets/第20章 并发总结.html.1e326470.js"><link rel="prefetch" href="/assets/第21章 反射.html.25579869.js"><link rel="prefetch" href="/assets/第22章 注解.html.10b1af26.js"><link rel="prefetch" href="/assets/第23章 动态代理.html.76b2167b.js"><link rel="prefetch" href="/assets/第24章 类加载机制.html.2dc4cd09.js"><link rel="prefetch" href="/assets/第25章 正则表达式.html.d3486e09.js"><link rel="prefetch" href="/assets/第26章 函数式编程.html.dd3f8bd7.js"><link rel="prefetch" href="/assets/第2章 理解数据背后的二进制.html.3d5eaefa.js"><link rel="prefetch" href="/assets/第3章 类的基础.html.c86161b4.js"><link rel="prefetch" href="/assets/第4章 类的继承.html.2bce738f.js"><link rel="prefetch" href="/assets/第5章 类的继承.html.ad950d91.js"><link rel="prefetch" href="/assets/第6章 异常.html.09ddca79.js"><link rel="prefetch" href="/assets/第7章 常用基础类.html.12c88740.js"><link rel="prefetch" href="/assets/第8章 泛型.html.81d0949a.js"><link rel="prefetch" href="/assets/第9章 列表和队列.html.38c68a48.js"><link rel="prefetch" href="/assets/index.html.bf5d33db.js"><link rel="prefetch" href="/assets/第10章Executor框架.html.a7e672e0.js"><link rel="prefetch" href="/assets/第11章Java并发编程实践.html.debb41c7.js"><link rel="prefetch" href="/assets/第1章并发编程的挑战.html.1b00855d.js"><link rel="prefetch" href="/assets/第2章Java并发机制的底层实现原理.html.f005f932.js"><link rel="prefetch" href="/assets/第3章Java内存模型.html.6ec525fb.js"><link rel="prefetch" href="/assets/第4章Java并发编程基础.html.bd275d3c.js"><link rel="prefetch" href="/assets/第5章Java中的锁.html.83cc4dba.js"><link rel="prefetch" href="/assets/第6章Java并发容器和框架.html.8a83a2ef.js"><link rel="prefetch" href="/assets/第7章Java中的13个原子操作类.html.2c3c8029.js"><link rel="prefetch" href="/assets/第8章Java中的并发工具类.html.61794c87.js"><link rel="prefetch" href="/assets/第9章Java中的线程池.html.9434f936.js"><link rel="prefetch" href="/assets/index.html.93c2aee6.js"><link rel="prefetch" href="/assets/第10章避免活跃性危险.html.e7ea1e3a.js"><link rel="prefetch" href="/assets/第11章性能与可伸缩性.html.42d4a3a1.js"><link rel="prefetch" href="/assets/第12章并发程序的测试.html.690d2aba.js"><link rel="prefetch" href="/assets/第13章显式锁.html.1171f97b.js"><link rel="prefetch" href="/assets/第14章构建自定义的同步工具.html.6c72f888.js"><link rel="prefetch" href="/assets/第15章原子变量与非阻塞同步机制.html.9de6dd1b.js"><link rel="prefetch" href="/assets/第16章Java内存模型简介.html.847d1584.js"><link rel="prefetch" href="/assets/第1章简介.html.5ff3b256.js"><link rel="prefetch" href="/assets/第2章线程安全.html.34a72eca.js"><link rel="prefetch" href="/assets/第3章对象的共享.html.088b59e3.js"><link rel="prefetch" href="/assets/第4章对象的组合.html.420592f2.js"><link rel="prefetch" href="/assets/第5章基础构建模块.html.b697dc08.js"><link rel="prefetch" href="/assets/第6章任务执行.html.d2692cee.js"><link rel="prefetch" href="/assets/第7章取消与关闭.html.1033df86.js"><link rel="prefetch" href="/assets/第8章线程池的使用.html.5655d9dd.js"><link rel="prefetch" href="/assets/第9章图形用户界面应用程序.html.2c9a92f0.js"><link rel="prefetch" href="/assets/001-two-sum.html.bd5b42b8.js"><link rel="prefetch" href="/assets/002-add-two-numbers.html.1cd12f58.js"><link rel="prefetch" href="/assets/003-longest-substring-without-repeating-characters.html.3f87474a.js"><link rel="prefetch" href="/assets/index.html.346ee126.js"><link rel="prefetch" href="/assets/index.html.bddb9164.js"><link rel="prefetch" href="/assets/第10章前端编译与优化.html.27f33bd6.js"><link rel="prefetch" href="/assets/第11章后端编译与优化.html.2d98e937.js"><link rel="prefetch" href="/assets/第12章Java内存模型与线程.html.e5d51c84.js"><link rel="prefetch" href="/assets/第13章线程安全与锁优化.html.2e377ef2.js"><link rel="prefetch" href="/assets/第1章走近Java.html.7c41e7a9.js"><link rel="prefetch" href="/assets/第2章Java内存区域与内存溢出异常.html.82365a5f.js"><link rel="prefetch" href="/assets/第3章垃圾收集器与内存分配策略.html.1360e884.js"><link rel="prefetch" href="/assets/第4章虚拟机性能监控、故障处理工具.html.0a90211f.js"><link rel="prefetch" href="/assets/第5章调优案例分析与实战.html.e7e286da.js"><link rel="prefetch" href="/assets/第6章类文件结构.html.9f84d086.js"><link rel="prefetch" href="/assets/第7章虚拟机类加载机制.html.31c0a6a3.js"><link rel="prefetch" href="/assets/第8章虚拟机字节码执行引擎.html.6f40ca25.js"><link rel="prefetch" href="/assets/第9章类加载及执行子系统的案例与实战.html.5bf71bd8.js"><link rel="prefetch" href="/assets/index.html.18e34f59.js"><link rel="prefetch" href="/assets/第1章走入并行世界.html.d4a7a8b1.js"><link rel="prefetch" href="/assets/第2章Java并行程序基础.html.79f6e18f.js"><link rel="prefetch" href="/assets/第3章JDK并发包.html.df0acd9f.js"><link rel="prefetch" href="/assets/第4章锁的优化及注意事项.html.5a2b559c.js"><link rel="prefetch" href="/assets/第5章并行模式与算法.html.c0ec6141.js"><link rel="prefetch" href="/assets/第6章Java8910与并发.html.9a2cc047.js"><link rel="prefetch" href="/assets/第7章使用Akka构建高并发程序.html.e1442a98.js"><link rel="prefetch" href="/assets/第8章并行程序调试.html.ddf890de.js"><link rel="prefetch" href="/assets/第9章多线程优化示例—Jetty核心代码分析.html.0ab5a261.js"><link rel="prefetch" href="/assets/index.html.9735d51d.js"><link rel="prefetch" href="/assets/第10章Class装载系统.html.50bb638d.js"><link rel="prefetch" href="/assets/第1章初探Java虚拟机.html.0a668344.js"><link rel="prefetch" href="/assets/第2章认识Java虚拟机的基本结构.html.1777df39.js"><link rel="prefetch" href="/assets/第3章常用Java虚拟机参数.html.65784af7.js"><link rel="prefetch" href="/assets/第4章垃圾回收的概念与算法.html.d6231456.js"><link rel="prefetch" href="/assets/第5章垃圾收集器和内存分配.html.6446a277.js"><link rel="prefetch" href="/assets/第6章性能监控工具.html.e9ce7787.js"><link rel="prefetch" href="/assets/第7章分析Java堆.html.ee273e82.js"><link rel="prefetch" href="/assets/第8章锁与并发.html.7624390a.js"><link rel="prefetch" href="/assets/第9章Class文件结构.html.f4c2ac9f.js"><link rel="prefetch" href="/assets/404.html.36540b0d.js"><link rel="prefetch" href="/assets/index.html.583c479d.js"><link rel="prefetch" href="/assets/index.html.c407fe6a.js"><link rel="prefetch" href="/assets/index.html.99a8f87f.js"><link rel="prefetch" href="/assets/index.html.7587b161.js"><link rel="prefetch" href="/assets/index.html.f6866d7d.js"><link rel="prefetch" href="/assets/index.html.a985c72b.js"><link rel="prefetch" href="/assets/index.html.4c96ae2e.js"><link rel="prefetch" href="/assets/404.629f43ab.js"><link rel="prefetch" href="/assets/Layout.26a2a4c9.js"><link rel="prefetch" href="/assets/Slide.b01858c1.js"><link rel="prefetch" href="/assets/Blog.ac038c81.js"><link rel="prefetch" href="/assets/auto.esm.52abc6cc.js"><link rel="prefetch" href="/assets/index.147398ee.js"><link rel="prefetch" href="/assets/index.e1c5a3de.js"><link rel="prefetch" href="/assets/mermaid.esm.min.e741c6cd.js"><link rel="prefetch" href="/assets/highlight.esm.9b852bc5.js"><link rel="prefetch" href="/assets/markdown.esm.77e8db25.js"><link rel="prefetch" href="/assets/math.esm.cb9d4be3.js"><link rel="prefetch" href="/assets/notes.esm.62c5f19d.js"><link rel="prefetch" href="/assets/reveal.esm.41ec5d7f.js"><link rel="prefetch" href="/assets/search.esm.04894411.js"><link rel="prefetch" href="/assets/zoom.esm.78977eba.js"><link rel="prefetch" href="/assets/photoswipe.esm.2debdee5.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/" class="brand"><img class="logo" src="/logo.svg" alt="MyBlog"><!----><span class="site-name hide-in-pad">MyBlog</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="读书笔记"><span class="title"><span class="icon iconfont icon-note" style=""></span>读书笔记</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/reading-notes/Effective%20Java" class="nav-link" aria-label="Effective Java"><!---->Effective Java<!----></a></li><li class="dropdown-item"><a href="/reading-notes/Java%E7%BC%96%E7%A8%8B%E7%9A%84%E9%80%BB%E8%BE%91" class="nav-link" aria-label="Java 编程的逻辑"><!---->Java 编程的逻辑<!----></a></li><li class="dropdown-item"><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98" class="nav-link" aria-label="Java 并发编程实战"><!---->Java 并发编程实战<!----></a></li><li class="dropdown-item"><a href="/reading-notes/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF" class="nav-link" aria-label="Java 多线程编程核心技术"><!---->Java 多线程编程核心技术<!----></a></li><li class="dropdown-item"><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8B%E7%BE%8E" class="nav-link" aria-label="Java 并发编程之美"><!---->Java 并发编程之美<!----></a></li><li class="dropdown-item"><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9AJDK%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90" class="nav-link" aria-label="Java 并发实现原理：JDK 源码剖析"><!---->Java 并发实现原理：JDK 源码剖析<!----></a></li><li class="dropdown-item"><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1" class="nav-link" aria-label="实战 Java 高并发程序设计"><!---->实战 Java 高并发程序设计<!----></a></li><li class="dropdown-item"><a href="/reading-notes/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF" class="nav-link" aria-label="Java 并发编程的艺术"><!---->Java 并发编程的艺术<!----></a></li><li class="dropdown-item"><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96" class="nav-link active" aria-label="实战 Java 虚拟机：JVM 故障诊断与性能优化"><!---->实战 Java 虚拟机：JVM 故障诊断与性能优化<!----></a></li><li class="dropdown-item"><a href="/reading-notes/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" class="nav-link" aria-label="深入理解 Java 虚拟机：JVM 高级特性与最佳实践"><!---->深入理解 Java 虚拟机：JVM 高级特性与最佳实践<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="leetcode"><span class="title"><span class="icon iconfont icon-note" style=""></span>leetcode</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/leetcode/Top100" class="nav-link" aria-label="Top 100"><!---->Top 100<!----></a></li></ul></button></div></div></nav><!----></div><div class="navbar-right"><!----><!----><div class="nav-item"><a class="repo-link" href="https://gitee.com/anansneaker/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="Gitee"><svg xmlns="http://www.w3.org/2000/svg" class="icon gitee-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="gitee icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm242.97-533.34H482.39a23.7 23.7 0 0 0-23.7 23.7l-.03 59.28c0 13.08 10.59 23.7 23.7 23.7h165.96a23.7 23.7 0 0 1 23.7 23.7v11.85a71.1 71.1 0 0 1-71.1 71.1H375.71a23.7 23.7 0 0 1-23.7-23.7V423.11a71.1 71.1 0 0 1 71.1-71.1h331.8a23.7 23.7 0 0 0 23.7-23.7l.06-59.25a23.73 23.73 0 0 0-23.7-23.73H423.11a177.78 177.78 0 0 0-177.78 177.75v331.83c0 13.08 10.62 23.7 23.7 23.7h349.62a159.99 159.99 0 0 0 159.99-159.99V482.33a23.7 23.7 0 0 0-23.7-23.7z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><p class="sidebar-heading active"><span class="icon iconfont icon-note" style=""></span><span class="title">读书笔记</span><!----></p><ul class="sidebar-links"><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Effective Java</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java 编程的逻辑</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java 并发编程实战</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java多线程编程核心技术</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java 并发编程之美</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java 并发实现原理：JDK 源码剖析</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">实战 Java 高并发程序设计</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">Java 并发编程的艺术</span><span class="arrow right"></span></button><!----></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">实战 Java 虚拟机：JVM 故障诊断与性能优化</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC1%E7%AB%A0%E5%88%9D%E6%8E%A2Java%E8%99%9A%E6%8B%9F%E6%9C%BA.html" class="nav-link sidebar-link sidebar-page" aria-label="第 1 章 初探 Java 虚拟机"><!---->第 1 章 初探 Java 虚拟机<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC2%E7%AB%A0%E8%AE%A4%E8%AF%86Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84.html" class="nav-link sidebar-link sidebar-page" aria-label="第 2 章 认识 Java 虚拟机的基本结构"><!---->第 2 章 认识 Java 虚拟机的基本结构<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC3%E7%AB%A0%E5%B8%B8%E7%94%A8Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%8F%82%E6%95%B0.html" class="nav-link sidebar-link sidebar-page" aria-label="第 3 章 常用 Java 虚拟机参数"><!---->第 3 章 常用 Java 虚拟机参数<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC4%E7%AB%A0%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%9A%84%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%AE%97%E6%B3%95.html" class="nav-link sidebar-link sidebar-page" aria-label="第 4 章 垃圾回收的概念与算法"><!---->第 4 章 垃圾回收的概念与算法<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC5%E7%AB%A0%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E5%92%8C%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D.html" class="nav-link sidebar-link sidebar-page" aria-label="第 5 章 垃圾收集器和内存分配"><!---->第 5 章 垃圾收集器和内存分配<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC6%E7%AB%A0%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7.html" class="nav-link sidebar-link sidebar-page" aria-label="第 6 章 性能监控工具"><!---->第 6 章 性能监控工具<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC7%E7%AB%A0%E5%88%86%E6%9E%90Java%E5%A0%86.html" class="nav-link sidebar-link sidebar-page" aria-label="第 7 章 分析 Java 堆"><!---->第 7 章 分析 Java 堆<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC8%E7%AB%A0%E9%94%81%E4%B8%8E%E5%B9%B6%E5%8F%91.html" class="nav-link sidebar-link sidebar-page" aria-label="第 8 章 锁与并发"><!---->第 8 章 锁与并发<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC9%E7%AB%A0Class%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.html" class="nav-link sidebar-link sidebar-page" aria-label="第 9 章 Class 文件结构"><!---->第 9 章 Class 文件结构<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC10%E7%AB%A0Class%E8%A3%85%E8%BD%BD%E7%B3%BB%E7%BB%9F.html" class="nav-link sidebar-link sidebar-page" aria-label="第 10 章 Class 装载系统"><!---->第 10 章 Class 装载系统<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="第 11 章 字节码执行"><!---->第 11 章 字节码执行<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-1-代码如何执行-字节码执行案例" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.1 代码如何执行：字节码执行案例"><!---->11.1 代码如何执行：字节码执行案例<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-执行的基础-java-虚拟机常用指令介绍" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.2 执行的基础：Java 虚拟机常用指令介绍"><!---->11.2 执行的基础：Java 虚拟机常用指令介绍<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-1-常量入栈指令" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.2.1 常量入栈指令"><!---->11.2.1 常量入栈指令<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-2-局部变量压栈指令" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.2.2 局部变量压栈指令"><!---->11.2.2 局部变量压栈指令<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-3-出栈装入局部变量表指令" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.2.3 出栈装入局部变量表指令"><!---->11.2.3 出栈装入局部变量表指令<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-4-通用型操作" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.2.4 通用型操作"><!---->11.2.4 通用型操作<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-5-类型转换指令" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.2.5 类型转换指令"><!---->11.2.5 类型转换指令<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-6-运算指令" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.2.6 运算指令"><!---->11.2.6 运算指令<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-7-对象操作指令" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.2.7 对象操作指令"><!---->11.2.7 对象操作指令<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-8-比较控制指令" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.2.8 比较控制指令"><!---->11.2.8 比较控制指令<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-9-函数调用与返回指令" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.2.9 函数调用与返回指令"><!---->11.2.9 函数调用与返回指令<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-10-同步控制" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.2.10 同步控制"><!---->11.2.10 同步控制<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-11-再看-class-的方法结构" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.2.11 再看 Class 的方法结构"><!---->11.2.11 再看 Class 的方法结构<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-3-更上一层楼-再看-asm" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.3 更上一层楼：再看 ASM"><!---->11.3 更上一层楼：再看 ASM<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-3-1-为类增加安全控制" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.3.1 为类增加安全控制"><!---->11.3.1 为类增加安全控制<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-3-2-统计函数执行时间" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.3.2 统计函数执行时间"><!---->11.3.2 统计函数执行时间<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-4-谁说-java-太刻板-java-agent-运行时修改类" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.4 谁说 Java 太刻板：Java Agent 运行时修改类"><!---->11.4 谁说 Java 太刻板：Java Agent 运行时修改类<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-4-1-使用-javaagent-参数启动-java-虚拟机" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.4.1 使用 -javaagent 参数启动 Java 虚拟机"><!---->11.4.1 使用 -javaagent 参数启动 Java 虚拟机<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-4-2-使用-java-agent-为函数增加计时功能" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.4.2 使用 Java Agent 为函数增加计时功能"><!---->11.4.2 使用 Java Agent 为函数增加计时功能<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-4-3-动态重转换类" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.4.3 动态重转换类"><!---->11.4.3 动态重转换类<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-4-4-有关-java-agent-的总结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.4.4 有关 Java Agent 的总结"><!---->11.4.4 有关 Java Agent 的总结<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-5-与时俱进-动态方法调用" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.5 与时俱进：动态方法调用"><!---->11.5 与时俱进：动态方法调用<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-5-1-方法句柄使用实例" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.5.1 方法句柄使用实例"><!---->11.5.1 方法句柄使用实例<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-5-2-调用点使用实例" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.5.2 调用点使用实例"><!---->11.5.2 调用点使用实例<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-5-3-反射和方法句柄" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.5.3 反射和方法句柄"><!---->11.5.3 反射和方法句柄<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-5-4-指令-invokedynamic-使用实例" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.5.4 指令 invokedynamic 使用实例"><!---->11.5.4 指令 invokedynamic 使用实例<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-6-跑得再快点-静态编译优化" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.6 跑得再快点：静态编译优化"><!---->11.6 跑得再快点：静态编译优化<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-6-1-编译时计算" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.6.1 编译时计算"><!---->11.6.1 编译时计算<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-6-2-变量字符串的连接" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.6.2 变量字符串的连接"><!---->11.6.2 变量字符串的连接<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-6-3-基于常量的条件语句裁剪" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.6.3 基于常量的条件语句裁剪"><!---->11.6.3 基于常量的条件语句裁剪<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-6-4-switch-语句的优化" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.6.4 switch 语句的优化"><!---->11.6.4 switch 语句的优化<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-7-提高虚拟机的执行效率-jit-及其相关参数" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.7 提高虚拟机的执行效率：JIT 及其相关参数"><!---->11.7 提高虚拟机的执行效率：JIT 及其相关参数<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-7-1-开启-jit-编译" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.7.1 开启 JIT 编译"><!---->11.7.1 开启 JIT 编译<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-7-2-jit-编译阈值" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.7.2 JIT 编译阈值"><!---->11.7.2 JIT 编译阈值<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-7-3-多级编译器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.7.3 多级编译器"><!---->11.7.3 多级编译器<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-7-4-osr-栈上替换" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.7.4 OSR 栈上替换"><!---->11.7.4 OSR 栈上替换<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-7-5-方法内联" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.7.5 方法内联"><!---->11.7.5 方法内联<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-7-6-设置代码缓存大小" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.7.6 设置代码缓存大小"><!---->11.7.6 设置代码缓存大小<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-8-小结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="11.8 小结"><!---->11.8 小结<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">深入理解 Java 虚拟机：JVM 高级特性与最佳实践</span><span class="arrow right"></span></button><!----></section><!--]--></li></ul></section><!--]--></li><li><!--[--><section class="sidebar-group"><p class="sidebar-heading"><span class="icon iconfont icon-note" style=""></span><span class="title">leetcode</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/leetcode/Top100/" class="nav-link sidebar-link sidebar-page" aria-label="Top 100"><!---->Top 100<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->第 11 章 字节码执行</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down" localizeddate="2022年7月30日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://www.cxlsn.cn/" target="_blank" rel="noopener noreferrer">阿楠sneaker</a></span><span property="author" content="阿楠sneaker"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022年7月30日</span><meta property="datePublished" content="2022-07-30T08:51:46.000Z"></span><!----><!----><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down" localizeddate="2022年7月30日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 93 分钟</span><meta property="timeRequired" content="PT93M"></span><span class="words-info" aria-label="字数🔠" data-balloon-pos="down" localizeddate="2022年7月30日" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 27996 字</span><meta property="wordCount" content="27996"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-1-代码如何执行-字节码执行案例" class="router-link-active router-link-exact-active toc-link level2">11.1 代码如何执行：字节码执行案例</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-执行的基础-java-虚拟机常用指令介绍" class="router-link-active router-link-exact-active toc-link level2">11.2 执行的基础：Java 虚拟机常用指令介绍</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-1-常量入栈指令" class="router-link-active router-link-exact-active toc-link level3">11.2.1 常量入栈指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-2-局部变量压栈指令" class="router-link-active router-link-exact-active toc-link level3">11.2.2 局部变量压栈指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-3-出栈装入局部变量表指令" class="router-link-active router-link-exact-active toc-link level3">11.2.3 出栈装入局部变量表指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-4-通用型操作" class="router-link-active router-link-exact-active toc-link level3">11.2.4 通用型操作</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-5-类型转换指令" class="router-link-active router-link-exact-active toc-link level3">11.2.5 类型转换指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-6-运算指令" class="router-link-active router-link-exact-active toc-link level3">11.2.6 运算指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-7-对象操作指令" class="router-link-active router-link-exact-active toc-link level3">11.2.7 对象操作指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-8-比较控制指令" class="router-link-active router-link-exact-active toc-link level3">11.2.8 比较控制指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-9-函数调用与返回指令" class="router-link-active router-link-exact-active toc-link level3">11.2.9 函数调用与返回指令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-10-同步控制" class="router-link-active router-link-exact-active toc-link level3">11.2.10 同步控制</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-2-11-再看-class-的方法结构" class="router-link-active router-link-exact-active toc-link level3">11.2.11 再看 Class 的方法结构</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-3-更上一层楼-再看-asm" class="router-link-active router-link-exact-active toc-link level2">11.3 更上一层楼：再看 ASM</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-3-1-为类增加安全控制" class="router-link-active router-link-exact-active toc-link level3">11.3.1 为类增加安全控制</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-3-2-统计函数执行时间" class="router-link-active router-link-exact-active toc-link level3">11.3.2 统计函数执行时间</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-4-谁说-java-太刻板-java-agent-运行时修改类" class="router-link-active router-link-exact-active toc-link level2">11.4 谁说 Java 太刻板：Java Agent 运行时修改类</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-4-1-使用-javaagent-参数启动-java-虚拟机" class="router-link-active router-link-exact-active toc-link level3">11.4.1 使用 -javaagent 参数启动 Java 虚拟机</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-4-2-使用-java-agent-为函数增加计时功能" class="router-link-active router-link-exact-active toc-link level3">11.4.2 使用 Java Agent 为函数增加计时功能</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-4-3-动态重转换类" class="router-link-active router-link-exact-active toc-link level3">11.4.3 动态重转换类</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-4-4-有关-java-agent-的总结" class="router-link-active router-link-exact-active toc-link level3">11.4.4 有关 Java Agent 的总结</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-5-与时俱进-动态方法调用" class="router-link-active router-link-exact-active toc-link level2">11.5 与时俱进：动态方法调用</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-5-1-方法句柄使用实例" class="router-link-active router-link-exact-active toc-link level3">11.5.1 方法句柄使用实例</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-5-2-调用点使用实例" class="router-link-active router-link-exact-active toc-link level3">11.5.2 调用点使用实例</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-5-3-反射和方法句柄" class="router-link-active router-link-exact-active toc-link level3">11.5.3 反射和方法句柄</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-5-4-指令-invokedynamic-使用实例" class="router-link-active router-link-exact-active toc-link level3">11.5.4 指令 invokedynamic 使用实例</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-6-跑得再快点-静态编译优化" class="router-link-active router-link-exact-active toc-link level2">11.6 跑得再快点：静态编译优化</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-6-1-编译时计算" class="router-link-active router-link-exact-active toc-link level3">11.6.1 编译时计算</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-6-2-变量字符串的连接" class="router-link-active router-link-exact-active toc-link level3">11.6.2 变量字符串的连接</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-6-3-基于常量的条件语句裁剪" class="router-link-active router-link-exact-active toc-link level3">11.6.3 基于常量的条件语句裁剪</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-6-4-switch-语句的优化" class="router-link-active router-link-exact-active toc-link level3">11.6.4 switch 语句的优化</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-7-提高虚拟机的执行效率-jit-及其相关参数" class="router-link-active router-link-exact-active toc-link level2">11.7 提高虚拟机的执行效率：JIT 及其相关参数</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-7-1-开启-jit-编译" class="router-link-active router-link-exact-active toc-link level3">11.7.1 开启 JIT 编译</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-7-2-jit-编译阈值" class="router-link-active router-link-exact-active toc-link level3">11.7.2 JIT 编译阈值</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-7-3-多级编译器" class="router-link-active router-link-exact-active toc-link level3">11.7.3 多级编译器</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-7-4-osr-栈上替换" class="router-link-active router-link-exact-active toc-link level3">11.7.4 OSR 栈上替换</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-7-5-方法内联" class="router-link-active router-link-exact-active toc-link level3">11.7.5 方法内联</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-7-6-设置代码缓存大小" class="router-link-active router-link-exact-active toc-link level3">11.7.6 设置代码缓存大小</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC11%E7%AB%A0%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C.html#_11-8-小结" class="router-link-active router-link-exact-active toc-link level2">11.8 小结</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="第-11-章-字节码执行" tabindex="-1"><a class="header-anchor" href="#第-11-章-字节码执行" aria-hidden="true">#</a> 第 11 章 字节码执行</h1><p>字节码执行是 Java 虚拟机的重点，就如同汇编语言对于计算机一样重要，字节码对于 Java 虚拟机来说是执行的根本。当 Java 源码被编译成 Class 文件后，虚拟机就会将 Class 文件内的方法字节码载入系统并加以执行。本章将详细介绍虚拟机的指令系统、执行机制及相关配置参数。</p><p>本章涉及的主要知识点有：</p><ul><li><p>使用 javap 查看 Class 文件信息。</p></li><li><p>了解字节码执行过程。</p></li><li><p>熟悉常用字节码。</p></li><li><p>学习 JIT 相关参数配置。</p></li><li><p>通过 ASM 增强方法的功能。</p></li><li><p>使用 Java Agent 动态修改字节码。</p></li></ul><h2 id="_11-1-代码如何执行-字节码执行案例" tabindex="-1"><a class="header-anchor" href="#_11-1-代码如何执行-字节码执行案例" aria-hidden="true">#</a> 11.1 代码如何执行：字节码执行案例</h2><p>Java 字节码对于虚拟机，就好像汇编语言对于计算机，属于基本执行指令。每一个 Java 字节码指令是一个 byte 数字，并且有一个对应的助记符。目前大约有 200 余个字节码指令。下面列举了部分字节码及其对应的助记符：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>_nop          = 0,      // 0x00 
_aconst_null  = 1,      // 0x01 
_iconst_0     = 3,      // 0x03 
_iconst_1     = 4,      // 0x04 
_dconst_1     = 15,     // Ox0f 
_bipush       = 16,     // 0x10 
_iload_0      = 26,     // Ox1a 
_iload_1      = 27,     // Ox1b 
_aload_0      = 42,     // 0x2a 
_istore       = 54,     // 0x36 
_POP          = 87,     // 0x57 
_imul         = 104,    // 0x68 
_idiv         = 108,    // 0x6c
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>方法的 Java 字节码指令被编译到 Java 方法的 Code 属性中，如果想要查看指令的具体内容，可以使用 JDK 自带的 javap 工具。javap 的常用参数如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>用法：javap &lt;options&gt; &lt;classes&gt; 
其中的选项包括：

-version      版本信息
-v -verbose   输出附加信息
-l            输出行号和本地变量表
-public       仅显示公共类和成员
-protected    显示受保护的 / 公共类和成员
-package      显示程序包 / 受保护的 / 公共类和成员（默认）
-p -private   显示所有类和成员
-c            对代码进行反汇编
-s            输出内部类型签名
-sysinfo      显示正在处理的类的系统信息（路径、大小、日期、MD5 散列）
-constants    显示静态最终常量
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>【示例 11-1】下面以一段简单的 Java 代码为例，演示 javap 的使用方法。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Calc</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> 
        <span class="token keyword">return</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span> <span class="token operator">/</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用 javap 显示这段代码的信息，命令和返回信息如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>javap -v geym\zbase\ch11\calc\Calc
Compiled from &quot;Calc.java&quot;
public class geym.zbase.ch11.calc.Calc extends java.lang.Object
SourceFile: &quot;Calc.java&quot;
minor version: 0
major version: 51
Constant pool:
const #1 = class         #2;  // geym/zbase/ch11/calc/Calc
const #2 = Asciz         geym/zbase/ch11/calc/Calc;
const #3 = class         #4;  // java/lang/Object
const #4 = Asciz         java/lang/Object;
const #5 = Asciz         &lt;init&gt;;
const #6 = Asciz         ()V;
const #7 = Asciz         Code;
const #8 = Method        #3.#9;  // java/lang/Object.&quot;&lt;init&gt;&quot;:
const #9 = NameAndType   #5:#6;  // &quot;&lt;init&gt;&quot;:()V
const #10 = Asciz        LineNumberTable;
const #11 = Asciz        LocalVariableTable;
const #12 = Asciz        this;
const #13 = Asciz        Lgeym/zbase/ch11/calc/Calc;;
const #14 = Asciz        calc;
const #15 = Asciz        ()I；
const #16 = Asciz        a;
const #17 = Asciz        I;
const #18 = Asciz        b;
const #19 = Asciz        c;
const #20 = Asciz        SourceFile;
const #21 = Asciz        Calc.java;
{
public geym.zbase.ch11.calc.Calc();
Code:
Stack=1, Locals=1, Args_size=1
0:   aload_0
1:   invokespecial    #8; // Method java/lang/Object.&quot;&lt;init&gt;&quot;
4:   return
LineNumberTable:
line 3: 0

LocalVariableTable:
Start  Length  Slot  Name  Signature
0      5       0     this   Lgeym/zbase/ch11/calc/Calc;

public int calc();
Code:
Stack=2, Locals=4, Args_size=1
0:   sipush 500
3:   istore_1
4:   sipush 200
7:   istore_2
8:   bipush 50
10:  istore_3
11:  iload_1
12:  iload_2
13:  iadd
14:  iload_3
15:  idiv
16:  ireturn
LineNumberTable:
line 5: 0
line 6: 4
line 7: 8
line 8: 11

LocalVariableTable:
Start  Length  Slot  Name  Signature
0      17	   0     this  Lgeym/zbase/ch11/calc/Calc;
4      13	   1     a     I
8      9	   2     b     I
11     6	   3     c     I
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上述代码可以看出，这段简单的 Java 程序被反编译后生成了大量的信息。</p><p>首先，显示了生成这个 Class 文件的 Java 源文件名称、小版本号和大版本号。接着，显示了这个类中所有的常量，这里有 21 项常量。此外，还显示了两个方法信息：第一个方法为类的构造函数，是编译器自动插入的；第二个方法为 calc() 方法，在方法体内，显示了栈大小、局部变量表大小、字节码指令、行号、局部变量表等信息。</p><p>读者可以重点关注一下 calc() 方法的主体内容，即字节码部分（加粗代码），下面将仔细解读这段字节码的执行过程。</p><p>如图11.1 所示，左侧的字节码列表用加粗字体显示了正在执行的字节码，右侧分别显示了当前的局部变量表和操作数栈。在字节码部分，左侧的数字序号表示字节码偏移量，即当前字节码所在的位置，这看起来有点像行号，但它不是。字节码偏移量总是和前几个字节码的长度有关，第一条字节码为 sipush，自然其偏移量为 0。而 sipush 这条指令本身占用 1 字节，但它接收一个双字节的参数，故整个 sipush 指令合计为 3 字节。其后续指令 istore_1 所在位置在偏移量 3 处，而 istore_1 指令为 1 字节，且不接收参数，故合计为 1 字节，加上之前 sipush 的 3 字节，sipush 200 就在偏移量 4 的位置，依此类推。</p><p><img src="/assets/图11-1.7149e9e7.png" alt="图11-1" loading="lazy"></p><p>图11.1 字节码执行示意图 1</p><p>如图11.1 所示，在执行第一条指令的时候，局部变量表第 0 项为 this 引用，表示当前对象。为了能顺利访问 this 对象，Java 对于所有的非静态函数调用，都会将对象的引用放置在局部变量表的第 0 个槽位。指令 sipush 的作用是将给定的参数压入操作数栈，执行完 sipush 500 后，操作数栈中含有数字 500。在虚拟机的指令集中，还有一条指令为 bipush，也是完成相同的操作，但是 bipush 仅接收一个字节的参数，因此它只能处理 -128 ~ 127 的数字，这里的 500 己经超过了 bipush 的处理范围，故使用 sipush，它可以支持 -32768 ~ 32767 的数字。虚拟机通过这种细分的指令集，可以尽可能减少指令所占的空间，毕竟 sipush 要比 bipush 多占一个字节。</p><p>如图11.2 所示，虚拟机正在执行 istore_1 命令，store 命令是从操作数栈中弹出一个元素，并将其存放在局部变量表中。一般说来，类似 store 这样的命令需要带一个参数，用来指明将弹出的元素放在局部变量表的第几个位置。但是，为了尽可能压缩指令大小，使用专门的 istore_1 指令表示将弹出的元素放置在局部变量表的第 1 个位置。类似的还有 istore_0、istore_2、istore_3，它们分别表示从操作数栈顶弹出一个元素，存放在局部变量表第 0、2、3 个位置。局部变量表的前几个位置是常用的，因此这种做法虽然增加了指令数量，但是可以大大压缩生成的字节码的体积。如果局部变量表很大，需要存储的槽位大于 3，那么可以使用 istore 指令，外加一个参数表示需要存放的槽位。在这条指令执行完毕后，操作数栈被清空，局部变量表 1 的位置存入 500。</p><p><img src="/assets/图11-2.99302513.png" alt="图11-2" loading="lazy"></p><p>图11.2 字节码执行示意图 2</p><p>接着，执行 sipush 200 指令，将 200 压入操作数栈，如图11.3 所示。</p><p><img src="/assets/图11-3.e31b49f1.png" alt="图11-3" loading="lazy"></p><p>图11.3 字节码执行示意图 3</p><p>指令 istore2，将 200 存入局部变量的第 2 个位置，并清空操作数栈，如图11.4 所示。</p><p><img src="/assets/图11-4.74084fc6.png" alt="图11-4" loading="lazy"></p><p>图11.4 字节码执行示意图 4</p><p>指令 bipush 50 将 50 压入操作数栈，如图11.5 所示。</p><p><img src="/assets/图11-5.2bfddd42.png" alt="图11-5" loading="lazy"></p><p>图11.5 字节码执行示意图 5</p><p>指令 istore_3 将 50 弹出，并存放在局部变量表的第 3 个位置，如图11.6 所示。</p><p><img src="/assets/图11-6.607a8099.png" alt="图11-6" loading="lazy"></p><p>图11.6 字节码执行示意图 6</p><p>指令 iload_1 将局部变量表第 1 个位置的值压入操作数栈。和 store 指令类似，虚拟机也提供了一系列指令，如 iload_0、iload_2、iload_3 等，分别表示将局部变量表的第 0、2、3 个位置的值压入操作数栈。如果需要操作比较大的局部变量表，则可以使用 iload，外加一个参数来指明局部变量表的位置。在执行指令 iload_1 之后，操作数栈中栈顶元素为 500，如图11.7 所示。</p><p><img src="/assets/图11-7.e5d7067e.png" alt="图11-7" loading="lazy"></p><p>图11.7 字节码执行示意图 7</p><p>指令 iload_2 将第 2 个局部变量压入操作数栈，如图11.8 所示。</p><p><img src="/assets/图11-8.4ed96e0f.png" alt="图11-8" loading="lazy"></p><p>图11.8 字节码执行示意图 8</p><p>指令 iadd 表示加法操作，它从操作数栈中弹出两个元素做加法，并将结果再压回操作数栈，如图11.9 所示。</p><p><img src="/assets/图11-9.0939d170.png" alt="图11-9" loading="lazy"></p><p>图11.9 字节码执行示意图 9</p><p>指令 iload_3 将局部变量表第 3 个位置的 50 压入操作数栈，如图11.10 所示。</p><p><img src="/assets/图11-10.cf700590.png" alt="图11-10" loading="lazy"></p><p>图11.10 字节码执行示意图 10</p><p>指令 idiv 表示整数除法，它从操作数栈中弹出两个元素，相除后将结果压入操作数栈，如图11.11 所示。比 iadd 略显复杂的是，除法是需要考虑顺序的，idiv 的做法是用栈顶第 2 顺位的元素除以栈顶元素，此处为 700 / 50 = 14。</p><p><img src="/assets/图11-11.a998ad4e.png" alt="图11-11" loading="lazy"></p><p>图11.11 字节码执行示意图 11</p><p>然后，通过 ireturn 指令，将当前函数操作数栈的顶层元素弹出，并将这个元素压入调用者函数的操作数栈中（因为调用者非常关心函数的返回值），如图11.12 所示，所有在当前函数操作数栈中的其他元素都会被丢弃。如果当前返回的是 synchroinzed 方法，那么还会执行一个隐含的 monitorexit 指令，退出临界区。最后，会丢弃当前方法的整个帧，恢复调用者的帧，并将控制权转交给调用者。</p><p><img src="/assets/图11-12.e8843dec.png" alt="图11-12" loading="lazy"></p><p>图11.12 字节码执行示意图 12</p><h2 id="_11-2-执行的基础-java-虚拟机常用指令介绍" tabindex="-1"><a class="header-anchor" href="#_11-2-执行的基础-java-虚拟机常用指令介绍" aria-hidden="true">#</a> 11.2 执行的基础：Java 虚拟机常用指令介绍</h2><p>Java 虚拟机的字节码指令多达 200 余个，完全介绍和学习这些指令需要花费大量时间。为了让读者能够更快地熟悉和了解这些基本指令，本节对常用的指令做了归类整理，方便读者查阅。熟悉虚拟机的指令对于动态字节码生成、反编译 Class 文件、Class 文件修补都有非常重要的价值。</p><h3 id="_11-2-1-常量入栈指令" tabindex="-1"><a class="header-anchor" href="#_11-2-1-常量入栈指令" aria-hidden="true">#</a> 11.2.1 常量入栈指令</h3><p>常量入栈指令的功能是将常数压入操作数栈，根据数据类型和入栈内容的不同，可以分为 const 系列、push 系列和 ldc 指令。</p><p>const 系列指令用于特定的常量入栈，入栈的常量隐含在指令本身里。比如，aconst_null 将 null 压入操作数栈；iconst_m1将 -1 压入操作数栈；iconst_x（x 为 0 到 5）将 x 压入栈；lconst_0、lconst_1 分别将长整数 0 和 1 压入栈；fconst_0、fconst_1、fconst_2 分别将浮点数 0、1、2 压入栈；dconst_0 和 dconst_1 分别将 double 型 0 和 1 压入栈。从指令的命名上不难找出规律，指令助记符的第一个字符总是喜欢表示数据类型，i 表示整数，l 表示长整数，f 表示浮点数，d 表示双精度浮点数，习惯上用 a 表示对象引用。如果指令隐含操作的参数，会以下画线形式给出。</p><p>push 系列指令主要包括 bipush 和 sipush。它们的区别在于接收数据类型不同，bipush 接收 8 位整数，sipush 接收 16 位整数，它们都将参数压入栈。</p><p>如果以上指令都不能满足需求，那么可以使用万能的 ldc 指令，它可以接收一个 8 位的参数，该参数指向常量池中的 int、float 或者 String 类型的索引，将指定的内容压入堆栈。类似的还有 ldc_w，它接收两个 8 位参数，能支持的索引范围大于 ldc。如果要压入的元素是 long 或者 double 类型的，则使用 ldc2_w 指令，使用方式都是类似的。</p><p>以下代码使用了常量 100000.0d：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">100000.0d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>它产生的指令中就包含了 ldc2_w，如下所示，第 2 行为常量池第 27 项。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ldc2_w	#27
#27 = Double  100000.0d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-2-2-局部变量压栈指令" tabindex="-1"><a class="header-anchor" href="#_11-2-2-局部变量压栈指令" aria-hidden="true">#</a> 11.2.2 局部变量压栈指令</h3><p>局部变量压栈指令将给定的局部变量表中的数据压入操作数栈。这类指令大体可以分为 xload（x 为 i、l、f、d、a）、xload_n（x 为 i、l、f、d、a，n 为 0 到 3）、xaload（x 为 i、l、f、d、a、b、c、s）。在这里 x 表示数据类型，如表11.1 所示。</p><p>表11.1 x 所表示的数据类型</p><p><img src="/assets/表11-1.4c7e4832.png" alt="表11-1" loading="lazy"></p><p>指令 xload_n 顼表示将第 n 个局部变量压入操作数栈，比如 iload_1、fload_0、aload_0 等指令。其中 aload_n 表示将一个对象引用压入栈。</p><p>指令 xload 通过指定参数的形式，把局部变量压入操作数栈，当使用这个指令时，表示局部变量的数量可能超过了 4 个，比如指令 iload、fload 等。</p><p>指令 xaload 表示将数组的元素压入栈，比如 saload、caload 分别表示压入 short 数组和 char 数组。指令 xaload 在执行时，要求操作数中栈顶元素为数组索引 i，栈顶顺位第 2 个元素为数组引用 a，该指令会弹出栈顶这两个元素，并将 a[i] 重新压入栈。</p><p>【示例 11-2】以下面的代码为例。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print3</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cs<span class="token punctuation">,</span><span class="token keyword">short</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>cs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>生成的部分字节码如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: getstatic  #21
3: aload_2
4: iconst_0
5: saload
6: invokevirtual  #43
9: getstatic  #21
12: aload_1
13: iconst_0
14: caload
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意加粗部分，符合前文的描述，在 saload 执行前，先将数组引用压入栈（aload_2），再将索引压入栈（iconst_0），索引为 0。同理，在 caload 执行前，先将 char[] 数组压入栈（aload_1），然后将数组索引 0 压入栈（iconst_0），最后调用 caload 将第 0 位的数据压入操作数栈顶部。</p><h3 id="_11-2-3-出栈装入局部变量表指令" tabindex="-1"><a class="header-anchor" href="#_11-2-3-出栈装入局部变量表指令" aria-hidden="true">#</a> 11.2.3 出栈装入局部变量表指令</h3><p>出栈装入局部变量表指令用于将操作数栈中栈顶元素弹出后，装入局部变量表的指定位置，用于给局部变量赋值。这类指令主要以 store 的形式存在，比如 xstore（x 为 i、I、f、d、a）、xstore_n（x 为 i、l、f、d、a，n 为 0 到 3）和 xastore（x 为 i、l、f、d、a、b、c、s）。其中 x 的取值含义和 load 类命令是一样的，在此不再赘述。</p><p>指令 istore_1 将从操作数栈中弹出一个整数，并把它赋值给局部变量 1。由于指令 xstore 没有隐含参数信息，需要提供一个 byte 类型的参数类指定目标局部变量表的位置。xastore 则专门针对数组操作，以 iastore 为例，它用于给一个 int 数组的给定索引赋值。在 iastore 执行前，操作数栈顶需要准备 3 个元素：值、索引、数组引用，iastore 会弹出这 3 个值，并将值赋给数组中指定索引的位置。</p><p>【示例 11-3】以下面这段简单的代码为例。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print4</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cs<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> x<span class="token punctuation">;</span>
    x <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>
    s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">77</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它生成的字节码中包含 istore 和 iastore 指令。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: bipush 99
2: istore 6
4: aload_2
5: iconst_0
6: bipush 77
8: iastore
9: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，第 0 行字节码（实际上是字节码偏移量，为表述简单起见，使用行为单位，下同），压入常量 99，第 2 行 istore 将 99 弹出，并赋给局部变量表中第 6 个位置的变量，该变量正好是 x。接着在第 4、5、6 行分别压入 iastore 所需的 3 个参数，最后调用 iastore 将 77 赋值给局部变量表第 2 个位置的数组（int[] s）的第 0 个索引位置（s[0]）。</p><h3 id="_11-2-4-通用型操作" tabindex="-1"><a class="header-anchor" href="#_11-2-4-通用型操作" aria-hidden="true">#</a> 11.2.4 通用型操作</h3><p>从前面的几类指令中可以看到，大部分数据操作指令是和数据类型相关的。Java 虚拟机为不同的数据类型都量身定做了一系列指令。但是无类型的指令还是必要的，比如，就栈操作而言，不是在所有时刻对栈的压入或者弹出都必须明确数据类型。通用型操作就提供了这种无须指明数据类型的操作。</p><p>指令 nop 是一个非常特殊的指令，它的字节码为 0x00。和汇编语言中的 nop 一样，它表示什么都不做。这条指令一般可用于调试、占位等。</p><p>另外两个比较重要的指令是 dup 和 pop。指令 dup 意为 duplicate（复制），它会将栈顶元素复制一份并再次压入栈顶，这样栈顶就有两份一模一样的元素了。指令 pop 则把一个元素从栈顶弹出，并且直接废弃。</p><p>【示例 11-4】下面这段简单的代码是这两个指令的使用案例。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print5</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    obj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译成字节码后，其内容如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: new    #3  // class java/lang/Object
3: dup
4: invokespecial    #16  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V
7: astore_2
8: aload_2
9: invokevirtual    #58  // Method java/lang/Object.toString:()Ljava/lang/String;
12: pop
13: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了生成 Object 对象，使用了对象创建指令 new。创建完成后，指令 new 会把对象引用放置在栈顶，此时栈顶只有一份对象引用。但是，在指令 new 之后，对该 obj 对象连续进行两次操作：一次是通过 invokespecial 指令调用对象的构造函数，另一次是通过 astore_2 指令将对象赋值给 obj。这两个操作都会将栈顶元素弹出，为了连续两次使用同样的栈顶元素，这里使用指令 dup 复制了一份对象引用，供后面的指令使用。在 obj.toString() 方法执行完毕后，函数的返回值会出现在栈顶，但是由于没有人使用，所以简单地使用 pop 指令将无人问津的返回值直接丢弃，也实属合理。</p><p><strong>注意</strong>：pop 指令只能丢弃 1 个字长（32 位），如果要丢弃栈顶的 64 位数据（long 或者 double），则需要使用 pop2 指令，类似地，如果要连续复制栈顶 2 个字长（64 位数据），则可以使用 dup2 指令。</p><h3 id="_11-2-5-类型转换指令" tabindex="-1"><a class="header-anchor" href="#_11-2-5-类型转换指令" aria-hidden="true">#</a> 11.2.5 类型转换指令</h3><p>在软件开发过程中，类型转换是极为常用的功能。为了更好地支持类型转换，虚拟机提供了一整套专门用于类型转换的指令。这类指令的助记符基本上使用 x2y 的形式给出。其中 x 可能是 i、f、l、d，y 可能是 i、f、l、d、c、s、b。它们的含义如表11.2 所示。</p><p>表11.2 指令中字符的含义</p><p><img src="/assets/表11-2.6b80c499.png" alt="表11-2" loading="lazy"></p><p>比如，i2l 表示将 int 型数据转为 long 型数据。在执行指令 i2l 时，先将栈顶的 int 型数据弹出，然后进行转换，最后将转化后的 long 型数据压入，如图11.13 所示，转换后的 long 型数据占用两个字空间。</p><p><img src="/assets/图11-13.f6573651.png" alt="图11-13" loading="lazy"></p><p>图11.13 执行指令 i2l 和 l2i 前后操作数栈情况</p><p>【示例 11-5】下面这段代码演示这类指令的使用。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print6</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> l <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token keyword">float</span> f <span class="token operator">=</span> l<span class="token punctuation">;</span>
    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> l<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其字节码如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: iload_1
1: i2l
2: lstore_2
3: lload_2
4: l2f
5: fstore 4
7: lload_2
8: l2i
9: istore 5
11: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从字节码加粗部分不难看出，int 类型转换为 long 类型使用了 i2l，long 类型转换为 float 类型使用了 l2f，long 类型转换为 int 类型使用了 l2i。</p><p>细心的读者也不难发现，在这些转换指令中，只有 i2b、i2c、i2s，没有 b2i、c2i、s2i。也就是说，没有从 byte、char 或是 short 类型转换为其他数据类型的指令，这不免让人心生疑虑。来看如下代码：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print7</span><span class="token punctuation">(</span><span class="token keyword">byte</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> k <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token keyword">long</span> l <span class="token operator">=</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这段代码把一个 byte 类型转为了 int 类型和 long 类型。如果没有 b2i 和 b2l，这是如何做到的呢？以下是这段代码的字节码：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: iload_1    // i 压入栈
1: istore_2   // i 赋值给 k
2: iload_1    // i 入栈
3: i2l        // i 转为 long
4: lstore_3   // long 賦值给 l
5: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，对于 byte 类型转为 int 类型，虚拟机并没有做实质性的转化处理，只是简单地通过操作数栈交换了两个数据。而将 byte 类型转为 long 类型时，使用的是 i2l，可以看到在内部 byte 类型在这里己经等同于 int 类型处理，类似的还有 short 类型，这种处理方式有两个特点：</p><ul><li><p>一方面可以减少实际的数据类型，如果为 short 和 byte 类型都准备一套指令，那么指令的数量就会大增，而虚拟机目前只愿意使用一个字节表示指令，因此指令总数不能超过 256 个，为了节省指令资源，将 short 类型和 byte 类型当作 int 类型处理也在情理之中。</p></li><li><p>另一方面，由于局部变量表中的槽位固定为 32 位，无论是 byte 类型还是 short 类型存入局部变量表，都会占用 32 位空间。从这个角度说，也没有必要特意区分这几种数据类型。</p></li></ul><h3 id="_11-2-6-运算指令" tabindex="-1"><a class="header-anchor" href="#_11-2-6-运算指令" aria-hidden="true">#</a> 11.2.6 运算指令</h3><p>运算指令为 Java 虚拟机提供了基本的加减乘除等运算功能。基本运算可以分为加法、减法、乘法、除法、取余、数值取反、位运算、自增运算。每一个指令也有自己支持的数据类型，与前文所述的指令类似，将数据类型使用一个字符表示。</p><ul><li><p>加法指令有：iadd、ladd、fadd、dadd。</p></li><li><p>减法指令有：isub、lsub、fsub、dsub。</p></li><li><p>乘法指令有：imul、lmul、fmul、dmul。</p></li><li><p>除法指令有：idiv、ldiv、fdiv、ddiv。</p></li><li><p>取余指令有：irem、lrem、frem、drem。</p></li><li><p>数值取反有：ineg、lneg、fheg、dneg。</p></li><li><p>自增指令：iinc。</p></li><li><p>位运算指令，又可分为如下几种。</p><ul><li>位移指令：ishl、ishr、iushr、lshl、lshr、lushr。</li><li>按位或指令：ior、lor。</li><li>按位与指令：iand、land。</li><li>按位异或指令：ixor、lxor。</li></ul></li></ul><p>以乘法指令为例，imul 表示从操作数栈中弹出两个整数，将它们相乘，将结果再压入栈。指令 Imul 表示对 long 型数据的操作，fmul 表示对 float 型数据的操作，dmul 表示对 double 型数据的乘法，依此类推。</p><p>取余指令用于计算两个数相除后的余数，比如 i % j 就会产生 irem 指令。</p><p>【示例 11-6】数值取反指令改变数字的符号位，比如以下 Java 代码，会产生两个 fneg。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">float</span> i <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> j <span class="token operator">=</span> <span class="token operator">-</span>i<span class="token punctuation">;</span>
i <span class="token operator">=</span> <span class="token operator">-</span>j；
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>生成的字节码如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: ldc  #73  // float 8.0f
2: fstore_1
3: fload_1
4: fneg
5: fstore_2
6: fload_2
7: fneg
8: fstore_1
9: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>指令 fheg 执行前后，操作数栈没有变化，只是栈顶的元素符号位被取反。</p><p>指令 iinc 对给定的局部变量做自增操作，这条指令是少数几个执行过程中完全不修改操作数栈的指令。它接收两个操作数：第 1 个为局部变量表的位置，第 2 个为累加数。比如常见的 i++，就会产生这条指令。</p><p>【示例 11-7】以下代码对局部变量 i 累加 10 次。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print11</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
    i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上代码产生的字节码如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: bipush  123
2: istore_2
3: iinc  2, 10
6: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于参数中 this、j 占据了局部变量表的第 0 和第 1 个位置，故i处于第 2 个位置。</p><p>【示例 11-8】位运算指令由位运算符产生，比如左移 &lt;&lt;、无符号右移 &gt;&gt;&gt;、右移 &gt;&gt;、按位或 |、按位与 &amp;、异或 ^、按位取反 ~ 等。不难发现，除了按位取反，其他位运算都有对应的指令。那么按位取反又是如何做到的呢？以下面的代码为例：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token operator">~</span>i<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>生成的字节码如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: bipush  123
2: istore_1
3: iload_1
4: iconst_m1
5: ixor
6: istore_2
7: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，ixor 为整数的按位异或操作，它从栈中弹出两个整数，并将它们按位异或，将结果再压入栈中。可以看到，在 ixor 执行前，压入栈中的数字为 i = 123 及 -1（iconst_m1），在虚拟机中，按位取反是通过与 -1 异或计算得来的。</p><p><strong>注意</strong>：-1 的 2 进制表示为一个全 1 的数字 0xFF，任何数字与 0xFF 异或后，自然取反。</p><h3 id="_11-2-7-对象操作指令" tabindex="-1"><a class="header-anchor" href="#_11-2-7-对象操作指令" aria-hidden="true">#</a> 11.2.7 对象操作指令</h3><p>Java 是面向对象的程序设计语言，虚拟机平台从字节码层面就对面向对象做了深层次的支持。有一系列指令专门用于对象操作，可进一步细分为创建指令、字段访问指令、类型检査指令、数组操作指令。</p><ol><li><p>创建指令</p><p>创建指令可以用于创建对象，由于对象在 Java 中的广泛使用，这些指令的使用频率也非常高。创建指令主要有 new、newarray、anewarray 和 multianewarray。</p><p>指令 new 用于创建普通对象。它接收一个操作数，为指向常量池的索引，表示要创建的类型，执行完成后，将对象的引用压入栈。</p><p>【示例 11-9】指令 newarray 和 anewarray 用来创建数组。前者用于创建基本类型的数组，后者用于创建对象数组。指令 multianewarray 用于创建多维数组。比如以下代码：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> intarray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objarray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mintarray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这段代码创建了一个 int 数组，一个 Object 数组和一个 int 二维数组，它依次使用了 newarray、anewarray 和 multianewarray。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: bipush    10
2: newarray    int
4: astore_1
5: bipush    10
7: anewarray    #3  // class java/lang/Object
10: astore_2
11: bipush    10
13: bipush    10
15: multianewarray    #81, 2  // class &quot;[[I&quot;
19: astore_3
20: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>字段访问指令</p><p>字段访问指令专门用于访问类或者对象的字段。主要有 getfield、putheld、getstatic、putstatic 4 个。其中，getfield、putfield 用于操作实例对象的字段，getstatic、putstatic 用于操作类的静态字段。以 getstatic 指令为例，它含有一个操作数，为指向常量池的 Fieldref 索引，它的作用就是获取 Fieldref 指定的对象或者值，并将其压入操作数栈（有关 Fieldref 的详细信息，请参阅第 9 章）。</p><p>以下是常用的控制台输出语句：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Java 编译器会为这条语句产生如下 getstatic 指令，用于将 System.out 这个静态字段压入操作数栈。这段指令显示，常量池第 21 号为 Fieldref，它指向 System.out 静态字段，字段类型为 java/io/PrintStream。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: getstatic  #21  // Field java/lang/System.out:Ljava/io/PrintStream;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>类型检查指令</p><p>类型检查指令主要有两个：checkcast 和 instanceof。指令 checkcast 用于检查类型强制转换是否可以进行。如果可以进行，那么 checkcast 指令不会改变操作数栈，否则它会抛出 ClassCastException 异常。指令 instanceof 用来判断给定对象是否是某一个类的实例，它会将判断结果压入操作数栈。</p><p>【示例 11-10】以下代码是 checkcast 和 instanceof 指令的实例。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">chackcast</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面代码使用了 instanceof 关键字，并使用了强制转换，它们分别会产生 instanceof 和 checkcast 两个字节码。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: aload_1
1: instanceof    #95  // class java/lang/String
4: ifeq    12
7: aload_1
8: checkcast    #95  // class java/lang/String
11: areturn
12: aconst_null
13: areturn
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，它们都接收一个操作数，并判断栈顶层元素是否可以转为该操作数给定的类型。</p></li><li><p>数组操作指令</p><p>数组操作指令主要有前文介绍过的 xastore 和 xaload，这里不再赘述。此外，还有一个取数组长度的指令 arraylength，该指令弹出栈顶的数组元素，获取数组的长度，将长度压入栈。</p></li></ol><h3 id="_11-2-8-比较控制指令" tabindex="-1"><a class="header-anchor" href="#_11-2-8-比较控制指令" aria-hidden="true">#</a> 11.2.8 比较控制指令</h3><p>程序流程离不开条件控制，为了支持条件跳转，虚拟机提供了大量字节码指令，大体上可以分为比较指令、条件跳转指令、比较条件跳转指令、多条件分支跳转指令、无条件跳转指令等。</p><ol><li><p>比较指令</p><p>比较指令的作用是比较栈顶两个元素的大小，并将比较结果入栈。比较指令有 dcmpg、dcmpl、fcmpg、fcmpl、lcmp。与前文讲解的指令类似，首字符 d 表示 double 类型，f 表示 float 类型，l 表示 long 类型。对于 double 类型和 float 类型的数字，由于 NaN 的存在，各有两个版本的比较指令，以 float 类型为例，有 fcmpg 和 fcmpl 两个指令，它们的区别在于，在进行数字比较时，若遇到 NaN 值，处理结果不同。</p><p>指令 fcmpg 和 fcmpl 都从栈中弹出两个操作数，并将它们做比较，设栈顶的元素为 v2，栈顶顺位第 2 位的元素为 v1，若 v1 = v2 则压入 0，若 v1 &gt; v2 则压入 1，若 v1 &lt; v2 则压入 -1。两个指令的不同之处在于，如果遇到 NaN 值，fcmpg 会压入 1，而 fbmpl 会压入 -1。</p><p>指令 dcmpl 和 dcmpg 也是类似的，根据其命名可以推测其含义，在此不再赘述。指令 Icmp 针对 long 型整数，由于 long 型整数没有 NaN 值，故无须准备两套指令。</p></li><li><p>条件跳转指令</p><p>条件跳转指令通常和比较指令结合使用。条件跳转指令有 ifeq、iflt、ifle、ifne、ifgt、ifge、ifnull、ifnonnull 这些指令都接收两个字节的操作数，用于计算跳转的位置（16 位符号整数作为当前位置的 offset）。它们的统一含义为：弹出栈顶元素，测试它是否满足某一条件，如果满足条件，则跳转到给定位置。在条件跳转指令执行前，一般可以先用比较指令进行栈顶元素的准备，然后进行条件跳转。</p><p>【示例 11-11】请看以下代码：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">float</span> f1 <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> f2 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>f1 <span class="token operator">&gt;</span> f2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上代码产生的指令如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: ldc    #38;  // float 9.0f
2: fstore_1
3: ldc    #39;  // float 10.0f
5: fstore_2
6: getstatic    #15;  // Field java/lang/System.out:Ljava/io/PrintStream;
9: fload_1
10: fload_2
11: fcmpl
12: ifle    19
15: iconst_1
16: goto    20
19: iconst_0
20: invokevirtual    #30; // Method java/io/PrintStream.println:(Z)V
23: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，第 9 行和第 10 行在栈顶准备了两个比较元素。第 11 行对栈顶两个元素进行比较，第 12 行的 ifle 获取栈顶的结果，并确认是否需要跳转。</p></li><li><p>比较条件跳转指令</p><p>比较条件跳转指令类似于比较指令和条件跳转指令的结合体，它将比较和跳转两个步骤合二为一，这类指令有 if_cmpeq、if_cmpne、if_cmplt、if_cmpgt、if_cmple、if_icmpge、if_acmpeq 和 if_acmpne。其中指令助记符加上 &quot;if_&quot; 后，以字符 &quot;i&quot; 开头的指令针对 int 型整数操作（也包括 short 和 byte 类型），以字符 &quot;a&quot; 开头的指令表示对象引用的比较。</p><p>这些指令都接收两个字节的操作数作为参数，用于计算跳转的位置。同时在执行指令时，栈顶需要准备两个元素进行比较。指令执行完成后，栈顶的这两个元素被清空，且没有任何数据入栈。如果预设条件成立，则执行跳转，否则继续执行下一条语句。</p><p>【示例 11-12】以下面的代码为例，比较 short 和 byte 类型的两个数字的大小。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">short</span> f1 <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token keyword">byte</span> f2 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>f1 <span class="token operator">&gt;</span> f2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>生成的字节码如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: bipush    9
2: istore_1
3: bipush 10
5: istore_2
6: getstatic    #15;  // Field java/lang/Systern.out:Ljava/io/PrintStream;
9: iload_1
10: iload_2
11: if_icmple    18
14: iconst_1
15: goto    19
18: iconst_0
19: invokevirtual    #30;  // Method java/io/PrintStream.println:(Z)V
22: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，第 9 行和第 10 行将需要比较的数字压入栈，第 11 行执行比较，如果条件成立则跳转到第 18 行，输出 0，否则继续执行后一条指令，即输入 1。</p><p>【示例 11-13】如果比较的元素是对象，那么就会使用 if_acmpeq 和 if_acmpne 指令。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Object</span> f1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span> f2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>fl <span class="token operator">==</span> f2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>fl <span class="token operator">!=</span> f2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上代码生成的部分指令为（篇幅所限，没有给出完整指令）：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>19: aload_1
20: aload_2
21: if_acmpne    28
24: iconst_1
25: goto    29
...
35: aload_1
36: aload_2
37: if_acmpeq    44
40: iconst_1
41: goto    45
44: iconst_0
45: invokevirtual    #30;  // Method java/io/PrintStream.println:(Z)V
48: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中第 9、10 行和第 35、36 行分别压入栈顶元素进行比较，第 21 行和第 37 行执行对象引用的比较，并确认是否需要跳转。</p></li><li><p>多条件分支跳转指令</p><p>多条件分支跳转指令是专为 switch-case 语句设计的，主要有 tableswitch 和 lookupswitch。从助记符上看，两者都是 switch 语句的实现，它们的区别在于，tableswitch 要求多个条件分支值是连续的，它内部只存放起始值和终止值，以及若干个跳转偏移量，通过给定的操作数 index，可以立即定位到跳转偏移量位置，因此效率比较高。指令 lookupswitch 内部存放着各个离散的 case-offset 对，每次执行都要搜索全部的 case-offset 对，找到匹配的 case 值，并根据对应的 offset 计算跳转地址，因此效率较低。</p><p>指令 tableswitch 的示意图如图11.14 所示。由于 tableswitch 的 case 值是连续的，所以只需要记录最低值和最高值，以及每一项对应的 offset 偏移量，根据给定的 index 值通过简单的计算即可直接定位到 offset。</p><p><img src="/assets/图11-14.0f831dcc.png" alt="图11-14" loading="lazy"></p><p>图11.14 指令 tableswitch 的示意图</p><p>指令 lookupswitch 处理的是离散的 case 值，但是出于效率考虑，将 case-offset 对按照 case 值大小排序，给定 index 时，需要查找与 index 相等的 case，获得其 offset，如果找不到则跳转到 default。指令 lookupswitch 的示意图如图11.15 所示。</p><p><img src="/assets/图11-15.e4957296.png" alt="图11-15" loading="lazy"></p><p>图11.15 指令 lookupswitch 的示意图</p><p>【示例 11-14】下面以几个代码片段为例，介绍这两个指令的具体使用方式。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">swtich1</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码对 i 进行分支判断，产生的字节码如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: iload_1
1: tableswitch{ // 1 to 3
        1: 28;
        2: 31;
        3: 34;
        default: 34 }
28: goto    34
31: goto    34
34: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，由于 case 值是连续的，编译器生成了 tableswitch 指令来处理 switch 语句。</p><p>再来看第 2 段代码：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">swtich2</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">100</span><span class="token operator">:</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">200</span><span class="token operator">:</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">300</span><span class="token operator">:</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，case 值为不连续的，无法使用 tableswitch 处理，因此生成了 lookupswitch 指令。形式上 lookupswitch 和 tableswitch 非常类似，但是从字节码体积上看，lookupswitch 需要占用更多的空间。这非常容易理解，因为 lookupswitch 需要为每一种情况分别保存 case-offset 的值，但是 tableswitch 为每一个分支只保存了 offset。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: iload_1
1: lookupswitch{ // 3
        100: 36;
        200: 39;
        300: 42;
        default: 42 }
36: goto    42
39: goto    42
42: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>【示例 11-15】在 JDK 1.7 后，swtich 语句得到了增强，目前已经支持使用字符串进行 switch 操作。而字符串的 switch-case 语句是通过 lookupswitch 指令来实现的。以下面代码为例：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">swtich4</span><span class="token punctuation">(</span><span class="token class-name">String</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">&quot;geym&quot;</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">&quot;zbase&quot;</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">&quot;java&quot;</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码用字符串作为 switch 对象，它所生成的字节码如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: aload_1
1: dup
2: astore_2
3: invokevirtual    #51;  // Method java/lang/String.hashCode:()I
6: lookupswitch{ // 3
         3169394: 40;
         3254818: 52;
         115685963: 64;
         default: 73 }
40:  aload_2                                                      
41:  ldc    #57;  //String geym
43:  invokevirtual    #59;  // Method java/lang/String.equals:(Ljava/lang/Object;)Z
46:  ifne    73
49:  goto    73
52:  aload_2                                                      
53:  ldc    #63;  // String java
55:  invokevirtual    #59;  // Method java/lang/String.equals: (Ljava/lang/Object;)Z
58:  ifne    73
61:  goto    73
64:  aload_2                                                      
65:  ldc    #65;  // String zbase
67:  invokevirtual    #59; //Method java/lang/String.equals: (Ljava/lang/Object;)Z
70:  ifne    73
73:  return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，为了支持对 String 类型的 switch 操作，在字节码第 3 行（实为偏移量，用行简化描述）调用了字符串的 hashCode() 方法，得到 int 类型整数。在 lookupswitch 指令中，实际使用该 hash 值作为分支的 case。如果 hash 值不匹配，则字符串也不匹配，因此可以直接执行 default 处的指令，但如果 hash 值匹配，考虑到 hash 冲突的存在，这里并没有立即执行匹配后的指令，而是对匹配的项进行二次确认，在第 43 行使用 String.equals() 函数判断字符串是否真的相等。如果确实相等，则执行对应的语句，否则退出。由此可见，当使用 String 作为 case 类型时，虚拟机要执行 hash 计算及判断字符串是否相等，性能必然要低于直接对 int 类型的处理。</p></li><li><p>无条件跳转指令</p><p>目前主要的无条件跳转指令为 goto。指令 jsr、ret 虽然也是无条件跳转的，主要用于 try-finally 语句，且已经被虚拟机逐渐废弃，故不在本书中介绍。指令 goto 接收两个字节的操作数，共同组成一个带符号的整数，用于指定指令的偏移量，指令执行的目的就是跳转到偏移量给定的位置。如果指令偏移量太大，超过双字节的带符号整数的范围，则可以使用指令 goto_w，它和 goto 有相同的作用，但是它接收 4 个字节的操作数，可以表示更大的地址范围。</p></li></ol><h3 id="_11-2-9-函数调用与返回指令" tabindex="-1"><a class="header-anchor" href="#_11-2-9-函数调用与返回指令" aria-hidden="true">#</a> 11.2.9 函数调用与返回指令</h3><p>为了支持函数调用和返回值的处理，虚拟机提供了一系列基本指令。就函数调用而言，有指令 invokevirtual、invokeinterface、invokespecial、invokestatic 和 invokedynamic。在函数返回时，需要将返回值压入调用者操作数栈，此时需要使用 xreturn 指令（x 可以是 i、l、f、d、a 或空）。</p><p>这些invokeAXY指令都是进行函数调用的，但是各自都有自己的使用范围。</p><ul><li><p>invokevirtual：虚函数调用，调用对象的实例方法，根据对象的实际类型进行派发，支持多态，也是最常见的 Java 函数调用方式。</p></li><li><p>invokeinterface：指接口方法的调用，当被调用对象声明为接口时，使用该指令调用接口的方法。</p></li><li><p>invokespecial：调用一些特殊的函数，比如构造函数、类的私有方法、父类方法。这些方法都是静态类型绑定的，不会在调用时进行动态派发。</p></li><li><p>invokestatic：调用类的静态方法，这个也是静态绑定的。</p></li><li><p>invokedynamic：调用动态绑定的方法，这个是 JDK 1.7 后新加入的指令，该指令的具体介绍请参考 11.5 节。</p></li></ul><p>函数调用结束前，需要进行返回。返回时，需要使用 xretum 指令将返回值存入调用者的操作数栈中。根据返回值类型的不同，该指令的前缀有所不同，当返回值为 int 类型时，使用指令 ireturn，当返回值为 void 时，使用指令 return。该指令被调用时，如果方法是同步的，那么调用后，监视器锁将被释放。</p><p>【示例 11-16】下面通过几个代码片段来理解一下这几个指令的使用方式。</p><p>首先，来介绍一下指令 invokevirtual 的使用。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;aa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>以上语句会产生：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: getstatic    #16;  // Field java/lang/System.out:Ljava/io/PrintStream;
3: ldc    #22;  // String aa
5: invokevirtual    #24;  // Method java/io/PrintStream.println:(Ljava/lang/String;)V 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意指令 invokevirtual，它调用了 PrintStream 实例的 println() 方法。在调用前，操作数栈中将压入调用对象的实例，以及该方法的所有参数。在本例中为 System.out 实例和字符 &quot;aa&quot;。指令 invokevirtual 需要两个字节的操作数，用于计算指向常量池的索引，这里索引必须指向 CONSTANT_Methodref 入口，表示需要调用的方法。</p><p>指令 invokeinterface 调用接口的方法。比如：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
t<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span><span class="token punctuation">)</span> t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码生成了 Thread 对象，并调用了它的 run() 方法。Thread 类实现了 Runnable 接口。这里使用两种方式调用 run() 方法：第 1 种直接在 Thread 声明的实例上调用；第 2 种将其转为接口类型 Runnable，再进行调用。这两种调用方式使用的 invoke 指令是不同的，如下所示：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: new    #45;  // class java/lang/Thread
3: dup                                                                    
4: invokespecial    #47;  // Method java/lang/Thread.&quot;&lt;init&gt;&quot;:()V
7: astore_1                                                               
8: aload_1                                                                
9: invokevirtual    #48;  // Method java/lang/Thread.run:()V
12: aload_1                                                                
13: invokeinterface    #51, 1;  // InterfaceMethod java/lang/Runnable.run:()V
18: return      
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第 9 行使用 invokevirtual 指令，是直接针对 Thread 对象的调用，第 13 行则是针对 Runnable 接口的调用。和 invokevirtual 不同，invokeinterface 在调用时需要额外传入 1 个字节的无符号整数，表示这次函数调用所需参数的字数（1 字为 32 位），包含隐含的 this。在本例中，函数没有参数，只需要当前引用 this，故字数为 1。</p><p>指令 invokespecial 用于调用特殊的函数。比如，调用类的构造函数、私有方法或者父类方法时都会使用该指令。该指令接收两个字节的操作数，用于计算常量池索引入口，且该入口必须为 CONSTANT_Methodref。此外，在调用时，必须在操作数栈中准备好对象实例、函数参数等信息。</p><p>一次简单的对象实例创建，就需要调用构造函数，比如：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Date</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>以上语句会产生：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: new    #31;  // class java/util/Date
3: dup
4: invokespecial    #33;  // Method java/util/Date.&quot;&lt;init&gt;&quot;:()V
7: astore_1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，使用指令 invokespecial 调用了 Date 类的构造函数。</p><p>【示例 11-17】下面再来看一个调用类的私有方法的例子。由于类的私有方法不具有多态性，即使在子类中有相同签名的私有方法，也不能覆盖父类中对应的私有方法的行为，因此对于私有方法的调用可以使用静态绑定。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invokeSpecial2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上代码调用 pMethod() 私有方法，它产生的字节码如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: aload_0
1: invokespecial    #37; // Method pMethod:()V
4: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此外，调用父类方法时也使用 invokespecial，比如：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>会生成：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: aload_0
1: invokespecial    #40;  // Method java/lang/Object.toString:()Ljava/lang/String;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，invokespecial 在调用父类方法，通过操作数直接指向父类的 toString() 方法，从而避免了子类 toString() 方法的使用。</p><h3 id="_11-2-10-同步控制" tabindex="-1"><a class="header-anchor" href="#_11-2-10-同步控制" aria-hidden="true">#</a> 11.2.10 同步控制</h3><p>为了实现多线程的同步，Java虚拟机还提供了 monitorenter、monitorexit 来完成临界区的进入和离开操作。当一个线程进入同步块时，它使用 monitorenter 指令请求进入，如果当前对象的监视器计数器为 0，则它会被准许进入，若为 1，则判断持有当前监视器的线程是否为自己，如果是，则进入，否则进行等待，直到对象的监视器计数器为 0，才会被允许进入同步块。当线程退出同步块时，需要使用 monitorexit 声明退出。在 Java 虚拟机中，任何对象都有一个监视器与之关联，用来判断对象是否被锁定，当监视器被持有后，对象处于锁定状态。</p><p>指令 monitorenter 和 monitorexit 在执行时，都需要在操作数栈顶压入对象，之后 monitorenter 和 monitorexit 的锁定和释放都是针对这个对象的监视器进行的。</p><p>图11.16 展示了监视器如何保护临界区代码不同时被多个线程访问，只有当线程 4 离开临界区后，线程 1、2、3 才有可能进入。</p><p><img src="/assets/图11-16.b7b9d34c.png" alt="图11-16" loading="lazy"></p><p>图11.16 监视器保护临界区</p><p>【示例 11-18】这里给出一个 monitorenter、monitorexit 指令的使用示例。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncAdd</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">add1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在类 SyncAdd 中有两个方法：add1() 和 add2()，它们都对当前 this 对象进行加锁，并对实例字段 i 进行更新。对于 add1() 方法，有如下字节码：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: aload_0
1: dup
2: getfield    #12;  // Field i:I
5: iconst_1
6: iadd
7: putfield    #12;  // Field i:I
10: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，这段代码和普通的无同步操作的代码没有什么不同，没有使用 monitorenter 和 monitorexit 进行同步区控制。这是因为，对于同步方法而言，当虚拟机通过方法的访问标识符判断它是一个同步方法时，会自动在方法调用前进行加锁，当同步方法执行完毕后，不管方法是正常结束还是抛出异常，均会由虚拟机释放这个锁。所以，对于同步方式而言，monitorenter 和 monitorexit 指令是隐式存在的，并未直接出现在字节码中。</p><p>add2() 方法的字节码如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: aload_0
1: dup
2: astore_1
3: monitorenter
4: aload_0
5: dup
6: getfield    #12;  // Field i:I
9: iconst_1
10: iadd
11: putfield    #12;  // Field i:I
14: aload_1
15: monitorexit
16: goto    22
19: aload_1
20: monitorexit
21: athrow
22: return
  Exception table:                     
     from  to  target  type                  
     4	   16  19      any              
     19	   21  19      any     
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，对于同步块而言，字节码中已经生成了 monitorenter 和 monitorexit 指令。读者也许会觉得奇怪，为什么一个 monitorenter 居然会对应两个 monitorexit 指令？读者可以注意字节码最后给出的异常表，虽然在源码中没有进行异常处理，但是在生成的字节码中自动插入了一段异常处理代码，异常处理点为第 19 行。整段字节码的解析如下：</p><p>第 0 行将 this 引用入栈。</p><p>第 1 行复制 this 引用，并入栈。</p><p>第 2 行将 this 引用弹出，存入第 1 个局部变量。</p><p>第 3 行根据栈顶的 this 引用进行加锁。</p><p>第 4 ~ 14 行执行了 i++ 操作。</p><p>第 15 行表示释放锁，此时，i++ 已经完成。</p><p>第 16 行跳转到第 22 行，并退出。</p><p>如果在第 4 ~ 16 行执行期间遇到任何异常，则进入第 19 行处理。</p><p>第 19 行将第 1 个局部变量入栈，该变量就是 this，由第 2 行存入。</p><p>第 20 行根据栈顶的 this 退出临界区，释放锁。</p><p>第 21 行抛出当前发生的异常，异常对象位于栈顶。</p><h3 id="_11-2-11-再看-class-的方法结构" tabindex="-1"><a class="header-anchor" href="#_11-2-11-再看-class-的方法结构" aria-hidden="true">#</a> 11.2.11 再看 Class 的方法结构</h3><p>在 9.2.14 节中，以 SimpleUser.setId() 方法为例，分析了 Class 文件的静态结构。读者可以回顾相关内容。图11.17 为 setId() 方法的结构和指令部分。</p><p><img src="/assets/图11-17.e24c3bfb.png" alt="图11-17" loading="lazy"></p><p>图11.17 setId() 方法的结构和指令部分</p><p>其中细线框部分为方法的字节码指令。为阅读方便，这里再次给出 SimpleUser.setId() 方法源码。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>解析 setId() 方法字节码，如表11.3 所示。</p><p>表11.3 setId() 方法字节码解析</p><p><img src="/assets/表11-3-1.af222b0c.png" alt="表11-3-1" loading="lazy"></p><p><img src="/assets/表11-3-2.92afbbe4.png" alt="表11-3-2" loading="lazy"></p><p><strong>注意</strong>：表中第 1 列的数字均为 16 进制，故在常量池索引计算时，务必先转为 10 进制。</p><p>最后，给出这段代码的完整字节码信息，方便读者比对。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: aload_0
1: iload_1
2: putfield    #23;  // Field id:I
5: goto    19
8: astore_2
9: getstatic    #30;  // Field java/lang/System.out:Ljava/io/Printstream;
12: aload_2
13: invokevirtual    #36;  // Method java/lang/IllegalStateException.toString:()Ljava/lang/String;
16: invokevirtual    #40;  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
19: return
  Exception table:
    from  to  target  type
    0     5   8       Class java/lang/IllegalStateException
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_11-3-更上一层楼-再看-asm" tabindex="-1"><a class="header-anchor" href="#_11-3-更上一层楼-再看-asm" aria-hidden="true">#</a> 11.3 更上一层楼：再看 ASM</h2><p>读到这里，读者或许会觉得学习虚拟机的指令枯燥而乏味，了解 Class 文件错综复杂的结构似乎也没有太大的价值。事实恰恰相反，这些看似枯燥的知识，可以让我们做很多有趣的事情。比如大名鼎鼎的 CGLIB，其底层就是基于 ASM 的，而要用好 ASM，了解 Class 文件结构和常用指令是必不可少的。通过 ASM 的字节码操作，可以动态创建新的类型，可以为类增加新的功能。虽然使用 CGLIB 这些高级库也可以完成大量的工作，但是直接使用 ASM 还是大有好处的：ASM 的性能最好，灵活度最高，功能也最强大，可以将操作粒度定位到每一条指令。</p><h3 id="_11-3-1-为类增加安全控制" tabindex="-1"><a class="header-anchor" href="#_11-3-1-为类增加安全控制" aria-hidden="true">#</a> 11.3.1 为类增加安全控制</h3><p>【示例 11-19】本节将介绍一个使用 ASM 的基本案例。现有一个账户类，可以进行某些操作，如下所示：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Account</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;operation ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>目前，operation() 方法没有任何控制手段，现在希望为 operation() 方法增加一些安全校验，以判断这个对象是否有权限执行这个方法，如果有，则执行该方法，如果没有，则直接退出。当然，这一切是要在不修改 Account 类源码的前提下进行的。</p><p><strong>注意</strong>：根据开闭原则，一个系统对功能的增加应该是开放的，对修改应该是闭合的。也就是说，系统应该拥有一定的扩展性，但是也应该尽可能不要修改原有系统的代码。对于线上系统，修改代码带来的最大问题是很容易将原有系统破坏，需要安排更多的回归测试。从另一方面讲，如果系统中要进行权限校验的功能点很多，进行统一的批量处理要比逐个处理方便、高效、精确得多。</p><p>假设现在要增加的权限校验函数为：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityChecker</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">checkSecurity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;SecurityChecker.checkSecurity ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上代码模拟了权限校验，通过随机方式给出是否通过校验。现在系统要做的就是将 SecurityChecker.checkSecurity() 置于 Account.operation() 之前运行，如果权限校验失败，则阻止 Account.operation() 继续处理。</p><p>下面的 SecurityWeaveGenerator 类将 checkSecurity() 放置到 operation() 的第 1 行执行。它的核心是代码第 6 行的 AddSecurityCheckClassAdapter 类。这是一个 ClassVisitor，它负责实际的字节码织入操作。在代码的第 8 ~ 12 行，将新生成的 Account 类写入文件，覆盖由 Java 编译器产生的 Account 类的 Class 文件。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityWeaveGenerator</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassReader</span> cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassReader</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_MAXS <span class="token operator">|</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_FRAMES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AddSecurityCheckClassAdapter</span> classAdapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AddSecurityCheckClassAdapter</span><span class="token punctuation">(</span>cw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cr<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>classAdapter<span class="token punctuation">,</span> <span class="token class-name">ClassReader</span><span class="token punctuation">.</span>SKIP_DEBUG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;bin/&quot;</span> <span class="token operator">+</span> className<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;\\.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; .class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileOutputStream</span> fout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fout<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AddSecurityCheckClassAdapter 类的内容如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">AddSecurityCheckClassAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">ClassVisitor</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">AddSecurityCheckClassAdapter</span><span class="token punctuation">(</span><span class="token class-name">ClassVisitor</span> cv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>ASM5<span class="token punctuation">,</span> cv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">MethodVisitor</span> <span class="token function">visitMethod</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> access<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span>
                                     <span class="token keyword">final</span> <span class="token class-name">String</span> desc<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> exceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MethodVisitor</span> mv <span class="token operator">=</span> cv<span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodVisitor</span> wrappedMv <span class="token operator">=</span> mv<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mv <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;operation&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                wrappedMv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AddSecurityCheckMethodAdapter</span><span class="token punctuation">(</span>mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> wrappedMv<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 AddSecurityCheckClassAdapter 中覆盖了 visitMethod() 方法，在代码的第 11 行，当访问到 operation 方法时，交由 AddSecurityCheckMethodAdapter 类处理。AddSecurityCheckMethodAdapter 是一个 Methodvisitor，负责最终的字节码修改。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">AddSecurityCheckMethodAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">MethodVisitor</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">AddSecurityCheckMethodAdapter</span><span class="token punctuation">(</span><span class="token class-name">MethodVisitor</span> mv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>ASM5<span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Label</span> continueLabel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Label</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">visitMethodInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>INVOKESTATIC<span class="token punctuation">,</span> <span class="token string">&quot;geym/zbase/ch11/aop/securitycheck/Securitychecker&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;checksecurity&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()Z&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">visitJumpInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>IFNE<span class="token punctuation">,</span> continueLabel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">visitInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>RETURN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">visitLabel</span><span class="token punctuation">(</span>continueLabel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AddSecurityCheckMethodAdapter 类覆盖了 MethodVisitor 的 visitCode() 方法。当访问到方法的字节码时，在第 7 ~ 12 行织入了对 SecurityCheckcr.checkSecurity() 的调用。如果 checkSecurity() 返回了 false（栈顶为 0），根据指令 ifne，跳转不会发生，程序返回。如果 checkSecurity() 返回了 true（栈顶为 1），则指令 ifne 发生跳转，继续执行原先的 operation() 方法。</p><p>首先使用 javac 编译并生成 Account.class，接着使用 SecurityWeaveGenerator 类对 Account.class 进行处理，织入权限校验的字节码，最后使用以下简单的代码测试：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunAccountMain</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Account</span> account <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        account<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>程序可能的输出如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>SecurityChecker.checkSecurity ...
operation ...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-3-2-统计函数执行时间" tabindex="-1"><a class="header-anchor" href="#_11-3-2-统计函数执行时间" aria-hidden="true">#</a> 11.3.2 统计函数执行时间</h3><p>当系统遇到性能问题时，获取函数的执行时间有助于帮助我们排查性能问题。统计函数执行时间最简单的方式是在函数入口和出口处都使用 System.currentTimeMillis() 函数获得系统时间，然后计算两者的差值。一般情况下，不可能为每一个函数都写这样的语句，在实际工作中，往往不会有这样的信息统计。但得益于 ASM 框架，现在可以在不修改源码、不改变原有系统的情况下，直接将统计函数织入系统。</p><p>【示例 11-20】下面的代码使用 Thread.sleep() 模拟一段耗时的函数调用，现在 Acccout.operation() 本身并不具有计时功能。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Account</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;operation ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>需要加入的计时统计功能如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeStat</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> time <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> t<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">&quot; spend:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>TimeStat 类实现了函数的调用计时，在进入函数时，可以使用 start() 方法表示函数调用开始，在离开函数时，使用 end() 方法表示函数调用结束。函数调用结束后，打印出当前正在调用的函数名称及实际的系统耗时。</p><p>以下代码将 TimeStat.start() 和 TimeStat.end() 织入 Account.operation() 中。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeStatWeaveGenerator</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassReader</span> cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassReader</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_MAXS <span class="token operator">|</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_FRAMES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TimeStatClassAdapter</span> classAdapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimeStatClassAdapter</span><span class="token punctuation">(</span>cw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cr<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>classAdapter<span class="token punctuation">,</span> <span class="token class-name">ClassReader</span><span class="token punctuation">.</span>SKIP_DEBUG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;bin/&quot;</span> <span class="token operator">+</span> className<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;\\. &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; / &quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;. class &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileOutputStream</span> fout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fout<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在以上代码中，第 6 行使用 TimeStatClassAdapter 类完成具体的字节码修改工作。修改完成后，在第 9 ~ 12 行写入 Class 文件，覆盖原有的 Class 文件。</p><p>TimeStatClassAdapter 是一个 ClassVisitor，这里需要覆盖它的 visitMethod() 方法，对 operation() 方法进行修改。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">TimeStatClassAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">ClassVisitor</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">TimeStatClassAdapter</span><span class="token punctuation">(</span><span class="token class-name">ClassVisitor</span> cv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>ASM5<span class="token punctuation">,</span> cv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">MethodVisitor</span> <span class="token function">visitMethod</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> access<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> 
                                     <span class="token keyword">final</span> <span class="token class-name">String</span> desc<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> exceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MethodVisitor</span> mv <span class="token operator">=</span> cv<span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> desc<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodVisitor</span> wrappedMv <span class="token operator">=</span> mv<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mv <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;operation&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                wrappedMv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimeStatMethodAdapter</span><span class="token punctuation">(</span>mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> wrappedMv<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上代码在访问方法时，判断是否是 operation() 方法，如果是，则进行方法字节码的调整，并将这个工作委托给 TimeStatMethodAdapter 完成。下面是 TimeStatMethodAdapter 的实现。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">TimeStatMethodAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">MethodVisitor</span> <span class="token keyword">implements</span> <span class="token class-name">Opcodes</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">TimeStatMethodAdapter</span><span class="token punctuation">(</span><span class="token class-name">MethodVisitor</span> mv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>ASM5<span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">visitMethodInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>INVOKESTATIC<span class="token punctuation">,</span> <span class="token string">&quot;geym/zbase/ch11/aop/timestat/TimeStat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;start&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visitInsn</span><span class="token punctuation">(</span><span class="token keyword">int</span> opcode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>opcode <span class="token operator">&gt;=</span> IRETURN <span class="token operator">&amp;&amp;</span> opcode <span class="token operator">&lt;=</span> RETURN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">visitMethodInsn</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span>INVOKESTATIC<span class="token punctuation">,</span> <span class="token string">&quot;geym/zbase/ch11/aop/timestat/TimeStat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mv<span class="token punctuation">.</span><span class="token function">visitInsn</span><span class="token punctuation">(</span>opcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，第 6 行的 visitCode() 在方法的 Code 属性被访问时调用，因此在这里插入对 TimeStat.start() 方法的调用，表示方法的开始。在第 12 行，覆盖了 visitInsn() 方法，当访问到 xreturn 指令时，进行 TimeStat.end() 方法调用，表示方法即将退出。从字节码的指令上，看多个 xretum 指令是连续的，如下所示：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ireturn = 172,  // Oxac
lreturn = 173,  // Oxad
freturn = 174,  // Oxae
dreturn = 175,  // Oxaf
areturn = 176,  // OxbO
return = 177,   // Oxb1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因此在 visitInsn() 方法中，简单地通过指令值获得范围，判断是否为 xreturn 返回指令。使用 TimeStatWeaveGenerator 修改 Account.class，将时间统计的字节码织入，并运行以下代码：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunTimeStatMainAfterGen</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Account</span> account <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        account<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以得到输出如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>operation ...
geym.zbase.ch11.aop.timestat.Account.operation(Unknown Source) spend:10 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，在 operation() 方法调用结束后，程序还输出了函数运行的耗时。</p><h2 id="_11-4-谁说-java-太刻板-java-agent-运行时修改类" tabindex="-1"><a class="header-anchor" href="#_11-4-谁说-java-太刻板-java-agent-运行时修改类" aria-hidden="true">#</a> 11.4 谁说 Java 太刻板：Java Agent 运行时修改类</h2><p>JDK 1.5 引入了 java.lang.instrument 包，该包提供了一些工具帮助开发人员在 Java 程序运行时动态修改系统中的 Class 类型。该软件包的一个关键组件为 Java Agent。从名字看，似乎可以理解成 Java 代理，实际上，它的功能更像 Class 类型的转换器，它可以在运行时接收程序外部请求，对 Class 类型进行修改。</p><p>在命令行执行 java 命令，可以看到 java 命令的帮助，不难发现其中有一个 javaagent 选项。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-javaagent:&lt;jarpath&gt;[=&lt;options&gt;]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>加载 Java 编程语言代理，请参阅 java.lang.instrument</p><p>也就是说，在 Java 程序运行时可以指定一个 Java Agent 作为其编程语言代理。</p><h3 id="_11-4-1-使用-javaagent-参数启动-java-虚拟机" tabindex="-1"><a class="header-anchor" href="#_11-4-1-使用-javaagent-参数启动-java-虚拟机" aria-hidden="true">#</a> 11.4.1 使用 -javaagent 参数启动 Java 虚拟机</h3><p>参数 -javaagent 可以用于指定一个 jar 包，且对该 jar 包有如下要求：</p><ol><li><p>这个 jar 包的 MANIFEST.MF 文件必须指定 Premain-Class 项。</p></li><li><p>Premain-Class 指定的那个类必须实现 premain() 方法。</p></li></ol><p>Premain-Class 仅从英文字面上理解，就是运行在 main() 函数之前的类。当 Java 虚拟机启动时，在执行 main() 函数之前，虚拟机会先运行 -javaagent 所指定 jar 包内 Premain-Class 类的 premain() 方法。premain() 方法的签名如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其中，agentArgs 是通过命令行传给 Java Agent 的参数，inst 提供 Java Class 字节码转换的工具。Instrumentation 类的常用 API 如下：</p><ul><li><p>void addTransformer(ClassFileTransformer transformer, boolean canRetransform)</p><p>增加一个 Class 文件的转换器，用于改变 Class 二进制流的数据，参数 canRetransform 用于设置是否允许重新转换。</p></li><li><p>void redefineClasses(ClassDefinition... definitions)</p><p>在类加载之前，重新定义 Class 文件。ClassDefinition 表示对一个类新的定义。如果在类加载之后，需要使用 retransformClasses() 方法重新定义类。</p></li><li><p>boolean removeTransformer(ClassFileTransformer transformer)</p><p>移出一个类转换器。</p></li><li><p>void retransformClasses(Class&lt;?&gt;... classes)</p><p>在类加载之后，重新定义 Class。</p></li></ul><p>【示例 11-21】下面的例子定义了一个 Java Agent，这个 Agent 打印出在 main() 函数运行后，系统载入的类型。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PreMainTraceAgent</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">UnmodifiableClassException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;agentArgs:&quot;</span> <span class="token operator">+</span> agentArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inst<span class="token punctuation">.</span><span class="token function">addTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassFileTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> classBeingRedefined<span class="token punctuation">,</span>
                                    <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span>
                    <span class="token keyword">throws</span> <span class="token class-name">IllegalClassFormatException</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;load Class:&quot;</span> <span class="token operator">+</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> classfileBuffer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码第 2 行，定义了 Agent 的 premain() 方法，该方法会在 main() 函数执行前调用。</p><p>代码第 4 行，打印了传递给 Agent 的参数。</p><p>代码第 5 行，加入了一个类转换器。这里使用匿名内部类，定义了一个类转换器。这个类转换器很简单，只是简单地打印出获取的类名，不做实质性转换。</p><p>代码第 7 行为类转换器接口的 transform() 方法，用于完成类的转换。该方法定义如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> 
                 <span class="token class-name">String</span> className<span class="token punctuation">,</span> 
                 <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> classBeingRedefined<span class="token punctuation">,</span>
                 <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">,</span> 
                 <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">IllegalClassFormatException</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，loader 为类的加载器，className 表示类的全限定名，比如 &quot;java/lang/String&quot;。参数 classBeingRedefined 表示：如果被重定义或重转换触发，则为重定义或重转换的类；如果是类加载，则为 null。参数 protectionDomain 表示要定义或重定义的类的保护域。参数 classfileBuffer 表示类文件格式的二进制数据（只读，不能修改）。该方法的返回值为重新定义的新的类的二进制数据。</p><p>将以上的 Java Agent 打包成 jat.jar，并设置 META-INF/MANIFEST.MF 文件如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Manifest-Version: 1.0
Premain-Class: geym.zbase.ch11.agent.PreMainTraceAgent 
Can-Redine-Classes: true
Can-Retransform-Classes: true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这就完成了一个保存有合法 Java Agent 的 jar 包。使用以下代码测试这个 jat.jar：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunAccountMain</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Account</span> account <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        account<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码中的 Account 为 11.3.2 节中的 Account 类。使用 Java 虚拟机参数 -javaagent:d:/jat.jar 运行代码，输出如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>agentArgs:null
load Class:sun/launcher/LauncherHelper
load Class:geym/zbase/ch11/agent/RunAccountMain
load Class:java/lang/Void
load Class:geym/zbase/ch11/aop/timestat/Account
load Class:java/lang/InterruptedException
operation ...
load Class:java/lang/Shutdown
load Class:java/lang/Shutdown$Lock
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，PreMainTraceAgent 已经可以正常工作了，这里所加载的类型，并非系统中所有的 Class 类。实际上，在 jat.jar 执行之前的所有巳加载的类型都是无法捕获的。因此，大量的系统核心类会丢失，但是应用程序的类都在 main() 函数执行之后加载，因此都可以通过这种方式捕获，例如上述代码的字体加粗部分。</p><h3 id="_11-4-2-使用-java-agent-为函数增加计时功能" tabindex="-1"><a class="header-anchor" href="#_11-4-2-使用-java-agent-为函数增加计时功能" aria-hidden="true">#</a> 11.4.2 使用 Java Agent 为函数增加计时功能</h3><p>在 11.3.2 节中，已经通过 ASM 进行了字节码织入，使 Account.operation() 方法具有计时功能，但提供的织入方式不够灵活，要求在 Account 类进行 javac 编译后，再进行基于文件的织入。这种做法虽然可行，但是过于烦琐。有了 Java Agent 的支持，就可以大大改进这种方式。</p><p>【示例 11-22】下面的代码展示了通过 Java Agent 直接进行字节码织入的方式。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PreMainAddTimeStatAgent</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">UnmodifiableClassException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;agentArgs:&quot;</span> <span class="token operator">+</span> agentArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        inst<span class="token punctuation">.</span><span class="token function">addTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassFileTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> classBeingRedefined<span class="token punctuation">,</span>
                                    <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span>
                    <span class="token keyword">throws</span> <span class="token class-name">IllegalClassFormatException</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;geym/zbase/ch11/aop/timestat/Account&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;meet geym.zbase.ch11.aop.timestat.Account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">ClassReader</span> cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassReader</span><span class="token punctuation">(</span>classfileBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_MAXS <span class="token operator">|</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_FRAMES<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">TimeStatClassAdapter</span> classAdapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimeStatClassAdapter</span><span class="token punctuation">(</span>cw<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cr<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>classAdapter<span class="token punctuation">,</span> <span class="token class-name">ClassReader</span><span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> classfileBuffer<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码第 5 行，加入了类转换器，这里依然使用了匿名内部类的形式定义这个转换器。第 9 行判断当前加载的类是否为 Account，如果是，则进行字节码织入。第 11 ~ 15 行使用 TimeStatClassAdapter 对 Account 进行修改。</p><p>将 PreMainAddTimeStatAgent 打包成 ja.jar，设置 META-INF/MANIFEST.MF 为：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Manifest-Version: 1.0
Premain-Class: geym.zbase.ch11.agent.PreMainAddTimeStatAgent
Can-Redine-Classes: true
Can-Retransform-Classes: true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用 Java 虚拟机参数 -javaagent:d:/ja.jar 运行上一节中的 RunAccountMain，得到如下输出：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>agentArgs:null
sun/launcher/LauncherHelper
geym/zbase/ch11/agent/RunAccountMain
java/lang/Void
meet geym.zbase.ch11.aop.timestat.Account
java/lang/InterruptedException
geym/zbase/ch11/aop/timestat/TimeStat
operation ...
geym.zbase.ch11.aop.timestat.Account.operation(Unknown Source) spend:10
java/lang/Shutdown
java/lang/Shutdown$Lock
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，使用了 Java Agent 后，已经可以在 main() 函数运行时动态修改 Account 的字节码并使之生效，因此函数的执行时间也出现在输出中（字体加粗部分）。</p><p><strong>注意</strong>：使用 Java Agent 可以在 Class 类型被加载前对类进行重定义，动态修改指定的 Class 二进制数据并使之生效。这种方式比基于文件进行字节码织入更快捷有效。</p><h3 id="_11-4-3-动态重转换类" tabindex="-1"><a class="header-anchor" href="#_11-4-3-动态重转换类" aria-hidden="true">#</a> 11.4.3 动态重转换类</h3><p>在前两节中，使用 Java Agent 方式需要在 Java 程序启动时加入 -javaagent 参数，并且只能在类加载前进行重定义。事实上，Java Agent 也支持在类加载后进行动态修改。这需要使用 Java Agent 的另外一个方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>agentmain() 方法与 premain() 方法的参数有着同样的含义。但是 agentmain() 方法是在一个 Java Agent 被附加（attach）到 Java 虚拟机上时执行的。当 Java Agent 被附加到 Java 虚拟机上时，Java 程序的 main() 函数一般己经启动，并且程序很可能已经运行了相当长的时间。此时，通过 Instrumentation.retransformClasses() 方法可以使用类转换器重新转换给定的 Class 类型并使之生效。为演示这个功能，请看下面的示例。</p><p>【示例 11-23】下面这段代码不断地调用 Account.operation() 方法。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RunLoopAccountMain</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Account</span> account <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                account<span class="token punctuation">.</span><span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上代码持续调用 operation() 方法，并每次休眠 1 秒。不需要加任何 Java 虚拟机参数运行这段代码，程序会持续出现以下输出：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>operation ...
operation ...
operation ...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着，修改上节中的 PreMainAddTimeStatAgent 类，并增加以下方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> 
    <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">UnmodifiableClassException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Agent Main called&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;agentArgs:&quot;</span> <span class="token operator">+</span> agentArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">premain</span><span class="token punctuation">(</span>agentArgs<span class="token punctuation">,</span> inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    inst<span class="token punctuation">.</span><span class="token function">retransformClasses</span><span class="token punctuation">(</span><span class="token class-name">Account</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码实现了 agentmain() 方法，该方法会在函数 Java Agent 被附加到虚拟机上时执行。agentmain() 方法委托 premain() 方法进行类转换器的注册，并在最后使用了 retransformClasses() 方法要求使用注册的类转换器重转换类 Accout。</p><p>将修改后的 PreMainAddTimeStatAgent 类打包为 ja.jar，并修改 META-INF/MANIFEST.MF 为（增加了 Agent-Class）：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Manifest-Version: 1.0
Agent-Class: geym.zbase.ch11.agent.PreMainAddTimeStatAgent
Premain-Class: geym.zbase.ch11.agent.PreMainAddTimeStatAgent 
Can-Redine-Classes: true
Can-Retransform-Classes: true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>增加的 Agent-Class 属性表示：当持有 Java Agent 的 jar（这里是 ja.jar）被附加到 Java 虚拟机上时，执行该属性指定类的 agentmain() 方法（这里就是 PreMainAddTimeStatAgent. agentmain() 方法）。</p><p>到此，Java Agent 己经准备完毕，剩下的问题就是如何将 Java Agent（ja.jar）附加到正在执行的 RunLoopAccountMain 上。要实现这个功能，需要借助 %JAVA_HOME%/lib/tools.jar，该 jar 包提供了一些虚拟机操作的工具类，将该 jar 包加入工程的 ClassPath 中，如图11.18 所示。</p><p><img src="/assets/图11-18.9e37da6b.png" alt="图11-18" loading="lazy"></p><p>图11.18 tools.jar 引入</p><p>接着，使用 tools.jar 中的工具类，将 ja.jar 附加到目标 Java 进程中，如下所示：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AttachToolMain</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">AttachNotSupportedException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span>
            <span class="token class-name">AgentLoadExceptiont</span><span class="token punctuation">,</span> <span class="token class-name">AgentlnitializationException</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VirtualMachineDescriptor</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">VirtualMachine</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">VirtualMachineDescriptor</span> vmd <span class="token operator">:</span> list<span class="token punctuation">)</span> 
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>vmd<span class="token punctuation">.</span><span class="token function">displayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;RunLoopAccountMain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">VirtualMachine</span> virtualmachine <span class="token operator">=</span> <span class="token class-name">VirtualMachine</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>vmd<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                virtualmachine<span class="token punctuation">.</span><span class="token function">loadAgent</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\ja.jar&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;argument for agent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                virtualmachine<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码的主要功能是将 D:\ja.jar 中的 Java Agent 附加到指定的 Java 程序中。代码第 5 行获得当前系统中所有的 Java 虚拟机（有点像 jps 命令）。代码第 8 行限定只对以 RunLoopAccountMain 为主函数的虚拟机程序进行操作。代码第 9 行使用 attach() 方法连接上给定的虚拟机（这里就是 RunLoopAccountMain）。代码第 10 行将准备好的 ja.jar 载入目标虚拟机，并传入了一个参数 &quot;argument for agent&quot;<strong>。</strong></p><p>保持 RunLoopAccountMain 持续运行，并同时运行 AttachToolMain，结束后打印出 &quot;ok&quot; 字样，再观察 RunLoopAccountMain 的输出，可以看到：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>operation ...
operation ...
Agent Main called
agentArgs:argument for agent
agentArgs:argument for agent
meet geym.zbase.ch11.aop.timestat.Account
geym/zbase/ch11/aop/timestat/TimeStat
operation ...
geym.zbase.ch11.aop.timestat.Account.operation(Unknown Source) spend:10 
operation ...
geym.zbase.ch11.aop.timestat.Account.operation(Unknown Source) spend:10
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由这段输出可知，在 RunLoopAccountMain 加载了 PreMainAddTimeStatAgent 之后，agentmain() 被调用，接着重新运行了类转换器，并为 Account 类加入了函数调用的计时功能。在类转换结束后，每次 operation() 操作后都会输出函数调用的耗时。而这一切都不需要重启应用，甚至不需要任何额外参数的支持。</p><h3 id="_11-4-4-有关-java-agent-的总结" tabindex="-1"><a class="header-anchor" href="#_11-4-4-有关-java-agent-的总结" aria-hidden="true">#</a> 11.4.4 有关 Java Agent 的总结</h3><p>Java Agent 提供了一个很好的方式动态修改类的实现，而 ASM 提供了一套高效的 Class 二进制流创建和修改工具。ASM 可以让 Java Agent 知道如何修改或者创建一个类，而 Java Agent 可以让 ASM 更好、更方便地进行类的修改。两者的结合可以大大增加 Java 平台的灵活性。</p><h2 id="_11-5-与时俱进-动态方法调用" tabindex="-1"><a class="header-anchor" href="#_11-5-与时俱进-动态方法调用" aria-hidden="true">#</a> 11.5 与时俱进：动态方法调用</h2><p>在 JDK 1.7 中引入了一个 invoke 指令——invokedynamic，该指令的目的是更好地支持 Java 虚拟机平台上的动态语言，以及 Java 8 中的 lambda 表达式。在 Java 8 之前，甚至无法使用 Java 编译器产生的 invokednamic 指令，实际上在 JDK 1.7 中已经支持了该指令。随着 invokednamic 的引入，Java 1.7 中还引入了一些概念，为了更好地理解 invokedynamic，这里先来介绍一下相关概念。</p><ul><li><p>方法句柄（Method Handler）：方法句柄很像一个方法指针或者代理。通过方法句柄，可以调用一个方法。读者应该还记得在 Class 文件的常量池中，有一项常量类型为 CONSTANT_MethodHandle，这就是方法句柄。</p></li><li><p>调用点（CallSite）：调用点是对方法句柄的封装，通过调用点可以获得一个方法句柄进行方法调用。使用调用点可以增强方法句柄的表达能力，比如对于可变调用点来说，它绑定的方法句柄是可变的，因此，对同一个调用点而言，其调用方法是可变的。</p></li><li><p>启动方法（BootstrapMethods）：通过启动方法可以获得一个调用点，获取调用点的目的是进行方法绑定和调用。启动方法是在 Class 文件的属性中进行描述的，读者可以参见 9.2.16 节。</p></li><li><p>方法类型（Method Type）：用于描述方法的签名，比如方法的参数类型、返回值等。根据方法的类型，可以查找到可用的方法句柄。</p></li></ul><h3 id="_11-5-1-方法句柄使用实例" tabindex="-1"><a class="header-anchor" href="#_11-5-1-方法句柄使用实例" aria-hidden="true">#</a> 11.5.1 方法句柄使用实例</h3><p>在 JDK 1.7 中，引入了一些 API 用来支持方法句柄的使用，这些类主要位于 java.lang.invoke 包中。本节主要介绍最基础的 4 个类：</p><ul><li><p>java.lang.invoke.MethodType：提供了一组生成方法类型描述的 API。使用其静态方法 methodType()，可以根据返回值和参数类型生成一个 MethodType 对象。</p></li><li><p>java.lang.invoke.MethodHandle：表示方法句柄。通过方法句柄的实例，可以使用其 invoke() 方法直接调用指定方法。</p></li><li><p>java.lang.invoke.MethodHandles：这是一个工具类，大部分方法是静态方法，用于构造 MethodHandle 实例。</p></li><li><p>java.lang.invoke.MethodHandles.Lookup：这是 MethodHandles 的内部类，是一个工具类，用于查找和构造 MethodHandle 实例。</p></li></ul><p>【示例 11-24】下面是一个简单的使用 MethodHandle 进行函数调用的例子。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">geym<span class="token punctuation">.</span>zbase<span class="token punctuation">.</span>ch11<span class="token punctuation">.</span>inv</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>invoke<span class="token punctuation">.</span></span><span class="token class-name">MethodHandle</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>invoke<span class="token punctuation">.</span></span><span class="token class-name">MethodType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token import static"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>invoke<span class="token punctuation">.</span></span><span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token static">lookup</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleMethodHandle</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyPrintln</span> <span class="token punctuation">{</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">1L</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0L</span> <span class="token operator">?</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">MyPrintln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getPrintlnMethodHandler</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invokeExact</span><span class="token punctuation">(</span><span class="token string">&quot;geym&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">MethodHandle</span> <span class="token function">getPrintlnMethodHandler</span><span class="token punctuation">(</span><span class="token class-name">Object</span> receiver<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">MethodType</span> mt <span class="token operator">=</span> <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findVirtual</span><span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;println&quot;</span><span class="token punctuation">,</span> mt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindTo</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>本例中声明了一个内部类 MyPrintln，它拥有一个 println() 方法，这个方法和 System.out 中的 println() 方法有相同的签名。因此，这两个属于不同类的方法拥有相同的描述和 MethodType。在 main() 函数中，第 14 行随机产生一个对象，它可能是 PrintStream 类，也可能是 MyPrintln 类。在第 18 行的 getPrintlnMethodHandler() 使用 MethodType.methodType() 方法构造了一个表示方法签名的 MethodType 实例。这里产生的 MethodType 表示一个返回值为 void、参数为 String 的函数。在第 20 行，使用 MethodHandles.lookup.lookup() 得到一个 Lookup 实例，并调用其 findVirtual() 方法，根据 MethodType、函数名称和实际的对象类型进行方法查找，得到 MethodHandle 实例，并将调用对象 receiver 作为方法调用的执行者，然后返回这个 MethodHandle 实例。在第 16 行，根据返回的 MethodHandle 实例，调用 println() 方法，并传入参数 &quot;geym&quot;。无论当前 obj 是什么类型的对象，只要其拥有给定签名和名称的方法，就可以顺利调用到这个方法。</p><p>以上就是 MethodHandle 的使用案例。这里还需要说明一下，使用 Lookup 对象进行函数查找有 3 种方式。</p><ul><li><p>findStatic() 方法：查找一个 static 方法，使用 invokestatic 进行方法调用。</p></li><li><p>findVirtual() 方法：查找一个虚方法，使用 invokevirtual 指令进行方法调用。</p></li><li><p>findSpecial() 方法：查找一个特殊的方法，等价于使用 invokespecial 调用，用于访问私有方法、父类的方法。但是对于构造函数的访问需要使用 findConstructor() 方法。</p></li></ul><p>由于大部分 Java 函数都是虚函数，所以对于绝大部分函数调用，使用 findVirtual() 方法查找就可以了。对于静态函数则使用 findStatic() 方法，对于特殊的一些方法，比如私有方法或者父类方法，则使用 findSpecial() 方法进行查找。</p><p>【示例 11-25】下面的代码演示了 findStatic() 方法的使用。和 findVirtual() 方法不同，静态方法不需要绑定调用对象，因为静态方法没有 this 引用。下面的代码通过 MethodHandle 调用了 Math.sin() 函数。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleStaticMethodHandle</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">SimpleStaticMethodHandle</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStaticMethodHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">callSin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">callSin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">MethodHandle</span> mh <span class="token operator">=</span> <span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findStatic</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;sin&quot;</span><span class="token punctuation">,</span>
                <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> mh<span class="token punctuation">.</span><span class="token function">invokeExact</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span>PI <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>【示例 11-26】下面的例子使用 findSpecial() 方法调用了类的私有方法。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimplePrivateMethodHandle</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">SimplePrivateMethodHandle</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimplePrivateMethodHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj<span class="token punctuation">.</span><span class="token function">callToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">printLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;call private method&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">MethodHandle</span> mh <span class="token operator">=</span> <span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findSpecial</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;printLine&quot;</span><span class="token punctuation">,</span>
                <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindTo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mh<span class="token punctuation">.</span><span class="token function">invokeExact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>【示例 11-27】下面的例子使用 findSpecial() 方法调用了父类的方法，模拟了 super.toString() 方法的调用。虽然在 SimpleSuperMethodHandle 类中重载了 toString() 方法，但是按照下面所示的调用方式，程序依然会打印 &quot;geym.zbase.ch11.inv.SimpleSuperMethodHandle@15e538e&quot;。这个方法调用的依然是实例方法，故在最后通过 bindTo() 方法绑定到目标实例上。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleSuperMethodHandle</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">SimpleSuperMethodHandle</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleSuperMethodHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">callToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;I am SimpleSuperMethodHandle&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">callToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">MethodHandle</span> mh <span class="token operator">=</span> <span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findSpecial</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;toString&quot;</span><span class="token punctuation">,</span>
                <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindTo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> mh<span class="token punctuation">.</span><span class="token function">invokeExact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意</strong>：findSpecial() 方法的参数中，第 1 个为要调用方法的所在类，第 2 个参数为方法名，第 3 个参数为方法类型，第 4 个参数为实际的对象类型.</p><h3 id="_11-5-2-调用点使用实例" tabindex="-1"><a class="header-anchor" href="#_11-5-2-调用点使用实例" aria-hidden="true">#</a> 11.5.2 调用点使用实例</h3><p>调用点（CallSite）也是 JDK 1.7 增加的 API，它也在 java.lang.invoke 包中，如图11.19 所示。调用点用于包装方法句柄，通过一个调用点实例就可以得到相关的方法句柄，从而实现方法调用。</p><p><img src="/assets/图11-19.a21aba83.png" alt="图11-19" loading="lazy"></p><p>图11.19 调用点类层次结构</p><p>可以看到，目前，JDK 中支持 3 类调用点，分别是常量调用点（ConstantCallSite）、可变调用点（MutableCallSite）和易变调用点（VolatileCallSite）。它们的特点如下。</p><ul><li><p>常量调用点：调用目标不可变。一旦它绑定到了目标方法句柄上，就无法再更改。</p></li><li><p>可变调用点：调用目标可变，可以多次绑定到不同的目标方法句柄上，每次只通过同一个调用点，就可以调用不同的方法。</p></li><li><p>易变调用点：由于缓存等原因，在多线程环境中，当一个线程更改了可变调用点的目标方法后，其他线程不能保证立即发现这个更改。如果需要保证调用点修改在多线程间的可见性，可以使用易变调用点，它满足 volatile 语义。</p></li></ul><p>以下代码演示了常量调用点的使用：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">constantCallSiteSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">MethodHandles<span class="token punctuation">.</span>Lookup</span> lookup <span class="token operator">=</span> <span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodType</span> type <span class="token operator">=</span> <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodHandle</span> mh <span class="token operator">=</span> lookup<span class="token punctuation">.</span><span class="token function">findVirtual</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;substring&quot;</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ConstantCallSite</span> callSite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConstantCallSite</span><span class="token punctuation">(</span>mh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodHandle</span> invoker <span class="token operator">=</span> callSite<span class="token punctuation">.</span><span class="token function">dynamicInvoker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">&quot;1234567890&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;constantCallSiteSample return:&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码第 5 行，根据 MethodHandle 方法句柄构造一个常量调用点，常量调用点不可变，一直指向该 MethodHandle。由第 2 ~ 4 行可知，该 MethodHandle 指向 String.substring(int, int) 方法。第 6 行由调用点的 dynamiclnvoker() 方法取得 MethodHandle，并进行调用。</p><p>【示例 11-28】下面的例子展示了可变调用点（MutableCallSite）的使用方式。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mutableCallSiteSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">MethodType</span> type <span class="token operator">=</span> <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MutableCallSite</span> callSite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutableCallSite</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodHandle</span> invoker <span class="token operator">=</span> callSite<span class="token punctuation">.</span><span class="token function">dynamicInvoker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodHandles<span class="token punctuation">.</span>Lookup</span> lookup <span class="token operator">=</span> <span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodHandle</span> mhSin <span class="token operator">=</span> lookup<span class="token punctuation">.</span><span class="token function">findStatic</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;sin&quot;</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MethodHandle</span> mhCos <span class="token operator">=</span> lookup<span class="token punctuation">.</span><span class="token function">findStatic</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;cos&quot;</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    callSite<span class="token punctuation">.</span><span class="token function">setTarget</span><span class="token punctuation">(</span>mhSin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span>PI <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;sin(90)=&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    callSite<span class="token punctuation">.</span><span class="token function">setTarget</span><span class="token punctuation">(</span>mhCos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span>PI <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;cos(90)=&quot;</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码第 3 行根据函数类型（函数签名）构造了可变调用点，根据可变调用点生成 MethodHandle，名为 invoker，但此时，可变调用点尚未完成初始化，没有绑定任何可用函数。接着在第 6、7 行获得可用的方法句柄 Math.sin() 和Math.cos()。第 8 行设置可变调用点的目标方法为 Math.sin()，并进行函数调用。第 11 行改变可用调用点的目标方法，并进行调用。结果通过同一个 MethodHandle 实例 invoker 完成了两次不同的方法调用。</p><h3 id="_11-5-3-反射和方法句柄" tabindex="-1"><a class="header-anchor" href="#_11-5-3-反射和方法句柄" aria-hidden="true">#</a> 11.5.3 反射和方法句柄</h3><p>读者也许会发现，方法句柄提供的函数查找和访问功能，在反射中不是早己提供了吗？不错，使用反射也可以实现类似的功能，不同的是，反射在 Java 语言层面进行方法调用模拟，而方法句柄则在 Java 字节码层面进行方法调用。因此，方法句柄的执行效率要高于反射。</p><p>【示例 11-29】使用下面的代码对反射调用和方法句柄调用进行测试。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectionMain</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> COUNT <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">callByHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReflectionMain</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodType</span> mt <span class="token operator">=</span> <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodHandle</span> mh <span class="token operator">=</span> <span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findVirtual</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;method&quot;</span><span class="token punctuation">,</span> mt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindTo</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> COUNT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mh<span class="token punctuation">.</span><span class="token function">invokeExact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">callByReflection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">ReflectionMain</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> m <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;method&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> COUNT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            m<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token function">callByHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callByHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callByReflection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callByReflection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>调用的目标方法都是第 5 行的 method() 方法。callByHandler() 方法使用方法句柄进行函数调用，callByReflection() 方法使用反射进行调用。两者都用 method() 方法执行相同的调用次数，并统计时间。主函数 main() 中，分别进行两次调用：第 1 次调用属于热身，希望相关的 JIT 编译等进行完成，第 2 次调用才是要关心的性能统计数据。</p><p>在笔者的计算机上，使用不同参数运行程序，得到如下输出：</p><p>运行参数：-Xint</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>callByHandler spend:282
callByHandler spend:263
callByReflection spend:444
callByReflection spend:433
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行参数：-Xcomp -XX:-BackgroundCompilation</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>callByHandler spend:52
callByHandler spend:50
callByReflection spend:121
callByReflection spend:67
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里只关心每一种类型的第 2 次输出（加粗部分）。可以看到，对于纯解释型函数调用，反射的性能只能达到方法句柄的一半，而对于 JIT 编译后的函数调用，反射的性能有较大提升，但仍然比方法句柄略差。</p><h3 id="_11-5-4-指令-invokedynamic-使用实例" tabindex="-1"><a class="header-anchor" href="#_11-5-4-指令-invokedynamic-使用实例" aria-hidden="true">#</a> 11.5.4 指令 invokedynamic 使用实例</h3><p>在了解了方法句柄和调用点的基础上，终于可以让主角 invokedynamic 指令登场亮相了。指令 invokedynamic 接收两个字节操作数，根据操作数，invokedynamic 会计算出常量池索引，该常量池入口为 CONSTANT_InvokeDynamic 结构，该结构用于指向一个引导方法（BootstrapMethods）和方法的签名。引导方法会指向常量池中的 CONSTANT_MethodHandle 项，表示方法的调用位置。CONSTANT_MethodHandle 入口会具体指向 CONSTANT_Methodref 或者 CONSTANT_Fieldref 结构。引导方法、CONSTANT_MethodHandle、CONSTANT_InvokeDynamic 在内的属性或者常量池类型，在第 9 章中有详细描述，读者可以参考相关内容。</p><p>通过对 InvokeDynamic 结构的解析，最终会找到引导方法，引导方法会返回一个 CallSite 调用点，虚拟机在执行引导方法后，就能得到目标调用点，并取得目标函数的 MethodHandle，从而完成函数调用。</p><p>如图11.20 所示，invokedynamic 指令会找到 Class 文件中的 CONSTANT_InvokeDynamic 常量，并解析出对应的引导方法 BootstrapMethods。在引导方法结构中，又会引用常量池中的 MethodHandle 方法句柄，该方法句柄表示引导方法，通过这个 MethodHandle 又能在 Class 文件中找到 CONSTANT_Methodref，从而进行引导方法的调用。引导方法会返回 CallSite 调用点，系统通过调用点找到最终需要调用的方法句柄，就可以执行目标方法了。由此可见，动态调用的函数派发绑定是由引导方法决定的。这也就是把它称为引导方法的原因。</p><p><img src="/assets/图11-20.0e4a271e.png" alt="图11-20" loading="lazy"></p><p>图11.20 invokedynamic 指令流程图</p><p>目前，指令 invokedynamic 完全是为动态语言准备的。在 JDK 1.7 及之前版本中，Java 尚不具备很强的动态性，因此无法通过 Java 编译器产生 invokedynamic 指令。但在 JDK 1.8 之后，由于函数式编程的引入，Java 的动态性大大增强，在 Java 函数式 API 调用中，编译器就能产生 invokedynamic 指令。此外，由各种动态语言自己的编译器（比如 Groovy 等）也可能产生 invokedynamic 调用。</p><p>虽然在 JDK 1.8 之前，无法直接由 Java 编译器产生 invokedynamic 指令，但在前文中已有不少篇幅介绍 ASM 框架的使用，在这里将使用 ASM 产生包含 invokedynamic 指令的函数，并演示其结构。本例使用 invokedynamic 来调用 String.hashCode() 方法。</p><p>为了使用 invokedynamic，必须先建立一个引导方法，代码如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynBootStrap</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CallSite</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token class-name">Lookup</span> lookup<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">MethodType</span> type<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;bootstrap called, name=&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodHandle</span> mh <span class="token operator">=</span> lookup<span class="token punctuation">.</span><span class="token function">findVirtual</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bindTo</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConstantCallSite</span><span class="token punctuation">(</span>mh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>引导方法的第 2 个参数 name 为调用函数的名称，这里使用 name 来查找 String 的方法，此处传入的值为 &quot;hashCode&quot;。参数 value 是方法的第 1 个参数，对于实例方法，第 1 个参数就是 this。方法第 4 行完成了方法句柄的查找工作，第 5 行返回了常量调用点，系统会根据这个调用点进行方法调用。</p><p>以下代码使用 ASM 构造了一个使用 invokedynamic 指令的类，并将上述代码的引导方法作为其引导方法。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynInvokerSample</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Handle</span> BSM <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handle</span><span class="token punctuation">(</span>H_INVOKESTATIC<span class="token punctuation">,</span> <span class="token class-name">DynBootStrap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">&#39;.&#39;</span><span class="token punctuation">,</span> <span class="token char">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;bootstrap&quot;</span><span class="token punctuation">,</span> <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token function">methodType</span><span class="token punctuation">(</span><span class="token class-name">CallSite</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Lookup</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">MethodType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMethodDescriptorString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Class</span> <span class="token function">createClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_FRAMES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cw<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span>V1_7<span class="token punctuation">,</span> ACC_PUBLIC <span class="token operator">|</span> ACC_SUPER<span class="token punctuation">,</span> <span class="token string">&quot;DynInvokerSampleMain&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;java/lang/Object&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> m <span class="token operator">=</span> <span class="token class-name">Method</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;void &lt;init&gt;()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">GeneratorAdapter</span> mg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GeneratorAdapter</span><span class="token punctuation">(</span>ACC_PUBLIC<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> cw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mg<span class="token punctuation">.</span><span class="token function">loadThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mg<span class="token punctuation">.</span><span class="token function">invokeConstructor</span><span class="token punctuation">(</span><span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mg<span class="token punctuation">.</span><span class="token function">returnValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mg<span class="token punctuation">.</span><span class="token function">endMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">MethodVisitor</span> mv <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>ACC_PUBLIC <span class="token operator">|</span> ACC_STATIC<span class="token punctuation">,</span> <span class="token string">&quot;run&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()V&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mv<span class="token punctuation">.</span><span class="token function">visitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mv<span class="token punctuation">.</span><span class="token function">visitFieldInsn</span><span class="token punctuation">(</span>GETSTATIC<span class="token punctuation">,</span> <span class="token string">&quot;java/lang/System&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;out&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Ljava/io/PrintStream;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mv<span class="token punctuation">.</span><span class="token function">visitInvokeDynamicInsn</span><span class="token punctuation">(</span><span class="token string">&quot;hashCode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;()I&quot;</span><span class="token punctuation">,</span> BSM<span class="token punctuation">,</span> <span class="token string">&quot;geym&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mv<span class="token punctuation">.</span><span class="token function">visitMethodInsn</span><span class="token punctuation">(</span>INVOKEVIRTUAL<span class="token punctuation">,</span> <span class="token string">&quot;java/io/PrintStream&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;println&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;(I)V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mv<span class="token punctuation">.</span><span class="token function">visitInsn</span><span class="token punctuation">(</span>RETURN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mv<span class="token punctuation">.</span><span class="token function">visitMaxs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mv<span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cw<span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">FileOutputStream</span> fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;D:/DynInvokerSampleMain.class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token string">&quot;DynInvokerSampleMain&quot;</span><span class="token punctuation">,</span> bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span>
            <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">SecurityException</span> <span class="token punctuation">{</span>
        <span class="token class-name">DynInvokerSample</span> me <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynInvokerSample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> me<span class="token punctuation">.</span><span class="token function">createClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;run&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;geym&quot;</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第 2 ~ 4 行声明了引导方法，引导方法将使用 invokstatic 进行调用。第 8 ~ 14 行创建了类 DynlnvokerSampleMain，并为其产生了默认的构造函数。第 16 行创建了 run() 方法。第 20 行使用 invokedynamic 指令，在字符串 &quot;gcym&quot; 上查找并调用名为 hashCode 的函数，函数签名为 &quot;()I&quot;，即不接收参数，返回值为 int 类型。传入的 BSM 为在第 2 ~ 4 行声明的引导方法。第 21 行输出 invokedynamic 运行后的结果。第 29 行将新生成的 Class 写入文件 DynlnvokerSampleMain.class。第 31 行完成类 DynlnvokerSampleMain 的定义和加载。第 38 行调用了 DynInvokerSampleMain.run() 方法，打印 &quot;geym&quot; 的 hashCode() 返回值。第 39 行直接调用 &quot;geym&quot;.hashCode()。</p><p>运行以上代码，输出如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>bootstrap called,name=hashCode
3169394
3169394
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用 javap工具分析上述代码产生的 DynlnvokerSampleMain.class 文件，如图11.21 所示。</p><p><img src="/assets/图11-21.29a949d3.png" alt="图11-21" loading="lazy"></p><p>图11.21 invokedynamic 实例结构图</p><p>文件中有两处结构和动态调用有关：</p><ul><li><p>一处是 run() 方法字节码部分使用了 invokedynamic 指令，该指令一方面指向了 CONSTANT_InvokeDynamic 结构，另一方面指向了第一个引导方法。</p></li><li><p>另一处就是引导方法属性，它主要定位了方法句柄的位置，并根据常量池之间的引用关系，可以一直追溯到 DynBootStrap.bootstrap() 方法。</p></li></ul><h2 id="_11-6-跑得再快点-静态编译优化" tabindex="-1"><a class="header-anchor" href="#_11-6-跑得再快点-静态编译优化" aria-hidden="true">#</a> 11.6 跑得再快点：静态编译优化</h2><p>当使用 javac 把 Java 源码转为字节码时，编译器会有一些优化以获得更好的性能。目前，对于执行的字节码会从两处进行优化：</p><p>第一，使用 javac 编译时；</p><p>第二，通过 JIT（Just-In-Time）即时编译，在运行时。</p><p>目前，大量的优化工作都围绕着 JIT 展开，比如方法内联、栈上替换等。将优化工作从 javac 前端移到后端的好处是非常明显的，这样所有基于 Java 平台的语言都能共享这种优化带来的好处。将大量的优化只放置于 javac 前端，只有 Java 语言可以利用这种优化方式。但即便如此，开发人员也必须要了解一些 javac 的常用优化方法。</p><h3 id="_11-6-1-编译时计算" tabindex="-1"><a class="header-anchor" href="#_11-6-1-编译时计算" aria-hidden="true">#</a> 11.6.1 编译时计算</h3><p>如果在程序中出现了计算表达式，表达式的值能够在编译时确定，那么表达式的计算会提前到编译阶段，而不是在运行时计算。</p><p>【示例 11-30】很多时候，为了增强代码的可读性，往往不会把最终的数值写在代码中，通常倾向于把计算过程写在代码里，比如下面代码：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do sth.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>循环次数为 60 * 60 * 24 * 1000 次，通常这个表达式用来计算天、时、分、秒的乘积。看到这段代码，可能会让人产生一种怀疑，是不是这个计算每次循环都要进行一次呢？如果是的话，是不是更应该写成：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">86400000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do sth.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或者一定要保留计算表达式的话，写成：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do sth.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>读者也许会认为，上述代码先计算了表达式乘积，并保留这个值，以避免每次循环都重复计算。</p><p>实际上，后两段代码的担心是多余的，因为在编译的时候，对于给定的表达式会自动计算并给出结果。本例中第一段代码生成的字节码如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>#20 = Integer    86400000
0: iconst_0
1: istore_1
2: goto    8
5: iinc    1, 1
8: iload_1
9: ldc    #20  // int 86400000
11: if_icmplt    5
14: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，用于控制循环次数上限的整数在字节码中并非经过计算得来的，而是保存在常量池中，并直接使用，其作用是判定是否可以继续循环。可见，对于常量表达式，可以大胆地使用而无须担心影响系统性能。</p><p>【示例 11-31】另一个常用的例子是字符串连接。有时候，如果一个字符串很长，通常会倾向于使用 &quot;+&quot; 号连接。由于字符串是不可变的对象，读者也许会认为使用类似 A + B 的方式连接字符串时，需要 3 个对象，即 A、B 和 AB。下面再来看一个例子。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> info1 <span class="token operator">=</span> <span class="token string">&quot;select * from test&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> info2 <span class="token operator">=</span> <span class="token string">&quot;select * &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;from test&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> info3 <span class="token operator">=</span> <span class="token string">&quot;select * &quot;</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;from test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info1 <span class="token operator">==</span> info2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info1 <span class="token operator">==</span> info3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info2 <span class="token operator">==</span> info3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>info2 <span class="token operator">==</span> info3<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码中，info1 是直接定义的字符，info2 使用 &quot;+&quot; 连接，生成字面量等于 info1 的字符串，info3 使用 String.concat() 方法做连接生成。执行以上代码，输出如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>true 
false 
false 
true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，info1 和 info2 指向了同一个对象引用，而 info3 则指向了不同的对象引用，但是 info3 的常量池引用地址就是 info2。这说明 info3 是被实实在在构造出来的新的 String 对象，而 info2 的 &quot;+&quot; 运算并未在运行时进行，否则也应该有新对象产生。查看它的部分字节码：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: ldc    #24;  // String select * from test
2: astore_0
3: ldc    #24;  // String select * from test
5: astore_1
6: ldc    #26;  // String select *
8: ldc    #28;  // String from test
10: invokevirtual    #30; // Method java/lang/String.concat:(Ljava/lang/String;)Ljava/lang/String;
13: astore_2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述字节码中，第 2 行表示将常量池第 24 项存入第 0 个局部变量（info1），第 5 行表示将常量池第 24 项存入第 1 个局部变量（info2）。这里就解释了为什么程序会有这样的输出，因为在编译时，字符串连接已经完成。而对于后续的 concat() 函数，则没有这种优化，第 10 行的 invokevirtual 调用，就说明了 info3 是在运行时被创建的。</p><p>综上，对于常量字符串连接，不用担心多写几个 &quot;+&quot; 会影响系统性能、多占用内存等，因为这些都会在编译器中进行计算。</p><h3 id="_11-6-2-变量字符串的连接" tabindex="-1"><a class="header-anchor" href="#_11-6-2-变量字符串的连接" aria-hidden="true">#</a> 11.6.2 变量字符串的连接</h3><p>上一节介绍了编译器对常量字符串的优化，那么对于变量字符串连接，是否也有类似的优化方案呢？答案是肯定的。</p><p>【示例 11-32】下面这段代码是常用的字符串操作方式。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addString</span><span class="token punctuation">(</span><span class="token class-name">String</span> str1<span class="token punctuation">,</span> <span class="token class-name">String</span> str2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> str3 <span class="token operator">=</span> str1 <span class="token operator">+</span> str2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>变量 str1 和 str2 通过 &quot;+&quot; 进行字符串连接。对于常量，会在运行时进行计算，而对于变量，运行时显然无法进行计算，此时编译器会为字符串的操作插入 StringBuilder。笔者使用 jad（Java 的反编译器）对上述代码生成的 Class 文件进行反编译，得到：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> str3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>可以清楚地看到，字符串连接都被转为了更可取的 StringBuilder 操作，避免了每次字符串操作都生成新的对象，因此读者大可不必担心这类操作带来太大的性能问题。但是如果能在编码时留意这些问题，依然是大有好处的。</p><p>【示例 11-33】下面的代码在循环中进行字符串连接。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addString2</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> str1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> str3 <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> str <span class="token operator">:</span> str1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        str3 <span class="token operator">+=</span> str1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据上述经验，读者应该能想到，这些字符串操作都会被编译成更高效的 StringBuilder。使用 jad 反编译上述生成的 Class 文件，得到：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addString2</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> str1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> str3 <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> as<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token punctuation">(</span>as <span class="token operator">=</span> str1<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        str3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>str3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从反编译代码可知，虽然使用了 StringBuilder 进行字符串连接，但是优化的结果是为每次字符串连接都生成一个 StringBuilder 实例，这显然也是一种不够聪明的做法。更好的做法是在循环外建立 StringBuilder 实例，在循环内进行字符串累加操作。</p><p>由此可见，对于变量字符串累加，编译器会做适量优化，但是无法得到最优的解决方案，依然需要在开发时注意这些问题。</p><h3 id="_11-6-3-基于常量的条件语句裁剪" tabindex="-1"><a class="header-anchor" href="#_11-6-3-基于常量的条件语句裁剪" aria-hidden="true">#</a> 11.6.3 基于常量的条件语句裁剪</h3><p>在介绍本节内容前，笔者先讲述一个真实的开发案例。众所周知，大型项目的构建过程是非常耗时的，以笔者维护的 Java 项目为例，完全编译和构建需要花 30 分钟到 1 小时。因此，在正式发布版本之前，大家都是非常谨慎的，生怕出错后重新编译项目费时费力。但是，难免疏忽，有时候就是会由于这样那样的原因，需要重新编译。为了节省时间，有时候就会使用 “塞包” 的方法，将需要更新的类单独编译，然后更新到己经编译完成的 jar 包中，而不去重新编译整个系统（当然，一般情况下并不推荐这么做）。</p><p>【示例 11-34】有一次，笔者发现类似下面代码定义的类需要修改。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinalFlag</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改的内容是 flag 常量应该被置为 false，而不是 true，因为在系统中有不少地方以下面类似的方式引用这个常量。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FinalFlag</span><span class="token punctuation">.</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;flag is true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;flag is false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了避免重新编译整个系统带来的麻烦，笔者想当然地将 FinalFlag 中的 flag 设置为 false，单独编译 FinalFlag，并将新的 Class 文件更新到 jar 中。接着更新整个系统并进行测试，结果发现引用到 FinalFlag.flag 的代码点，并没有进入期望的逻辑，让人纠结半天。</p><p>其实，导致这个问题的原因很简单，如果使用 javap 获得上述 checkflag() 方法的字节码，可以看到：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: getstatic    #36;  // Field java/lang/System.out:Ljava/io/Printstream;
3: ldc    #59;  // String flag is true
5: invokevirtual    #61;  // Method java/io/Printstream.println:(Ljava/lang/String;)V
8: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这是不是令人吃惊的编译结果？在实际执行的字节码中，没有获取 FinalFlag.flag，没有进行条件判断跳转，只是简单地打印了 &quot;String flag is true&quot;。因此，无论如何更新 FinalFlag.flag，只要引用这个变量的类不做更新，程序都不会有任何变化。这就是因为编译器会对常量做特殊的优化，由于 final 常量是不可变的，任何逻辑都可以在编译时就确定，不需要的逻辑自然可以裁剪，于是就有了这么一个问题。</p><p>解决这个问题的办法就是做一次全面的编译，让 final 的更新影响到每一个使用到的类中。</p><h3 id="_11-6-4-switch-语句的优化" tabindex="-1"><a class="header-anchor" href="#_11-6-4-switch-语句的优化" aria-hidden="true">#</a> 11.6.4 switch 语句的优化</h3><p>在前面的章节中提到，对于 switch 语句，编译器会产生两种字节码指令：tableswitch 和 lookupswitch。其中 tableswitch 的效率高于 lookupswitch，但 tableswitch 的结构决定了它只能处理 case 情况是连续的数值，而 lookupswitch 可以处理不连续的情况。一般来说，总是希望可以尽可能地使用 tableswitch，而不是 lookupswitch。</p><p>【示例 11-35】以下面的代码为例。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也许不少读者会认为，因为 case 值是不连续的，所以编译器会使用低效的 lookupswitch 指令处理这个 switch，每次都遍历查找所有的可能情况。</p><p>如果用 javap 查看生成的字节码，会发现：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>0: iload_1
1: tableswitch{ // 1 to 5
        1: 36;
        2: 39;
        3: 45;
        4: 45; 
        5: 42;
        default: 45 }
36:	goto    53
39:	goto    53
42:	goto    53
45: getstatic    #36;  // Field java/lang/System.out:Ljava/io/Printstream;
48:	ldc    #58;  // String
50: invokevirtual    #60;  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
53: return
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，为了使用 tableswitch，编译器将离散的数据进行了填充，其中 case3、4 都跳转到了 default，符合代码的语义。但如果离散空间很大，就会要求插入过多的中间数据，此时编译器依然会使用 lookupswitch 指令。</p><h2 id="_11-7-提高虚拟机的执行效率-jit-及其相关参数" tabindex="-1"><a class="header-anchor" href="#_11-7-提高虚拟机的执行效率-jit-及其相关参数" aria-hidden="true">#</a> 11.7 提高虚拟机的执行效率：JIT 及其相关参数</h2><p>JIT（Just-In-Time）编译器是 Java 虚拟机的执行机制的性能保证。由于 Java 的字节码是解释执行的，效率很低。在 Java 发展历史中，有两套解释执行器：古老的字节码解释器、现在被广泛使用的模板解释器。字节码解释器在执行时通过纯软件代码模拟字节码的执行，效率非常低。相比之下，模板解释器将每一条字节码和一个模板函数相关联，而模板函数中直接产生这条字节码执行时的机器码，从而提高了解释器的性能。但即便如此，仅凭借解释器，虚拟机的执行效率依然很低，为了解决这个问题，虚拟机平台支持一种叫作即时编译的技术。</p><p>即时编译的目的是避免函数被解释执行，而是将整个函数体编译成机器码，每次函数执行时，只执行编译后的机器码即可，这种方式可以使执行效率大幅度提升。</p><h3 id="_11-7-1-开启-jit-编译" tabindex="-1"><a class="header-anchor" href="#_11-7-1-开启-jit-编译" aria-hidden="true">#</a> 11.7.1 开启 JIT 编译</h3><p>Java 虚拟机有 3 种执行模式，分别是解释执行、混合模式和编译执行，默认情况下处于混合模式中。使用命令行 java -version 可以查看虚拟机的执行模式：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>C:\Users\Administrator&gt;java -version
java version &quot;10.0.2&quot; 2018-07-17
Java(TM) SE Runtime Environment 18.3 (build 10.0.2+13)
Java HotSpot(TM) 64-Bit Server VM 18.3 (build 10.0.2+13, mixed mode)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面输出的 &quot;mixed mode&quot; 就表示混合模式。在混合模式中，部分函数会被解释执行，部分函数可能被编译执行。虚拟机决定函数是否需要编译执行的依据是判断该函数是否为热点代码。如果函数的调用频率很高，被反复使用，那么就会被认为是热点，就会被编译执行。</p><p>解释执行模式表示全部代码均解释执行，不做任何 JIT 编译，可以使用参数 -Xint 来开启解释执行模式：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>C:\Users\Administrator&gt;java -Xint -version
java version ”10.0.2&quot; 2018-07-17
Java(TM) SE Runtime Environment 18.3 (build 10.0.2+13)
Java HotSpot(TM) 64-Bit Server VM 18.3 (build 10.0.2+13, interpreted mode)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译执行模式和解释执行模式相反，对于所有的函数，无论是否是热点代码，都会被编译执行，使用参数 -Xcomp 可以设置为编译模式：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>C:\Users\Administrator&gt;java -Xcomp -version
java version ”10.0.2&quot; 2018-07-17
Java(TM) SE Runtime Environment 18.3 (build 10.0.2+13)
Java HotSpot(TM) 64-Bit Server VM 18.3 (build 10.0.2+13, compiled mode)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一般来说，编译模式的执行效率会远远高于解释模式。</p><p>【示例 11-36】下面的代码不停地计算圆周率的数值，并给出了运行的耗时。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">calcPi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> re <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        re <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> re <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">calcPi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;spend:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>e <span class="token operator">-</span> b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用虚拟机参数 -Xint 运行以上代码，输出：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>spend:2441ms
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>使用虚拟机参数 -Xcomp 运行以上代码，输出：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>spend:400ms
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>很明显，在本例中使用编译运行要比解释运行快大约 6 倍。</p><h3 id="_11-7-2-jit-编译阈值" tabindex="-1"><a class="header-anchor" href="#_11-7-2-jit-编译阈值" aria-hidden="true">#</a> 11.7.2 JIT 编译阈值</h3><p>在默认情况下，JIT 使用混合模式运行（指定参数为 -Xmixed），在混合模式中，只会对热点代码进行即时编译。对于是否为热点代码，虚拟机内有一个阈值进行判断，当函数调用次数超过这个阈值时，就被认为是热点代码，进行即时编译。在 Client 模式下，这个阈值为 1500 次，在 Server 模式下这个阈值为 10000 次。使用参数 -XX:CompileThreshold 可以设置这个阈值，使用参数 -XX:+PrintCompilation 可以打印即时编译的日志。</p><p>【示例 11-37】下面的代码调用了 500 次 met() 函数，在默认情况下，met() 函数不会被编译，但是通过设置 -XX:CompileThreshold 为 500，met() 函数就会成为热点代码，被编译为机器码。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">met</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    b <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">500</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">met</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以参数 -XX:CompileThreshold=500 -XX:+PrintCompilation 运行以上代码，部分输出如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>68  19  s  java.lang.StringBuffer::append (8 bytes)
69  20     java.io.Win32FileSystem::normalize (231 bytes)
70  21     geym.zbase.ch11.jit.JITSimpleTest::met (9 bytes)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，函数 met() 已经被编译为机器码。</p><h3 id="_11-7-3-多级编译器" tabindex="-1"><a class="header-anchor" href="#_11-7-3-多级编译器" aria-hidden="true">#</a> 11.7.3 多级编译器</h3><p>Java 虚拟机中拥有客户端编译器和服务端编译器两种编译系统，一般称为 C1 和 C2 编译器。当使用 -client 参数时，虚拟机会使用 C1 编译器，使用 -server 参数时，虚拟机会使用 C2 编译器。C1 编译器的特点是编译速度快，C2 编译器的特点是会做更多的编译时优化，因此编译时间会长于 C1，但是编译后的代码质量会高于 C1。为了使 C1 和 C2 在编译速度和执行效率之间取得平衡，虚拟机支持一种叫作多级编译的策略。多级编译将编译的层次分为以下 5 级。</p><ul><li><p>0 级（解释执行）：釆用解释执行，不釆集性能监控数据。</p></li><li><p>1 级（简单的 C1 编译）：釆用 C1 编译器，进行最简单的快速编译，根据需要釆集性能数据。</p></li><li><p>2 级（有限的 C1 编译）：釆用 C1 编译器，进行更多的优化编译，可能会根据第 1 级釆集的性能统计数据进一步优化编译代码。</p></li><li><p>3 级（完全 C1 编译）：完全使用 C1 编译器的所有功能，会釆集性能数据进行优化。</p></li><li><p>4 级（C2 编译）：完全使用 C2 编译器进行编译，进行完全的优化。</p></li></ul><p>要使用多级编译器可以使用参数 -XX:+TieredCompilation 打开多级编译器的策略。如果使用该参数，那么虚拟机必须使用 -server 模式启动，如果使用 -client 模式启动，那么分级模式依然不会开启。</p><p>【示例 11-38】下面的代码频繁调用了 WriterService. service() 函数，通过不同的参数配置，来学习一下多级编译器的使用。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WriterMain</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WriterService</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriterService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ws<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;spend:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>e <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ws <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WriterService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DBWriter</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DBWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DBWriter</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;DBWriter&quot;</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用参数 -XX:+PrintCompilation -server-Xcomp 运行上述代码，部分输出如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>862  382    b    geym.zbase.ch11.jit.deopt.WriterMain::main (74 bytes)
863  382         geym.zbase.ch11.jit.deopt.WriterMain::main (74 bytes) made not entrant
912  397    b    geym.zbase.ch11.jit.deopt.WriterService::&lt;init&gt; (5 bytes)
913  398    b    geym.zbase.ch11.jit.deopt.WriterService::service (13 bytes)
913  398    b    geym.zbase.ch11.jit.deopt.WriterService::service (13 bytes) made not entrant
915  400    b    geym.zbase.ch11.jit.deopt.DBWriter::&lt;init&gt; (5 bytes)             
915  401    b    geym.zbase.ch11.jit.deopt.DBWriter::write (7 bytes)              
918  403    b    geym.zbase.ch11.jit.deopt.WriterService::service (13 bytes) 
919  404  % b     geym.zbase.ch11.jit.deopt.WriterMain::main @ 18 (74 bytes) 
1143  404  %       geym.zbase.ch11.jit.deopt.WriterMain::main @ -2 (74 bytes) made not entrant
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，WriterService.service() 和 DBWriter.writer() 等函数都被编译成了本地代码。其中有些函数后标注有 made not entrant 标记，表示该函数编译结果被标记为不可再用，后续可能会从内存中移除，表示废弃。这种情况是因为该函数已经不需要再使用（比如类被垃圾回收器回收，其方法代码自然不会再被使用），或者编译器产生了一个更优的编译结果，需要将旧数据清除。</p><p><strong>注意</strong>：made not entrant 状态只是表示新的代码调用不能使用这块编译结果，但可能存在正在使用该段代码块的程序，所以还不能完全从系统中清理。如果代码块已经不再被使用，并处于 made not entrant 状态，一旦被清理线程发现，代码块会被进一步标记为 made zombie 状态（僵尸状态），此时代码库将被彻底清除。</p><p>使用参数 -XX:+PrintCompilation -server -Xcomp -XX:+TieredCompilation 运行上述代码，部分输出如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>50  287    b 3   geym.zbase.ch11.jit.deopt.WriterMain::main (74 bytes)
57  298    b 3   geym.zbase.ch11.jit.deopt.WriterService::&lt;init&gt; (5 bytes)
57  299    b 3   geym.zbase.ch11.jit.deopt.WriterService::service (13 bytes)
57  300    b 3   geym.zbase.ch11.jit.deopt.DBWriter::&lt;init&gt; (5 bytes)
57  301    b 3   geym.zbase.ch11.jit.deopt.DBWriter::write (7 bytes)
59  302    b 4   geym.zbase.ch11.jit.deopt.WriterService::service (13 bytes)
62  299      3   geym.zbase.ch11.jit.deopt.WriterService::service (13 bytes) made not entrant
62  303    b 4  geym.zbase.ch11.jit.deopt.DBWriter::&lt;init&gt; (5 bytes)
63  300      3  geym.zbase.ch11.jit.deopt.DBWriter::&lt;init&gt; (5 bytes) made not entrant
63  304    b 4  geym.zbase.ch11.jit.deopt.DBWriter::write (7 bytes)
63  301      3  geym.zbase.ch11.jit.deopt.DBWriter::write (7 bytes) made not entrant
66  309  % b 4  geym.zbase.ch11.jit.deopt.WriterMain::main @ 18 (74 bytes)
70  310    b 4  geym.zbase.ch11.jit.deopt.WriterMain::main (74 bytes)
73  287      3  geym.zbase.ch11.jit.deopt.WriterMain::main (74 bytes) made not entrant
77  309  % b 4  geym.zbase.ch11.jit.deopt.WriterMain::main @ -2 (74 bytes) made not entrant
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，在使用 -XX:+TieredCompilation 之后，JIT 的日志发生了变化，在输出的结果中多了一列，增加的列表示编译的级别。该日志的每一列的含义分别如下。</p><ul><li><p>时间戳：系统启动到编译完成时的毫秒数。</p></li><li><p>即时编译 ID：编译任务的内部 ID，一般是一个自增的值。</p></li><li><p>属性：描述代码状态的 5 个属性。</p><ul><li>%：是一个 OSR（栈上替换）。</li><li>s：是一个同步方法。</li><li>!：方法有异常处理快。</li><li>b：阻塞模式编译。</li><li>n：是本地方法的一个包装。</li></ul></li><li><p>编译级别：0 ~ 4 级编译。级别越高编译生成的机器码质量越好，编译耗时也越长。</p></li><li><p>方法名：被编译方法的名称。</p></li><li><p>方法大小：被编译方法的大小，这个大小是指 Java 字节码大小，不是生成的本地机器码大小。</p></li></ul><p>从这段编译日志中不难发现，在时间戳第 57 毫秒处，301 号编译中，DBWriter.writer() 被第一次编译为机器码，编译级别是 3。在第 63 毫秒处，该 301 号编译被标记为 made not entrant，即不再允许产生新的调用，与此同时，第 63 毫秒处的 304 号编译将 DBWriter.writer() 重新编译，并使用编译级别 4。这就是一个典型的层次编译策略进行编译级别的提升，后一次编译产生了更优质的代码。</p><h3 id="_11-7-4-osr-栈上替换" tabindex="-1"><a class="header-anchor" href="#_11-7-4-osr-栈上替换" aria-hidden="true">#</a> 11.7.4 OSR 栈上替换</h3><p>一般来说，一次函数调用要么使用解释执行，要么使用即时编译后的机器码执行。从解释执行切换到机器码执行，是在这个函数的两次调用之间产生的，即一个函数的前一次函数调用发生时，尚未准备好编译后版本，则会进行解释执行，而下一次调用发生时，发现其编译版本己经准备好，那么就会使用编译后的版本执行。这种情况覆盖了绝大部分场合，但是不适合那些调用次数不多但是函数体内包含大量循环的函数，比如如下函数：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">WriterService</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriterService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ws<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>main() 函数被执行的次数只有一次（或者其他被调用次数明显不多的函数），但是函数体内有一个循环次数很多的循环体，在这种情况下，由于 main() 函数不可能满足编译条件，永远得不到编译，但是从实际运行的角度来说，循环代码被大量反复执行，是有编译价值的。为了应对这种情况，编译器会记录循环的次数，一旦循环次数达到一定的阈值（一般在 1 万次左右），就会认为这段循环代码也是热点代码，并触发即时编译。</p><p>编译完成后，由于 main() 函数很少被执行，甚至可能永远不会再被执行了，虚拟机需要一个切入点来动态将正在执行的循环体代码替换为编译后版本。这种不等待函数运行结束，在循环体内就将代码替换为编译版本的技术，叫作 OSR（On Stack Relapcement，栈上替换）。如图11.22 所示，左侧表示普通的方法编译，每次在方法入口进行判断，右侧表示栈上替换，在方法入口时并不检査（方法调用次数很少），而在每次循环开始时，判断是否有编译版本可供使用。</p><p><img src="/assets/图11-22.453485aa.png" alt="图11-22" loading="lazy"></p><p>图11.22 OSR 和普通方法编译区别</p><p>在上一节的实例中，main() 函数已经使用了 OSR 进行编译和运行。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>66  309 % b 4    geym.zbase.ch11.jit.deopt.WriterMain::main @ 18 (74 bytes)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>上述日志中，％ 表示 OSR。</p><p><strong>注意</strong>：严格来说，并不是通过循环次数和循环入口来进行 OSR 判断的，而是使用一种叫作回边（back-edge）计数器和回边指令来进行判断的。所谓回边，就是字节码指令中向后跳转的指令。当然，在大部分情况下，这种向后跳转的指令是由循环产生的。</p><h3 id="_11-7-5-方法内联" tabindex="-1"><a class="header-anchor" href="#_11-7-5-方法内联" aria-hidden="true">#</a> 11.7.5 方法内联</h3><p>方法内联是一种有效的优化手段，它可以减少方法调用的次数，从而提高系统性能。JIT 编译器默认会进行方法内联优化。</p><p>【示例 11-39】下面的例子说明了什么是方法内联。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InLineMain</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> b <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">100000000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> e <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 main() 函数中，调用 inc() 函数。而 inc() 函数的内容很少，属于典型的小方法。因此产生一次函数调用的成本就会相对比较高，对 inc() 函数进行内联后，循环体就会变成：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">100000000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到循环函数调用被剥离，原有的函数体直接被嵌入循环体内，从而有效减少函数调用次数。对于这种小方法效果是极其明显的，使用 -XX:+Inline 参数可以打开内联优化。使用参数 -Xcomp -server -XX:+Inline 运行示例中的 InLineMain.main()，输出（耗时）：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>7
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>使用 -Xcomp -server -XX:-Inline 参数关闭内联，再次运行，输出（耗时）：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>236
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>由此可见，内联的优化效果是非常显著的。但是内联会增大系统执行代码的体积，对于大的方法体，使用内联也需要谨慎，虚拟机提供了一些参数来控制对于多大的代码体积允许进行内联，比如 -XX:FreqInlineSize 参数，可以控制热点方法进行内联的体积上限，但凡方法体积大于给定值，都不会进行内联优化。</p><h3 id="_11-7-6-设置代码缓存大小" tabindex="-1"><a class="header-anchor" href="#_11-7-6-设置代码缓存大小" aria-hidden="true">#</a> 11.7.6 设置代码缓存大小</h3><p>字节码被编译为机器码后，得到的结果需要在内存中保存，使用。存放这些代码的内存区域称为代码缓存（Code Cache）。一旦代码缓存空间被用完，虚拟机并不会像堆或者永久区那样暴力地直接抛出内存溢出错误，保持系统继续运行。系统停止 JIT 编译后，后续未编译的代码全部以解释方式运行，故系统性能会受到影响。代码缓存空间的清理工作也是在系统 GC 时完成的。</p><p>代码缓存空间的大小可以使用参数 -XX:ReservedCodeCacheSize 指定。一般在 32 位的 Client 模式下，这个值为 32MB。读者可以根据应用的需要设定这个值。</p><p>【示例 11-40】下面例子显示了代码缓存空间的大小设置，以及代码缓存空间的回收情况。读者需要知道，代码缓存空间设置得越大，那么可以保存的被编译的方法就越多。而一旦代码缓存空间耗尽，JIT 编译器停止工作，就再也无法启动 JIT 编译了。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CodeCacheJit</span> <span class="token keyword">implements</span> <span class="token class-name">Opcodes</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">createAndCall</span><span class="token punctuation">(</span><span class="token class-name">String</span> hellostr<span class="token punctuation">,</span> <span class="token class-name">String</span> classname<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span>
            <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">SecurityException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassWriter</span> cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_MAXS <span class="token operator">|</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">.</span>COMPUTE_FRAMES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cw<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span>V1_7<span class="token punctuation">,</span> ACC_PUBLIC<span class="token punctuation">,</span> classname<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;java/lang/Object&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MethodVisitor</span> mw <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>ACC_PUBLIC<span class="token punctuation">,</span> <span class="token string">&quot;&lt;init&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; ()V&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitVarInsn</span><span class="token punctuation">(</span>ALOAD<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitMethodInsn</span><span class="token punctuation">(</span>INVOKESPECIAL<span class="token punctuation">,</span> <span class="token string">&quot;java/lang/Object&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;init&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot; ()V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitInsn</span><span class="token punctuation">(</span>RETURN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitMaxs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>ACC_PUBLIC <span class="token operator">+</span> ACC_STATIC<span class="token punctuation">,</span> <span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;([Ljava/lang/String;)V&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitFieldInsn</span><span class="token punctuation">(</span>GETSTATIC<span class="token punctuation">,</span> <span class="token string">&quot;java/lang/System&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;out&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Ljava/io/PrintStream;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitLdcInsn</span><span class="token punctuation">(</span>hellostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitMethodInsn</span><span class="token punctuation">(</span>INVOKEVIRTUAL<span class="token punctuation">,</span> <span class="token string">&quot;java/io/PrintStream&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;println&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;(Ljava/lang/String;)V&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitInsn</span><span class="token punctuation">(</span>RETURN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitMaxs</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mw<span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JitClassLoader</span> loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JitClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Method</span> m<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            m <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">&quot;defineClass&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            m<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Class</span> exampleClass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> m<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> classname<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> code<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            exampleClass<span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">createAndCall</span><span class="token punctuation">(</span><span class="token string">&quot;hello, world&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">&quot;Ex&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 停止 JIT 后再 GC, JIT 不会启用了</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">2500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述代码在 main() 函数中反复调用 createAndCall() 函数，这个函数每次新建一个类，并调用这个类的 main() 函数。程序第 40 行，在调用 2500 次以后，进行显式的 GC 操作。</p><p>使用以下参数运行这段代码：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>-XX:+PrintCompilation -XX:ReservedCodeCacheSize=5M -Xcomp 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>得到程序部分输出如下：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>hello,world2041
1143  2777  b    Ex2042::main (9 bytes)
hello,world2042
1143  2778  b    Ex2043::main (9 bytes)
hello,world2043
hello,world2044
hello,world2045
hello,world2046
hello,world2571
hello,world2572
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，在 2041 次调用后，JIT 编译被停止，不再有任何 JIT 编译日志信息输出。而在 2500 次调用后，系统调用显式 GC 后，并没有任何效果。</p><p>将程序第 40 行改为：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>以相同的参数运行以上代码，可以看到部分输出（输出量太大，故截取一小部分）：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>hello,world1270
869 2006  b    Ex1271::main (9 bytes)
...
hello,world1999                                 
1125 2735  b    Ex2000::main (9 bytes)         
hello,world2000                                 
1125 2736  b    java.lang.System::gc (7 bytes) 
1125 2737  n    java.lang.Runtime::gc (native) 
1138 2739  b    Ex2001::main (9 bytes)         
hello,world2001                                 
1148 2740  b    Ex2002::main (9 bytes)         
1148 1063       (method) made zombie           
1148 1061       (method)  made zombie 
hello,world2002              
1148 1058       (method) made zombie           
1157 2454       (method) made zombie           
1157 2453       (method) made zombie      
...
19278 4729      (method) made zombie           
hello,world4002                                 
19289 4741  b    Ex4003::main (9 bytes)         
hello,world4003                                 
19298 4742  b    Ex4004::main (9 bytes)         
hello,world4004
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，在 2000 次调用前，没有任何代码缓存空间被回收，在 2000 次调用后，System.gc() 运行，并开始回收代码缓存空间，大量函数被标记为 made zombie，并被释放。由于垃圾回收的存在，无效的代码总是可以被释放，代码缓存空间未被耗尽，并最终持续执行到 4000 多次调用，依然正常工作。</p><p><strong>注意</strong>：一旦代码缓存空间耗尽，JIT 就会停止，并且在整个虚拟机的生命周期中，不会再启动了。要扩大代码缓存区间，可以使用 -XX:ReservedCodeCacheSize 参数设置。</p><p>如图11.23 所示，在 JConsole 里观察代码缓存空间的使用情况。</p><p><img src="/assets/图11-23.7d2618b5.png" alt="图11-23" loading="lazy"></p><p>图11.23 代码缓存空间使用率</p><h2 id="_11-8-小结" tabindex="-1"><a class="header-anchor" href="#_11-8-小结" aria-hidden="true">#</a> 11.8 小结</h2><p>本章主要介绍了 Java 虚拟机的字节码执行机制。首先介绍了 Java 虚拟机的主要指令集，接着以这些指令集为基础，学习如何使用 ASM 库进行动态字节码生成、修改等相关的开发工作。为了更好地使用这种技术，本章还介绍了 Java Agent 机制。</p><p>此外，本章还简单介绍了 Javac 的静态编译及 JIT 动态编译这两项基础性的模块，以帮助读者进一步理解 Java 虚拟机的运行机制。</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://gitee.com/anansneaker/vuepress-theme-hope/edit/master/docs/reading-notes/实战Java虚拟机：JVM故障诊断与性能优化/第11章字节码执行.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">上次编辑于: </span><span class="info">2022/8/16 下午7:56:17</span></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: cl55563@163.com">阿楠sneaker</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/reading-notes/%E5%AE%9E%E6%88%98Java%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%9AJVM%E6%95%85%E9%9A%9C%E8%AF%8A%E6%96%AD%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AC%AC10%E7%AB%A0Class%E8%A3%85%E8%BD%BD%E7%B3%BB%E7%BB%9F.html" class="nav-link prev" aria-label="第 10 章 Class 装载系统"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->第 10 章 Class 装载系统</div></a><!----></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer"></div><div class="copyright">Copyright © 2022 阿楠sneaker</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.0d56c066.js" defer></script>
  </body>
</html>
